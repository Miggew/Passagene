import{r,s as c,a as oa,j as e,B as xe,U as ra,k as xa,i as va}from"./index-BPMeM9-O.js";import{C as Oe,a as Me,b as Be,d as He}from"./card-8azKTSNJ.js";import{T as Ye,a as Je,b as Fe,c as me,d as Xe,e as ue}from"./table-l_s8S0JA.js";import{S as Te,a as $e,b as ke,c as Re,d as Ve}from"./select-La4nrp5K.js";import{I as qe}from"./input-tqcTRdPv.js";import{B as Ue}from"./badge-CeJDYfYs.js";import{P as ga}from"./PageHeader-DQ4rM2jO.js";import{E as ja}from"./EmptyState-yqSFIU3C.js";import{u as Ce}from"./use-toast-BGNwDi9e.js";import{h as Ze}from"./error-handler-B0L1mfY3.js";import{e as Ae,t as ta,d as ia,f as Ne,a as ba,g as wa}from"./dateUtils-eJ5e6apA.js";import{D as Ke,a as Da,b as We,c as ea,d as aa,e as sa}from"./dialog-CLDnxY7R.js";import{L as ve}from"./label-fluRYl3j.js";import{T as la}from"./textarea-B1aXpqcj.js";import{P as ma}from"./plus-Ah0p7ggz.js";import{A as Na}from"./arrow-left-CjWJp082.js";import{F as Sa}from"./file-text-CtxiCcm9.js";import{P as da}from"./package-CNNpa4CW.js";import{F as Ea}from"./filter-DouKIrIu.js";import{X as na}from"./x-BxiwAMrM.js";import{C as za}from"./calendar-CuUQg-xw.js";import{E as Fa}from"./eye-CZithoXn.js";import"./index-C5PY5DOm.js";import"./check-Bdb-Yd05.js";function Ge(t){return{[-1]:"Aspira√ß√£o",0:"Fecunda√ß√£o",1:"Zigoto",2:"Clivagem",3:"Clivagem Avan√ßada",4:"Compacta√ß√£o",5:"M√≥rula / Blastocisto Inicial",6:"Blastocisto",7:"Blastocisto Expandido",8:"Resgate / Sa√≠da Tardia"}[t]||`Dia ${t}`}function Aa(t){return t===-1?"bg-blue-100 text-blue-800 border-blue-300":t===0?"bg-green-100 text-green-800 border-green-300":t>=1&&t<=3?"bg-yellow-100 text-yellow-800 border-yellow-300":t>=4&&t<=5||t===6?"bg-orange-100 text-orange-800 border-orange-300":t===7?"bg-purple-100 text-purple-800 border-purple-300":t===8?"bg-red-100 text-red-800 border-red-300":"bg-slate-100 text-slate-800 border-slate-300"}const ua="lotes_fiv_filtros";function pa(){try{const t=localStorage.getItem(ua);return t?JSON.parse(t):{}}catch{return{}}}function Ca(t){try{localStorage.setItem(ua,JSON.stringify(t))}catch{}}const ca=8;function ya(t){return t===0?-1:t>9?8:t-1}function La({lotes:t,pacotesParaFiltro:P,fazendasAspiracaoUnicas:b,lotesHistoricos:U}){const[h]=r.useState(()=>pa()),[m,f]=r.useState(h.filtroFazendaAspiracao??""),[L,re]=r.useState(h.filtroFazendaAspiracaoBusca??""),[w,Q]=r.useState(h.filtroDiaCultivo??""),[V,K]=r.useState(!1),[W,Y]=r.useState(h.filtroHistoricoDataInicio??""),[te,ee]=r.useState(h.filtroHistoricoDataFim??""),[de,v]=r.useState(h.filtroHistoricoFazenda??""),[O,M]=r.useState(h.filtroHistoricoFazendaBusca??""),[k,Z]=r.useState(!1),[J,l]=r.useState(h.abaAtiva??"ativos"),[B,z]=r.useState(h.historicoPage??1);r.useEffect(()=>{Ca({abaAtiva:J,filtroFazendaAspiracao:m,filtroFazendaAspiracaoBusca:L,filtroDiaCultivo:w,filtroHistoricoDataInicio:W,filtroHistoricoDataFim:te,filtroHistoricoFazenda:de,filtroHistoricoFazendaBusca:O,historicoPage:B})},[J,m,L,w,W,te,de,O,B]),r.useEffect(()=>{z(1)},[W,te,de]),r.useEffect(()=>{const o=Math.max(1,Math.ceil(U.length/ca));B>o&&z(o)},[U.length,B]),r.useEffect(()=>{const o=i=>{const x=i.target;x.closest(".fazenda-busca-container")||K(!1),x.closest(".fazenda-busca-historico-container")||Z(!1)};if(V||k)return document.addEventListener("mousedown",o),()=>{document.removeEventListener("mousedown",o)}},[V,k]);const _=r.useMemo(()=>{let o=[...t];if(o=o.filter(i=>i.status==="FECHADO"||i.dia_atual!==void 0&&i.dia_atual>9?!1:i.dia_atual!==void 0&&i.dia_atual<=9),m&&(o=o.filter(i=>{const x=P.find(F=>F.id===i.pacote_aspiracao_id);return(x==null?void 0:x.fazenda_id)===m})),w!==""){const i=parseInt(w);o=o.filter(x=>x.dia_atual===void 0||x.dia_atual===null?!1:(x.dia_atual===0?-1:x.dia_atual-1)===i)}return o},[t,m,w,P]),g=r.useMemo(()=>b.filter(o=>o.nome.toLowerCase().includes(L.toLowerCase())),[b,L]);return{filtroFazendaAspiracao:m,setFiltroFazendaAspiracao:f,filtroFazendaAspiracaoBusca:L,setFiltroFazendaAspiracaoBusca:re,filtroDiaCultivo:w,setFiltroDiaCultivo:Q,showFazendaBusca:V,setShowFazendaBusca:K,fazendasFiltradas:g,lotesFiltrados:_,limparFiltrosAtivos:()=>{f(""),re(""),Q(""),K(!1)},filtroHistoricoDataInicio:W,setFiltroHistoricoDataInicio:Y,filtroHistoricoDataFim:te,setFiltroHistoricoDataFim:ee,filtroHistoricoFazenda:de,setFiltroHistoricoFazenda:v,filtroHistoricoFazendaBusca:O,setFiltroHistoricoFazendaBusca:M,showFazendaBuscaHistorico:k,setShowFazendaBuscaHistorico:Z,limparFiltrosHistorico:()=>{Y(""),ee(""),v(""),M(""),Z(!1),z(1)},abaAtiva:J,setAbaAtiva:l,historicoPage:B,setHistoricoPage:z,HISTORICO_PAGE_SIZE:ca}}function qa(){const{toast:t}=Ce(),[P,b]=r.useState([]),[U,h]=r.useState([]),[m,f]=r.useState([]),[L,re]=r.useState([]),[w,Q]=r.useState([]),[V,K]=r.useState(!0),[W,Y]=r.useState([]),[te,ee]=r.useState([]),de=r.useCallback(async()=>{try{K(!0);const{data:v,error:O}=await c.from("pacotes_aspiracao").select("*").eq("status","FINALIZADO").order("data_aspiracao",{ascending:!1});if(O)throw O;const{data:M,error:k}=await c.from("fazendas").select("id, nome").order("nome",{ascending:!0});if(k)throw k;f(M||[]);const{data:Z,error:J}=await c.from("clientes").select("id, nome").order("nome",{ascending:!0});J||Q(Z||[]);const l=new Map(M==null?void 0:M.map(s=>[s.id,s.nome])),B=new Map,z=new Map,_=(v==null?void 0:v.map(s=>s.id))||[];if(_.length>0){const{data:s,error:S}=await c.from("pacotes_aspiracao_fazendas_destino").select("pacote_aspiracao_id, fazenda_destino_id").in("pacote_aspiracao_id",_);!S&&s&&s.forEach(H=>{const d=l.get(H.fazenda_destino_id);if(d){const T=B.get(H.pacote_aspiracao_id)||[];T.push(d),B.set(H.pacote_aspiracao_id,T)}});const{data:D,error:E}=await c.from("aspiracoes_doadoras").select("pacote_aspiracao_id").in("pacote_aspiracao_id",_);!E&&D&&D.forEach(H=>{H.pacote_aspiracao_id&&z.set(H.pacote_aspiracao_id,(z.get(H.pacote_aspiracao_id)||0)+1)})}const{data:g,error:u}=await c.from("lotes_fiv").select("*").order("data_abertura",{ascending:!1});if(u)throw u;const N=new Set((g==null?void 0:g.map(s=>s.pacote_aspiracao_id).filter(s=>!!s))||[]),i=(v||[]).filter(s=>s.usado_em_lote_fiv!==void 0?!s.usado_em_lote_fiv:!N.has(s.id)).map(s=>({...s,fazenda_nome:l.get(s.fazenda_id),fazendas_destino_nomes:B.get(s.id)||[],quantidade_doadoras:z.get(s.id)||0}));h(i);const x=(g==null?void 0:g.map(s=>s.id))||[],{data:F,error:j}=await c.from("lote_fiv_acasalamentos").select("lote_fiv_id").in("lote_fiv_id",x);if(j)throw j;const q=new Map;F==null||F.forEach(s=>{q.set(s.lote_fiv_id,(q.get(s.lote_fiv_id)||0)+1)});const{data:I,error:A}=await c.from("lote_fiv_fazendas_destino").select("lote_fiv_id, fazenda_id").in("lote_fiv_id",x);if(A)throw A;const a=new Map;I==null||I.forEach(s=>{const S=l.get(s.fazenda_id);if(S){const D=a.get(s.lote_fiv_id)||[];D.push(S),a.set(s.lote_fiv_id,D)}});const n=new Map(i.map(s=>[s.id,s]));(v||[]).forEach(s=>{n.has(s.id)||n.set(s.id,{...s,fazenda_nome:l.get(s.fazenda_id),fazendas_destino_nomes:B.get(s.id)||[],quantidade_doadoras:z.get(s.id)||0})});const C=(g||[]).map(s=>{const S=n.get(s.pacote_aspiracao_id);let D=Ae((S==null?void 0:S.data_aspiracao)||null);if(!D){const d=Ae(s.data_abertura);if(d){const[T,$,le]=d.split("-").map(Number),X=new Date(T,$-1,le);X.setDate(X.getDate()-1);const ie=X.getFullYear(),oe=String(X.getMonth()+1).padStart(2,"0"),ce=String(X.getDate()).padStart(2,"0");D=`${ie}-${oe}-${ce}`}}const E=ta(),H=D?Math.max(0,ia(D,E)):0;return{...s,pacote_nome:S==null?void 0:S.fazenda_nome,pacote_data:S==null?void 0:S.data_aspiracao,fazendas_destino_nomes:a.get(s.id)||[],quantidade_acasalamentos:q.get(s.id)||0,dia_atual:H}}),R=C.filter(s=>s.status==="ABERTO"&&s.dia_atual!==void 0&&s.dia_atual>9);if(R.length>0){const s=R.map(D=>D.id),{error:S}=await c.from("lotes_fiv").update({status:"FECHADO"}).in("id",s);S&&t({title:"Aviso",description:"N√£o foi poss√≠vel fechar automaticamente alguns lotes expirados. Recarregue a p√°gina.",variant:"destructive"}),S||R.forEach(D=>{D.status="FECHADO"})}b(C);const se=new Set(C.map(s=>s.pacote_aspiracao_id).filter(s=>!!s)),ne=[];(v||[]).forEach(s=>{se.has(s.id)&&ne.push({...s,fazenda_nome:l.get(s.fazenda_id),fazendas_destino_nomes:B.get(s.id)||[],quantidade_doadoras:z.get(s.id)||0})}),Y(ne);const _e=new Map;ne.forEach(s=>{s.fazenda_id&&s.fazenda_nome&&_e.set(s.fazenda_id,s.fazenda_nome)}),ee(Array.from(_e.entries()).map(([s,S])=>({id:s,nome:S})).sort((s,S)=>s.nome.localeCompare(S.nome)))}catch(v){Ze(v,"Erro ao carregar dados")}finally{K(!1)}},[t]);return{lotes:P,pacotes:U,fazendas:m,setFazendas:f,doadoras:L,setDoadoras:re,clientes:w,setClientes:Q,loading:V,setLoading:K,pacotesParaFiltro:W,fazendasAspiracaoUnicas:te,loadData:de}}function Ia({setFazendas:t,setDoadoras:P,setClientes:b,setLoading:U}){const{toast:h}=Ce(),[m,f]=r.useState(null),[L,re]=r.useState(!1),[w,Q]=r.useState([]),[V,K]=r.useState([]),[W,Y]=r.useState([]),[te,ee]=r.useState([]),[de,v]=r.useState([]),[O,M]=r.useState(""),[k,Z]=r.useState([]),[J,l]=r.useState([]),[B,z]=r.useState(""),_=r.useCallback(async u=>{try{const{data:N,error:o}=await c.from("embrioes").select("id, lote_fiv_acasalamento_id, created_at").eq("lote_fiv_id",u).order("created_at",{ascending:!1});if(o){Y([]);return}const i=new Map;N==null||N.forEach(j=>{if(j.created_at){const q=j.created_at.split("T")[0],I=i.get(q)||[];I.push(j),i.set(q,I)}});const x=[...new Set((N==null?void 0:N.map(j=>j.lote_fiv_acasalamento_id).filter(Boolean))||[])];if(x.length>0){const{data:j,error:q}=await c.from("lote_fiv_acasalamentos").select("id, aspiracao_doadora_id, dose_semen_id").in("id",x);if(!q&&j){const I=[...new Set(j.map(E=>E.aspiracao_doadora_id).filter(Boolean))],{data:A}=await c.from("aspiracoes_doadoras").select("id, doadora_id").in("id",I),a=[...new Set((A==null?void 0:A.map(E=>E.doadora_id).filter(Boolean))||[])],{data:n}=await c.from("doadoras").select("id, registro, nome").in("id",a),C=[...new Set(j.map(E=>E.dose_semen_id).filter(Boolean))],{data:R}=await c.from("doses_semen").select("id, touro_id, touro:touros(id, nome, registro, raca)").in("id",C),se=new Map((A==null?void 0:A.map(E=>[E.id,E]))||[]),ne=new Map((n==null?void 0:n.map(E=>[E.id,E]))||[]),_e=new Map((R==null?void 0:R.map(E=>[E.id,E]))||[]),s=new Map(j.map(E=>[E.id,E])),D=Array.from(i.keys()).sort((E,H)=>H.localeCompare(E)).map(E=>{const H=i.get(E)||[],d=new Map;H.forEach($=>{$.lote_fiv_acasalamento_id&&d.set($.lote_fiv_acasalamento_id,(d.get($.lote_fiv_acasalamento_id)||0)+1)});const T=Array.from(d.entries()).map(([$,le])=>{var be;const X=s.get($),ie=X?se.get(X.aspiracao_doadora_id):void 0,oe=ie?ne.get(ie.doadora_id):void 0,ce=X?_e.get(X.dose_semen_id):void 0;return{acasalamento_id:$,quantidade:le,doadora:(oe==null?void 0:oe.registro)||(oe==null?void 0:oe.nome)||"-",dose:ce?((be=ce.touro)==null?void 0:be.nome)||"Touro desconhecido":"-"}});return{id:`${u}-${E}`,data_despacho:E,acasalamentos:T}});Y(D);return}}const F=Array.from(i.keys()).map(j=>({id:`${u}-${j}`,data_despacho:j,acasalamentos:[]}));Y(F)}catch{Y([])}},[]),g=r.useCallback(async u=>{try{U(!0);const{data:N,error:o}=await c.from("lotes_fiv").select("*").eq("id",u).single();if(o)throw o;const{data:i,error:x}=await c.from("pacotes_aspiracao").select("*").eq("id",N.pacote_aspiracao_id).single();if(x){if(x.code==="PGRST116"){h({title:"Pacote n√£o encontrado",description:"O lote referencia um pacote de aspira√ß√£o inexistente. Verifique o v√≠nculo do lote.",variant:"destructive"}),U(!1);return}throw x}z(i.data_aspiracao);const{data:F,error:j}=await c.from("fazendas").select("nome").eq("id",i.fazenda_id).single();M(j?"":(F==null?void 0:F.nome)||"");const{data:q}=await c.from("pacotes_aspiracao_fazendas_destino").select("fazenda_destino_id").eq("pacote_aspiracao_id",i.id);let I=[];if(!q||q.length===0?i.fazenda_destino_id&&(I=[i.fazenda_destino_id]):I=q.map(p=>p.fazenda_destino_id),K(I),I.length>0){const{data:p,error:pe}=await c.from("fazendas").select("id, nome").in("id",I);pe?Z([]):(Z((p==null?void 0:p.map(ae=>ae.nome))||[]),p&&t(ae=>{const fe=[...ae];return p.forEach(G=>{fe.find(he=>he.id===G.id)||fe.push(G)}),fe}))}else Z([]);const{data:A,error:a}=await c.from("lote_fiv_acasalamentos").select("*").eq("lote_fiv_id",u).order("created_at",{ascending:!0});if(a)throw a;const n=(A==null?void 0:A.map(p=>p.aspiracao_doadora_id))||[],{data:C,error:R}=await c.from("aspiracoes_doadoras").select("id, doadora_id, viaveis").in("id",n);if(R)throw R;const se=[...new Set((C==null?void 0:C.map(p=>p.doadora_id))||[])],{data:ne,error:_e}=await c.from("doadoras").select("id, nome, registro").in("id",se);if(_e)throw _e;const s=[...new Set((A==null?void 0:A.map(p=>p.dose_semen_id))||[])],{data:S,error:D}=await c.from("doses_semen").select("id, touro_id, touro:touros(id, nome, registro, raca)").in("id",s);if(D)throw D;const E=new Map(ne==null?void 0:ne.map(p=>[p.id,p])),H=new Map(S==null?void 0:S.map(p=>[p.id,p])),d=new Map(C==null?void 0:C.map(p=>[p.id,p])),{data:T,error:$}=await c.from("embrioes").select("lote_fiv_acasalamento_id").eq("lote_fiv_id",u),le=new Map;!$&&T&&T.forEach(p=>{p.lote_fiv_acasalamento_id&&le.set(p.lote_fiv_acasalamento_id,(le.get(p.lote_fiv_acasalamento_id)||0)+1)});const X=(A||[]).map(p=>{const pe=d.get(p.aspiracao_doadora_id),ae=pe?E.get(pe.doadora_id):void 0,fe=H.get(p.dose_semen_id),G=(fe==null?void 0:fe.touro)??null;return{...p,doadora_nome:(ae==null?void 0:ae.nome)||(ae==null?void 0:ae.registro),doadora_registro:ae==null?void 0:ae.registro,dose_nome:(G==null?void 0:G.nome)||"Touro desconhecido",viaveis:pe==null?void 0:pe.viaveis,total_embrioes_produzidos:le.get(p.id)||0}});Q(X),f({...N,pacote_nome:i.fazenda_id,pacote_data:i.data_aspiracao}),re(!0);const{data:ie,error:oe}=await c.from("aspiracoes_doadoras").select("id, doadora_id, viaveis").eq("pacote_aspiracao_id",N.pacote_aspiracao_id);if(!oe){const p=new Map;A==null||A.forEach(G=>{const he=G.aspiracao_doadora_id,Ee=G.quantidade_oocitos||0;p.set(he,(p.get(he)||0)+Ee)});const ae=(ie||[]).filter(G=>{const he=G.viaveis??0,Ee=p.get(G.id)||0,Ie=he-Ee;return he>0&&Ie>0}).map(G=>({...G,oocitos_disponiveis:(G.viaveis??0)-(p.get(G.id)||0)}));ee(ae);const fe=[...new Set((ie==null?void 0:ie.map(G=>G.doadora_id))||[])];if(fe.length>0){const{data:G,error:he}=await c.from("doadoras").select("id, nome, registro").in("id",fe);!he&&G&&P(G)}}const{data:ce,error:be}=await c.from("doses_semen").select("id, touro_id, cliente_id, tipo_semen, quantidade, touro:touros(id, nome, registro, raca)").order("created_at",{ascending:!1});if(be)v([]);else try{const p=N==null?void 0:N.doses_selecionadas;p&&Array.isArray(p)&&p.length>0?v((ce||[]).filter(pe=>p.includes(pe.id))):v(ce||[])}catch{v(ce||[])}const{data:we,error:Se}=await c.from("clientes").select("id, nome").order("nome",{ascending:!0});Se||b(we||[]),await _(u)}catch(N){Ze(N,"Erro ao carregar detalhes do lote")}finally{U(!1)}},[h,_,t,P,b,U]);return{selectedLote:m,setSelectedLote:f,showLoteDetail:L,setShowLoteDetail:re,acasalamentos:w,setAcasalamentos:Q,fazendasDestinoIds:V,historicoDespachos:W,setHistoricoDespachos:Y,aspiracoesDisponiveis:te,dosesDisponiveis:de,fazendaOrigemNome:O,fazendasDestinoNomes:k,dosesDisponiveisNoLote:J,dataAspiracao:B,loadLoteDetail:g,loadHistoricoDespachos:_}}function Pa({filtroHistoricoDataInicio:t,filtroHistoricoDataFim:P,filtroHistoricoFazenda:b,setHistoricoPage:U}){const{toast:h}=Ce(),[m,f]=r.useState([]),[L,re]=r.useState(!1),[w,Q]=r.useState(null),[V,K]=r.useState(null),[W,Y]=r.useState(!1),te=r.useCallback(async()=>{try{re(!0),U(1);let v=c.from("lotes_fiv").select("*").eq("status","FECHADO");t&&(v=v.gte("data_abertura",t)),P&&(v=v.lte("data_abertura",P));const{data:O,error:M}=await v.order("data_abertura",{ascending:!1});if(M)throw M;if(!O||O.length===0){f([]),re(!1);return}const k=O.map(a=>a.id),Z=[...new Set(O.map(a=>a.pacote_aspiracao_id).filter(Boolean))],{data:J}=await c.from("pacotes_aspiracao").select("id, data_aspiracao, fazenda_id, total_oocitos").in("id",Z),{data:l}=await c.from("fazendas").select("id, nome").order("nome",{ascending:!0}),B=new Map((l==null?void 0:l.map(a=>[a.id,a.nome]))||[]),z=(l==null?void 0:l.map(a=>({id:a.id,nome:a.nome})))||[],{data:_}=await c.from("lote_fiv_acasalamentos").select("id, lote_fiv_id, quantidade_embrioes, aspiracao_doadora_id").in("lote_fiv_id",k),{data:g,error:u}=await c.from("embrioes").select("id, lote_fiv_id, lote_fiv_acasalamento_id, classificacao, status_atual").in("lote_fiv_id",k);u&&h({title:"Erro ao buscar embri√µes",description:u.message,variant:"destructive"});const{data:N}=await c.from("lote_fiv_fazendas_destino").select("lote_fiv_id, fazenda_id").in("lote_fiv_id",k),o=[...new Set((_==null?void 0:_.map(a=>a.aspiracao_doadora_id).filter(Boolean))||[])],{data:i}=await c.from("aspiracoes_doadoras").select("id, viaveis").in("id",o),x=new Map((J==null?void 0:J.map(a=>[a.id,a]))||[]),F=new Map,j=new Map,q=new Map,I=new Map((i==null?void 0:i.map(a=>[a.id,a]))||[]);_==null||_.forEach(a=>{F.has(a.lote_fiv_id)||F.set(a.lote_fiv_id,[]),F.get(a.lote_fiv_id).push(a)}),g&&g.length>0&&g.forEach(a=>{a.lote_fiv_id&&(j.has(a.lote_fiv_id)||j.set(a.lote_fiv_id,[]),j.get(a.lote_fiv_id).push(a))}),N==null||N.forEach(a=>{q.has(a.lote_fiv_id)||q.set(a.lote_fiv_id,[]);const n=B.get(a.fazenda_id);n&&q.get(a.lote_fiv_id).push(n)});let A=O.map(a=>{const n=x.get(a.pacote_aspiracao_id),C=F.get(a.id)||[],R=j.get(a.id)||[],se=q.get(a.id)||[],ne=R.length,_e=R.filter(H=>H.status_atual==="TRANSFERIDO").length,s=R.filter(H=>H.status_atual==="CONGELADO").length,S=R.filter(H=>H.status_atual==="DESCARTADO").length,D={};R.forEach(H=>{H.classificacao?D[H.classificacao]=(D[H.classificacao]||0)+1:D.sem_classificacao=(D.sem_classificacao||0)+1});let E=0;return C.forEach(H=>{if(H.aspiracao_doadora_id){const d=I.get(H.aspiracao_doadora_id);d!=null&&d.viaveis&&(E+=d.viaveis)}}),{id:a.id,data_abertura:a.data_abertura,status:a.status,observacoes:a.observacoes,pacote_aspiracao_id:a.pacote_aspiracao_id,pacote_data:n==null?void 0:n.data_aspiracao,pacote_nome:B.get((n==null?void 0:n.fazenda_id)||""),fazenda_origem_nome:B.get((n==null?void 0:n.fazenda_id)||""),fazendas_destino_nomes:se,quantidade_acasalamentos:C.length,total_embrioes_produzidos:ne,total_embrioes_transferidos:_e,total_embrioes_congelados:s,total_embrioes_descartados:S,embrioes_por_classificacao:{BE:D.BE,BN:D.BN,BX:D.BX,BL:D.BL,BI:D.BI,sem_classificacao:D.sem_classificacao},total_oocitos:n==null?void 0:n.total_oocitos,total_viaveis:E>0?E:void 0}});if(b){const a=z.find(n=>n.id===b);a&&(A=A.filter(n=>n.fazenda_origem_nome===a.nome))}f(A)}catch(v){Ze(v,"Erro ao carregar hist√≥rico")}finally{re(!1)}},[t,P,b,U,h]),ee=r.useCallback(async v=>{try{Y(!0);const O=m.find(o=>o.id===v);if(!O){h({title:"Erro",description:"Lote n√£o encontrado",variant:"destructive"});return}const{data:M}=await c.from("pacotes_aspiracao").select("*").eq("id",O.pacote_aspiracao_id).single(),{data:k}=await c.from("lote_fiv_acasalamentos").select("*").eq("lote_fiv_id",v).order("created_at",{ascending:!0}),{data:Z}=await c.from("embrioes").select("*").eq("lote_fiv_id",v).order("created_at",{ascending:!0}),J=[...new Set((k==null?void 0:k.map(o=>o.aspiracao_doadora_id).filter(Boolean))||[])],{data:l}=await c.from("aspiracoes_doadoras").select("*, doadora:doadoras(id, registro, nome)").in("id",J),B=[...new Set((k==null?void 0:k.map(o=>o.dose_semen_id).filter(Boolean))||[])],{data:z}=await c.from("doses_semen").select("*, cliente:clientes(nome), touro:touros(id, nome, registro, raca)").in("id",B),_=new Map((l==null?void 0:l.map(o=>[o.id,o]))||[]),g=new Map((z==null?void 0:z.map(o=>[o.id,o]))||[]),u=new Map;(Z||[]).forEach(o=>{const i=o.lote_fiv_acasalamento_id||"sem_acasalamento";u.has(i)||u.set(i,{total:0,porStatus:{},porClassificacao:{}});const x=u.get(i);x.total++;const F=o.status_atual||"sem_status";x.porStatus[F]=(x.porStatus[F]||0)+1;const j=o.classificacao||"sem_classificacao";x.porClassificacao[j]=(x.porClassificacao[j]||0)+1});const N={lote:O,pacote:M?{id:M.id,data_aspiracao:M.data_aspiracao,horario_inicio:M.horario_inicio,horario_final:M.horario_final,veterinario_responsavel:M.veterinario_responsavel,tecnico_responsavel:M.tecnico_responsavel,total_oocitos:M.total_oocitos,observacoes:M.observacoes}:void 0,acasalamentos:(k||[]).map(o=>{var q,I,A,a;const i=o.aspiracao_doadora_id?_.get(o.aspiracao_doadora_id):null,x=o.dose_semen_id?g.get(o.dose_semen_id):null,F=i==null?void 0:i.doadora,j=u.get(o.id)||{total:0,porStatus:{},porClassificacao:{}};return{id:o.id,aspiracao_id:o.aspiracao_doadora_id,doadora:F?{registro:F.registro,nome:F.nome}:void 0,aspiracao:i?{data_aspiracao:i.data_aspiracao,horario_aspiracao:i.horario_aspiracao,viaveis:i.viaveis,expandidos:i.expandidos,total_oocitos:i.total_oocitos,atresicos:i.atresicos,degenerados:i.degenerados,desnudos:i.desnudos,veterinario_responsavel:i.veterinario_responsavel}:void 0,dose_semen:x?{nome:((q=x.touro)==null?void 0:q.nome)||"Touro desconhecido",registro:(I=x.touro)==null?void 0:I.registro,raca:((A=x.touro)==null?void 0:A.raca)||x.raca,tipo_semen:x.tipo_semen,cliente:(a=x.cliente)==null?void 0:a.nome}:void 0,quantidade_fracionada:o.quantidade_fracionada,quantidade_oocitos:o.quantidade_oocitos,quantidade_embrioes:o.quantidade_embrioes,observacoes:o.observacoes,resumo_embrioes:j}}),embrioes:(Z||[]).map(o=>({id:o.id,identificacao:o.identificacao,classificacao:o.classificacao,tipo_embriao:o.tipo_embriao,status_atual:o.status_atual,acasalamento_id:o.lote_fiv_acasalamento_id}))};K(N)}catch(O){Ze(O,"Erro ao carregar detalhes")}finally{Y(!1)}},[m,h]),de=r.useCallback(async v=>{w===v?(Q(null),K(null)):(Q(v),await ee(v))},[w,ee]);return{lotesHistoricos:m,loadingHistorico:L,loteExpandido:w,detalhesLoteExpandido:V,loadingDetalhes:W,loadLotesHistoricos:te,handleExpandirLote:de}}function Oa({id:t,filtroHistoricoDataInicio:P,filtroHistoricoDataFim:b,filtroHistoricoFazenda:U,setHistoricoPage:h}){const m=qa(),f=Ia({setFazendas:m.setFazendas,setDoadoras:m.setDoadoras,setClientes:m.setClientes,setLoading:m.setLoading}),L=Pa({filtroHistoricoDataInicio:P,filtroHistoricoDataFim:b,filtroHistoricoFazenda:U,setHistoricoPage:h});return r.useEffect(()=>{t?f.loadLoteDetail(t):m.loadData()},[t,m.loadData,f.loadLoteDetail]),{lotes:m.lotes,pacotes:m.pacotes,fazendas:m.fazendas,setFazendas:m.setFazendas,doadoras:m.doadoras,clientes:m.clientes,loading:m.loading,selectedLote:f.selectedLote,setSelectedLote:f.setSelectedLote,showLoteDetail:f.showLoteDetail,setShowLoteDetail:f.setShowLoteDetail,acasalamentos:f.acasalamentos,setAcasalamentos:f.setAcasalamentos,fazendasDestinoIds:f.fazendasDestinoIds,historicoDespachos:f.historicoDespachos,setHistoricoDespachos:f.setHistoricoDespachos,aspiracoesDisponiveis:f.aspiracoesDisponiveis,dosesDisponiveis:f.dosesDisponiveis,fazendaOrigemNome:f.fazendaOrigemNome,fazendasDestinoNomes:f.fazendasDestinoNomes,dosesDisponiveisNoLote:f.dosesDisponiveisNoLote,dataAspiracao:f.dataAspiracao,pacotesParaFiltro:m.pacotesParaFiltro,fazendasAspiracaoUnicas:m.fazendasAspiracaoUnicas,lotesHistoricos:L.lotesHistoricos,loadingHistorico:L.loadingHistorico,loteExpandido:L.loteExpandido,detalhesLoteExpandido:L.detalhesLoteExpandido,loadingDetalhes:L.loadingDetalhes,loadData:m.loadData,loadLoteDetail:f.loadLoteDetail,loadLotesHistoricos:L.loadLotesHistoricos,handleExpandirLote:L.handleExpandirLote}}function Ma({pacotes:t,clientes:P,fazendas:b}){var J;const U=oa(),{toast:h}=Ce(),[m,f]=r.useState(!1),[L,re]=r.useState(!1),[w,Q]=r.useState({pacote_aspiracao_id:"",observacoes:"",doses_selecionadas:[]}),[V,K]=r.useState(null),[W,Y]=r.useState([]),[te,ee]=r.useState([]),[de,v]=r.useState([]),O=async l=>{Q({...w,pacote_aspiracao_id:l});const B=t.find(z=>z.id===l);if(K(B||null),B){const{data:z,error:_}=await c.from("aspiracoes_doadoras").select("id, doadora_id, viaveis").eq("pacote_aspiracao_id",l);if(_)return;ee(z||[]);const g=[...new Set((z==null?void 0:z.map(o=>o.doadora_id))||[])];if(g.length>0){const{data:o,error:i}=await c.from("doadoras").select("id, nome, registro").in("id",g);if(i)return;v(o||[])}const{data:u,error:N}=await c.from("doses_semen").select("id, cliente_id, touro_id, tipo_semen, quantidade, touro:touros(id, nome, registro, raca)").order("created_at",{ascending:!1});if(N)return;Y(u||[])}},M=async l=>{var B,z;if(l.preventDefault(),!w.pacote_aspiracao_id){h({title:"Erro de valida√ß√£o",description:"Pacote de aspira√ß√£o √© obrigat√≥rio",variant:"destructive"});return}if(!V){h({title:"Erro de valida√ß√£o",description:"Pacote selecionado n√£o encontrado",variant:"destructive"});return}try{re(!0);const{data:_,error:g}=await c.from("pacotes_aspiracao").select("id, status").eq("id",w.pacote_aspiracao_id).single();if(g||!_){h({title:"Erro de valida√ß√£o",description:"Pacote de aspira√ß√£o n√£o encontrado ou inv√°lido",variant:"destructive"});return}if(_.status!=="FINALIZADO"){h({title:"Erro de valida√ß√£o",description:"Apenas pacotes FINALIZADOS podem ser usados para criar lotes FIV",variant:"destructive"});return}const u=new Date(V.data_aspiracao);u.setDate(u.getDate()+1);const N=u.toISOString().split("T")[0],o={pacote_aspiracao_id:w.pacote_aspiracao_id,data_abertura:N,data_fecundacao:N,status:"ABERTO",observacoes:w.observacoes||null};if(w.doses_selecionadas&&w.doses_selecionadas.length>0)try{o.doses_selecionadas=w.doses_selecionadas}catch{}let i;const{data:x,error:F}=await c.from("lotes_fiv").insert([o]).select().single();if(F)if((B=F.message)!=null&&B.includes("doses_selecionadas")||F.code==="42703"){delete o.doses_selecionadas;const{data:q,error:I}=await c.from("lotes_fiv").insert([o]).select().single();if(I)throw I;i=q}else throw F;else i=x;const j=(z=V.fazendas_destino_nomes)==null?void 0:z.map(q=>{const I=b.find(A=>A.nome===q);return I==null?void 0:I.id}).filter(q=>!!q);if(j&&j.length>0){const{error:q}=await c.from("lote_fiv_fazendas_destino").insert(j.map(I=>({lote_fiv_id:i.id,fazenda_id:I})));if(q)throw q}try{await c.from("pacotes_aspiracao").update({usado_em_lote_fiv:!0}).eq("id",w.pacote_aspiracao_id)}catch{}h({title:"Lote FIV criado",description:"Lote FIV criado com sucesso. Agora voc√™ pode adicionar acasalamentos."}),f(!1),k(),U(`/lotes-fiv/${i.id}`)}catch(_){const g=_ instanceof Error?_.message:"Erro desconhecido";h({title:"Erro ao criar lote",description:g.includes("RLS")||g.includes("policy")?"RLS est√° bloqueando escrita. Configure pol√≠ticas anon no Supabase.":g,variant:"destructive"})}finally{re(!1)}},k=()=>{Q({pacote_aspiracao_id:"",observacoes:"",doses_selecionadas:[]}),K(null),ee([]),v([]),Y([])},Z=()=>{f(!1),k()};return e.jsxs(Ke,{open:m,onOpenChange:f,children:[e.jsx(Da,{asChild:!0,children:e.jsxs(xe,{children:[e.jsx(ma,{className:"w-4 h-4 mr-2"}),"Novo Lote"]})}),e.jsxs(We,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(ea,{children:[e.jsx(aa,{children:"Criar Novo Lote FIV"}),e.jsx(sa,{children:"Selecione um pacote de aspira√ß√£o FINALIZADO para criar o lote"})]}),e.jsxs("form",{onSubmit:M,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ve,{htmlFor:"pacote_aspiracao_id",children:"Pacote de Aspira√ß√£o *"}),t.length===0?e.jsxs("div",{className:"border rounded-lg p-4 bg-yellow-50 border-yellow-200",children:[e.jsx("p",{className:"text-sm text-yellow-800 font-medium mb-2",children:"Nenhum pacote dispon√≠vel"}),e.jsxs("p",{className:"text-sm text-yellow-700",children:["Verifique se o pacote de aspira√ß√£o est√° com status ",e.jsx("strong",{children:"FINALIZADO"})," e ainda n√£o foi usado para criar um lote FIV."]})]}):e.jsxs(Te,{value:w.pacote_aspiracao_id,onValueChange:O,children:[e.jsx($e,{children:e.jsx(ke,{placeholder:"Selecione o pacote"})}),e.jsx(Re,{children:t.map(l=>e.jsxs(Ve,{value:l.id,children:[Ne(l.data_aspiracao)," - ",l.fazenda_nome," (",l.quantidade_doadoras," doadoras)"]},l.id))})]}),V&&e.jsxs("div",{className:"text-sm text-slate-600 space-y-1 mt-2 p-3 bg-slate-50 rounded-lg",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Data do Pacote:"})," ",Ne(V.data_aspiracao)]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Data de Fecunda√ß√£o do Lote:"})," ",(()=>{const l=new Date(V.data_aspiracao);return l.setDate(l.getDate()+1),Ne(l.toISOString().split("T")[0])})()]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Fazendas Destino:"})," ",((J=V.fazendas_destino_nomes)==null?void 0:J.join(", "))||"Nenhuma"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Quantidade de Doadoras:"})," ",V.quantidade_doadoras||0]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ve,{children:"Doses de S√™men Dispon√≠veis no Lote *"}),e.jsx("div",{className:"border rounded-lg p-4 max-h-60 overflow-y-auto",children:W.length===0?e.jsx("p",{className:"text-sm text-slate-500",children:V?"Carregando doses...":"Selecione um pacote primeiro"}):e.jsx("div",{className:"space-y-2",children:W.map(l=>{var _,g;const B=P.find(u=>u.id===l.cliente_id),z=w.doses_selecionadas.includes(l.id);return e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:`dose-${l.id}`,checked:z,onChange:u=>{u.target.checked?Q({...w,doses_selecionadas:[...w.doses_selecionadas,l.id]}):Q({...w,doses_selecionadas:w.doses_selecionadas.filter(N=>N!==l.id)})},className:"rounded"}),e.jsxs("label",{htmlFor:`dose-${l.id}`,className:"text-sm cursor-pointer flex-1",children:[e.jsx("span",{className:"font-medium",children:((_=l.touro)==null?void 0:_.nome)||"Touro desconhecido"}),((g=l.touro)==null?void 0:g.registro)&&e.jsxs("span",{className:"text-slate-500 ml-2",children:["(",l.touro.registro,")"]}),B&&e.jsxs("span",{className:"text-slate-500 ml-2",children:["- ",B.nome]})]})]},l.id)})})}),e.jsx("p",{className:"text-xs text-slate-500",children:"Selecione as doses de s√™men que estar√£o dispon√≠veis para uso neste lote"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ve,{htmlFor:"observacoes",children:"Observa√ß√µes"}),e.jsx(la,{id:"observacoes",value:w.observacoes,onChange:l=>Q({...w,observacoes:l.target.value}),placeholder:"Observa√ß√µes sobre o lote",rows:3})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(xe,{type:"submit",className:"flex-1",disabled:L,children:L?"Criando...":"Criar Lote"}),e.jsx(xe,{type:"button",variant:"outline",onClick:Z,disabled:L,children:"Cancelar"})]})]})]})]})}function ze(t){return{[-1]:"Aspira√ß√£o",0:"Fecunda√ß√£o",1:"Zigoto",2:"2 C√©lulas",3:"4 C√©lulas",4:"8 C√©lulas",5:"M√≥rula",6:"Blastocisto",7:"Blastocisto Expandido",8:"Blastocisto Expandido"}[t]||`D${t}`}function Ba({lote:t,acasalamentos:P,aspiracoesDisponiveis:b,dosesDisponiveis:U,dosesDisponiveisNoLote:h,doadoras:m,clientes:f,historicoDespachos:L,dataAspiracao:re,fazendaOrigemNome:w,fazendasDestinoNomes:Q,submitting:V,onBack:K,onAddAcasalamento:W,onDespacharEmbrioes:Y,onUpdateQuantidadeEmbrioes:te,editQuantidadeEmbrioes:ee,onUpdateClivados:de,editClivados:v={}}){var A;const O=oa(),{toast:M}=Ce(),[k,Z]=r.useState(!1),[J,l]=r.useState(!1),[B,z]=r.useState(""),[_,g]=r.useState({aspiracao_doadora_id:"",dose_semen_id:"",quantidade_fracionada:"1.0",quantidade_oocitos:"",observacoes:""});let u=Ae(re||t.pacote_data||null);if(!u){const a=Ae(t.data_abertura);if(a){const[n,C,R]=a.split("-").map(Number),se=new Date(n,C-1,R);se.setDate(se.getDate()-1),u=`${se.getFullYear()}-${String(se.getMonth()+1).padStart(2,"0")}-${String(se.getDate()).padStart(2,"0")}`}}if(!u)return e.jsx("div",{children:"Erro: Data de aspira√ß√£o n√£o encontrada"});const N=ta(),o=Math.max(0,ia(u,N)),i=ya(o),x=ba(u,8),F=Ne(x),j=wa(x),q=async a=>{if(a.preventDefault(),!_.aspiracao_doadora_id){M({title:"Erro de valida√ß√£o",description:"Doadora √© obrigat√≥ria",variant:"destructive"});return}if(!_.dose_semen_id){M({title:"Erro de valida√ß√£o",description:"Selecione uma dose de s√™men",variant:"destructive"});return}if((parseFloat(_.quantidade_fracionada)||0)<=0){M({title:"Erro de valida√ß√£o",description:"Quantidade fracionada deve ser maior que zero",variant:"destructive"});return}try{await W(_),Z(!1),g({aspiracao_doadora_id:"",dose_semen_id:"",quantidade_fracionada:"1.0",quantidade_oocitos:"",observacoes:""}),z("")}catch{}},I=()=>{K(),O("/lotes-fiv")};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(xe,{variant:"ghost",size:"sm",onClick:I,children:e.jsx(Na,{className:"w-4 h-4"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-slate-900",children:"Detalhes do Lote FIV"}),e.jsxs("div",{className:"text-slate-600 mt-1 flex items-center gap-2",children:[e.jsxs("span",{children:["Data de fecunda√ß√£o (D0): ",Ne(t.data_abertura)," |",u&&` Data aspira√ß√£o (D-1): ${Ne(u)} |`,i===-1?` D-1 - ${ze(i)} |`:` D${i} - ${ze(i)} |`," ","Status:"]}),e.jsx(Ue,{variant:t.status==="FECHADO"?"default":"secondary",children:t.status})]})]})]}),e.jsxs(Oe,{children:[e.jsx(Me,{children:e.jsx(Be,{children:"Informa√ß√µes do Lote"})}),e.jsxs(He,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(ve,{children:"Dia Atual"}),e.jsx("p",{className:"text-2xl font-bold",children:i===-1?e.jsxs(e.Fragment,{children:["D-1 ",e.jsxs("span",{className:"text-lg font-normal text-slate-600",children:["- ",ze(i)]})]}):e.jsxs(e.Fragment,{children:["D",i," ",e.jsxs("span",{className:"text-lg font-normal text-slate-600",children:["- ",ze(i)]})]})})]}),e.jsxs("div",{children:[e.jsx(ve,{children:"Data da TE"}),o<7?e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-orange-600",children:F}),e.jsx("p",{className:"text-sm text-slate-500",children:j})]}):e.jsx("p",{className:"text-2xl font-bold text-green-600",children:"Hoje ou passou"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(ve,{children:"Fazenda de Origem"}),e.jsx("p",{className:"font-medium",children:w||t.pacote_nome||"-"})]}),e.jsxs("div",{children:[e.jsx(ve,{children:"Fazendas de Destino"}),e.jsx("p",{className:"font-medium",children:Q.length>0?Q.join(", "):((A=t.fazendas_destino_nomes)==null?void 0:A.join(", "))||"-"})]})]}),t.observacoes&&e.jsxs("div",{children:[e.jsx(ve,{children:"Observa√ß√µes"}),e.jsx("p",{className:"text-slate-600",children:t.observacoes})]}),t.status==="ABERTO"&&o===7&&e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"text-blue-800 font-medium",children:["üìä Este lote est√° no D6 (",ze(6),"). Voc√™ pode preencher a quantidade de embri√µes (pr√©via) e gerar um relat√≥rio."]}),e.jsxs(xe,{variant:"outline",size:"sm",onClick:()=>l(!0),children:[e.jsx(Sa,{className:"w-4 h-4 mr-2"}),"Gerar Relat√≥rio de Pr√©via"]})]})}),(t.status==="ABERTO"&&(o===8||o===9)||t.status==="FECHADO"&&o===9)&&e.jsx("div",{className:"bg-orange-50 border border-orange-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"text-orange-800 font-medium",children:["‚ö†Ô∏è Este lote est√° no ",o===8?"D7":"D8"," (",ze(o===8?7:8),"). ",o===8?"Informe a quantidade de embri√µes para cada acasalamento e despache os embri√µes.":"Per√≠odo de emerg√™ncia (D8). Voc√™ pode adicionar novos acasalamentos e despachar os embri√µes imediatamente."]}),e.jsxs(xe,{variant:"default",size:"sm",onClick:Y,disabled:V,children:[e.jsx(da,{className:"w-4 h-4 mr-2"}),V?"Despachando...":"Despachar Todos os Embri√µes"]})]})})]})]}),e.jsxs(Oe,{children:[e.jsx(Me,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Be,{className:"flex items-center gap-2",children:[e.jsx(ra,{className:"w-5 h-5"}),"Acasalamentos (",P.length,")"]}),t.status==="ABERTO"&&e.jsxs(xe,{size:"sm",onClick:()=>Z(!0),children:[e.jsx(ma,{className:"w-4 h-4 mr-2"}),"Adicionar Acasalamento"]})]})}),e.jsx(He,{children:P.length===0?e.jsxs("div",{className:"text-center py-8 text-slate-500",children:[e.jsx(ra,{className:"w-12 h-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"Nenhum acasalamento cadastrado"}),t.status==="ABERTO"&&e.jsx(xe,{variant:"outline",size:"sm",className:"mt-2",onClick:()=>Z(!0),children:"Adicionar primeiro acasalamento"})]}):e.jsxs(Ye,{children:[e.jsx(Je,{children:e.jsxs(Fe,{children:[e.jsx(me,{children:"Doadora"}),e.jsx(me,{children:"Touro"}),e.jsx(me,{className:"text-center",children:"O√≥citos"}),e.jsx(me,{className:"text-center",children:"D3 Clivados"}),e.jsx(me,{className:"text-center",children:"Qtd. Embri√µes"}),e.jsx(me,{className:"text-center",children:"%"}),e.jsx(me,{children:"Observa√ß√µes"})]})}),e.jsx(Xe,{children:P.map(a=>{const n=a.viaveis||0,C=v[a.id],R=a.embrioes_clivados_d3,se=C!==void 0?C:(R==null?void 0:R.toString())??"",ne=parseInt(se)||0,_e=ne>0?ne:n,s=ee[a.id]!==void 0?parseInt(ee[a.id])||0:a.total_embrioes_produzidos||0,S=n>0?(s/n*100).toFixed(1):"0.0";return e.jsxs(Fe,{children:[e.jsx(ue,{children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:a.doadora_registro||"-"}),a.doadora_nome&&e.jsx("p",{className:"text-sm text-slate-500",children:a.doadora_nome})]})}),e.jsx(ue,{children:a.dose_nome||"-"}),e.jsx(ue,{className:"text-center",children:n}),e.jsx(ue,{className:"text-center",children:t.status==="ABERTO"&&i>=3&&de?e.jsx(qe,{type:"number",min:"0",max:n,className:"w-20 text-center",value:se,onChange:D=>de(a.id,D.target.value),placeholder:"-"}):e.jsx("span",{children:ne>0?ne:"-"})}),e.jsx(ue,{className:"text-center",children:t.status==="ABERTO"&&o>=7?e.jsx(qe,{type:"number",min:"0",max:_e,className:"w-20 text-center",value:ee[a.id]??a.total_embrioes_produzidos??"",onChange:D=>te(a.id,D.target.value),placeholder:"0"}):e.jsx("span",{children:s})}),e.jsx(ue,{className:"text-center",children:e.jsxs(Ue,{variant:parseFloat(S)>=30?"default":"secondary",children:[S,"%"]})}),e.jsx(ue,{className:"max-w-[200px] truncate",children:a.observacoes||"-"})]},a.id)})})]})})]}),L.length>0&&e.jsxs(Oe,{children:[e.jsx(Me,{children:e.jsxs(Be,{className:"flex items-center gap-2",children:[e.jsx(da,{className:"w-5 h-5"}),"Hist√≥rico de Despachos"]})}),e.jsx(He,{children:e.jsx("div",{className:"space-y-4",children:L.map(a=>e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsxs("p",{className:"font-medium mb-2",children:["Despacho em ",Ne(a.data_despacho)]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2",children:a.acasalamentos.map((n,C)=>e.jsxs("div",{className:"text-sm bg-slate-50 rounded p-2",children:[e.jsx("span",{className:"font-medium",children:n.doadora}),e.jsxs("span",{className:"text-slate-500",children:[" x ",n.dose]}),e.jsxs("span",{className:"ml-2 text-green-600 font-medium",children:["(",n.quantidade,")"]})]},C))})]},a.id))})})]}),e.jsx(Ke,{open:k,onOpenChange:Z,children:e.jsxs(We,{className:"max-w-lg",children:[e.jsxs(ea,{children:[e.jsx(aa,{children:"Adicionar Acasalamento"}),e.jsx(sa,{children:"Selecione a doadora e a dose de s√™men para o acasalamento"})]}),e.jsxs("form",{onSubmit:q,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ve,{children:"Doadora *"}),e.jsxs(Te,{value:_.aspiracao_doadora_id,onValueChange:a=>{g({..._,aspiracao_doadora_id:a});const n=b.find(C=>C.id===a);n&&g(C=>({...C,aspiracao_doadora_id:a,quantidade_oocitos:String(n.oocitos_disponiveis||n.viaveis||0)}))},children:[e.jsx($e,{children:e.jsx(ke,{placeholder:"Selecione a doadora"})}),e.jsx(Re,{children:b.map(a=>{const n=m.find(C=>C.id===a.doadora_id);return e.jsxs(Ve,{value:a.id,children:[(n==null?void 0:n.registro)||(n==null?void 0:n.nome)||"Doadora"," - ",a.oocitos_disponiveis??a.viaveis??0," o√≥citos dispon√≠veis"]},a.id)})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ve,{children:"Dose de S√™men *"}),e.jsxs(Te,{value:_.dose_semen_id,onValueChange:a=>g({..._,dose_semen_id:a}),children:[e.jsx($e,{children:e.jsx(ke,{placeholder:"Selecione a dose"})}),e.jsx(Re,{children:(h.length>0?h:U).map(a=>{var C,R;const n=f.find(se=>se.id===a.cliente_id);return e.jsxs(Ve,{value:a.id,children:[((C=a.touro)==null?void 0:C.nome)||"Touro desconhecido",((R=a.touro)==null?void 0:R.registro)&&` (${a.touro.registro})`,n&&` - ${n.nome}`]},a.id)})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ve,{children:"Qtd. Fracionada"}),e.jsx(qe,{type:"number",step:"0.1",min:"0",value:_.quantidade_fracionada,onChange:a=>g({..._,quantidade_fracionada:a.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ve,{children:"Qtd. O√≥citos"}),e.jsx(qe,{type:"number",min:"0",value:_.quantidade_oocitos,onChange:a=>g({..._,quantidade_oocitos:a.target.value}),placeholder:"Auto"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ve,{children:"Observa√ß√µes"}),e.jsx(la,{value:_.observacoes,onChange:a=>g({..._,observacoes:a.target.value}),placeholder:"Observa√ß√µes sobre o acasalamento",rows:2})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(xe,{type:"submit",className:"flex-1",disabled:V,children:V?"Adicionando...":"Adicionar"}),e.jsx(xe,{type:"button",variant:"outline",onClick:()=>{Z(!1),g({aspiracao_doadora_id:"",dose_semen_id:"",quantidade_fracionada:"1.0",quantidade_oocitos:"",observacoes:""})},children:"Cancelar"})]})]})]})}),e.jsx(Ke,{open:J,onOpenChange:l,children:e.jsxs(We,{className:"max-w-2xl",children:[e.jsxs(ea,{children:[e.jsx(aa,{children:"Relat√≥rio de Pr√©via - D6"}),e.jsx(sa,{children:"Resumo dos acasalamentos e embri√µes previstos"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"border rounded-lg p-4 bg-slate-50",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Informa√ß√µes do Lote"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-slate-500",children:"Fazenda Origem:"})," ",w||t.pacote_nome]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-slate-500",children:"Fazendas Destino:"})," ",Q.join(", ")||"-"]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-slate-500",children:"Data TE prevista:"})," ",F]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-slate-500",children:"Total Acasalamentos:"})," ",P.length]})]})]}),e.jsxs(Ye,{children:[e.jsx(Je,{children:e.jsxs(Fe,{children:[e.jsx(me,{children:"Doadora"}),e.jsx(me,{children:"Touro"}),e.jsx(me,{className:"text-center",children:"O√≥citos"}),e.jsx(me,{className:"text-center",children:"Embri√µes (prev.)"})]})}),e.jsx(Xe,{children:P.map(a=>e.jsxs(Fe,{children:[e.jsx(ue,{children:a.doadora_registro||"-"}),e.jsx(ue,{children:a.dose_nome||"-"}),e.jsx(ue,{className:"text-center",children:a.viaveis||0}),e.jsx(ue,{className:"text-center",children:ee[a.id]??a.total_embrioes_produzidos??"-"})]},a.id))})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(xe,{onClick:()=>l(!1),children:"Fechar"})})]})]})})]})}function ms(){const{id:t}=xa(),P=oa(),{toast:b}=Ce(),[U,h]=r.useState(!1),[m,f]=r.useState({}),[L,re]=r.useState({}),[w,Q]=r.useState(()=>pa().historicoPage??1),V=r.useCallback(d=>{Q(d)},[]),{filtroFazendaAspiracao:K,setFiltroFazendaAspiracao:W,filtroFazendaAspiracaoBusca:Y,setFiltroFazendaAspiracaoBusca:te,filtroDiaCultivo:ee,setFiltroDiaCultivo:de,showFazendaBusca:v,setShowFazendaBusca:O,filtroHistoricoDataInicio:M,filtroHistoricoDataFim:k,filtroHistoricoFazenda:Z}=La({lotes:[],pacotesParaFiltro:[],fazendasAspiracaoUnicas:[],lotesHistoricos:[]}),{lotes:J,pacotes:l,fazendas:B,doadoras:z,clientes:_,loading:g,selectedLote:u,setSelectedLote:N,showLoteDetail:o,setShowLoteDetail:i,acasalamentos:x,fazendasDestinoIds:F,historicoDespachos:j,setHistoricoDespachos:q,aspiracoesDisponiveis:I,dosesDisponiveis:A,fazendaOrigemNome:a,fazendasDestinoNomes:n,dosesDisponiveisNoLote:C,dataAspiracao:R,pacotesParaFiltro:se,fazendasAspiracaoUnicas:ne,loadLoteDetail:_e}=Oa({id:t,filtroHistoricoDataInicio:M,filtroHistoricoDataFim:k,filtroHistoricoFazenda:Z,setHistoricoPage:V}),s=Ha(J,se,K,ee),S=Ta(ne,Y),D=r.useCallback(()=>{W(""),te(""),de(""),O(!1)},[W,te,de,O]),E=async()=>{var d,T;if(u)try{h(!0);const $=l.find(y=>y.id===u.pacote_aspiracao_id);let le=Ae(($==null?void 0:$.data_aspiracao)||null);if(!le){const y=Ae(u.data_abertura);if(y){const[ge,De,ye]=y.split("-").map(Number),je=new Date(ge,De-1,ye);je.setDate(je.getDate()-1);const Le=je.getFullYear(),Pe=String(je.getMonth()+1).padStart(2,"0"),Qe=String(je.getDate()).padStart(2,"0");le=`${Le}-${Pe}-${Qe}`}}const X=ta();if((le?Math.max(0,ia(le,X)):0)>9){b({title:"Prazo expirado",description:"D8 √© o √∫ltimo dia. N√£o √© poss√≠vel criar embri√µes ap√≥s o D8. O lote ser√° fechado e n√£o aparecer√° mais na lista.",variant:"destructive"}),h(!1);return}const oe=x.filter(y=>{var De;return parseInt(m[y.id]||((De=y.quantidade_embrioes)==null?void 0:De.toString())||"0")>0});if(oe.length===0){b({title:"Nenhum embri√£o para despachar",description:"Preencha a quantidade de embri√µes em pelo menos um acasalamento antes de despachar.",variant:"destructive"});return}for(const y of oe){const ge=parseInt(m[y.id]||((d=y.quantidade_embrioes)==null?void 0:d.toString())||"0"),De=y.quantidade_oocitos??0,ye=L[y.id],je=y.embrioes_clivados_d3,Le=parseInt(ye??(je==null?void 0:je.toString())??"")||0,Pe=Le>0?Le:De;if(ge>Pe){const Qe=y.doadora_nome||y.doadora_registro||"Doadora desconhecida",ha=Le>0?"clivados (D3)":"o√≥citos";b({title:"Valida√ß√£o de quantidade",description:`O acasalamento da doadora "${Qe}" possui ${ge} embri√µes, mas o limite de ${ha} √© ${Pe}. A quantidade de embri√µes n√£o pode exceder esse limite.`,variant:"destructive"});return}}const ce=`${a} - ${n.join(", ")}`,be=new Date().toISOString().split("T")[0];if(!F.length){b({title:"Erro ao despachar",description:"√â necess√°rio ter pelo menos uma fazenda destino configurada no lote.",variant:"destructive"});return}let we="EMB";const Se=le||"",p=Se.slice(8,10)+Se.slice(5,7);if($!=null&&$.fazenda_id){const{data:y,error:ge}=await c.from("fazendas").select("sigla, nome").eq("id",$.fazenda_id).single();!ge&&y&&(y.sigla?we=y.sigla:y.nome&&(we=y.nome.replace(/[^a-zA-Z]/g,"").substring(0,3).toUpperCase()||"EMB"))}const pe=`${we}-${p}`;let ae=1;const{count:fe,error:G}=await c.from("embrioes").select("*",{count:"exact",head:!0}).like("identificacao",`${pe}-%`);!G&&fe!==null&&(ae=fe+1);const he=[],Ee=[];let Ie=0;for(const y of oe){const ge=parseInt(m[y.id]||((T=y.quantidade_embrioes)==null?void 0:T.toString())||"0");if(ge>0){for(let De=0;De<ge;De++){const ye=String(ae+Ie).padStart(3,"0"),je={lote_fiv_id:u.id,lote_fiv_acasalamento_id:y.id,status_atual:"FRESCO",identificacao:`${pe}-${ye}`};he.push(je),Ie++}Ee.push({acasalamento_id:y.id,quantidade:ge,doadora:y.doadora_registro||y.doadora_nome,dose:y.dose_nome})}}if(he.length>0){const{error:y}=await c.from("embrioes").insert(he);if(y)throw y}const fa={id:`${u.id}-${be}`,data_despacho:be,acasalamentos:Ee};q([fa,...j]);const _a=oe.map(y=>c.from("lote_fiv_acasalamentos").update({quantidade_embrioes:null}).eq("id",y.id));await Promise.all(_a),f({}),b({title:"Embri√µes despachados",description:`${he.length} embri√£o(√µes) foram despachados para ${ce}.`}),_e(u.id)}catch($){b({title:"Erro ao despachar embri√µes",description:$ instanceof Error?$.message:"Erro desconhecido",variant:"destructive"})}finally{h(!1)}},H=async d=>{var $,le;if(!u)return;const T=parseFloat(d.quantidade_fracionada)||0;try{h(!0);const X=I.find(fe=>fe.id===d.aspiracao_doadora_id),ie=(X==null?void 0:X.oocitos_disponiveis)??0,oe=parseInt(d.quantidade_oocitos)||0;if(oe>ie)throw b({title:"Erro de valida√ß√£o",description:`A quantidade de o√≥citos (${oe}) n√£o pode ser maior que os o√≥citos dispon√≠veis (${ie})`,variant:"destructive"}),new Error("Valida√ß√£o falhou");const{data:ce,error:be}=await c.from("doses_semen").select("id, quantidade").eq("id",d.dose_semen_id).single();if(be)throw be;const we=(ce==null?void 0:ce.quantidade)??0;if(we<T)throw b({title:"Estoque insuficiente",description:`Quantidade dispon√≠vel (${we}) √© menor que a quantidade fracionada (${T}).`,variant:"destructive"}),new Error("Estoque insuficiente");const Se={lote_fiv_id:u.id,aspiracao_doadora_id:d.aspiracao_doadora_id,dose_semen_id:d.dose_semen_id,quantidade_fracionada:T,quantidade_oocitos:oe>0?oe:null,observacoes:d.observacoes||null},{error:p}=await c.from("lote_fiv_acasalamentos").insert([Se]);if(p){if(p.code==="23505"||($=p.message)!=null&&$.includes("duplicate")||(le=p.message)!=null&&le.includes("unique")){b({title:"Acasalamento duplicado",description:"J√° existe um acasalamento com esta doadora e dose de s√™men neste lote. Edite o existente ou escolha outra combina√ß√£o.",variant:"destructive"});return}throw p}const pe=we-T,{error:ae}=await c.from("doses_semen").update({quantidade:pe}).eq("id",(ce==null?void 0:ce.id)||"");if(ae)throw ae;b({title:"Acasalamento adicionado",description:"Acasalamento adicionado com sucesso"}),await _e(u.id)}catch(X){const ie=X instanceof Error?X.message:"Erro desconhecido";throw!ie.includes("Valida√ß√£o")&&!ie.includes("Estoque")&&b({title:"Erro ao adicionar acasalamento",description:ie.includes("RLS")||ie.includes("policy")?"RLS est√° bloqueando escrita. Configure pol√≠ticas anon no Supabase.":ie,variant:"destructive"}),X}finally{h(!1)}};return g&&!u?e.jsx(va,{}):u&&o?e.jsx(Ba,{lote:u,acasalamentos:x,aspiracoesDisponiveis:I,dosesDisponiveis:A,dosesDisponiveisNoLote:C,doadoras:z,clientes:_,historicoDespachos:j,dataAspiracao:R,fazendaOrigemNome:a,fazendasDestinoNomes:n,submitting:U,onBack:()=>{i(!1),N(null)},onAddAcasalamento:H,onDespacharEmbrioes:E,onUpdateQuantidadeEmbrioes:(d,T)=>{f({...m,[d]:T})},editQuantidadeEmbrioes:m,onUpdateClivados:async(d,T)=>{re({...L,[d]:T});const $=parseInt(T)||null;await c.from("lote_fiv_acasalamentos").update({embrioes_clivados_d3:$}).eq("id",d)},editClivados:L}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(ga,{title:"Lotes FIV",description:"Gerenciar lotes de fecunda√ß√£o in vitro",actions:e.jsx(Ma,{pacotes:l,clientes:_,fazendas:B})}),e.jsx("div",{className:"rounded-xl border border-border bg-gradient-to-r from-card via-card to-muted/30 p-4 mb-4",children:e.jsxs("div",{className:"flex flex-wrap items-end gap-6",children:[e.jsxs("div",{className:"flex items-end gap-3",children:[e.jsx("div",{className:"w-1 h-6 rounded-full bg-primary/40 self-center"}),e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground self-center",children:[e.jsx(Ea,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:"Filtros"})]}),e.jsxs("div",{className:"flex-1 min-w-[220px] relative fazenda-busca-container",children:[e.jsx("label",{className:"text-[10px] font-medium text-muted-foreground mb-1 block uppercase tracking-wide",children:"Fazenda da Aspira√ß√£o"}),e.jsxs("div",{className:"relative",children:[e.jsx(qe,{id:"filtro-fazenda-aspira√ß√£o",placeholder:"Digite para buscar fazenda...",value:Y,onChange:d=>{te(d.target.value),O(!0),d.target.value||W("")},onFocus:()=>O(!0),className:"h-9"}),K&&e.jsx(xe,{variant:"ghost",size:"sm",className:"absolute right-1 top-1 h-7 w-7 p-0",onClick:()=>{W(""),te(""),O(!1)},children:e.jsx(na,{className:"h-4 w-4"})}),v&&S.length>0&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-card border border-border rounded-lg shadow-lg max-h-60 overflow-auto",children:S.map(d=>e.jsx("div",{className:"px-4 py-2 hover:bg-muted cursor-pointer text-sm",onClick:()=>{W(d.id),te(d.nome),O(!1)},children:d.nome},d.id))}),v&&Y&&S.length===0&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-card border border-border rounded-lg shadow-lg p-4 text-sm text-muted-foreground",children:"Nenhuma fazenda encontrada"})]})]})]}),e.jsx("div",{className:"h-10 w-px bg-border hidden lg:block"}),e.jsxs("div",{className:"flex items-end gap-3",children:[e.jsx("div",{className:"w-1 h-6 rounded-full bg-emerald-500/40 self-center"}),e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground self-center",children:[e.jsx(za,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:"Cultivo"})]}),e.jsxs("div",{className:"w-[180px]",children:[e.jsx("label",{className:"text-[10px] font-medium text-muted-foreground mb-1 block uppercase tracking-wide",children:"Dia do Cultivo"}),e.jsxs(Te,{value:ee||void 0,onValueChange:d=>de(d||""),children:[e.jsx($e,{id:"filtro-dia-cultivo",className:"h-9",children:e.jsx(ke,{placeholder:"Todos os dias"})}),e.jsx(Re,{children:[0,1,2,3,4,5,6,7,8].map(d=>e.jsxs(Ve,{value:d.toString(),children:["D",d," - ",Ge(d)]},d))})]})]})]}),e.jsx("div",{className:"h-10 w-px bg-border hidden lg:block"}),(K||ee)&&e.jsx("div",{className:"flex items-end ml-auto",children:e.jsxs(xe,{variant:"outline",onClick:D,className:"h-9",children:[e.jsx(na,{className:"w-4 h-4 mr-2"}),"Limpar Filtros"]})})]})}),e.jsxs(Oe,{children:[e.jsx(Me,{children:e.jsx(Be,{children:"Lista de Lotes FIV"})}),e.jsx(He,{children:s.length===0?e.jsx(ja,{title:J.length===0?"Nenhum lote cadastrado":"Nenhum lote encontrado",description:J.length===0?"Crie um novo lote para come√ßar.":"Ajuste os filtros para encontrar outros lotes."}):e.jsxs(Ye,{children:[e.jsx(Je,{children:e.jsxs(Fe,{children:[e.jsx(me,{children:"Aspira√ß√£o"}),e.jsx(me,{children:"Fazendas Destino"}),e.jsx(me,{children:"Dia do Cultivo"}),e.jsx(me,{children:"Acasalamentos"}),e.jsx(me,{className:"text-right",children:"A√ß√µes"})]})}),e.jsx(Xe,{children:s.map(d=>e.jsxs(Fe,{children:[e.jsxs(ue,{children:[d.pacote_data&&Ne(d.pacote_data)," - ",d.pacote_nome]}),e.jsx(ue,{children:e.jsx("div",{className:"flex flex-wrap gap-1",children:d.fazendas_destino_nomes&&d.fazendas_destino_nomes.length>0?d.fazendas_destino_nomes.map((T,$)=>e.jsx(Ue,{variant:"outline",className:"text-xs",children:T},$)):e.jsx("span",{className:"text-muted-foreground",children:"-"})})}),e.jsx(ue,{children:d.dia_atual!==void 0?e.jsx(Ue,{variant:"outline",className:`font-semibold ${Aa(d.dia_atual===0?-1:d.dia_atual>9?8:d.dia_atual-1)}`,children:(()=>{const T=d.dia_atual===0?-1:d.dia_atual>9?8:d.dia_atual-1;return T===-1?`D-1 - ${Ge(T)}`:`D${T} - ${Ge(T)}`})()}):e.jsx("span",{className:"text-muted-foreground",children:"-"})}),e.jsx(ue,{children:d.quantidade_acasalamentos??0}),e.jsx(ue,{className:"text-right",children:e.jsx(xe,{variant:"ghost",size:"sm",onClick:()=>P(`/lotes-fiv/${d.id}`),children:e.jsx(Fa,{className:"w-4 h-4"})})})]},d.id))})]})})]})]})}function Ha(t,P,b,U){return r.useMemo(()=>{let h=[...t];if(h=h.filter(m=>m.status==="FECHADO"||m.dia_atual!==void 0&&m.dia_atual>9?!1:m.dia_atual!==void 0&&m.dia_atual<=9),b&&(h=h.filter(m=>{const f=P.find(L=>L.id===m.pacote_aspiracao_id);return(f==null?void 0:f.fazenda_id)===b})),U!==""){const m=parseInt(U);h=h.filter(f=>f.dia_atual===void 0||f.dia_atual===null?!1:(f.dia_atual===0?-1:f.dia_atual-1)===m)}return h},[t,b,U,P])}function Ta(t,P){return r.useMemo(()=>t.filter(b=>b.nome.toLowerCase().includes(P.toLowerCase())),[t,P])}export{ms as default};
