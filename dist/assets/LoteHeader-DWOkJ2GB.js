import{r as A,s as j,j as e,h as Q,B}from"./index-TMaXuGT-.js";import{u as G}from"./use-toast-BfiUt0Jw.js";import{C as O,a as R,b as P,d as $}from"./card-DMaHdbj2.js";import{S as U,a as J,b as K,c as W,d as X}from"./select-mKWZhFeY.js";import{L as D}from"./label-CDZKlFri.js";import{T as Y,a as ee,b as Z,c as M,d as ae,e as I}from"./table-BcP2BpwR.js";import{E as te}from"./EmptyState-BdHwPhgd.js";import{I as H}from"./input-CS01soKQ.js";import{C as se}from"./circle-check-big-3OdUs8RJ.js";import{L as re}from"./lock-BkPpUXrw.js";function ue(r){const i=new Date(r);return Math.floor((new Date().getTime()-i.getTime())/(1e3*60*60*24))}function me(r){const i=new Date(r),t=new Date(i);return t.setDate(t.getDate()+275),t.toISOString().split("T")[0]}function ve(){return new Date().toISOString().split("T")[0]}function xe(r){return r.veterinario_responsavel.trim()!==""&&r.tecnico_responsavel.trim()!==""}function ge({statusReceptoraFiltro:r,tipoDiagnosticoFiltro:i}){const{toast:t}=G(),[c,n]=A.useState([]),[h,u]=A.useState(!1),l=A.useCallback(async()=>{try{u(!0);const{data:_,error:p}=await j.from("fazendas").select("*").order("nome",{ascending:!0});if(p)throw p;if(!_||_.length===0){n([]);return}const{data:m,error:o}=await j.from("vw_receptoras_fazenda_atual").select("receptora_id, fazenda_id_atual");if(o)throw o;const N=[...new Set((m||[]).map(s=>s.receptora_id).filter(Boolean))];if(N.length===0){n([]);return}const C=Array.isArray(r)?r:[r];let v=j.from("receptoras").select("id").in("id",N);C.length===1?v=v.eq("status_reprodutivo",C[0]):v=v.in("status_reprodutivo",C);const{data:x,error:T}=await v;if(T)throw T;const L=(x==null?void 0:x.map(s=>s.id))||[];if(L.length===0){n([]);return}const{data:S,error:q}=await j.from("transferencias_embrioes").select("receptora_id, data_te").in("receptora_id",L).eq("status_te","REALIZADA");if(q)throw q;const{data:w,error:z}=await j.from("diagnosticos_gestacao").select("receptora_id, data_te").in("receptora_id",L).eq("tipo_diagnostico",i);if(z)throw z;const b=new Map((m||[]).filter(s=>s.receptora_id&&s.fazenda_id_atual).map(s=>[s.receptora_id,s.fazenda_id_atual])),E=new Map,k=new Map;(S||[]).forEach(s=>{const f=b.get(s.receptora_id);if(!f)return;const g=`${f}|${s.data_te}`;k.set(g,f),E.has(g)||E.set(g,new Set),E.get(g).add(s.receptora_id)});const a=new Map;(w||[]).forEach(s=>{const f=b.get(s.receptora_id);if(!f)return;const g=`${f}|${s.data_te}`;a.has(g)||a.set(g,new Set),a.get(g).add(s.receptora_id)});const d=new Set;E.forEach((s,f)=>{var V;if((((V=a.get(f))==null?void 0:V.size)||0)<s.size){const F=k.get(f);F&&d.add(F)}});const y=_.filter(s=>d.has(s.id));n(y)}catch(_){t({title:"Erro ao carregar fazendas",description:_ instanceof Error?_.message:"Erro desconhecido",variant:"destructive"}),n([])}finally{u(!1)}},[r,i,t]);return{fazendas:c,loading:h,loadFazendas:l}}function je({statusReceptoraFiltro:r,tipoDiagnosticoFiltro:i,transformLote:t}){const{toast:c}=G(),[n,h]=A.useState([]),[u,l]=A.useState(!1),_=A.useCallback(async(p,m)=>{try{l(!0);const{data:o,error:N}=await j.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",p);if(N)throw N;const C=(o==null?void 0:o.map(a=>a.receptora_id))||[];if(C.length===0){h([]);return}const v=Array.isArray(r)?r:[r];let x=j.from("receptoras").select("id, status_reprodutivo").in("id",C);v.length===1?x=x.eq("status_reprodutivo",v[0]):x=x.in("status_reprodutivo",v);const{data:T}=await x,L=(T==null?void 0:T.map(a=>a.id))||[];if(L.length===0){h([]);return}const{data:S,error:q}=await j.from("transferencias_embrioes").select("id, receptora_id, data_te").in("receptora_id",L).eq("status_te","REALIZADA").order("data_te",{ascending:!1});if(q)throw q;const{data:w}=await j.from("diagnosticos_gestacao").select("receptora_id, data_te, veterinario_responsavel, tecnico_responsavel, data_diagnostico").in("receptora_id",L).eq("tipo_diagnostico",i).order("data_diagnostico",{ascending:!1}),z=new Map,b=new Map,E=new Map;S==null||S.forEach(a=>{const d=`${p}-${a.data_te}`;if(b.has(a.data_te)||b.set(a.data_te,new Set),b.get(a.data_te).add(a.receptora_id),!z.has(d)){const y=w==null?void 0:w.find(s=>s.data_te===a.data_te);y&&!E.has(a.data_te)&&E.set(a.data_te,y),z.set(d,{id:d,fazenda_id:p,fazenda_nome:m||"",data_te:a.data_te,quantidade_receptoras:0,status:"ABERTO"})}}),z.forEach(a=>{var s;const d=((s=b.get(a.data_te))==null?void 0:s.size)||0;a.quantidade_receptoras=d;const y=(w==null?void 0:w.filter(f=>f.data_te===a.data_te))||[];y.length>0&&y.length>=d&&(a.status="FECHADO")});const k=Array.from(z.values()).map(a=>{const d=E.get(a.data_te);return t(a,d?{veterinario_responsavel:d.veterinario_responsavel,tecnico_responsavel:d.tecnico_responsavel}:void 0)}).filter(a=>a.status==="ABERTO").sort((a,d)=>new Date(d.data_te).getTime()-new Date(a.data_te).getTime());h(k)}catch(o){c({title:"Erro ao carregar lotes",description:o instanceof Error?o.message:"Erro desconhecido",variant:"destructive"}),h([])}finally{l(!1)}},[r,i,t,c]);return{lotesTE:n,loading:u,loadLotesTE:_}}function we({fazendas:r,fazendaSelecionada:i,onFazendaChange:t}){return e.jsxs(O,{children:[e.jsx(R,{children:e.jsx(P,{children:"Selecionar Fazenda"})}),e.jsx($,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"fazenda",children:"Fazenda *"}),e.jsxs(U,{value:i,onValueChange:t,children:[e.jsx(J,{children:e.jsx(K,{placeholder:"Selecione a fazenda"})}),e.jsx(W,{children:r.map(c=>e.jsx(X,{value:c.id,children:c.nome},c.id))})]})]})})]})}function Ee({title:r,emptyTitle:i,emptyDescription:t,lotesTE:c,loteSelecionado:n,loading:h,veterinarioLabel:u,tecnicoLabel:l,getVeterinario:_,getTecnico:p,onSelectLote:m}){return e.jsxs(O,{children:[e.jsx(R,{children:e.jsx(P,{children:r})}),e.jsx($,{children:h?e.jsx(Q,{}):c.length===0?e.jsx(te,{title:i,description:t}):e.jsxs(Y,{children:[e.jsx(ee,{children:e.jsxs(Z,{children:[e.jsx(M,{children:"Data TE"}),e.jsx(M,{children:"Quantidade"}),e.jsx(M,{children:u}),e.jsx(M,{children:l}),e.jsx(M,{className:"text-right",children:"Ações"})]})}),e.jsx(ae,{children:c.map(o=>e.jsxs(Z,{className:(n==null?void 0:n.id)===o.id?"bg-blue-50":"",children:[e.jsx(I,{className:"font-medium",children:new Date(o.data_te).toLocaleDateString("pt-BR")}),e.jsxs(I,{children:[o.quantidade_receptoras," receptoras"]}),e.jsx(I,{children:_(o)||"-"}),e.jsx(I,{children:p(o)||"-"}),e.jsx(I,{className:"text-right",children:e.jsx(B,{size:"sm",onClick:()=>m(o),variant:(n==null?void 0:n.id)===o.id?"default":"outline",children:(n==null?void 0:n.id)===o.id?"Selecionado":"Selecionar"})})]},o.id))})]})})]})}function Le({title:r,loteSelecionado:i,loteFormData:t,onFormChange:c,onAbrirLote:n,onCancelar:h}){const u=t.veterinario_responsavel.trim()!==""&&t.tecnico_responsavel.trim()!=="";return e.jsxs(O,{children:[e.jsx(R,{children:e.jsx(P,{children:r})}),e.jsxs($,{className:"space-y-4",children:[e.jsxs("p",{className:"text-slate-600",children:["Lote de TE em ",new Date(i.data_te).toLocaleDateString("pt-BR")," - ",i.quantidade_receptoras," receptoras"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"veterinario",children:"Veterinário Responsável *"}),e.jsx(H,{id:"veterinario",value:t.veterinario_responsavel,onChange:l=>c({...t,veterinario_responsavel:l.target.value}),placeholder:"Nome do veterinário"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"tecnico",children:"Técnico Responsável *"}),e.jsx(H,{id:"tecnico",value:t.tecnico_responsavel,onChange:l=>c({...t,tecnico_responsavel:l.target.value}),placeholder:"Nome do técnico"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(B,{onClick:n,disabled:!u,children:[e.jsx(se,{className:"w-4 h-4 mr-2"}),"Abrir Lote"]}),e.jsx(B,{variant:"outline",onClick:h,children:"Cancelar"})]})]})]})}function ze({loteSelecionado:r,receptorasCount:i,loteFormData:t,onFormChange:c,veterinarioLabel:n,tecnicoLabel:h,onSalvarLote:u,submitting:l,canSave:_}){const p=r.status==="FECHADO";return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(P,{children:["Receptoras do Lote - ",i," ",i===1?"receptora":"receptoras",p&&e.jsx("span",{className:"ml-2 text-sm text-slate-500",children:"(Lote Fechado - Somente Leitura)"})]}),!p&&e.jsxs(B,{onClick:u,disabled:!_||l,children:[e.jsx(re,{className:"w-4 h-4 mr-2"}),l?"Salvando...":"Salvar Lote Completo"]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 pt-2 border-t",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(D,{htmlFor:"veterinario_lote",children:[n," *"]}),e.jsx(H,{id:"veterinario_lote",value:t.veterinario_responsavel,onChange:m=>c({...t,veterinario_responsavel:m.target.value}),placeholder:"Nome do veterinário",disabled:p})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(D,{htmlFor:"tecnico_lote",children:[h," *"]}),e.jsx(H,{id:"tecnico_lote",value:t.tecnico_responsavel,onChange:m=>c({...t,tecnico_responsavel:m.target.value}),placeholder:"Nome do técnico",disabled:p})]})]})]})}export{Le as A,we as F,Ee as L,je as a,ze as b,ue as c,me as d,ve as g,ge as u,xe as v};
