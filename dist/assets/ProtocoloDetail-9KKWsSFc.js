import{e as K,f as W,r as t,s as n,j as e,a as G,B as b,g as C}from"./index-DmNymSE5.js";import{C as z,a as A,b as D,d as y}from"./card-SrkIpKk5.js";import{T as E,a as I,b as u,c as p,d as T,e as l}from"./table-BEqiB4gi.js";import{D as Q,b as U,c as X,d as Y,e as ee}from"./dialog-j4QKUGZf.js";import"./alert-dialog-DGw4iz2S.js";import"./input-CUsCheD8.js";import"./label-u6KawL_e.js";import"./textarea-BuM8ilf-.js";import"./select-yD1hylSL.js";import"./tabs-DU1S-P5P.js";import{B}from"./badge-BB9l9AxT.js";import{P as se}from"./PageHeader-C6hPTib0.js";import{E as ae}from"./EmptyState-8CewmVht.js";import{u as te}from"./use-toast-8Wh80yTN.js";import{A as oe}from"./arrow-left-4eR3Pk6r.js";import{C as re}from"./circle-check-big-Dw4nsJgC.js";import"./index-BMCBZPUE.js";import"./index-C79PyqkA.js";import"./x-BKw_NAIH.js";import"./index-BoubMqWY.js";import"./index-BMurdLVa.js";import"./check-D6LfuFSM.js";import"./index-DntbqoHW.js";function Me(){const{id:x}=K(),v=W(),{toast:_}=te(),[F,w]=t.useState(!0),[ie,ce]=t.useState(!1),[c,q]=t.useState(null),[g,H]=t.useState(""),[d,R]=t.useState([]),[ne,P]=t.useState([]);t.useRef(!1);const[le,de]=t.useState(!1),[me,pe]=t.useState(!1),[V,S]=t.useState(!1),[xe,he]=t.useState({receptora_id:"",observacoes:""}),[ue,fe]=t.useState({identificacao:"",nome:"",observacoes:""});t.useEffect(()=>{x&&k()},[x]);const k=async()=>{try{w(!0);const{data:s,error:r}=await n.from("protocolos_sincronizacao").select("*").eq("id",x).single();if(r)throw r;q(s);const{data:m,error:i}=await n.from("fazendas").select("nome").eq("id",s.fazenda_id).single();if(i)throw i;H(m.nome),await O(),await L(s.fazenda_id)}catch(s){_({title:"Erro ao carregar dados",description:s instanceof Error?s.message:"Erro desconhecido",variant:"destructive"})}finally{w(!1)}},O=async()=>{try{const{data:s,error:r}=await n.from("protocolo_receptoras").select("*").eq("protocolo_id",x);if(r)throw r;if(!s||s.length===0){R([]);return}const m=s.map(a=>a.receptora_id),{data:i,error:f}=await n.from("receptoras").select("*").in("id",m);if(f)throw f;const j=new Map((i==null?void 0:i.map(a=>[a.id,a]))||[]),N=s.map(a=>{const h=j.get(a.receptora_id);return h?{...h,pr_id:a.id,pr_status:a.status,pr_motivo_inapta:a.motivo_inapta,pr_observacoes:a.observacoes}:null}).filter(a=>a!==null);R(N)}catch{}},L=async s=>{try{const{data:r,error:m}=await n.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",s);if(m)throw m;const i=(r==null?void 0:r.map(o=>o.receptora_id))||[];if(i.length===0){P([]);return}const{data:f,error:j}=await n.from("receptoras").select("id, identificacao, nome, status_reprodutivo").in("id",i).order("identificacao",{ascending:!0});if(j)throw j;const N=f||[],{data:a,error:h}=await n.from("protocolo_receptoras").select("receptora_id").eq("protocolo_id",x);if(h)throw h;const Z=(a==null?void 0:a.map(o=>o.receptora_id))||[],$=(N||[]).filter(o=>!Z.includes(o.id)).map(async o=>(o.status_reprodutivo||"VAZIA")==="VAZIA"?o:null),J=(await Promise.all($)).filter(o=>o!==null);P(J)}catch{}},M=()=>{S(!1),_({title:"1º passo concluído com sucesso",description:`${d.length} receptoras em sincronização`}),v("/protocolos")};return F?e.jsx(G,{}):c?e.jsxs("div",{className:"space-y-6",children:[e.jsx(se,{title:`Protocolo - ${g}`,description:"Protocolo finalizado",actions:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(b,{variant:"outline",size:"icon",onClick:()=>v("/protocolos"),children:e.jsx(oe,{className:"w-4 h-4"})}),!1]})}),e.jsxs(z,{children:[e.jsx(A,{children:e.jsx(D,{children:"Informações do Protocolo"})}),e.jsxs(y,{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Fazenda"}),e.jsx("p",{className:"text-base text-slate-900",children:g})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Data Início"}),e.jsx("p",{className:"text-base text-slate-900",children:C(c.data_inicio)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Responsável"}),e.jsx("p",{className:"text-base text-slate-900",children:c.responsavel_inicio})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Status"}),e.jsx("div",{className:"text-base text-slate-900",children:e.jsx(B,{variant:"secondary",children:"1º Passo Concluído"})})]})]})]}),e.jsxs(z,{children:[e.jsx(A,{children:e.jsxs(D,{children:["Receptoras do Protocolo (",d.length,")"]})}),e.jsx(y,{children:e.jsxs(E,{children:[e.jsx(I,{children:e.jsxs(u,{children:[e.jsx(p,{children:"Brinco"}),e.jsx(p,{children:"Nome"}),e.jsx(p,{children:"Status"}),e.jsx(p,{children:"Observações"})]})}),e.jsx(T,{children:d.length===0?e.jsx(u,{children:e.jsx(l,{colSpan:4,className:"text-center text-slate-500",children:"Nenhuma receptora adicionada ao protocolo"})}):d.map(s=>e.jsxs(u,{children:[e.jsx(l,{className:"font-medium",children:s.identificacao}),e.jsx(l,{children:s.nome||"-"}),e.jsx(l,{children:e.jsx(B,{variant:"secondary",children:s.pr_status==="INICIADA"?"Em Sincronização":s.pr_status})}),e.jsx(l,{className:"max-w-xs truncate",children:s.pr_observacoes||"-"})]},s.id))})]})})]}),e.jsx(Q,{open:V,onOpenChange:S,children:e.jsxs(U,{className:"max-w-2xl",children:[e.jsxs(X,{children:[e.jsxs(Y,{className:"flex items-center gap-2",children:[e.jsx(re,{className:"w-6 h-6 text-green-600"}),"Resumo do 1º Passo"]}),e.jsx(ee,{children:"1º passo concluído com sucesso"})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 p-4 bg-slate-50 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Fazenda"}),e.jsx("p",{className:"text-base text-slate-900",children:g})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Data do 1º Passo"}),e.jsx("p",{className:"text-base text-slate-900",children:c&&C(c.data_inicio)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Responsável"}),e.jsx("p",{className:"text-base text-slate-900",children:c==null?void 0:c.responsavel_inicio})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Total de Receptoras"}),e.jsx("p",{className:"text-base text-slate-900 font-bold",children:d.length})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-700 mb-2",children:"Receptoras em Sincronização:"}),e.jsx("div",{className:"max-h-60 overflow-y-auto border rounded-lg",children:e.jsxs(E,{children:[e.jsx(I,{children:e.jsxs(u,{children:[e.jsx(p,{children:"Brinco"}),e.jsx(p,{children:"Nome"})]})}),e.jsx(T,{children:d.map(s=>e.jsxs(u,{children:[e.jsx(l,{className:"font-medium",children:s.identificacao}),e.jsx(l,{children:s.nome||"-"})]},s.id))})]})})]}),e.jsx("div",{className:"p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("strong",{children:"Próximo passo:"}),' Acesse a aba "2º Passo (para confirmar)" na tela de Protocolos e clique em "INICIAR 2º PASSO" para revisar e confirmar as receptoras.']})}),e.jsx(b,{onClick:M,className:"w-full bg-green-600 hover:bg-green-700",children:"OK - Voltar para Protocolos"})]})]})})]}):e.jsx("div",{className:"space-y-6",children:e.jsx(ae,{title:"Protocolo não encontrado",description:"Volte para a lista e selecione outro protocolo.",action:e.jsx(b,{onClick:()=>v("/protocolos"),variant:"outline",children:"Voltar para Protocolos"})})})}export{Me as default};
