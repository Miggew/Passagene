import{r as T,s as j,j as e,g as Q,h as B}from"./index-CvlUDCD-.js";import{u as G,C as O,a as R,b as P,c as $}from"./use-toast-BhbfqK05.js";import{S as U,a as J,b as K,c as W,d as X}from"./select-CRV7QsOQ.js";import{L as I}from"./label-BIMTC7_j.js";import{T as Y,a as ee,b as Z,c as M,d as ae,e as D}from"./table-BAfLAU-a.js";import{E as re}from"./EmptyState-DFkj0E0i.js";import{I as H}from"./input-BiDTc9_9.js";import{C as se}from"./circle-check-big-C9vVKwgT.js";import{L as te}from"./lock-F3GwCU70.js";function fe(t){const i=new Date(t);return Math.floor((new Date().getTime()-i.getTime())/(1e3*60*60*24))}function ue(t){const i=new Date(t),s=new Date(i);return s.setDate(s.getDate()+275),s.toISOString().split("T")[0]}function me(){return new Date().toISOString().split("T")[0]}function ve(t){return t.veterinario_responsavel.trim()!==""&&t.tecnico_responsavel.trim()!==""}function ge({statusReceptoraFiltro:t,tipoDiagnosticoFiltro:i}){const{toast:s}=G(),[c,n]=T.useState([]),[m,p]=T.useState(!1),f=T.useCallback(async()=>{try{p(!0);const{data:h,error:u}=await j.from("fazendas").select("*").order("nome",{ascending:!0});if(u)throw u;if(!h||h.length===0){n([]);return}const{data:_,error:o}=await j.from("vw_receptoras_fazenda_atual").select("receptora_id, fazenda_id_atual");if(o)throw o;const A=[...new Set((_||[]).map(r=>r.receptora_id).filter(Boolean))];if(A.length===0){n([]);return}const C=Array.isArray(t)?t:[t];let v=j.from("receptoras").select("id").in("id",A);C.length===1?v=v.eq("status_reprodutivo",C[0]):v=v.in("status_reprodutivo",C);const{data:g,error:N}=await v;if(N)throw N;const L=(g==null?void 0:g.map(r=>r.id))||[];if(L.length===0){n([]);return}const{data:S,error:q}=await j.from("transferencias_embrioes").select("receptora_id, data_te").in("receptora_id",L).eq("status_te","REALIZADA");if(q)throw q;const{data:w,error:b}=await j.from("diagnosticos_gestacao").select("receptora_id, data_te").in("receptora_id",L).eq("tipo_diagnostico",i);if(b)throw b;const y=new Map((_||[]).filter(r=>r.receptora_id&&r.fazenda_id_atual).map(r=>[r.receptora_id,r.fazenda_id_atual])),E=new Map,k=new Map;(S||[]).forEach(r=>{const l=y.get(r.receptora_id);if(!l)return;const x=`${l}|${r.data_te}`;k.set(x,l),E.has(x)||E.set(x,new Set),E.get(x).add(r.receptora_id)});const a=new Map;(w||[]).forEach(r=>{const l=y.get(r.receptora_id);if(!l)return;const x=`${l}|${r.data_te}`;a.has(x)||a.set(x,new Set),a.get(x).add(r.receptora_id)});const d=new Set;E.forEach((r,l)=>{var V;if((((V=a.get(l))==null?void 0:V.size)||0)<r.size){const F=k.get(l);F&&d.add(F)}});const z=h.filter(r=>d.has(r.id));n(z)}catch(h){s({title:"Erro ao carregar fazendas",description:h instanceof Error?h.message:"Erro desconhecido",variant:"destructive"}),n([])}finally{p(!1)}},[t,i,s]);return{fazendas:c,loading:m,loadFazendas:f}}function xe({statusReceptoraFiltro:t,tipoDiagnosticoFiltro:i,fazendas:s,transformLote:c}){const{toast:n}=G(),[m,p]=T.useState([]),[f,h]=T.useState(!1),u=T.useCallback(async _=>{try{h(!0);const{data:o,error:A}=await j.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",_);if(A)throw A;const C=(o==null?void 0:o.map(a=>a.receptora_id))||[];if(C.length===0){p([]);return}const v=Array.isArray(t)?t:[t];let g=j.from("receptoras").select("id, status_reprodutivo").in("id",C);v.length===1?g=g.eq("status_reprodutivo",v[0]):g=g.in("status_reprodutivo",v);const{data:N}=await g,L=(N==null?void 0:N.map(a=>a.id))||[];if(L.length===0){p([]);return}const{data:S,error:q}=await j.from("transferencias_embrioes").select("id, receptora_id, data_te").in("receptora_id",L).eq("status_te","REALIZADA").order("data_te",{ascending:!1});if(q)throw q;const{data:w}=await j.from("diagnosticos_gestacao").select("receptora_id, data_te, veterinario_responsavel, tecnico_responsavel, data_diagnostico").in("receptora_id",L).eq("tipo_diagnostico",i).order("data_diagnostico",{ascending:!1}),b=new Map,y=new Map,E=new Map;S==null||S.forEach(a=>{var z;const d=`${_}-${a.data_te}`;if(y.has(a.data_te)||y.set(a.data_te,new Set),y.get(a.data_te).add(a.receptora_id),!b.has(d)){const r=w==null?void 0:w.find(l=>l.data_te===a.data_te);r&&!E.has(a.data_te)&&E.set(a.data_te,r),b.set(d,{id:d,fazenda_id:_,fazenda_nome:((z=s.find(l=>l.id===_))==null?void 0:z.nome)||"",data_te:a.data_te,quantidade_receptoras:0,status:"ABERTO"})}}),b.forEach(a=>{var r;const d=((r=y.get(a.data_te))==null?void 0:r.size)||0;a.quantidade_receptoras=d;const z=(w==null?void 0:w.filter(l=>l.data_te===a.data_te))||[];z.length>0&&z.length>=d&&(a.status="FECHADO")});const k=Array.from(b.values()).map(a=>{const d=E.get(a.data_te);return c(a,d?{veterinario_responsavel:d.veterinario_responsavel,tecnico_responsavel:d.tecnico_responsavel}:void 0)}).filter(a=>a.status==="ABERTO").sort((a,d)=>new Date(d.data_te).getTime()-new Date(a.data_te).getTime());p(k)}catch(o){n({title:"Erro ao carregar lotes",description:o instanceof Error?o.message:"Erro desconhecido",variant:"destructive"}),p([])}finally{h(!1)}},[t,i,s,c,n]);return{lotesTE:m,loading:f,loadLotesTE:u}}function je({fazendas:t,fazendaSelecionada:i,onFazendaChange:s}){return e.jsxs(O,{children:[e.jsx(R,{children:e.jsx(P,{children:"Selecionar Fazenda"})}),e.jsx($,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{htmlFor:"fazenda",children:"Fazenda *"}),e.jsxs(U,{value:i,onValueChange:s,children:[e.jsx(J,{children:e.jsx(K,{placeholder:"Selecione a fazenda"})}),e.jsx(W,{children:t.map(c=>e.jsx(X,{value:c.id,children:c.nome},c.id))})]})]})})]})}function we({title:t,emptyTitle:i,emptyDescription:s,lotesTE:c,loteSelecionado:n,loading:m,veterinarioLabel:p,tecnicoLabel:f,getVeterinario:h,getTecnico:u,onSelectLote:_}){return e.jsxs(O,{children:[e.jsx(R,{children:e.jsx(P,{children:t})}),e.jsx($,{children:m?e.jsx(Q,{}):c.length===0?e.jsx(re,{title:i,description:s}):e.jsxs(Y,{children:[e.jsx(ee,{children:e.jsxs(Z,{children:[e.jsx(M,{children:"Data TE"}),e.jsx(M,{children:"Quantidade"}),e.jsx(M,{children:p}),e.jsx(M,{children:f}),e.jsx(M,{className:"text-right",children:"Ações"})]})}),e.jsx(ae,{children:c.map(o=>e.jsxs(Z,{className:(n==null?void 0:n.id)===o.id?"bg-blue-50":"",children:[e.jsx(D,{className:"font-medium",children:new Date(o.data_te).toLocaleDateString("pt-BR")}),e.jsxs(D,{children:[o.quantidade_receptoras," receptoras"]}),e.jsx(D,{children:h(o)||"-"}),e.jsx(D,{children:u(o)||"-"}),e.jsx(D,{className:"text-right",children:e.jsx(B,{size:"sm",onClick:()=>_(o),variant:(n==null?void 0:n.id)===o.id?"default":"outline",children:(n==null?void 0:n.id)===o.id?"Selecionado":"Selecionar"})})]},o.id))})]})})]})}function Ee({title:t,loteSelecionado:i,loteFormData:s,onFormChange:c,onAbrirLote:n,onCancelar:m}){const p=s.veterinario_responsavel.trim()!==""&&s.tecnico_responsavel.trim()!=="";return e.jsxs(O,{children:[e.jsx(R,{children:e.jsx(P,{children:t})}),e.jsxs($,{className:"space-y-4",children:[e.jsxs("p",{className:"text-slate-600",children:["Lote de TE em ",new Date(i.data_te).toLocaleDateString("pt-BR")," - ",i.quantidade_receptoras," receptoras"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{htmlFor:"veterinario",children:"Veterinário Responsável *"}),e.jsx(H,{id:"veterinario",value:s.veterinario_responsavel,onChange:f=>c({...s,veterinario_responsavel:f.target.value}),placeholder:"Nome do veterinário"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{htmlFor:"tecnico",children:"Técnico Responsável *"}),e.jsx(H,{id:"tecnico",value:s.tecnico_responsavel,onChange:f=>c({...s,tecnico_responsavel:f.target.value}),placeholder:"Nome do técnico"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(B,{onClick:n,className:"bg-green-600 hover:bg-green-700",disabled:!p,children:[e.jsx(se,{className:"w-4 h-4 mr-2"}),"Abrir Lote"]}),e.jsx(B,{variant:"outline",onClick:m,children:"Cancelar"})]})]})]})}function Le({loteSelecionado:t,receptorasCount:i,loteFormData:s,onFormChange:c,veterinarioLabel:n,tecnicoLabel:m,onSalvarLote:p,submitting:f,canSave:h}){const u=t.status==="FECHADO";return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(P,{children:["Receptoras do Lote - ",i," ",i===1?"receptora":"receptoras",u&&e.jsx("span",{className:"ml-2 text-sm text-slate-500",children:"(Lote Fechado - Somente Leitura)"})]}),!u&&e.jsxs(B,{onClick:p,disabled:!h||f,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(te,{className:"w-4 h-4 mr-2"}),f?"Salvando...":"Salvar Lote Completo"]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 pt-2 border-t",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(I,{htmlFor:"veterinario_lote",children:[n," *"]}),e.jsx(H,{id:"veterinario_lote",value:s.veterinario_responsavel,onChange:_=>c({...s,veterinario_responsavel:_.target.value}),placeholder:"Nome do veterinário",disabled:u})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(I,{htmlFor:"tecnico_lote",children:[m," *"]}),e.jsx(H,{id:"tecnico_lote",value:s.tecnico_responsavel,onChange:_=>c({...s,tecnico_responsavel:_.target.value}),placeholder:"Nome do técnico",disabled:u})]})]})]})}export{Ee as A,je as F,we as L,xe as a,Le as b,fe as c,ue as d,me as g,ge as u,ve as v};
