import{r as s,s as d,j as e,h as ne,g as ra,a4 as ta}from"./index-CWtHucPz.js";import{u as Ye,C as oa,a as ia,b as sa,c as na}from"./use-toast-C_ednEV-.js";import{S as ke,a as Me,b as qe,c as Be,d as Ve}from"./select-BUr2m4f3.js";import{I as Ge}from"./input-bF23Jkur.js";import{L as ae}from"./label-CDN-yMr6.js";import{T as ca}from"./textarea-EUsZECCO.js";import{P as da}from"./PageHeader-DqMTzrbX.js";import{b as la}from"./dataEnrichment-C6Uyclml.js";import{v as pa}from"./receptoraStatus-DfJ2QNI_.js";import{D as _a,b as fa,c as ua,d as ma,e as ha,f as va}from"./dialog-DG0TUp-m.js";import{T as Qe,a as Ue,b as Te,c as Z,d as Je,e as $}from"./table-2v-HqcxP.js";import{f as Le}from"./dateUtils-eJ5e6apA.js";import{F as He}from"./file-text-D2kMcbSG.js";import{B as Ie}from"./badge-DewFfdNp.js";import{C as ga,Q as xa}from"./QualidadeSemaforo-CbjBn_HL.js";import{T as ba}from"./trash-2-xz0xDiTy.js";import{S as ea}from"./StatusBadge-B_pnPC6h.js";import{T as ja}from"./triangle-alert-Z4rSr_A9.js";import{S as Ea}from"./switch-CTwIGhep.js";import{D as Xe}from"./DatePickerBR-D4MNcuwK.js";import"./index-RvRMy3My.js";import"./index-H2w26JuE.js";import"./check-D_BDiPDp.js";import"./x-BtWTyRSy.js";import"./popover-hCBfJPXC.js";import"./statusLabels-IklKT8dE.js";import"./chevron-right-CY2M1G_-.js";const Na=!0;function wa({dataPasso2:a,incluirCioLivre:_,filtroClienteId:j,filtroRaca:z,formData:x}){const{toast:C}=Ye(),[c,S]=s.useState([]),[b,D]=s.useState([]),[p,E]=s.useState([]),[P,l]=s.useState([]),[v,M]=s.useState([]),[q,T]=s.useState([]),[Y,J]=s.useState(!0),[ce,be]=s.useState(!1),[A,Ne]=s.useState([]),[he,ve]=s.useState([]),[Q,we]=s.useState({}),[L,re]=s.useState({}),F=s.useCallback(async r=>{var g,f;if(!r.fazenda_id||!((((g=r.transferenciasIdsSessao)==null?void 0:g.length)||0)>0||(((f=r.transferenciasSessao)==null?void 0:f.length)||0)>0))return;let u=null;if(r.pacote_id){const h=r.pacote_id.substring(0,36);/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(h)&&(u=h)}const m={fazenda_id:r.fazenda_id,pacote_id:u,data_passo2:r.data_passo2||null,data_te:r.data_te||null,veterinario_responsavel:r.veterinario_responsavel||null,tecnico_responsavel:r.tecnico_responsavel||null,origem_embriao:r.origem_embriao||null,filtro_cliente_id:r.filtro_cliente_id||null,filtro_raca:r.filtro_raca||null,incluir_cio_livre:!!r.incluir_cio_livre,transferencias_ids:r.transferenciasIdsSessao||[],protocolo_receptora_ids:r.transferenciasSessao||[],status:"ABERTA",updated_at:new Date().toISOString()};await d.from("transferencias_sessoes").upsert(m,{onConflict:"fazenda_id,status"})},[]),I=s.useCallback(async r=>{r&&await d.from("transferencias_sessoes").update({status:"ENCERRADA",updated_at:new Date().toISOString()}).eq("fazenda_id",r).eq("status","ABERTA")},[]),ee=s.useCallback(r=>{const n=Array.isArray(r==null?void 0:r.transferencias_ids)?r.transferencias_ids:[],u=Array.isArray(r==null?void 0:r.protocolo_receptora_ids)?r.protocolo_receptora_ids:[],m=(r==null?void 0:r.origem_embriao)==="CONGELADO"?"CONGELADO":"PACOTE",g=(r==null?void 0:r.data_te)||new Date().toISOString().split("T")[0];return{transferenciasIds:n,protocoloReceptoraIds:u,filtros:{origem_embriao:m,filtro_cliente_id:(r==null?void 0:r.filtro_cliente_id)||"",filtro_raca:(r==null?void 0:r.filtro_raca)||"",data_passo2:(r==null?void 0:r.data_passo2)||new Date().toISOString().split("T")[0],incluir_cio_livre:!!(r!=null&&r.incluir_cio_livre)},camposPacote:{data_te:g,veterinario_responsavel:(r==null?void 0:r.veterinario_responsavel)||"",tecnico_responsavel:(r==null?void 0:r.tecnico_responsavel)||""},formData:{fazenda_id:(r==null?void 0:r.fazenda_id)||"",pacote_id:(r==null?void 0:r.pacote_id)||"",protocolo_id:(r==null?void 0:r.protocolo_id)||"",data_te:g,veterinario_responsavel:(r==null?void 0:r.veterinario_responsavel)||"",tecnico_responsavel:(r==null?void 0:r.tecnico_responsavel)||""}}},[]),de=s.useCallback(r=>{ve(r.transferenciasIds),Ne(r.protocoloReceptoraIds)},[]),le=s.useCallback(async()=>{try{const{data:r}=await d.from("transferencias_sessoes").select("*").eq("status","ABERTA").order("updated_at",{ascending:!1}).limit(1);if(r&&r.length>0){const n=r[0],u=Array.isArray(n==null?void 0:n.transferencias_ids)?n.transferencias_ids:[];let m=Array.isArray(n==null?void 0:n.protocolo_receptora_ids)?n.protocolo_receptora_ids:[];if(m.length===0&&u.length>0){const{data:h}=await d.from("transferencias_embrioes").select("protocolo_receptora_id").in("id",u);h&&(m=[...new Set(h.map(O=>O.protocolo_receptora_id).filter(O=>!!O))])}let g=!1;if(m.length>0){const{data:h}=await d.from("protocolo_receptoras").select("id, status").in("id",m);h&&(g=h.some(O=>O.status!=="UTILIZADA"))}if(!g)return await d.from("transferencias_sessoes").update({status:"ENCERRADA",updated_at:new Date().toISOString()}).eq("id",n.id),null;const f=ee(n);return de({transferenciasIds:f.transferenciasIds,protocoloReceptoraIds:f.protocoloReceptoraIds}),f}return null}catch{return null}},[ee,de]),fe=s.useCallback(async()=>{try{const{data:r,error:n}=await d.from("clientes").select("id, nome").order("nome",{ascending:!0});if(n)throw n;D(r||[])}catch{D([])}},[]),N=s.useCallback(async()=>{try{let r=d.from("protocolos_sincronizacao").select("id");a&&(r=r.eq("passo2_data",a));const{data:n,error:u}=await r;if(u)throw u;const m=[...new Set((n||[]).map(W=>W.id).filter(Boolean))];if(m.length===0){S([]),J(!1);return}const{data:g,error:f}=await d.from("v_protocolo_receptoras_status").select("receptora_id").eq("fase_ciclo","SINCRONIZADA").in("protocolo_id",m);if(f)throw f;const h=[...new Set((g||[]).map(W=>W.receptora_id).filter(Boolean))];if(h.length===0){S([]),J(!1);return}const{data:O,error:V}=await d.from("vw_receptoras_fazenda_atual").select("fazenda_id_atual").in("receptora_id",h);if(V)throw V;const ue=[...new Set((O||[]).map(W=>W.fazenda_id_atual).filter(Boolean))];if(ue.length===0){S([]),J(!1);return}const{data:pe,error:H}=await d.from("fazendas").select("id, nome").in("id",ue).order("nome",{ascending:!0});if(H)throw H;S(pe||[]),J(!1)}catch(r){C({title:"Erro ao carregar fazendas",description:r instanceof Error?r.message:"Erro desconhecido",variant:"destructive"}),J(!1)}},[a,C]),B=s.useCallback(async()=>{var r;try{const{error:n}=await d.rpc("descartar_embrioes_d9");n&&console.warn("RPC descartar_embrioes_d9 não disponível:",n.message);const[u,m]=await Promise.all([d.from("transferencias_embrioes").select("embriao_id"),d.from("embrioes").select("*").eq("status_atual","FRESCO").order("created_at",{ascending:!1})]),g=((r=u.data)==null?void 0:r.map(o=>o.embriao_id))||[];if(m.error)throw m.error;const f=[...m.data||[]].filter(o=>!g.includes(o.id)&&o.status_atual!=="TRANSFERIDO").sort((o,t)=>{const w=new Date(o.created_at||0).getTime();return new Date(t.created_at||0).getTime()-w});if(!f||f.length===0){E([]);return}const h=f.map(o=>o.id),O=[...new Set(f.filter(o=>o.lote_fiv_id).map(o=>o.lote_fiv_id))];let V=new Map,ue=new Map,pe=new Map,H=new Map;const[W,Ae,Oe]=await Promise.all([h.length>0?d.from("v_embrioes_disponiveis_te").select("embriao_id, d7_pronto, d8_limite").in("embriao_id",h):Promise.resolve({data:null,error:null}),d.from("fazendas").select("id, nome"),O.length>0?d.from("lotes_fiv").select("id, pacote_aspiracao_id").in("id",O):Promise.resolve({data:null,error:null})]),ge=new Map((W.data||[]).map(o=>[o.embriao_id,{d7_pronto:o.d7_pronto,d8_limite:o.d8_limite}]));Ae.data&&(H=new Map(Ae.data.map(o=>[o.id,o.nome])));const je=Oe.data;if(je&&je.length>0){je.forEach(t=>{t.pacote_aspiracao_id&&ue.set(t.id,t.pacote_aspiracao_id)});const o=[...new Set(je.map(t=>t.pacote_aspiracao_id).filter(Boolean))];if(o.length>0){const[t,w]=await Promise.all([d.from("pacotes_aspiracao").select("*").in("id",o),d.from("pacotes_aspiracao_fazendas_destino").select("pacote_aspiracao_id, fazenda_destino_id").in("pacote_aspiracao_id",o)]),R=w.data;R&&R.forEach(y=>{const ie=pe.get(y.pacote_aspiracao_id)||[];ie.includes(y.fazenda_destino_id)||ie.push(y.fazenda_destino_id),pe.set(y.pacote_aspiracao_id,ie)});const X=t.data;X&&X.forEach(y=>{if(y.fazenda_destino_id){const ie=pe.get(y.id)||[];ie.includes(y.fazenda_destino_id)||ie.push(y.fazenda_destino_id),pe.set(y.id,ie)}V.set(y.id,{id:y.id,data_aspiracao:y.data_aspiracao,fazenda_nome:H.get(y.fazenda_id),quantidade_doadoras:0,horario_inicio:y.horario_inicio,veterinario_responsavel:y.veterinario_responsavel,total_oocitos:y.total_oocitos})})}}const De=f.map(o=>o.lote_fiv_acasalamento_id).filter(o=>!!o);let me=new Map,Re=new Map;if(De.length>0){const{data:o}=await d.from("lote_fiv_acasalamentos").select("id, aspiracao_doadora_id, dose_semen_id").in("id",De);if(o){me=new Map(o.map(k=>[k.id,k]));const t=[...new Set(o.map(k=>k.aspiracao_doadora_id).filter(Boolean))],w=[...new Set(o.map(k=>k.dose_semen_id).filter(Boolean))],[R,X]=await Promise.all([t.length>0?d.from("aspiracoes_doadoras").select("id, doadora_id").in("id",t):Promise.resolve({data:null}),w.length>0?d.from("doses_semen").select("id, touro_id, touro:touros(id, nome, registro, raca)").in("id",w):Promise.resolve({data:null})]),y=R.data,ie=X.data;if(ie&&(Re=new Map(ie.map(k=>{const se=k.touro,xe=Array.isArray(se)?se[0]:se;return[k.id,(xe==null?void 0:xe.nome)||"Touro desconhecido"]})),o.forEach(k=>{if(k.dose_semen_id){const se=Re.get(k.dose_semen_id);if(se){const xe=me.get(k.id);me.set(k.id,{...xe,touro_nome:se})}}})),y){const k=[...new Set(y.map(se=>se.doadora_id))];if(k.length>0){const{data:se}=await d.from("doadoras").select("id, registro").in("id",k);if(se){const xe=new Map(se.map(te=>[te.id,te.registro])),Fe=new Map(y.map(te=>[te.id,te.doadora_id]));o.forEach(te=>{if(te.aspiracao_doadora_id){const Ke=Fe.get(te.aspiracao_doadora_id);if(Ke){const We=xe.get(Ke);if(We){const aa=me.get(te.id);me.set(te.id,{...aa,doadora_registro:We})}}}})}}}}}const Ee=new Map;f.forEach(o=>{var y,ie;if(!o.lote_fiv_id||!o.created_at)return;const t=o.created_at.split("T")[0],w=`${o.lote_fiv_id}-${t}`;let R=Ee.get(w);if(!R){const k=ue.get(o.lote_fiv_id),se=k?V.get(k):void 0,xe=k?pe.get(k)||[]:[],Fe=xe.map(te=>H.get(te)).filter(te=>!!te);R={id:w,lote_fiv_id:o.lote_fiv_id,data_despacho:t,fazendas_destino_ids:xe,fazendas_destino_nomes:Fe,pacote_info:se||{id:k||"",data_aspiracao:t,quantidade_doadoras:0},embrioes:[],total:0,frescos:0,congelados:0},Ee.set(w,R)}const X=me.get(o.lote_fiv_acasalamento_id||"");R.embrioes.push({...o,doadora_registro:X==null?void 0:X.doadora_registro,touro_nome:X==null?void 0:X.touro_nome,d7_pronto:(y=ge.get(o.id))==null?void 0:y.d7_pronto,d8_limite:(ie=ge.get(o.id))==null?void 0:ie.d8_limite}),R.total++,o.status_atual==="FRESCO"&&R.frescos++,o.status_atual==="CONGELADO"&&R.congelados++});const ze=[...new Set(Array.from(Ee.values()).map(o=>o.lote_fiv_id))],{data:Se}=await d.from("lotes_fiv").select("id, disponivel_para_transferencia").in("id",ze),Pe=new Map((Se==null?void 0:Se.map(o=>[o.id,o.disponivel_para_transferencia===!0]))||[]),G=Array.from(Ee.values()).map(o=>{const t=o.embrioes.filter(w=>!w.classificacao||w.classificacao.trim()==="").length;return{pacote:o,semClassificacao:t,total:o.total,disponivel:Pe.get(o.lote_fiv_id)}}).filter(o=>o.disponivel!==!1&&o.total>0&&o.semClassificacao===0).map(o=>o.pacote).sort((o,t)=>t.data_despacho.localeCompare(o.data_despacho));E(G)}catch(n){C({title:"Erro ao carregar pacotes de embriões",description:n instanceof Error?n.message:"Erro desconhecido",variant:"destructive"}),E([])}},[C]),U=s.useCallback(async()=>{var n;const r=z.trim().toLowerCase();if(!j&&!r){M([]);return}try{be(!0);let u=d.from("embrioes").select("*").eq("status_atual","CONGELADO").not("cliente_id","is",null);j&&(u=u.eq("cliente_id",j));const[m,g]=await Promise.all([d.from("transferencias_embrioes").select("embriao_id"),u.order("created_at",{ascending:!1})]);if(m.error)throw m.error;if(g.error)throw g.error;const f=((n=m.data)==null?void 0:n.map(O=>O.embriao_id))||[],h=(g.data||[]).filter(O=>!f.includes(O.id)&&O.status_atual!=="TRANSFERIDO");if(h.length===0){M([]);return}M(h)}catch(u){C({title:"Erro ao carregar embriões congelados",description:u instanceof Error?u.message:"Erro desconhecido",variant:"destructive"}),M([])}finally{be(!1)}},[j,z,C]),K=s.useCallback(async r=>{try{const{data:n,error:u}=await d.from("receptoras_cio_livre").select("receptora_id, data_cio").eq("status","DISPONIVEL").eq("fazenda_id",r);if(u&&u.code!=="PGRST205")throw u;const m=(n||[]).map(V=>V.receptora_id).filter(V=>!!V);if(m.length===0)return{receptoras:[],receptorasDisponiveis:0};const{data:g,error:f}=await d.from("receptoras").select("id, identificacao, status_reprodutivo").in("id",m);if(f)throw f;const h=new Map((n||[]).map(V=>[V.receptora_id,V.data_cio])),O=(g||[]).map(V=>({receptora_id:V.id,brinco:V.identificacao||"N/A",identificacao:V.identificacao||"",protocolo_id:void 0,protocolo_receptora_id:void 0,data_te_prevista:void 0,data_limite_te:void 0,quantidade_embrioes:0,ciclando_classificacao:void 0,qualidade_semaforo:void 0,origem:"CIO_LIVRE",data_cio:h.get(V.id),status_reprodutivo:V.status_reprodutivo}));return{receptoras:O,receptorasDisponiveis:O.length}}catch(n){return C({title:"Erro ao carregar receptoras",description:n instanceof Error?n.message:"Erro desconhecido",variant:"destructive"}),{receptoras:[],receptorasDisponiveis:0}}},[C]),oe=s.useCallback(async(r,n)=>{const u=(n==null?void 0:n.contagem)??Q,m=(n==null?void 0:n.info)??L;try{let g=d.from("protocolos_sincronizacao").select("id");a&&(g=g.eq("passo2_data",a));const{data:f,error:h}=await g;if(h)throw h;const O=[...new Set((f||[]).map(t=>t.id).filter(Boolean))];if(O.length===0)return T([]),{receptorasDisponiveis:0};const{data:V,error:ue}=await d.from("v_protocolo_receptoras_status").select("receptora_id, brinco, data_te_prevista, data_limite_te, protocolo_id").eq("fase_ciclo","SINCRONIZADA").in("protocolo_id",O);if(ue&&ue.code!=="PGRST205")throw ue;const pe=V||[],H=[...new Set(pe.map(t=>t.receptora_id).filter(Boolean))];if(H.length===0)return T([]),{receptorasDisponiveis:0};const{data:W,error:Ae}=await d.from("vw_receptoras_fazenda_atual").select("receptora_id").in("receptora_id",H).eq("fazenda_id_atual",r);if(Ae)throw Ae;const Oe=new Set((W||[]).map(t=>t.receptora_id).filter(Boolean)),ge=pe.filter(t=>Oe.has(t.receptora_id)),je=[...new Set(ge.map(t=>t.receptora_id).filter(Boolean))];if(je.length===0)return T([]),{receptorasDisponiveis:0};const{data:De,error:me}=await d.from("receptoras").select("id, identificacao, status_reprodutivo").in("id",je);if(me)throw me;const Re=new Map((De||[]).map(t=>[t.id,t])),Ee=[...new Set(ge.map(t=>t.protocolo_id).filter(Boolean))];let ze=[];if(Ee.length>0){const{data:t,error:w}=await d.from("protocolo_receptoras").select("id, receptora_id, protocolo_id, status, ciclando_classificacao, qualidade_semaforo").in("protocolo_id",Ee).neq("status","INAPTA").neq("status","UTILIZADA");if(w&&w.code!=="PGRST205")throw w;ze=t||[]}const Se=new Map(ze.map(t=>[t.receptora_id,t]));let i=ge.map(t=>{const w=Re.get(t.receptora_id),R=Se.get(t.receptora_id),X=u[t.receptora_id]||0;return{receptora_id:t.receptora_id,brinco:t.brinco||(w==null?void 0:w.identificacao)||"N/A",identificacao:(w==null?void 0:w.identificacao)||"",protocolo_id:(R==null?void 0:R.protocolo_id)||t.protocolo_id,protocolo_receptora_id:(R==null?void 0:R.id)||"",data_te_prevista:t.data_te_prevista,data_limite_te:t.data_limite_te,quantidade_embrioes:X,ciclando_classificacao:(R==null?void 0:R.ciclando_classificacao)??null,qualidade_semaforo:(R==null?void 0:R.qualidade_semaforo)??null,origem:"PROTOCOLO",status_reprodutivo:w==null?void 0:w.status_reprodutivo}}).filter(t=>t.status_reprodutivo==="SINCRONIZADA"||u[t.receptora_id]>0);if(_){const{receptoras:t}=await K(r);i=[...i,...t]}const G=Object.values(m).filter(t=>(u[t.receptora_id]||0)>=1),o=new Set(i.map(t=>t.receptora_id));return G.forEach(t=>{o.has(t.receptora_id)||i.push({...t,quantidade_embrioes:u[t.receptora_id]||0})}),i=i.map(t=>({...t,quantidade_embrioes:u[t.receptora_id]||0})),T(i),{receptorasDisponiveis:i.length}}catch(g){return C({title:"Erro ao carregar receptoras",description:g instanceof Error?g.message:"Erro desconhecido",variant:"destructive"}),T([]),{receptorasDisponiveis:0}}},[a,_,Q,L,K,C]),Ce=s.useCallback(async(r,n)=>{await oe(r,n)},[oe]);return s.useEffect(()=>{if(x.fazenda_id){const r=p.filter(n=>n.fazendas_destino_ids.includes(x.fazenda_id));l(r)}else l([])},[x.fazenda_id,p]),s.useEffect(()=>{(async()=>{if(he.length===0){we({}),re({});return}const{data:n,error:u}=await d.from("transferencias_embrioes").select("id, receptora_id, protocolo_receptora_id, receptoras(id, identificacao, status_reprodutivo)").in("id",he);if(u)return;const m={},g={};(n||[]).forEach(f=>{if(!f.receptora_id)return;m[f.receptora_id]=(m[f.receptora_id]||0)+1;const h=Array.isArray(f.receptoras)?f.receptoras[0]:f.receptoras;g[f.receptora_id]={receptora_id:f.receptora_id,brinco:(h==null?void 0:h.identificacao)||"N/A",identificacao:(h==null?void 0:h.identificacao)||"",protocolo_id:void 0,protocolo_receptora_id:f.protocolo_receptora_id||"",quantidade_embrioes:m[f.receptora_id],origem:f.protocolo_receptora_id?"PROTOCOLO":"CIO_LIVRE",status_reprodutivo:(h==null?void 0:h.status_reprodutivo)||"SERVIDA"}}),we(m),re(g)})()},[he]),{fazendas:c,clientes:b,pacotes:p,pacotesFiltrados:P,embrioesCongelados:v,receptoras:q,setReceptoras:T,loading:Y,loadingCongelados:ce,transferenciasSessao:A,setTransferenciasSessao:Ne,transferenciasIdsSessao:he,setTransferenciasIdsSessao:ve,contagemSessaoPorReceptora:Q,setContagemSessaoPorReceptora:we,receptorasSessaoInfo:L,setReceptorasSessaoInfo:re,loadFazendas:N,loadPacotes:B,loadClientes:fe,loadEmbrioesCongelados:U,carregarReceptorasDaFazenda:oe,recarregarReceptoras:Ce,salvarSessaoNoBanco:F,encerrarSessaoNoBanco:I,restaurarSessaoEmAndamento:le}}const _e={origemEmbriao:"PACOTE",filtroClienteId:"",filtroRaca:"",dataPasso2:"",incluirCioLivre:!1,embrioesPage:1},ye={showRelatorioDialog:!1,relatorioData:[],isVisualizacaoApenas:!1};function Ca(){const[a,_]=s.useState(_e.origemEmbriao),[j,z]=s.useState(_e.filtroClienteId),[x,C]=s.useState(_e.filtroRaca),[c,S]=s.useState(_e.dataPasso2),[b,D]=s.useState(_e.incluirCioLivre),[p,E]=s.useState(_e.embrioesPage),[P,l]=s.useState(ye.showRelatorioDialog),[v,M]=s.useState(ye.relatorioData),[q,T]=s.useState(ye.isVisualizacaoApenas),Y=s.useCallback(()=>{_(_e.origemEmbriao),z(_e.filtroClienteId),C(_e.filtroRaca),S(_e.dataPasso2),D(_e.incluirCioLivre),E(_e.embrioesPage)},[]),J=s.useCallback(()=>{l(ye.showRelatorioDialog),M(ye.relatorioData),T(ye.isVisualizacaoApenas)},[]),ce=s.useCallback(()=>{Y(),J()},[Y,J]),be=s.useCallback(Q=>{M(Q),T(!0),l(!0)},[]),A=s.useCallback(Q=>{M(Q),T(!1),l(!0)},[]),Ne=s.useCallback(()=>{l(!1),T(!1)},[]),he=s.useCallback(Q=>{_(Q.origem_embriao==="CONGELADO"?"CONGELADO":"PACOTE"),z(Q.filtro_cliente_id||""),C(Q.filtro_raca||""),S(Q.data_passo2||new Date().toISOString().split("T")[0]),D(!!Q.incluir_cio_livre),Q.embrioes_page&&E(Q.embrioes_page)},[]),ve=s.useCallback(()=>({origemEmbriao:a,filtroClienteId:j,filtroRaca:x,dataPasso2:c,incluirCioLivre:b,embrioesPage:p}),[a,j,x,c,b,p]);return{origemEmbriao:a,setOrigemEmbriao:_,filtroClienteId:j,setFiltroClienteId:z,filtroRaca:x,setFiltroRaca:C,dataPasso2:c,setDataPasso2:S,incluirCioLivre:b,setIncluirCioLivre:D,embrioesPage:p,setEmbrioesPage:E,showRelatorioDialog:P,setShowRelatorioDialog:l,relatorioData:v,setRelatorioData:M,isVisualizacaoApenas:q,setIsVisualizacaoApenas:T,resetFilters:Y,resetRelatorio:J,resetAll:ce,abrirRelatorioVisualizacao:be,abrirRelatorioEncerramento:A,fecharRelatorio:Ne,aplicarFiltrosSessao:he,getFiltersState:ve}}function Aa({formData:a,setFormData:_,origemEmbriao:j,receptoras:z,contagemSessaoPorReceptora:x,setContagemSessaoPorReceptora:C,receptorasSessaoInfo:c,setReceptorasSessaoInfo:S,transferenciasSessao:b,setTransferenciasSessao:D,transferenciasIdsSessao:p,setTransferenciasIdsSessao:E,numerosFixosMap:P,setSubmitting:l,setRelatorioData:v,setShowRelatorioDialog:M,setIsVisualizacaoApenas:q,resetFiltros:T,loadPacotes:Y,loadEmbrioesCongelados:J,recarregarReceptoras:ce,encerrarSessaoNoBanco:be}){const{toast:A}=Ye(),Ne=s.useCallback(async()=>{if(!a.receptora_id){A({title:"Nenhuma receptora selecionada",description:"Selecione uma receptora para descartar.",variant:"destructive"});return}const L=z.find(I=>I.receptora_id===a.receptora_id),re=(L==null?void 0:L.brinco)||a.receptora_id,F=(L==null?void 0:L.origem)||"PROTOCOLO";try{if(l(!0),F==="CIO_LIVRE"){const{error:I}=await d.from("receptoras_cio_livre").update({status:"DESCARTADA"}).eq("receptora_id",a.receptora_id).eq("status","DISPONIVEL");if(I)throw I}else if(a.protocolo_receptora_id){const{error:I}=await d.from("protocolo_receptoras").update({status:"INAPTA",motivo_inapta:"Descartada no menu de TE - não recebeu embrião"}).eq("id",a.protocolo_receptora_id);if(I)throw I}a.receptora_id&&await d.from("receptoras").update({status_reprodutivo:"VAZIA"}).eq("id",a.receptora_id),A({title:"Receptora descartada",description:F==="CIO_LIVRE"?`${re} foi descartada e saiu da lista de cio livre.`:`${re} foi descartada e não receberá embrião neste protocolo.`}),_(I=>({...I,receptora_id:"",protocolo_receptora_id:""})),a.fazenda_id&&await ce(a.fazenda_id)}catch(I){A({title:"Erro ao descartar receptora",description:I instanceof Error?I.message:"Erro desconhecido",variant:"destructive"})}finally{l(!1)}},[a,z,_,l,ce,A]),he=s.useCallback(async L=>{var de,le,fe,N;L.preventDefault();const re=j==="PACOTE";if(!a.embriao_id){A({title:"Embrião não selecionado",description:"Por favor, selecione um embrião para realizar a transferência.",variant:"destructive"});return}if(!a.fazenda_id||!a.receptora_id||!a.data_te||re&&!a.pacote_id){A({title:"Erro de validação",description:"Todos os campos obrigatórios devem ser preenchidos",variant:"destructive"});return}const F=z.find(B=>B.receptora_id===a.receptora_id);if(!F){A({title:"Receptora não disponível",description:"A receptora selecionada não está disponível para transferência.",variant:"destructive"});return}const I=x[a.receptora_id]||0,ee=I===1;if(I>=2){A({title:"Limite atingido",description:"Esta receptora já recebeu o máximo de 2 embriões permitidos.",variant:"destructive"});return}if(a.receptora_id&&!ee){const B=F.status_reprodutivo||"VAZIA",U=F.origem==="CIO_LIVRE"?"SINCRONIZADA":B,K=pa(U,"REALIZAR_TE");if(!K.valido){A({title:"Erro de validação",description:K.mensagem||"A receptora não pode receber embrião no estado atual",variant:"destructive"});return}}if(!a.veterinario_responsavel||a.veterinario_responsavel.trim()===""){A({title:"Erro de validação",description:"Veterinário responsável é obrigatório. Por favor, informe o nome do veterinário.",variant:"destructive"});return}try{l(!0);const B={embriao_id:a.embriao_id,receptora_id:a.receptora_id,protocolo_receptora_id:a.protocolo_receptora_id||null,data_te:a.data_te,tipo_te:j==="CONGELADO"?"CONGELADO":"FRESCO",veterinario_responsavel:a.veterinario_responsavel.trim(),tecnico_responsavel:((de=a.tecnico_responsavel)==null?void 0:de.trim())||null,status_te:"REALIZADA",observacoes:((le=a.observacoes)==null?void 0:le.trim())||null},{data:U,error:K}=await d.from("transferencias_embrioes").insert([B]).select("id");if(K){if(K.code==="23505"&&((fe=K.message)!=null&&fe.includes("unq_embriao_te_realizada"))){j==="CONGELADO"?J():Y();return}throw K}U&&((N=U[0])!=null&&N.id)&&E(r=>[...r,U[0].id]),await d.from("embrioes").update({status_atual:"TRANSFERIDO"}).eq("id",a.embriao_id),a.protocolo_receptora_id&&D(r=>r.includes(a.protocolo_receptora_id)?r:[...r,a.protocolo_receptora_id]);const oe={...x};oe[a.receptora_id]=(oe[a.receptora_id]||0)+1,C(oe);const Ce={...c};Ce[a.receptora_id]={...F,quantidade_embrioes:oe[a.receptora_id]},S(Ce),A({title:"Transferência registrada",description:`Embrião transferido para ${F.brinco} com sucesso.`}),_(r=>({...r,embriao_id:"",receptora_id:"",protocolo_receptora_id:"",observacoes:""})),j==="CONGELADO"?J():Y(),a.fazenda_id&&await ce(a.fazenda_id,{contagem:oe,info:Ce})}catch(B){A({title:"Erro ao registrar transferência",description:B instanceof Error?B.message:"Erro desconhecido",variant:"destructive"})}finally{l(!1)}},[a,j,z,x,c,_,l,E,D,C,S,Y,J,ce,A]),ve=s.useCallback(async(L=!1)=>{if(!(p.length>0)){L||A({title:"Nenhuma transferência na sessão",description:"Não há transferências para gerar relatório.",variant:"destructive"});return}try{const{data:F,error:I}=await d.from("transferencias_embrioes").select(`
          *,
          embrioes (id, identificacao, classificacao, status_atual, lote_fiv_id, lote_fiv_acasalamento_id),
          receptoras (id, identificacao, nome)
        `).in("id",p).eq("status_te","REALIZADA").order("created_at",{ascending:!0});if(I)throw I;if(!F||F.length===0){A({title:"Erro ao gerar relatório",description:"Não foi possível encontrar as transferências da sessão.",variant:"destructive"});return}const ee=F.map(N=>{var B;return(B=N.embrioes)==null?void 0:B.lote_fiv_acasalamento_id}).filter(N=>!!N),{doadorasMap:de,tourosMap:le}=await la(ee),fe=F.map(N=>{var r,n,u,m,g;const B=(r=N.embrioes)==null?void 0:r.lote_fiv_acasalamento_id,U=B&&de.get(B)||"N/A",K=B&&le.get(B)||"N/A";return{numero_embriao:((n=N.embrioes)==null?void 0:n.identificacao)||(P&&P.get(N.embriao_id||"")?String(P.get(N.embriao_id||"")):null)||(N.embriao_id?N.embriao_id.substring(0,8):"N/A"),doadora:U,touro:K,classificacao:((u=N.embrioes)==null?void 0:u.classificacao)||"N/A",receptora_brinco:((m=N.receptoras)==null?void 0:m.identificacao)||"N/A",receptora_nome:((g=N.receptoras)==null?void 0:g.nome)||"N/A",data_te:N.data_te,veterinario:N.veterinario_responsavel||"N/A",tecnico:N.tecnico_responsavel||"N/A",observacoes:N.observacoes||""}});v(fe),M(!0)}catch(F){A({title:"Erro ao gerar relatório",description:F instanceof Error?F.message:"Erro desconhecido",variant:"destructive"}),q(!1)}},[p,P,v,M,q,A]),Q=s.useCallback(async()=>{if(p.length===0){A({title:"Nenhuma transferência na sessão",description:"Não há transferências para visualizar.",variant:"destructive"});return}q(!0),await ve(!0)},[p,q,ve,A]),we=s.useCallback(async()=>{if(p.length===0){A({title:"Nenhuma transferência na sessão",description:"Não há transferências para encerrar nesta sessão.",variant:"destructive"});return}try{l(!0);let L=[...b];if(L.length===0){const{data:le,error:fe}=await d.from("transferencias_embrioes").select("protocolo_receptora_id").in("id",p);if(fe)throw fe;L=[...new Set((le||[]).map(N=>N.protocolo_receptora_id).filter(N=>!!N))]}const{data:re,error:F}=await d.from("transferencias_embrioes").select("receptora_id").in("id",p).eq("status_te","REALIZADA");if(F)throw F;const I=[...new Set((re||[]).map(le=>le.receptora_id).filter(Boolean))];if(I.length===0)throw new Error("Nenhuma receptora encontrada para encerrar a sessão.");const{error:ee}=await d.rpc("encerrar_sessao_te",{p_receptora_ids:I,p_protocolo_receptora_ids:L});if(ee)throw(ee==null?void 0:ee.code)==="PGRST202"?new Error("Função encerrar_sessao_te não encontrada no banco. Aplique o SQL em docs/db/003_encerrar_sessao_te.sql e tente novamente."):ee;await be(a.fazenda_id),A({title:"Sessão encerrada",description:`${p.length} transferência(s) finalizada(s) com sucesso.`});const de=a.fazenda_id;_({fazenda_id:"",pacote_id:"",protocolo_id:"",embriao_id:"",receptora_id:"",protocolo_receptora_id:"",data_te:new Date().toISOString().split("T")[0],veterinario_responsavel:"",tecnico_responsavel:"",observacoes:""}),D([]),E([]),C({}),S({}),T(),await Y(),de&&await ce(de)}catch(L){A({title:"Erro ao encerrar sessão",description:L instanceof Error?L.message:"Erro desconhecido",variant:"destructive"})}finally{l(!1)}},[a,b,p,_,l,D,E,C,S,T,Y,ce,be,A]);return{handleDescartarReceptora:Ne,handleSubmit:he,visualizarRelatorioSessao:Q,gerarRelatorioSessao:ve,handleEncerrarSessao:we}}function Ra({open:a,onOpenChange:_,relatorioData:j,fazendaNome:z,dataTe:x,veterinarioResponsavel:C,tecnicoResponsavel:c,isVisualizacaoApenas:S,submitting:b,onFechar:D,onConfirmarEncerrar:p}){return e.jsx(_a,{open:a,onOpenChange:_,children:e.jsxs(fa,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(ua,{children:[e.jsxs(ma,{className:"flex items-center gap-2",children:[e.jsx(He,{className:"w-5 h-5"}),"Relatório da Sessão de Transferência de Embriões"]}),e.jsxs(ha,{children:["Fazenda: ",z||"N/A"," | Data da TE: ",x?Le(x):"N/A"," | Total: ",j.length," transferência(s)"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Veterinário Responsável:"})," ",C||"N/A"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Técnico Responsável:"})," ",c||"N/A"]})]}),e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsxs(Qe,{children:[e.jsx(Ue,{children:e.jsxs(Te,{children:[e.jsx(Z,{className:"text-center",children:"Código"}),e.jsx(Z,{children:"Doadora"}),e.jsx(Z,{children:"Touro"}),e.jsx(Z,{children:"Classificação"}),e.jsx(Z,{children:"Receptora (Brinco)"}),e.jsx(Z,{children:"Receptora (Nome)"}),e.jsx(Z,{children:"Data TE"}),e.jsx(Z,{children:"Observações"})]})}),e.jsx(Je,{children:j.map((E,P)=>e.jsxs(Te,{children:[e.jsx($,{className:"text-center font-semibold",children:E.numero_embriao}),e.jsx($,{children:E.doadora}),e.jsx($,{children:E.touro}),e.jsx($,{children:E.classificacao}),e.jsx($,{className:"font-semibold",children:E.receptora_brinco}),e.jsx($,{children:E.receptora_nome}),e.jsx($,{children:E.data_te?Le(E.data_te):"N/A"}),e.jsx($,{className:"text-sm text-slate-600",children:E.observacoes||"-"})]},P))})]})})]}),e.jsxs(va,{children:[e.jsx(ne,{type:"button",variant:"outline",onClick:D,children:"Fechar"}),!S&&e.jsx(ne,{type:"button",onClick:async()=>{D(),await p()},className:"bg-blue-600 hover:bg-blue-700",disabled:b,children:b?"Encerrando...":"Confirmar e Encerrar Sessão"})]})]})})}function Sa({receptoras:a,selectedReceptoraId:_,contagemSessaoPorReceptora:j,submitting:z,onSelectReceptora:x,onDescartarReceptora:C}){return e.jsxs("div",{className:"space-y-2",children:[e.jsx(ae,{children:"6. Selecionar Receptora *"}),e.jsx("div",{className:"border rounded-lg p-4 max-h-60 overflow-y-auto",children:a.length===0?e.jsx("p",{className:"text-sm text-slate-500",children:"Nenhuma receptora sincronizada encontrada para esta fazenda."}):e.jsx("div",{className:"space-y-2",children:a.map(c=>{const S=j[c.receptora_id]||0,b=S<2,D=_===c.receptora_id;return e.jsxs("div",{className:`flex items-center justify-between p-2 rounded cursor-pointer ${D?"bg-green-100 border-green-500 border":b?"hover:bg-slate-50":"opacity-50 cursor-not-allowed"}`,onClick:()=>{b&&x(c.receptora_id,c.protocolo_receptora_id||"")},children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"receptora",checked:D,onChange:()=>{},disabled:!b,className:"w-4 h-4"}),e.jsx("span",{className:"font-medium",children:c.brinco}),c.origem==="CIO_LIVRE"&&e.jsx(Ie,{variant:"outline",className:"text-xs bg-purple-50 text-purple-700",children:"CIO LIVRE"}),c.ciclando_classificacao&&e.jsx(ga,{classificacao:c.ciclando_classificacao}),c.qualidade_semaforo&&e.jsx(xa,{qualidade:c.qualidade_semaforo})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[S>0&&e.jsxs(Ie,{variant:"secondary",children:[S,"/2 embriões"]}),D&&e.jsx(ne,{type:"button",variant:"ghost",size:"sm",onClick:p=>{p.stopPropagation(),C()},className:"text-red-600 hover:text-red-700 hover:bg-red-50",disabled:z,children:e.jsx(ba,{className:"w-4 h-4"})})]})]},c.receptora_id)})})})]})}const Ze=20;function Da({pacote:a,embrioes:_,numerosFixosMap:j,selectedEmbriaoId:z,embrioesPage:x,hasD8Limite:C,onSelectEmbriao:c,onPageChange:S}){const b=[..._].sort((l,v)=>{const M=l.identificacao||"",q=v.identificacao||"";if(M&&q)return M.localeCompare(q);if(M&&!q)return-1;if(!M&&q)return 1;const T=j.get(l.id)||9999,Y=j.get(v.id)||9999;return T-Y}),D=Math.max(1,Math.ceil(b.length/Ze)),p=Math.min(x,D),E=(p-1)*Ze,P=b.slice(E,E+Ze);return e.jsxs("div",{className:"space-y-4",children:[e.jsx(ae,{children:"7. Selecionar Embrião do Pacote *"}),e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"font-semibold text-slate-900",children:"Pacote selecionado"}),e.jsxs("p",{className:"text-sm text-slate-600",children:["Data Despacho: ",Le(a.data_despacho)," | Total: ",a.total," embrião(ões)"]}),C&&e.jsxs("div",{className:"mt-2 flex items-center gap-2 text-sm text-amber-700",children:[e.jsx(ja,{className:"w-4 h-4"}),"Embriões em D8: transferir ou congelar hoje. No D9 serão descartados automaticamente."]})]}),e.jsxs("div",{className:"max-h-96 overflow-y-auto",children:[e.jsxs(Qe,{children:[e.jsx(Ue,{children:e.jsxs(Te,{children:[e.jsx(Z,{className:"w-12"}),e.jsx(Z,{className:"text-center w-28",children:"Código"}),e.jsx(Z,{children:"Doadora"}),e.jsx(Z,{children:"Touro"}),e.jsx(Z,{children:"Classificação"}),e.jsx(Z,{children:"Status"}),e.jsx(Z,{children:"Dia"})]})}),e.jsx(Je,{children:P.map(l=>{const v=j.get(l.id)||0;return e.jsxs(Te,{className:z===l.id?"bg-green-50":"cursor-pointer hover:bg-slate-50",onClick:()=>c(l.id),children:[e.jsx($,{children:e.jsx("input",{type:"radio",name:"embriao",value:l.id,checked:z===l.id,onChange:()=>c(l.id),className:"w-4 h-4"})}),e.jsx($,{className:"text-center font-medium font-mono text-xs",children:l.identificacao||`#${v}`}),e.jsx($,{children:l.doadora_registro||"-"}),e.jsx($,{children:l.touro_nome||"-"}),e.jsx($,{children:l.classificacao?e.jsx(Ie,{variant:"outline",children:l.classificacao}):e.jsx("span",{className:"text-slate-400",children:"-"})}),e.jsx($,{children:e.jsx(ea,{status:l.status_atual})}),e.jsx($,{children:l.d8_limite?e.jsx(Ie,{variant:"destructive",children:"D8"}):l.d7_pronto?e.jsx(Ie,{variant:"outline",className:"bg-emerald-50 text-emerald-700 border-emerald-200",children:"D7"}):e.jsx("span",{className:"text-slate-400",children:"-"})})]},l.id)})})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-between text-sm text-slate-600",children:[e.jsxs("div",{children:[_.length," embrião(ões) disponíveis"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ne,{type:"button",variant:"outline",size:"sm",onClick:()=>S(Math.max(1,x-1)),disabled:x===1,children:"Anterior"}),e.jsxs("span",{children:["Página ",p," de ",D]}),e.jsx(ne,{type:"button",variant:"outline",size:"sm",onClick:()=>S(Math.min(D,x+1)),disabled:x>=D,children:"Próxima"})]})]})]})]})]})}const $e=20;function za({embrioes:a,selectedEmbriaoId:_,embrioesPage:j,loadingCongelados:z,filtroClienteId:x,filtroRaca:C,onSelectEmbriao:c,onPageChange:S}){const b=x||C.trim(),D=[...a].sort((v,M)=>{const q=v.created_at?new Date(v.created_at).getTime():0;return(M.created_at?new Date(M.created_at).getTime():0)-q}),p=Math.max(1,Math.ceil(D.length/$e)),E=Math.min(j,p),P=(E-1)*$e,l=D.slice(P,P+$e);return e.jsxs("div",{className:"space-y-4",children:[e.jsx(ae,{children:"7. Selecionar Embrião Congelado *"}),e.jsxs("div",{className:"border rounded-lg p-4",children:[!b&&e.jsx("div",{className:"text-sm text-slate-500",children:"Selecione um cliente ou informe a raça para listar embriões congelados."}),z&&e.jsx("div",{className:"text-sm text-slate-500",children:"Carregando embriões congelados..."}),!z&&a.length===0&&b&&e.jsx("div",{className:"text-sm text-slate-500",children:"Nenhum embrião congelado encontrado para os filtros aplicados."}),!z&&a.length>0&&e.jsxs("div",{className:"max-h-96 overflow-y-auto",children:[e.jsxs(Qe,{children:[e.jsx(Ue,{children:e.jsxs(Te,{children:[e.jsx(Z,{className:"w-12"}),e.jsx(Z,{children:"Código"}),e.jsx(Z,{children:"Doadora"}),e.jsx(Z,{children:"Touro"}),e.jsx(Z,{children:"Classificação"}),e.jsx(Z,{children:"Status"})]})}),e.jsx(Je,{children:l.map(v=>e.jsxs(Te,{className:_===v.id?"bg-green-50":"cursor-pointer hover:bg-slate-50",onClick:()=>c(v.id),children:[e.jsx($,{children:e.jsx("input",{type:"radio",name:"embriao",value:v.id,checked:_===v.id,onChange:()=>c(v.id),className:"w-4 h-4"})}),e.jsx($,{className:"font-mono text-xs",children:v.identificacao||v.id.substring(0,8)}),e.jsx($,{children:v.doadora_registro||"-"}),e.jsx($,{children:v.touro_nome||"-"}),e.jsx($,{children:v.classificacao?e.jsx(Ie,{variant:"outline",children:v.classificacao}):e.jsx("span",{className:"text-slate-400",children:"-"})}),e.jsx($,{children:e.jsx(ea,{status:v.status_atual})})]},v.id))})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-between text-sm text-slate-600",children:[e.jsxs("div",{children:[a.length," embrião(ões) disponíveis"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ne,{type:"button",variant:"outline",size:"sm",onClick:()=>S(Math.max(1,j-1)),disabled:j===1,children:"Anterior"}),e.jsxs("span",{children:["Página ",E," de ",p]}),e.jsx(ne,{type:"button",variant:"outline",size:"sm",onClick:()=>S(Math.min(p,j+1)),disabled:j>=p,children:"Próxima"})]})]})]})]})]})}const ya=20;function ir(){var Pe;const[a,_]=s.useState({fazenda_id:"",pacote_id:"",protocolo_id:"",receptora_id:"",protocolo_receptora_id:"",embriao_id:"",data_te:new Date().toISOString().split("T")[0],veterinario_responsavel:"",tecnico_responsavel:"",observacoes:""}),[j,z]=s.useState({data_te:"",veterinario_responsavel:"",tecnico_responsavel:""}),[x,C]=s.useState(!1),{origemEmbriao:c,setOrigemEmbriao:S,filtroClienteId:b,setFiltroClienteId:D,filtroRaca:p,setFiltroRaca:E,dataPasso2:P,setDataPasso2:l,incluirCioLivre:v,setIncluirCioLivre:M,embrioesPage:q,setEmbrioesPage:T,showRelatorioDialog:Y,setShowRelatorioDialog:J,relatorioData:ce,setRelatorioData:be,isVisualizacaoApenas:A,setIsVisualizacaoApenas:Ne,resetAll:he,aplicarFiltrosSessao:ve,fecharRelatorio:Q}=Ca(),{fazendas:we,clientes:L,pacotes:re,pacotesFiltrados:F,embrioesCongelados:I,receptoras:ee,setReceptoras:de,loading:le,loadingCongelados:fe,transferenciasSessao:N,setTransferenciasSessao:B,transferenciasIdsSessao:U,setTransferenciasIdsSessao:K,contagemSessaoPorReceptora:oe,setContagemSessaoPorReceptora:Ce,receptorasSessaoInfo:r,setReceptorasSessaoInfo:n,loadFazendas:u,loadPacotes:m,loadClientes:g,loadEmbrioesCongelados:f,carregarReceptorasDaFazenda:h,recarregarReceptoras:O,salvarSessaoNoBanco:V,encerrarSessaoNoBanco:ue,restaurarSessaoEmAndamento:pe}=wa({dataPasso2:P,incluirCioLivre:v,filtroClienteId:b,filtroRaca:p,formData:a}),H=re.find(i=>i.id===a.pacote_id),W=s.useMemo(()=>(H==null?void 0:H.embrioes.filter(i=>i.status_atual==="FRESCO"))||[],[H]),Ae=W.some(i=>i.d8_limite),Oe=s.useRef(0),ge=s.useMemo(()=>{if(!a.pacote_id||!H)return new Map;const i=[...W].sort((o,t)=>{const w=o.doadora_registro||"",R=t.doadora_registro||"";if(w!==R)return w.localeCompare(R);const X=o.created_at?new Date(o.created_at).getTime():0,y=t.created_at?new Date(t.created_at).getTime():0;return X!==y?X-y:(o.id||"").localeCompare(t.id||"")}),G=new Map;return i.forEach((o,t)=>{G.set(o.id,t+1)}),G},[a.pacote_id,H,W]),{handleDescartarReceptora:je,handleSubmit:De,visualizarRelatorioSessao:me,handleEncerrarSessao:Re}=Aa({formData:a,setFormData:_,origemEmbriao:c,receptoras:ee,contagemSessaoPorReceptora:oe,setContagemSessaoPorReceptora:Ce,receptorasSessaoInfo:r,setReceptorasSessaoInfo:n,transferenciasSessao:N,setTransferenciasSessao:B,transferenciasIdsSessao:U,setTransferenciasIdsSessao:K,numerosFixosMap:ge,setSubmitting:C,setRelatorioData:be,setShowRelatorioDialog:J,setIsVisualizacaoApenas:Ne,resetFiltros:he,loadPacotes:m,loadEmbrioesCongelados:f,recarregarReceptoras:O,encerrarSessaoNoBanco:ue}),Ee=()=>{const i={fazenda_id:a.fazenda_id,pacote_id:a.pacote_id,data_passo2:P,data_te:a.data_te,veterinario_responsavel:a.veterinario_responsavel,tecnico_responsavel:a.tecnico_responsavel,origem_embriao:c,filtro_cliente_id:b,filtro_raca:p,incluir_cio_livre:v,transferenciasSessao:N,transferenciasIdsSessao:U,embrioes_page:q};V(i)},ze=async i=>{if(!i){_({...a,fazenda_id:"",pacote_id:"",protocolo_id:"",embriao_id:"",receptora_id:"",protocolo_receptora_id:""}),z({data_te:"",veterinario_responsavel:"",tecnico_responsavel:""}),B([]),K([]),de([]);return}B([]),K([]),z({data_te:"",veterinario_responsavel:"",tecnico_responsavel:""}),await h(i),_({...a,fazenda_id:i,pacote_id:"",protocolo_id:"",embriao_id:"",receptora_id:"",protocolo_receptora_id:""})},Se=i=>{var o;const G=re.find(t=>t.id===i);(o=G==null?void 0:G.pacote_info)!=null&&o.veterinario_responsavel&&!a.veterinario_responsavel?(_(t=>({...t,pacote_id:i,veterinario_responsavel:G.pacote_info.veterinario_responsavel||""})),z(t=>({...t,veterinario_responsavel:G.pacote_info.veterinario_responsavel||""}))):_(t=>({...t,pacote_id:i}))};return s.useEffect(()=>{(async()=>{await Promise.all([u(),m(),g()]);const G=await pe();G&&(ve(G.filtros),z(G.camposPacote),_(o=>({...o,...G.formData,embriao_id:"",receptora_id:"",protocolo_receptora_id:"",observacoes:""})))})()},[]),s.useEffect(()=>{(a.fazenda_id||a.pacote_id||U.length>0)&&Ee()},[a.fazenda_id,a.pacote_id,a.protocolo_id,a.data_te,a.veterinario_responsavel,a.tecnico_responsavel,c,b,p,P,v,N.length,U.length,q]),s.useEffect(()=>{u()},[P]),s.useEffect(()=>{a.fazenda_id&&h(a.fazenda_id)},[a.fazenda_id,P,v]),s.useEffect(()=>{c==="CONGELADO"&&(b||p.trim())&&f()},[c,b,p]),s.useEffect(()=>{T(1)},[a.pacote_id]),s.useEffect(()=>{c==="CONGELADO"&&(T(1),_(i=>({...i,embriao_id:""})))},[c,b,p]),s.useEffect(()=>{!a.pacote_id||!H||(Oe.current+=1)},[a.pacote_id,H,ge]),s.useEffect(()=>{const i=Math.max(1,Math.ceil(W.length/ya));q>i&&T(i)},[W.length,q]),le?e.jsx(ra,{}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(da,{title:"Transferência de Embriões (TE)",description:"Destinar embriões para receptoras sincronizadas"}),e.jsxs(oa,{children:[e.jsx(ia,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(sa,{className:"flex items-center gap-2",children:[e.jsx(ta,{className:"w-5 h-5"}),"Nova Transferência"]}),a.fazenda_id&&U.length>0&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(ne,{type:"button",onClick:me,className:"bg-slate-600 hover:bg-slate-700",disabled:x,variant:"default",title:"Visualizar relatório da sessão atual sem encerrar",children:[e.jsx(He,{className:"w-4 h-4 mr-2"}),"Visualizar Relatório (",U.length," transferência",U.length>1?"s":"",")"]}),e.jsxs(ne,{type:"button",onClick:Re,className:"bg-blue-600 hover:bg-blue-700",disabled:x,variant:"default",children:[e.jsx(He,{className:"w-4 h-4 mr-2"}),x?"Gerando...":`Encerrar Sessão (${U.length} transferência${U.length>1?"s":""})`]})]})]})}),e.jsx(na,{children:e.jsxs("form",{onSubmit:De,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4 border-b pb-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ae,{htmlFor:"fazenda_id",children:"1. Fazenda onde estão as receptoras *"}),e.jsxs(ke,{value:a.fazenda_id,onValueChange:ze,children:[e.jsx(Me,{children:e.jsx(qe,{placeholder:"Selecione a fazenda"})}),e.jsx(Be,{children:we.map(i=>e.jsx(Ve,{value:i.id,children:i.nome},i.id))})]})]}),a.fazenda_id&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(ae,{htmlFor:"data_passo2",children:"2. Data do 2º Passo (opcional)"}),e.jsx(Xe,{id:"data_passo2",value:P,onChange:i=>l(i||"")}),P&&e.jsx("div",{className:"flex justify-end",children:e.jsx(ne,{type:"button",variant:"ghost",size:"sm",onClick:()=>l(""),children:"Limpar data"})})]}),a.fazenda_id&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ea,{id:"incluir-cio-livre",checked:v,onCheckedChange:M}),e.jsx(ae,{htmlFor:"incluir-cio-livre",className:"cursor-pointer text-sm",children:"Incluir receptoras de CIO livre"})]}),a.fazenda_id&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(ae,{children:"3. Origem do Embrião *"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx(ne,{type:"button",variant:c==="PACOTE"?"default":"outline",onClick:()=>S("PACOTE"),className:c==="PACOTE"?"bg-green-600 hover:bg-green-700":"",children:"Pacote (Frescos)"}),e.jsx(ne,{type:"button",variant:c==="CONGELADO"?"default":"outline",onClick:()=>S("CONGELADO"),className:c==="CONGELADO"?"bg-blue-600 hover:bg-blue-700":"",children:"Congelados"})]})]}),a.fazenda_id&&c==="PACOTE"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(ae,{htmlFor:"pacote_id",children:"4. Pacote de Embriões *"}),e.jsxs(ke,{value:a.pacote_id,onValueChange:Se,children:[e.jsx(Me,{children:e.jsx(qe,{placeholder:"Selecione o pacote"})}),e.jsx(Be,{children:F.map(i=>{var G;return e.jsxs(Ve,{value:i.id,children:[((G=i.pacote_info)==null?void 0:G.fazenda_nome)||"N/A"," - ",Le(i.data_despacho)," (",i.frescos," frescos)"]},i.id)})})]})]}),a.fazenda_id&&c==="CONGELADO"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx(ae,{children:"4. Filtros para Embriões Congelados"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ae,{htmlFor:"filtro_cliente",children:"Cliente"}),e.jsxs(ke,{value:b,onValueChange:D,children:[e.jsx(Me,{children:e.jsx(qe,{placeholder:"Selecione o cliente"})}),e.jsx(Be,{children:L.map(i=>e.jsx(Ve,{value:i.id,children:i.nome},i.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ae,{htmlFor:"filtro_raca",children:"Raça"}),e.jsx(Ge,{id:"filtro_raca",value:p,onChange:i=>E(i.target.value),placeholder:"Digite a raça"})]})]})]}),(a.pacote_id||c==="CONGELADO")&&a.fazenda_id&&e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ae,{htmlFor:"data_te",children:"5. Data da TE *"}),e.jsx(Xe,{id:"data_te",value:a.data_te,onChange:i=>_({...a,data_te:i||""})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ae,{htmlFor:"veterinario_responsavel",children:"Veterinário Responsável *"}),e.jsx(Ge,{id:"veterinario_responsavel",value:a.veterinario_responsavel,onChange:i=>_({...a,veterinario_responsavel:i.target.value}),placeholder:"Nome do veterinário"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ae,{htmlFor:"tecnico_responsavel",children:"Técnico Responsável"}),e.jsx(Ge,{id:"tecnico_responsavel",value:a.tecnico_responsavel,onChange:i=>_({...a,tecnico_responsavel:i.target.value}),placeholder:"Nome do técnico"})]})]}),(a.pacote_id||c==="CONGELADO"&&(b||p.trim()))&&a.fazenda_id&&e.jsx(Sa,{receptoras:ee,selectedReceptoraId:a.receptora_id,contagemSessaoPorReceptora:oe,submitting:x,onSelectReceptora:(i,G)=>{_({...a,receptora_id:i,protocolo_receptora_id:G})},onDescartarReceptora:je}),a.pacote_id&&H&&e.jsx(Da,{pacote:H,embrioes:W,numerosFixosMap:ge,selectedEmbriaoId:a.embriao_id,embrioesPage:q,hasD8Limite:Ae,onSelectEmbriao:i=>_({...a,embriao_id:i}),onPageChange:T}),c==="CONGELADO"&&e.jsx(za,{embrioes:I,selectedEmbriaoId:a.embriao_id,embrioesPage:q,loadingCongelados:fe,filtroClienteId:b,filtroRaca:p,onSelectEmbriao:i=>_({...a,embriao_id:i}),onPageChange:T}),a.embriao_id&&a.receptora_id&&e.jsx("div",{className:"space-y-4 border-t pt-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(ae,{htmlFor:"observacoes",children:"Observações"}),e.jsx(ca,{id:"observacoes",value:a.observacoes,onChange:i=>_({...a,observacoes:i.target.value}),placeholder:"Observações sobre a transferência",rows:3})]})})]}),a.embriao_id&&a.receptora_id&&e.jsx("div",{className:"flex justify-end",children:e.jsx(ne,{type:"submit",className:"bg-green-600 hover:bg-green-700",disabled:x,children:x?"Registrando...":"Registrar Transferência"})})]})})]}),e.jsx(Ra,{open:Y,onOpenChange:J,relatorioData:ce,fazendaNome:((Pe=we.find(i=>i.id===a.fazenda_id))==null?void 0:Pe.nome)||"N/A",dataTe:a.data_te,veterinarioResponsavel:a.veterinario_responsavel,tecnicoResponsavel:a.tecnico_responsavel,isVisualizacaoApenas:A,submitting:x,onFechar:Q,onConfirmarEncerrar:Re})]})}export{ir as default};
