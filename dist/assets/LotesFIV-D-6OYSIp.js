import{r,s as c,y as ke,n as za,z as Fa,f as Ca,j as e,B as ue,g as Le,C as Ra,E as ga,F as Va,U as Na,a as qa,e as Ua}from"./index-DmNymSE5.js";import{C as Ze,a as Xe,b as Ge,d as Ye}from"./card-SrkIpKk5.js";import{T as ia,a as ra,b as Oe,c as I,d as na,e as O}from"./table-BEqiB4gi.js";import{S as da,a as ca,b as la,c as ma,d as pa,C as Qa,e as Za}from"./select-yD1hylSL.js";import{I as Je}from"./input-CUsCheD8.js";import{L as je}from"./label-u6KawL_e.js";import{B as Te}from"./badge-BB9l9AxT.js";import{P as Xa}from"./PageHeader-C6hPTib0.js";import{E as Ma}from"./EmptyState-8CewmVht.js";import{u as xa}from"./use-toast-8Wh80yTN.js";import{h as oa}from"./error-handler-CVxXqVfW.js";import{T as Ga,a as Ya,b as La,c as Ia}from"./tabs-DU1S-P5P.js";import{D as wa,a as Ja,b as Da,c as Sa,d as Ea,e as ya}from"./dialog-j4QKUGZf.js";import{T as Pa}from"./textarea-BuM8ilf-.js";import{P as $a}from"./plus-BZvL1qCK.js";import{A as Ka}from"./arrow-left-4eR3Pk6r.js";import{F as Wa}from"./file-text-ZSN0C1g0.js";import{P as Aa}from"./package-Be7lPzXE.js";import{D as Oa}from"./DatePickerBR-DL95UOFW.js";import{X as ka}from"./x-BKw_NAIH.js";import{S as es}from"./search-52vUzEUy.js";import{E as as}from"./eye-VBUrU1-Z.js";import"./index-BoubMqWY.js";import"./index-C79PyqkA.js";import"./index-BMCBZPUE.js";import"./index-BMurdLVa.js";import"./check-D6LfuFSM.js";import"./index-DntbqoHW.js";import"./popover-BabFSUJ1.js";import"./calendar-u0e6cTgk.js";function ba(a){return{[-1]:"Aspira√ß√£o",0:"Fecunda√ß√£o",1:"Zigoto",2:"Clivagem",3:"Clivagem Avan√ßada",4:"Compacta√ß√£o",5:"M√≥rula / Blastocisto Inicial",6:"Blastocisto",7:"Blastocisto Expandido",8:"Resgate / Sa√≠da Tardia"}[a]||`Dia ${a}`}function ss(a){return a===-1?"bg-blue-100 text-blue-800 border-blue-300":a===0?"bg-green-100 text-green-800 border-green-300":a>=1&&a<=3?"bg-yellow-100 text-yellow-800 border-yellow-300":a>=4&&a<=5||a===6?"bg-orange-100 text-orange-800 border-orange-300":a===7?"bg-purple-100 text-purple-800 border-purple-300":a===8?"bg-red-100 text-red-800 border-red-300":"bg-slate-100 text-slate-800 border-slate-300"}const Ha="lotes_fiv_filtros";function ts(){try{const a=localStorage.getItem(Ha);return a?JSON.parse(a):{}}catch{return{}}}function os(a){try{localStorage.setItem(Ha,JSON.stringify(a))}catch{}}const Ta=8;function is(a){return a===0?-1:a>9?8:a-1}function Ba({lotes:a,pacotesParaFiltro:$,fazendasAspiracaoUnicas:o,lotesHistoricos:R}){const[d]=r.useState(()=>ts()),[D,se]=r.useState(d.filtroFazendaAspiracao??""),[H,_e]=r.useState(d.filtroFazendaAspiracaoBusca??""),[u,W]=r.useState(d.filtroDiaCultivo??""),[g,ie]=r.useState(!1),[re,T]=r.useState(d.filtroHistoricoDataInicio??""),[ne,V]=r.useState(d.filtroHistoricoDataFim??""),[de,ce]=r.useState(d.filtroHistoricoFazenda??""),[ge,xe]=r.useState(d.filtroHistoricoFazendaBusca??""),[le,X]=r.useState(!1),[f,v]=r.useState(d.abaAtiva??"ativos"),[N,L]=r.useState(d.historicoPage??1);r.useEffect(()=>{os({abaAtiva:f,filtroFazendaAspiracao:D,filtroFazendaAspiracaoBusca:H,filtroDiaCultivo:u,filtroHistoricoDataInicio:re,filtroHistoricoDataFim:ne,filtroHistoricoFazenda:de,filtroHistoricoFazendaBusca:ge,historicoPage:N})},[f,D,H,u,re,ne,de,ge,N]),r.useEffect(()=>{L(1)},[re,ne,de]),r.useEffect(()=>{const w=Math.max(1,Math.ceil(R.length/Ta));N>w&&L(w)},[R.length,N]),r.useEffect(()=>{const w=Q=>{const he=Q.target;he.closest(".fazenda-busca-container")||ie(!1),he.closest(".fazenda-busca-historico-container")||X(!1)};if(g||le)return document.addEventListener("mousedown",w),()=>{document.removeEventListener("mousedown",w)}},[g,le]);const B=r.useMemo(()=>{let w=[...a];if(w=w.filter(Q=>Q.status==="FECHADO"||Q.dia_atual!==void 0&&Q.dia_atual>9?!1:Q.dia_atual!==void 0&&Q.dia_atual<=9),D&&(w=w.filter(Q=>{const he=$.find(Ae=>Ae.id===Q.pacote_aspiracao_id);return(he==null?void 0:he.fazenda_id)===D})),u!==""){const Q=parseInt(u);w=w.filter(he=>he.dia_atual===void 0||he.dia_atual===null?!1:(he.dia_atual===0?-1:he.dia_atual-1)===Q)}return w},[a,D,u,$]),ve=r.useMemo(()=>o.filter(w=>w.nome.toLowerCase().includes(H.toLowerCase())),[o,H]);return{filtroFazendaAspiracao:D,setFiltroFazendaAspiracao:se,filtroFazendaAspiracaoBusca:H,setFiltroFazendaAspiracaoBusca:_e,filtroDiaCultivo:u,setFiltroDiaCultivo:W,showFazendaBusca:g,setShowFazendaBusca:ie,fazendasFiltradas:ve,lotesFiltrados:B,limparFiltrosAtivos:()=>{se(""),_e(""),W(""),ie(!1)},filtroHistoricoDataInicio:re,setFiltroHistoricoDataInicio:T,filtroHistoricoDataFim:ne,setFiltroHistoricoDataFim:V,filtroHistoricoFazenda:de,setFiltroHistoricoFazenda:ce,filtroHistoricoFazendaBusca:ge,setFiltroHistoricoFazendaBusca:xe,showFazendaBuscaHistorico:le,setShowFazendaBuscaHistorico:X,limparFiltrosHistorico:()=>{T(""),V(""),ce(""),xe(""),X(!1),L(1)},abaAtiva:f,setAbaAtiva:v,historicoPage:N,setHistoricoPage:L,HISTORICO_PAGE_SIZE:Ta}}function rs({id:a,filtroHistoricoDataInicio:$,filtroHistoricoDataFim:o,filtroHistoricoFazenda:R,setHistoricoPage:d}){const{toast:D}=xa(),[se,H]=r.useState([]),[_e,u]=r.useState([]),[W,g]=r.useState([]),[ie,re]=r.useState([]),[T,ne]=r.useState([]),[V,de]=r.useState(!0),[ce,ge]=r.useState(null),[xe,le]=r.useState(!1),[X,f]=r.useState([]),[v,N]=r.useState([]),[L,B]=r.useState([]),[ve,U]=r.useState([]),[me,w]=r.useState([]),[Q,he]=r.useState(""),[Ae,ze]=r.useState([]),[we,i]=r.useState([]),[A,te]=r.useState(""),[Fe,De]=r.useState([]),[Ke,ha]=r.useState([]),[Me,Be]=r.useState([]),[He,Pe]=r.useState(!1),[Re,We]=r.useState(null),[fa,ea]=r.useState(null),[ua,aa]=r.useState(!1),sa=r.useCallback(async b=>{try{const{data:y,error:G}=await c.from("embrioes").select("id, lote_fiv_acasalamento_id, created_at").eq("lote_fiv_id",b).order("created_at",{ascending:!1});if(G){B([]);return}const C=new Map;y==null||y.forEach(t=>{if(t.created_at){const j=t.created_at.split("T")[0],h=C.get(j)||[];h.push(t),C.set(j,h)}});const Se=[...new Set((y==null?void 0:y.map(t=>t.lote_fiv_acasalamento_id).filter(Boolean))||[])];if(Se.length>0){const{data:t,error:j}=await c.from("lote_fiv_acasalamentos").select("id, aspiracao_doadora_id, dose_semen_id").in("id",Se);if(!j&&t){const h=[...new Set(t.map(_=>_.aspiracao_doadora_id).filter(Boolean))],{data:x}=await c.from("aspiracoes_doadoras").select("id, doadora_id").in("id",h),Z=[...new Set((x==null?void 0:x.map(_=>_.doadora_id).filter(Boolean))||[])],{data:Y}=await c.from("doadoras").select("id, registro, nome").in("id",Z),J=[...new Set(t.map(_=>_.dose_semen_id).filter(Boolean))],{data:m}=await c.from("doses_semen").select("id, touro_id, touro:touros(id, nome, registro, raca)").in("id",J),S=new Map((x==null?void 0:x.map(_=>[_.id,_]))||[]),q=new Map((Y==null?void 0:Y.map(_=>[_.id,_]))||[]),M=new Map((m==null?void 0:m.map(_=>[_.id,_]))||[]),oe=new Map(t.map(_=>[_.id,_])),Ne=Array.from(C.keys()).sort((_,n)=>n.localeCompare(_)).map(_=>{const n=C.get(_)||[],z=new Map;n.forEach(F=>{F.lote_fiv_acasalamento_id&&z.set(F.lote_fiv_acasalamento_id,(z.get(F.lote_fiv_acasalamento_id)||0)+1)});const p=Array.from(z.entries()).map(([F,ae])=>{var P;const pe=oe.get(F),fe=pe?S.get(pe.aspiracao_doadora_id):void 0,s=fe?q.get(fe.doadora_id):void 0,E=pe?M.get(pe.dose_semen_id):void 0;return{acasalamento_id:F,quantidade:ae,doadora:(s==null?void 0:s.registro)||(s==null?void 0:s.nome)||"-",dose:E?((P=E.touro)==null?void 0:P.nome)||"Touro desconhecido":"-"}});return{id:`${b}-${_}`,data_despacho:_,acasalamentos:p}});B(Ne);return}}const Ee=Array.from(C.keys()).map(t=>({id:`${b}-${t}`,data_despacho:t,acasalamentos:[]}));B(Ee)}catch{B([])}},[]),Ve=r.useCallback(async()=>{try{de(!0);const{data:b,error:y}=await c.from("pacotes_aspiracao").select("*").eq("status","FINALIZADO").order("data_aspiracao",{ascending:!1});if(y)throw y;const{data:G,error:C}=await c.from("fazendas").select("id, nome").order("nome",{ascending:!0});if(C)throw C;g(G||[]);const{data:Se,error:Ee}=await c.from("clientes").select("id, nome").order("nome",{ascending:!0});Ee||ne(Se||[]);const t=new Map(G==null?void 0:G.map(s=>[s.id,s.nome])),j=new Map,h=new Map,x=(b==null?void 0:b.map(s=>s.id))||[];if(x.length>0){const{data:s,error:E}=await c.from("pacotes_aspiracao_fazendas_destino").select("pacote_aspiracao_id, fazenda_destino_id").in("pacote_aspiracao_id",x);!E&&s&&s.forEach(K=>{const l=t.get(K.fazenda_destino_id);if(l){const ye=j.get(K.pacote_aspiracao_id)||[];ye.push(l),j.set(K.pacote_aspiracao_id,ye)}});const{data:P,error:Ie}=await c.from("aspiracoes_doadoras").select("pacote_aspiracao_id").in("pacote_aspiracao_id",x);!Ie&&P&&P.forEach(K=>{K.pacote_aspiracao_id&&h.set(K.pacote_aspiracao_id,(h.get(K.pacote_aspiracao_id)||0)+1)})}const{data:Z,error:Y}=await c.from("lotes_fiv").select("*").order("data_abertura",{ascending:!1});if(Y)throw Y;const J=new Set((Z==null?void 0:Z.map(s=>s.pacote_aspiracao_id).filter(s=>!!s))||[]),S=(b||[]).filter(s=>s.usado_em_lote_fiv!==void 0?!s.usado_em_lote_fiv:!J.has(s.id)).map(s=>({...s,fazenda_nome:t.get(s.fazenda_id),fazendas_destino_nomes:j.get(s.id)||[],quantidade_doadoras:h.get(s.id)||0}));u(S);const q=(Z==null?void 0:Z.map(s=>s.id))||[],{data:M,error:oe}=await c.from("lote_fiv_acasalamentos").select("lote_fiv_id").in("lote_fiv_id",q);if(oe)throw oe;const ee=new Map;M==null||M.forEach(s=>{ee.set(s.lote_fiv_id,(ee.get(s.lote_fiv_id)||0)+1)});const{data:Ne,error:_}=await c.from("lote_fiv_fazendas_destino").select("lote_fiv_id, fazenda_id").in("lote_fiv_id",q);if(_)throw _;const n=new Map;Ne==null||Ne.forEach(s=>{const E=t.get(s.fazenda_id);if(E){const P=n.get(s.lote_fiv_id)||[];P.push(E),n.set(s.lote_fiv_id,P)}});const z=new Map(S.map(s=>[s.id,s]));(b||[]).forEach(s=>{z.has(s.id)||z.set(s.id,{...s,fazenda_nome:t.get(s.fazenda_id),fazendas_destino_nomes:j.get(s.id)||[],quantidade_doadoras:h.get(s.id)||0})});const p=(Z||[]).map(s=>{const E=z.get(s.pacote_aspiracao_id);let P=ke((E==null?void 0:E.data_aspiracao)||null);if(!P){const l=ke(s.data_abertura);if(l){const[ye,be,Ce]=l.split("-").map(Number),k=new Date(ye,be-1,Ce);k.setDate(k.getDate()-1);const qe=k.getFullYear(),Qe=String(k.getMonth()+1).padStart(2,"0"),ja=String(k.getDate()).padStart(2,"0");P=`${qe}-${Qe}-${ja}`}}const Ie=za(),K=P?Math.max(0,Fa(Ie,P)):0;return{...s,pacote_nome:E==null?void 0:E.fazenda_nome,pacote_data:E==null?void 0:E.data_aspiracao,fazendas_destino_nomes:n.get(s.id)||[],quantidade_acasalamentos:ee.get(s.id)||0,dia_atual:K}}),F=p.filter(s=>s.status==="ABERTO"&&s.dia_atual!==void 0&&s.dia_atual>9);if(F.length>0){const s=F.map(E=>E.id);c.from("lotes_fiv").update({status:"FECHADO"}).in("id",s).then(({error:E})=>{E&&D({title:"Aviso",description:"N√£o foi poss√≠vel fechar automaticamente alguns lotes expirados. Recarregue a p√°gina.",variant:"destructive"})})}H(p);const ae=new Set(p.map(s=>s.pacote_aspiracao_id).filter(s=>!!s)),pe=[];(b||[]).forEach(s=>{ae.has(s.id)&&pe.push({...s,fazenda_nome:t.get(s.fazenda_id),fazendas_destino_nomes:j.get(s.id)||[],quantidade_doadoras:h.get(s.id)||0})}),De(pe);const fe=new Map;pe.forEach(s=>{s.fazenda_id&&s.fazenda_nome&&fe.set(s.fazenda_id,s.fazenda_nome)}),ha(Array.from(fe.entries()).map(([s,E])=>({id:s,nome:E})).sort((s,E)=>s.nome.localeCompare(E.nome)))}catch(b){oa(b,"Erro ao carregar dados")}finally{de(!1)}},[D]),_a=r.useCallback(async()=>{try{Pe(!0),d(1);let b=c.from("lotes_fiv").select("*").eq("status","FECHADO");$&&(b=b.gte("data_abertura",$)),o&&(b=b.lte("data_abertura",o));const{data:y,error:G}=await b.order("data_abertura",{ascending:!1});if(G)throw G;if(!y||y.length===0){Be([]),Pe(!1);return}const C=y.map(n=>n.id),Se=[...new Set(y.map(n=>n.pacote_aspiracao_id).filter(Boolean))],{data:Ee}=await c.from("pacotes_aspiracao").select("id, data_aspiracao, fazenda_id, total_oocitos").in("id",Se),{data:t}=await c.from("fazendas").select("id, nome").order("nome",{ascending:!0}),j=new Map((t==null?void 0:t.map(n=>[n.id,n.nome]))||[]),h=(t==null?void 0:t.map(n=>({id:n.id,nome:n.nome})))||[],{data:x}=await c.from("lote_fiv_acasalamentos").select("id, lote_fiv_id, quantidade_embrioes, aspiracao_doadora_id").in("lote_fiv_id",C),{data:Z,error:Y}=await c.from("embrioes").select("id, lote_fiv_id, lote_fiv_acasalamento_id, classificacao, status_atual").in("lote_fiv_id",C);Y&&D({title:"Erro ao buscar embri√µes",description:Y.message,variant:"destructive"});const{data:J}=await c.from("lote_fiv_fazendas_destino").select("lote_fiv_id, fazenda_id").in("lote_fiv_id",C),m=[...new Set((x==null?void 0:x.map(n=>n.aspiracao_doadora_id).filter(Boolean))||[])],{data:S}=await c.from("aspiracoes_doadoras").select("id, viaveis").in("id",m),q=new Map((Ee==null?void 0:Ee.map(n=>[n.id,n]))||[]),M=new Map,oe=new Map,ee=new Map,Ne=new Map((S==null?void 0:S.map(n=>[n.id,n]))||[]);x==null||x.forEach(n=>{M.has(n.lote_fiv_id)||M.set(n.lote_fiv_id,[]),M.get(n.lote_fiv_id).push(n)}),Z&&Z.length>0&&Z.forEach(n=>{n.lote_fiv_id&&(oe.has(n.lote_fiv_id)||oe.set(n.lote_fiv_id,[]),oe.get(n.lote_fiv_id).push(n))}),J==null||J.forEach(n=>{ee.has(n.lote_fiv_id)||ee.set(n.lote_fiv_id,[]);const z=j.get(n.fazenda_id);z&&ee.get(n.lote_fiv_id).push(z)});let _=y.map(n=>{const z=q.get(n.pacote_aspiracao_id),p=M.get(n.id)||[],F=oe.get(n.id)||[],ae=ee.get(n.id)||[],pe=F.length,fe=F.filter(K=>K.status_atual==="TRANSFERIDO").length,s=F.filter(K=>K.status_atual==="CONGELADO").length,E=F.filter(K=>K.status_atual==="DESCARTADO").length,P={};F.forEach(K=>{K.classificacao?P[K.classificacao]=(P[K.classificacao]||0)+1:P.sem_classificacao=(P.sem_classificacao||0)+1});let Ie=0;return p.forEach(K=>{if(K.aspiracao_doadora_id){const l=Ne.get(K.aspiracao_doadora_id);l!=null&&l.viaveis&&(Ie+=l.viaveis)}}),{id:n.id,data_abertura:n.data_abertura,status:n.status,observacoes:n.observacoes,pacote_aspiracao_id:n.pacote_aspiracao_id,pacote_data:z==null?void 0:z.data_aspiracao,pacote_nome:j.get((z==null?void 0:z.fazenda_id)||""),fazenda_origem_nome:j.get((z==null?void 0:z.fazenda_id)||""),fazendas_destino_nomes:ae,quantidade_acasalamentos:p.length,total_embrioes_produzidos:pe,total_embrioes_transferidos:fe,total_embrioes_congelados:s,total_embrioes_descartados:E,embrioes_por_classificacao:{BE:P.BE,BN:P.BN,BX:P.BX,BL:P.BL,BI:P.BI,sem_classificacao:P.sem_classificacao},total_oocitos:z==null?void 0:z.total_oocitos,total_viaveis:Ie>0?Ie:void 0}});if(R){const n=h.find(z=>z.id===R);n&&(_=_.filter(z=>z.fazenda_origem_nome===n.nome))}Be(_)}catch(b){oa(b,"Erro ao carregar hist√≥rico")}finally{Pe(!1)}},[$,o,R,d,D]),ta=r.useCallback(async b=>{try{aa(!0);const y=Me.find(m=>m.id===b);if(!y){D({title:"Erro",description:"Lote n√£o encontrado",variant:"destructive"});return}const{data:G}=await c.from("pacotes_aspiracao").select("*").eq("id",y.pacote_aspiracao_id).single(),{data:C}=await c.from("lote_fiv_acasalamentos").select("*").eq("lote_fiv_id",b).order("created_at",{ascending:!0}),{data:Se}=await c.from("embrioes").select("*").eq("lote_fiv_id",b).order("created_at",{ascending:!0}),Ee=[...new Set((C==null?void 0:C.map(m=>m.aspiracao_doadora_id).filter(Boolean))||[])],{data:t}=await c.from("aspiracoes_doadoras").select("*, doadora:doadoras(id, registro, nome)").in("id",Ee),j=[...new Set((C==null?void 0:C.map(m=>m.dose_semen_id).filter(Boolean))||[])],{data:h}=await c.from("doses_semen").select("*, cliente:clientes(nome), touro:touros(id, nome, registro, raca)").in("id",j),x=new Map((t==null?void 0:t.map(m=>[m.id,m]))||[]),Z=new Map((h==null?void 0:h.map(m=>[m.id,m]))||[]),Y=new Map;(Se||[]).forEach(m=>{const S=m.lote_fiv_acasalamento_id||"sem_acasalamento";Y.has(S)||Y.set(S,{total:0,porStatus:{},porClassificacao:{}});const q=Y.get(S);q.total++;const M=m.status_atual||"sem_status";q.porStatus[M]=(q.porStatus[M]||0)+1;const oe=m.classificacao||"sem_classificacao";q.porClassificacao[oe]=(q.porClassificacao[oe]||0)+1});const J={lote:y,pacote:G?{id:G.id,data_aspiracao:G.data_aspiracao,horario_inicio:G.horario_inicio,horario_final:G.horario_final,veterinario_responsavel:G.veterinario_responsavel,tecnico_responsavel:G.tecnico_responsavel,total_oocitos:G.total_oocitos,observacoes:G.observacoes}:void 0,acasalamentos:(C||[]).map(m=>{var ee,Ne,_,n;const S=m.aspiracao_doadora_id?x.get(m.aspiracao_doadora_id):null,q=m.dose_semen_id?Z.get(m.dose_semen_id):null,M=S==null?void 0:S.doadora,oe=Y.get(m.id)||{total:0,porStatus:{},porClassificacao:{}};return{id:m.id,aspiracao_id:m.aspiracao_doadora_id,doadora:M?{registro:M.registro,nome:M.nome}:void 0,aspiracao:S?{data_aspiracao:S.data_aspiracao,horario_aspiracao:S.horario_aspiracao,viaveis:S.viaveis,expandidos:S.expandidos,total_oocitos:S.total_oocitos,atresicos:S.atresicos,degenerados:S.degenerados,desnudos:S.desnudos,veterinario_responsavel:S.veterinario_responsavel}:void 0,dose_semen:q?{nome:((ee=q.touro)==null?void 0:ee.nome)||"Touro desconhecido",registro:(Ne=q.touro)==null?void 0:Ne.registro,raca:((_=q.touro)==null?void 0:_.raca)||q.raca,tipo_semen:q.tipo_semen,cliente:(n=q.cliente)==null?void 0:n.nome}:void 0,quantidade_fracionada:m.quantidade_fracionada,quantidade_oocitos:m.quantidade_oocitos,quantidade_embrioes:m.quantidade_embrioes,observacoes:m.observacoes,resumo_embrioes:oe}}),embrioes:(Se||[]).map(m=>({id:m.id,identificacao:m.identificacao,classificacao:m.classificacao,tipo_embriao:m.tipo_embriao,status_atual:m.status_atual,acasalamento_id:m.lote_fiv_acasalamento_id}))};ea(J)}catch(y){oa(y,"Erro ao carregar detalhes")}finally{aa(!1)}},[Me,D]),va=r.useCallback(async b=>{Re===b?(We(null),ea(null)):(We(b),await ta(b))},[Re,ta]),Ue=r.useCallback(async b=>{try{de(!0);const{data:y,error:G}=await c.from("lotes_fiv").select("*").eq("id",b).single();if(G)throw G;const{data:C,error:Se}=await c.from("pacotes_aspiracao").select("*").eq("id",y.pacote_aspiracao_id).single();if(Se){if(Se.code==="PGRST116"){D({title:"Pacote n√£o encontrado",description:"O lote referencia um pacote de aspira√ß√£o inexistente. Verifique o v√≠nculo do lote.",variant:"destructive"}),de(!1);return}throw Se}te(C.data_aspiracao);const{data:Ee,error:t}=await c.from("fazendas").select("nome").eq("id",C.fazenda_id).single();he(t?"":(Ee==null?void 0:Ee.nome)||"");const{data:j}=await c.from("pacotes_aspiracao_fazendas_destino").select("fazenda_destino_id").eq("pacote_aspiracao_id",C.id);let h=[];if(!j||j.length===0?C.fazenda_destino_id&&(h=[C.fazenda_destino_id]):h=j.map(l=>l.fazenda_destino_id),N(h),h.length>0){const{data:l,error:ye}=await c.from("fazendas").select("id, nome").in("id",h);ye?ze([]):(ze((l==null?void 0:l.map(be=>be.nome))||[]),l&&g(be=>{const Ce=[...be];return l.forEach(k=>{Ce.find(qe=>qe.id===k.id)||Ce.push(k)}),Ce}))}else ze([]);const{data:x,error:Z}=await c.from("lote_fiv_acasalamentos").select("*").eq("lote_fiv_id",b).order("created_at",{ascending:!0});if(Z)throw Z;const Y=(x==null?void 0:x.map(l=>l.aspiracao_doadora_id))||[],{data:J,error:m}=await c.from("aspiracoes_doadoras").select("id, doadora_id, viaveis").in("id",Y);if(m)throw m;const S=[...new Set((J==null?void 0:J.map(l=>l.doadora_id))||[])],{data:q,error:M}=await c.from("doadoras").select("id, nome, registro").in("id",S);if(M)throw M;const oe=[...new Set((x==null?void 0:x.map(l=>l.dose_semen_id))||[])],{data:ee,error:Ne}=await c.from("doses_semen").select("id, touro_id, touro:touros(id, nome, registro, raca)").in("id",oe);if(Ne)throw Ne;const _=new Map(q==null?void 0:q.map(l=>[l.id,l])),n=new Map(ee==null?void 0:ee.map(l=>[l.id,l])),z=new Map(J==null?void 0:J.map(l=>[l.id,l])),{data:p,error:F}=await c.from("embrioes").select("lote_fiv_acasalamento_id").eq("lote_fiv_id",b),ae=new Map;!F&&p&&p.forEach(l=>{l.lote_fiv_acasalamento_id&&ae.set(l.lote_fiv_acasalamento_id,(ae.get(l.lote_fiv_acasalamento_id)||0)+1)});const pe=(x||[]).map(l=>{const ye=z.get(l.aspiracao_doadora_id),be=ye?_.get(ye.doadora_id):void 0,Ce=n.get(l.dose_semen_id),k=(Ce==null?void 0:Ce.touro)??null;return{...l,doadora_nome:(be==null?void 0:be.nome)||(be==null?void 0:be.registro),doadora_registro:be==null?void 0:be.registro,dose_nome:(k==null?void 0:k.nome)||"Touro desconhecido",viaveis:ye==null?void 0:ye.viaveis,total_embrioes_produzidos:ae.get(l.id)||0}});f(pe),ge({...y,pacote_nome:C.fazenda_id,pacote_data:C.data_aspiracao}),le(!0);const{data:fe,error:s}=await c.from("aspiracoes_doadoras").select("id, doadora_id, viaveis").eq("pacote_aspiracao_id",y.pacote_aspiracao_id);if(!s){const l=new Map;x==null||x.forEach(k=>{const qe=k.aspiracao_doadora_id,Qe=k.quantidade_oocitos||0;l.set(qe,(l.get(qe)||0)+Qe)});const be=(fe||[]).filter(k=>{const qe=k.viaveis??0,Qe=l.get(k.id)||0,ja=qe-Qe;return qe>0&&ja>0}).map(k=>({...k,oocitos_disponiveis:(k.viaveis??0)-(l.get(k.id)||0)}));U(be);const Ce=[...new Set((fe==null?void 0:fe.map(k=>k.doadora_id))||[])];if(Ce.length>0){const{data:k,error:qe}=await c.from("doadoras").select("id, nome, registro").in("id",Ce);!qe&&k&&re(k)}}const{data:E,error:P}=await c.from("doses_semen").select("id, touro_id, cliente_id, tipo_semen, quantidade, touro:touros(id, nome, registro, raca)").order("created_at",{ascending:!1});if(P)w([]);else try{const l=y==null?void 0:y.doses_selecionadas;l&&Array.isArray(l)&&l.length>0?w((E||[]).filter(ye=>l.includes(ye.id))):w(E||[])}catch{w(E||[])}const{data:Ie,error:K}=await c.from("clientes").select("id, nome").order("nome",{ascending:!0});K||ne(Ie||[]),await sa(b)}catch(y){oa(y,"Erro ao carregar detalhes do lote")}finally{de(!1)}},[D,sa]);return r.useEffect(()=>{a?Ue(a):Ve()},[a,Ve,Ue]),{lotes:se,pacotes:_e,fazendas:W,setFazendas:g,doadoras:ie,clientes:T,loading:V,selectedLote:ce,setSelectedLote:ge,showLoteDetail:xe,setShowLoteDetail:le,acasalamentos:X,setAcasalamentos:f,fazendasDestinoIds:v,historicoDespachos:L,setHistoricoDespachos:B,aspiracoesDisponiveis:ve,dosesDisponiveis:me,fazendaOrigemNome:Q,fazendasDestinoNomes:Ae,dosesDisponiveisNoLote:we,dataAspiracao:A,pacotesParaFiltro:Fe,fazendasAspiracaoUnicas:Ke,lotesHistoricos:Me,loadingHistorico:He,loteExpandido:Re,detalhesLoteExpandido:fa,loadingDetalhes:ua,loadData:Ve,loadLoteDetail:Ue,loadLotesHistoricos:_a,handleExpandirLote:va}}function ns({pacotes:a,clientes:$,fazendas:o}){var f;const R=Ca(),{toast:d}=xa(),[D,se]=r.useState(!1),[H,_e]=r.useState(!1),[u,W]=r.useState({pacote_aspiracao_id:"",observacoes:"",doses_selecionadas:[]}),[g,ie]=r.useState(null),[re,T]=r.useState([]),[ne,V]=r.useState([]),[de,ce]=r.useState([]),ge=async v=>{W({...u,pacote_aspiracao_id:v});const N=a.find(L=>L.id===v);if(ie(N||null),N){const{data:L,error:B}=await c.from("aspiracoes_doadoras").select("id, doadora_id, viaveis").eq("pacote_aspiracao_id",v);if(B)return;V(L||[]);const ve=[...new Set((L==null?void 0:L.map(w=>w.doadora_id))||[])];if(ve.length>0){const{data:w,error:Q}=await c.from("doadoras").select("id, nome, registro").in("id",ve);if(Q)return;ce(w||[])}const{data:U,error:me}=await c.from("doses_semen").select("id, cliente_id, touro_id, tipo_semen, quantidade, touro:touros(id, nome, registro, raca)").order("created_at",{ascending:!1});if(me)return;T(U||[])}},xe=async v=>{var N,L;if(v.preventDefault(),!u.pacote_aspiracao_id){d({title:"Erro de valida√ß√£o",description:"Pacote de aspira√ß√£o √© obrigat√≥rio",variant:"destructive"});return}if(!g){d({title:"Erro de valida√ß√£o",description:"Pacote selecionado n√£o encontrado",variant:"destructive"});return}try{_e(!0);const{data:B,error:ve}=await c.from("pacotes_aspiracao").select("id, status").eq("id",u.pacote_aspiracao_id).single();if(ve||!B){d({title:"Erro de valida√ß√£o",description:"Pacote de aspira√ß√£o n√£o encontrado ou inv√°lido",variant:"destructive"});return}if(B.status!=="FINALIZADO"){d({title:"Erro de valida√ß√£o",description:"Apenas pacotes FINALIZADOS podem ser usados para criar lotes FIV",variant:"destructive"});return}const U=new Date(g.data_aspiracao);U.setDate(U.getDate()+1);const me=U.toISOString().split("T")[0],w={pacote_aspiracao_id:u.pacote_aspiracao_id,data_abertura:me,data_fecundacao:me,status:"ABERTO",observacoes:u.observacoes||null};if(u.doses_selecionadas&&u.doses_selecionadas.length>0)try{w.doses_selecionadas=u.doses_selecionadas}catch{}let Q;const{data:he,error:Ae}=await c.from("lotes_fiv").insert([w]).select().single();if(Ae)if((N=Ae.message)!=null&&N.includes("doses_selecionadas")||Ae.code==="42703"){delete w.doses_selecionadas;const{data:we,error:i}=await c.from("lotes_fiv").insert([w]).select().single();if(i)throw i;Q=we}else throw Ae;else Q=he;const ze=(L=g.fazendas_destino_nomes)==null?void 0:L.map(we=>{const i=o.find(A=>A.nome===we);return i==null?void 0:i.id}).filter(we=>!!we);if(ze&&ze.length>0){const{error:we}=await c.from("lote_fiv_fazendas_destino").insert(ze.map(i=>({lote_fiv_id:Q.id,fazenda_id:i})));if(we)throw we}try{await c.from("pacotes_aspiracao").update({usado_em_lote_fiv:!0}).eq("id",u.pacote_aspiracao_id)}catch{}d({title:"Lote FIV criado",description:"Lote FIV criado com sucesso. Agora voc√™ pode adicionar acasalamentos."}),se(!1),le(),R(`/lotes-fiv/${Q.id}`)}catch(B){const ve=B instanceof Error?B.message:"Erro desconhecido";d({title:"Erro ao criar lote",description:ve.includes("RLS")||ve.includes("policy")?"RLS est√° bloqueando escrita. Configure pol√≠ticas anon no Supabase.":ve,variant:"destructive"})}finally{_e(!1)}},le=()=>{W({pacote_aspiracao_id:"",observacoes:"",doses_selecionadas:[]}),ie(null),V([]),ce([]),T([])},X=()=>{se(!1),le()};return e.jsxs(wa,{open:D,onOpenChange:se,children:[e.jsx(Ja,{asChild:!0,children:e.jsxs(ue,{className:"bg-green-600 hover:bg-green-700",children:[e.jsx($a,{className:"w-4 h-4 mr-2"}),"Novo Lote"]})}),e.jsxs(Da,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(Sa,{children:[e.jsx(Ea,{children:"Criar Novo Lote FIV"}),e.jsx(ya,{children:"Selecione um pacote de aspira√ß√£o FINALIZADO para criar o lote"})]}),e.jsxs("form",{onSubmit:xe,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(je,{htmlFor:"pacote_aspiracao_id",children:"Pacote de Aspira√ß√£o *"}),a.length===0?e.jsxs("div",{className:"border rounded-lg p-4 bg-yellow-50 border-yellow-200",children:[e.jsx("p",{className:"text-sm text-yellow-800 font-medium mb-2",children:"Nenhum pacote dispon√≠vel"}),e.jsxs("p",{className:"text-sm text-yellow-700",children:["Verifique se o pacote de aspira√ß√£o est√° com status ",e.jsx("strong",{children:"FINALIZADO"})," e ainda n√£o foi usado para criar um lote FIV."]})]}):e.jsxs(da,{value:u.pacote_aspiracao_id,onValueChange:ge,children:[e.jsx(ca,{children:e.jsx(la,{placeholder:"Selecione o pacote"})}),e.jsx(ma,{children:a.map(v=>e.jsxs(pa,{value:v.id,children:[Le(v.data_aspiracao)," - ",v.fazenda_nome," (",v.quantidade_doadoras," doadoras)"]},v.id))})]}),g&&e.jsxs("div",{className:"text-sm text-slate-600 space-y-1 mt-2 p-3 bg-slate-50 rounded-lg",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Data do Pacote:"})," ",Le(g.data_aspiracao)]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Data de Fecunda√ß√£o do Lote:"})," ",(()=>{const v=new Date(g.data_aspiracao);return v.setDate(v.getDate()+1),Le(v.toISOString().split("T")[0])})()]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Fazendas Destino:"})," ",((f=g.fazendas_destino_nomes)==null?void 0:f.join(", "))||"Nenhuma"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Quantidade de Doadoras:"})," ",g.quantidade_doadoras||0]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(je,{children:"Doses de S√™men Dispon√≠veis no Lote *"}),e.jsx("div",{className:"border rounded-lg p-4 max-h-60 overflow-y-auto",children:re.length===0?e.jsx("p",{className:"text-sm text-slate-500",children:g?"Carregando doses...":"Selecione um pacote primeiro"}):e.jsx("div",{className:"space-y-2",children:re.map(v=>{var B,ve;const N=$.find(U=>U.id===v.cliente_id),L=u.doses_selecionadas.includes(v.id);return e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:`dose-${v.id}`,checked:L,onChange:U=>{U.target.checked?W({...u,doses_selecionadas:[...u.doses_selecionadas,v.id]}):W({...u,doses_selecionadas:u.doses_selecionadas.filter(me=>me!==v.id)})},className:"rounded"}),e.jsxs("label",{htmlFor:`dose-${v.id}`,className:"text-sm cursor-pointer flex-1",children:[e.jsx("span",{className:"font-medium",children:((B=v.touro)==null?void 0:B.nome)||"Touro desconhecido"}),((ve=v.touro)==null?void 0:ve.registro)&&e.jsxs("span",{className:"text-slate-500 ml-2",children:["(",v.touro.registro,")"]}),N&&e.jsxs("span",{className:"text-slate-500 ml-2",children:["- ",N.nome]})]})]},v.id)})})}),e.jsx("p",{className:"text-xs text-slate-500",children:"Selecione as doses de s√™men que estar√£o dispon√≠veis para uso neste lote"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(je,{htmlFor:"observacoes",children:"Observa√ß√µes"}),e.jsx(Pa,{id:"observacoes",value:u.observacoes,onChange:v=>W({...u,observacoes:v.target.value}),placeholder:"Observa√ß√µes sobre o lote",rows:3})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(ue,{type:"submit",className:"flex-1 bg-green-600 hover:bg-green-700",disabled:H,children:H?"Criando...":"Criar Lote"}),e.jsx(ue,{type:"button",variant:"outline",onClick:X,disabled:H,children:"Cancelar"})]})]})]})]})}function $e(a){return{[-1]:"Aspira√ß√£o",0:"Fecunda√ß√£o",1:"Zigoto",2:"2 C√©lulas",3:"4 C√©lulas",4:"8 C√©lulas",5:"M√≥rula",6:"Blastocisto",7:"Blastocisto Expandido",8:"Blastocisto Expandido"}[a]||`D${a}`}function ds({lote:a,acasalamentos:$,aspiracoesDisponiveis:o,dosesDisponiveis:R,dosesDisponiveisNoLote:d,doadoras:D,clientes:se,historicoDespachos:H,dataAspiracao:_e,fazendaOrigemNome:u,fazendasDestinoNomes:W,submitting:g,onBack:ie,onAddAcasalamento:re,onDespacharEmbrioes:T,onUpdateQuantidadeEmbrioes:ne,editQuantidadeEmbrioes:V}){var we;const de=Ca(),{toast:ce}=xa(),[ge,xe]=r.useState(!1),[le,X]=r.useState(!1),[f,v]=r.useState(""),[N,L]=r.useState({aspiracao_doadora_id:"",dose_semen_id:"",quantidade_fracionada:"1.0",quantidade_oocitos:"",observacoes:""});let B=ke(_e||a.pacote_data||null);if(!B){const i=ke(a.data_abertura);if(i){const[A,te,Fe]=i.split("-").map(Number),De=new Date(A,te-1,Fe);De.setDate(De.getDate()-1),B=`${De.getFullYear()}-${String(De.getMonth()+1).padStart(2,"0")}-${String(De.getDate()).padStart(2,"0")}`}}if(!B)return e.jsx("div",{children:"Erro: Data de aspira√ß√£o n√£o encontrada"});const ve=za(),U=Math.max(0,Fa(ve,B)),me=is(U),w=Ra(B,8),Q=ga(w),he=Va(w),Ae=async i=>{if(i.preventDefault(),!N.aspiracao_doadora_id){ce({title:"Erro de valida√ß√£o",description:"Doadora √© obrigat√≥ria",variant:"destructive"});return}if(!N.dose_semen_id){ce({title:"Erro de valida√ß√£o",description:"Selecione uma dose de s√™men",variant:"destructive"});return}if((parseFloat(N.quantidade_fracionada)||0)<=0){ce({title:"Erro de valida√ß√£o",description:"Quantidade fracionada deve ser maior que zero",variant:"destructive"});return}try{await re(N),xe(!1),L({aspiracao_doadora_id:"",dose_semen_id:"",quantidade_fracionada:"1.0",quantidade_oocitos:"",observacoes:""}),v("")}catch{}},ze=()=>{ie(),de("/lotes-fiv")};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(ue,{variant:"ghost",size:"sm",onClick:ze,children:e.jsx(Ka,{className:"w-4 h-4"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-slate-900",children:"Detalhes do Lote FIV"}),e.jsxs("div",{className:"text-slate-600 mt-1 flex items-center gap-2",children:[e.jsxs("span",{children:["Data de fecunda√ß√£o (D0): ",Le(a.data_abertura)," |",B&&` Data aspira√ß√£o (D-1): ${ga(B)} |`,me===-1?` D-1 - ${$e(me)} |`:` D${me} - ${$e(me)} |`," ","Status:"]}),e.jsx(Te,{variant:a.status==="FECHADO"?"default":"secondary",children:a.status})]})]})]}),e.jsxs(Ze,{children:[e.jsx(Xe,{children:e.jsx(Ge,{children:"Informa√ß√µes do Lote"})}),e.jsxs(Ye,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(je,{children:"Dia Atual"}),e.jsx("p",{className:"text-2xl font-bold",children:me===-1?e.jsxs(e.Fragment,{children:["D-1 ",e.jsxs("span",{className:"text-lg font-normal text-slate-600",children:["- ",$e(me)]})]}):e.jsxs(e.Fragment,{children:["D",me," ",e.jsxs("span",{className:"text-lg font-normal text-slate-600",children:["- ",$e(me)]})]})})]}),e.jsxs("div",{children:[e.jsx(je,{children:"Data da TE"}),U<7?e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-orange-600",children:Q}),e.jsx("p",{className:"text-sm text-slate-500",children:he})]}):e.jsx("p",{className:"text-2xl font-bold text-green-600",children:"Hoje ou passou"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(je,{children:"Fazenda de Origem"}),e.jsx("p",{className:"font-medium",children:u||a.pacote_nome||"-"})]}),e.jsxs("div",{children:[e.jsx(je,{children:"Fazendas de Destino"}),e.jsx("p",{className:"font-medium",children:W.length>0?W.join(", "):((we=a.fazendas_destino_nomes)==null?void 0:we.join(", "))||"-"})]})]}),a.observacoes&&e.jsxs("div",{children:[e.jsx(je,{children:"Observa√ß√µes"}),e.jsx("p",{className:"text-slate-600",children:a.observacoes})]}),a.status==="ABERTO"&&U===7&&e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"text-blue-800 font-medium",children:["üìä Este lote est√° no D6 (",$e(6),"). Voc√™ pode preencher a quantidade de embri√µes (pr√©via) e gerar um relat√≥rio."]}),e.jsxs(ue,{variant:"outline",size:"sm",onClick:()=>X(!0),children:[e.jsx(Wa,{className:"w-4 h-4 mr-2"}),"Gerar Relat√≥rio de Pr√©via"]})]})}),(a.status==="ABERTO"&&(U===8||U===9)||a.status==="FECHADO"&&U===9)&&e.jsx("div",{className:"bg-orange-50 border border-orange-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"text-orange-800 font-medium",children:["‚ö†Ô∏è Este lote est√° no ",U===8?"D7":"D8"," (",$e(U===8?7:8),"). ",U===8?"Informe a quantidade de embri√µes para cada acasalamento e despache os embri√µes.":"Per√≠odo de emerg√™ncia (D8). Voc√™ pode adicionar novos acasalamentos e despachar os embri√µes imediatamente."]}),e.jsxs(ue,{variant:"default",size:"sm",onClick:T,disabled:g,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(Aa,{className:"w-4 h-4 mr-2"}),g?"Despachando...":"Despachar Todos os Embri√µes"]})]})})]})]}),e.jsxs(Ze,{children:[e.jsx(Xe,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Ge,{className:"flex items-center gap-2",children:[e.jsx(Na,{className:"w-5 h-5"}),"Acasalamentos (",$.length,")"]}),a.status==="ABERTO"&&e.jsxs(ue,{size:"sm",onClick:()=>xe(!0),className:"bg-green-600 hover:bg-green-700",children:[e.jsx($a,{className:"w-4 h-4 mr-2"}),"Adicionar Acasalamento"]})]})}),e.jsx(Ye,{children:$.length===0?e.jsxs("div",{className:"text-center py-8 text-slate-500",children:[e.jsx(Na,{className:"w-12 h-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"Nenhum acasalamento cadastrado"}),a.status==="ABERTO"&&e.jsx(ue,{variant:"outline",size:"sm",className:"mt-2",onClick:()=>xe(!0),children:"Adicionar primeiro acasalamento"})]}):e.jsxs(ia,{children:[e.jsx(ra,{children:e.jsxs(Oe,{children:[e.jsx(I,{children:"Doadora"}),e.jsx(I,{children:"Touro"}),e.jsx(I,{className:"text-center",children:"O√≥citos"}),e.jsx(I,{className:"text-center",children:"Qtd. Embri√µes"}),e.jsx(I,{className:"text-center",children:"%"}),e.jsx(I,{children:"Observa√ß√µes"})]})}),e.jsx(na,{children:$.map(i=>{const A=i.viaveis||0,te=V[i.id]!==void 0?parseInt(V[i.id])||0:i.total_embrioes_produzidos||0,Fe=A>0?(te/A*100).toFixed(1):"0.0";return e.jsxs(Oe,{children:[e.jsx(O,{children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:i.doadora_registro||"-"}),i.doadora_nome&&e.jsx("p",{className:"text-sm text-slate-500",children:i.doadora_nome})]})}),e.jsx(O,{children:i.dose_nome||"-"}),e.jsx(O,{className:"text-center",children:A}),e.jsx(O,{className:"text-center",children:a.status==="ABERTO"&&U>=7?e.jsx(Je,{type:"number",min:"0",className:"w-20 text-center",value:V[i.id]??i.total_embrioes_produzidos??"",onChange:De=>ne(i.id,De.target.value),placeholder:"0"}):e.jsx("span",{children:te})}),e.jsx(O,{className:"text-center",children:e.jsxs(Te,{variant:parseFloat(Fe)>=30?"default":"secondary",children:[Fe,"%"]})}),e.jsx(O,{className:"max-w-[200px] truncate",children:i.observacoes||"-"})]},i.id)})})]})})]}),H.length>0&&e.jsxs(Ze,{children:[e.jsx(Xe,{children:e.jsxs(Ge,{className:"flex items-center gap-2",children:[e.jsx(Aa,{className:"w-5 h-5"}),"Hist√≥rico de Despachos"]})}),e.jsx(Ye,{children:e.jsx("div",{className:"space-y-4",children:H.map(i=>e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsxs("p",{className:"font-medium mb-2",children:["Despacho em ",ga(i.data_despacho)]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2",children:i.acasalamentos.map((A,te)=>e.jsxs("div",{className:"text-sm bg-slate-50 rounded p-2",children:[e.jsx("span",{className:"font-medium",children:A.doadora}),e.jsxs("span",{className:"text-slate-500",children:[" x ",A.dose]}),e.jsxs("span",{className:"ml-2 text-green-600 font-medium",children:["(",A.quantidade,")"]})]},te))})]},i.id))})})]}),e.jsx(wa,{open:ge,onOpenChange:xe,children:e.jsxs(Da,{className:"max-w-lg",children:[e.jsxs(Sa,{children:[e.jsx(Ea,{children:"Adicionar Acasalamento"}),e.jsx(ya,{children:"Selecione a doadora e a dose de s√™men para o acasalamento"})]}),e.jsxs("form",{onSubmit:Ae,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(je,{children:"Doadora *"}),e.jsxs(da,{value:N.aspiracao_doadora_id,onValueChange:i=>{L({...N,aspiracao_doadora_id:i});const A=o.find(te=>te.id===i);A&&L(te=>({...te,aspiracao_doadora_id:i,quantidade_oocitos:String(A.oocitos_disponiveis||A.viaveis||0)}))},children:[e.jsx(ca,{children:e.jsx(la,{placeholder:"Selecione a doadora"})}),e.jsx(ma,{children:o.map(i=>{const A=D.find(te=>te.id===i.doadora_id);return e.jsxs(pa,{value:i.id,children:[(A==null?void 0:A.registro)||(A==null?void 0:A.nome)||"Doadora"," - ",i.oocitos_disponiveis??i.viaveis??0," o√≥citos dispon√≠veis"]},i.id)})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(je,{children:"Dose de S√™men *"}),e.jsxs(da,{value:N.dose_semen_id,onValueChange:i=>L({...N,dose_semen_id:i}),children:[e.jsx(ca,{children:e.jsx(la,{placeholder:"Selecione a dose"})}),e.jsx(ma,{children:(d.length>0?d:R).map(i=>{var te,Fe;const A=se.find(De=>De.id===i.cliente_id);return e.jsxs(pa,{value:i.id,children:[((te=i.touro)==null?void 0:te.nome)||"Touro desconhecido",((Fe=i.touro)==null?void 0:Fe.registro)&&` (${i.touro.registro})`,A&&` - ${A.nome}`]},i.id)})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(je,{children:"Qtd. Fracionada"}),e.jsx(Je,{type:"number",step:"0.1",min:"0",value:N.quantidade_fracionada,onChange:i=>L({...N,quantidade_fracionada:i.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(je,{children:"Qtd. O√≥citos"}),e.jsx(Je,{type:"number",min:"0",value:N.quantidade_oocitos,onChange:i=>L({...N,quantidade_oocitos:i.target.value}),placeholder:"Auto"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(je,{children:"Observa√ß√µes"}),e.jsx(Pa,{value:N.observacoes,onChange:i=>L({...N,observacoes:i.target.value}),placeholder:"Observa√ß√µes sobre o acasalamento",rows:2})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(ue,{type:"submit",className:"flex-1 bg-green-600 hover:bg-green-700",disabled:g,children:g?"Adicionando...":"Adicionar"}),e.jsx(ue,{type:"button",variant:"outline",onClick:()=>{xe(!1),L({aspiracao_doadora_id:"",dose_semen_id:"",quantidade_fracionada:"1.0",quantidade_oocitos:"",observacoes:""})},children:"Cancelar"})]})]})]})}),e.jsx(wa,{open:le,onOpenChange:X,children:e.jsxs(Da,{className:"max-w-2xl",children:[e.jsxs(Sa,{children:[e.jsx(Ea,{children:"Relat√≥rio de Pr√©via - D6"}),e.jsx(ya,{children:"Resumo dos acasalamentos e embri√µes previstos"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"border rounded-lg p-4 bg-slate-50",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Informa√ß√µes do Lote"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-slate-500",children:"Fazenda Origem:"})," ",u||a.pacote_nome]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-slate-500",children:"Fazendas Destino:"})," ",W.join(", ")||"-"]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-slate-500",children:"Data TE prevista:"})," ",Q]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-slate-500",children:"Total Acasalamentos:"})," ",$.length]})]})]}),e.jsxs(ia,{children:[e.jsx(ra,{children:e.jsxs(Oe,{children:[e.jsx(I,{children:"Doadora"}),e.jsx(I,{children:"Touro"}),e.jsx(I,{className:"text-center",children:"O√≥citos"}),e.jsx(I,{className:"text-center",children:"Embri√µes (prev.)"})]})}),e.jsx(na,{children:$.map(i=>e.jsxs(Oe,{children:[e.jsx(O,{children:i.doadora_registro||"-"}),e.jsx(O,{children:i.dose_nome||"-"}),e.jsx(O,{className:"text-center",children:i.viaveis||0}),e.jsx(O,{className:"text-center",children:V[i.id]??i.total_embrioes_produzidos??"-"})]},i.id))})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(ue,{onClick:()=>X(!1),children:"Fechar"})})]})]})})]})}function cs({lotesHistoricos:a,fazendas:$,detalhesLoteExpandido:o,loteExpandido:R,loadingHistorico:d,loadingDetalhes:D,filtroHistoricoDataInicio:se,setFiltroHistoricoDataInicio:H,filtroHistoricoDataFim:_e,setFiltroHistoricoDataFim:u,filtroHistoricoFazenda:W,setFiltroHistoricoFazenda:g,filtroHistoricoFazendaBusca:ie,setFiltroHistoricoFazendaBusca:re,showFazendaBuscaHistorico:T,setShowFazendaBuscaHistorico:ne,historicoPage:V,setHistoricoPage:de,HISTORICO_PAGE_SIZE:ce,onLoadHistorico:ge,onExpandirLote:xe}){const le=Math.max(1,Math.ceil(a.length/ce)),X=()=>{H(""),u(""),g(""),re(""),ne(!1),ge()};return e.jsxs("div",{className:"mt-0",children:[e.jsxs("div",{className:"flex gap-4 mb-6 flex-wrap items-end",children:[e.jsxs("div",{className:"flex-1 min-w-[280px]",children:[e.jsxs("div",{className:"mb-2",children:[e.jsx(je,{className:"text-sm font-medium text-slate-700",children:"Per√≠odo de Busca"}),e.jsx("p",{className:"text-xs text-slate-500 mt-0.5",children:"Filtro pela data D0 (Fecunda√ß√£o) do lote"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(je,{htmlFor:"filtro-historico-data-inicio",className:"text-xs text-slate-500 font-normal",children:"Data In√≠cio"}),e.jsx(Oa,{value:se,onChange:f=>H(f||""),placeholder:"Data inicial"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx(je,{htmlFor:"filtro-historico-data-fim",className:"text-xs text-slate-500 font-normal",children:"Data Fim"}),e.jsx(Oa,{value:_e,onChange:f=>u(f||""),placeholder:"Data final"})]})]})]}),e.jsxs("div",{className:"flex-1 min-w-[250px] relative fazenda-busca-historico-container",children:[e.jsx(je,{htmlFor:"filtro-historico-fazenda",children:"Fazenda de Origem"}),e.jsxs("div",{className:"relative",children:[e.jsx(Je,{id:"filtro-historico-fazenda",placeholder:"Digite para buscar fazenda...",value:ie,onChange:f=>{re(f.target.value),ne(!0),f.target.value||g("")},onFocus:()=>ne(!0)}),W&&e.jsx(ue,{variant:"ghost",size:"sm",className:"absolute right-1 top-1 h-7 w-7 p-0",onClick:()=>{g(""),re(""),ne(!1)},children:e.jsx(ka,{className:"h-4 w-4"})}),T&&$.length>0&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-white border rounded-md shadow-lg max-h-60 overflow-auto",children:$.filter(f=>f.nome.toLowerCase().includes(ie.toLowerCase())).map(f=>e.jsx("div",{className:"px-4 py-2 hover:bg-slate-100 cursor-pointer",onClick:()=>{g(f.id),re(f.nome),ne(!1)},children:f.nome},f.id))}),T&&ie&&$.filter(f=>f.nome.toLowerCase().includes(ie.toLowerCase())).length===0&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-white border rounded-md shadow-lg p-4 text-sm text-slate-500",children:"Nenhuma fazenda encontrada"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(ue,{onClick:ge,disabled:d,className:"bg-blue-600 hover:bg-blue-700",children:[e.jsx(es,{className:"w-4 h-4 mr-2"}),"Buscar"]}),(se||_e||W)&&e.jsx(ue,{variant:"outline",onClick:X,children:"Limpar"})]})]}),d?e.jsx("div",{className:"py-8",children:e.jsx(qa,{})}):a.length===0?e.jsx(Ma,{title:"Nenhum lote hist√≥rico encontrado",description:"Ajuste os filtros ou tente outro per√≠odo."}):e.jsxs("div",{className:"space-y-4",children:[a.slice((V-1)*ce,V*ce).map(f=>e.jsx(ls,{lote:f,isExpanded:R===f.id,detalhes:R===f.id?o:null,loadingDetalhes:D&&R===f.id,onExpandir:()=>xe(f.id)},f.id)),e.jsxs("div",{className:"flex items-center justify-between pt-2 text-sm text-slate-600",children:[e.jsxs("div",{children:[a.length," lotes no hist√≥rico"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ue,{variant:"outline",size:"sm",onClick:()=>de(Math.max(1,V-1)),disabled:V===1,children:"Anterior"}),e.jsxs("span",{children:["P√°gina ",Math.min(V,le)," de ",le]}),e.jsx(ue,{variant:"outline",size:"sm",onClick:()=>de(Math.min(le,V+1)),disabled:V>=le,children:"Pr√≥xima"})]})]})]})]})}function ls({lote:a,isExpanded:$,detalhes:o,loadingDetalhes:R,onExpandir:d}){return e.jsxs(Ze,{className:"border-l-4 border-l-slate-400",children:[e.jsx(Xe,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Ge,{className:"text-lg",children:["Lote FIV - ",Le(a.data_abertura)]}),e.jsx(ue,{variant:"outline",size:"sm",onClick:d,disabled:R,children:$?e.jsxs(e.Fragment,{children:[e.jsx(Qa,{className:"w-4 h-4 mr-2"}),"Recolher"]}):e.jsxs(e.Fragment,{children:[e.jsx(Za,{className:"w-4 h-4 mr-2"}),"Ver Detalhes Completos"]})})]})}),e.jsxs(Ye,{className:"pt-0",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Informa√ß√µes B√°sicas"}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Data da Aspira√ß√£o:"})," ",a.pacote_data?Le(a.pacote_data):"-"]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Fazenda Origem:"})," ",a.fazenda_origem_nome||"-"]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Data de Abertura:"})," ",Le(a.data_abertura)]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Status:"})," ",e.jsx(Te,{variant:"outline",children:a.status})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Fazendas Destino"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:a.fazendas_destino_nomes&&a.fazendas_destino_nomes.length>0?a.fazendas_destino_nomes.map((D,se)=>e.jsx(Te,{variant:"outline",className:"text-xs",children:D},se)):e.jsx("span",{className:"text-slate-400 text-sm",children:"-"})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Estat√≠sticas"}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Acasalamentos:"})," ",a.quantidade_acasalamentos||0]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total de Embri√µes:"})," ",a.total_embrioes_produzidos||0]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total Transferidos:"})," ",e.jsx("span",{className:"text-green-700 font-semibold",children:a.total_embrioes_transferidos||0})]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total Congelados:"})," ",e.jsx("span",{className:"text-blue-700 font-semibold",children:a.total_embrioes_congelados||0})]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total Descartados:"})," ",e.jsx("span",{className:"text-red-700 font-semibold",children:a.total_embrioes_descartados||0})]}),a.total_oocitos&&e.jsxs("p",{className:"mt-2 pt-2 border-t border-slate-200",children:[e.jsx("span",{className:"font-medium",children:"Total de O√≥citos:"})," ",a.total_oocitos]}),a.total_viaveis&&e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"O√≥citos Vi√°veis:"})," ",a.total_viaveis]})]})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2 lg:col-span-3",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Embri√µes por Classifica√ß√£o"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-6 gap-2",children:[a.embrioes_por_classificacao.BE&&e.jsxs("div",{className:"bg-green-50 p-2 rounded border",children:[e.jsx("p",{className:"text-xs font-medium text-green-800",children:"BE"}),e.jsx("p",{className:"text-lg font-bold text-green-900",children:a.embrioes_por_classificacao.BE})]}),a.embrioes_por_classificacao.BN&&e.jsxs("div",{className:"bg-blue-50 p-2 rounded border",children:[e.jsx("p",{className:"text-xs font-medium text-blue-800",children:"BN"}),e.jsx("p",{className:"text-lg font-bold text-blue-900",children:a.embrioes_por_classificacao.BN})]}),a.embrioes_por_classificacao.BX&&e.jsxs("div",{className:"bg-yellow-50 p-2 rounded border",children:[e.jsx("p",{className:"text-xs font-medium text-yellow-800",children:"BX"}),e.jsx("p",{className:"text-lg font-bold text-yellow-900",children:a.embrioes_por_classificacao.BX})]}),a.embrioes_por_classificacao.BL&&e.jsxs("div",{className:"bg-orange-50 p-2 rounded border",children:[e.jsx("p",{className:"text-xs font-medium text-orange-800",children:"BL"}),e.jsx("p",{className:"text-lg font-bold text-orange-900",children:a.embrioes_por_classificacao.BL})]}),a.embrioes_por_classificacao.BI&&e.jsxs("div",{className:"bg-red-50 p-2 rounded border",children:[e.jsx("p",{className:"text-xs font-medium text-red-800",children:"BI"}),e.jsx("p",{className:"text-lg font-bold text-red-900",children:a.embrioes_por_classificacao.BI})]}),a.embrioes_por_classificacao.sem_classificacao&&e.jsxs("div",{className:"bg-slate-50 p-2 rounded border",children:[e.jsx("p",{className:"text-xs font-medium text-slate-800",children:"Sem Classifica√ß√£o"}),e.jsx("p",{className:"text-lg font-bold text-slate-900",children:a.embrioes_por_classificacao.sem_classificacao})]})]})]}),a.observacoes&&e.jsxs("div",{className:"space-y-2 md:col-span-2 lg:col-span-3",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Observa√ß√µes"}),e.jsx("p",{className:"text-sm text-slate-600 bg-slate-50 p-3 rounded border",children:a.observacoes})]})]}),$&&e.jsx(ms,{detalhes:o,loadingDetalhes:R})]})]})}function ms({detalhes:a,loadingDetalhes:$}){return $?e.jsx("div",{className:"mt-4 pt-4 border-t border-slate-200 py-4",children:e.jsx(qa,{})}):a?e.jsxs("div",{className:"mt-4 pt-4 border-t border-slate-200 space-y-4",children:[a.pacote&&e.jsxs("div",{className:"bg-slate-50 p-3 rounded border text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Aa,{className:"w-4 h-4 text-slate-600"}),e.jsx("span",{className:"font-semibold",children:"Pacote de Aspira√ß√£o"})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-x-4 gap-y-1",children:[a.pacote.data_aspiracao&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Data:"})," ",e.jsx("span",{className:"font-medium",children:Le(a.pacote.data_aspiracao)})]}),a.pacote.horario_inicio&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Hora In√≠cio:"})," ",e.jsx("span",{className:"font-medium",children:a.pacote.horario_inicio})]}),a.pacote.horario_final&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Hora Fim Aspira√ß√£o:"})," ",e.jsx("span",{className:"font-medium",children:a.pacote.horario_final})]}),a.pacote.veterinario_responsavel&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Vet:"})," ",e.jsx("span",{className:"font-medium",children:a.pacote.veterinario_responsavel})]}),a.pacote.tecnico_responsavel&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"T√©cnico:"})," ",e.jsx("span",{className:"font-medium",children:a.pacote.tecnico_responsavel})]}),a.pacote.total_oocitos&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"O√≥citos Totais:"})," ",e.jsx("span",{className:"font-medium",children:a.pacote.total_oocitos})]}),a.pacote.observacoes&&e.jsxs("div",{className:"col-span-full mt-1 pt-1 border-t border-slate-200",children:[e.jsx("span",{className:"text-slate-600",children:"Obs:"})," ",e.jsx("span",{className:"text-slate-700",children:a.pacote.observacoes})]})]})]}),a.acasalamentos.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Na,{className:"w-4 h-4 text-slate-600"}),e.jsxs("span",{className:"font-semibold text-sm",children:["Acasalamentos e Embri√µes (",a.acasalamentos.length,")"]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(ia,{children:[e.jsx(ra,{children:e.jsxs(Oe,{className:"bg-slate-50",children:[e.jsx(I,{className:"h-8 text-xs font-semibold",children:"#"}),e.jsx(I,{className:"h-8 text-xs font-semibold",children:"Doadora"}),e.jsx(I,{className:"h-8 text-xs font-semibold",children:"Aspira√ß√£o"}),e.jsx(I,{className:"h-8 text-xs font-semibold",children:"O√≥citos"}),e.jsx(I,{className:"h-8 text-xs font-semibold",children:"Vi√°veis"}),e.jsx(I,{className:"h-8 text-xs font-semibold",children:"S√™men"}),e.jsx(I,{className:"h-8 text-xs font-semibold",children:"Dose"}),e.jsx(I,{className:"h-8 text-xs font-semibold",children:"Embri√µes Prod."}),e.jsx(I,{className:"h-8 text-xs font-semibold",children:"Total Emb."}),e.jsx(I,{className:"h-8 text-xs font-semibold",children:"Transf."}),e.jsx(I,{className:"h-8 text-xs font-semibold",children:"Cong."}),e.jsx(I,{className:"h-8 text-xs font-semibold",children:"Desc."}),e.jsx(I,{className:"h-8 text-xs font-semibold",children:"Outros"}),e.jsx(I,{className:"h-8 text-xs font-semibold",children:"Classifica√ß√£o"})]})}),e.jsx(na,{children:a.acasalamentos.map((o,R)=>{var ie,re,T,ne,V,de,ce,ge,xe,le;const d=o.resumo_embrioes,D=(d==null?void 0:d.porStatus.TRANSFERIDO)||0,se=(d==null?void 0:d.porStatus.CONGELADO)||0,H=(d==null?void 0:d.porStatus.DESCARTADO)||0,_e=d?d.total-D-se-H:0,u=d&&Object.entries(d.porClassificacao).filter(([X])=>X!=="sem_classificacao").sort((X,f)=>f[1]-X[1]).map(([X,f])=>`${X}(${f})`).join(", ")||"-",W=R>0?a.acasalamentos[R-1]:null,g=W&&o.aspiracao_id&&o.aspiracao_id===W.aspiracao_id;return e.jsxs(Oe,{className:`text-xs ${g?"bg-slate-50/50":""}`,children:[e.jsx(O,{className:"py-2 font-medium",children:R+1}),e.jsx(O,{className:"py-2",children:g?e.jsx("div",{className:"text-slate-400 italic text-[10px]",children:"‚Ü≥"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"font-medium",children:((ie=o.doadora)==null?void 0:ie.registro)||"-"}),((re=o.doadora)==null?void 0:re.nome)&&e.jsx("div",{className:"text-slate-500 text-[11px]",children:o.doadora.nome})]})}),e.jsx(O,{className:"py-2",children:g?e.jsx("div",{className:"text-slate-400 italic text-[10px]",children:"‚Ü≥"}):e.jsxs(e.Fragment,{children:[((T=o.aspiracao)==null?void 0:T.data_aspiracao)&&e.jsx("div",{children:Le(o.aspiracao.data_aspiracao)}),((ne=o.aspiracao)==null?void 0:ne.horario_aspiracao)&&e.jsx("div",{className:"text-slate-500 text-[11px]",children:o.aspiracao.horario_aspiracao})]})}),e.jsx(O,{className:"py-2",children:g?e.jsx("div",{className:"text-slate-400 italic text-[10px]",children:"‚Ü≥ (mesma aspira√ß√£o)"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"font-medium",children:((V=o.aspiracao)==null?void 0:V.total_oocitos)??"-"}),o.aspiracao&&e.jsxs("div",{className:"text-[10px] text-slate-500 space-x-1",children:[o.aspiracao.expandidos!==void 0&&e.jsxs("span",{children:["Exp:",o.aspiracao.expandidos]}),o.aspiracao.atresicos!==void 0&&e.jsxs("span",{children:["At:",o.aspiracao.atresicos]}),o.aspiracao.degenerados!==void 0&&e.jsxs("span",{children:["Deg:",o.aspiracao.degenerados]}),o.aspiracao.desnudos!==void 0&&e.jsxs("span",{children:["Des:",o.aspiracao.desnudos]})]})]})}),e.jsx(O,{className:"py-2",children:g?e.jsx("div",{className:"text-slate-400 italic text-[10px]",children:"‚Ü≥"}):e.jsx("span",{className:"font-medium text-green-700",children:((de=o.aspiracao)==null?void 0:de.viaveis)??"-"})}),e.jsxs(O,{className:"py-2",children:[e.jsx("div",{className:"font-medium",children:((ce=o.dose_semen)==null?void 0:ce.nome)||"-"}),e.jsxs("div",{className:"text-[10px] text-slate-500 space-x-1",children:[((ge=o.dose_semen)==null?void 0:ge.raca)&&e.jsx("span",{children:o.dose_semen.raca}),((xe=o.dose_semen)==null?void 0:xe.tipo_semen)&&e.jsxs("span",{children:["‚Ä¢ ",o.dose_semen.tipo_semen]})]}),((le=o.dose_semen)==null?void 0:le.cliente)&&e.jsx("div",{className:"text-[10px] text-slate-500",children:o.dose_semen.cliente})]}),e.jsx(O,{className:"py-2 text-center",children:e.jsx("span",{className:"font-medium",children:o.quantidade_fracionada})}),e.jsxs(O,{className:"py-2 text-center",children:[e.jsx("span",{className:"font-medium text-blue-700",children:o.quantidade_embrioes??"-"}),o.quantidade_oocitos!==void 0&&e.jsxs("div",{className:"text-[10px] text-slate-500",children:["Usados: ",o.quantidade_oocitos]})]}),e.jsx(O,{className:"py-2 text-center",children:d&&d.total>0?e.jsx("span",{className:"font-semibold",children:d.total}):e.jsx("span",{className:"text-slate-400",children:"-"})}),e.jsx(O,{className:"py-2 text-center",children:D>0?e.jsx("span",{className:"text-green-700 font-medium",children:D}):e.jsx("span",{className:"text-slate-400",children:"-"})}),e.jsx(O,{className:"py-2 text-center",children:se>0?e.jsx("span",{className:"text-blue-700 font-medium",children:se}):e.jsx("span",{className:"text-slate-400",children:"-"})}),e.jsx(O,{className:"py-2 text-center",children:H>0?e.jsx("span",{className:"text-red-700 font-medium",children:H}):e.jsx("span",{className:"text-slate-400",children:"-"})}),e.jsx(O,{className:"py-2 text-center",children:_e>0?e.jsx("span",{className:"text-slate-600 font-medium",children:_e}):e.jsx("span",{className:"text-slate-400",children:"-"})}),e.jsx(O,{className:"py-2 text-[11px] text-slate-700",children:d&&u!=="-"?e.jsxs("div",{className:"flex flex-wrap gap-1",children:[u.split(", ").map((X,f)=>e.jsx(Te,{variant:"outline",className:"text-[10px] px-1 py-0 border-slate-300",children:X},f)),d.porClassificacao.sem_classificacao&&e.jsxs(Te,{variant:"outline",className:"text-[10px] px-1 py-0 border-slate-300 text-slate-500",children:["Sem class.(",d.porClassificacao.sem_classificacao,")"]})]}):e.jsx("span",{className:"text-slate-400",children:"-"})})]},o.id)})})]})})]}),a.acasalamentos.some(o=>o.observacoes)&&e.jsxs("div",{className:"bg-amber-50 p-2 rounded border border-amber-200 text-xs",children:[e.jsx("div",{className:"font-semibold mb-1 text-amber-900",children:"Observa√ß√µes dos Acasalamentos:"}),a.acasalamentos.filter(o=>o.observacoes).map((o,R)=>{var d;return e.jsxs("div",{className:"mb-1",children:[e.jsxs("span",{className:"font-medium",children:["#",R+1," (",((d=o.doadora)==null?void 0:d.registro)||"N/A","):"]})," ",o.observacoes]},o.id)})]})]}):e.jsx("div",{className:"mt-4 pt-4 border-t border-slate-200 text-center text-slate-500 py-4 text-sm",children:"Erro ao carregar detalhes"})}function Hs(){const{id:a}=Ua(),$=Ca(),{toast:o}=xa(),[R,d]=r.useState(!1),[D,se]=r.useState({}),H=Ba({lotes:[],pacotesParaFiltro:[],fazendasAspiracaoUnicas:[],lotesHistoricos:[]}),{lotes:_e,pacotes:u,fazendas:W,doadoras:g,clientes:ie,loading:re,selectedLote:T,setSelectedLote:ne,showLoteDetail:V,setShowLoteDetail:de,acasalamentos:ce,fazendasDestinoIds:ge,historicoDespachos:xe,setHistoricoDespachos:le,aspiracoesDisponiveis:X,dosesDisponiveis:f,fazendaOrigemNome:v,fazendasDestinoNomes:N,dosesDisponiveisNoLote:L,dataAspiracao:B,pacotesParaFiltro:ve,fazendasAspiracaoUnicas:U,lotesHistoricos:me,loadingHistorico:w,loteExpandido:Q,detalhesLoteExpandido:he,loadingDetalhes:Ae,loadLoteDetail:ze,loadLotesHistoricos:we,handleExpandirLote:i}=rs({id:a,filtroHistoricoDataInicio:H.filtroHistoricoDataInicio,filtroHistoricoDataFim:H.filtroHistoricoDataFim,filtroHistoricoFazenda:H.filtroHistoricoFazenda,setHistoricoPage:H.setHistoricoPage}),{filtroFazendaAspiracao:A,setFiltroFazendaAspiracao:te,filtroFazendaAspiracaoBusca:Fe,setFiltroFazendaAspiracaoBusca:De,filtroDiaCultivo:Ke,setFiltroDiaCultivo:ha,showFazendaBusca:Me,setShowFazendaBusca:Be,fazendasFiltradas:He,lotesFiltrados:Pe,limparFiltrosAtivos:Re,filtroHistoricoDataInicio:We,setFiltroHistoricoDataInicio:fa,filtroHistoricoDataFim:ea,setFiltroHistoricoDataFim:ua,filtroHistoricoFazenda:aa,setFiltroHistoricoFazenda:sa,filtroHistoricoFazendaBusca:Ve,setFiltroHistoricoFazendaBusca:_a,showFazendaBuscaHistorico:ta,setShowFazendaBuscaHistorico:va,abaAtiva:Ue,setAbaAtiva:b,historicoPage:y,setHistoricoPage:G,HISTORICO_PAGE_SIZE:C}=Ba({lotes:_e,pacotesParaFiltro:ve,fazendasAspiracaoUnicas:U,lotesHistoricos:me}),Se=async()=>{var t,j;if(T)try{d(!0);const h=u.find(p=>p.id===T.pacote_aspiracao_id);let x=ke((h==null?void 0:h.data_aspiracao)||null);if(!x){const p=ke(T.data_abertura);if(p){const[F,ae,pe]=p.split("-").map(Number),fe=new Date(F,ae-1,pe);fe.setDate(fe.getDate()-1);const s=fe.getFullYear(),E=String(fe.getMonth()+1).padStart(2,"0"),P=String(fe.getDate()).padStart(2,"0");x=`${s}-${E}-${P}`}}const Z=za();if((x?Math.max(0,Fa(Z,x)):0)>9){o({title:"Prazo expirado",description:"D8 √© o √∫ltimo dia. N√£o √© poss√≠vel criar embri√µes ap√≥s o D8. O lote ser√° fechado e n√£o aparecer√° mais na lista.",variant:"destructive"}),d(!1);return}const J=ce.filter(p=>{var ae;return parseInt(D[p.id]||((ae=p.quantidade_embrioes)==null?void 0:ae.toString())||"0")>0});if(J.length===0){o({title:"Nenhum embri√£o para despachar",description:"Preencha a quantidade de embri√µes em pelo menos um acasalamento antes de despachar.",variant:"destructive"});return}for(const p of J){const F=parseInt(D[p.id]||((t=p.quantidade_embrioes)==null?void 0:t.toString())||"0"),ae=p.quantidade_oocitos??0;if(F>ae){const pe=p.doadora_nome||p.doadora_registro||"Doadora desconhecida";o({title:"Valida√ß√£o de quantidade",description:`O acasalamento da doadora "${pe}" possui ${F} embri√µes, mas apenas ${ae} o√≥citos foram usados. A quantidade de embri√µes n√£o pode exceder a quantidade de o√≥citos dispon√≠veis.`,variant:"destructive"});return}}const m=`${v} - ${N.join(", ")}`,S=new Date().toISOString().split("T")[0];if(!ge.length){o({title:"Erro ao despachar",description:"√â necess√°rio ter pelo menos uma fazenda destino configurada no lote.",variant:"destructive"});return}let q="",M="";if(h!=null&&h.fazenda_id){const{data:p,error:F}=await c.from("fazendas").select("sigla").eq("id",h.fazenda_id).single();if(!F&&(p!=null&&p.sigla)){q=p.sigla;const ae=x||"",pe=ae.slice(8,10)+ae.slice(5,7);M=`${q}-${pe}`}}let oe=1;if(M){const{count:p,error:F}=await c.from("embrioes").select("*",{count:"exact",head:!0}).like("identificacao",`${M}-%`);!F&&p!==null&&(oe=p+1)}const ee=[],Ne=[];let _=0;for(const p of J){const F=parseInt(D[p.id]||((j=p.quantidade_embrioes)==null?void 0:j.toString())||"0");if(F>0){for(let ae=0;ae<F;ae++){const pe={lote_fiv_id:T.id,lote_fiv_acasalamento_id:p.id,status_atual:"FRESCO"};if(M){const fe=String(oe+_).padStart(3,"0");pe.identificacao=`${M}-${fe}`}ee.push(pe),_++}Ne.push({acasalamento_id:p.id,quantidade:F,doadora:p.doadora_registro||p.doadora_nome,dose:p.dose_nome})}}if(ee.length>0){const{error:p}=await c.from("embrioes").insert(ee);if(p)throw p}const n={id:`${T.id}-${S}`,data_despacho:S,acasalamentos:Ne};le([n,...xe]);const z=J.map(p=>c.from("lote_fiv_acasalamentos").update({quantidade_embrioes:null}).eq("id",p.id));await Promise.all(z),se({}),o({title:"Embri√µes despachados",description:`${ee.length} embri√£o(√µes) foram despachados para ${m}.`}),ze(T.id)}catch(h){o({title:"Erro ao despachar embri√µes",description:h instanceof Error?h.message:"Erro desconhecido",variant:"destructive"})}finally{d(!1)}},Ee=async t=>{if(!T)return;const j=parseFloat(t.quantidade_fracionada)||0;try{d(!0);const h=X.find(ee=>ee.id===t.aspiracao_doadora_id),x=(h==null?void 0:h.oocitos_disponiveis)??0,Z=parseInt(t.quantidade_oocitos)||0;if(Z>x)throw o({title:"Erro de valida√ß√£o",description:`A quantidade de o√≥citos (${Z}) n√£o pode ser maior que os o√≥citos dispon√≠veis (${x})`,variant:"destructive"}),new Error("Valida√ß√£o falhou");const{data:Y,error:J}=await c.from("doses_semen").select("id, quantidade").eq("id",t.dose_semen_id).single();if(J)throw J;const m=(Y==null?void 0:Y.quantidade)??0;if(m<j)throw o({title:"Estoque insuficiente",description:`Quantidade dispon√≠vel (${m}) √© menor que a quantidade fracionada (${j}).`,variant:"destructive"}),new Error("Estoque insuficiente");const S={lote_fiv_id:T.id,aspiracao_doadora_id:t.aspiracao_doadora_id,dose_semen_id:t.dose_semen_id,quantidade_fracionada:j,quantidade_oocitos:Z>0?Z:null,observacoes:t.observacoes||null},{error:q}=await c.from("lote_fiv_acasalamentos").insert([S]);if(q)throw q;const M=m-j,{error:oe}=await c.from("doses_semen").update({quantidade:M}).eq("id",(Y==null?void 0:Y.id)||"");if(oe)throw oe;o({title:"Acasalamento adicionado",description:"Acasalamento adicionado com sucesso"}),await ze(T.id)}catch(h){const x=h instanceof Error?h.message:"Erro desconhecido";throw!x.includes("Valida√ß√£o")&&!x.includes("Estoque")&&o({title:"Erro ao adicionar acasalamento",description:x.includes("RLS")||x.includes("policy")?"RLS est√° bloqueando escrita. Configure pol√≠ticas anon no Supabase.":x,variant:"destructive"}),h}finally{d(!1)}};return re&&!T?e.jsx(qa,{}):T&&V?e.jsx(ds,{lote:T,acasalamentos:ce,aspiracoesDisponiveis:X,dosesDisponiveis:f,dosesDisponiveisNoLote:L,doadoras:g,clientes:ie,historicoDespachos:xe,dataAspiracao:B,fazendaOrigemNome:v,fazendasDestinoNomes:N,submitting:R,onBack:()=>{de(!1),ne(null)},onAddAcasalamento:Ee,onDespacharEmbrioes:Se,onUpdateQuantidadeEmbrioes:(t,j)=>{se({...D,[t]:j})},editQuantidadeEmbrioes:D}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(Xa,{title:"Lotes FIV",description:"Gerenciar lotes de fecunda√ß√£o in vitro",actions:e.jsx(ns,{pacotes:u,clientes:ie,fazendas:W})}),e.jsxs(Ze,{children:[e.jsx(Xe,{children:e.jsx(Ge,{children:"Lista de Lotes FIV"})}),e.jsx(Ye,{children:e.jsxs(Ga,{value:Ue,onValueChange:t=>b(t),children:[e.jsxs(Ya,{className:"mb-6",children:[e.jsx(La,{value:"ativos",children:"Lotes Ativos"}),e.jsx(La,{value:"historico",children:"Hist√≥rico"})]}),e.jsxs(Ia,{value:"ativos",className:"mt-0",children:[e.jsxs("div",{className:"flex gap-4 mb-6 flex-wrap",children:[e.jsxs("div",{className:"flex-1 min-w-[250px] relative fazenda-busca-container",children:[e.jsx(je,{htmlFor:"filtro-fazenda-aspira√ß√£o",children:"Filtrar por Fazenda da Aspira√ß√£o"}),e.jsxs("div",{className:"relative",children:[e.jsx(Je,{id:"filtro-fazenda-aspira√ß√£o",placeholder:"Digite para buscar fazenda...",value:Fe,onChange:t=>{De(t.target.value),Be(!0),t.target.value||te("")},onFocus:()=>Be(!0)}),A&&e.jsx(ue,{variant:"ghost",size:"sm",className:"absolute right-1 top-1 h-7 w-7 p-0",onClick:()=>{te(""),De(""),Be(!1)},children:e.jsx(ka,{className:"h-4 w-4"})}),Me&&He.length>0&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-white border rounded-md shadow-lg max-h-60 overflow-auto",children:He.map(t=>e.jsx("div",{className:"px-4 py-2 hover:bg-slate-100 cursor-pointer",onClick:()=>{te(t.id),De(t.nome),Be(!1)},children:t.nome},t.id))}),Me&&Fe&&He.length===0&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-white border rounded-md shadow-lg p-4 text-sm text-slate-500",children:"Nenhuma fazenda encontrada"})]})]}),e.jsxs("div",{className:"flex-1 min-w-[200px]",children:[e.jsx(je,{htmlFor:"filtro-dia-cultivo",children:"Filtrar por Dia do Cultivo"}),e.jsxs(da,{value:Ke||void 0,onValueChange:t=>ha(t||""),children:[e.jsx(ca,{id:"filtro-dia-cultivo",children:e.jsx(la,{placeholder:"Todos os dias"})}),e.jsx(ma,{children:[0,1,2,3,4,5,6,7,8].map(t=>e.jsxs(pa,{value:t.toString(),children:["D",t," - ",ba(t)]},t))})]})]}),(A||Ke)&&e.jsx("div",{className:"flex items-end",children:e.jsx(ue,{variant:"outline",onClick:Re,children:"Limpar Filtros"})})]}),Pe.length===0?e.jsx(Ma,{title:_e.length===0?"Nenhum lote cadastrado":"Nenhum lote encontrado",description:_e.length===0?"Crie um novo lote para come√ßar.":"Ajuste os filtros para encontrar outros lotes."}):e.jsxs(ia,{children:[e.jsx(ra,{children:e.jsxs(Oe,{children:[e.jsx(I,{children:"Aspira√ß√£o"}),e.jsx(I,{children:"Fazendas Destino"}),e.jsx(I,{children:"Dia do Cultivo"}),e.jsx(I,{children:"Acasalamentos"}),e.jsx(I,{className:"text-right",children:"A√ß√µes"})]})}),e.jsx(na,{children:Pe.map(t=>e.jsxs(Oe,{children:[e.jsxs(O,{children:[t.pacote_data&&Le(t.pacote_data)," - ",t.pacote_nome]}),e.jsx(O,{children:e.jsx("div",{className:"flex flex-wrap gap-1",children:t.fazendas_destino_nomes&&t.fazendas_destino_nomes.length>0?t.fazendas_destino_nomes.map((j,h)=>e.jsx(Te,{variant:"outline",className:"text-xs",children:j},h)):e.jsx("span",{className:"text-slate-400",children:"-"})})}),e.jsx(O,{children:t.dia_atual!==void 0?e.jsx(Te,{variant:"outline",className:`font-semibold ${ss(t.dia_atual===0?-1:t.dia_atual>9?8:t.dia_atual-1)}`,children:(()=>{const j=t.dia_atual===0?-1:t.dia_atual>9?8:t.dia_atual-1;return j===-1?`D-1 - ${ba(j)}`:`D${j} - ${ba(j)}`})()}):e.jsx("span",{className:"text-slate-400",children:"-"})}),e.jsx(O,{children:t.quantidade_acasalamentos??0}),e.jsx(O,{className:"text-right",children:e.jsx(ue,{variant:"ghost",size:"sm",onClick:()=>$(`/lotes-fiv/${t.id}`),children:e.jsx(as,{className:"w-4 h-4"})})})]},t.id))})]})]}),e.jsx(Ia,{value:"historico",className:"mt-0",children:e.jsx(cs,{lotesHistoricos:me,fazendas:W,detalhesLoteExpandido:he,loteExpandido:Q,loadingHistorico:w,loadingDetalhes:Ae,filtroHistoricoDataInicio:We,setFiltroHistoricoDataInicio:fa,filtroHistoricoDataFim:ea,setFiltroHistoricoDataFim:ua,filtroHistoricoFazenda:aa,setFiltroHistoricoFazenda:sa,filtroHistoricoFazendaBusca:Ve,setFiltroHistoricoFazendaBusca:_a,showFazendaBuscaHistorico:ta,setShowFazendaBuscaHistorico:va,historicoPage:y,setHistoricoPage:G,HISTORICO_PAGE_SIZE:C,onLoadHistorico:we,onExpandirLote:i})})]})})]})]})}export{Hs as default};
