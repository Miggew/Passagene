import{a as V,a7 as H,r as i,s as w,j as e,i as X,B as j}from"./index-BPMeM9-O.js";import{C as B,d as T,a as K,b as Z,c as J}from"./card-8azKTSNJ.js";import{B as Q}from"./badge-CeJDYfYs.js";import{I as U}from"./input-tqcTRdPv.js";import{E as W}from"./EmptyState-yqSFIU3C.js";import{C as E,D as Y}from"./index-BkgnAyi6.js";import{R as ee,g as ae,a as se}from"./ResultBadge-D1BY0IWw.js";import{u as te}from"./use-toast-BGNwDi9e.js";import{A as re}from"./arrow-left-CjWJp082.js";import{S as oe}from"./search-SyV5imYB.js";function fe(){const k=V(),[N]=H(),{toast:M}=te(),u=N.get("fazenda")||"",g=N.get("data_te")||"",f=N.get("data_sexagem")||"",h=N.get("vet")||"",[F,z]=i.useState(!0),[m,P]=i.useState(null),[b,A]=i.useState([]),[S,I]=i.useState(""),[n,y]=i.useState(1),v=20;i.useEffect(()=>{if(!u||!g||!f){M({title:"Parâmetros inválidos",description:"Faltam parâmetros para identificar a sessão",variant:"destructive"}),k("/sexagem");return}L()},[u,g,f,h]);const L=async()=>{try{z(!0);let a=w.from("diagnosticos_gestacao").select("*").eq("tipo_diagnostico","SEXAGEM").eq("data_te",g).eq("data_diagnostico",f);h&&(a=a.eq("veterinario_responsavel",h));const{data:r,error:s}=await a;if(s)throw s;if(!r||r.length===0){A([]),P({fazenda_nome:u,data_te:g,data_sexagem:f,veterinario_responsavel:h||void 0}),z(!1);return}const x=[...new Set(r.map(t=>t.receptora_id))],{data:l,error:D}=await w.from("receptoras").select("id, identificacao, nome, data_provavel_parto").in("id",x);if(D)throw D;const q=new Map((l||[]).map(t=>[t.id,t])),{data:G}=await w.from("vw_receptoras_fazenda_atual").select("receptora_id, fazenda_nome_atual").in("receptora_id",x),$=new Map((G||[]).map(t=>[t.receptora_id,t.fazenda_nome_atual])),O=r.filter(t=>$.get(t.receptora_id)===u).map(t=>{const o=q.get(t.receptora_id);return{id:t.id,receptora_id:t.receptora_id,receptora_brinco:(o==null?void 0:o.identificacao)||"-",receptora_nome:o==null?void 0:o.nome,data_te:t.data_te,data_diagnostico:t.data_diagnostico,resultado:t.resultado,sexagem:t.sexagem,numero_gestacoes:t.numero_gestacoes,observacoes:t.observacoes,data_provavel_parto:(o==null?void 0:o.data_provavel_parto)||void 0}}).sort((t,o)=>t.receptora_brinco.localeCompare(o.receptora_brinco));A(O);const p=r[0];P({fazenda_nome:u,data_te:g,data_sexagem:f,veterinario_responsavel:(p==null?void 0:p.veterinario_responsavel)||h||void 0,tecnico_responsavel:p==null?void 0:p.tecnico_responsavel})}catch(a){console.error("Erro ao carregar sessão:",a),M({title:"Erro ao carregar dados",description:a instanceof Error?a.message:"Erro desconhecido",variant:"destructive"})}finally{z(!1)}},c=i.useMemo(()=>{if(!S.trim())return b;const a=S.toLowerCase();return b.filter(r=>{var s;return r.receptora_brinco.toLowerCase().includes(a)||((s=r.receptora_nome)==null?void 0:s.toLowerCase().includes(a))})},[b,S]),d=Math.ceil(c.length/v),R=c.slice((n-1)*v,n*v),C=i.useMemo(()=>{const a=c.length,r=c.filter(l=>l.sexagem==="FEMEA").length,s=c.filter(l=>l.sexagem==="MACHO").length,x=c.filter(l=>l.resultado==="VAZIA").length;return{total:a,femeas:r,machos:s,vazias:x}},[c]),_=a=>{if(!a)return"-";const[r,s,x]=a.split("-");return`${x}/${s}/${r}`};return F?e.jsx(X,{}):m?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(j,{variant:"ghost",size:"sm",onClick:()=>k(-1),children:e.jsx(re,{className:"w-4 h-4"})}),e.jsx("h1",{className:"text-xl font-semibold text-foreground",children:"Sessão de Sexagem"})]}),e.jsx(B,{children:e.jsxs(T,{className:"pt-4 pb-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-xs font-medium text-muted-foreground",children:"Fazenda"}),e.jsx("p",{className:"text-base font-semibold text-foreground",children:m.fazenda_nome})]}),e.jsx("div",{className:"h-8 w-px bg-border"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xs font-medium text-muted-foreground",children:"Data TE"}),e.jsx("p",{className:"text-sm text-foreground",children:_(m.data_te)})]}),e.jsx("div",{className:"h-8 w-px bg-border"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xs font-medium text-muted-foreground",children:"Data Sexagem"}),e.jsx("p",{className:"text-sm text-foreground",children:_(m.data_sexagem)})]}),e.jsx("div",{className:"h-8 w-px bg-border"}),e.jsx(Q,{variant:"default",className:"bg-primary hover:bg-primary-dark",children:"Realizada"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Total:"}),e.jsx(E,{value:C.total,variant:"default"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Fêmeas:"}),e.jsx(E,{value:C.femeas,variant:"pink"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Machos:"}),e.jsx(E,{value:C.machos,variant:"blue"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Perda:"}),e.jsx(E,{value:C.vazias,variant:"danger"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4 pt-3 border-t border-border",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h4",{className:"text-[10px] font-semibold text-muted-foreground uppercase tracking-wide",children:"Veterinário"}),e.jsx("p",{className:"text-xs text-foreground",children:m.veterinario_responsavel||"—"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("h4",{className:"text-[10px] font-semibold text-muted-foreground uppercase tracking-wide",children:"Técnico"}),e.jsx("p",{className:"text-xs text-foreground",children:m.tecnico_responsavel||"—"})]})]})]})}),e.jsxs(B,{children:[e.jsx(K,{className:"pb-2 pt-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(Z,{className:"text-base",children:["Receptoras (",c.length,")"]}),e.jsx(J,{children:"Lista de todas as receptoras sexadas na sessão"})]}),e.jsxs("div",{className:"relative w-64",children:[e.jsx(oe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(U,{placeholder:"Buscar brinco ou nome...",value:S,onChange:a=>{I(a.target.value),y(1)},className:"pl-9 h-9"})]})]})}),e.jsx(T,{className:"pt-0 pb-2",children:c.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:b.length===0?"Nenhuma receptora encontrada nesta sessão":"Nenhuma receptora corresponde à busca"}):e.jsxs(e.Fragment,{children:[e.jsx(Y,{data:R,rowKey:"id",rowNumber:!0,emptyMessage:"Nenhuma receptora encontrada",columns:[{key:"receptora_brinco",label:"Receptora"},{key:"data_te",label:"Data TE",align:"center"},{key:"data_diagnostico",label:"Data Sexagem",align:"center"},{key:"data_provavel_parto",label:"Data Parto",align:"center"},{key:"sexagem",label:"Sexagem",align:"center"},{key:"numero_gestacoes",label:"Nº Gest.",align:"center"},{key:"observacoes",label:"Observações"}],renderCell:(a,r)=>{var s;switch(r.key){case"receptora_brinco":return e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-sm text-foreground",children:a.receptora_brinco}),a.receptora_nome&&e.jsx("span",{className:"text-[10px] text-muted-foreground block",children:a.receptora_nome})]});case"data_te":return e.jsx("span",{className:"text-muted-foreground",children:_(a.data_te)});case"data_diagnostico":return e.jsx("span",{className:"text-foreground",children:_(a.data_diagnostico)});case"data_provavel_parto":return e.jsx("span",{className:"text-muted-foreground",children:a.data_provavel_parto?_(a.data_provavel_parto):"—"});case"sexagem":return e.jsx(ee,{result:se(a.sexagem,a.resultado),label:ae(a.sexagem,a.resultado)});case"numero_gestacoes":return e.jsx("span",{className:"text-muted-foreground",children:a.numero_gestacoes||"—"});case"observacoes":return e.jsx("span",{className:"text-muted-foreground truncate",children:((s=a.observacoes)==null?void 0:s.replace(/SEXAGENS:[^|]+\|?/,"").trim())||"—"});default:return null}}}),d>1&&e.jsxs("div",{className:"flex items-center justify-between mt-4 pt-4 border-t border-border",children:[e.jsxs("span",{className:"text-sm text-muted-foreground",children:["Mostrando ",(n-1)*v+1," a ",Math.min(n*v,c.length)," de ",c.length]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(j,{variant:"outline",size:"sm",onClick:()=>y(a=>Math.max(1,a-1)),disabled:n===1,children:"Anterior"}),e.jsx("div",{className:"flex items-center gap-1",children:Array.from({length:Math.min(5,d)},(a,r)=>{let s;return d<=5||n<=3?s=r+1:n>=d-2?s=d-4+r:s=n-2+r,e.jsx(j,{variant:n===s?"default":"outline",size:"sm",className:`w-9 h-9 p-0 ${n===s?"bg-primary hover:bg-primary-dark":""}`,onClick:()=>y(s),children:s},s)})}),e.jsx(j,{variant:"outline",size:"sm",onClick:()=>y(a=>Math.min(d,a+1)),disabled:n===d,children:"Próximo"})]})]})]})})]})]}):e.jsx(W,{title:"Sessão não encontrada",description:"Não foi possível carregar os dados da sessão.",action:e.jsx(j,{onClick:()=>k("/sexagem"),variant:"outline",children:"Voltar para Sexagem"})})}export{fe as default};
