import{c as ba,r as f,s as c,j as e,a as Xe,B as z}from"./index-DmNymSE5.js";import{C as Te,a as Ae,b as Oe,d as Be}from"./card-SrkIpKk5.js";import{T as Ge,a as We,b as se,c as L,d as Qe,e as B}from"./table-BEqiB4gi.js";import{D as ue,a as Sa,b as pe,c as he,d as xe,e as ve,f as Da}from"./dialog-j4QKUGZf.js";import{S as ge,a as _e,b as je,c as Ne,d as Q}from"./select-yD1hylSL.js";import{I as ne}from"./input-CUsCheD8.js";import{L as F}from"./label-u6KawL_e.js";import{T as ya}from"./textarea-BuM8ilf-.js";import{S as Ca}from"./StatusBadge-UrqKsWCC.js";import{P as za}from"./PageHeader-C6hPTib0.js";import{E as Ra}from"./EmptyState-8CewmVht.js";import{h as Ke}from"./error-handler-CVxXqVfW.js";import{u as Ma}from"./use-toast-8Wh80yTN.js";import Ia from"./ReceptoraHistorico-CCvU4_FF.js";import{f as Fa}from"./statusLabels-IklKT8dE.js";import{m as ea,a as aa,D as Ta,f as Aa,p as Oa}from"./DatePickerBR-DL95UOFW.js";import{S as Ba}from"./search-52vUzEUy.js";import{P as $a}from"./plus-BZvL1qCK.js";import{B as Ha}from"./baby-DVqUDv16.js";import{S as ka}from"./square-pen-D0yg8shX.js";import{H as Pa}from"./history-Ijd8nAqu.js";import"./index-BMCBZPUE.js";import"./index-C79PyqkA.js";import"./x-BKw_NAIH.js";import"./index-BoubMqWY.js";import"./index-BMurdLVa.js";import"./check-D6LfuFSM.js";import"./badge-BB9l9AxT.js";import"./sheet-DWUaBWrd.js";import"./calendar-u0e6cTgk.js";import"./user-plus-wGsTTIAJ.js";import"./popover-BabFSUJ1.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qa=ba("ArrowRight",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]]);function Ua(i,t){const o=Ja(i);let v;if(o.date){const w=Ya(o.date,2);v=Xa(w.restDateString,w.year)}if(!v||isNaN(v.getTime()))return new Date(NaN);const R=v.getTime();let N=0,V;if(o.time&&(N=Ga(o.time),isNaN(N)))return new Date(NaN);if(o.timezone){if(V=Wa(o.timezone),isNaN(V))return new Date(NaN)}else{const w=new Date(R+N),Z=new Date(0);return Z.setFullYear(w.getUTCFullYear(),w.getUTCMonth(),w.getUTCDate()),Z.setHours(w.getUTCHours(),w.getUTCMinutes(),w.getUTCSeconds(),w.getUTCMilliseconds()),Z}return new Date(R+N+V)}const we={dateTimeDelimiter:/[T ]/,timeZoneDelimiter:/[Z ]/i,timezone:/([Z+-].*)$/},La=/^-?(?:(\d{3})|(\d{2})(?:-?(\d{2}))?|W(\d{2})(?:-?(\d{1}))?|)$/,Va=/^(\d{2}(?:[.,]\d*)?)(?::?(\d{2}(?:[.,]\d*)?))?(?::?(\d{2}(?:[.,]\d*)?))?$/,Za=/^([+-])(\d{2})(?::?(\d{2}))?$/;function Ja(i){const t={},s=i.split(we.dateTimeDelimiter);let o;if(s.length>2)return t;if(/:/.test(s[0])?o=s[0]:(t.date=s[0],o=s[1],we.timeZoneDelimiter.test(t.date)&&(t.date=i.split(we.timeZoneDelimiter)[0],o=i.substr(t.date.length,i.length))),o){const v=we.timezone.exec(o);v?(t.time=o.replace(v[1],""),t.timezone=v[1]):t.time=o}return t}function Ya(i,t){const s=new RegExp("^(?:(\\d{4}|[+-]\\d{"+(4+t)+"})|(\\d{2}|[+-]\\d{"+(2+t)+"})$)"),o=i.match(s);if(!o)return{year:NaN,restDateString:""};const v=o[1]?parseInt(o[1]):null,R=o[2]?parseInt(o[2]):null;return{year:R===null?v:R*100,restDateString:i.slice((o[1]||o[2]).length)}}function Xa(i,t){if(t===null)return new Date(NaN);const s=i.match(La);if(!s)return new Date(NaN);const o=!!s[4],v=ce(s[1]),R=ce(s[2])-1,N=ce(s[3]),V=ce(s[4]),w=ce(s[5])-1;if(o)return tt(t,V,w)?Qa(t,V,w):new Date(NaN);{const Z=new Date(0);return!et(t,R,N)||!at(t,v)?new Date(NaN):(Z.setUTCFullYear(t,R,Math.max(v,N)),Z)}}function ce(i){return i?parseInt(i):1}function Ga(i){const t=i.match(Va);if(!t)return NaN;const s=$e(t[1]),o=$e(t[2]),v=$e(t[3]);return rt(s,o,v)?s*ea+o*aa+v*1e3:NaN}function $e(i){return i&&parseFloat(i.replace(",","."))||0}function Wa(i){if(i==="Z")return 0;const t=i.match(Za);if(!t)return 0;const s=t[1]==="+"?-1:1,o=parseInt(t[2]),v=t[3]&&parseInt(t[3])||0;return ot(o,v)?s*(o*ea+v*aa):NaN}function Qa(i,t,s){const o=new Date(0);o.setUTCFullYear(i,0,4);const v=o.getUTCDay()||7,R=(t-1)*7+s+1-v;return o.setUTCDate(o.getUTCDate()+R),o}const Ka=[31,null,31,30,31,30,31,31,30,31,30,31];function ta(i){return i%400===0||i%4===0&&i%100!==0}function et(i,t,s){return t>=0&&t<=11&&s>=1&&s<=(Ka[t]||(ta(i)?29:28))}function at(i,t){return t>=1&&t<=(ta(i)?366:365)}function tt(i,t,s){return t>=1&&t<=53&&s>=0&&s<=6}function rt(i,t,s){return i===24?t===0&&s===0:s>=0&&s<60&&t>=0&&t<60&&i>=0&&i<25}function ot(i,t){return t>=0&&t<=59}function Bt(){const[i,t]=f.useState([]),[s,o]=f.useState([]),[v,R]=f.useState([]),[N,V]=f.useState(""),[w,Z]=f.useState(""),[de,He]=f.useState("all"),[ra,ke]=f.useState([]),[oa,Pe]=f.useState(!0),[ia,qe]=f.useState(!1),[sa,Ee]=f.useState(!1),[na,te]=f.useState(!1),[ca,le]=f.useState(!1),[da,Ue]=f.useState(!1),[Le,la]=f.useState(""),[ma,me]=f.useState(!1),[be,Ve]=f.useState(!1),[re,Se]=f.useState([]),[M,K]=f.useState({receptora_id:"",data_nascimento:new Date().toISOString().split("T")[0],sexo:"",observacoes:""}),[J,ee]=f.useState(!1),[De,fe]=f.useState(!1),[d,ye]=f.useState(null),[$,Ce]=f.useState(""),[A,H]=f.useState(""),[oe,k]=f.useState(!1),[ze,Y]=f.useState(!1),{toast:g}=Ma(),Ze=new Date().toISOString().split("T")[0],[S,Re]=f.useState({identificacao:"",nome:""}),[X,Me]=f.useState({identificacao:"",nome:""});f.useEffect(()=>{pa()},[]),f.useEffect(()=>{N?ae():(t([]),o([]))},[N]),f.useEffect(()=>{fa()},[w,de,i]);const fa=()=>{let a=i;if(de!=="all"&&(a=a.filter(r=>r.status_calculado===de)),w.trim()){const r=w.toLowerCase();a=a.filter(n=>{var l;return n.identificacao.toLowerCase().includes(r)||((l=n.nome)==null?void 0:l.toLowerCase().includes(r))})}o(a)},ua=a=>{if(!a)return"";try{const r=Ua(a);return Number.isNaN(r.getTime())?"":Aa(r,"dd/MM/yyyy",{locale:Oa})}catch{return""}},pa=async()=>{try{Pe(!0);const{data:a,error:r}=await c.from("fazendas").select("id, nome, cliente_id").order("nome",{ascending:!0});if(r)throw r;R(a||[])}catch(a){Ke(a,"Erro ao carregar fazendas")}finally{Pe(!1)}},ae=async()=>{try{qe(!0);const{data:a,error:r}=await c.from("vw_receptoras_fazenda_atual").select("receptora_id, fazenda_nome_atual").eq("fazenda_id_atual",N);if(r)throw r;const n=(a==null?void 0:a.map(u=>u.receptora_id))||[];if(n.length===0){t([]),o([]),ke([]);return}const{data:l,error:b}=await c.from("receptoras").select("*").in("id",n).order("identificacao",{ascending:!0});if(b)throw b;const _=new Map((a==null?void 0:a.map(u=>[u.receptora_id,u.fazenda_nome_atual]))||[]),m=(l||[]).map(u=>({...u,fazenda_nome_atual:_.get(u.id)})).map(u=>({...u,status_calculado:u.status_reprodutivo||"VAZIA"})),h=["PRENHE","PRENHE_RETOQUE","PRENHE_FEMEA","PRENHE_MACHO","PRENHE_SEM_SEXO","PRENHE_2_SEXOS"],j=m.filter(u=>h.includes(u.status_calculado)||u.status_calculado.includes("PRENHE"));if(j.length>0){const u=j.map(q=>q.id),{data:D,error:y}=await c.from("diagnosticos_gestacao").select("receptora_id, numero_gestacoes").in("receptora_id",u).in("resultado",["PRENHE","PRENHE_FEMEA","PRENHE_MACHO","PRENHE_SEM_SEXO","PRENHE_2_SEXOS"]).not("numero_gestacoes","is",null);if(!y&&D){const q=new Map;D.forEach(C=>{if(C.numero_gestacoes&&C.numero_gestacoes>1){const O=q.get(C.receptora_id)||0;C.numero_gestacoes>O&&q.set(C.receptora_id,C.numero_gestacoes)}}),m.forEach(C=>{const O=q.get(C.id);O&&O>1&&(C.numero_gestacoes=O)})}const{data:P,error:G}=await c.from("transferencias_embrioes").select("receptora_id, embriao_id, data_te").in("receptora_id",u).eq("status_te","REALIZADA").order("data_te",{ascending:!1})}const E=Array.from(new Set(m.map(u=>u.status_calculado))).filter(u=>u).sort();ke(E),t(m),o(m),He("all")}catch(a){Ke(a,"Erro ao carregar receptoras")}finally{qe(!1)}},ha=async()=>{const a=Le;a&&(t(r=>r.filter(n=>n.id!==a)),o(r=>r.filter(n=>n.id!==a))),await ae()},xa=a=>a.includes("FEMEA")?"FEMEA":a.includes("MACHO")?"MACHO":"SEM_SEXO",va=async a=>{const{data:r,error:n}=await c.from("transferencias_embrioes").select("embriao_id, data_te").eq("receptora_id",a).eq("status_te","REALIZADA").order("data_te",{ascending:!1});if(n)throw n;if(!r||r.length===0)return[];const l=r[0].data_te,_=r.filter(x=>x.data_te===l).map(x=>x.embriao_id).filter(Boolean);if(_.length===0)return[];const{data:p}=await c.from("animais").select("embriao_id").in("embriao_id",_),m=new Set((p||[]).map(x=>x.embriao_id)),h=_.filter(x=>!m.has(x));if(h.length===0)return[];const{data:j,error:E}=await c.from("embrioes").select("id, lote_fiv_acasalamento_id").in("id",h);if(E)throw E;const u=[...new Set((j||[]).map(x=>x.lote_fiv_acasalamento_id).filter(Boolean))];let D=[],y=[],P=[],G=[];if(u.length>0){const{data:x,error:W}=await c.from("lote_fiv_acasalamentos").select("id, aspiracao_doadora_id, dose_semen_id").in("id",u);if(W)throw W;D=x||[];const ie=[...new Set(D.map(T=>T.aspiracao_doadora_id).filter(Boolean))],U=[...new Set(D.map(T=>T.dose_semen_id).filter(Boolean))];if(ie.length>0){const{data:T,error:I}=await c.from("aspiracoes_doadoras").select("id, doadora_id").in("id",ie);if(I)throw I;y=T||[];const Je=[...new Set(y.map(Fe=>Fe.doadora_id).filter(Boolean))];if(Je.length>0){const{data:Fe,error:Ye}=await c.from("doadoras").select("id, registro, raca").in("id",Je);if(Ye)throw Ye;P=Fe||[]}}if(U.length>0){const{data:T,error:I}=await c.from("doses_semen").select(`
            id,
            touro:touros(id, nome, registro, raca)
          `).in("id",U);if(I)throw I;G=T||[]}}const q=new Map(D.map(x=>[x.id,x])),C=new Map(y.map(x=>[x.id,x])),O=new Map(P.map(x=>[x.id,x])),Ie=new Map(G.map(x=>[x.id,x]));return(j||[]).map(x=>{const W=x.lote_fiv_acasalamento_id?q.get(x.lote_fiv_acasalamento_id):void 0,ie=W?C.get(W.aspiracao_doadora_id):void 0,U=ie?O.get(ie.doadora_id):void 0,T=W?Ie.get(W.dose_semen_id):void 0,I=(T==null?void 0:T.touro)??null;return{embriao_id:x.id,doadora_registro:U==null?void 0:U.registro,touro_nome:I==null?void 0:I.nome,raca:(U==null?void 0:U.raca)||(I==null?void 0:I.raca)}})},ga=async a=>{var r;try{Ve(!0),Se([]),K({receptora_id:a.id,data_nascimento:Ze,sexo:"",observacoes:""}),me(!0);const[n,l]=await Promise.all([va(a.id),c.from("diagnosticos_gestacao").select("sexagem").eq("receptora_id",a.id).eq("tipo_diagnostico","SEXAGEM").order("data_diagnostico",{ascending:!1}).limit(1).maybeSingle()]),b=((r=l==null?void 0:l.data)==null?void 0:r.sexagem)||xa(a.status_calculado);K(_=>({..._,sexo:b||""})),Se(n),n.length===0&&g({title:"Sem embriões disponíveis",description:"Nenhum embrião elegível para criar animal foi encontrado."})}catch(n){g({title:"Erro ao preparar nascimento",description:n instanceof Error?n.message:"Erro desconhecido",variant:"destructive"})}finally{Ve(!1)}},_a=async()=>{if(!N){g({title:"Fazenda não selecionada",description:"Selecione a fazenda antes de registrar o nascimento.",variant:"destructive"});return}if(!M.receptora_id){g({title:"Receptora não selecionada",description:"Selecione a receptora para registrar o nascimento.",variant:"destructive"});return}if(!M.data_nascimento){g({title:"Data de nascimento obrigatória",description:"Informe a data de nascimento.",variant:"destructive"});return}if(!M.sexo){g({title:"Sexo obrigatório",description:"Selecione o sexo da prenhez.",variant:"destructive"});return}if(re.length===0){g({title:"Sem embriões vinculados",description:"Nenhum embrião encontrado para a última transferência desta receptora.",variant:"destructive"});return}try{ee(!0);const a=v.find(m=>m.id===N),r=(a==null?void 0:a.cliente_id)||null,n=re.map(m=>({embriao_id:m.embriao_id,receptora_id:M.receptora_id,fazenda_id:N,cliente_id:r,data_nascimento:M.data_nascimento,sexo:M.sexo,raca:m.raca||null,pai_nome:m.touro_nome||null,mae_nome:m.doadora_registro||null,observacoes:M.observacoes||null})),{error:l}=await c.from("animais").insert(n);if(l)throw l;const{data:b,error:_}=await c.from("animais").select("id, data_nascimento").eq("receptora_id",M.receptora_id),{error:p}=await c.from("receptoras").update({status_reprodutivo:"VAZIA",data_provavel_parto:null}).eq("id",M.receptora_id);if(p)throw p;g({title:"Nascimento registrado",description:`${n.length} animal(is) criado(s) com sucesso.`}),me(!1),Se([]),K({receptora_id:"",data_nascimento:Ze,sexo:"",observacoes:""}),await ae()}catch(a){g({title:"Erro ao registrar nascimento",description:a instanceof Error?a.message:"Erro desconhecido",variant:"destructive"})}finally{ee(!1)}},ja=async a=>{if(a.preventDefault(),!S.identificacao.trim()){g({title:"Erro de validação",description:"Identificação (brinco) é obrigatória",variant:"destructive"});return}if(!N){g({title:"Erro de validação",description:"Selecione uma fazenda primeiro",variant:"destructive"});return}try{ee(!0);const{data:r,error:n}=await c.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",N);if(n)throw n;const l=(r==null?void 0:r.map(h=>h.receptora_id))||[];if(l.length>0){const{data:h,error:j}=await c.from("receptoras").select("id, identificacao, nome").in("id",l).ilike("identificacao",S.identificacao.trim());if(j)throw j;if(h&&h.length>0){const E=h[0].nome?`"${h[0].nome}"`:"sem nome",u=`Já existe uma receptora com o brinco "${S.identificacao.trim()}" nesta fazenda (Nome: ${E}).`;throw new Error(u)}}if(S.nome.trim()&&l.length>0){const{data:h,error:j}=await c.from("receptoras").select("id, identificacao").in("id",l).ilike("nome",S.nome.trim());if(j)throw j;if(h&&h.length>0)throw new Error(`Já existe uma receptora com o nome "${S.nome.trim()}" nesta fazenda (Brinco: ${h[0].identificacao}).`)}const b={identificacao:S.identificacao};S.nome.trim()&&(b.nome=S.nome);const{data:_,error:p}=await c.from("receptoras").insert([b]).select().single();if(p)throw p.code==="23505"?new Error("Já existe uma receptora com esse brinco nesta fazenda."):p;const{error:m}=await c.from("receptora_fazenda_historico").insert([{receptora_id:_.id,fazenda_id:N,data_inicio:new Date().toISOString().split("T")[0],data_fim:null}]);g({title:"Receptora criada",description:"Receptora criada com sucesso"}),Ee(!1),Re({identificacao:"",nome:""}),ae()}catch(r){g({title:"Erro ao criar receptora",description:r instanceof Error?r.message:"Erro desconhecido",variant:"destructive"})}finally{ee(!1)}},Na=a=>{ye(a),Me({identificacao:a.identificacao,nome:a.nome||""}),te(!0)},wa=async a=>{if(a.preventDefault(),!!d){if(!X.identificacao.trim()){g({title:"Erro de validação",description:"Identificação (brinco) é obrigatória",variant:"destructive"});return}try{ee(!0);const r=d.identificacao,n=X.identificacao.trim(),l=r!==n,b={identificacao:n,nome:X.nome.trim()||null},{error:_}=await c.from("receptoras").update(b).eq("id",d.id);if(_)throw _.code==="23505"?new Error("Já existe uma receptora com esse brinco nesta fazenda."):_;if(l)try{const{error:p}=await c.from("receptora_renomeacoes_historico").insert([{receptora_id:d.id,brinco_anterior:r,brinco_novo:n,data_renomeacao:new Date().toISOString(),motivo:"EDICAO_MANUAL",observacoes:null}])}catch{}g({title:"Receptora atualizada",description:l?`Receptora atualizada. Brinco alterado de "${r}" para "${n}".`:"Receptora atualizada com sucesso"}),te(!1),ye(null),ae()}catch(r){g({title:"Erro ao atualizar receptora",description:r instanceof Error?r.message:"Erro desconhecido",variant:"destructive"})}finally{ee(!1)}}};f.useEffect(()=>{(async()=>{if(!d||!$){k(!1),H(""),Y(!1);return}try{const{data:r,error:n}=await c.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",$);if(n)return;const l=(r==null?void 0:r.map(p=>p.receptora_id))||[];if(l.length===0){k(!1),H(""),Y(!1);return}if(d.nome&&d.nome.trim()){const{data:p,error:m}=await c.from("receptoras").select("id, nome, identificacao").in("id",l).ilike("nome",d.nome.trim());!m&&p&&p.length>0?Y(!0):Y(!1)}else Y(!1);const{data:b,error:_}=await c.from("receptoras").select("id, identificacao").in("id",l).ilike("identificacao",d.identificacao);if(_)return;if(b&&b.length>0){k(!0);const p=async(m,h=0)=>{if(h>10)throw new Error("Não foi possível gerar um brinco disponível após várias tentativas");const j=new Date,E=String(j.getDate()).padStart(2,"0"),u=String(j.getMonth()+1).padStart(2,"0"),D=h===0?`-MOV${E}${u}`:`-MOV${E}${u}-${h}`,y=`${m}${D}`,{data:P,error:G}=await c.from("receptoras").select("id, identificacao").in("id",l).ilike("identificacao",y);return G?y:P&&P.length>0?p(m,h+1):y};try{const m=await p(d.identificacao);H(m)}catch{const m=new Date,h=String(m.getDate()).padStart(2,"0"),j=String(m.getMonth()+1).padStart(2,"0"),E=`-MOV${h}${j}`;H(`${d.identificacao}${E}`)}}else k(!1),H("")}catch{k(!1),H("")}})()},[d,$]);const Ea=async()=>{if(!d||!$){g({title:"Erro de validação",description:"Selecione uma fazenda de destino",variant:"destructive"});return}if(ze&&d.nome&&d.nome.trim()){g({title:"Conflito de nome",description:`Já existe uma receptora com o nome "${d.nome.trim()}" na fazenda destino. Não é possível mover esta receptora.`,variant:"destructive"});return}try{fe(!0);const{data:a,error:r}=await c.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",$);if(!r&&a){const p=a.map(m=>m.receptora_id);if(p.length>0){const{data:m,error:h}=await c.from("receptoras").select("id, identificacao").in("id",p).ilike("identificacao",d.identificacao);if(!h&&m&&m.length>0&&(!oe||!A)){fe(!1),g({title:"Conflito de brinco",description:`Já existe uma receptora com o brinco "${d.identificacao}" na fazenda destino. Aguarde enquanto o sistema gera um novo brinco...`,variant:"destructive"}),k(!0);return}}}const n=d.identificacao;let l=n;if(oe&&A){const{data:p,error:m}=await c.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",$);if(!m&&p){const j=p.map(E=>E.receptora_id);if(j.length>0){const{data:E,error:u}=await c.from("receptoras").select("id, identificacao").in("id",j).ilike("identificacao",A);if(!u&&E&&E.length>0){let D=1,y=A;for(;D<=10;){const P=new Date,G=String(P.getDate()).padStart(2,"0"),q=String(P.getMonth()+1).padStart(2,"0"),C=`-MOV${G}${q}-${D}`;y=`${n}${C}`;const{data:O,error:Ie}=await c.from("receptoras").select("id").in("id",j).ilike("identificacao",y);if(!Ie&&(!O||O.length===0))break;D++}l=y}else l=A}else l=A}else l=A;const{error:h}=await c.from("receptoras").update({identificacao:l}).eq("id",d.id);if(h)throw new Error(`Erro ao atualizar brinco: ${h.message}`);try{const{error:j}=await c.from("receptora_renomeacoes_historico").insert([{receptora_id:d.id,brinco_anterior:n,brinco_novo:l,data_renomeacao:new Date().toISOString(),motivo:"MUDANCA_FAZENDA",observacoes:"Renomeação automática devido a conflito de brinco na fazenda destino"}])}catch{}d.identificacao=l}const{data:b,error:_}=await c.rpc("mover_receptora_fazenda",{p_receptora_id:d.id,p_nova_fazenda_id:$,p_data_mudanca:new Date().toISOString().split("T")[0],p_observacoes:null});if(_){let p="Erro ao mover receptora";_.message?p=_.message:_.details&&(p=_.details),g({title:"Erro ao mover receptora",description:p,variant:"destructive"}),fe(!1);return}g({title:"Receptora movida",description:oe?`Receptora movida com sucesso. Brinco atualizado de "${n}" para "${d.identificacao}" devido a conflito na fazenda destino.`:"Receptora movida para a nova fazenda com sucesso. Protocolos e histórico não foram afetados."}),le(!1),te(!1),ye(null),Ce(""),k(!1),H(""),Y(!1),ae()}catch(a){const r=a instanceof Error?a.message:"Erro desconhecido ao mover receptora";g({title:"Erro ao mover receptora",description:r,variant:"destructive"})}finally{fe(!1)}};return oa?e.jsx(Xe,{}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(za,{title:"Receptoras",description:"Gerenciar receptoras por fazenda"}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(Te,{children:[e.jsx(Ae,{children:e.jsx(Oe,{children:"Selecione a Fazenda *"})}),e.jsx(Be,{children:e.jsxs(ge,{value:N,onValueChange:V,children:[e.jsx(_e,{className:"w-full",children:e.jsx(je,{placeholder:"Selecione uma fazenda para listar receptoras"})}),e.jsx(Ne,{children:v.map(a=>e.jsx(Q,{value:a.id,children:a.nome},a.id))})]})})]}),N?e.jsxs(e.Fragment,{children:[e.jsxs(Te,{children:[e.jsx(Ae,{children:e.jsx(Oe,{children:"Filtros"})}),e.jsx(Be,{children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 max-w-md",children:[e.jsx(F,{htmlFor:"filtro-status",children:"Status"}),e.jsxs(ge,{value:de,onValueChange:He,children:[e.jsx(_e,{id:"filtro-status",children:e.jsx(je,{placeholder:"Todas"})}),e.jsxs(Ne,{children:[e.jsx(Q,{value:"all",children:"Todas"}),ra.map(a=>e.jsx(Q,{value:a,children:Fa(a)},a))]})]})]}),e.jsxs("div",{className:"flex-1 max-w-md",children:[e.jsx(F,{htmlFor:"busca",children:"Buscar por brinco ou nome"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ba,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4"}),e.jsx(ne,{id:"busca",placeholder:"Buscar por brinco ou nome...",value:w,onChange:a=>Z(a.target.value),className:"pl-10"})]})]})]})})]}),e.jsx("div",{className:"flex items-center justify-end",children:e.jsxs(ue,{open:sa,onOpenChange:Ee,children:[e.jsx(Sa,{asChild:!0,children:e.jsxs(z,{className:"bg-green-600 hover:bg-green-700",children:[e.jsx($a,{className:"w-4 h-4 mr-2"}),"Nova Receptora"]})}),e.jsxs(pe,{className:"max-w-md",children:[e.jsxs(he,{children:[e.jsx(xe,{children:"Criar Nova Receptora"}),e.jsx(ve,{children:"Criar receptora na fazenda selecionada"})]}),e.jsxs("form",{onSubmit:ja,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"identificacao",children:"Identificação (Brinco) *"}),e.jsx(ne,{id:"identificacao",value:S.identificacao,onChange:a=>Re({...S,identificacao:a.target.value}),placeholder:"Número do brinco",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"nome",children:"Nome"}),e.jsx(ne,{id:"nome",value:S.nome,onChange:a=>Re({...S,nome:a.target.value}),placeholder:"Nome da receptora (opcional)"})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(z,{type:"submit",className:"flex-1 bg-green-600 hover:bg-green-700",disabled:J,children:J?"Salvando...":"Salvar"}),e.jsx(z,{type:"button",variant:"outline",onClick:()=>Ee(!1),disabled:J,children:"Cancelar"})]})]})]})]})}),e.jsxs(Te,{children:[e.jsx(Ae,{children:e.jsxs(Oe,{children:["Lista de Receptoras (",s.length,")"]})}),e.jsx(Be,{children:ia?e.jsx("div",{className:"py-8",children:e.jsx(Xe,{})}):e.jsxs(Ge,{children:[e.jsx(We,{children:e.jsxs(se,{children:[e.jsx(L,{children:"Brinco"}),e.jsx(L,{children:"Nome"}),e.jsx(L,{children:"Status Atual"}),e.jsx(L,{children:"Data de parto"}),e.jsx(L,{className:"text-right",children:"Ações"})]})}),e.jsx(Qe,{children:s.length===0?e.jsx(se,{children:e.jsx(B,{colSpan:5,className:"text-center text-slate-500",children:w?"Nenhuma receptora encontrada":"Nenhuma receptora cadastrada nesta fazenda"})}):s.map(a=>e.jsxs(se,{children:[e.jsx(B,{className:"font-medium",children:a.identificacao}),e.jsx(B,{children:a.nome||"-"}),e.jsx(B,{children:e.jsx(Ca,{status:a.status_calculado,count:a.numero_gestacoes})}),e.jsx(B,{children:a.status_calculado.includes("PRENHE")&&a.data_provavel_parto?ua(a.data_provavel_parto):"—"}),e.jsx(B,{className:"text-right",children:e.jsxs("div",{className:"flex gap-1 justify-end",children:[a.status_calculado.includes("PRENHE")&&a.data_provavel_parto&&a.data_provavel_parto<=new Date(new Date().setDate(new Date().getDate()+20)).toISOString().split("T")[0]&&e.jsx(z,{variant:"ghost",size:"sm",onClick:()=>ga(a),title:"Registrar nascimento",children:e.jsx(Ha,{className:"w-4 h-4"})}),e.jsx(z,{variant:"ghost",size:"sm",onClick:()=>Na(a),title:"Editar",children:e.jsx(ka,{className:"w-4 h-4"})}),e.jsx(z,{variant:"ghost",size:"sm",onClick:()=>{la(a.id),Ue(!0)},title:"Ver histórico",children:e.jsx(Pa,{className:"w-4 h-4"})})]})})]},a.id))})]})})]})]}):e.jsx(Ra,{title:"Selecione uma fazenda",description:"Escolha uma fazenda para listar receptoras e aplicar filtros."}),e.jsx(ue,{open:ma,onOpenChange:me,children:e.jsxs(pe,{className:"max-w-2xl",children:[e.jsxs(he,{children:[e.jsx(xe,{children:"Registrar nascimento"}),e.jsx(ve,{children:"Crie os animais a partir da prenhez desta receptora."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{children:"Data de nascimento *"}),e.jsx(Ta,{value:M.data_nascimento,onChange:a=>K(r=>({...r,data_nascimento:a||""})),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{children:"Sexo *"}),e.jsxs(ge,{value:M.sexo,onValueChange:a=>K(r=>({...r,sexo:a})),children:[e.jsx(_e,{children:e.jsx(je,{placeholder:"Selecione o sexo"})}),e.jsxs(Ne,{children:[e.jsx(Q,{value:"FEMEA",children:"Fêmea"}),e.jsx(Q,{value:"MACHO",children:"Macho"}),e.jsx(Q,{value:"SEM_SEXO",children:"Sem sexo"})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{children:"Observações"}),e.jsx(ya,{value:M.observacoes,onChange:a=>K(r=>({...r,observacoes:a.target.value})),placeholder:"Observações sobre o nascimento",rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{children:"Embriões vinculados"}),be&&e.jsx("div",{className:"text-sm text-slate-500",children:"Carregando dados..."}),!be&&re.length===0&&e.jsx("div",{className:"text-sm text-slate-500",children:"Nenhum embrião disponível para registro."}),!be&&re.length>0&&e.jsx("div",{className:"border rounded-lg p-3",children:e.jsxs(Ge,{children:[e.jsx(We,{children:e.jsxs(se,{children:[e.jsx(L,{children:"Embrião"}),e.jsx(L,{children:"Doadora"}),e.jsx(L,{children:"Touro"}),e.jsx(L,{children:"Raça"})]})}),e.jsx(Qe,{children:re.map(a=>e.jsxs(se,{children:[e.jsx(B,{className:"font-medium",children:a.embriao_id.substring(0,8)}),e.jsx(B,{children:a.doadora_registro||"-"}),e.jsx(B,{children:a.touro_nome||"-"}),e.jsx(B,{children:a.raca||"-"})]},a.embriao_id))})]})})]})]}),e.jsxs(Da,{children:[e.jsx(z,{type:"button",variant:"outline",onClick:()=>me(!1),children:"Cancelar"}),e.jsx(z,{type:"button",onClick:_a,disabled:J,children:"Registrar nascimento"})]})]})}),e.jsx(ue,{open:na,onOpenChange:te,children:e.jsxs(pe,{className:"max-w-md",children:[e.jsxs(he,{children:[e.jsx(xe,{children:"Editar Receptora"}),e.jsx(ve,{children:"Atualizar dados da receptora"})]}),e.jsxs("form",{onSubmit:wa,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"edit_identificacao",children:"Identificação (Brinco) *"}),e.jsx(ne,{id:"edit_identificacao",value:X.identificacao,onChange:a=>Me({...X,identificacao:a.target.value}),placeholder:"Número do brinco",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"edit_nome",children:"Nome"}),e.jsx(ne,{id:"edit_nome",value:X.nome,onChange:a=>Me({...X,nome:a.target.value}),placeholder:"Nome da receptora (opcional)"})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(z,{type:"submit",className:"flex-1 bg-green-600 hover:bg-green-700",disabled:J,children:J?"Salvando...":"Salvar Alterações"}),e.jsx(z,{type:"button",variant:"outline",onClick:()=>te(!1),disabled:J,children:"Cancelar"})]})]}),e.jsxs("div",{className:"relative my-4",children:[e.jsx("div",{className:"absolute inset-0 flex items-center",children:e.jsx("span",{className:"w-full border-t"})}),e.jsx("div",{className:"relative flex justify-center text-xs uppercase",children:e.jsx("span",{className:"bg-white px-2 text-slate-500",children:"Ou"})})]}),e.jsxs(z,{type:"button",variant:"outline",className:"w-full",onClick:()=>{le(!0),Ce("")},disabled:J,children:[e.jsx(qa,{className:"w-4 h-4 mr-2"}),"Mover para outra fazenda"]})]})}),e.jsx(ue,{open:ca,onOpenChange:a=>{le(a),a||(k(!1),H(""))},children:e.jsxs(pe,{className:"max-w-md",children:[e.jsxs(he,{children:[e.jsx(xe,{children:"Mover Receptora"}),e.jsxs(ve,{children:["Mover ",d==null?void 0:d.identificacao," para outra fazenda. Protocolos e histórico reprodutivo não serão afetados."]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(F,{htmlFor:"nova_fazenda",children:"Nova Fazenda *"}),e.jsxs(ge,{value:$,onValueChange:Ce,children:[e.jsx(_e,{children:e.jsx(je,{placeholder:"Selecione a fazenda de destino"})}),e.jsx(Ne,{children:v.filter(a=>a.id!==N).map(a=>e.jsx(Q,{value:a.id,children:a.nome},a.id))})]})]}),ze&&(d==null?void 0:d.nome)&&e.jsxs("div",{className:"space-y-2 p-3 bg-red-50 border border-red-200 rounded-md",children:[e.jsx("div",{className:"flex items-start gap-2",children:e.jsx("div",{className:"text-red-800 text-sm font-medium",children:"❌ Conflito de Nome Detectado"})}),e.jsxs("div",{className:"text-red-700 text-sm",children:['Já existe uma receptora com o nome "',d.nome.trim(),'" na fazenda destino.']}),e.jsx("div",{className:"text-red-600 text-xs",children:"Não é possível mover esta receptora. Edite o nome da receptora antes de movê-la."})]}),oe&&A&&e.jsxs("div",{className:"space-y-2 p-3 bg-yellow-50 border border-yellow-200 rounded-md",children:[e.jsx("div",{className:"flex items-start gap-2",children:e.jsx("div",{className:"text-yellow-800 text-sm font-medium",children:"⚠️ Conflito de Brinco Detectado"})}),e.jsxs("div",{className:"text-yellow-700 text-sm",children:['Já existe uma receptora com o brinco "',d==null?void 0:d.identificacao,'" na fazenda destino.']}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(F,{className:"text-yellow-800 text-sm font-medium",children:"Novo Brinco Proposto:"}),e.jsx("div",{className:"p-2 bg-white border border-yellow-300 rounded text-sm font-mono text-yellow-900",children:A}),e.jsx("div",{className:"text-yellow-600 text-xs",children:"O brinco será automaticamente atualizado para permitir a movimentação."})]})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(z,{type:"button",className:"flex-1 bg-green-600 hover:bg-green-700",onClick:Ea,disabled:De||!$||ze||oe&&!A,children:De?"Movendo...":"Confirmar Movimentação"}),e.jsx(z,{type:"button",variant:"outline",onClick:()=>{le(!1),k(!1),H(""),Y(!1)},disabled:De,children:"Cancelar"})]})]})]})}),e.jsx(Ia,{receptoraId:Le,open:da,onClose:()=>Ue(!1),onUpdated:()=>{ha()}})]})]})}export{Bt as default};
