import{c as Ra,r as o,j as e,B as ke,s as m,b as Ia,f as ka,S as Da,ab as Oa}from"./index-B-7HRnm0.js";import{C as Ta,d as Pa}from"./card-DdhhEbXV.js";import{S as ea,a as aa,b as ra,c as ta,d as oa}from"./select-B0M3FCy4.js";import{I as Je}from"./input-D2h8r4MO.js";import{L as ma}from"./label-vBcRjcSu.js";import{P as La}from"./PageHeader-CT7CFo0W.js";import{u as sa}from"./use-toast-DDUqdzpY.js";import{b as Ma}from"./dataEnrichment-B3oy6j3b.js";import{v as Fa}from"./receptoraStatus-D9dFVedA.js";import{B as Fe}from"./badge-BCHVCiM7.js";import{D as qa,a as Ba,b as Va,c as $a,d as Ga,e as Ha}from"./dialog-CIXjHraQ.js";import{f as _a}from"./dateUtils-eJ5e6apA.js";import{F as Za}from"./file-text-ElQw19Mr.js";import{C as Ua,Q as Qa}from"./QualidadeSemaforo-CErGLmdF.js";import{C as Wa,D as fa}from"./DatePickerBR-XHkKTcYs.js";import{C as Ka}from"./chevron-right-DntnbvYp.js";import{T as Ja}from"./trash-2-czF2ENAT.js";import{T as ha}from"./triangle-alert-DsRw1gwV.js";import{A as Xa,a as Ya,b as er,c as ar,d as rr,e as tr,f as or,g as sr}from"./alert-dialog-CSZ8uCy0.js";import{S as ir}from"./switch-DtAGOp8o.js";import{U as nr}from"./user-B8IJeGnS.js";import{M as cr}from"./map-pin-B7CeMiQc.js";import{E as dr}from"./eye-C2rdP5in.js";import{S as lr}from"./save-DAusptDg.js";import{P as ua}from"./package-DCz2QOfz.js";import"./index-B4eR1KA_.js";import"./check-C6h7QFZL.js";import"./popover-i4alam_g.js";import"./pt-BR-DS62bWKG.js";import"./differenceInCalendarDays-CrzntjZV.js";import"./calendar-D8momPux.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pr=Ra("CalendarDays",[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 18h.01",key:"lrp35t"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M16 18h.01",key:"kzsmim"}]]),mr=768;function ia({data:s,columns:r,renderCell:u,rowKey:M="id",emptyMessage:C="Nenhum item encontrado",className:O="",selectionType:T="radio",selectedId:V="",selectedIds:$=[],onSelect:F,onSelectMultiple:g,isRowDisabled:l,radioName:_="selection",pageSize:h=0,currentPage:G,onPageChange:A,headerContent:q,footerContent:Q}){const[H,re]=o.useState(!1),[je,Ee]=o.useState(1),N=G??je,ne=A??Ee;o.useEffect(()=>{const n=()=>re(window.innerWidth<mr);return n(),window.addEventListener("resize",n),()=>window.removeEventListener("resize",n)},[]);const Y=(n,p,j)=>{if(u){const S=u(n,p,j);if(S!==void 0)return S}const k=n[p.key];return k==null?"—":String(k)},Ae=h>0?Math.max(1,Math.ceil(s.length/h)):1,we=h>0?s.slice((N-1)*h,N*h):s,he=n=>{const p=String(n[M]);if(!(l!=null&&l(n)))if(T==="radio")F==null||F(p);else{const j=$.includes(p)?$.filter(k=>k!==p):[...$,p];g==null||g(j)}},Se=n=>{const p=String(n[M]);return T==="radio"?V===p:$.includes(p)},B=()=>e.jsx("div",{className:"overflow-x-auto rounded-lg border border-border",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-muted text-[10px] font-semibold text-muted-foreground uppercase tracking-wide",children:[e.jsx("th",{className:"w-8 px-2 py-2"}),r.map(n=>e.jsx("th",{className:`px-2 py-2 font-semibold ${n.align==="center"?"text-center":n.align==="right"?"text-right":"text-left"}`,style:n.width?{width:n.width}:void 0,children:n.label},String(n.key)))]})}),e.jsx("tbody",{children:we.map((n,p)=>{const j=String(n[M]),k=(l==null?void 0:l(n))??!1,S=Se(n);return e.jsxs("tr",{className:`border-t border-border transition-colors ${S?"bg-primary/10":k?"opacity-50 cursor-not-allowed":"hover:bg-muted/50 cursor-pointer"}`,onClick:()=>he(n),children:[e.jsx("td",{className:"px-2 py-2",children:e.jsx("div",{className:"flex justify-center",children:e.jsx("input",{type:T,name:T==="radio"?_:void 0,checked:S,onChange:()=>he(n),disabled:k,className:"w-4 h-4 accent-primary"})})}),r.map(b=>e.jsx("td",{className:`px-2 py-2 ${b.align==="center"?"text-center":b.align==="right"?"text-right":""}`,children:e.jsx("div",{className:`${b.align==="center"?"flex justify-center":b.align==="right"?"flex justify-end":""}`,children:Y(n,b,p)})},String(b.key)))]},j)})})]})}),ee=()=>e.jsx("div",{className:"space-y-2",children:we.map((n,p)=>{const j=String(n[M]),k=(l==null?void 0:l(n))??!1,S=Se(n),b=r[0];return e.jsx("div",{className:`p-3 rounded-lg border transition-colors ${S?"border-primary bg-primary/5":k?"border-border opacity-50":"border-border hover:border-primary/50"} ${k?"cursor-not-allowed":"cursor-pointer"}`,onClick:()=>he(n),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("input",{type:T,name:T==="radio"?_:void 0,checked:S,onChange:()=>he(n),disabled:k,className:"w-4 h-4 accent-primary mt-1"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium text-foreground",children:Y(n,b,p)}),e.jsx("div",{className:"mt-1 space-y-1",children:r.slice(1).filter(E=>!E.excludeFromCard).map(E=>e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsxs("span",{className:"text-muted-foreground",children:[E.label,":"]}),e.jsx("span",{className:"text-foreground",children:Y(n,E,p)})]},String(E.key)))})]})]})},j)})}),I=()=>h<=0||Ae<=1?null:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(ke,{type:"button",variant:"outline",size:"sm",className:"h-6 text-xs px-2",onClick:()=>ne(Math.max(1,N-1)),disabled:N===1,children:[e.jsx(Wa,{className:"w-3 h-3 mr-1"}),"Anterior"]}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[N," / ",Ae]}),e.jsxs(ke,{type:"button",variant:"outline",size:"sm",className:"h-6 text-xs px-2",onClick:()=>ne(Math.min(Ae,N+1)),disabled:N>=Ae,children:["Próxima",e.jsx(Ka,{className:"w-3 h-3 ml-1"})]})]});return e.jsxs("div",{className:`flex flex-col h-full ${O}`,children:[q,s.length===0?e.jsx("div",{className:"flex-1 flex items-center justify-center py-6 text-sm text-muted-foreground",children:C}):e.jsx("div",{className:"flex-1 min-h-0 overflow-y-auto",children:H?ee():B()}),e.jsxs("div",{className:"mt-2 flex items-center justify-between text-xs text-muted-foreground",children:[e.jsx("div",{children:Q??`${s.length} item(s)`}),I()]})]})}const fr=!0;function ur({dataPasso2:s,filtroClienteId:r,filtroRaca:u,formData:M}){const{toast:C}=sa(),[O,T]=o.useState([]),[V,$]=o.useState([]),[F,g]=o.useState([]),[l,_]=o.useState([]),[h,G]=o.useState([]),[A,q]=o.useState([]),[Q,H]=o.useState(!0),[re,je]=o.useState(!1),[Ee,N]=o.useState([]),[ne,Y]=o.useState([]),[Ae,we]=o.useState({}),[he,Se]=o.useState({}),B=o.useCallback(async a=>{var v,w;if(!a.fazenda_id||!((((v=a.transferenciasIdsSessao)==null?void 0:v.length)||0)>0||(((w=a.transferenciasSessao)==null?void 0:w.length)||0)>0))return;let c=null;if(a.pacote_id){const R=a.pacote_id.substring(0,36);/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(R)&&(c=R)}const P={pacote_id:c,data_passo2:a.data_passo2||null,data_te:a.data_te||null,veterinario_responsavel:a.veterinario_responsavel||null,tecnico_responsavel:a.tecnico_responsavel||null,origem_embriao:a.origem_embriao||null,filtro_cliente_id:a.filtro_cliente_id||null,filtro_raca:a.filtro_raca||null,transferencias_ids:a.transferenciasIdsSessao||[],protocolo_receptora_ids:a.transferenciasSessao||[],updated_at:new Date().toISOString()};try{await m.from("transferencias_sessoes").delete().eq("fazenda_id",a.fazenda_id).eq("status","ABERTA"),await m.from("transferencias_sessoes").insert({...P,fazenda_id:a.fazenda_id,status:"ABERTA"})}catch{}},[]),ee=o.useCallback(async a=>{if(a)try{await m.from("transferencias_sessoes").delete().eq("fazenda_id",a).eq("status","ABERTA")}catch{}},[]),I=o.useCallback(a=>{const d=Array.isArray(a==null?void 0:a.transferencias_ids)?a.transferencias_ids:[],c=Array.isArray(a==null?void 0:a.protocolo_receptora_ids)?a.protocolo_receptora_ids:[],P=(a==null?void 0:a.origem_embriao)==="CONGELADO"?"CONGELADO":"PACOTE",v=(a==null?void 0:a.data_te)||new Date().toISOString().split("T")[0];return{transferenciasIds:d,protocoloReceptoraIds:c,filtros:{origem_embriao:P,filtro_cliente_id:(a==null?void 0:a.filtro_cliente_id)||"",filtro_raca:(a==null?void 0:a.filtro_raca)||"",data_passo2:(a==null?void 0:a.data_passo2)||new Date().toISOString().split("T")[0]},camposPacote:{data_te:v,veterinario_responsavel:(a==null?void 0:a.veterinario_responsavel)||"",tecnico_responsavel:(a==null?void 0:a.tecnico_responsavel)||""},formData:{fazenda_id:(a==null?void 0:a.fazenda_id)||"",pacote_id:(a==null?void 0:a.pacote_id)||"",protocolo_id:(a==null?void 0:a.protocolo_id)||"",data_te:v,veterinario_responsavel:(a==null?void 0:a.veterinario_responsavel)||"",tecnico_responsavel:(a==null?void 0:a.tecnico_responsavel)||""}}},[]),n=o.useCallback(a=>{Y(a.transferenciasIds),N(a.protocoloReceptoraIds)},[]),p=o.useCallback(async()=>{try{const{data:a}=await m.from("transferencias_sessoes").select("*").eq("status","ABERTA").order("updated_at",{ascending:!1}).limit(1);if(a&&a.length>0){const d=a[0],c=Array.isArray(d==null?void 0:d.transferencias_ids)?d.transferencias_ids:[];let P=Array.isArray(d==null?void 0:d.protocolo_receptora_ids)?d.protocolo_receptora_ids:[];if(c.length===0){try{await m.from("transferencias_sessoes").delete().eq("id",d.id)}catch{}return null}const{data:v}=await m.from("transferencias_embrioes").select("id, protocolo_receptora_id").in("id",c);if(!v||v.length===0){try{await m.from("transferencias_sessoes").delete().eq("id",d.id)}catch{}return null}P=[...new Set(v.map(R=>R.protocolo_receptora_id).filter(R=>!!R))];const w=I(d);return n({transferenciasIds:w.transferenciasIds,protocoloReceptoraIds:w.protocoloReceptoraIds}),w}return null}catch{return null}},[I,n]),j=o.useCallback(async()=>{try{const{data:a,error:d}=await m.from("clientes").select("id, nome").order("nome",{ascending:!0});if(d)throw d;$(a||[])}catch{$([])}},[]),k=o.useCallback(async a=>{const d=a??s;try{let c=m.from("protocolos_sincronizacao").select("id");d&&(c=c.eq("passo2_data",d));const{data:P,error:v}=await c;if(v)throw v;const w=[...new Set((P||[]).map(pe=>pe.id).filter(Boolean))];if(w.length===0)return T([]),H(!1),[];const{data:R,error:W}=await m.from("v_protocolo_receptoras_status").select("receptora_id").eq("fase_ciclo","SINCRONIZADA").in("protocolo_id",w);if(W)throw W;const Ce=[...new Set((R||[]).map(pe=>pe.receptora_id).filter(Boolean))];if(Ce.length===0)return T([]),H(!1),[];const{data:ue,error:L}=await m.from("vw_receptoras_fazenda_atual").select("fazenda_id_atual").in("receptora_id",Ce);if(L)throw L;const Te=[...new Set((ue||[]).map(pe=>pe.fazenda_id_atual).filter(Boolean))];if(Te.length===0)return T([]),H(!1),[];const{data:ze,error:X}=await m.from("fazendas").select("id, nome").in("id",Te).order("nome",{ascending:!0});if(X)throw X;return T(ze||[]),H(!1),ze||[]}catch(c){return C({title:"Erro ao carregar fazendas",description:c instanceof Error?c.message:"Erro desconhecido",variant:"destructive"}),H(!1),[]}},[s,C]),S=o.useCallback(async()=>{var a;try{const[d,c]=await Promise.all([m.from("transferencias_embrioes").select("embriao_id"),m.from("embrioes").select("*").eq("status_atual","FRESCO").order("created_at",{ascending:!1})]),P=((a=d.data)==null?void 0:a.map(i=>i.embriao_id))||[];if(c.error)throw c.error;const v=[...c.data||[]].filter(i=>!P.includes(i.id)&&i.status_atual!=="TRANSFERIDO").sort((i,U)=>{const te=new Date(i.created_at||0).getTime();return new Date(U.created_at||0).getTime()-te});if(!v||v.length===0)return g([]),[];const w=v.map(i=>i.id),R=[...new Set(v.filter(i=>i.lote_fiv_id).map(i=>i.lote_fiv_id))];let W=new Map,Ce=new Map,ue=new Map,L=new Map;const[Te,ze,X]=await Promise.all([w.length>0?m.from("v_embrioes_disponiveis_te").select("embriao_id, d7_pronto, d8_limite").in("embriao_id",w):Promise.resolve({data:null,error:null}),m.from("fazendas").select("id, nome"),R.length>0?m.from("lotes_fiv").select("id, pacote_aspiracao_id").in("id",R):Promise.resolve({data:null,error:null})]),pe=new Map((Te.data||[]).map(i=>[i.embriao_id,{d7_pronto:i.d7_pronto,d8_limite:i.d8_limite}]));ze.data&&(L=new Map(ze.data.map(i=>[i.id,i.nome])));const De=X.data;if(De&&De.length>0){De.forEach(U=>{U.pacote_aspiracao_id&&Ce.set(U.id,U.pacote_aspiracao_id)});const i=[...new Set(De.map(U=>U.pacote_aspiracao_id).filter(Boolean))];if(i.length>0){const[U,te]=await Promise.all([m.from("pacotes_aspiracao").select("*").in("id",i),m.from("pacotes_aspiracao_fazendas_destino").select("pacote_aspiracao_id, fazenda_destino_id").in("pacote_aspiracao_id",i)]),y=te.data;y&&y.forEach(x=>{const se=ue.get(x.pacote_aspiracao_id)||[];se.includes(x.fazenda_destino_id)||se.push(x.fazenda_destino_id),ue.set(x.pacote_aspiracao_id,se)});const D=U.data;D&&D.forEach(x=>{if(x.fazenda_destino_id){const se=ue.get(x.id)||[];se.includes(x.fazenda_destino_id)||se.push(x.fazenda_destino_id),ue.set(x.id,se)}W.set(x.id,{id:x.id,data_aspiracao:x.data_aspiracao,fazenda_nome:L.get(x.fazenda_id),quantidade_doadoras:0,horario_inicio:x.horario_inicio,veterinario_responsavel:x.veterinario_responsavel,total_oocitos:x.total_oocitos})})}}const qe=v.map(i=>i.lote_fiv_acasalamento_id).filter(i=>!!i);let xe=new Map,Be=new Map;if(qe.length>0){const{data:i}=await m.from("lote_fiv_acasalamentos").select("id, aspiracao_doadora_id, dose_semen_id").in("id",qe);if(i){xe=new Map(i.map(Z=>[Z.id,Z]));const U=[...new Set(i.map(Z=>Z.aspiracao_doadora_id).filter(Boolean))],te=[...new Set(i.map(Z=>Z.dose_semen_id).filter(Boolean))],[y,D]=await Promise.all([U.length>0?m.from("aspiracoes_doadoras").select("id, doadora_id").in("id",U):Promise.resolve({data:null}),te.length>0?m.from("doses_semen").select("id, touro_id, touro:touros(id, nome, registro, raca)").in("id",te):Promise.resolve({data:null})]),x=y.data,se=D.data;if(se&&(Be=new Map(se.map(Z=>{const oe=Z.touro,ye=Array.isArray(oe)?oe[0]:oe;return[Z.id,(ye==null?void 0:ye.nome)||"Touro desconhecido"]})),i.forEach(Z=>{if(Z.dose_semen_id){const oe=Be.get(Z.dose_semen_id);if(oe){const ye=xe.get(Z.id);xe.set(Z.id,{...ye,touro_nome:oe})}}})),x){const Z=[...new Set(x.map(oe=>oe.doadora_id))];if(Z.length>0){const{data:oe}=await m.from("doadoras").select("id, registro").in("id",Z);if(oe){const ye=new Map(oe.map(ie=>[ie.id,ie.registro])),Ge=new Map(x.map(ie=>[ie.id,ie.doadora_id]));i.forEach(ie=>{if(ie.aspiracao_doadora_id){const Qe=Ge.get(ie.aspiracao_doadora_id);if(Qe){const ve=ye.get(Qe);if(ve){const Me=xe.get(ie.id);xe.set(ie.id,{...Me,doadora_registro:ve})}}}})}}}}}const Pe=new Map;v.forEach(i=>{var x,se;if(!i.lote_fiv_id||!i.created_at)return;const U=i.created_at.split("T")[0],te=`${i.lote_fiv_id}-${U}`;let y=Pe.get(te);if(!y){const Z=Ce.get(i.lote_fiv_id),oe=Z?W.get(Z):void 0,ye=Z?ue.get(Z)||[]:[],Ge=ye.map(ie=>L.get(ie)).filter(ie=>!!ie);y={id:te,lote_fiv_id:i.lote_fiv_id,data_despacho:U,fazendas_destino_ids:ye,fazendas_destino_nomes:Ge,pacote_info:oe||{id:Z||"",data_aspiracao:U,quantidade_doadoras:0},embrioes:[],total:0,frescos:0,congelados:0},Pe.set(te,y)}const D=xe.get(i.lote_fiv_acasalamento_id||"");y.embrioes.push({...i,doadora_registro:D==null?void 0:D.doadora_registro,touro_nome:D==null?void 0:D.touro_nome,d7_pronto:(x=pe.get(i.id))==null?void 0:x.d7_pronto,d8_limite:(se=pe.get(i.id))==null?void 0:se.d8_limite}),y.total++,i.status_atual==="FRESCO"&&y.frescos++,i.status_atual==="CONGELADO"&&y.congelados++});const Ve=[...new Set(Array.from(Pe.values()).map(i=>i.lote_fiv_id))],{data:Re}=await m.from("lotes_fiv").select("id, disponivel_para_transferencia").in("id",Ve),ge=new Map((Re==null?void 0:Re.map(i=>[i.id,i.disponivel_para_transferencia===!0]))||[]),Le=Array.from(Pe.values()).map(i=>{const U=i.embrioes.filter(te=>!te.classificacao||te.classificacao.trim()==="").length;return{pacote:i,semClassificacao:U,total:i.total,disponivel:ge.get(i.lote_fiv_id)}}).filter(i=>i.disponivel!==!1&&i.total>0&&i.semClassificacao===0).map(i=>i.pacote).sort((i,U)=>U.data_despacho.localeCompare(i.data_despacho));return g(Le),Le}catch(d){return C({title:"Erro ao carregar pacotes de embriões",description:d instanceof Error?d.message:"Erro desconhecido",variant:"destructive"}),g([]),[]}},[C]),b=o.useCallback(async()=>{var d;const a=u.trim().toLowerCase();if(!r&&!a){G([]);return}try{je(!0);let c=m.from("embrioes").select("*").eq("status_atual","CONGELADO").not("cliente_id","is",null);r&&(c=c.eq("cliente_id",r));const[P,v]=await Promise.all([m.from("transferencias_embrioes").select("embriao_id"),c.order("created_at",{ascending:!1})]);if(P.error)throw P.error;if(v.error)throw v.error;const w=((d=P.data)==null?void 0:d.map(W=>W.embriao_id))||[],R=(v.data||[]).filter(W=>!w.includes(W.id)&&W.status_atual!=="TRANSFERIDO");if(R.length===0){G([]);return}G(R)}catch(c){C({title:"Erro ao carregar embriões congelados",description:c instanceof Error?c.message:"Erro desconhecido",variant:"destructive"}),G([])}finally{je(!1)}},[r,u,C]),E=o.useCallback(async(a,d)=>{try{let c=m.from("receptoras_cio_livre").select("receptora_id, data_cio").eq("ativa",!0).eq("fazenda_id",a);d&&(c=c.eq("data_cio",d));const{data:P,error:v}=await c;if(v&&v.code!=="PGRST205")throw v;const w=(P||[]).map(L=>L.receptora_id).filter(L=>!!L);if(w.length===0)return{receptoras:[],receptorasDisponiveis:0};const{data:R,error:W}=await m.from("receptoras").select("id, identificacao, status_reprodutivo").in("id",w);if(W)throw W;const Ce=new Map((P||[]).map(L=>[L.receptora_id,L.data_cio])),ue=(R||[]).map(L=>({receptora_id:L.id,brinco:L.identificacao||"N/A",identificacao:L.identificacao||"",protocolo_id:void 0,protocolo_receptora_id:void 0,data_te_prevista:void 0,data_limite_te:void 0,quantidade_embrioes:0,ciclando_classificacao:void 0,qualidade_semaforo:void 0,origem:"CIO_LIVRE",data_cio:Ce.get(L.id),status_reprodutivo:L.status_reprodutivo}));return{receptoras:ue,receptorasDisponiveis:ue.length}}catch(c){return C({title:"Erro ao carregar receptoras CIO LIVRE",description:c instanceof Error?c.message:"Erro desconhecido",variant:"destructive"}),{receptoras:[],receptorasDisponiveis:0}}},[C]),fe=o.useCallback(async(a,d)=>{const c=(d==null?void 0:d.contagem)??Ae,P=(d==null?void 0:d.info)??he;try{let v=[],w=m.from("protocolos_sincronizacao").select("id");s&&(w=w.eq("passo2_data",s));const{data:R,error:W}=await w;if(W)throw W;const Ce=[...new Set((R||[]).map(X=>X.id).filter(Boolean))];if(Ce.length>0){const{data:X,error:pe}=await m.from("v_protocolo_receptoras_status").select("receptora_id, brinco, data_te_prevista, data_limite_te, protocolo_id").eq("fase_ciclo","SINCRONIZADA").in("protocolo_id",Ce);if(pe&&pe.code!=="PGRST205")throw pe;const De=X||[],qe=[...new Set(De.map(xe=>xe.receptora_id).filter(Boolean))];if(qe.length>0){const{data:xe,error:Be}=await m.from("vw_receptoras_fazenda_atual").select("receptora_id").in("receptora_id",qe).eq("fazenda_id_atual",a);if(Be)throw Be;const Pe=new Set((xe||[]).map(ge=>ge.receptora_id).filter(Boolean)),Ve=De.filter(ge=>Pe.has(ge.receptora_id)),Re=[...new Set(Ve.map(ge=>ge.receptora_id).filter(Boolean))];if(Re.length>0){const{data:ge,error:_e}=await m.from("receptoras").select("id, identificacao, status_reprodutivo").in("id",Re);if(_e)throw _e;const Le=new Map((ge||[]).map(y=>[y.id,y])),i=[...new Set(Ve.map(y=>y.protocolo_id).filter(Boolean))];let U=[];if(i.length>0){const{data:y,error:D}=await m.from("protocolo_receptoras").select("id, receptora_id, protocolo_id, status, ciclando_classificacao, qualidade_semaforo, observacoes").in("protocolo_id",i).neq("status","INAPTA").neq("status","UTILIZADA");if(D&&D.code!=="PGRST205")throw D;U=y||[]}const te=new Map(U.map(y=>[y.receptora_id,y]));v=Ve.map(y=>{const D=Le.get(y.receptora_id),x=te.get(y.receptora_id),se=c[y.receptora_id]||0;return{receptora_id:y.receptora_id,brinco:y.brinco||(D==null?void 0:D.identificacao)||"N/A",identificacao:(D==null?void 0:D.identificacao)||"",protocolo_id:(x==null?void 0:x.protocolo_id)||y.protocolo_id,protocolo_receptora_id:(x==null?void 0:x.id)||"",data_te_prevista:y.data_te_prevista,data_limite_te:y.data_limite_te,quantidade_embrioes:se,ciclando_classificacao:(x==null?void 0:x.ciclando_classificacao)??null,qualidade_semaforo:(x==null?void 0:x.qualidade_semaforo)??null,observacoes:(x==null?void 0:x.observacoes)??null,origem:"PROTOCOLO",status_reprodutivo:D==null?void 0:D.status_reprodutivo}}).filter(y=>y.status_reprodutivo==="SINCRONIZADA"||c[y.receptora_id]>0)}}}const{receptoras:ue}=await E(a,s);let L=[...v,...ue];const Te=Object.values(P).filter(X=>(c[X.receptora_id]||0)>=1),ze=new Set(L.map(X=>X.receptora_id));return Te.forEach(X=>{ze.has(X.receptora_id)||L.push({...X,quantidade_embrioes:c[X.receptora_id]||0})}),L=L.map(X=>({...X,quantidade_embrioes:c[X.receptora_id]||0})),q(L),{receptorasDisponiveis:L.length}}catch(v){return C({title:"Erro ao carregar receptoras",description:v instanceof Error?v.message:"Erro desconhecido",variant:"destructive"}),q([]),{receptorasDisponiveis:0}}},[s,Ae,he,E,C]),le=o.useCallback(async(a,d)=>{await fe(a,d)},[fe]);return o.useEffect(()=>{if(M.fazenda_id){const a=F.filter(d=>d.fazendas_destino_ids.includes(M.fazenda_id));_(a)}else _([])},[M.fazenda_id,F]),o.useEffect(()=>{(async()=>{if(ne.length===0){we({}),Se({});return}const{data:d,error:c}=await m.from("transferencias_embrioes").select("id, receptora_id, protocolo_receptora_id, receptoras(id, identificacao, status_reprodutivo)").in("id",ne);if(c)return;const P={},v={};(d||[]).forEach(w=>{if(!w.receptora_id)return;P[w.receptora_id]=(P[w.receptora_id]||0)+1;const R=Array.isArray(w.receptoras)?w.receptoras[0]:w.receptoras;v[w.receptora_id]={receptora_id:w.receptora_id,brinco:(R==null?void 0:R.identificacao)||"N/A",identificacao:(R==null?void 0:R.identificacao)||"",protocolo_id:void 0,protocolo_receptora_id:w.protocolo_receptora_id||"",quantidade_embrioes:P[w.receptora_id],origem:w.protocolo_receptora_id?"PROTOCOLO":"CIO_LIVRE",status_reprodutivo:(R==null?void 0:R.status_reprodutivo)||"SERVIDA"}}),we(P),Se(v)})()},[ne]),{fazendas:O,clientes:V,pacotes:F,pacotesFiltrados:l,embrioesCongelados:h,receptoras:A,setReceptoras:q,loading:Q,loadingCongelados:re,transferenciasSessao:Ee,setTransferenciasSessao:N,transferenciasIdsSessao:ne,setTransferenciasIdsSessao:Y,contagemSessaoPorReceptora:Ae,setContagemSessaoPorReceptora:we,receptorasSessaoInfo:he,setReceptorasSessaoInfo:Se,loadFazendas:k,loadPacotes:S,loadClientes:j,loadEmbrioesCongelados:b,carregarReceptorasDaFazenda:fe,recarregarReceptoras:le,salvarSessaoNoBanco:B,encerrarSessaoNoBanco:ee,restaurarSessaoEmAndamento:p}}const Ie={origemEmbriao:"PACOTE",filtroClienteId:"",filtroRaca:"",dataPasso2:"",embrioesPage:1},$e={showRelatorioDialog:!1,relatorioData:[],isVisualizacaoApenas:!1};function _r(){const[s,r]=o.useState(Ie.origemEmbriao),[u,M]=o.useState(Ie.filtroClienteId),[C,O]=o.useState(Ie.filtroRaca),[T,V]=o.useState(Ie.dataPasso2),[$,F]=o.useState(Ie.embrioesPage),[g,l]=o.useState($e.showRelatorioDialog),[_,h]=o.useState($e.relatorioData),[G,A]=o.useState($e.isVisualizacaoApenas),q=o.useCallback(()=>{r(Ie.origemEmbriao),M(Ie.filtroClienteId),O(Ie.filtroRaca),V(Ie.dataPasso2),F(Ie.embrioesPage)},[]),Q=o.useCallback(()=>{l($e.showRelatorioDialog),h($e.relatorioData),A($e.isVisualizacaoApenas)},[]),H=o.useCallback(()=>{q(),Q()},[q,Q]),re=o.useCallback(Y=>{h(Y),A(!0),l(!0)},[]),je=o.useCallback(Y=>{h(Y),A(!1),l(!0)},[]),Ee=o.useCallback(()=>{l(!1),A(!1)},[]),N=o.useCallback(Y=>{r(Y.origem_embriao==="CONGELADO"?"CONGELADO":"PACOTE"),M(Y.filtro_cliente_id||""),O(Y.filtro_raca||""),V(Y.data_passo2||new Date().toISOString().split("T")[0]),Y.embrioes_page&&F(Y.embrioes_page)},[]),ne=o.useCallback(()=>({origemEmbriao:s,filtroClienteId:u,filtroRaca:C,dataPasso2:T,embrioesPage:$}),[s,u,C,T,$]);return{origemEmbriao:s,setOrigemEmbriao:r,filtroClienteId:u,setFiltroClienteId:M,filtroRaca:C,setFiltroRaca:O,dataPasso2:T,setDataPasso2:V,embrioesPage:$,setEmbrioesPage:F,showRelatorioDialog:g,setShowRelatorioDialog:l,relatorioData:_,setRelatorioData:h,isVisualizacaoApenas:G,setIsVisualizacaoApenas:A,resetFilters:q,resetRelatorio:Q,resetAll:H,abrirRelatorioVisualizacao:re,abrirRelatorioEncerramento:je,fecharRelatorio:Ee,aplicarFiltrosSessao:N,getFiltersState:ne}}function hr({formData:s,setFormData:r,origemEmbriao:u,receptoras:M,contagemSessaoPorReceptora:C,setContagemSessaoPorReceptora:O,receptorasSessaoInfo:T,setReceptorasSessaoInfo:V,transferenciasSessao:$,setTransferenciasSessao:F,transferenciasIdsSessao:g,setTransferenciasIdsSessao:l,numerosFixosMap:_,setSubmitting:h,setRelatorioData:G,setShowRelatorioDialog:A,setIsVisualizacaoApenas:q,resetFiltros:Q,loadPacotes:H,loadEmbrioesCongelados:re,recarregarReceptoras:je,encerrarSessaoNoBanco:Ee}){const{toast:N}=sa(),ne=o.useCallback(async B=>{try{const{data:ee,error:I}=await m.from("protocolo_receptoras").select("protocolo_id").eq("id",B).single();if(I||!(ee!=null&&ee.protocolo_id))return;const n=ee.protocolo_id,{data:p,error:j}=await m.from("protocolo_receptoras").select("status").eq("protocolo_id",n);if(j||!p)return;if(p.filter(S=>S.status==="APTA"||S.status==="INICIADA").length===0){const b=p.filter(E=>E.status==="UTILIZADA").length>0?"EM_TE":"FECHADO";await m.from("protocolos_sincronizacao").update({status:b}).eq("id",n)}}catch(ee){console.error("Erro ao verificar status do protocolo:",ee)}},[]),Y=o.useCallback(async()=>{if(!s.receptora_id){N({title:"Nenhuma receptora selecionada",description:"Selecione uma receptora para descartar.",variant:"destructive"});return}const B=M.find(p=>p.receptora_id===s.receptora_id),ee=(B==null?void 0:B.brinco)||s.receptora_id,I=(B==null?void 0:B.origem)||"PROTOCOLO",n=s.protocolo_receptora_id;try{if(h(!0),I==="CIO_LIVRE"){const{error:p,data:j}=await m.from("receptoras_cio_livre").update({ativa:!1}).eq("receptora_id",s.receptora_id).eq("ativa",!0).select("id");if(p)throw console.error("Erro ao descartar receptora CIO LIVRE:",{error:p,code:p.code,message:p.message,details:p.details,hint:p.hint,receptora_id:s.receptora_id}),p;(!j||j.length===0)&&console.warn("Nenhum registro de CIO LIVRE encontrado para desativar:",{receptora_id:s.receptora_id,possivel_causa:"Registro não existe ou RLS bloqueou acesso"})}else if(n){const{error:p}=await m.from("protocolo_receptoras").update({status:"INAPTA",motivo_inapta:"Descartada no menu de TE - não recebeu embrião"}).eq("id",n);if(p)throw p;await ne(n)}s.receptora_id&&I!=="CIO_LIVRE"&&await m.from("receptoras").update({status_reprodutivo:"VAZIA"}).eq("id",s.receptora_id),N({title:"Receptora descartada",description:I==="CIO_LIVRE"?`${ee} foi descartada da lista de cio livre. Status anterior mantido.`:`${ee} foi descartada e não receberá embrião neste protocolo.`}),r(p=>({...p,receptora_id:"",protocolo_receptora_id:""})),s.fazenda_id&&await je(s.fazenda_id)}catch(p){N({title:"Erro ao descartar receptora",description:p instanceof Error?p.message:"Erro desconhecido",variant:"destructive"})}finally{h(!1)}},[s,M,r,h,je,ne,N]),Ae=o.useCallback(async B=>{var j,k,S,b;B.preventDefault();const ee=u==="PACOTE";if(!s.embriao_id){N({title:"Embrião não selecionado",description:"Por favor, selecione um embrião para realizar a transferência.",variant:"destructive"});return}if(!s.fazenda_id||!s.receptora_id||!s.data_te||ee&&!s.pacote_id){N({title:"Erro de validação",description:"Todos os campos obrigatórios devem ser preenchidos",variant:"destructive"});return}const I=M.find(E=>E.receptora_id===s.receptora_id);if(!I){N({title:"Receptora não disponível",description:"A receptora selecionada não está disponível para transferência.",variant:"destructive"});return}const n=C[s.receptora_id]||0,p=n===1;if(n>=2){N({title:"Limite atingido",description:"Esta receptora já recebeu o máximo de 2 embriões permitidos.",variant:"destructive"});return}if(s.receptora_id&&!p&&I.origem!=="CIO_LIVRE"){const E=I.status_reprodutivo||"VAZIA";if(E.startsWith("PRENHE")){N({title:"Receptora indisponível",description:"Esta receptora já está prenhe e não pode receber outro embrião.",variant:"destructive"});return}const fe=Fa(E,"REALIZAR_TE");if(!fe.valido){N({title:"Erro de validação",description:fe.mensagem||"A receptora não pode receber embrião no estado atual",variant:"destructive"});return}}if(!s.veterinario_responsavel||s.veterinario_responsavel.trim()===""){N({title:"Erro de validação",description:"Veterinário responsável é obrigatório. Por favor, informe o nome do veterinário.",variant:"destructive"});return}try{h(!0);const E={embriao_id:s.embriao_id,receptora_id:s.receptora_id,protocolo_receptora_id:s.protocolo_receptora_id||null,data_te:s.data_te,tipo_te:u==="CONGELADO"?"CONGELADO":"FRESCO",veterinario_responsavel:s.veterinario_responsavel.trim(),tecnico_responsavel:((j=s.tecnico_responsavel)==null?void 0:j.trim())||null,status_te:"REALIZADA",observacoes:((k=s.observacoes)==null?void 0:k.trim())||null},{data:fe,error:le}=await m.from("transferencias_embrioes").insert([E]).select("id");if(le){if(le.code==="23505"&&((S=le.message)!=null&&S.includes("unq_embriao_te_realizada"))){u==="CONGELADO"?re():H();return}throw le}fe&&((b=fe[0])!=null&&b.id)&&l(c=>[...c,fe[0].id]),await m.from("embrioes").update({status_atual:"TRANSFERIDO"}).eq("id",s.embriao_id),s.protocolo_receptora_id&&F(c=>c.includes(s.protocolo_receptora_id)?c:[...c,s.protocolo_receptora_id]);const a={...C};a[s.receptora_id]=(a[s.receptora_id]||0)+1,O(a);const d={...T};d[s.receptora_id]={...I,quantidade_embrioes:a[s.receptora_id]},V(d),N({title:"Transferência registrada",description:`Embrião transferido para ${I.brinco} com sucesso.`}),r(c=>({...c,embriao_id:"",receptora_id:"",protocolo_receptora_id:"",observacoes:""})),u==="CONGELADO"?re():H()}catch(E){N({title:"Erro ao registrar transferência",description:E instanceof Error?E.message:"Erro desconhecido",variant:"destructive"})}finally{h(!1)}},[s,u,M,C,T,r,h,l,F,O,V,H,re,N]),we=o.useCallback(async(B=!1)=>{if(!(g.length>0)){B||N({title:"Nenhuma transferência na sessão",description:"Não há transferências para gerar relatório.",variant:"destructive"});return}try{const{data:I,error:n}=await m.from("transferencias_embrioes").select(`
          *,
          embrioes (id, identificacao, classificacao, status_atual, lote_fiv_id, lote_fiv_acasalamento_id),
          receptoras (id, identificacao, nome)
        `).in("id",g).eq("status_te","REALIZADA").order("created_at",{ascending:!0});if(n)throw n;if(!I||I.length===0){N({title:"Erro ao gerar relatório",description:"Não foi possível encontrar as transferências da sessão.",variant:"destructive"});return}const p=I.map(b=>{var E;return(E=b.embrioes)==null?void 0:E.lote_fiv_acasalamento_id}).filter(b=>!!b),{doadorasMap:j,tourosMap:k}=await Ma(p),S=I.map(b=>{var c,P,v,w,R,W;const E=(c=b.embrioes)==null?void 0:c.lote_fiv_acasalamento_id,fe=E&&j.get(E)||"N/A",le=E&&k.get(E)||"N/A";return{numero_embriao:((P=b.embrioes)==null?void 0:P.identificacao)||(_&&_.get(b.embriao_id||"")?String(_.get(b.embriao_id||"")):null)||(b.embriao_id?b.embriao_id.substring(0,8):"N/A"),doadora:fe,touro:le,classificacao:((v=b.embrioes)==null?void 0:v.classificacao)||"N/A",receptora_id:((w=b.receptoras)==null?void 0:w.id)||b.receptora_id||"",receptora_brinco:((R=b.receptoras)==null?void 0:R.identificacao)||"N/A",receptora_nome:((W=b.receptoras)==null?void 0:W.nome)||"",data_te:b.data_te,veterinario:b.veterinario_responsavel||"N/A",tecnico:b.tecnico_responsavel||"N/A",observacoes:b.observacoes||""}});G(S),A(!0)}catch(I){N({title:"Erro ao gerar relatório",description:I instanceof Error?I.message:"Erro desconhecido",variant:"destructive"}),q(!1)}},[g,_,G,A,q,N]),he=o.useCallback(async()=>{if(g.length===0){N({title:"Nenhuma transferência na sessão",description:"Não há transferências para visualizar.",variant:"destructive"});return}q(!0),await we(!0)},[g,q,we,N]),Se=o.useCallback(async()=>{if(g.length===0){N({title:"Nenhuma transferência na sessão",description:"Não há transferências para encerrar nesta sessão.",variant:"destructive"});return}try{h(!0);let B=[...$];if(B.length===0){const{data:k,error:S}=await m.from("transferencias_embrioes").select("protocolo_receptora_id").in("id",g);if(S)throw S;B=[...new Set((k||[]).map(b=>b.protocolo_receptora_id).filter(b=>!!b))]}const{data:ee,error:I}=await m.from("transferencias_embrioes").select("receptora_id").in("id",g).eq("status_te","REALIZADA");if(I)throw I;const n=[...new Set((ee||[]).map(k=>k.receptora_id).filter(Boolean))];if(n.length===0)throw new Error("Nenhuma receptora encontrada para encerrar a sessão.");if(n.length>0){const{error:k,data:S}=await m.from("receptoras_cio_livre").update({ativa:!1}).in("receptora_id",n).eq("ativa",!0).select("id");k?console.error("Erro ao desativar receptoras CIO LIVRE no encerramento:",{error:k,code:k.code,message:k.message,receptoraIds:n,possivel_causa:"RLS pode estar bloqueando UPDATE para este usuário"}):S&&S.length>0&&console.info(`${S.length} receptora(s) CIO LIVRE desativada(s) no encerramento da sessão`)}const{error:p}=await m.rpc("encerrar_sessao_te",{p_receptora_ids:n,p_protocolo_receptora_ids:B});if(p)throw(p==null?void 0:p.code)==="PGRST202"?new Error("Função encerrar_sessao_te não encontrada no banco. Aplique o SQL em docs/db/003_encerrar_sessao_te.sql e tente novamente."):p;await Ee(s.fazenda_id),N({title:"Sessão encerrada",description:`${g.length} transferência(s) finalizada(s) com sucesso.`});const j=s.fazenda_id;r({fazenda_id:"",pacote_id:"",protocolo_id:"",embriao_id:"",receptora_id:"",protocolo_receptora_id:"",data_te:new Date().toISOString().split("T")[0],veterinario_responsavel:"",tecnico_responsavel:"",observacoes:""}),F([]),l([]),O({}),V({}),Q(),await H(),j&&await je(j)}catch(B){N({title:"Erro ao encerrar sessão",description:B instanceof Error?B.message:"Erro desconhecido",variant:"destructive"})}finally{h(!1)}},[s,$,g,r,h,F,l,O,V,Q,H,je,Ee,N]);return{handleDescartarReceptora:Y,handleSubmit:Ae,visualizarRelatorioSessao:he,gerarRelatorioSessao:we,handleEncerrarSessao:Se}}function xr({open:s,onOpenChange:r,relatorioData:u,fazendaNome:M,dataTe:C,veterinarioResponsavel:O,tecnicoResponsavel:T,isVisualizacaoApenas:V,submitting:$,onFechar:F,onConfirmarEncerrar:g}){const l=o.useMemo(()=>{const A=new Map;return u.forEach(q=>{const Q=q.receptora_id||q.receptora_brinco;A.has(Q)||A.set(Q,{receptora_id:q.receptora_id||"",receptora_brinco:q.receptora_brinco,receptora_nome:q.receptora_nome||"",embrioes:[],observacoes:[]});const H=A.get(Q);H.embrioes.push(q),q.observacoes&&H.observacoes.push(q.observacoes)}),Array.from(A.values())},[u]),_=l.length,h=u.length,G=l.filter(A=>A.embrioes.length>=2).length;return e.jsx(qa,{open:s,onOpenChange:r,children:e.jsxs(Ba,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(Va,{children:[e.jsxs($a,{className:"flex items-center gap-2",children:[e.jsx(Za,{className:"w-5 h-5"}),"Relatório da Sessão de Transferência de Embriões"]}),e.jsxs(Ga,{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("span",{children:["Fazenda: ",M||"N/A"]}),e.jsx("span",{className:"text-muted-foreground",children:"•"}),e.jsxs("span",{children:["Data da TE: ",C?_a(C):"N/A"]}),e.jsx("span",{className:"text-muted-foreground",children:"•"}),e.jsxs("span",{className:"font-medium text-foreground",children:[_," receptora",_!==1?"s":""," • ",h," embrião",h!==1?"es":""]}),G>0&&e.jsxs(Fe,{variant:"outline",className:"text-[10px] bg-amber-500/10 text-amber-600 border-amber-500/30",children:[G," com 2 embriões"]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Veterinário Responsável:"})," ",O||"N/A"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Técnico Responsável:"})," ",T||"N/A"]})]}),e.jsxs("div",{className:"rounded-xl border border-border bg-card overflow-hidden",children:[e.jsx("div",{className:"bg-gradient-to-r from-muted/80 via-muted/60 to-muted/80 border-b border-border",children:e.jsxs("div",{className:"grid grid-cols-[1.5fr_3fr_1.5fr] text-[10px] font-semibold text-muted-foreground uppercase tracking-wider",children:[e.jsxs("div",{className:"px-4 py-3 flex items-center gap-2",children:[e.jsx("div",{className:"w-1 h-4 rounded-full bg-primary/40"}),"Receptora"]}),e.jsx("div",{className:"px-3 py-3",children:"Embriões Transferidos"}),e.jsx("div",{className:"px-3 py-3",children:"Observações"})]})}),e.jsx("div",{className:"divide-y divide-border/50",children:l.map((A,q)=>{const Q=A.embrioes.length>=2;return e.jsxs("div",{className:`
                      grid grid-cols-[1.5fr_3fr_1.5fr] items-start
                      ${q%2===0?"bg-transparent":"bg-muted/20"}
                      ${Q?"bg-amber-500/5":""}
                    `,children:[e.jsxs("div",{className:"px-4 py-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-semibold text-sm text-foreground",children:A.receptora_brinco}),Q&&e.jsx(Fe,{variant:"outline",className:"text-[9px] px-1.5 py-0 h-4 bg-amber-500/15 text-amber-600 border-amber-500/30",children:"2 embriões"})]}),A.receptora_nome&&e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:A.receptora_nome})]}),e.jsx("div",{className:"px-3 py-3",children:e.jsx("div",{className:"space-y-1.5",children:A.embrioes.map((H,re)=>e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("span",{className:"inline-flex items-center justify-center min-w-6 h-6 px-1.5 text-xs font-semibold bg-primary/10 text-primary rounded",children:H.numero_embriao}),e.jsxs("span",{className:"text-muted-foreground",children:[H.doadora||"N/A"," × ",H.touro||"N/A"]}),e.jsx(Fe,{variant:"outline",className:"text-[10px] px-1.5 py-0 h-4",children:H.classificacao||"-"})]},re))})}),e.jsx("div",{className:"px-3 py-3",children:A.observacoes.length>0?e.jsx("ul",{className:"text-xs text-muted-foreground space-y-1",children:A.observacoes.map((H,re)=>e.jsx("li",{children:H},re))}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"-"})})]},A.receptora_id||q)})}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 bg-gradient-to-r from-muted/30 via-transparent to-muted/30 border-t border-border",children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:[e.jsx("span",{className:"font-medium text-foreground",children:_})," receptora",_!==1?"s":""," •"," ",e.jsx("span",{className:"font-medium text-foreground",children:h})," embrião",h!==1?"es":""]}),G>0&&e.jsxs("span",{className:"text-xs text-amber-600",children:[G," receptora",G!==1?"s":""," com transferência dupla"]})]})]})]}),e.jsxs(Ha,{children:[e.jsx(ke,{type:"button",variant:"outline",onClick:F,children:"Fechar"}),!V&&e.jsx(ke,{type:"button",onClick:async()=>{F(),await g()},disabled:$,children:$?"Encerrando...":"Confirmar e Encerrar Sessão"})]})]})})}function gr({receptoras:s,selectedReceptoraId:r,contagemSessaoPorReceptora:u,submitting:M,permitirSegundoEmbriao:C,onSelectReceptora:O,onDescartarReceptora:T}){const V=s.filter(l=>{const _=u[l.receptora_id]||0;return C?_<2:_===0}),$=[{key:"brinco",label:"Receptora"},{key:"embrioes_count",label:"Embriões",width:"80px",align:"center"},{key:"action",label:"",width:"50px",excludeFromCard:!0}],F=V.length,g=V.filter(l=>(u[l.receptora_id]||0)>0).length;return e.jsx(ia,{data:V,columns:$,rowKey:"receptora_id",selectionType:"radio",radioName:"receptora",selectedId:r,onSelect:l=>{const _=V.find(h=>h.receptora_id===l);_&&O(l,_.protocolo_receptora_id||"")},isRowDisabled:()=>!1,emptyMessage:C?"Nenhuma receptora disponível para 2º embrião":"Nenhuma receptora sincronizada encontrada",footerContent:C&&g>0?`${F} receptora(s) - ${g} com 1 embrião`:`${F} receptora(s) disponível(is)`,renderCell:(l,_)=>{const h=u[l.receptora_id]||0,G=r===l.receptora_id;switch(_.key){case"brinco":return e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-1.5 flex-wrap",children:[e.jsx("span",{className:"text-sm font-medium text-foreground",children:l.brinco}),l.origem==="CIO_LIVRE"&&e.jsx(Fe,{variant:"outline",className:"text-[10px] px-1.5 py-0 h-4 bg-emerald-50 text-emerald-700 border-emerald-200 dark:bg-emerald-950 dark:text-emerald-300 dark:border-emerald-800",children:"CIO"}),e.jsx(Ua,{value:l.ciclando_classificacao}),e.jsx(Qa,{value:l.qualidade_semaforo})]}),l.observacoes&&e.jsx("p",{className:"text-[10px] text-muted-foreground truncate mt-0.5",title:l.observacoes,children:l.observacoes})]});case"embrioes_count":return C?h>0?e.jsxs("span",{className:"inline-flex items-center justify-center px-2 h-5 text-[10px] font-medium bg-amber-500/15 text-amber-600 dark:text-amber-400 rounded",children:[h,"/2"]}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"0/2"}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"-"});case"action":return G?e.jsx(ke,{type:"button",variant:"ghost",size:"sm",onClick:A=>{A.stopPropagation(),T()},className:"h-6 w-6 p-0 text-destructive hover:text-destructive hover:bg-destructive/10",disabled:M,title:"Descartar receptora",children:e.jsx(Ja,{className:"w-3.5 h-3.5"})}):null;default:return}}})}function vr({pacote:s,embrioes:r,numerosFixosMap:u,selectedEmbriaoId:M,embrioesPage:C,hasD8Limite:O,onSelectEmbriao:T,onPageChange:V}){const $=o.useMemo(()=>[...r].sort((g,l)=>{const _=g.identificacao||"",h=l.identificacao||"";if(_&&h)return _.localeCompare(h);if(_&&!h)return-1;if(!_&&h)return 1;const G=u.get(g.id)||9999,A=u.get(l.id)||9999;return G-A}),[r,u]),F=[{key:"identificacao",label:"Código",width:"60px",align:"center"},{key:"doadora_registro",label:"Doadora"},{key:"touro_nome",label:"Touro"},{key:"classificacao",label:"Class.",width:"70px",align:"center"},{key:"d7_pronto",label:"Dia",width:"50px",align:"center"}];return e.jsx(ia,{data:$,columns:F,rowKey:"id",selectionType:"radio",radioName:"embriao",selectedId:M,onSelect:T,pageSize:20,currentPage:C,onPageChange:V,emptyMessage:"Nenhum embrião disponível no pacote",headerContent:O&&e.jsxs("div",{className:"mb-2 flex items-center gap-2 text-xs text-amber-700 dark:text-amber-400 bg-amber-50 dark:bg-amber-950/50 p-2 rounded-lg border border-amber-200 dark:border-amber-800",children:[e.jsx(ha,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{children:"Embriões em D8: transferir ou congelar hoje"})]}),footerContent:`${r.length} embrião(ões) disponível(is)`,renderCell:(g,l)=>{switch(l.key){case"identificacao":const _=u.get(g.id)||0;return e.jsx("span",{className:"text-xs font-medium font-mono text-foreground",children:g.identificacao||`#${_}`});case"doadora_registro":return e.jsx("span",{className:"text-sm text-foreground truncate",children:g.doadora_registro||"-"});case"touro_nome":return e.jsx("span",{className:"text-sm text-muted-foreground truncate",children:g.touro_nome||"-"});case"classificacao":return g.classificacao?e.jsx(Fe,{variant:"outline",className:"text-[10px] px-1.5 py-0 h-4",children:g.classificacao}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"-"});case"d7_pronto":return g.d8_limite?e.jsx(Fe,{variant:"destructive",className:"text-[10px] px-1.5 py-0 h-4",children:"D8"}):g.d7_pronto?e.jsx(Fe,{variant:"outline",className:"text-[10px] px-1.5 py-0 h-4 bg-emerald-50 text-emerald-700 border-emerald-200 dark:bg-emerald-950 dark:text-emerald-300 dark:border-emerald-800",children:"D7"}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"-"});default:return}}})}function br({embrioes:s,selectedEmbriaoId:r,embrioesPage:u,loadingCongelados:M,filtroClienteId:C,filtroRaca:O,onSelectEmbriao:T,onPageChange:V}){const $=C||O.trim(),F=o.useMemo(()=>[...s].sort((_,h)=>{const G=_.created_at?new Date(_.created_at).getTime():0;return(h.created_at?new Date(h.created_at).getTime():0)-G}),[s]),g=[{key:"identificacao",label:"Código",width:"80px"},{key:"doadora_registro",label:"Doadora"},{key:"touro_nome",label:"Touro"},{key:"classificacao",label:"Class.",width:"70px",align:"center"}],l=()=>$?M?"Carregando embriões congelados...":"Nenhum embrião congelado encontrado":"Selecione um cliente ou informe a raça para listar embriões";return!$||M?e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsx("div",{className:"flex-1 flex items-center justify-center border border-border rounded-lg",children:e.jsx("div",{className:"text-center py-6 text-sm text-muted-foreground",children:l()})}),e.jsxs("div",{className:"mt-2 text-xs text-muted-foreground",children:[s.length," embrião(ões) disponível(is)"]})]}):e.jsx(ia,{data:F,columns:g,rowKey:"id",selectionType:"radio",radioName:"embriao",selectedId:r,onSelect:T,pageSize:20,currentPage:u,onPageChange:V,emptyMessage:l(),footerContent:`${s.length} embrião(ões) disponível(is)`,renderCell:(_,h)=>{switch(h.key){case"identificacao":return e.jsx("span",{className:"text-xs font-medium font-mono text-foreground",children:_.identificacao||_.id.substring(0,8)});case"doadora_registro":return e.jsx("span",{className:"text-sm text-foreground truncate",children:_.doadora_registro||"-"});case"touro_nome":return e.jsx("span",{className:"text-sm text-muted-foreground truncate",children:_.touro_nome||"-"});case"classificacao":return _.classificacao?e.jsx(Fe,{variant:"outline",className:"text-[10px] px-1.5 py-0 h-4",children:_.classificacao}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"-"});default:return}}})}const Nr=20;function Yr(){var ca;Ia();const{toast:s}=sa(),[r,u]=o.useState({fazenda_id:"",pacote_id:"",protocolo_id:"",receptora_id:"",protocolo_receptora_id:"",embriao_id:"",data_te:new Date().toISOString().split("T")[0],veterinario_responsavel:"",tecnico_responsavel:"",observacoes:""}),[M,C]=o.useState({data_te:"",veterinario_responsavel:"",tecnico_responsavel:""}),[O,T]=o.useState(!1),[V,$]=o.useState(!1),[F,g]=o.useState([]),[l,_]=o.useState([]),[h,G]=o.useState(!1),[A,q]=o.useState("todos"),[Q,H]=o.useState("todos"),[re,je]=o.useState(""),[Ee,N]=o.useState(""),[ne,Y]=o.useState(""),[Ae,we]=o.useState([]),[he,Se]=o.useState(1),B=15,[ee,I]=o.useState(!1),[n,p]=o.useState(null),{origemEmbriao:j,setOrigemEmbriao:k,filtroClienteId:S,setFiltroClienteId:b,filtroRaca:E,setFiltroRaca:fe,dataPasso2:le,setDataPasso2:a,embrioesPage:d,setEmbrioesPage:c,showRelatorioDialog:P,setShowRelatorioDialog:v,relatorioData:w,setRelatorioData:R,isVisualizacaoApenas:W,setIsVisualizacaoApenas:Ce,resetAll:ue,aplicarFiltrosSessao:L,fecharRelatorio:Te}=_r(),{fazendas:ze,clientes:X,pacotes:pe,pacotesFiltrados:De,embrioesCongelados:qe,receptoras:xe,setReceptoras:Be,loading:Pe,loadingCongelados:Ve,transferenciasSessao:Re,setTransferenciasSessao:ge,transferenciasIdsSessao:_e,setTransferenciasIdsSessao:Le,contagemSessaoPorReceptora:i,setContagemSessaoPorReceptora:U,receptorasSessaoInfo:te,setReceptorasSessaoInfo:y,loadFazendas:D,loadPacotes:x,loadClientes:se,loadEmbrioesCongelados:Z,carregarReceptorasDaFazenda:oe,recarregarReceptoras:ye,salvarSessaoNoBanco:Ge,encerrarSessaoNoBanco:ie,restaurarSessaoEmAndamento:Qe}=ur({dataPasso2:le,filtroClienteId:S,filtroRaca:E,formData:r}),ve=pe.find(t=>t.id===r.pacote_id),Me=o.useMemo(()=>(ve==null?void 0:ve.embrioes.filter(t=>t.status_atual==="FRESCO"))||[],[ve]),xa=Me.some(t=>t.d8_limite),ga=o.useRef(0),Xe=o.useMemo(()=>{if(!r.pacote_id||!ve)return new Map;const t=[...Me].sort((ae,K)=>{const be=ae.doadora_registro||"",Ne=K.doadora_registro||"";if(be!==Ne)return be.localeCompare(Ne);const me=ae.created_at?new Date(ae.created_at).getTime():0,ce=K.created_at?new Date(K.created_at).getTime():0;return me!==ce?me-ce:(ae.id||"").localeCompare(K.id||"")}),z=new Map;return t.forEach((ae,K)=>{z.set(ae.id,K+1)}),z},[r.pacote_id,ve,Me]),{handleDescartarReceptora:va,handleSubmit:ba,visualizarRelatorioSessao:Na,handleEncerrarSessao:na}=hr({formData:r,setFormData:u,origemEmbriao:j,receptoras:xe,contagemSessaoPorReceptora:i,setContagemSessaoPorReceptora:U,receptorasSessaoInfo:te,setReceptorasSessaoInfo:y,transferenciasSessao:Re,setTransferenciasSessao:ge,transferenciasIdsSessao:_e,setTransferenciasIdsSessao:Le,numerosFixosMap:Xe,setSubmitting:T,setRelatorioData:R,setShowRelatorioDialog:v,setIsVisualizacaoApenas:Ce,resetFiltros:ue,loadPacotes:x,loadEmbrioesCongelados:Z,recarregarReceptoras:ye,encerrarSessaoNoBanco:ie}),ja=()=>{const t={fazenda_id:r.fazenda_id,pacote_id:r.pacote_id,data_passo2:le,data_te:r.data_te,veterinario_responsavel:r.veterinario_responsavel,tecnico_responsavel:r.tecnico_responsavel,origem_embriao:j,filtro_cliente_id:S,filtro_raca:E,transferenciasSessao:Re,transferenciasIdsSessao:_e,embrioes_page:d};Ge(t)},Ea=async()=>{const{data:t}=await m.from("fazendas").select("id, nome").order("nome");we(t||[])};o.useCallback(async()=>{try{G(!0);let t=m.from("transferencias_embrioes").select(`
          id,
          receptora_id,
          embriao_id,
          data_te,
          tipo_te,
          veterinario_responsavel,
          tecnico_responsavel,
          observacoes,
          status_te,
          embrioes (id, identificacao, classificacao),
          receptoras (id, identificacao, nome)
        `).eq("status_te","REALIZADA").order("data_te",{ascending:!1}).limit(500);Ee&&(t=t.gte("data_te",Ee)),ne&&(t=t.lte("data_te",ne)),Q&&Q!=="todos"&&(t=t.eq("tipo_te",Q));const{data:z,error:ae}=await t;if(ae)throw console.error("Erro ao buscar transferências:",ae),new Error(ae.message||"Erro ao buscar transferências");if(!z||z.length===0){g([]),_([]);return}const K=[...new Set(z.map(f=>f.receptora_id).filter(Boolean))],{data:be,error:Ne}=await m.from("vw_receptoras_fazenda_atual").select("receptora_id, fazenda_id_atual, fazenda_nome_atual").in("receptora_id",K);Ne&&console.error("Erro ao buscar view receptoras:",Ne);const me=new Map((be||[]).map(f=>[f.receptora_id,{id:f.fazenda_id_atual,nome:f.fazenda_nome_atual}])),ce=z.map(f=>f.embriao_id).filter(Boolean),{data:Oe}=await m.from("embrioes").select("id, lote_fiv_acasalamento_id").in("id",ce),We=(Oe||[]).map(f=>f.lote_fiv_acasalamento_id).filter(f=>!!f);let He=new Map,Ke=new Map;if(We.length>0){const{data:f}=await m.from("lote_fiv_acasalamentos").select(`
            id,
            doadoras (registro),
            touros (nome)
          `).in("id",We);(f||[]).forEach(J=>{var de,Ue;(de=J.doadoras)!=null&&de.registro&&He.set(J.id,J.doadoras.registro),(Ue=J.touros)!=null&&Ue.nome&&Ke.set(J.id,J.touros.nome)})}const Sa=new Map((Oe||[]).map(f=>[f.id,f.lote_fiv_acasalamento_id])),da=z.map(f=>{var Ue,la,pa;const J=me.get(f.receptora_id),de=Sa.get(f.embriao_id);return{id:f.id,receptora_id:f.receptora_id,receptora_brinco:((Ue=f.receptoras)==null?void 0:Ue.identificacao)||"-",receptora_nome:(la=f.receptoras)==null?void 0:la.nome,fazenda_nome:(J==null?void 0:J.nome)||"-",fazenda_id:J==null?void 0:J.id,data_te:f.data_te,embriao_identificacao:(pa=f.embrioes)==null?void 0:pa.identificacao,doadora_registro:de?He.get(de):void 0,touro_nome:de?Ke.get(de):void 0,tipo_te:f.tipo_te,veterinario_responsavel:f.veterinario_responsavel,tecnico_responsavel:f.tecnico_responsavel,observacoes:f.observacoes}});g(da);const Ze=new Map;da.forEach(f=>{const J=`${f.fazenda_nome}|${f.data_te}|${f.veterinario_responsavel||""}`;Ze.has(J)||Ze.set(J,{id:J,fazenda_nome:f.fazenda_nome,fazenda_id:f.fazenda_id||"",data_te:f.data_te,veterinario_responsavel:f.veterinario_responsavel,tecnico_responsavel:f.tecnico_responsavel,total_receptoras:0,total_embrioes:0,frescos:0,congelados:0,transferencias:[]});const de=Ze.get(J);de.total_embrioes++,de.transferencias.push(f),f.tipo_te==="FRESCO"?de.frescos++:f.tipo_te==="CONGELADO"&&de.congelados++,!de.tecnico_responsavel&&f.tecnico_responsavel&&(de.tecnico_responsavel=f.tecnico_responsavel)}),Ze.forEach(f=>{const J=new Set(f.transferencias.map(de=>de.receptora_id));f.total_receptoras=J.size});const za=Array.from(Ze.values()).sort((f,J)=>(J.data_te||"").localeCompare(f.data_te||""));_(za),Se(1)}catch(t){console.error("Erro no loadHistorico:",t);const z=t instanceof Error?t.message:"Erro desconhecido";s({title:"Erro ao carregar histórico",description:z,variant:"destructive"})}finally{G(!1)}},[Ee,ne,Q,s]);const wa=async t=>{if(!t){u({...r,fazenda_id:"",pacote_id:"",protocolo_id:"",embriao_id:"",receptora_id:"",protocolo_receptora_id:""}),C({data_te:"",veterinario_responsavel:"",tecnico_responsavel:""}),ge([]),Le([]),Be([]);return}ge([]),Le([]),C({data_te:"",veterinario_responsavel:"",tecnico_responsavel:""}),await oe(t),u({...r,fazenda_id:t,pacote_id:"",protocolo_id:"",embriao_id:"",receptora_id:"",protocolo_receptora_id:""})},Ca=t=>{var ae;const z=pe.find(K=>K.id===t);(ae=z==null?void 0:z.pacote_info)!=null&&ae.veterinario_responsavel&&!r.veterinario_responsavel?(u(K=>({...K,pacote_id:t,veterinario_responsavel:z.pacote_info.veterinario_responsavel||""})),C(K=>({...K,veterinario_responsavel:z.pacote_info.veterinario_responsavel||""}))):u(K=>({...K,pacote_id:t}))},ya=async()=>{if(n){const t=n.filtros.data_passo2||"",z=n.formData.fazenda_id||"",ae=n.formData.pacote_id||"",K=n.transferenciasIds||[];L(n.filtros),C(n.camposPacote);const[,be]=await Promise.all([D(t),x()]);let Ne="";if(ae&&be&&be.length>0){if(K.length>0)try{const{data:me}=await m.from("transferencias_embrioes").select("embriao_id, embrioes(lote_fiv_id, created_at)").in("id",K).limit(1);if(me&&me.length>0){const ce=Array.isArray(me[0].embrioes)?me[0].embrioes[0]:me[0].embrioes;if(ce!=null&&ce.lote_fiv_id&&(ce!=null&&ce.created_at)){const Oe=ce.created_at.split("T")[0],We=`${ce.lote_fiv_id}-${Oe}`,He=be.find(Ke=>Ke.id===We);He&&(Ne=He.id)}}}catch(me){console.error("Erro ao inferir pacote da sessão:",me)}if(!Ne){const ce=(z?be.filter(Oe=>Oe.fazendas_destino_ids.includes(z)):be).find(Oe=>Oe.id.startsWith(ae)||Oe.lote_fiv_id===ae);ce&&(Ne=ce.id)}}u(me=>({...me,...n.formData,pacote_id:Ne||ae,embriao_id:"",receptora_id:"",protocolo_receptora_id:"",observacoes:""})),z&&await oe(z,{contagem:i,info:te}),s({title:"Sessão restaurada",description:"Continuando de onde você parou."})}I(!1),p(null)},Aa=async()=>{var t;(t=n==null?void 0:n.filtros)!=null&&t.fazenda_id&&await ie(n.filtros.fazenda_id),I(!1),p(null),s({title:"Sessão descartada",description:"Uma nova sessão será iniciada."})};o.useEffect(()=>{(async()=>{await Promise.all([D(),x(),se(),Ea()]);const z=await Qe();z&&(p(z),I(!0))})()},[]),o.useEffect(()=>{(r.fazenda_id||r.pacote_id||_e.length>0)&&ja()},[r.fazenda_id,r.pacote_id,r.protocolo_id,r.data_te,r.veterinario_responsavel,r.tecnico_responsavel,j,S,E,le,Re.length,_e.length,d]),o.useEffect(()=>{D()},[le]),o.useEffect(()=>{r.fazenda_id&&(_e.length>0?oe(r.fazenda_id,{contagem:i,info:te}):oe(r.fazenda_id))},[r.fazenda_id,le]),o.useEffect(()=>{j==="CONGELADO"&&(S||E.trim())&&Z()},[j,S,E]),o.useEffect(()=>{c(1)},[r.pacote_id]),o.useEffect(()=>{j==="CONGELADO"&&(c(1),u(t=>({...t,embriao_id:""})))},[j,S,E]),o.useEffect(()=>{!r.pacote_id||!ve||(ga.current+=1)},[r.pacote_id,ve,Xe]),o.useEffect(()=>{const t=Math.max(1,Math.ceil(Me.length/Nr));d>t&&c(t)},[Me.length,d]);const Ye=l.filter(t=>{var K;const z=!re||t.fazenda_nome.toLowerCase().includes(re.toLowerCase())||((K=t.veterinario_responsavel)==null?void 0:K.toLowerCase().includes(re.toLowerCase()))||t.transferencias.some(be=>{var Ne;return be.receptora_brinco.toLowerCase().includes(re.toLowerCase())||((Ne=be.receptora_nome)==null?void 0:Ne.toLowerCase().includes(re.toLowerCase()))}),ae=A==="todos"||t.fazenda_nome===A;return z&&ae});return Math.ceil(Ye.length/B),Ye.slice((he-1)*B,he*B),Ye.reduce((t,z)=>({sessoes:t.sessoes+1,receptoras:t.receptoras+z.total_receptoras,embrioes:t.embrioes+z.total_embrioes,frescos:t.frescos+z.frescos,congelados:t.congelados+z.congelados}),{sessoes:0,receptoras:0,embrioes:0,frescos:0,congelados:0}),Pe?e.jsx(ka,{}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(La,{title:"Transferência de Embriões (TE)",description:"Destinar embriões para receptoras sincronizadas"}),e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"rounded-xl border border-border bg-gradient-to-r from-card via-card to-muted/30 p-4 mb-4",children:[e.jsxs("div",{className:"flex flex-wrap items-end gap-6",children:[e.jsxs("div",{className:"flex items-end gap-3",children:[e.jsx("div",{className:"w-1 h-6 rounded-full bg-primary/40 self-center"}),e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground self-center",children:[e.jsx(nr,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:"Responsáveis"})]}),e.jsxs("div",{className:"flex-1 min-w-[160px]",children:[e.jsx("label",{className:"text-[10px] font-medium text-muted-foreground mb-1 block uppercase tracking-wide",children:"Veterinário *"}),e.jsx(Je,{placeholder:"Nome do veterinário",value:r.veterinario_responsavel,onChange:t=>u({...r,veterinario_responsavel:t.target.value}),className:"h-9"})]}),e.jsxs("div",{className:"flex-1 min-w-[160px]",children:[e.jsx("label",{className:"text-[10px] font-medium text-muted-foreground mb-1 block uppercase tracking-wide",children:"Técnico"}),e.jsx(Je,{placeholder:"Nome do técnico",value:r.tecnico_responsavel,onChange:t=>u({...r,tecnico_responsavel:t.target.value}),className:"h-9"})]})]}),e.jsx("div",{className:"h-10 w-px bg-border hidden lg:block"}),e.jsxs("div",{className:"flex items-end gap-3",children:[e.jsx("div",{className:"w-1 h-6 rounded-full bg-emerald-500/40 self-center"}),e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground self-center",children:[e.jsx(cr,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:"Local"})]}),e.jsxs("div",{className:"flex-1 min-w-[160px]",children:[e.jsxs("label",{className:"text-[10px] font-medium text-muted-foreground mb-1 block uppercase tracking-wide",children:["Fazenda ",_e.length>0?"(sessão ativa)":"*"]}),e.jsxs(ea,{value:r.fazenda_id,onValueChange:wa,disabled:!r.veterinario_responsavel||_e.length>0,children:[e.jsx(aa,{className:"h-9",children:e.jsx(ra,{placeholder:"Selecione a fazenda"})}),e.jsx(ta,{children:ze.map(t=>e.jsx(oa,{value:t.id,children:t.nome},t.id))})]})]}),e.jsxs("div",{className:"w-[140px] flex-shrink-0",children:[e.jsx("label",{className:"text-[10px] font-medium text-muted-foreground mb-1 block uppercase tracking-wide",children:"Data TE *"}),e.jsx(fa,{value:r.data_te,onChange:t=>u({...r,data_te:t||""}),className:"h-9"})]})]}),e.jsx("div",{className:"h-10 w-px bg-border hidden lg:block"}),r.fazenda_id&&_e.length>0&&e.jsxs("div",{className:"flex items-end gap-2 ml-auto",children:[e.jsxs(ke,{type:"button",onClick:Na,variant:"outline",disabled:O,className:"h-9",title:"Visualizar relatório da sessão atual",children:[e.jsx(dr,{className:"w-4 h-4 mr-2"}),"Ver (",_e.length,")"]}),e.jsxs(ke,{type:"button",onClick:na,disabled:O,className:"h-9 px-6 bg-primary hover:bg-primary-dark shadow-sm",children:[e.jsx(lr,{className:"w-4 h-4 mr-2"}),O?"Encerrando...":`Encerrar (${_e.length})`]})]})]}),r.fazenda_id&&e.jsxs("div",{className:"flex flex-wrap items-end gap-4 mt-4 pt-4 border-t border-border/50",children:[e.jsxs("div",{className:"flex items-end gap-3",children:[e.jsx("div",{className:"w-1 h-6 rounded-full bg-blue-500/40 self-center"}),e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground self-center",children:[e.jsx(pr,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:"Receptoras"})]}),e.jsxs("div",{className:"w-[130px]",children:[e.jsx("label",{className:"text-[10px] font-medium text-muted-foreground mb-1 block uppercase tracking-wide",children:"Data 2º Passo"}),e.jsx(fa,{value:le,onChange:t=>a(t||""),className:"h-9"})]}),e.jsxs("div",{className:"flex items-center gap-2 h-9 self-end",children:[e.jsx(ir,{id:"permitir-segundo-embriao",checked:V,onCheckedChange:$}),e.jsx(ma,{htmlFor:"permitir-segundo-embriao",className:"cursor-pointer text-xs",children:"2º embrião"})]})]}),e.jsx("div",{className:"h-10 w-px bg-border hidden lg:block"}),e.jsxs("div",{className:"flex items-end gap-3",children:[e.jsx("div",{className:"w-1 h-6 rounded-full bg-amber-500/40 self-center"}),e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground self-center",children:[e.jsx(ua,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:"Origem"})]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsxs(ke,{type:"button",variant:j==="PACOTE"?"default":"outline",onClick:()=>k("PACOTE"),size:"sm",className:"h-8",children:[e.jsx(ua,{className:"w-3.5 h-3.5 mr-1.5"}),"Pacote"]}),e.jsxs(ke,{type:"button",variant:j==="CONGELADO"?"default":"outline",onClick:()=>k("CONGELADO"),size:"sm",className:"h-8",children:[e.jsx(Da,{className:"w-3.5 h-3.5 mr-1.5"}),"Congelado"]})]})]}),j==="PACOTE"&&e.jsxs("div",{className:"flex-1 min-w-[220px] max-w-[300px]",children:[e.jsx("label",{className:"text-[10px] font-medium text-muted-foreground mb-1 block uppercase tracking-wide",children:"Pacote de Embriões *"}),e.jsxs(ea,{value:r.pacote_id,onValueChange:Ca,children:[e.jsx(aa,{className:"h-9",children:e.jsx(ra,{placeholder:"Selecione o pacote"})}),e.jsx(ta,{children:De.map(t=>{var z;return e.jsxs(oa,{value:t.id,children:[((z=t.pacote_info)==null?void 0:z.fazenda_nome)||"N/A"," - ",_a(t.data_despacho)," (",t.frescos," frescos)"]},t.id)})})]})]}),j==="CONGELADO"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex-1 min-w-[160px] max-w-[200px]",children:[e.jsx("label",{className:"text-[10px] font-medium text-muted-foreground mb-1 block uppercase tracking-wide",children:"Cliente"}),e.jsxs(ea,{value:S,onValueChange:b,children:[e.jsx(aa,{className:"h-9",children:e.jsx(ra,{placeholder:"Selecione"})}),e.jsx(ta,{children:X.map(t=>e.jsx(oa,{value:t.id,children:t.nome},t.id))})]})]}),e.jsxs("div",{className:"flex-1 min-w-[140px] max-w-[160px]",children:[e.jsx("label",{className:"text-[10px] font-medium text-muted-foreground mb-1 block uppercase tracking-wide",children:"Raça"}),e.jsx(Je,{value:E,onChange:t=>fe(t.target.value),placeholder:"Digite a raça",className:"h-9"})]})]})]}),r.veterinario_responsavel?r.fazenda_id?null:e.jsx("p",{className:"text-xs text-muted-foreground mt-3",children:"Selecione uma fazenda para ver as receptoras disponíveis"}):e.jsx("p",{className:"text-xs text-muted-foreground mt-3",children:"Preencha o veterinário para selecionar a fazenda"})]}),r.fazenda_id&&e.jsx("form",{onSubmit:ba,children:(r.pacote_id||j==="CONGELADO"&&(S||E.trim()))&&e.jsx(Ta,{className:"mb-4",children:e.jsxs(Pa,{className:"pt-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-1 h-6 rounded-full bg-primary/40"}),e.jsx("span",{className:"text-sm font-semibold text-foreground",children:"Selecione Receptora e Embrião"})]}),r.embriao_id&&r.receptora_id&&e.jsxs(ke,{type:"submit",disabled:O,className:"h-9 px-6 bg-primary hover:bg-primary-dark shadow-sm shadow-primary/25",children:[e.jsx(Oa,{className:"w-4 h-4 mr-2"}),O?"Registrando...":"Transferir Embrião"]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("h3",{className:"text-xs font-medium text-muted-foreground mb-2 uppercase tracking-wide",children:"Receptoras"}),e.jsx("div",{className:"flex-1 min-h-[300px] max-h-[400px]",children:e.jsx(gr,{receptoras:xe,selectedReceptoraId:r.receptora_id,contagemSessaoPorReceptora:i,submitting:O,permitirSegundoEmbriao:V,onSelectReceptora:(t,z)=>{u({...r,receptora_id:t,protocolo_receptora_id:z})},onDescartarReceptora:va})})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("h3",{className:"text-xs font-medium text-muted-foreground mb-2 uppercase tracking-wide",children:["Embriões ",j==="PACOTE"?"(Pacote)":"(Congelados)"]}),e.jsxs("div",{className:"flex-1 min-h-[300px] max-h-[400px]",children:[j==="PACOTE"&&r.pacote_id&&ve&&e.jsx(vr,{pacote:ve,embrioes:Me,numerosFixosMap:Xe,selectedEmbriaoId:r.embriao_id,embrioesPage:d,hasD8Limite:xa,onSelectEmbriao:t=>u({...r,embriao_id:t}),onPageChange:c}),j==="CONGELADO"&&e.jsx(br,{embrioes:qe,selectedEmbriaoId:r.embriao_id,embrioesPage:d,loadingCongelados:Ve,filtroClienteId:S,filtroRaca:E,onSelectEmbriao:t=>u({...r,embriao_id:t}),onPageChange:c})]})]})]}),r.embriao_id&&r.receptora_id&&e.jsx("div",{className:"mt-4 pt-4 border-t border-border/50",children:e.jsx("div",{className:"flex items-center gap-4",children:e.jsxs("div",{className:"flex-1 max-w-md",children:[e.jsx(ma,{htmlFor:"observacoes",className:"text-[10px] font-medium text-muted-foreground mb-1 block uppercase tracking-wide",children:"Observações (opcional)"}),e.jsx(Je,{id:"observacoes",value:r.observacoes,onChange:t=>u({...r,observacoes:t.target.value}),placeholder:"Observações sobre a transferência",className:"h-9"})]})})})]})})})]}),e.jsx(xr,{open:P,onOpenChange:v,relatorioData:w,fazendaNome:((ca=ze.find(t=>t.id===r.fazenda_id))==null?void 0:ca.nome)||"N/A",dataTe:r.data_te,veterinarioResponsavel:r.veterinario_responsavel,tecnicoResponsavel:r.tecnico_responsavel,isVisualizacaoApenas:W,submitting:O,onFechar:Te,onConfirmarEncerrar:na}),e.jsx(Xa,{open:ee,onOpenChange:I,children:e.jsxs(Ya,{children:[e.jsxs(er,{children:[e.jsxs(ar,{className:"flex items-center gap-2",children:[e.jsx(ha,{className:"h-5 w-5 text-primary"}),"Sessão de TE não finalizada"]}),e.jsx(rr,{children:"Você tem uma sessão de transferência de embriões em andamento que não foi finalizada. Deseja continuar de onde parou?"})]}),e.jsxs(tr,{children:[e.jsx(or,{onClick:Aa,children:"Descartar"}),e.jsx(sr,{onClick:ya,children:"Restaurar"})]})]})})]})}export{Yr as default};
