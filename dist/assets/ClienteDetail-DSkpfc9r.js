import{e as ue,f as je,r as d,s as N,j as e,a as ge,B as x,L as J,H as ve,D as fe}from"./index-DM5u2d-F.js";import{N as Ne,g as Ce,a as De,i as _e,e as be,b as Se}from"./coordinates-CPjP6fsB.js";import{C as z,a as w,b as L,d as E}from"./card-B_EQ6x91.js";import{T as M,a as U,b as h,c,d as A,e as i}from"./table-CEKyj1ed.js";import{D as K,a as ze,b as W,c as X,d as Y,e as ee}from"./dialog-2y4jBKyr.js";import{I as j}from"./input-CtUEWea1.js";import{L as g}from"./label-Bhhf9ayq.js";import{T as we,a as Le,b as H,c as I}from"./tabs-mOzZlruc.js";import{P as Ee}from"./PageHeader-JgO8x5IE.js";import{E as Fe}from"./EmptyState-ChaxWsz8.js";import{u as ye}from"./use-toast-BOUGyrIz.js";import{A as ke}from"./arrow-left-CH9vqVt5.js";import{S as se}from"./square-pen-Cfxri2C7.js";import{S as Te}from"./snowflake-DcJSD3Yt.js";import{P as Re}from"./plus-DJrruxx9.js";import"./index-CWb7Yp_3.js";import"./index-sCsFC1oc.js";import"./x-DsJYRTDR.js";import"./index-C0gH1jj7.js";import"./index-ClZPXJQX.js";function ss(){const{id:p}=ue(),V=je(),{toast:C}=ye(),[ae,P]=d.useState(!0),[u,te]=d.useState(null),[F,le]=d.useState([]),[y,ne]=d.useState([]),[k,ie]=d.useState([]),[T,G]=d.useState(null),re=({embriao:s})=>{const a=s.acasalamento,t=a==null?void 0:a.dose_semen,n=t==null?void 0:t.touro,r=a==null?void 0:a.aspiracao,o=r==null?void 0:r.doadora,f=s.lote_fiv;return e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-500",children:"ID"}),e.jsx("p",{className:"font-medium",children:s.id})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-500",children:"Identificação"}),e.jsx("p",{className:"font-medium",children:s.identificacao||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-500",children:"Classificação"}),e.jsx("p",{className:"font-medium",children:s.classificacao||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-500",children:"Status"}),e.jsx("p",{className:"font-medium",children:s.status_atual||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-500",children:"Data de Congelamento"}),e.jsx("p",{className:"font-medium",children:s.data_congelamento?new Date(s.data_congelamento).toLocaleDateString("pt-BR"):"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-500",children:"Localização"}),e.jsx("p",{className:"font-medium",children:s.localizacao_atual||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-500",children:"Doadora"}),e.jsx("p",{className:"font-medium",children:(o==null?void 0:o.registro)||(o==null?void 0:o.nome)||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-500",children:"Touro"}),e.jsxs("p",{className:"font-medium",children:[(n==null?void 0:n.nome)||"-",n!=null&&n.registro?` (${n.registro})`:""]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-500",children:"Raça do Touro"}),e.jsx("p",{className:"font-medium",children:(n==null?void 0:n.raca)||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-500",children:"Data D0 (Lote FIV)"}),e.jsx("p",{className:"font-medium",children:f!=null&&f.data_abertura?new Date(f.data_abertura).toLocaleDateString("pt-BR"):"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-500",children:"Data de Aspiração (D-1)"}),e.jsx("p",{className:"font-medium",children:r!=null&&r.data_aspiracao?new Date(r.data_aspiracao).toLocaleDateString("pt-BR"):"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-500",children:"Hora de Aspiração"}),e.jsx("p",{className:"font-medium",children:(r==null?void 0:r.horario_aspiracao)||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-500",children:"Criado em"}),e.jsx("p",{className:"font-medium",children:s.created_at?new Date(s.created_at).toLocaleDateString("pt-BR"):"-"})]})]})},oe=s=>{G(s)},[ce,S]=d.useState(!1),[R,$]=d.useState(!1),[l,m]=d.useState({nome:"",sigla:"",localizacao:"",latitude:"",longitude:"",mapsLink:"",responsavel:"",contato_responsavel:""}),[q,D]=d.useState(null),[_,b]=d.useState(null);d.useEffect(()=>{p&&O()},[p]);const O=async()=>{try{P(!0);const{data:s,error:a}=await N.from("clientes").select("*").eq("id",p).single();if(a)throw a;te(s);const{data:t,error:n}=await N.from("fazendas").select("*").eq("cliente_id",p).order("nome",{ascending:!0});if(n)throw n;le(t||[]);const{data:r,error:o}=await N.from("doses_semen").select(`
          *,
          touro:touros(id, nome, registro, raca)
        `).eq("cliente_id",p).order("created_at",{ascending:!1});if(o)throw o;ne(r||[]);const{data:f,error:Z}=await N.from("embrioes").select(`
          *,
          lote_fiv:lotes_fiv(id, data_abertura),
          acasalamento:lote_fiv_acasalamentos(
            id,
            dose_semen:doses_semen(
              id,
              touro:touros(id, nome, registro, raca)
            ),
            aspiracao:aspiracoes_doadoras(
              id,
              data_aspiracao,
              horario_aspiracao,
              doadora:doadoras(id, registro, nome)
            )
          )
        `).eq("cliente_id",p).eq("status_atual","CONGELADO").order("data_congelamento",{ascending:!1});if(Z)throw Z;ie(f||[])}catch(s){C({title:"Erro ao carregar dados",description:s instanceof Error?s.message:"Erro desconhecido",variant:"destructive"})}finally{P(!1)}},de=s=>{if(s.latitude&&s.longitude){const a=Ce(s.latitude,s.longitude);window.open(a,"_blank")}else if(s.localizacao){const a=De(s.localizacao);window.open(a,"_blank")}},me=s=>s.latitude&&s.longitude||s.localizacao,xe=s=>{if(m({...l,mapsLink:s}),D(null),!s.trim())return;if(_e(s)){D("Links curtos (goo.gl) nao sao suportados. Abra o link no navegador e copie a URL completa.");return}const a=be(s);a&&m(t=>({...t,mapsLink:s,latitude:a.lat,longitude:a.lng}))},Q=(s,a)=>{const t={...l,[s]:a};if(m(t),t.latitude&&t.longitude){const n=parseFloat(t.latitude),r=parseFloat(t.longitude);b(Se(n,r))}else b(null)},[v,B]=d.useState(null),he=s=>{var a,t;m({nome:s.nome||"",sigla:s.sigla||"",localizacao:s.localizacao||"",latitude:((a=s.latitude)==null?void 0:a.toString())||"",longitude:((t=s.longitude)==null?void 0:t.toString())||"",mapsLink:"",responsavel:s.responsavel||"",contato_responsavel:s.contato_responsavel||""}),D(null),b(null),B(s),S(!0)},pe=async s=>{if(s.preventDefault(),!l.nome.trim()){C({title:"Erro de validação",description:"Nome da fazenda é obrigatório",variant:"destructive"});return}try{$(!0);const a={nome:l.nome,sigla:l.sigla.trim().toUpperCase()||null,localizacao:l.localizacao.trim()||null,latitude:l.latitude?parseFloat(l.latitude):null,longitude:l.longitude?parseFloat(l.longitude):null,responsavel:l.responsavel.trim()||null,contato_responsavel:l.contato_responsavel.trim()||null};if(v){const{error:t}=await N.from("fazendas").update(a).eq("id",v.id);if(t)throw t;C({title:"Fazenda atualizada",description:"Fazenda atualizada com sucesso"})}else{const{error:t}=await N.from("fazendas").insert([{...a,cliente_id:p}]);if(t)throw t;C({title:"Fazenda criada",description:"Fazenda criada com sucesso"})}S(!1),B(null),m({nome:"",sigla:"",localizacao:"",latitude:"",longitude:"",mapsLink:"",responsavel:"",contato_responsavel:""}),D(null),b(null),O()}catch(a){const t=a instanceof Error?a.message:"Erro desconhecido";C({title:v?"Erro ao atualizar fazenda":"Erro ao criar fazenda",description:t.includes("RLS")||t.includes("policy")?"RLS está bloqueando escrita. Configure políticas anon no Supabase.":t,variant:"destructive"})}finally{$(!1)}};return ae?e.jsx(ge,{}):u?e.jsxs("div",{className:"space-y-6",children:[e.jsx(Ee,{title:u.nome,description:"Detalhes do cliente",actions:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{variant:"outline",size:"icon",onClick:()=>V("/clientes"),children:e.jsx(ke,{className:"w-4 h-4"})}),e.jsx(J,{to:`/clientes/${p}/editar`,children:e.jsxs(x,{variant:"outline",children:[e.jsx(se,{className:"w-4 h-4 mr-2"}),"Editar"]})})]})}),e.jsxs(z,{children:[e.jsx(w,{children:e.jsx(L,{children:"Informações do Cliente"})}),e.jsxs(E,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Nome"}),e.jsx("p",{className:"text-base text-slate-900",children:u.nome})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Telefone"}),e.jsx("p",{className:"text-base text-slate-900",children:u.telefone||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Endereço"}),e.jsx("p",{className:"text-base text-slate-900",children:u.endereco||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Cadastrado em"}),e.jsx("p",{className:"text-base text-slate-900",children:u.created_at?new Date(u.created_at).toLocaleDateString("pt-BR"):"-"})]})]})]}),e.jsxs(we,{defaultValue:"fazendas",className:"w-full",children:[e.jsxs(Le,{children:[e.jsxs(H,{value:"fazendas",children:[e.jsx(ve,{className:"w-4 h-4 mr-2"}),"Fazendas (",F.length,")"]}),e.jsxs(H,{value:"doses",children:[e.jsx(fe,{className:"w-4 h-4 mr-2"}),"Doses de Sêmen (",y.length,")"]}),e.jsxs(H,{value:"embrioes",children:[e.jsx(Te,{className:"w-4 h-4 mr-2"}),"Embriões Congelados (",k.length,")"]})]}),e.jsx(I,{value:"fazendas",children:e.jsxs(z,{children:[e.jsx(w,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(L,{children:"Fazendas do Cliente"}),e.jsxs(K,{open:ce,onOpenChange:s=>{S(s),s||(B(null),m({nome:"",sigla:"",localizacao:"",latitude:"",longitude:"",mapsLink:"",responsavel:"",contato_responsavel:""}),D(null),b(null))},children:[e.jsx(ze,{asChild:!0,children:e.jsxs(x,{className:"bg-green-600 hover:bg-green-700",children:[e.jsx(Re,{className:"w-4 h-4 mr-2"}),"Nova Fazenda"]})}),e.jsxs(W,{className:"max-w-md",children:[e.jsxs(X,{children:[e.jsx(Y,{children:v?"Editar Fazenda":"Criar Nova Fazenda"}),e.jsx(ee,{children:v?`Editando ${v.nome}`:`Criar fazenda para ${u.nome}`})]}),e.jsxs("form",{onSubmit:pe,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"nome",children:"Nome da Fazenda *"}),e.jsx(j,{id:"nome",value:l.nome,onChange:s=>m({...l,nome:s.target.value}),placeholder:"Nome da fazenda",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"sigla",children:"Sigla (2-3 caracteres)"}),e.jsx(j,{id:"sigla",value:l.sigla,onChange:s=>{const a=s.target.value.toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,3);m({...l,sigla:a})},placeholder:"Ex: SC, BV",maxLength:3,className:"w-24 uppercase"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Usada para identificar embriões (ex: SC-2401-001)"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"localizacao",children:"Localização"}),e.jsx(j,{id:"localizacao",value:l.localizacao,onChange:s=>m({...l,localizacao:s.target.value}),placeholder:"Cidade, Estado"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"mapsLink",children:"Link do Google Maps"}),e.jsx(j,{id:"mapsLink",value:l.mapsLink,onChange:s=>xe(s.target.value),placeholder:"Cole aqui o link compartilhado do Maps",className:q?"border-red-500":""}),q&&e.jsx("p",{className:"text-xs text-red-500",children:q}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Cole um link do Google Maps para preencher as coordenadas automaticamente"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"latitude",children:"Latitude"}),e.jsx(j,{id:"latitude",type:"number",step:"any",value:l.latitude,onChange:s=>Q("latitude",s.target.value),placeholder:"-23.550520",className:_===!1?"border-red-500":_===!0?"border-green-500":""})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"longitude",children:"Longitude"}),e.jsx(j,{id:"longitude",type:"number",step:"any",value:l.longitude,onChange:s=>Q("longitude",s.target.value),placeholder:"-46.633308",className:_===!1?"border-red-500":_===!0?"border-green-500":""})]})]}),_===!1&&e.jsx("p",{className:"text-xs text-red-500",children:"Coordenadas fora do range valido (lat: -90 a 90, lng: -180 a 180)"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"responsavel",children:"Responsável"}),e.jsx(j,{id:"responsavel",value:l.responsavel,onChange:s=>m({...l,responsavel:s.target.value}),placeholder:"Nome do responsável"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"contato_responsavel",children:"Contato do Responsável"}),e.jsx(j,{id:"contato_responsavel",value:l.contato_responsavel,onChange:s=>m({...l,contato_responsavel:s.target.value}),placeholder:"Telefone ou email"})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(x,{type:"submit",className:"flex-1 bg-green-600 hover:bg-green-700",disabled:R,children:R?"Salvando...":v?"Salvar":"Criar Fazenda"}),e.jsx(x,{type:"button",variant:"outline",onClick:()=>S(!1),disabled:R,children:"Cancelar"})]})]})]})]})]})}),e.jsx(E,{children:e.jsxs(M,{children:[e.jsx(U,{children:e.jsxs(h,{children:[e.jsx(c,{children:"Nome"}),e.jsx(c,{children:"Sigla"}),e.jsx(c,{children:"Localização"}),e.jsx(c,{children:"Responsável"}),e.jsx(c,{className:"text-right",children:"Ações"})]})}),e.jsx(A,{children:F.length===0?e.jsx(h,{children:e.jsx(i,{colSpan:5,className:"text-center text-slate-500",children:"Nenhuma fazenda cadastrada"})}):F.map(s=>e.jsxs(h,{children:[e.jsx(i,{className:"font-medium",children:e.jsx(J,{to:`/fazendas/${s.id}`,className:"text-green-600 hover:text-green-700 hover:underline",children:s.nome})}),e.jsx(i,{children:s.sigla||"-"}),e.jsx(i,{children:s.localizacao||"-"}),e.jsx(i,{children:s.responsavel||"-"}),e.jsx(i,{className:"text-right",children:e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>he(s),children:e.jsx(se,{className:"w-4 h-4"})}),me(s)&&e.jsxs(x,{variant:"outline",size:"sm",onClick:()=>de(s),children:[e.jsx(Ne,{className:"w-4 h-4 mr-1"}),"Navegar"]})]})})]},s.id))})]})})]})}),e.jsx(I,{value:"doses",children:e.jsxs(z,{children:[e.jsx(w,{children:e.jsx(L,{children:"Doses de Sêmen"})}),e.jsx(E,{children:e.jsxs(M,{children:[e.jsx(U,{children:e.jsxs(h,{children:[e.jsx(c,{children:"Nome (Touro)"}),e.jsx(c,{children:"Raça"}),e.jsx(c,{children:"Tipo"}),e.jsx(c,{children:"Quantidade"})]})}),e.jsx(A,{children:y.length===0?e.jsx(h,{children:e.jsx(i,{colSpan:4,className:"text-center text-slate-500",children:"Nenhuma dose de sêmen cadastrada"})}):y.map(s=>{const a=s.touro;return e.jsxs(h,{children:[e.jsxs(i,{className:"font-medium",children:[(a==null?void 0:a.nome)||"Touro desconhecido",(a==null?void 0:a.registro)&&e.jsxs("span",{className:"text-slate-500 ml-2",children:["(",a.registro,")"]})]}),e.jsx(i,{children:(a==null?void 0:a.raca)||s.raca||"-"}),e.jsx(i,{children:s.tipo_semen||"-"}),e.jsx(i,{children:s.quantidade??"-"})]},s.id)})})]})})]})}),e.jsxs(I,{value:"embrioes",children:[e.jsxs(z,{children:[e.jsx(w,{children:e.jsx(L,{children:"Embriões Congelados no Estoque"})}),e.jsx(E,{children:e.jsxs(M,{children:[e.jsx(U,{children:e.jsxs(h,{children:[e.jsx(c,{children:"Identificação"}),e.jsx(c,{children:"Classificação"}),e.jsx(c,{children:"Doadora"}),e.jsx(c,{children:"Touro"}),e.jsx(c,{children:"Data Congelamento"}),e.jsx(c,{children:"Localização"}),e.jsx(c,{className:"text-right",children:"Ações"})]})}),e.jsx(A,{children:k.length===0?e.jsx(h,{children:e.jsx(i,{colSpan:7,className:"text-center text-slate-500",children:"Nenhum embrião congelado no estoque"})}):k.map(s=>{const a=s.acasalamento,t=a==null?void 0:a.dose_semen,n=t==null?void 0:t.touro,r=a==null?void 0:a.aspiracao,o=r==null?void 0:r.doadora;return e.jsxs(h,{children:[e.jsx(i,{className:"font-medium",children:s.identificacao||"-"}),e.jsx(i,{children:s.classificacao?e.jsx("span",{className:"px-2 py-1 text-xs font-medium rounded bg-purple-100 text-purple-800",children:s.classificacao}):"-"}),e.jsx(i,{children:(o==null?void 0:o.registro)||(o==null?void 0:o.nome)||"-"}),e.jsxs(i,{children:[(n==null?void 0:n.nome)||"-",(n==null?void 0:n.registro)&&e.jsxs("span",{className:"text-slate-500 ml-2",children:["(",n.registro,")"]})]}),e.jsx(i,{children:s.data_congelamento?new Date(s.data_congelamento).toLocaleDateString("pt-BR"):"-"}),e.jsx(i,{children:s.localizacao_atual||"-"}),e.jsx(i,{className:"text-right",children:e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>oe(s),children:"Detalhar"})})]},s.id)})})]})})]}),e.jsx(K,{open:!!T,onOpenChange:s=>!s&&G(null),children:e.jsxs(W,{className:"max-w-2xl",style:{opacity:1},children:[e.jsxs(X,{children:[e.jsx(Y,{children:"Detalhes do Embrião"}),e.jsx(ee,{children:"Informações completas do embrião congelado direcionado ao cliente."})]}),T&&e.jsx(re,{embriao:T})]})})]})]})]}):e.jsx("div",{className:"space-y-6",children:e.jsx(Fe,{title:"Cliente não encontrado",description:"Volte para a lista e selecione outro cliente.",action:e.jsx(x,{onClick:()=>V("/clientes"),variant:"outline",children:"Voltar para Clientes"})})})}export{ss as default};
