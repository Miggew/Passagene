import{a as k,r,s as p,j as e,g as q,h as m}from"./index-CvlUDCD-.js";import{u as V,C as $,a as H,b as M,c as G}from"./use-toast-BhbfqK05.js";import{I as _}from"./input-BiDTc9_9.js";import{L as n}from"./label-BIMTC7_j.js";import{T as X}from"./textarea-CWzGJoHk.js";import{S as J,a as K,b as Q,c as U,d as W}from"./select-CRV7QsOQ.js";import{P as Y,a as Z,b as ee}from"./popover-D6dVxm31.js";import{C as ae,a as se,b as ie,c as F,d as re,e as te}from"./command-CBz-a0vF.js";import{B as oe}from"./badge-C6XBkHcG.js";import{D as ne}from"./DatePickerBR-gAx3gAQT.js";import{A as de}from"./arrow-left-DavZAJTM.js";import{S as ce}from"./search-B2NaMPhp.js";import{X as le}from"./x-DpiajgWI.js";import"./index-BYe3zTS0.js";import"./index-CDlvsNjp.js";import"./check-BbN618wW.js";import"./dialog-DSJKtNd7.js";function Fe(){const u=k(),{toast:d}=V(),[E,j]=r.useState(!0),[h,g]=r.useState(!1),[z,w]=r.useState([]),f=r.useRef(0),[A,b]=r.useState([]),[T,v]=r.useState(!1),[B,N]=r.useState(!1),[s,t]=r.useState({fazenda_id:"",fazendas_destino_ids:[],data_aspiracao:new Date().toISOString().split("T")[0],horario_inicio:"",veterinario_responsavel:"",tecnico_responsavel:"",observacoes:""}),[c,C]=r.useState(""),D=c.trim(),I=D.length>=2,x=A.filter(a=>!s.fazendas_destino_ids.includes(a.id));r.useEffect(()=>{P()},[]),r.useEffect(()=>{const a=D;if(!a){b([]),v(!1);return}const i=++f.current;v(!0),p.from("fazendas").select("id, nome").ilike("nome",`%${a}%`).order("nome",{ascending:!0}).limit(50).then(({data:o,error:l})=>{i===f.current&&b(o||[])}).finally(()=>{i===f.current&&v(!1)})},[c]);const P=async()=>{try{j(!0);const{data:a,error:i}=await p.from("fazendas").select("id, nome").order("nome",{ascending:!0});if(i)throw i;w(a||[])}catch(a){d({title:"Erro ao carregar fazendas",description:a instanceof Error?a.message:"Erro desconhecido",variant:"destructive"})}finally{j(!1)}};r.useEffect(()=>{},[c,x.length]);const R=async a=>{if(a.preventDefault(),!s.fazenda_id||s.fazendas_destino_ids.length===0||!s.data_aspiracao){d({title:"Erro de validação",description:"Fazenda, pelo menos uma fazenda destino e data são obrigatórios",variant:"destructive"});return}if(!s.veterinario_responsavel.trim()){d({title:"Erro de validação",description:"Veterinário responsável é obrigatório",variant:"destructive"});return}if(!s.tecnico_responsavel.trim()){d({title:"Erro de validação",description:"Técnico responsável é obrigatório",variant:"destructive"});return}try{g(!0);const i=s.fazendas_destino_ids[0],o={fazenda_id:s.fazenda_id,fazenda_destino_id:i,data_aspiracao:s.data_aspiracao,horario_inicio:s.horario_inicio||null,veterinario_responsavel:s.veterinario_responsavel.trim(),tecnico_responsavel:s.tecnico_responsavel.trim(),observacoes:s.observacoes.trim()||null,status:"EM_ANDAMENTO"},{data:l,error:S}=await p.from("pacotes_aspiracao").insert([o]).select().single();if(S)throw S;const L=s.fazendas_destino_ids.map(O=>({pacote_aspiracao_id:l.id,fazenda_destino_id:O})),{error:y}=await p.from("pacotes_aspiracao_fazendas_destino").insert(L);if(y)throw y;d({title:"Aspiração criada",description:"Aspiração criada com sucesso"}),u(`/aspiracoes/${l.id}`)}catch(i){d({title:"Erro ao criar aspiração",description:i instanceof Error?i.message:"Erro desconhecido",variant:"destructive"})}finally{g(!1)}};return E?e.jsx(q,{}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(m,{onClick:()=>u("/aspiracoes"),variant:"outline",size:"icon",children:e.jsx(de,{className:"w-4 h-4"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-slate-900",children:"Nova Aspiração"}),e.jsx("p",{className:"text-slate-600 mt-1",children:"Criar nova aspiração"})]})]}),e.jsxs($,{children:[e.jsx(H,{children:e.jsx(M,{children:"Informações da Aspiração"})}),e.jsx(G,{children:e.jsxs("form",{onSubmit:R,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"fazenda_id",children:"Fazenda da Aspiração *"}),e.jsxs(J,{value:s.fazenda_id,onValueChange:a=>t({...s,fazenda_id:a}),children:[e.jsx(K,{children:e.jsx(Q,{placeholder:"Selecione a fazenda"})}),e.jsx(U,{children:z.map(a=>e.jsx(W,{value:a.id,children:a.nome},a.id))})]})]}),e.jsxs("div",{className:"space-y-2 col-span-2",children:[e.jsx(n,{children:"Fazendas Destino *"}),e.jsx("div",{className:"space-y-2",children:e.jsxs(Y,{open:B,onOpenChange:a=>{N(a)},children:[e.jsx(Z,{asChild:!0,children:e.jsxs(m,{variant:"outline",className:"w-full justify-between",children:[c.trim()===""?"Buscar/selecionar fazenda destino":`Busca: ${c}`,e.jsx(ce,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(ee,{className:"w-[400px] p-0",align:"start",children:e.jsxs(ae,{shouldFilter:!1,children:[e.jsx(se,{placeholder:"Buscar fazenda destino...",value:c,onValueChange:C}),e.jsx(ie,{children:I?T?e.jsx("div",{className:"p-2 text-sm text-slate-500",children:"Buscando..."}):x.length===0?e.jsx(F,{children:"Nenhuma fazenda encontrada"}):e.jsx(re,{children:x.map(a=>e.jsx(te,{value:`${a.nome} ${a.id}`,onSelect:()=>{s.fazendas_destino_ids.includes(a.id)||t({...s,fazendas_destino_ids:[...s.fazendas_destino_ids,a.id]}),C(""),N(!1)},children:a.nome},a.id))}):e.jsx(F,{children:"Digite pelo menos 2 letras para buscar"})})]})})]})}),s.fazendas_destino_ids.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:s.fazendas_destino_ids.map(a=>{const i=z.find(o=>o.id===a);return i?e.jsxs(oe,{variant:"outline",className:"flex items-center gap-1 pr-1",children:[i.nome,e.jsx("button",{type:"button",onClick:o=>{o.preventDefault(),t({...s,fazendas_destino_ids:s.fazendas_destino_ids.filter(l=>l!==a)})},className:"ml-1 hover:bg-slate-200 rounded-full p-0.5",children:e.jsx(le,{className:"w-3 h-3"})})]},a):null})}),s.fazendas_destino_ids.length===0&&e.jsx("p",{className:"text-sm text-slate-500",children:"Selecione pelo menos uma fazenda destino"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"data_aspiracao",children:"Data da Aspiração *"}),e.jsx(ne,{id:"data_aspiracao",value:s.data_aspiracao,onChange:a=>t({...s,data_aspiracao:a||""}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"horario_inicio",children:"Horário de Início"}),e.jsx(_,{id:"horario_inicio",type:"time",value:s.horario_inicio,onChange:a=>t({...s,horario_inicio:a.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"veterinario_responsavel",children:"Veterinário Responsável *"}),e.jsx(_,{id:"veterinario_responsavel",value:s.veterinario_responsavel,onChange:a=>t({...s,veterinario_responsavel:a.target.value}),placeholder:"Nome do veterinário",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"tecnico_responsavel",children:"Técnico Responsável *"}),e.jsx(_,{id:"tecnico_responsavel",value:s.tecnico_responsavel,onChange:a=>t({...s,tecnico_responsavel:a.target.value}),placeholder:"Nome do técnico",required:!0})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"observacoes",children:"Observações"}),e.jsx(X,{id:"observacoes",value:s.observacoes,onChange:a=>t({...s,observacoes:a.target.value}),placeholder:"Observações sobre a aspiração",rows:3})]}),e.jsxs("div",{className:"flex gap-4 pt-4",children:[e.jsx(m,{type:"submit",className:"flex-1 bg-green-600 hover:bg-green-700",disabled:h,children:h?"Criando...":"Criar Aspiração"}),e.jsx(m,{type:"button",variant:"outline",onClick:()=>u("/aspiracoes"),disabled:h,children:"Cancelar"})]})]})})]})]})}export{Fe as default};
