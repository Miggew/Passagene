import{r as t,s as C,j as e,g as xe,h as p}from"./index-CWtHucPz.js";import{u as pe,C as je,a as ge,b as ve,c as fe}from"./use-toast-C_ednEV-.js";import{T as _e,a as Se,b as M,c as j,d as Ce,e as x}from"./table-2v-HqcxP.js";import{D as Q,a as De,b as G,c as W,d as J,e as K}from"./dialog-DG0TUp-m.js";import{S as g,a as v,b as f,c as _,d as l}from"./select-BUr2m4f3.js";import{I as L}from"./input-bF23Jkur.js";import{L as d}from"./label-CDN-yMr6.js";import{P as Ne}from"./PageHeader-DqMTzrbX.js";import{E as Ee}from"./EmptyState-B00kV8BS.js";import{A as be,a as ye,b as we,c as Te,d as Ae,e as qe,f as Le,g as Oe}from"./alert-dialog-BfCZBKmD.js";import{B as U}from"./badge-DewFfdNp.js";import{P as Fe}from"./plus-CgYPqLq7.js";import{S as Ve}from"./square-pen-VnVIDeeL.js";import{T as Ie}from"./trash-2-xz0xDiTy.js";import"./index-RvRMy3My.js";import"./x-BtWTyRSy.js";import"./index-H2w26JuE.js";import"./check-D_BDiPDp.js";function ss(){const[Y,Z]=t.useState([]),[R,$]=t.useState([]),[z,ee]=t.useState([]),[se,B]=t.useState(!0),[ae,O]=t.useState(!1),[ie,b]=t.useState(!1),[te,F]=t.useState(!1),[u,S]=t.useState(!1),[H,X]=t.useState(null),[m,k]=t.useState(null),{toast:n}=pe(),[r,D]=t.useState({touro_id:"",cliente_id:"",tipo_semen:"",quantidade:""}),[o,N]=t.useState({touro_id:"",cliente_id:"",tipo_semen:"",quantidade:""}),[y,re]=t.useState(""),[V,oe]=t.useState(""),[I,ne]=t.useState("");t.useEffect(()=>{w()},[]);const w=async()=>{try{B(!0);const{data:s,error:i}=await C.from("touros").select("*").order("nome",{ascending:!0});if(i)throw i;$(s||[]);const{data:a,error:T}=await C.from("clientes").select("id, nome").order("nome",{ascending:!0});if(T)throw T;ee(a||[]);const{data:A,error:E}=await C.from("doses_semen").select("*").order("created_at",{ascending:!1});if(E)throw E;const q=new Map((s==null?void 0:s.map(c=>[c.id,c]))||[]),he=new Map((a==null?void 0:a.map(c=>[c.id,c.nome]))||[]),me=(A||[]).map(c=>{const h=q.get(c.touro_id);return{...c,cliente_nome:c.cliente_id?he.get(c.cliente_id):void 0,touro_nome:h==null?void 0:h.nome,touro_registro:h==null?void 0:h.registro,touro_raca:h==null?void 0:h.raca}});Z(me)}catch(s){n({title:"Erro ao carregar dados",description:s instanceof Error?s.message:"Erro desconhecido",variant:"destructive"})}finally{B(!1)}},le=async s=>{if(s.preventDefault(),!r.touro_id){n({title:"Erro de validação",description:"Selecione um touro do catálogo",variant:"destructive"});return}if(!r.cliente_id){n({title:"Erro de validação",description:"Selecione um cliente",variant:"destructive"});return}if(!r.tipo_semen){n({title:"Erro de validação",description:"Selecione o tipo de sêmen",variant:"destructive"});return}try{S(!0);const i={touro_id:r.touro_id,cliente_id:r.cliente_id,tipo_semen:r.tipo_semen,quantidade:parseInt(r.quantidade)||0},{error:a}=await C.from("doses_semen").insert([i]).select();if(a)throw a;n({title:"Dose criada",description:"Dose de sêmen criada com sucesso"}),O(!1),D({touro_id:"",cliente_id:"",tipo_semen:"",quantidade:""}),w()}catch(i){const a=i instanceof Error?i.message:"Erro desconhecido";n({title:"Erro ao criar dose",description:a.includes("RLS")||a.includes("policy")?"RLS está bloqueando escrita. Configure políticas anon no Supabase.":a,variant:"destructive"})}finally{S(!1)}},de=s=>{var i;X(s),N({touro_id:s.touro_id,cliente_id:s.cliente_id||"",tipo_semen:s.tipo_semen||"",quantidade:((i=s.quantidade)==null?void 0:i.toString())||""}),b(!0)},ce=async s=>{if(s.preventDefault(),!!H){if(!o.touro_id){n({title:"Erro de validação",description:"Selecione um touro do catálogo",variant:"destructive"});return}if(!o.cliente_id){n({title:"Erro de validação",description:"Selecione um cliente",variant:"destructive"});return}try{S(!0);const i={touro_id:o.touro_id,cliente_id:o.cliente_id,tipo_semen:o.tipo_semen,quantidade:parseInt(o.quantidade)||0},{error:a}=await C.from("doses_semen").update(i).eq("id",H.id);if(a)throw a;n({title:"Dose atualizada",description:"Dose de sêmen atualizada com sucesso"}),b(!1),X(null),w()}catch(i){const a=i instanceof Error?i.message:"Erro desconhecido";n({title:"Erro ao atualizar dose",description:a.includes("RLS")||a.includes("policy")?"RLS está bloqueando escrita. Configure políticas anon no Supabase.":a,variant:"destructive"})}finally{S(!1)}}},ue=async()=>{if(m)try{S(!0);const{error:s}=await C.from("doses_semen").delete().eq("id",m.id);if(s)throw s;n({title:"Dose excluída",description:"Dose de sêmen excluída com sucesso"}),F(!1),k(null),w()}catch(s){const i=s instanceof Error?s.message:"Erro desconhecido";n({title:"Erro ao excluir dose",description:i,variant:"destructive"})}finally{S(!1)}},P=Y.filter(s=>{var A,E,q;const i=!y||((A=s.touro_nome)==null?void 0:A.toLowerCase().includes(y.toLowerCase()))||((E=s.touro_registro)==null?void 0:E.toLowerCase().includes(y.toLowerCase())),a=!V||((q=s.cliente_nome)==null?void 0:q.toLowerCase().includes(V.toLowerCase())),T=!I||s.tipo_semen===I;return i&&a&&T});return se?e.jsx(xe,{}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(Ne,{title:"Doses de Sêmen",description:"Gerenciar doses de sêmen dos clientes relacionadas aos touros do catálogo",actions:e.jsxs(Q,{open:ae,onOpenChange:O,children:[e.jsx(De,{asChild:!0,children:e.jsxs(p,{className:"bg-green-600 hover:bg-green-700",children:[e.jsx(Fe,{className:"w-4 h-4 mr-2"}),"Nova Dose"]})}),e.jsxs(G,{className:"max-w-md",children:[e.jsxs(W,{children:[e.jsx(J,{children:"Criar Nova Dose de Sêmen"}),e.jsx(K,{children:"Selecione um touro do catálogo e um cliente para criar a dose"})]}),e.jsxs("form",{onSubmit:le,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"touro_id",children:"Touro do Catálogo *"}),e.jsxs(g,{value:r.touro_id,onValueChange:s=>D({...r,touro_id:s}),children:[e.jsx(v,{children:e.jsx(f,{placeholder:"Selecione o touro"})}),e.jsx(_,{children:R.map(s=>e.jsxs(l,{value:s.id,children:[s.nome," (",s.registro,")"]},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"cliente_id",children:"Cliente *"}),e.jsxs(g,{value:r.cliente_id,onValueChange:s=>D({...r,cliente_id:s}),children:[e.jsx(v,{children:e.jsx(f,{placeholder:"Selecione o cliente"})}),e.jsx(_,{children:z.map(s=>e.jsx(l,{value:s.id,children:s.nome},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"tipo_semen",children:"Tipo de Sêmen *"}),e.jsxs(g,{value:r.tipo_semen,onValueChange:s=>D({...r,tipo_semen:s}),children:[e.jsx(v,{children:e.jsx(f,{placeholder:"Selecione o tipo"})}),e.jsxs(_,{children:[e.jsx(l,{value:"CONVENCIONAL",children:"CONVENCIONAL"}),e.jsx(l,{value:"SEXADO",children:"SEXADO"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"quantidade",children:"Quantidade"}),e.jsx(L,{id:"quantidade",type:"number",min:"0",value:r.quantidade,onChange:s=>D({...r,quantidade:s.target.value}),placeholder:"Quantidade de doses"})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(p,{type:"submit",className:"flex-1 bg-green-600 hover:bg-green-700",disabled:u,children:u?"Salvando...":"Salvar"}),e.jsx(p,{type:"button",variant:"outline",onClick:()=>O(!1),disabled:u,children:"Cancelar"})]})]})]})]})}),e.jsxs(je,{children:[e.jsx(ge,{children:e.jsx(ve,{children:"Lista de Doses de Sêmen"})}),e.jsxs(fe,{children:[e.jsx("div",{className:"space-y-4 mb-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Filtrar por Touro"}),e.jsx(L,{placeholder:"Buscar por nome ou registro do touro...",value:y,onChange:s=>re(s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Filtrar por Cliente"}),e.jsx(L,{placeholder:"Buscar por nome do cliente...",value:V,onChange:s=>oe(s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Filtrar por Tipo"}),e.jsxs(g,{value:I||"all",onValueChange:s=>ne(s==="all"?"":s),children:[e.jsx(v,{children:e.jsx(f,{placeholder:"Todos os tipos"})}),e.jsxs(_,{children:[e.jsx(l,{value:"all",children:"Todos os tipos"}),e.jsx(l,{value:"CONVENCIONAL",children:"CONVENCIONAL"}),e.jsx(l,{value:"SEXADO",children:"SEXADO"})]})]})]})]})}),e.jsxs(_e,{children:[e.jsx(Se,{children:e.jsxs(M,{children:[e.jsx(j,{children:"Touro"}),e.jsx(j,{children:"Registro"}),e.jsx(j,{children:"Raça"}),e.jsx(j,{children:"Cliente"}),e.jsx(j,{children:"Tipo"}),e.jsx(j,{children:"Quantidade"}),e.jsx(j,{className:"text-right",children:"Ações"})]})}),e.jsx(Ce,{children:P.length===0?e.jsx(M,{children:e.jsx(x,{colSpan:7,className:"text-center text-slate-500",children:e.jsx(Ee,{title:"Nenhuma dose cadastrada",description:"Cadastre a primeira dose para começar."})})}):P.map(s=>e.jsxs(M,{children:[e.jsx(x,{className:"font-medium",children:s.touro_nome||"-"}),e.jsx(x,{children:s.touro_registro||"-"}),e.jsx(x,{children:s.touro_raca?e.jsx(U,{variant:"outline",children:s.touro_raca}):"-"}),e.jsx(x,{children:s.cliente_nome||"-"}),e.jsx(x,{children:s.tipo_semen?e.jsx(U,{variant:"secondary",children:s.tipo_semen}):"-"}),e.jsx(x,{children:s.quantidade??"-"}),e.jsx(x,{className:"text-right",children:e.jsxs("div",{className:"flex gap-1 justify-end",children:[e.jsx(p,{variant:"ghost",size:"sm",onClick:()=>de(s),children:e.jsx(Ve,{className:"w-4 h-4"})}),e.jsx(p,{variant:"ghost",size:"sm",onClick:()=>{k(s),F(!0)},children:e.jsx(Ie,{className:"w-4 h-4 text-red-600"})})]})})]},s.id))})]})]})]}),e.jsx(Q,{open:ie,onOpenChange:b,children:e.jsxs(G,{className:"max-w-md",children:[e.jsxs(W,{children:[e.jsx(J,{children:"Editar Dose de Sêmen"}),e.jsx(K,{children:"Atualizar dados da dose"})]}),e.jsxs("form",{onSubmit:ce,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"edit_touro_id",children:"Touro do Catálogo *"}),e.jsxs(g,{value:o.touro_id,onValueChange:s=>N({...o,touro_id:s}),children:[e.jsx(v,{children:e.jsx(f,{placeholder:"Selecione o touro"})}),e.jsx(_,{children:R.map(s=>e.jsxs(l,{value:s.id,children:[s.nome," (",s.registro,")"]},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"edit_cliente_id",children:"Cliente *"}),e.jsxs(g,{value:o.cliente_id,onValueChange:s=>N({...o,cliente_id:s}),children:[e.jsx(v,{children:e.jsx(f,{placeholder:"Selecione o cliente"})}),e.jsx(_,{children:z.map(s=>e.jsx(l,{value:s.id,children:s.nome},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"edit_tipo_semen",children:"Tipo de Sêmen *"}),e.jsxs(g,{value:o.tipo_semen,onValueChange:s=>N({...o,tipo_semen:s}),children:[e.jsx(v,{children:e.jsx(f,{placeholder:"Selecione o tipo"})}),e.jsxs(_,{children:[e.jsx(l,{value:"CONVENCIONAL",children:"CONVENCIONAL"}),e.jsx(l,{value:"SEXADO",children:"SEXADO"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"edit_quantidade",children:"Quantidade"}),e.jsx(L,{id:"edit_quantidade",type:"number",min:"0",value:o.quantidade,onChange:s=>N({...o,quantidade:s.target.value}),placeholder:"Quantidade de doses"})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(p,{type:"submit",className:"flex-1 bg-green-600 hover:bg-green-700",disabled:u,children:u?"Salvando...":"Salvar Alterações"}),e.jsx(p,{type:"button",variant:"outline",onClick:()=>b(!1),disabled:u,children:"Cancelar"})]})]})]})}),e.jsx(be,{open:te,onOpenChange:F,children:e.jsxs(ye,{children:[e.jsxs(we,{children:[e.jsx(Te,{children:"Confirmar Exclusão"}),e.jsxs(Ae,{children:['Tem certeza que deseja excluir a dose do touro "',m==null?void 0:m.touro_nome,'" do cliente "',m==null?void 0:m.cliente_nome,'"? Esta ação não pode ser desfeita.']})]}),e.jsxs(qe,{children:[e.jsx(Le,{disabled:u,children:"Cancelar"}),e.jsx(Oe,{onClick:ue,disabled:u,className:"bg-red-600 hover:bg-red-700",children:u?"Excluindo...":"Excluir"})]})]})})]})}export{ss as default};
