import{c as Je,r as t,s as v,j as e,a as Ye,B as x,g as Ze}from"./index-DM5u2d-F.js";import{C as He,a as Qe,b as We,d as Re}from"./card-B_EQ6x91.js";import{T as pa,a as xa,b as ea,c as he,d as ga,e as ue}from"./table-CEKyj1ed.js";import{D as ze,b as ye,c as Pe,d as Be,e as qe,f as _a}from"./dialog-2y4jBKyr.js";import{S as Ue,a as Ve,b as Ge,c as Xe,d as xe,C as ja,e as va}from"./select-B_NoJ61H.js";import{I as Ca}from"./input-CtUEWea1.js";import{L as be}from"./label-Bhhf9ayq.js";import{P as Da}from"./PageHeader-JgO8x5IE.js";import{E as wa}from"./EmptyState-ChaxWsz8.js";import{S as na}from"./StatusBadge-CySQHNUG.js";import{B as pe}from"./badge-D_AVhbx8.js";import{u as ca}from"./use-toast-BOUGyrIz.js";import{T as ba}from"./textarea-Kj1o8r55.js";import{T as la,S as Sa,a as Ea,b as Na,c as za,d as ya}from"./sheet-D_5EJbIK.js";import{D as aa}from"./DatePickerBR-BEWFLeoy.js";import{h as $e}from"./error-handler-BKHO4AyN.js";import{T as sa}from"./triangle-alert-ha7v3V29.js";import{S as Pa}from"./square-pen-Cfxri2C7.js";import{P as Ba}from"./package-D-Y95y60.js";import{S as da}from"./snowflake-DcJSD3Yt.js";import{T as ma}from"./trash-2-Bf7rr4V6.js";import{H as ka}from"./history-Xos89q5T.js";import"./index-CWb7Yp_3.js";import"./index-sCsFC1oc.js";import"./x-DsJYRTDR.js";import"./index-ClZPXJQX.js";import"./index-BEVMOrkK.js";import"./check-Y5eEMkO8.js";import"./statusLabels-IklKT8dE.js";import"./popover-CNdtTvFz.js";import"./calendar-B_KmJ-VL.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ta=Je("SquareCheckBig",[["path",{d:"M21 10.5V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h12.5",key:"1uzm8b"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ia=Je("Square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fa=Je("User",[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]]),ha="embrioes_filtros",oa=20,Ma=()=>{try{const h=localStorage.getItem(ha);return h?JSON.parse(h):{}}catch{return{}}},Aa=h=>{if(!h)return null;const w=new Date,z=w.getFullYear()+"-"+String(w.getMonth()+1).padStart(2,"0")+"-"+String(w.getDate()).padStart(2,"0"),[b,m,n]=z.split("-").map(Number),[y,_,H]=h.split("-").map(Number),oe=Date.UTC(b,m-1,n),R=Date.UTC(y,_-1,H);return Math.floor((oe-R)/(1e3*60*60*24))};function Ta(){const h=t.useMemo(()=>Ma(),[]),[w,z]=t.useState([]),[b,m]=t.useState([]),[n,y]=t.useState([]),[_,H]=t.useState([]),[oe,R]=t.useState(!1),[O,re]=t.useState(h.selectedFazendaDestinoId??""),[te,q]=t.useState(h.paginasPacotes??{}),[k,I]=t.useState({});t.useEffect(()=>{const o={selectedFazendaDestinoId:O,paginasPacotes:te};localStorage.setItem(ha,JSON.stringify(o))},[O,te]),t.useEffect(()=>{q(o=>{let r=!1;const g={...o};return b.forEach(S=>{const C=Math.max(1,Math.ceil(S.embrioes.length/oa));if(!g[S.id]){g[S.id]=1,r=!0;return}g[S.id]>C&&(g[S.id]=C,r=!0)}),r?g:o})},[b]);const K=t.useCallback(o=>(k[o.id]??o.classificacao??"").trim(),[k]),T=t.useCallback(o=>{const r={BE:0,BN:0,BX:0,BL:0,BI:0};let g=0;return o.embrioes.forEach(S=>{const C=K(S).toUpperCase();if(!C){g+=1;return}C==="BE"?r.BE+=1:C==="BN"?r.BN+=1:C==="BX"?r.BX+=1:C==="BL"?r.BL+=1:C==="BI"&&(r.BI+=1)}),{semClassificacao:g,classificados:r,total:o.total,todosClassificados:o.total>0&&g===0}},[K]),B=t.useCallback(async()=>{try{const{data:o,error:r}=await v.from("fazendas").select("id, nome").order("nome",{ascending:!0});if(r)throw r;y(o||[])}catch(o){$e(o,"Erro ao carregar fazendas")}},[]),V=t.useCallback(async()=>{try{const{data:o,error:r}=await v.from("clientes").select("id, nome").order("nome",{ascending:!0});if(r)throw r;H(o||[])}catch(o){$e(o,"Erro ao carregar clientes")}},[]),l=t.useCallback(async()=>{try{R(!0);const{data:o,error:r}=await v.from("embrioes").select("*").in("status_atual",["FRESCO","CONGELADO"]).is("cliente_id",null).order("created_at",{ascending:!1});if(r)throw r;if(!o||o.length===0){z([]),m([]),R(!1);return}const g=[...new Set(o.filter(a=>a.lote_fiv_acasalamento_id).map(a=>a.lote_fiv_acasalamento_id))],S=[...new Set(o.filter(a=>a.lote_fiv_id).map(a=>a.lote_fiv_id))],C=[...new Set(o.filter(a=>a.fazenda_destino_id).map(a=>a.fazenda_destino_id))];if(g.length===0){z(o),m([]),R(!1);return}const[F,ke]=await Promise.all([v.from("lote_fiv_acasalamentos").select("id, aspiracao_doadora_id, dose_semen_id").in("id",g),S.length>0?v.from("lotes_fiv").select("id, pacote_aspiracao_id, data_fecundacao").in("id",S):Promise.resolve({data:null,error:null})]);if(F.error)throw F.error;const Y=F.data||[],Z=ke.data||[],de=[...new Set(Y.map(a=>a.aspiracao_doadora_id))],Se=[...new Set(Y.map(a=>a.dose_semen_id))],ie=[...new Set(Z.map(a=>a.pacote_aspiracao_id).filter(Boolean))],L=new Map,ne=new Map;Z.forEach(a=>{a.pacote_aspiracao_id&&L.set(a.id,a.pacote_aspiracao_id),a.data_fecundacao&&ne.set(a.id,a.data_fecundacao)});const[$,Q,Me]=await Promise.all([de.length>0?v.from("aspiracoes_doadoras").select("id, doadora_id, pacote_aspiracao_id").in("id",de):Promise.resolve({data:null,error:null}),Se.length>0?v.from("doses_semen").select("id, touro_id, touro:touros(id, nome, registro, raca)").in("id",Se):Promise.resolve({data:null,error:null}),ie.length>0?v.from("pacotes_aspiracao").select("id, data_aspiracao, fazenda_id, fazenda_destino_id, horario_inicio, veterinario_responsavel, total_oocitos").in("id",ie):Promise.resolve({data:null,error:null})]);if($.error)throw $.error;if(Q.error)throw Q.error;const ce=$.data||[],W=Q.data||[],ee=Me.data||[],ae=[...new Set(ce.map(a=>a.doadora_id))],E=new Set(C);ee.forEach(a=>{a.fazenda_id&&E.add(a.fazenda_id),a.fazenda_destino_id&&E.add(a.fazenda_destino_id)});const[ge,Ee,U]=await Promise.all([ae.length>0?v.from("doadoras").select("id, registro").in("id",ae):Promise.resolve({data:null,error:null}),E.size>0?v.from("fazendas").select("id, nome").in("id",Array.from(E)):Promise.resolve({data:null,error:null}),ie.length>0?v.from("pacotes_aspiracao_fazendas_destino").select("pacote_aspiracao_id, fazenda_destino_id").in("pacote_aspiracao_id",ie):Promise.resolve({data:null,error:null})]);if(ge.error)throw ge.error;const _e=ge.data||[],Ne=Ee.data||[],Ae=U.data||[],M=new Map(Ne.map(a=>[a.id,a.nome])),le=new Map;Ae.forEach(a=>{const N=le.get(a.pacote_aspiracao_id)||[];N.includes(a.fazenda_destino_id)||N.push(a.fazenda_destino_id),le.set(a.pacote_aspiracao_id,N)}),ee.forEach(a=>{if(a.fazenda_destino_id){const N=le.get(a.id)||[];N.includes(a.fazenda_destino_id)||N.push(a.fazenda_destino_id),le.set(a.id,N)}});const je=new Map;ce.forEach(a=>{a.pacote_aspiracao_id&&je.set(a.pacote_aspiracao_id,(je.get(a.pacote_aspiracao_id)||0)+1)});const ve=new Map;ee.forEach(a=>{ve.set(a.id,{id:a.id,data_aspiracao:a.data_aspiracao,fazenda_nome:M.get(a.fazenda_id),quantidade_doadoras:je.get(a.id)||0,horario_inicio:a.horario_inicio,veterinario_responsavel:a.veterinario_responsavel,total_oocitos:a.total_oocitos})});const Te=new Map(ce.map(a=>[a.id,a])),Fe=new Map(_e.map(a=>[a.id,a])),i=new Map(W.map(a=>[a.id,a])),c=new Map(Y.map(a=>[a.id,a])),d=o.map(a=>{var A;const N=a.lote_fiv_acasalamento_id?c.get(a.lote_fiv_acasalamento_id):void 0,se=N?Te.get(N.aspiracao_doadora_id):void 0,X=se?Fe.get(se.doadora_id):void 0,Ce=N?i.get(N.dose_semen_id):void 0,fe=a.lote_fiv_id?L.get(a.lote_fiv_id):void 0,De=fe?ve.get(fe):void 0;return{...a,doadora_registro:X==null?void 0:X.registro,touro_nome:(A=Ce==null?void 0:Ce.touro)==null?void 0:A.nome,fazenda_destino_nome:a.fazenda_destino_id?M.get(a.fazenda_destino_id):void 0,data_aspiracao:De==null?void 0:De.data_aspiracao,pacote_aspiracao_id:fe}}),u=O?d.filter(a=>a.fazenda_destino_id===O):d;z(u);const p=new Map;u.forEach(a=>{var s;if(!a.lote_fiv_id)return;const N=((s=a.created_at)==null?void 0:s.split("T")[0])||"",se=`${a.lote_fiv_id}_${N}`,X=a.lote_fiv_id?L.get(a.lote_fiv_id):void 0,Ce=X?ve.get(X):void 0,fe=X?le.get(X)||[]:[],De=fe.map(j=>M.get(j)||"N/A");p.has(se)||p.set(se,{id:se,lote_fiv_id:a.lote_fiv_id,data_despacho:N,data_fecundacao:a.lote_fiv_id?ne.get(a.lote_fiv_id):void 0,fazendas_destino_ids:fe,fazendas_destino_nomes:De,pacote_info:Ce||{id:X||"",data_aspiracao:"",quantidade_doadoras:0},embrioes:[],total:0,frescos:0,congelados:0,sem_classificacao:0,classificados:{BE:0,BN:0,BX:0,BL:0,BI:0}});const A=p.get(se);if(A.embrioes.push(a),A.total++,a.status_atual==="FRESCO"&&A.frescos++,a.status_atual==="CONGELADO"&&A.congelados++,!a.classificacao)A.sem_classificacao++;else{const j=a.classificacao.toUpperCase();j==="BE"?A.classificados.BE++:j==="BN"?A.classificados.BN++:j==="BX"?A.classificados.BX++:j==="BL"?A.classificados.BL++:j==="BI"&&A.classificados.BI++}});const me=Array.from(p.values()).sort((a,N)=>{const se=new Date(a.data_despacho).getTime();return new Date(N.data_despacho).getTime()-se});me.forEach(a=>{a.todos_classificados=a.total>0&&a.sem_classificacao===0,a.disponivel_para_transferencia=a.todos_classificados&&a.frescos>0}),m(me)}catch(o){$e(o,"Erro ao carregar embriões")}finally{R(!1)}},[O]),G=t.useCallback(async()=>{await l()},[l]);return{embrioes:w,pacotes:b,fazendas:n,clientes:_,loading:oe,selectedFazendaDestinoId:O,setSelectedFazendaDestinoId:re,paginasPacotes:te,setPaginasPacotes:q,pageSize:oa,loadData:l,loadFazendas:B,loadClientes:V,reloadData:G,getClassificacaoAtual:K,getResumoPacote:T,classificacoesPendentes:k,setClassificacoesPendentes:I}}const Oe=async(h,w,z,b,m,n)=>{try{await v.from("historico_embrioes").insert([{embriao_id:h,status_anterior:w,status_novo:z,tipo_operacao:b,fazenda_id:m||null,observacoes:n||null,data_mudanca:new Date().toISOString()}])}catch{}};function Fa({embrioes:h,pacotes:w,classificacoesPendentes:z,setClassificacoesPendentes:b,onSuccess:m}){const{toast:n}=ca(),y=new Date().toISOString().split("T")[0],[_,H]=t.useState(new Set),[oe,R]=t.useState(!1),[O,re]=t.useState(!1),[te,q]=t.useState(!1),[k,I]=t.useState(!1),[K,T]=t.useState(!1),[B,V]=t.useState(!1),[l,G]=t.useState(!1),[o,r]=t.useState({data_congelamento:y,localizacao_atual:""}),[g,S]=t.useState({data_descarte:y,observacoes:""}),[C,F]=t.useState({cliente_id:""}),[ke,Y]=t.useState(null),[Z,de]=t.useState(null),[Se,ie]=t.useState(null),[L,ne]=t.useState(null),[$,Q]=t.useState([]),[Me,ce]=t.useState([]),[W,ee]=t.useState(!1),[ae,E]=t.useState(!1),ge=t.useCallback(i=>{H(c=>{const d=new Set(c);return d.has(i)?d.delete(i):d.add(i),d})},[]),Ee=t.useCallback(i=>{const c=w.find(p=>p.id===i);if(!c)return;const d=c.embrioes.filter(p=>p.status_atual==="FRESCO").map(p=>p.id),u=d.every(p=>_.has(p));H(p=>{const me=new Set(p);return u?d.forEach(a=>me.delete(a)):d.forEach(a=>me.add(a)),me})},[w,_]),U=t.useCallback(()=>{H(new Set),R(!1)},[]),_e=t.useCallback(i=>_.has(i),[_]),Ne=t.useCallback(async i=>{try{ee(!0);const{data:c,error:d}=await v.from("historico_embrioes").select("*, fazenda:fazendas(nome)").eq("embriao_id",i).order("data_mudanca",{ascending:!1});if(d)throw d;ce(c||[])}catch(c){n({title:"Erro ao carregar histórico",description:c instanceof Error?c.message:"Erro desconhecido",variant:"destructive"})}finally{ee(!1)}},[n]),Ae=t.useCallback(async()=>{if(_.size===0){n({title:"Nenhum embrião selecionado",description:"Selecione pelo menos um embrião para congelar.",variant:"destructive"});return}if(!o.localizacao_atual.trim()){n({title:"Localização obrigatória",description:"Informe a localização de armazenamento.",variant:"destructive"});return}try{E(!0);const i=Array.from(_),{error:c}=await v.from("embrioes").update({status_atual:"CONGELADO",data_congelamento:o.data_congelamento,localizacao_atual:o.localizacao_atual.trim()}).in("id",i);if(c)throw c;for(const d of i){const u=h.find(p=>p.id===d);await Oe(d,(u==null?void 0:u.status_atual)||null,"CONGELADO","CONGELAMENTO",null,`Congelado em ${o.localizacao_atual.trim()}`)}n({title:"Embriões congelados",description:`${i.length} embrião(ões) congelado(s) com sucesso.`}),re(!1),U(),r({data_congelamento:y,localizacao_atual:""}),await m()}catch(i){n({title:"Erro ao congelar embriões",description:i instanceof Error?i.message:"Erro desconhecido",variant:"destructive"})}finally{E(!1)}},[_,o,h,y,n,U,m]),M=t.useCallback(async()=>{if(_.size===0){n({title:"Nenhum embrião selecionado",description:"Selecione pelo menos um embrião para descartar.",variant:"destructive"});return}try{E(!0);const i=Array.from(_),{error:c}=await v.from("embrioes").update({status_atual:"DESCARTADO",data_descarte:g.data_descarte,observacoes:g.observacoes.trim()||null}).in("id",i);if(c)throw c;for(const d of i){const u=h.find(p=>p.id===d);await Oe(d,(u==null?void 0:u.status_atual)||null,"DESCARTADO","DESCARTE",null,g.observacoes.trim()||null)}n({title:"Embriões descartados",description:`${i.length} embrião(ões) descartado(s).`}),q(!1),U(),S({data_descarte:y,observacoes:""}),await m()}catch(i){n({title:"Erro ao descartar embriões",description:i instanceof Error?i.message:"Erro desconhecido",variant:"destructive"})}finally{E(!1)}},[_,g,h,y,n,U,m]),le=t.useCallback(async i=>{if(_.size===0){n({title:"Nenhum embrião selecionado",description:"Selecione pelo menos um embrião.",variant:"destructive"});return}if(!C.cliente_id){n({title:"Cliente não selecionado",description:"Selecione o cliente de destino.",variant:"destructive"});return}try{E(!0);const c=Array.from(_),{error:d}=await v.from("embrioes").update({cliente_id:C.cliente_id}).in("id",c);if(d)throw d;const u=i.find(p=>p.id===C.cliente_id);for(const p of c)await Oe(p,null,"DIRECIONADO","DESTINACAO",null,`Direcionado para cliente: ${(u==null?void 0:u.nome)||"N/A"}`);n({title:"Embriões direcionados",description:`${c.length} embrião(ões) direcionado(s) para ${(u==null?void 0:u.nome)||"cliente"}.`}),T(!1),U(),F({cliente_id:""}),await m()}catch(c){n({title:"Erro ao direcionar embriões",description:c instanceof Error?c.message:"Erro desconhecido",variant:"destructive"})}finally{E(!1)}},[_,C,n,U,m]),je=t.useCallback(async()=>{const i=Object.entries(z);if(i.length===0){n({title:"Nenhuma classificação pendente",description:"Não há classificações para salvar."});return}try{E(!0);for(const[c,d]of i){const{error:u}=await v.from("embrioes").update({classificacao:d.toUpperCase()}).eq("id",c);if(u)throw u;await Oe(c,null,d.toUpperCase(),"CLASSIFICACAO",null,`Classificado como ${d.toUpperCase()}`)}n({title:"Classificações salvas",description:`${i.length} embrião(ões) classificado(s).`}),b({}),await m()}catch(c){n({title:"Erro ao salvar classificações",description:c instanceof Error?c.message:"Erro desconhecido",variant:"destructive"})}finally{E(!1)}},[z,b,n,m]),ve=t.useCallback(async()=>{I(!1),Y(null)},[]),Te=t.useCallback(async()=>{if(Z)try{E(!0);const{error:i}=await v.from("embrioes").update({status_atual:"DESCARTADO",data_descarte:g.data_descarte,observacoes:g.observacoes.trim()||null}).eq("id",Z.id);if(i)throw i;await Oe(Z.id,Z.status_atual,"DESCARTADO","DESCARTE",null,g.observacoes.trim()||null),n({title:"Embrião descartado",description:"Embrião descartado com sucesso."}),q(!1),de(null),S({data_descarte:y,observacoes:""}),await m()}catch(i){n({title:"Erro ao descartar embrião",description:i instanceof Error?i.message:"Erro desconhecido",variant:"destructive"})}finally{E(!1)}},[Z,g,y,n,m]),Fe=t.useCallback(async()=>{if(L)try{if(E(!0),await v.from("pacotes_aspiracao_fazendas_destino").delete().eq("pacote_aspiracao_id",L.pacote_info.id),$.length>0){const i=$.map(d=>({pacote_aspiracao_id:L.pacote_info.id,fazenda_destino_id:d})),{error:c}=await v.from("pacotes_aspiracao_fazendas_destino").insert(i);if(c)throw c}n({title:"Fazendas destino atualizadas",description:"As fazendas destino foram atualizadas com sucesso."}),G(!1),ne(null),Q([]),await m()}catch(i){n({title:"Erro ao salvar fazendas destino",description:i instanceof Error?i.message:"Erro desconhecido",variant:"destructive"})}finally{E(!1)}},[L,$,n,m]);return{embrioesSelecionados:_,setEmbrioesSelecionados:H,showAcoesEmMassa:oe,setShowAcoesEmMassa:R,showCongelarDialog:O,setShowCongelarDialog:re,showDescartarDialog:te,setShowDescartarDialog:q,showClassificarDialog:k,setShowClassificarDialog:I,showDirecionarClienteDialog:K,setShowDirecionarClienteDialog:T,showHistoricoDialog:B,setShowHistoricoDialog:V,showEditarFazendasDestinoDialog:l,setShowEditarFazendasDestinoDialog:G,congelarData:o,setCongelarData:r,descartarData:g,setDescartarData:S,direcionarClienteData:C,setDirecionarClienteData:F,classificarEmbriao:ke,setClassificarEmbriao:Y,descartarEmbriao:Z,setDescartarEmbriao:de,historicoEmbriao:Se,setHistoricoEmbriao:ie,pacoteEditandoFazendas:L,setPacoteEditandoFazendas:ne,fazendasDestinoSelecionadas:$,setFazendasDestinoSelecionadas:Q,historico:Me,loadingHistorico:W,submitting:ae,handleCongelarEmMassa:Ae,handleDescartarEmMassa:M,handleDirecionarClienteEmMassa:le,handleSalvarClassificacoesPendentes:je,handleClassificarEmbriao:ve,handleDescartarEmbriao:Te,loadHistorico:Ne,handleSalvarFazendasDestino:Fe,toggleEmbriaoSelecionado:ge,selecionarTodosPacote:Ee,limparSelecao:U,isEmbriaoSelecionado:_e}}function ps(){var A;const{toast:h}=ca(),{embrioes:w,pacotes:z,fazendas:b,clientes:m,loading:n,selectedFazendaDestinoId:y,setSelectedFazendaDestinoId:_,paginasPacotes:H,setPaginasPacotes:oe,pageSize:R,loadData:O,loadFazendas:re,loadClientes:te,reloadData:q,getClassificacaoAtual:k,getResumoPacote:I,classificacoesPendentes:K,setClassificacoesPendentes:T}=Ta(),{embrioesSelecionados:B,setEmbrioesSelecionados:V,showAcoesEmMassa:l,setShowAcoesEmMassa:G,showCongelarDialog:o,setShowCongelarDialog:r,showDescartarDialog:g,setShowDescartarDialog:S,showClassificarDialog:C,setShowClassificarDialog:F,showDirecionarClienteDialog:ke,setShowDirecionarClienteDialog:Y,showHistoricoDialog:Z,setShowHistoricoDialog:de,showEditarFazendasDestinoDialog:Se,setShowEditarFazendasDestinoDialog:ie,congelarData:L,setCongelarData:ne,descartarData:$,setDescartarData:Q,direcionarClienteData:Me,setDirecionarClienteData:ce,classificarEmbriao:W,setClassificarEmbriao:ee,historicoEmbriao:ae,setHistoricoEmbriao:E,pacoteEditandoFazendas:ge,setPacoteEditandoFazendas:Ee,fazendasDestinoSelecionadas:U,setFazendasDestinoSelecionadas:_e,historico:Ne,loadingHistorico:Ae,submitting:M,handleCongelarEmMassa:le,handleDescartarEmMassa:je,handleDirecionarClienteEmMassa:ve,loadHistorico:Te,handleSalvarFazendasDestino:Fe,limparSelecao:i}=Fa({embrioes:w,pacotes:z,classificacoesPendentes:K,setClassificacoesPendentes:T,onSuccess:q}),[c,d]=t.useState(new Set),[u,p]=t.useState({classificacao:""});t.useEffect(()=>{re(),te()},[re,te]),t.useEffect(()=>{O()},[y,O]);const me=s=>{d(j=>{const f=new Set(j);return f.has(s)?f.delete(s):f.add(s),f})},a=s=>{V(j=>{const f=new Set(j);return f.has(s)?f.delete(s):f.add(s),G(f.size>0),f})},N=s=>{V(j=>{const f=new Set(j);return s.every(D=>f.has(D.id))?s.forEach(D=>f.delete(D.id)):s.forEach(D=>f.add(D.id)),G(f.size>0),f})},se=s=>H[s]??1,X=(s,j)=>{oe(f=>({...f,[s]:j}))},Ce=()=>{if(!W||!u.classificacao){h({title:"Erro de validação",description:"Classificação é obrigatória",variant:"destructive"});return}T(s=>({...s,[W.id]:u.classificacao})),h({title:"Classificação pendente",description:'Use "Despachar para o campo" para salvar.'}),F(!1),ee(null),p({classificacao:""}),i()},fe=()=>{if(B.size===0||!u.classificacao){h({title:"Erro de validação",description:"Selecione embriões e classificação",variant:"destructive"});return}const s=Array.from(B);T(j=>{const f={...j};return s.forEach(J=>{f[J]=u.classificacao}),f}),h({title:"Classificações pendentes",description:'Use "Despachar para o campo" para salvar.'}),F(!1),p({classificacao:""}),i()},De=async s=>{if(!I(s).todosClassificados){h({title:"Classificação pendente",description:"Classifique todos os embriões antes de despachar.",variant:"destructive"});return}try{const f=new Date().toISOString().split("T")[0],J=s.embrioes.filter(D=>{const we=k(D);return we&&we!==(D.classificacao||"").trim()});J.length>0&&await Promise.all(J.map(D=>v.from("embrioes").update({classificacao:k(D),data_classificacao:f}).eq("id",D.id))),await v.from("lotes_fiv").update({disponivel_para_transferencia:!0}).eq("id",s.lote_fiv_id),h({title:"Pacote despachado",description:"Disponível para transferência."}),T(D=>{const we={...D};return J.forEach(Ie=>delete we[Ie.id]),we}),await q()}catch(f){h({title:"Erro ao despachar",description:f instanceof Error?f.message:"Erro desconhecido",variant:"destructive"})}};return n?e.jsx(Ye,{}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(Da,{title:"Estoque de Embriões",description:"Gerenciar pacotes de embriões para transferência, congelamento ou descarte"}),e.jsxs(He,{children:[e.jsx(Qe,{children:e.jsx(We,{children:"Pacotes de Embriões"})}),e.jsxs(Re,{children:[e.jsxs("div",{className:"mb-4 space-y-2",children:[e.jsx(be,{htmlFor:"fazenda_destino",children:"Filtrar por Fazenda Destino"}),e.jsxs(Ue,{value:y||"all",onValueChange:s=>_(s==="all"?"":s),children:[e.jsx(Ve,{className:"w-full md:w-[300px]",children:e.jsx(Ge,{placeholder:"Todas as fazendas"})}),e.jsxs(Xe,{children:[e.jsx(xe,{value:"all",children:"Todas as fazendas"}),b.map(s=>e.jsx(xe,{value:s.id,children:s.nome},s.id))]})]})]}),z.length===0?e.jsx(wa,{title:"Nenhum pacote encontrado",description:"Selecione outra fazenda ou verifique se há pacotes disponíveis.",action:y?e.jsx(x,{variant:"outline",onClick:()=>_(""),children:"Limpar filtro"}):void 0}):e.jsx("div",{className:"space-y-4",children:z.map(s=>{const j=c.has(s.id),f=s.embrioes.filter(P=>B.has(P.id)).length,J=I(s),D=Aa(s.data_fecundacao),we=D===7,Ie=D===8,Ke=D!==null&&D>8;let Le="border-l-green-500";return Ie&&(Le="border-l-orange-500"),Ke&&(Le="border-l-red-500"),e.jsxs(He,{className:`border-l-4 ${Le}`,children:[e.jsx(Qe,{className:"pb-3",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>me(s.id),className:"p-0 h-auto",children:j?e.jsx(ja,{className:"w-5 h-5 text-slate-600"}):e.jsx(va,{className:"w-5 h-5 text-slate-600"})}),D!==null&&s.frescos>0&&e.jsxs(e.Fragment,{children:[we&&e.jsx(pe,{className:"bg-green-100 text-green-800 border-green-300",children:"D7 - Ideal"}),Ie&&e.jsxs(pe,{className:"bg-orange-100 text-orange-800 border-orange-300 animate-pulse",children:[e.jsx(sa,{className:"w-3 h-3 mr-1"}),"D8 - Último dia!"]}),Ke&&e.jsxs(pe,{className:"bg-red-100 text-red-800 border-red-300",children:[e.jsx(sa,{className:"w-3 h-3 mr-1"}),"D",D," - Vencido"]})]}),e.jsxs(We,{className:"text-lg",children:[s.pacote_info.fazenda_nome||"Fazenda não identificada"," →"," ",s.fazendas_destino_nomes.length>0?e.jsx("span",{className:"inline-flex flex-wrap gap-1",children:s.fazendas_destino_nomes.map((P,ua)=>e.jsx(pe,{variant:"outline",className:"text-xs",children:P},ua))}):e.jsx("span",{className:"text-slate-400",children:"Sem destino"})]}),e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>{Ee(s),_e([...s.fazendas_destino_ids]),ie(!0)},className:"h-8 w-8 p-0",title:"Editar fazendas destino",children:e.jsx(Pa,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"mt-2 ml-7 text-sm text-slate-600",children:e.jsxs("p",{children:[e.jsx("strong",{children:"Data Despacho:"})," ",s.data_despacho?Ze(s.data_despacho):"-"]})})]}),e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:s.total}),e.jsx("div",{className:"text-sm text-slate-600",children:"embriões"}),e.jsxs("div",{className:"text-xs text-slate-500 mt-1",children:[s.frescos," frescos, ",s.congelados," congelados"]}),e.jsxs("div",{className:"text-xs text-slate-500",children:[J.semClassificacao," sem classificação"]})]}),e.jsx("div",{className:"flex flex-col items-end gap-2 min-w-[280px]",children:J.todosClassificados?e.jsxs(e.Fragment,{children:[e.jsx(pe,{variant:"outline",className:"bg-green-50 text-green-700 border-green-300",children:"✓ Todos classificados"}),s.disponivel_para_transferencia?e.jsx(pe,{variant:"outline",className:"bg-blue-50 text-blue-700 border-blue-300",children:"Disponível para Transferência"}):e.jsx(x,{size:"sm",onClick:()=>De(s),className:"bg-green-600 hover:bg-green-700 text-white w-full",children:"Despachar para o campo"})]}):e.jsxs(pe,{variant:"outline",className:"bg-amber-50 text-amber-700 border-amber-300",children:["Pendente: ",J.total-J.semClassificacao,"/",J.total]})})]})]})}),j&&e.jsx(Re,{children:e.jsx(Oa,{pacote:s,embrioesSelecionados:B,paginaAtual:se(s.id),pageSize:R,totalSelecionados:f,getClassificacaoAtual:k,onToggleSelecionarEmbriao:a,onSelecionarTodosDaPagina:N,onSetPagina:P=>X(s.id,P),onClassificar:P=>{ee(P),p({classificacao:k(P)||""}),F(!0)},onCongelar:P=>{if(!k(P)){h({title:"Classificação obrigatória",description:"Classifique o embrião primeiro.",variant:"destructive"});return}V(new Set([P.id])),r(!0)},onDirecionar:P=>{V(new Set([P.id])),ce({cliente_id:""}),Y(!0)},onDescartar:P=>{V(new Set([P.id])),Q({data_descarte:new Date().toISOString().split("T")[0],observacoes:""}),S(!0)},onHistorico:async P=>{E(P),de(!0),await Te(P.id)},toast:h})})]},s.id)})}),l&&e.jsxs("div",{className:"mt-6 p-4 bg-slate-50 border border-slate-200 rounded-lg flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ba,{className:"w-5 h-5 text-slate-600"}),e.jsxs("span",{className:"font-medium",children:[B.size," selecionado(s)"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(x,{variant:"outline",size:"sm",onClick:()=>{p({classificacao:""}),F(!0)},children:[e.jsx(la,{className:"w-4 h-4 mr-2"}),"Classificar"]}),e.jsxs(x,{variant:"outline",size:"sm",onClick:()=>{ne({data_congelamento:new Date().toISOString().split("T")[0],localizacao_atual:""}),r(!0)},children:[e.jsx(da,{className:"w-4 h-4 mr-2"}),"Congelar"]}),e.jsxs(x,{variant:"outline",size:"sm",onClick:()=>{ce({cliente_id:""}),Y(!0)},children:[e.jsx(fa,{className:"w-4 h-4 mr-2"}),"Direcionar"]}),e.jsxs(x,{variant:"outline",size:"sm",onClick:()=>{Q({data_descarte:new Date().toISOString().split("T")[0],observacoes:""}),S(!0)},children:[e.jsx(ma,{className:"w-4 h-4 mr-2"}),"Descartar"]}),e.jsx(x,{variant:"outline",size:"sm",onClick:i,children:"Cancelar"})]})]})]})]}),e.jsx(ze,{open:C&&!!W,onOpenChange:s=>{s||(F(!1),ee(null))},children:e.jsxs(ye,{className:"max-w-md",children:[e.jsxs(Pe,{children:[e.jsx(Be,{children:"Classificar Embrião"}),e.jsx(qe,{children:(W==null?void 0:W.identificacao)||"Embrião selecionado"})]}),e.jsx(ra,{value:u.classificacao,onChange:s=>p({classificacao:s}),onSubmit:Ce,onCancel:()=>{F(!1),ee(null)},submitting:M,buttonLabel:"Salvar Classificação"})]})}),e.jsx(ze,{open:C&&!W&&B.size>0,onOpenChange:s=>!s&&F(!1),children:e.jsxs(ye,{className:"max-w-md",children:[e.jsxs(Pe,{children:[e.jsxs(Be,{children:["Classificar ",B.size," Embrião(ões)"]}),e.jsx(qe,{children:"Mesma classificação para todos"})]}),e.jsx(ra,{value:u.classificacao,onChange:s=>p({classificacao:s}),onSubmit:fe,onCancel:()=>F(!1),submitting:M,buttonLabel:`Classificar ${B.size}`})]})}),e.jsx(ze,{open:o,onOpenChange:r,children:e.jsxs(ye,{className:"max-w-md",children:[e.jsx(Pe,{children:e.jsxs(Be,{children:["Congelar ",B.size," Embrião(ões)"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(be,{children:"Data de Congelamento *"}),e.jsx(aa,{value:L.data_congelamento,onChange:s=>ne({...L,data_congelamento:s||""}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(be,{children:"Localização (Botijão) *"}),e.jsx(Ca,{value:L.localizacao_atual,onChange:s=>ne({...L,localizacao_atual:s.target.value}),placeholder:"Ex: Botijão 1, Canister A"})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(x,{onClick:le,className:"flex-1 bg-blue-600 hover:bg-blue-700",disabled:M,children:M?"Congelando...":"Congelar"}),e.jsx(x,{variant:"outline",onClick:()=>r(!1),children:"Cancelar"})]})]})]})}),e.jsx(ze,{open:g,onOpenChange:S,children:e.jsxs(ye,{className:"max-w-md",children:[e.jsx(Pe,{children:e.jsxs(Be,{children:["Descartar ",B.size," Embrião(ões)"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(be,{children:"Data de Descarte *"}),e.jsx(aa,{value:$.data_descarte,onChange:s=>Q({...$,data_descarte:s||""}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(be,{children:"Observações / Motivo"}),e.jsx(ba,{value:$.observacoes,onChange:s=>Q({...$,observacoes:s.target.value}),placeholder:"Motivo do descarte (opcional)",rows:3})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(x,{onClick:je,className:"flex-1 bg-red-600 hover:bg-red-700",disabled:M,children:M?"Descartando...":"Descartar"}),e.jsx(x,{variant:"outline",onClick:()=>S(!1),children:"Cancelar"})]})]})]})}),e.jsx(ze,{open:ke,onOpenChange:Y,children:e.jsxs(ye,{className:"max-w-md",children:[e.jsx(Pe,{children:e.jsx(Be,{children:"Direcionar para Cliente"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(be,{children:"Cliente *"}),e.jsxs(Ue,{value:Me.cliente_id,onValueChange:s=>ce({cliente_id:s}),children:[e.jsx(Ve,{children:e.jsx(Ge,{placeholder:"Selecione o cliente"})}),e.jsx(Xe,{children:m.map(s=>e.jsx(xe,{value:s.id,children:s.nome},s.id))})]})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(x,{onClick:()=>ve(m),className:"flex-1 bg-green-600 hover:bg-green-700",disabled:M,children:M?"Direcionando...":"Direcionar"}),e.jsx(x,{variant:"outline",onClick:()=>Y(!1),children:"Cancelar"})]})]})]})}),e.jsx(Sa,{open:Z,onOpenChange:de,children:e.jsxs(Ea,{className:"w-full sm:max-w-2xl",children:[e.jsxs(Na,{children:[e.jsx(za,{children:"Histórico do Embrião"}),e.jsx(ya,{children:(ae==null?void 0:ae.identificacao)||((A=ae==null?void 0:ae.id)==null?void 0:A.slice(0,8))})]}),e.jsx("div",{className:"mt-6",children:Ae?e.jsx(Ye,{}):Ne.length===0?e.jsx("p",{className:"text-slate-500 text-center py-8",children:"Nenhum histórico encontrado"}):e.jsx("div",{className:"space-y-4",children:Ne.map(s=>e.jsx(He,{children:e.jsx(Re,{className:"pt-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:s.tipo_operacao}),e.jsx("p",{className:"text-sm text-slate-600 mt-1",children:s.data_mudanca?Ze(s.data_mudanca):"-"}),s.observacoes&&e.jsx("p",{className:"text-sm text-slate-500 mt-1",children:s.observacoes})]}),e.jsx(na,{status:s.status_novo||""})]})})},s.id))})})]})}),e.jsx(ze,{open:Se,onOpenChange:ie,children:e.jsxs(ye,{className:"max-w-md",children:[e.jsxs(Pe,{children:[e.jsx(Be,{children:"Editar Fazendas Destino"}),e.jsx(qe,{children:"Selecione as fazendas destino do pacote"})]}),ge&&e.jsx("div",{className:"space-y-4",children:e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto border rounded-md p-3",children:b.map(s=>e.jsxs("label",{className:"flex items-center space-x-2 cursor-pointer hover:bg-slate-50 p-2 rounded",children:[e.jsx("input",{type:"checkbox",checked:U.includes(s.id),onChange:j=>{j.target.checked?_e([...U,s.id]):_e(U.filter(f=>f!==s.id))},className:"rounded border-slate-300"}),e.jsx("span",{className:"text-sm",children:s.nome})]},s.id))})}),e.jsxs(_a,{children:[e.jsx(x,{variant:"outline",onClick:()=>{ie(!1),Ee(null)},children:"Cancelar"}),e.jsx(x,{onClick:Fe,disabled:M,children:M?"Salvando...":"Salvar"})]})]})})]})}function ra({value:h,onChange:w,onSubmit:z,onCancel:b,submitting:m,buttonLabel:n}){return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(be,{children:"Classificação *"}),e.jsxs(Ue,{value:h,onValueChange:w,children:[e.jsx(Ve,{children:e.jsx(Ge,{placeholder:"Selecione"})}),e.jsxs(Xe,{children:[e.jsx(xe,{value:"BE",children:"BE (Blastocisto Excelente)"}),e.jsx(xe,{value:"BN",children:"BN (Blastocisto Normal)"}),e.jsx(xe,{value:"BX",children:"BX (Blastocisto Regular)"}),e.jsx(xe,{value:"BL",children:"BL (Blastocisto Limitado)"}),e.jsx(xe,{value:"BI",children:"BI (Blastocisto Irregular)"})]})]})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(x,{onClick:z,className:"flex-1 bg-purple-600 hover:bg-purple-700",disabled:m,children:m?"Salvando...":n}),e.jsx(x,{variant:"outline",onClick:b,disabled:m,children:"Cancelar"})]})]})}function Oa({pacote:h,embrioesSelecionados:w,paginaAtual:z,pageSize:b,totalSelecionados:m,getClassificacaoAtual:n,onToggleSelecionarEmbriao:y,onSelecionarTodosDaPagina:_,onSetPagina:H,onClassificar:oe,onCongelar:R,onDirecionar:O,onDescartar:re,onHistorico:te}){const q=[...h.embrioes].sort((l,G)=>{const o=l.identificacao||"",r=G.identificacao||"";return o&&r?o.localeCompare(r):o&&!r?-1:!o&&r?1:(l.created_at||"").localeCompare(G.created_at||"")}),k=Math.max(1,Math.ceil(q.length/b)),I=Math.min(z,k),K=(I-1)*b,T=q.slice(K,K+b),B=T.every(l=>w.has(l.id)),V=T.some(l=>w.has(l.id));return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(x,{variant:"outline",size:"sm",onClick:()=>_(T),children:[B?e.jsx(ta,{className:"w-4 h-4 mr-2"}):e.jsx(ia,{className:"w-4 h-4 mr-2"}),B?"Desmarcar Página":"Selecionar Página"]}),e.jsxs("span",{className:"text-sm text-slate-600",children:[V&&`${T.filter(l=>w.has(l.id)).length} na página`,!V&&m>0&&`${m} no pacote`]})]}),e.jsxs("div",{className:"text-sm text-slate-600",children:["Página ",I," de ",k]})]}),e.jsxs(pa,{children:[e.jsx(xa,{children:e.jsxs(ea,{children:[e.jsx(he,{className:"w-12"}),e.jsx(he,{className:"text-center w-28",children:"Código"}),e.jsx(he,{children:"Doadora"}),e.jsx(he,{children:"Touro"}),e.jsx(he,{children:"Classificação"}),e.jsx(he,{children:"Status"}),e.jsx(he,{children:"Localização"}),e.jsx(he,{className:"text-right",children:"Ações"})]})}),e.jsx(ga,{children:T.map((l,G)=>{const o=w.has(l.id),r=n(l);return e.jsxs(ea,{children:[e.jsx(ue,{children:e.jsx(x,{variant:"ghost",size:"sm",className:"p-0 h-auto",onClick:()=>y(l.id),children:o?e.jsx(ta,{className:"w-4 h-4 text-green-600"}):e.jsx(ia,{className:"w-4 h-4 text-slate-400"})})}),e.jsx(ue,{className:"text-center font-mono text-xs",children:l.identificacao||`#${K+G+1}`}),e.jsx(ue,{children:l.doadora_registro||"-"}),e.jsx(ue,{children:l.touro_nome||"-"}),e.jsx(ue,{children:r?e.jsx(pe,{variant:"outline",children:r}):e.jsx("span",{className:"text-slate-400",children:"-"})}),e.jsx(ue,{children:e.jsx(na,{status:l.status_atual})}),e.jsx(ue,{children:l.localizacao_atual||"-"}),e.jsx(ue,{className:"text-right",children:e.jsxs("div",{className:"flex gap-1 justify-end",children:[e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>oe(l),title:"Classificar",children:e.jsx(la,{className:"w-4 h-4 text-purple-600"})}),l.status_atual==="FRESCO"&&e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>R(l),title:r?"Congelar":"Classifique primeiro",disabled:!r,children:e.jsx(da,{className:r?"w-4 h-4 text-blue-600":"w-4 h-4 text-slate-400"})}),l.status_atual==="CONGELADO"&&!l.cliente_id&&e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>O(l),title:"Direcionar para Cliente",children:e.jsx(fa,{className:"w-4 h-4 text-green-600"})}),e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>re(l),title:"Descartar",children:e.jsx(ma,{className:"w-4 h-4 text-red-600"})}),e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>te(l),title:"Ver Histórico",children:e.jsx(ka,{className:"w-4 h-4 text-slate-600"})})]})})]},l.id)})})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-between",children:[e.jsxs("div",{className:"text-sm text-slate-600",children:[q.length," embriões no pacote"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{variant:"outline",size:"sm",onClick:()=>H(Math.max(1,I-1)),disabled:I===1,children:"Anterior"}),e.jsx(x,{variant:"outline",size:"sm",onClick:()=>H(Math.min(k,I+1)),disabled:I===k,children:"Próxima"})]})]})]})}export{ps as default};
