import{r as y,s as f}from"./index-B-7HRnm0.js";import{u as P}from"./use-toast-DDUqdzpY.js";import{c as F}from"./dataEnrichment-B3oy6j3b.js";const x={DG:27,SEXAGEM:54};function Z(t){const p=new Date(t),l=new Date(p);return l.setDate(l.getDate()+275),l.toISOString().split("T")[0]}function $(t){return t.veterinario_responsavel.trim()!==""}function N({statusReceptoraFiltro:t}){const{toast:p}=P(),[l,_]=y.useState([]),[m,S]=y.useState(!1),T=y.useCallback(async()=>{try{S(!0);const{data:i,error:E}=await f.from("fazendas").select("*").order("nome",{ascending:!0});if(E)throw E;if(!i||i.length===0){_([]);return}const{data:q,error:n}=await f.from("vw_receptoras_fazenda_atual").select("receptora_id, fazenda_id_atual");if(n)throw n;const g=[...new Set((q||[]).map(e=>e.receptora_id).filter(Boolean))];if(g.length===0){_(i);return}const v=Array.isArray(t)?t:[t];let d=f.from("receptoras").select("id").in("id",g);v.length===1?d=d.eq("status_reprodutivo",v[0]):d=d.in("status_reprodutivo",v);const{data:c,error:h}=await d;if(h)throw h;const b=(c==null?void 0:c.map(e=>e.id))||[];if(b.length===0){_([]);return}const{data:z,error:u}=await f.from("transferencias_embrioes").select("receptora_id").in("receptora_id",b).eq("status_te","REALIZADA");if(u)throw console.error("Erro ao buscar TEs:",u),u;const A=new Set((z==null?void 0:z.map(e=>e.receptora_id))||[]);if(A.size===0){_([]);return}const I=new Map((q||[]).filter(e=>e.receptora_id&&e.fazenda_id_atual).map(e=>[e.receptora_id,e.fazenda_id_atual])),D=new Set;A.forEach(e=>{const w=I.get(e);w&&D.add(w)});const L=i.filter(e=>D.has(e.id));_(L)}catch(i){console.error("Erro ao carregar fazendas:",i),p({title:"Erro ao carregar fazendas",description:i instanceof Error?i.message:"Erro desconhecido",variant:"destructive"}),_([])}finally{S(!1)}},[t,p]);return{fazendas:l,loading:m,loadFazendas:T}}function U({statusReceptoraFiltro:t,transformLote:p}){const{toast:l}=P(),[_,m]=y.useState([]),[S,T]=y.useState(!1),i=y.useCallback(async(E,q)=>{try{T(!0);const{data:n,error:g}=await f.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",E);if(g)throw console.error("Erro ao buscar view:",g),g;const v=(n==null?void 0:n.map(a=>a.receptora_id))||[];if(v.length===0){m([]);return}const d=Array.isArray(t)?t:[t];let c=f.from("receptoras").select("id, status_reprodutivo").in("id",v);d.length===1?c=c.eq("status_reprodutivo",d[0]):c=c.in("status_reprodutivo",d);const{data:h,error:b}=await c;if(b)throw console.error("Erro ao buscar receptoras:",b),b;const z=(h==null?void 0:h.map(a=>a.id))||[];if(z.length===0){m([]);return}const{data:u,error:A}=await f.from("transferencias_embrioes").select("id, receptora_id, data_te, embriao_id").in("receptora_id",z).eq("status_te","REALIZADA").order("data_te",{ascending:!1});if(A)throw console.error("Erro ao buscar TEs:",A),A;if(!u||u.length===0){m([]);return}const I=u.map(a=>a.embriao_id).filter(Boolean);let D=new Map,L=new Map;if(I.length>0){const{data:a}=await f.from("embrioes").select("id, lote_fiv_id").in("id",I);if(a){D=new Map(a.map(r=>[r.id,{lote_fiv_id:r.lote_fiv_id}]));const o=[...new Set(a.map(r=>r.lote_fiv_id).filter(Boolean))];if(o.length>0){const{data:r}=await f.from("lotes_fiv").select("id, data_abertura").in("id",o);r&&(L=new Map(r.map(s=>[s.id,{data_abertura:s.data_abertura}])))}}}const e=new Map,w=new Map,C=new Map;u.forEach(a=>{const o=`${E}-${a.data_te}`;w.has(a.data_te)||w.set(a.data_te,new Set),w.get(a.data_te).add(a.receptora_id);const r=D.get(a.embriao_id);if(r!=null&&r.lote_fiv_id){const s=L.get(r.lote_fiv_id);if(s!=null&&s.data_abertura){const M=C.get(o);(!M||s.data_abertura<M)&&C.set(o,s.data_abertura)}}e.has(o)||e.set(o,{id:o,fazenda_id:E,fazenda_nome:q||"",data_te:a.data_te,quantidade_receptoras:0,status:"ABERTO"})}),e.forEach((a,o)=>{var M;const r=((M=w.get(a.data_te))==null?void 0:M.size)||0;a.quantidade_receptoras=r;const s=C.get(o);s&&(a.data_abertura_lote=s,a.dias_gestacao=F(s))});const B=Array.from(e.values()).map(a=>p(a,void 0)).sort((a,o)=>new Date(o.data_te).getTime()-new Date(a.data_te).getTime());m(B)}catch(n){console.error("Erro ao carregar lotes:",n),l({title:"Erro ao carregar lotes",description:n instanceof Error?n.message:"Erro desconhecido",variant:"destructive"}),m([])}finally{T(!1)}},[t,p,l]);return{lotesTE:_,loading:S,loadLotesTE:i}}export{x as D,U as a,Z as c,N as u,$ as v};
