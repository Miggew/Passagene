import{e as Ke,f as We,r as c,s as n,j as e,a as Ye,B as u,S as ea,d as aa}from"./index-DM5u2d-F.js";import{f as sa}from"./statusLabels-IklKT8dE.js";import{N as ta,g as ra,a as oa}from"./coordinates-CPjP6fsB.js";import{C as m,a as E,b as C,d as p}from"./card-B_EQ6x91.js";import{T as ia,a as na,b as fe,c as S,d as da,e as A}from"./table-CEKyj1ed.js";import{T as ca,a as la,b as _e,c as ue}from"./tabs-mOzZlruc.js";import{B as v}from"./badge-D_AVhbx8.js";import{P as ma}from"./PageHeader-JgO8x5IE.js";import{E as je}from"./EmptyState-ChaxWsz8.js";import{u as pa}from"./use-toast-BOUGyrIz.js";import{A as xa}from"./arrow-left-CH9vqVt5.js";import{C as ha}from"./calendar-B_KmJ-VL.js";import{B as ge}from"./baby-Cs4whXQA.js";import"./index-C0gH1jj7.js";import"./index-ClZPXJQX.js";import"./index-CWb7Yp_3.js";function La(){const{id:x}=Ke(),j=We(),{toast:Ne}=pa(),[ve,U]=c.useState(!0),[o,be]=c.useState(null),[V,we]=c.useState(""),[fa,Se]=c.useState([]),[_a,Ae]=c.useState([]),[ua,Z]=c.useState([]),[ja,De]=c.useState([]),[ga,ye]=c.useState({total_ultimos_60_dias:0,sem_diagnostico:0}),[h,X]=c.useState({passo2Pendente:0,tePendente:0,dgPendente:0,sexagemPendente:0,prenhesTotal:0,prenhesDataMaisProxima:void 0,prenhesNaDataMaisProxima:0}),[I,Q]=c.useState({total:0,porStatus:[]}),[b,ze]=c.useState({total:0,porRaca:[],oocitos30d:0,aspiracoes30d:0,mediaOocitos:0}),[J,Pe]=c.useState([]);c.useEffect(()=>{x&&Ee()},[x]);const Ee=async()=>{try{U(!0);const{data:r,error:D}=await n.from("fazendas").select("*").eq("id",x).single();if(D)throw D;be(r);const{data:Re,error:W}=await n.from("clientes").select("nome").eq("id",r.cliente_id).single();if(W)throw W;we(Re.nome);const{data:w,error:Y}=await n.from("protocolos_sincronizacao").select("id, data_inicio, data_retirada, status").eq("fazenda_id",x).in("status",["PASSO1_FECHADO","PRIMEIRO_PASSO_FECHADO","SINCRONIZADO","FECHADO"]).order("data_inicio",{ascending:!1});if(Y)throw Y;Se(w||[]);try{const{data:a,error:t}=await n.from("v_protocolo_receptoras_status").select("*").in("protocolo_id",(w==null?void 0:w.map(i=>i.id))||[]).eq("fase_ciclo","SINCRONIZADA");!t&&a&&Ae(a.map(i=>({brinco:i.brinco,fase_ciclo:i.fase_ciclo,status_efetivo:i.status_efetivo,motivo_efetivo:i.motivo_efetivo,data_te_prevista:i.data_te_prevista,data_limite_te:i.data_limite_te})))}catch{}const{data:O,error:ee}=await n.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",x);if(ee)throw ee;const ae=(O==null?void 0:O.map(a=>a.receptora_id))||[],Na=new Date().toISOString().split("T")[0],F=new Date;F.setDate(F.getDate()-60);const{data:g,error:se}=await n.from("transferencias_embrioes").select("id, receptora_id, data_te").in("receptora_id",ae.length>0?ae:["00000000-0000-0000-0000-000000000000"]).gte("data_te",F.toISOString().split("T")[0]);if(se)throw se;const Te=(g==null?void 0:g.length)||0;if(g&&g.length>0){const a=g.map(d=>d.receptora_id),{data:t,error:i}=await n.from("diagnosticos_gestacao").select("receptora_id").in("receptora_id",a);if(!i){const d=new Set(t==null?void 0:t.map(l=>l.receptora_id)),f=g.filter(l=>!d.has(l.receptora_id)).length;ye({total_ultimos_60_dias:Te,sem_diagnostico:f})}}const{data:te,error:Ie}=await n.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",x);if(!Ie&&te){const a=te.map(t=>t.receptora_id);if(a.length>0){const{data:t,error:i}=await n.from("receptoras").select("id, identificacao, nome, status_reprodutivo, data_provavel_parto").in("id",a).order("identificacao",{ascending:!0});if(!i){Z((t==null?void 0:t.map(s=>({receptora_id:s.id,brinco:s.identificacao,nome:s.nome,status_reprodutivo:s.status_reprodutivo,data_provavel_parto:s.data_provavel_parto})))||[]);const d=(t==null?void 0:t.length)||0,f=new Map;(t||[]).forEach(s=>{const _=s.status_reprodutivo||"SEM_STATUS";f.set(_,(f.get(_)||0)+1)}),Q({total:d,porStatus:Array.from(f.entries()).map(([s,_])=>({status:s,total:_})).sort((s,_)=>_.total-s.total)});const l=(w||[]).filter(s=>s.status==="PASSO1_FECHADO"||s.status==="PRIMEIRO_PASSO_FECHADO").length,z=(w||[]).filter(s=>s.status==="SINCRONIZADO").length,{data:P}=await n.from("transferencias_embrioes").select("receptora_id").in("receptora_id",a).eq("status_te","REALIZADA"),N=Array.from(new Set((P||[]).map(s=>s.receptora_id))),B=N.length>0?N:["00000000-0000-0000-0000-000000000000"],{data:R}=await n.from("diagnosticos_gestacao").select("receptora_id, tipo_diagnostico").in("receptora_id",B).in("tipo_diagnostico",["DG","SEXAGEM"]),he=new Set((R||[]).filter(s=>s.tipo_diagnostico==="DG").map(s=>s.receptora_id)),Ze=new Set((R||[]).filter(s=>s.tipo_diagnostico==="SEXAGEM").map(s=>s.receptora_id)),Xe=N.filter(s=>!he.has(s)).length,Qe=(t||[]).filter(s=>(s.status_reprodutivo||"").includes("PRENHE")&&he.has(s.id)).map(s=>s.id).filter(s=>!Ze.has(s)).length,T=(t||[]).filter(s=>(s.status_reprodutivo||"").includes("PRENHE")&&s.data_provavel_parto).map(s=>s.data_provavel_parto).sort((s,_)=>s.localeCompare(_)),$=T.length>0?T[0]:void 0,Je=$?T.filter(s=>s===$).length:0;X({passo2Pendente:l,tePendente:z,dgPendente:Xe,sexagemPendente:Qe,prenhesTotal:T.length,prenhesDataMaisProxima:$,prenhesNaDataMaisProxima:Je})}}else Z([]),Q({total:0,porStatus:[]}),X({passo2Pendente:0,tePendente:0,dgPendente:0,sexagemPendente:0,prenhesTotal:0,prenhesDataMaisProxima:void 0,prenhesNaDataMaisProxima:0})}const{data:y,error:re}=await n.from("doadoras").select("*").eq("fazenda_id",x).order("registro",{ascending:!0});if(re)throw re;De(y||[]);const L=new Map;(y||[]).forEach(a=>{const t=a.raca||"SEM_RACA";L.set(t,(L.get(t)||0)+1)});const q=new Date;q.setDate(q.getDate()-30);const{data:M}=await n.from("aspiracoes_doadoras").select("id, total_oocitos, data_aspiracao").eq("fazenda_id",x).gte("data_aspiracao",q.toISOString().split("T")[0]),H=(M==null?void 0:M.length)||0,oe=(M||[]).reduce((a,t)=>a+(t.total_oocitos||0),0),Oe=H>0?Math.round(oe/H*10)/10:0;ze({total:(y==null?void 0:y.length)||0,porRaca:Array.from(L.entries()).map(([a,t])=>({raca:a,total:t})).sort((a,t)=>t.total-a.total),oocitos30d:oe,aspiracoes30d:H,mediaOocitos:Oe});const{data:k}=await n.from("animais").select("id, embriao_id, receptora_id, data_nascimento, sexo, raca, pai_nome, mae_nome, created_at").eq("fazenda_id",x).order("created_at",{ascending:!1}).limit(200),ie=Array.from(new Set((k||[]).map(a=>a.receptora_id).filter(a=>!!a))),ne=Array.from(new Set((k||[]).map(a=>a.embriao_id).filter(a=>!!a))),{data:Fe}=await n.from("receptoras").select("id, identificacao, nome").in("id",ie.length>0?ie:["00000000-0000-0000-0000-000000000000"]),Le=new Map((Fe||[]).map(a=>[a.id,a])),{data:de}=await n.from("embrioes").select("id, identificacao, lote_fiv_acasalamento_id").in("id",ne.length>0?ne:["00000000-0000-0000-0000-000000000000"]),qe=new Map((de||[]).map(a=>[a.id,a])),ce=Array.from(new Set((de||[]).map(a=>a.lote_fiv_acasalamento_id).filter(a=>!!a))),{data:G}=await n.from("lote_fiv_acasalamentos").select("id, aspiracao_doadora_id, dose_semen_id").in("id",ce.length>0?ce:["00000000-0000-0000-0000-000000000000"]),He=new Map((G||[]).map(a=>[a.id,a])),le=Array.from(new Set((G||[]).map(a=>a.aspiracao_doadora_id).filter(a=>!!a))),me=Array.from(new Set((G||[]).map(a=>a.dose_semen_id).filter(a=>!!a))),{data:pe}=await n.from("aspiracoes_doadoras").select("id, doadora_id").in("id",le.length>0?le:["00000000-0000-0000-0000-000000000000"]),ke=new Map((pe||[]).map(a=>[a.id,a.doadora_id])),xe=Array.from(new Set((pe||[]).map(a=>a.doadora_id).filter(a=>!!a))),{data:Ge}=await n.from("doadoras").select("id, registro, nome").in("id",xe.length>0?xe:["00000000-0000-0000-0000-000000000000"]),Be=new Map((Ge||[]).map(a=>[a.id,a])),{data:$e}=await n.from("doses_semen").select("id, touro:touros(id, nome, registro)").in("id",me.length>0?me:["00000000-0000-0000-0000-000000000000"]),Ue=new Map(($e||[]).map(a=>[a.id,a])),Ve=(k||[]).map(a=>{const t=a.receptora_id?Le.get(a.receptora_id):null,i=a.embriao_id?qe.get(a.embriao_id):null,d=i!=null&&i.lote_fiv_acasalamento_id?He.get(i.lote_fiv_acasalamento_id):null,f=d!=null&&d.aspiracao_doadora_id?ke.get(d.aspiracao_doadora_id):null,l=f?Be.get(f):null,z=d!=null&&d.dose_semen_id?Ue.get(d.dose_semen_id):null,P=z==null?void 0:z.touro,N=Array.isArray(P)?P[0]:P,B=l?`${l.registro||""}${l.nome?` - ${l.nome}`:""}`.trim():a.mae_nome||null,R=(N==null?void 0:N.nome)||a.pai_nome||null;return{id:a.id,data_nascimento:a.data_nascimento,sexo:a.sexo,raca:a.raca,receptora_id:a.receptora_id,receptora_brinco:t==null?void 0:t.identificacao,receptora_nome:t==null?void 0:t.nome,embriao_id:a.embriao_id,embriao_identificacao:(i==null?void 0:i.identificacao)||null,doadora:B||null,touro:R||null}});Pe(Ve)}catch(r){Ne({title:"Erro ao carregar dados",description:r instanceof Error?r.message:"Erro desconhecido",variant:"destructive"})}finally{U(!1)}},Ce=()=>{if(o){if(o.latitude&&o.longitude){const r=ra(o.latitude,o.longitude);window.open(r,"_blank")}else if(o.localizacao){const r=oa(o.localizacao);window.open(r,"_blank")}}},Me=()=>o?o.latitude&&o.longitude||o.localizacao:!1,K=r=>r?new Date(r).toLocaleDateString("pt-BR"):"-";return ve?e.jsx(Ye,{}):o?e.jsxs("div",{className:"space-y-6",children:[e.jsx(ma,{title:o.nome,description:`Cliente: ${V}`,actions:e.jsx(u,{variant:"outline",size:"icon",onClick:()=>j("/fazendas"),children:e.jsx(xa,{className:"w-4 h-4"})})}),e.jsxs(m,{children:[e.jsx(E,{children:e.jsx(C,{children:"Informações da Fazenda"})}),e.jsxs(p,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Nome"}),e.jsx("p",{className:"text-base text-slate-900",children:o.nome})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Sigla"}),e.jsx("p",{className:"text-base text-slate-900",children:o.sigla||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Cliente"}),e.jsx("p",{className:"text-base text-slate-900",children:V})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Localização"}),e.jsx("p",{className:"text-base text-slate-900",children:o.localizacao||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Coordenadas"}),e.jsx("p",{className:"text-base text-slate-900",children:o.latitude&&o.longitude?`${o.latitude}, ${o.longitude}`:"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Responsável"}),e.jsx("p",{className:"text-base text-slate-900",children:o.responsavel||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Contato"}),e.jsx("p",{className:"text-base text-slate-900",children:o.contato_responsavel||"-"})]})]}),Me()&&e.jsx("div",{className:"pt-2",children:e.jsxs(u,{variant:"outline",onClick:Ce,children:[e.jsx(ta,{className:"w-4 h-4 mr-2"}),"Navegar"]})})]})]}),e.jsxs(ca,{defaultValue:"resumo",className:"space-y-4",children:[e.jsxs(la,{children:[e.jsx(_e,{value:"resumo",children:"Resumo"}),e.jsx(_e,{value:"animais",children:"Animais nascidos"})]}),e.jsxs(ue,{value:"resumo",className:"space-y-6",children:[e.jsxs(m,{children:[e.jsx(E,{children:e.jsx(C,{children:"Serviços pendentes"})}),e.jsx(p,{children:e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsx(m,{className:"border-dashed",children:e.jsxs(p,{className:"pt-5 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ha,{className:"w-4 h-4 text-slate-500"}),e.jsx("span",{className:"text-sm font-medium",children:"2º passo a fazer"})]}),e.jsx(v,{variant:"outline",children:h.passo2Pendente})]}),e.jsx("p",{className:"text-xs text-slate-500",children:"Protocolos com 1º passo fechado"}),e.jsx(u,{size:"sm",variant:"outline",onClick:()=>j("/protocolos"),children:"Abrir protocolos"})]})}),e.jsx(m,{className:"border-dashed",children:e.jsxs(p,{className:"pt-5 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ea,{className:"w-4 h-4 text-slate-500"}),e.jsx("span",{className:"text-sm font-medium",children:"TE a fazer"})]}),e.jsx(v,{variant:"outline",children:h.tePendente})]}),e.jsx("p",{className:"text-xs text-slate-500",children:"Protocolos sincronizados"}),e.jsx(u,{size:"sm",variant:"outline",onClick:()=>j("/transferencia"),children:"Abrir TE"})]})}),e.jsx(m,{className:"border-dashed",children:e.jsxs(p,{className:"pt-5 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(aa,{className:"w-4 h-4 text-slate-500"}),e.jsx("span",{className:"text-sm font-medium",children:"DG a fazer"})]}),e.jsx(v,{variant:"outline",children:h.dgPendente})]}),e.jsx("p",{className:"text-xs text-slate-500",children:"TE realizada sem DG"}),e.jsx(u,{size:"sm",variant:"outline",onClick:()=>j("/dg"),children:"Abrir DG"})]})}),e.jsx(m,{className:"border-dashed",children:e.jsxs(p,{className:"pt-5 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ge,{className:"w-4 h-4 text-slate-500"}),e.jsx("span",{className:"text-sm font-medium",children:"Sexagem a fazer"})]}),e.jsx(v,{variant:"outline",children:h.sexagemPendente})]}),e.jsx("p",{className:"text-xs text-slate-500",children:"Prenhes com DG sem sexagem"}),e.jsx(u,{size:"sm",variant:"outline",onClick:()=>j("/sexagem"),children:"Abrir Sexagem"})]})}),e.jsx(m,{className:"border-dashed md:col-span-2",children:e.jsxs(p,{className:"pt-5 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ge,{className:"w-4 h-4 text-slate-500"}),e.jsx("span",{className:"text-sm font-medium",children:"Receptoras prenhes"})]}),e.jsx(v,{variant:"outline",children:h.prenhesTotal})]}),h.prenhesDataMaisProxima?e.jsxs("div",{className:"space-y-1 text-xs text-slate-600",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Data mais próxima"}),e.jsx("span",{children:K(h.prenhesDataMaisProxima)})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Receptoras nessa data"}),e.jsx("span",{children:h.prenhesNaDataMaisProxima})]})]}):e.jsx("p",{className:"text-xs text-slate-500",children:"Nenhuma prenhe com data prevista"}),e.jsx(u,{size:"sm",variant:"outline",onClick:()=>j("/receptoras"),children:"Ver receptoras"})]})})]})})]}),e.jsxs(m,{children:[e.jsx(E,{children:e.jsx(C,{children:"Resumo de receptoras"})}),e.jsxs(p,{className:"space-y-4",children:[e.jsxs("div",{className:"rounded-md border border-slate-200 p-4 flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-slate-500",children:"Total na fazenda"}),e.jsx("span",{className:"text-2xl font-semibold",children:I.total})]}),I.porStatus.length===0?e.jsx("p",{className:"text-sm text-slate-500",children:"Nenhuma receptora cadastrada"}):e.jsx("div",{className:"grid gap-2 md:grid-cols-3",children:I.porStatus.map(r=>e.jsxs("div",{className:"flex items-center justify-between rounded-md border border-slate-200 px-3 py-2 bg-slate-50",children:[e.jsx("span",{className:"text-sm font-medium",children:sa(r.status)}),e.jsx(v,{variant:"outline",children:r.total})]},r.status))})]})]}),e.jsxs(m,{children:[e.jsx(E,{children:e.jsx(C,{children:"Resumo de doadoras"})}),e.jsxs(p,{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs("div",{className:"rounded-md border border-slate-200 p-4",children:[e.jsx("p",{className:"text-sm text-slate-500",children:"Total de doadoras"}),e.jsx("p",{className:"text-2xl font-semibold",children:b.total})]}),e.jsxs("div",{className:"rounded-md border border-slate-200 p-4",children:[e.jsx("p",{className:"text-sm text-slate-500",children:"Oócitos (30 dias)"}),e.jsx("p",{className:"text-2xl font-semibold",children:b.oocitos30d}),e.jsxs("p",{className:"text-xs text-slate-500",children:["Média: ",b.mediaOocitos]})]}),e.jsxs("div",{className:"rounded-md border border-slate-200 p-4",children:[e.jsx("p",{className:"text-sm text-slate-500",children:"Aspirações (30 dias)"}),e.jsx("p",{className:"text-2xl font-semibold",children:b.aspiracoes30d})]})]}),b.porRaca.length===0?e.jsx("p",{className:"text-sm text-slate-500",children:"Nenhuma doadora cadastrada"}):e.jsx("div",{className:"grid gap-2 md:grid-cols-2",children:b.porRaca.map(r=>e.jsxs("div",{className:"flex items-center justify-between rounded-md border border-slate-200 px-3 py-2",children:[e.jsx("span",{className:"text-sm",children:r.raca}),e.jsx(v,{variant:"outline",children:r.total})]},r.raca))})]})]})]}),e.jsx(ue,{value:"animais",className:"space-y-6",children:e.jsxs(m,{children:[e.jsx(E,{children:e.jsx(C,{children:"Animais nascidos"})}),e.jsx(p,{children:J.length===0?e.jsx(je,{title:"Nenhum animal registrado",description:"Os nascimentos registrados aparecerão aqui."}):e.jsxs(ia,{children:[e.jsx(na,{children:e.jsxs(fe,{children:[e.jsx(S,{children:"Data"}),e.jsx(S,{children:"Sexo"}),e.jsx(S,{children:"Raça"}),e.jsx(S,{children:"Receptora"}),e.jsx(S,{children:"Embrião"}),e.jsx(S,{children:"Acasalamento"})]})}),e.jsx(da,{children:J.map(r=>{var D;return e.jsxs(fe,{children:[e.jsx(A,{children:K(r.data_nascimento)}),e.jsx(A,{children:r.sexo}),e.jsx(A,{children:r.raca||"-"}),e.jsxs(A,{children:[r.receptora_brinco||"-",r.receptora_nome?` - ${r.receptora_nome}`:""]}),e.jsx(A,{className:"font-mono text-xs",children:r.embriao_identificacao||((D=r.embriao_id)==null?void 0:D.substring(0,8))||"-"}),e.jsxs(A,{children:[r.doadora||"-"," x ",r.touro||"-"]})]},r.id)})})]})})]})})]})]}):e.jsx("div",{className:"space-y-6",children:e.jsx(je,{title:"Fazenda não encontrada",description:"Volte para a lista e selecione outra fazenda.",action:e.jsx(u,{onClick:()=>j("/fazendas"),variant:"outline",children:"Voltar para Fazendas"})})})}export{La as default};
