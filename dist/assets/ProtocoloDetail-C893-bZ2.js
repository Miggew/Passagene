import{r as i,s,i as Q,a as U,j as e,g as W,h as B}from"./index-CWtHucPz.js";import{u as y,C as T,a as F,b as O,c as $}from"./use-toast-C_ednEV-.js";import{T as V,a as J,b as q,c as I,d as H,e as S}from"./table-2v-HqcxP.js";import{D as X,b as Y,c as ee,d as te,e as ae}from"./dialog-DG0TUp-m.js";import"./alert-dialog-BfCZBKmD.js";import"./input-bF23Jkur.js";import"./label-CDN-yMr6.js";import"./textarea-EUsZECCO.js";import"./select-BUr2m4f3.js";import"./tabs-DDZz3sTw.js";import{B as Z}from"./badge-DewFfdNp.js";import{P as oe}from"./PageHeader-DqMTzrbX.js";import{E as re}from"./EmptyState-B00kV8BS.js";import{f as L}from"./dateUtils-eJ5e6apA.js";import{i as M,g as K}from"./receptoraStatus-DfJ2QNI_.js";import{A as se}from"./arrow-left-Xhigw_OT.js";import{C as ie}from"./circle-check-big-WLdPQf4E.js";import"./index-RvRMy3My.js";import"./x-BtWTyRSy.js";import"./index-H2w26JuE.js";import"./check-D_BDiPDp.js";import"./index-B77RxHAU.js";function ce({protocoloId:a}){const{toast:o}=y(),[D,d]=i.useState(!0),[u,z]=i.useState(null),[h,P]=i.useState(""),[v,C]=i.useState([]),[_,w]=i.useState([]),c=i.useCallback(async()=>{if(!a)return[];const{data:l,error:t}=await s.from("protocolo_receptoras").select("*").eq("protocolo_id",a);if(t)throw t;if(!l||l.length===0)return[];const N=l.map(r=>r.receptora_id),{data:b,error:p}=await s.from("receptoras").select("*").in("id",N);if(p)throw p;const A=new Map((b==null?void 0:b.map(r=>[r.id,r]))||[]);return l.map(r=>{const f=A.get(r.receptora_id);return f?{...f,pr_id:r.id,pr_status:r.status,pr_motivo_inapta:r.motivo_inapta,pr_observacoes:r.observacoes}:null}).filter(r=>r!==null)},[a]),n=i.useCallback(async l=>{var g;const{data:t,error:N}=await s.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",l);if(N)throw N;const b=(t==null?void 0:t.map(R=>R.receptora_id))||[];if(b.length===0){w([]);return}const[p,A]=await Promise.all([s.from("receptoras").select("id, identificacao, nome, status_reprodutivo").in("id",b).order("identificacao",{ascending:!0}),s.from("protocolo_receptoras").select("receptora_id").eq("protocolo_id",a)]);if(p.error)throw p.error;const r=p.data||[],f=((g=A.data)==null?void 0:g.map(R=>R.receptora_id))||[],m=r.filter(R=>f.includes(R.id)?!1:(R.status_reprodutivo||"VAZIA")==="VAZIA");w(m)},[a]),x=i.useCallback(async()=>{if(a)try{d(!0);const{data:l,error:t}=await s.from("protocolos_sincronizacao").select("*").eq("id",a).single();if(t)throw t;z(l);const[N,b]=await Promise.all([s.from("fazendas").select("nome").eq("id",l.fazenda_id).single(),c()]);if(N.error)throw N.error;P(N.data.nome),C(b),await n(l.fazenda_id)}catch(l){o({title:"Erro ao carregar dados",description:l instanceof Error?l.message:"Erro desconhecido",variant:"destructive"})}finally{d(!1)}},[a,c,n,o]),j=i.useCallback(async()=>{u&&await n(u.fazenda_id)},[u,n]);return{loading:D,protocolo:u,setProtocolo:z,fazendaNome:h,receptoras:v,setReceptoras:C,receptorasDisponiveis:_,loadData:x,loadReceptoras:c,reloadReceptorasDisponiveis:j}}function ne({protocoloId:a,protocolo:o,receptoras:D,onSuccess:d}){const{toast:u}=y(),z=i.useRef(!1),[h,P]=i.useState(!1),[v,C]=i.useState({receptora_id:"",observacoes:""}),_=i.useCallback(()=>{C({receptora_id:"",observacoes:""})},[]),w=i.useCallback((n,x)=>{C(j=>({...j,[n]:x}))},[]),c=i.useCallback(async()=>{var n;if(!(h||z.current)){if(!v.receptora_id){u({title:"Erro",description:"Selecione uma receptora",variant:"destructive"});return}try{z.current=!0,P(!0);const{data:x,error:j}=await s.from("receptoras").select("id, identificacao, status_reprodutivo").eq("id",v.receptora_id).single();if(j)throw j;const{data:l}=await s.from("protocolo_receptoras").select("receptora_id").eq("protocolo_id",a);if(l&&l.length>0){const A=l.map(m=>m.receptora_id);if(A.includes(v.receptora_id)){u({title:"Receptora já está no protocolo",description:"Essa receptora já está adicionada a este protocolo.",variant:"destructive"});return}const{data:r}=await s.from("receptoras").select("id, identificacao").in("id",A);if(r==null?void 0:r.find(m=>m.identificacao===x.identificacao)){u({title:"Brinco já está no protocolo",description:`Já existe uma receptora com o brinco "${x.identificacao}" neste protocolo.`,variant:"destructive"});return}}const{data:t}=await s.from("protocolo_receptoras").select(`
          id,
          protocolo_id,
          status,
          motivo_inapta,
          protocolos_sincronizacao!inner (
            id,
            status,
            data_inicio
          )
        `).eq("receptora_id",v.receptora_id).neq("protocolos_sincronizacao.status","SINCRONIZADO");if(t&&t.length>0){const A=t.find(f=>f.protocolo_id===a);if(A){u({title:"Receptora já está no protocolo",description:`Esta receptora já foi adicionada (Status: ${A.status}).`,variant:"destructive"}),d();return}const r=t.filter(f=>{var R;const m=(R=f.protocolos_sincronizacao)==null?void 0:R.status,g=f.status;return g==="INAPTA"?!1:(g==="APTA"||g==="INICIADA")&&m!=="SINCRONIZADO"&&m!=="FECHADO"});if(r.length>0){const m=r[0].protocolos_sincronizacao;u({title:"Receptora em outro protocolo ativo",description:`Esta receptora está vinculada a outro protocolo ativo (ID: ${(n=m==null?void 0:m.id)==null?void 0:n.substring(0,8)}). Finalize o protocolo anterior antes de adicionar a um novo.`,variant:"destructive"});return}}const N=(x==null?void 0:x.status_reprodutivo)||"VAZIA";if(!M(N)){u({title:"Receptora não disponível",description:K(N),variant:"destructive"});return}const b={protocolo_id:a,receptora_id:v.receptora_id,evento_fazenda_id:o==null?void 0:o.fazenda_id,data_inclusao:o==null?void 0:o.data_inicio,status:"INICIADA",observacoes:v.observacoes||null},{error:p}=await s.from("protocolo_receptoras").insert([b]).select();if(p){if(p.code==="23505"){u({title:"Receptora já está no protocolo",description:"Esta receptora já foi adicionada a este protocolo.",variant:"destructive"}),d();return}throw p}u({title:"Receptora adicionada",description:"Receptora adicionada ao protocolo com sucesso"}),_(),d()}catch(x){u({title:"Erro ao adicionar receptora",description:x instanceof Error?x.message:"Erro desconhecido",variant:"destructive"})}finally{P(!1),z.current=!1}}},[h,v,a,o,d,_,u]);return{formData:v,setFormData:C,updateField:w,submitting:h,resetForm:_,handleAddReceptora:c}}function de({protocoloId:a,protocolo:o,onSuccess:D}){const{toast:d}=y(),[u,z]=i.useState(!1),[h,P]=i.useState({identificacao:"",nome:"",observacoes:""}),v=i.useCallback(()=>{P({identificacao:"",nome:"",observacoes:""})},[]),C=i.useCallback((w,c)=>{P(n=>({...n,[w]:c}))},[]),_=i.useCallback(async()=>{var w;if(!h.identificacao.trim()){d({title:"Erro de validação",description:"Identificação (brinco) é obrigatória",variant:"destructive"});return}if(!(!o||!a))try{z(!0);const c=h.identificacao.trim(),{data:n}=await s.from("receptoras").select("id, identificacao, status_reprodutivo").ilike("identificacao",c);if(n&&n.length>0){const{data:p}=await s.from("protocolo_receptoras").select("receptora_id, status").eq("protocolo_id",a);if(p&&p.length>0){const f=n.map(E=>E.id),m=p.find(E=>f.includes(E.receptora_id));if(m){d({title:"Receptora já está no protocolo",description:`Esta receptora já foi adicionada (Status: ${m.status}).`,variant:"destructive"});return}const g=p.map(E=>E.receptora_id),{data:R}=await s.from("receptoras").select("id, identificacao").in("id",g),k=R==null?void 0:R.find(E=>E.identificacao===c);if(k){const E=p.find(G=>G.receptora_id===k.id);d({title:"Brinco já está no protocolo",description:`Já existe uma receptora com o brinco "${c}" neste protocolo (Status: ${(E==null?void 0:E.status)||"N/A"}).`,variant:"destructive"});return}}for(const f of n){const m=f.status_reprodutivo||"VAZIA";if(!M(m)){d({title:"Receptora não disponível",description:`Já existe uma receptora com esse brinco que está ${K(m)}`,variant:"destructive"});return}}const A=n.map(f=>f.id),{data:r}=await s.from("receptora_fazenda_historico").select("receptora_id, fazenda_id").in("receptora_id",A).eq("fazenda_id",o.fazenda_id).is("data_fim",null);if(r&&r.length>0){const f=r[0].receptora_id,m=n.find(g=>g.id===f);if(m){const{error:g}=await s.from("protocolo_receptoras").insert([{protocolo_id:a,receptora_id:m.id,evento_fazenda_id:o.fazenda_id,data_inclusao:o.data_inicio,status:"INICIADA",observacoes:h.observacoes||null}]);if(g){if(g.code==="23505"){d({title:"Receptora já está no protocolo",description:"Esta receptora já foi adicionada.",variant:"destructive"}),D();return}throw g}d({title:"Receptora adicionada",description:"Receptora existente foi adicionada ao protocolo"}),v(),D();return}}}const x={identificacao:c};h.nome.trim()&&(x.nome=h.nome.trim());const{data:j,error:l}=await s.from("receptoras").insert([x]).select().single();if(l)throw l.code==="23505"?new Error("Já existe uma receptora com esse brinco."):l;const{data:t}=await s.from("receptora_fazenda_historico").select("id").eq("receptora_id",j.id).eq("fazenda_id",o.fazenda_id).is("data_fim",null).maybeSingle();if(!t){const{error:p}=await s.from("receptora_fazenda_historico").insert([{receptora_id:j.id,fazenda_id:o.fazenda_id,data_inicio:new Date().toISOString().split("T")[0],data_fim:null}]);if(p)throw(w=p.message)!=null&&w.includes("brinco")||p.code==="P0001"?(await s.from("receptoras").delete().eq("id",j.id),new Error("Já existe uma receptora com esse brinco nesta fazenda.")):p}const{data:N}=await s.from("receptora_fazenda_historico").select("id").eq("receptora_id",j.id).eq("fazenda_id",o.fazenda_id).is("data_fim",null).maybeSingle();if(!N){await s.from("receptoras").delete().eq("id",j.id),d({title:"Erro ao criar receptora",description:"Não foi possível vincular a receptora à fazenda.",variant:"destructive"});return}const{error:b}=await s.from("protocolo_receptoras").insert([{protocolo_id:a,receptora_id:j.id,evento_fazenda_id:o.fazenda_id,data_inclusao:o.data_inicio,status:"INICIADA",observacoes:h.observacoes||null}]);if(b){if(await s.from("receptoras").delete().eq("id",j.id),b.code==="23505"){d({title:"Receptora já está no protocolo",description:"Esta receptora já foi adicionada.",variant:"destructive"}),D();return}throw b}d({title:"Receptora criada e adicionada",description:"Receptora criada e adicionada ao protocolo com sucesso"}),v(),D()}catch(c){d({title:"Erro ao criar receptora",description:c instanceof Error?c.message:"Erro desconhecido",variant:"destructive"})}finally{z(!1)}},[h,a,o,D,v,d]);return{formData:h,setFormData:P,updateField:C,submitting:u,resetForm:v,handleCreateReceptora:_}}function Ie(){const{id:a}=Q(),o=U(),{toast:D}=y(),[d,u]=i.useState(!1),[z,h]=i.useState(!1),[P,v]=i.useState(!1),{loading:C,protocolo:_,fazendaNome:w,receptoras:c,loadData:n,reloadReceptorasDisponiveis:x}=ce({protocoloId:a});ne({protocoloId:a,protocolo:_,receptoras:c,onSuccess:()=>{u(!1),n()}}),de({protocoloId:a,protocolo:_,onSuccess:()=>{u(!1),n()}}),i.useEffect(()=>{a&&n()},[a,n]),i.useEffect(()=>{d&&_&&x()},[d,_,x]);const j=()=>{h(!1),D({title:"1º passo concluído com sucesso",description:`${c.length} receptoras em sincronização`}),o("/protocolos")};return C?e.jsx(W,{}):_?e.jsxs("div",{className:"space-y-6",children:[e.jsx(oe,{title:`Protocolo - ${w}`,description:"Protocolo finalizado",actions:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{variant:"outline",size:"icon",onClick:()=>o("/protocolos"),children:e.jsx(se,{className:"w-4 h-4"})}),!1]})}),e.jsxs(T,{children:[e.jsx(F,{children:e.jsx(O,{children:"Informações do Protocolo"})}),e.jsxs($,{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Fazenda"}),e.jsx("p",{className:"text-base text-slate-900",children:w})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Data Início"}),e.jsx("p",{className:"text-base text-slate-900",children:L(_.data_inicio)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Responsável"}),e.jsx("p",{className:"text-base text-slate-900",children:_.responsavel_inicio})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Status"}),e.jsx("div",{className:"text-base text-slate-900",children:e.jsx(Z,{variant:"secondary",children:"1º Passo Concluído"})})]})]})]}),e.jsxs(T,{children:[e.jsx(F,{children:e.jsxs(O,{children:["Receptoras do Protocolo (",c.length,")"]})}),e.jsx($,{children:e.jsxs(V,{children:[e.jsx(J,{children:e.jsxs(q,{children:[e.jsx(I,{children:"Brinco"}),e.jsx(I,{children:"Nome"}),e.jsx(I,{children:"Status"}),e.jsx(I,{children:"Observações"})]})}),e.jsx(H,{children:c.length===0?e.jsx(q,{children:e.jsx(S,{colSpan:4,className:"text-center text-slate-500",children:"Nenhuma receptora adicionada ao protocolo"})}):c.map(t=>e.jsxs(q,{children:[e.jsx(S,{className:"font-medium",children:t.identificacao}),e.jsx(S,{children:t.nome||"-"}),e.jsx(S,{children:e.jsx(Z,{variant:"secondary",children:t.pr_status==="INICIADA"?"Em Sincronização":t.pr_status})}),e.jsx(S,{className:"max-w-xs truncate",children:t.pr_observacoes||"-"})]},t.id))})]})})]}),e.jsx(X,{open:z,onOpenChange:h,children:e.jsxs(Y,{className:"max-w-2xl",children:[e.jsxs(ee,{children:[e.jsxs(te,{className:"flex items-center gap-2",children:[e.jsx(ie,{className:"w-6 h-6 text-green-600"}),"Resumo do 1º Passo"]}),e.jsx(ae,{children:"1º passo concluído com sucesso"})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 p-4 bg-slate-50 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Fazenda"}),e.jsx("p",{className:"text-base text-slate-900",children:w})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Data do 1º Passo"}),e.jsx("p",{className:"text-base text-slate-900",children:L(_.data_inicio)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Responsável"}),e.jsx("p",{className:"text-base text-slate-900",children:_.responsavel_inicio})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Total de Receptoras"}),e.jsx("p",{className:"text-base text-slate-900 font-bold",children:c.length})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-700 mb-2",children:"Receptoras em Sincronização:"}),e.jsx("div",{className:"max-h-60 overflow-y-auto border rounded-lg",children:e.jsxs(V,{children:[e.jsx(J,{children:e.jsxs(q,{children:[e.jsx(I,{children:"Brinco"}),e.jsx(I,{children:"Nome"})]})}),e.jsx(H,{children:c.map(t=>e.jsxs(q,{children:[e.jsx(S,{className:"font-medium",children:t.identificacao}),e.jsx(S,{children:t.nome||"-"})]},t.id))})]})})]}),e.jsx("div",{className:"p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("strong",{children:"Próximo passo:"}),' Acesse a aba "2º Passo (para confirmar)" na tela de Protocolos e clique em "INICIAR 2º PASSO" para revisar e confirmar as receptoras.']})}),e.jsx(B,{onClick:j,className:"w-full bg-green-600 hover:bg-green-700",children:"OK - Voltar para Protocolos"})]})]})})]}):e.jsx(re,{title:"Protocolo não encontrado",description:"Volte para a lista e selecione outro protocolo.",action:e.jsx(B,{onClick:()=>o("/protocolos"),variant:"outline",children:"Voltar para Protocolos"})})}export{Ie as default};
