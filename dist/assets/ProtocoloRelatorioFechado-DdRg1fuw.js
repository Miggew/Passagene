import{c as re,e as ie,f as oe,r as _,s as f,j as e,a as ne,B as E,g as F}from"./index-DM5u2d-F.js";import{C as l,a as m,b as x,d as p}from"./card-B_EQ6x91.js";import{T as ce,a as de,b as V,c as b,d as le,e as z}from"./table-CEKyj1ed.js";import{B as g}from"./badge-D_AVhbx8.js";import{u as me}from"./use-toast-BOUGyrIz.js";import{C as xe,Q as pe}from"./QualidadeSemaforo-CtCykpmc.js";import{A as he}from"./arrow-left-CH9vqVt5.js";import"./popover-CNdtTvFz.js";import"./index-sCsFC1oc.js";import"./index-CWb7Yp_3.js";import"./check-Y5eEMkO8.js";import"./x-DsJYRTDR.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=re("Printer",[["path",{d:"M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2",key:"143wyd"}],["path",{d:"M6 9V3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v6",key:"1itne7"}],["rect",{x:"6",y:"14",width:"12",height:"8",rx:"1",key:"1ue0tg"}]]);function Ce(){const{id:w}=ie(),q=oe(),{toast:Q}=me(),[Z,O]=_.useState(!0),[o,G]=_.useState(null),[J,K]=_.useState(""),[B,U]=_.useState([]),[d,k]=_.useState(null),[N,W]=_.useState({totalIniciaram:0,totalConcluiram:0,totalDescartadas:0,totalConfirmadas:0}),X=async a=>{try{const{data:r}=await f.from("protocolo_receptoras").select("receptora_id").eq("protocolo_id",a.id).limit(1);if(!r||r.length===0)return a.observacoes||"";const n=r[0].receptora_id,{data:t}=await f.from("receptora_fazenda_historico").select(`
          fazenda_id,
          data_inicio
        `).eq("receptora_id",n).order("data_inicio",{ascending:!0});if(!t||t.length<2)return a.observacoes||"";const c=new Set;for(const s of t)s.fazenda_id&&c.add(s.fazenda_id);const{data:u}=await f.from("fazendas").select("id, nome").in("id",Array.from(c)),h=new Map;if(u)for(const s of u)h.set(s.id,s.nome);const H=a.data_inicio.split("T")[0],[i,T,y]=H.split("-").map(Number),C=new Date(i,T-1,y);let j=null,L=1/0;for(let s=1;s<t.length;s++){const v=t[s],M=t[s-1],A=v.data_inicio.split("T")[0],[P,I,R]=A.split("-").map(Number),D=new Date(P,I-1,R),S=Math.abs((D.getTime()-C.getTime())/(1e3*60*60*24));S<=1&&S<L&&(L=S,j={fazendaOrigem:h.get(M.fazenda_id)||"Fazenda desconhecida",fazendaDestino:h.get(v.fazenda_id)||"Fazenda desconhecida",dataMudanca:v.data_inicio})}if(!j&&t.length>1)for(let s=t.length-1;s>=1;s--){const v=t[s],M=t[s-1],A=v.data_inicio.split("T")[0],[P,I,R]=A.split("-").map(Number),D=new Date(P,I-1,R);if(D<=C&&(C.getTime()-D.getTime())/(1e3*60*60*24)<=2){j={fazendaOrigem:h.get(M.fazenda_id)||"Fazenda desconhecida",fazendaDestino:h.get(v.fazenda_id)||"Fazenda desconhecida",dataMudanca:v.data_inicio};break}}if(j){const s=new Date(j.dataMudanca).toLocaleDateString("pt-BR");return`${a.observacoes} (Mudança: ${j.fazendaOrigem} → ${j.fazendaDestino} em ${s})`}return a.observacoes||""}catch{return a.observacoes||""}};_.useEffect(()=>{w&&Y()},[w]);const Y=async()=>{try{O(!0);const{data:a,error:r}=await f.from("protocolos_sincronizacao").select("*").eq("id",w).single();if(r)throw r;let n=a.observacoes;a.observacoes&&a.observacoes.includes("Protocolo criado automaticamente")&&(n=await X(a)),G({...a,observacoes:n});const{data:t,error:c}=await f.from("fazendas").select("nome").eq("id",a.fazenda_id).single();if(c)throw c;K(t.nome),await ee(a.id),await ae({...a,observacoes:n})}catch{}finally{O(!1)}},ee=async a=>{try{const{data:r,error:n}=await f.from("protocolo_receptoras").select("id").eq("protocolo_id",a);if(n||!r||r.length===0)return;const t=r.map(h=>h.id),{data:c,error:u}=await f.from("transferencias_embrioes").select("data_te, veterinario_responsavel, tecnico_responsavel").in("protocolo_receptora_id",t).eq("status_te","REALIZADA").order("data_te",{ascending:!1}).order("created_at",{ascending:!1}).limit(1).single();if(u)return;c&&k({data_te:c.data_te,veterinario_responsavel:c.veterinario_responsavel||void 0,tecnico_responsavel:c.tecnico_responsavel||void 0})}catch{k(null)}},ae=async a=>{try{const{data:r,error:n}=await f.from("protocolo_receptoras").select("*").eq("protocolo_id",a.id).order("data_inclusao",{ascending:!0});if(n)throw n;const t=[];for(const i of r||[]){const{data:T,error:y}=await f.from("receptoras").select("*").eq("id",i.receptora_id).single();y||t.push({...T,pr_id:i.id,pr_status:i.status,pr_motivo_inapta:i.motivo_inapta,pr_data_inclusao:i.data_inclusao,pr_data_retirada:i.data_retirada,pr_ciclando_classificacao:i.ciclando_classificacao,pr_qualidade_semaforo:i.qualidade_semaforo})}U(t);const c=t.length,u=t.filter(i=>i.pr_status==="APTA").length,h=t.filter(i=>i.pr_status==="INAPTA").length;W({totalIniciaram:c,totalConcluiram:u,totalDescartadas:h,totalConfirmadas:u})}catch{Q({title:"Erro ao carregar receptoras",description:"Não foi possível carregar a lista de receptoras do protocolo.",variant:"destructive"})}},$=a=>{if(!a)return{veterinario:null,tecnico:null};const r=a.match(/VET:\s*(.+?)(?:\s*\||$)/i),n=a.match(/TEC:\s*(.+?)(?:\s*\||$)/i);return{veterinario:r?r[1].trim():null,tecnico:n?n[1].trim():null}},te=a=>a==="APTA"?e.jsx(g,{variant:"default",className:"bg-green-600",children:"Confirmada"}):a==="INAPTA"?e.jsx(g,{variant:"destructive",children:"Descartada"}):e.jsx(g,{variant:"secondary",children:a}),se=()=>{window.print()};return Z?e.jsx(ne,{}):o?e.jsxs("div",{className:"space-y-6 print:space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between print:hidden",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(E,{variant:"ghost",size:"sm",onClick:()=>q("/protocolos"),children:e.jsx(he,{className:"w-4 h-4"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-slate-900",children:"Relatório do Protocolo"}),e.jsx("p",{className:"text-slate-600 mt-1",children:"Visualização somente leitura"})]})]}),e.jsxs(E,{onClick:se,variant:"outline",children:[e.jsx(fe,{className:"w-4 h-4 mr-2"}),"Imprimir"]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(l,{children:[e.jsx(m,{children:e.jsx(x,{children:"Informações Gerais"})}),e.jsxs(p,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Fazenda"}),e.jsx("p",{className:"text-base text-slate-900 mt-1",children:J||"—"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Data de Início"}),e.jsx("p",{className:"text-base text-slate-900 mt-1",children:o.data_inicio?F(o.data_inicio):"—"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Status"}),e.jsxs("p",{className:"text-base text-slate-900 mt-1",children:[o.status==="SINCRONIZADO"&&e.jsx(g,{variant:"default",className:"bg-green-600",children:"Sincronizado"}),o.status==="FECHADO"&&e.jsx(g,{variant:"default",className:"bg-slate-600",children:"Fechado"}),o.status==="PASSO1_FECHADO"&&e.jsx(g,{variant:"default",className:"bg-yellow-600",children:"Aguardando 2º Passo"})]})]})]})]}),e.jsxs(l,{children:[e.jsx(m,{children:e.jsx(x,{children:"1º Passo"})}),e.jsxs(p,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Veterinário Responsável"}),e.jsx("p",{className:"text-base text-slate-900 mt-1",children:$(o.responsavel_inicio).veterinario||"—"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Técnico Responsável"}),e.jsx("p",{className:"text-base text-slate-900 mt-1",children:$(o.responsavel_inicio).tecnico||"—"})]})]})]}),e.jsxs(l,{children:[e.jsx(m,{children:e.jsx(x,{children:"2º Passo"})}),e.jsxs(p,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Data de Realização"}),e.jsx("p",{className:"text-base text-slate-900 mt-1",children:o.passo2_data?F(o.passo2_data):"—"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Técnico Responsável"}),e.jsx("p",{className:"text-base text-slate-900 mt-1",children:o.passo2_tecnico_responsavel||"—"})]})]})]}),d&&(d.data_te||d.veterinario_responsavel||d.tecnico_responsavel)&&e.jsxs(l,{children:[e.jsx(m,{children:e.jsx(x,{children:"Transferência de Embriões"})}),e.jsxs(p,{className:"space-y-4",children:[d.data_te&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Data da TE"}),e.jsx("p",{className:"text-base text-slate-900 mt-1",children:F(d.data_te)})]}),d.veterinario_responsavel&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Veterinário Responsável"}),e.jsx("p",{className:"text-base text-slate-900 mt-1",children:d.veterinario_responsavel})]}),d.tecnico_responsavel&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Técnico Responsável"}),e.jsx("p",{className:"text-base text-slate-900 mt-1",children:d.tecnico_responsavel})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs(l,{children:[e.jsx(m,{className:"pb-3",children:e.jsx(x,{className:"text-base",children:"Total Iniciaram"})}),e.jsx(p,{children:e.jsx("p",{className:"text-3xl font-bold text-slate-900",children:N.totalIniciaram})})]}),e.jsxs(l,{children:[e.jsx(m,{className:"pb-3",children:e.jsx(x,{className:"text-base",children:"Confirmadas"})}),e.jsx(p,{children:e.jsx("p",{className:"text-3xl font-bold text-green-600",children:N.totalConfirmadas})})]}),e.jsxs(l,{children:[e.jsx(m,{className:"pb-3",children:e.jsx(x,{className:"text-base",children:"Descartadas"})}),e.jsx(p,{children:e.jsx("p",{className:"text-3xl font-bold text-red-600",children:N.totalDescartadas})})]}),e.jsxs(l,{children:[e.jsx(m,{className:"pb-3",children:e.jsx(x,{className:"text-base",children:"Taxa de Sucesso"})}),e.jsx(p,{children:e.jsxs("p",{className:"text-3xl font-bold text-blue-600",children:[N.totalIniciaram>0?Math.round(N.totalConfirmadas/N.totalIniciaram*100):0,"%"]})})]})]}),e.jsxs(l,{children:[e.jsx(m,{children:e.jsx(x,{children:"Receptoras e Resultado Final"})}),e.jsx(p,{children:B.length===0?e.jsx("p",{className:"text-slate-500 text-center py-4",children:"Nenhuma receptora no protocolo"}):e.jsxs(ce,{children:[e.jsx(de,{children:e.jsxs(V,{children:[e.jsx(b,{children:"Identificação"}),e.jsx(b,{children:"Ciclando"}),e.jsx(b,{children:"Qualidade"}),e.jsx(b,{children:"Resultado Final"}),e.jsx(b,{children:"Motivo do Descarte"})]})}),e.jsx(le,{children:B.map(a=>e.jsxs(V,{children:[e.jsxs(z,{className:"font-medium",children:[a.identificacao,a.nome?` - ${a.nome}`:""]}),e.jsx(z,{children:e.jsx(xe,{value:a.pr_ciclando_classificacao,variant:"display",disabled:!0})}),e.jsx(z,{children:e.jsx(pe,{value:a.pr_qualidade_semaforo,variant:"single",disabled:!0})}),e.jsx(z,{children:te(a.pr_status)}),e.jsx(z,{children:a.pr_motivo_inapta||"—"})]},a.id))})]})})]}),o.observacoes&&e.jsxs(l,{children:[e.jsx(m,{children:e.jsx(x,{children:"Observações"})}),e.jsx(p,{children:e.jsx("p",{className:"text-slate-700 whitespace-pre-wrap",children:o.observacoes})})]})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx("p",{className:"text-slate-600",children:"Protocolo não encontrado"}),e.jsx(E,{onClick:()=>q("/protocolos"),className:"mt-4",children:"Voltar para Protocolos"})]})}export{Ce as default};
