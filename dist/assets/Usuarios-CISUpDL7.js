import{d as le,r as l,s as n,j as e,g as ne,h as S,U as ce,a5 as de}from"./index-CWtHucPz.js";import{u as me,C as _,c as b,a as he,b as pe}from"./use-toast-C_ednEV-.js";import{T as ue,a as xe,b as M,c as x,d as je,e as j}from"./table-2v-HqcxP.js";import{D as fe,b as ge,c as ve,d as _e,e as be}from"./dialog-DG0TUp-m.js";import{S as k,a as L,b as q,c as F,d as h}from"./select-BUr2m4f3.js";import{I as H}from"./input-bF23Jkur.js";import{L as f}from"./label-CDN-yMr6.js";import{C as Ne}from"./checkbox-_-5iNsQZ.js";import{B as E}from"./badge-DewFfdNp.js";import{S as R}from"./switch-CTwIGhep.js";import{P as ye}from"./PageHeader-DqMTzrbX.js";import{E as G}from"./EmptyState-B00kV8BS.js";import{P as we}from"./plus-CgYPqLq7.js";import{S as Ce}from"./search-B6nVOFfl.js";import{S as Se}from"./square-pen-VnVIDeeL.js";import"./index-RvRMy3My.js";import"./x-BtWTyRSy.js";import"./index-H2w26JuE.js";import"./check-D_BDiPDp.js";function Ge(){const{toast:d}=me(),{permissions:T}=le(),[J,O]=l.useState(!0),[g,W]=l.useState([]),[K,Q]=l.useState([]),[X,Y]=l.useState([]),[v,Z]=l.useState(""),[N,ee]=l.useState("todos"),[se,y]=l.useState(!1),[t,z]=l.useState(null),[B,I]=l.useState(!1),[i,m]=l.useState({nome:"",email:"",user_type:"operacional",cliente_id:"",active:!0,hub_permissions:[]}),U=T==null?void 0:T.isAdmin;l.useEffect(()=>{U&&D()},[U]);const D=async()=>{try{O(!0);const{data:s,error:r}=await n.from("hubs").select("*").order("display_order");if(r)throw r;Q(s||[]);const{data:a,error:o}=await n.from("clientes").select("id, nome").order("nome");if(o)throw o;Y(a||[]);const{data:c,error:p}=await n.from("user_profiles").select("*").order("nome");if(p)throw p;const{data:w,error:C}=await n.from("user_hub_permissions").select("user_id, hub_code").eq("can_access",!0);if(C)throw C;const P=new Map;(w||[]).forEach(u=>{const $=P.get(u.user_id)||[];$.push(u.hub_code),P.set(u.user_id,$)});const oe=(c||[]).map(u=>({...u,hub_permissions:P.get(u.id)||[]}));W(oe)}catch(s){d({title:"Erro ao carregar dados",description:s instanceof Error?s.message:"Erro desconhecido",variant:"destructive"})}finally{O(!1)}},A=g.filter(s=>{var o,c;const r=!v||((o=s.nome)==null?void 0:o.toLowerCase().includes(v.toLowerCase()))||((c=s.email)==null?void 0:c.toLowerCase().includes(v.toLowerCase())),a=N==="todos"||s.user_type===N;return r&&a}),V=s=>{s?(z(s),m({nome:s.nome||"",email:s.email||"",user_type:s.user_type,cliente_id:s.cliente_id||"",active:s.active,hub_permissions:s.hub_permissions})):(z(null),m({nome:"",email:"",user_type:"operacional",cliente_id:"",active:!0,hub_permissions:[]})),y(!0)},ie=s=>{m(r=>{const a=r.hub_permissions;return a.includes(s)?{...r,hub_permissions:a.filter(o=>o!==s)}:{...r,hub_permissions:[...a,s]}})},re=async s=>{if(s.preventDefault(),!i.nome.trim()||!i.email.trim()){d({title:"Erro de validação",description:"Nome e email são obrigatórios",variant:"destructive"});return}if(i.user_type==="cliente"&&!i.cliente_id){d({title:"Erro de validação",description:"Selecione um cliente para usuários do tipo Cliente",variant:"destructive"});return}try{if(I(!0),t){const{error:r}=await n.from("user_profiles").update({nome:i.nome,user_type:i.user_type,cliente_id:i.user_type==="cliente"?i.cliente_id:null,active:i.active}).eq("id",t.id);if(r)throw r;const{error:a}=await n.from("user_hub_permissions").delete().eq("user_id",t.id);if(a)throw a;if(i.hub_permissions.length>0&&i.user_type!=="admin"){const o=i.hub_permissions.map(p=>({user_id:t.id,hub_code:p,can_access:!0})),{error:c}=await n.from("user_hub_permissions").insert(o);if(c)throw c}d({title:"Usuário atualizado",description:"Perfil e permissões atualizados com sucesso"})}else{const{data:r,error:a}=await n.from("user_profiles").select("id").eq("email",i.email.toLowerCase()).maybeSingle();if(a)throw a;if(r){d({title:"Usuário já existe",description:"Já existe um perfil para este email. Use a opção de editar.",variant:"destructive"});return}const{data:o,error:c}=await n.from("user_profiles").insert({nome:i.nome,email:i.email.toLowerCase(),user_type:i.user_type,cliente_id:i.user_type==="cliente"?i.cliente_id:null,active:i.active}).select().single();if(c)throw c;if(i.hub_permissions.length>0&&i.user_type!=="admin"){const p=i.hub_permissions.map(C=>({user_id:o.id,hub_code:C,can_access:!0})),{error:w}=await n.from("user_hub_permissions").insert(p);if(w)throw w}d({title:"Usuário criado",description:"Perfil criado. O usuário precisa fazer cadastro com este email."})}y(!1),D()}catch(r){d({title:"Erro ao salvar",description:r instanceof Error?r.message:"Erro desconhecido",variant:"destructive"})}finally{I(!1)}},ae=async s=>{try{const{error:r}=await n.from("user_profiles").update({active:!s.active}).eq("id",s.id);if(r)throw r;d({title:s.active?"Usuário desativado":"Usuário ativado",description:`${s.nome} foi ${s.active?"desativado":"ativado"}`}),D()}catch(r){d({title:"Erro ao atualizar",description:r instanceof Error?r.message:"Erro desconhecido",variant:"destructive"})}},te=s=>{switch(s){case"admin":return e.jsx(E,{className:"bg-purple-100 text-purple-800",children:"Admin"});case"cliente":return e.jsx(E,{className:"bg-blue-100 text-blue-800",children:"Cliente"});default:return e.jsx(E,{className:"bg-gray-100 text-gray-800",children:"Operacional"})}};return U?J?e.jsx(ne,{}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(ye,{title:"Administração de Usuários",description:"Gerencie perfis e permissões de acesso",actions:e.jsxs(S,{className:"bg-green-600 hover:bg-green-700",onClick:()=>V(),children:[e.jsx(we,{className:"w-4 h-4 mr-2"}),"Novo Usuário"]})}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(_,{children:e.jsx(b,{className:"pt-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ce,{className:"w-5 h-5 text-slate-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-500",children:"Total"}),e.jsx("p",{className:"text-2xl font-bold",children:g.length})]})]})})}),e.jsx(_,{children:e.jsxs(b,{className:"pt-4",children:[e.jsx("p",{className:"text-sm text-slate-500",children:"Admins"}),e.jsx("p",{className:"text-2xl font-bold",children:g.filter(s=>s.user_type==="admin").length})]})}),e.jsx(_,{children:e.jsxs(b,{className:"pt-4",children:[e.jsx("p",{className:"text-sm text-slate-500",children:"Operacionais"}),e.jsx("p",{className:"text-2xl font-bold",children:g.filter(s=>s.user_type==="operacional").length})]})}),e.jsx(_,{children:e.jsxs(b,{className:"pt-4",children:[e.jsx("p",{className:"text-sm text-slate-500",children:"Clientes"}),e.jsx("p",{className:"text-2xl font-bold",children:g.filter(s=>s.user_type==="cliente").length})]})})]}),e.jsxs("div",{className:"flex flex-wrap gap-4 items-center",children:[e.jsxs("div",{className:"relative flex-1 min-w-[200px] max-w-xs",children:[e.jsx(Ce,{className:"absolute left-2 top-2.5 h-4 w-4 text-slate-400"}),e.jsx(H,{placeholder:"Buscar por nome ou email...",value:v,onChange:s=>Z(s.target.value),className:"pl-8"})]}),e.jsxs(k,{value:N,onValueChange:ee,children:[e.jsx(L,{className:"w-[150px]",children:e.jsx(q,{placeholder:"Tipo"})}),e.jsxs(F,{children:[e.jsx(h,{value:"todos",children:"Todos"}),e.jsx(h,{value:"admin",children:"Admin"}),e.jsx(h,{value:"operacional",children:"Operacional"}),e.jsx(h,{value:"cliente",children:"Cliente"})]})]})]}),e.jsxs(_,{children:[e.jsx(he,{children:e.jsxs(pe,{children:["Usuários (",A.length,")"]})}),e.jsx(b,{children:A.length===0?e.jsx(G,{title:"Nenhum usuário encontrado",description:v||N!=="todos"?"Tente ajustar os filtros":"Cadastre o primeiro usuário"}):e.jsxs(ue,{children:[e.jsx(xe,{children:e.jsxs(M,{children:[e.jsx(x,{children:"Nome"}),e.jsx(x,{children:"Email"}),e.jsx(x,{children:"Tipo"}),e.jsx(x,{children:"Hubs"}),e.jsx(x,{children:"Ativo"}),e.jsx(x,{className:"text-right",children:"Ações"})]})}),e.jsx(je,{children:A.map(s=>e.jsxs(M,{className:s.active?"":"opacity-50",children:[e.jsx(j,{className:"font-medium",children:s.nome||"-"}),e.jsx(j,{children:s.email}),e.jsx(j,{children:te(s.user_type)}),e.jsx(j,{children:s.user_type==="admin"?e.jsx("span",{className:"text-purple-600 text-sm",children:"Acesso total"}):s.hub_permissions.length>0?e.jsx("div",{className:"flex flex-wrap gap-1",children:s.hub_permissions.map(r=>e.jsx(E,{variant:"outline",className:"text-xs",children:r},r))}):e.jsx("span",{className:"text-slate-400 text-sm",children:"Nenhum"})}),e.jsx(j,{children:e.jsx(R,{checked:s.active,onCheckedChange:()=>ae(s)})}),e.jsx(j,{className:"text-right",children:e.jsxs(S,{variant:"ghost",size:"sm",onClick:()=>V(s),children:[e.jsx(Se,{className:"w-4 h-4 mr-1"}),"Editar"]})})]},s.id))})]})})]}),e.jsx(fe,{open:se,onOpenChange:y,children:e.jsxs(ge,{className:"max-w-lg",children:[e.jsxs(ve,{children:[e.jsx(_e,{children:t?"Editar Usuário":"Novo Usuário"}),e.jsx(be,{children:t?`Editando ${t.nome||t.email}`:"Preencha os dados do novo usuário"})]}),e.jsxs("form",{onSubmit:re,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"nome",children:"Nome *"}),e.jsx(H,{id:"nome",value:i.nome,onChange:s=>m({...i,nome:s.target.value}),placeholder:"Nome completo",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"email",children:"Email *"}),e.jsx(H,{id:"email",type:"email",value:i.email,onChange:s=>m({...i,email:s.target.value}),placeholder:"email@exemplo.com",required:!0,disabled:!!t}),!t&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"O usuário precisará fazer cadastro com este email"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"user_type",children:"Tipo de Usuário *"}),e.jsxs(k,{value:i.user_type,onValueChange:s=>m({...i,user_type:s}),children:[e.jsx(L,{children:e.jsx(q,{})}),e.jsxs(F,{children:[e.jsx(h,{value:"admin",children:"Admin (acesso total)"}),e.jsx(h,{value:"operacional",children:"Operacional"}),e.jsx(h,{value:"cliente",children:"Cliente"})]})]})]}),i.user_type==="cliente"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"cliente_id",children:"Cliente Vinculado *"}),e.jsxs(k,{value:i.cliente_id,onValueChange:s=>m({...i,cliente_id:s}),children:[e.jsx(L,{children:e.jsx(q,{placeholder:"Selecione o cliente"})}),e.jsx(F,{children:X.map(s=>e.jsx(h,{value:s.id,children:s.nome},s.id))})]})]}),i.user_type!=="admin"&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs(f,{className:"flex items-center gap-2",children:[e.jsx(de,{className:"w-4 h-4"}),"Permissões de Acesso"]}),e.jsx("div",{className:"grid grid-cols-2 gap-3 p-3 border rounded-lg",children:K.map(s=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ne,{id:`hub-${s.code}`,checked:i.hub_permissions.includes(s.code),onCheckedChange:()=>ie(s.code)}),e.jsx("label",{htmlFor:`hub-${s.code}`,className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 cursor-pointer",children:s.name})]},s.id))}),i.hub_permissions.length===0&&e.jsx("p",{className:"text-xs text-amber-600",children:"Sem permissões, o usuário não terá acesso a nenhum hub"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(R,{id:"active",checked:i.active,onCheckedChange:s=>m({...i,active:s})}),e.jsx(f,{htmlFor:"active",children:"Usuário ativo"})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(S,{type:"submit",className:"flex-1 bg-green-600 hover:bg-green-700",disabled:B,children:B?"Salvando...":t?"Salvar":"Criar Usuário"}),e.jsx(S,{type:"button",variant:"outline",onClick:()=>y(!1),children:"Cancelar"})]})]})]})})]}):e.jsx("div",{className:"space-y-6",children:e.jsx(G,{title:"Acesso negado",description:"Apenas administradores podem acessar esta página."})})}export{Ge as default};
