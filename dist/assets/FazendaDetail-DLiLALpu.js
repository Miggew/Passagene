import{c as Qe,r as d,s as p,j as e,B as A,b as Ie,X as qe,g as Ke,f as ea,C as aa,D as sa,L as Ne,d as ta}from"./index-B-7HRnm0.js";import{f as He,S as ra}from"./StatusBadge-B48hPBgT.js";import{N as oa,g as ia,a as na}from"./coordinates-DV_iSMgh.js";import{C as Z,d as J,a as de,b as me}from"./card-DdhhEbXV.js";import{T as De,a as ye,b as ie,c as F,d as Ce,e as I}from"./table-fky3lpGR.js";import{T as ca,a as la,b as be,c as we}from"./tabs-ChsREKvA.js";import{B as G}from"./badge-BCHVCiM7.js";import{P as da}from"./PageHeader-CT7CFo0W.js";import{E as Se}from"./EmptyState-gn01eel2.js";import{u as ve}from"./use-toast-DDUqdzpY.js";import{D as fe,a as he,b as pe,c as ge,d as je,e as ma,f as Ue}from"./dialog-CIXjHraQ.js";import{S as Ee,a as ze,b as Re,c as Me,d as oe}from"./select-B0M3FCy4.js";import{I as re}from"./input-D2h8r4MO.js";import{L as Y}from"./label-vBcRjcSu.js";import{u as ua,a as xa,b as fa}from"./hooks-D8DQgb83.js";import{u as ha}from"./useDebounce-DKd5f0iC.js";import{T as pa}from"./textarea-RmDl789L.js";import{D as ga}from"./DatePickerBR-XHkKTcYs.js";import{F as Ve}from"./filter-WiIDhzCI.js";import{S as Ge}from"./search-DcAWDjHO.js";import{P as Ze}from"./plus-Cnek-_uY.js";import{S as ja}from"./square-pen-BpOU0zlP.js";import{H as Je}from"./history-CVgiEWSN.js";import{A as va}from"./arrow-right-BdNnsrEd.js";import{B as Fe}from"./baby-D2-VQuVM.js";import{m as Ye,a as We}from"./differenceInCalendarDays-CrzntjZV.js";import{f as Na,p as ba}from"./pt-BR-DS62bWKG.js";import{P as wa,D as _a}from"./DoadoraHistoricoAspiracoes-BJDboViY.js";import{f as Sa}from"./dateUtils-eJ5e6apA.js";import{G as Da}from"./gem-CW7dFMYc.js";import{S as le}from"./star-X44RvruR.js";import{A as ya}from"./arrow-left-D9wDrV6g.js";import{M as Ca}from"./map-pin-B7CeMiQc.js";import{U as Ea}from"./user-B8IJeGnS.js";import{A as Le}from"./activity-BuPU1g6A.js";import{B as $e}from"./beef-Cc-72Nix.js";import{C as za}from"./circle-alert-DaEslIuD.js";import{C as Ra}from"./calendar-D8momPux.js";import"./index-C7yzDtsu.js";import"./index-B4eR1KA_.js";import"./check-C6h7QFZL.js";import"./chevron-right-DntnbvYp.js";import"./popover-i4alam_g.js";import"./CountBadge-BBpPT0CT.js";import"./index-C6kCM6Yd.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ma=Qe("Phone",[["path",{d:"M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z",key:"foiqr5"}]]);function Ta(o,t){const s=Ia(o);let m;if(s.date){const u=Oa(s.date,2);m=ka(u.restDateString,u.year)}if(!m||isNaN(m.getTime()))return new Date(NaN);const c=m.getTime();let N=0,x;if(s.time&&(N=Ba(s.time),isNaN(N)))return new Date(NaN);if(s.timezone){if(x=La(s.timezone),isNaN(x))return new Date(NaN)}else{const u=new Date(c+N),n=new Date(0);return n.setFullYear(u.getUTCFullYear(),u.getUTCMonth(),u.getUTCDate()),n.setHours(u.getUTCHours(),u.getUTCMinutes(),u.getUTCSeconds(),u.getUTCMilliseconds()),n}return new Date(c+N+x)}const _e={dateTimeDelimiter:/[T ]/,timeZoneDelimiter:/[Z ]/i,timezone:/([Z+-].*)$/},Pa=/^-?(?:(\d{3})|(\d{2})(?:-?(\d{2}))?|W(\d{2})(?:-?(\d{1}))?|)$/,Aa=/^(\d{2}(?:[.,]\d*)?)(?::?(\d{2}(?:[.,]\d*)?))?(?::?(\d{2}(?:[.,]\d*)?))?$/,Fa=/^([+-])(\d{2})(?::?(\d{2}))?$/;function Ia(o){const t={},a=o.split(_e.dateTimeDelimiter);let s;if(a.length>2)return t;if(/:/.test(a[0])?s=a[0]:(t.date=a[0],s=a[1],_e.timeZoneDelimiter.test(t.date)&&(t.date=o.split(_e.timeZoneDelimiter)[0],s=o.substr(t.date.length,o.length))),s){const m=_e.timezone.exec(s);m?(t.time=s.replace(m[1],""),t.timezone=m[1]):t.time=s}return t}function Oa(o,t){const a=new RegExp("^(?:(\\d{4}|[+-]\\d{"+(4+t)+"})|(\\d{2}|[+-]\\d{"+(2+t)+"})$)"),s=o.match(a);if(!s)return{year:NaN,restDateString:""};const m=s[1]?parseInt(s[1]):null,c=s[2]?parseInt(s[2]):null;return{year:c===null?m:c*100,restDateString:o.slice((s[1]||s[2]).length)}}function ka(o,t){if(t===null)return new Date(NaN);const a=o.match(Pa);if(!a)return new Date(NaN);const s=!!a[4],m=xe(a[1]),c=xe(a[2])-1,N=xe(a[3]),x=xe(a[4]),u=xe(a[5])-1;if(s)return Va(t,x,u)?$a(t,x,u):new Date(NaN);{const n=new Date(0);return!Ha(t,c,N)||!Ua(t,m)?new Date(NaN):(n.setUTCFullYear(t,c,Math.max(m,N)),n)}}function xe(o){return o?parseInt(o):1}function Ba(o){const t=o.match(Aa);if(!t)return NaN;const a=Ae(t[1]),s=Ae(t[2]),m=Ae(t[3]);return Ga(a,s,m)?a*Ye+s*We+m*1e3:NaN}function Ae(o){return o&&parseFloat(o.replace(",","."))||0}function La(o){if(o==="Z")return 0;const t=o.match(Fa);if(!t)return 0;const a=t[1]==="+"?-1:1,s=parseInt(t[2]),m=t[3]&&parseInt(t[3])||0;return Za(s,m)?a*(s*Ye+m*We):NaN}function $a(o,t,a){const s=new Date(0);s.setUTCFullYear(o,0,4);const m=s.getUTCDay()||7,c=(t-1)*7+a+1-m;return s.setUTCDate(s.getUTCDate()+c),s}const qa=[31,null,31,30,31,30,31,31,30,31,30,31];function Xe(o){return o%400===0||o%4===0&&o%100!==0}function Ha(o,t,a){return t>=0&&t<=11&&a>=1&&a<=(qa[t]||(Xe(o)?29:28))}function Ua(o,t){return t>=1&&t<=(Xe(o)?366:365)}function Va(o,t,a){return t>=1&&t<=53&&a>=0&&a<=6}function Ga(o,t,a){return o===24?t===0&&a===0:a>=0&&a<60&&t>=0&&t<60&&o>=0&&o<25}function Za(o,t){return t>=0&&t<=59}function Ja({selectedFazendaId:o}){const[t,a]=d.useState(""),[s,m]=d.useState("all"),c=ha(t,300),[N,x]=d.useState(new Map),[u,n]=d.useState(new Set),{data:M=[],isLoading:R,refetch:O}=ua(),{data:b=[],isLoading:y,refetch:P}=xa(o||void 0);fa();const C=d.useMemo(()=>b.filter(l=>!u.has(l.id)).map(l=>{const D=N.get(l.id);return D?{...l,...D}:l}),[b,N,u]),k=d.useMemo(()=>Array.from(new Set(C.map(l=>l.status_calculado))).filter(l=>l).sort(),[C]),H=d.useMemo(()=>{let l=C;if(s!=="all"&&(l=l.filter(D=>D.status_calculado===s)),c.trim()){const D=c.toLowerCase();l=l.filter(T=>{var r;return T.identificacao.toLowerCase().includes(D)||((r=T.nome)==null?void 0:r.toLowerCase().includes(D))})}return l},[C,s,c]),w=async()=>{await O()},_=async()=>{o&&(x(new Map),n(new Set),await P())},i=async()=>{await _()},f=d.useCallback((l,D)=>{x(T=>{const r=new Map(T),h=r.get(l)||{};return r.set(l,{...h,...D}),r})},[]),v=d.useCallback(l=>{n(D=>new Set(D).add(l))},[]);return{fazendas:M,receptoras:C,filteredReceptoras:H,statusDisponiveis:k,loadingFazendas:R,loadingReceptoras:y,searchTerm:t,setSearchTerm:a,filtroStatus:s,setFiltroStatus:m,loadFazendas:w,loadReceptoras:_,reloadReceptoras:i,updateReceptoraInList:f,removeReceptoraFromList:v}}function Ya({selectedFazendaId:o,onSuccess:t}){const{toast:a}=ve(),[s,m]=d.useState({identificacao:"",nome:""}),[c,N]=d.useState(!1),[x,u]=d.useState({identificacao:"",nome:""}),[n,M]=d.useState(null),[R,O]=d.useState(!1),[b,y]=d.useState(!1),P=d.useCallback(()=>{m({identificacao:"",nome:""})},[]),C=d.useCallback(()=>{u({identificacao:"",nome:""}),M(null)},[]),k=d.useCallback(_=>{M(_),u({identificacao:_.identificacao,nome:_.nome||""}),O(!0)},[]),H=d.useCallback(async _=>{if(_.preventDefault(),!s.identificacao.trim()){a({title:"Erro de validação",description:"Identificação (brinco) é obrigatória",variant:"destructive"});return}if(!o){a({title:"Erro de validação",description:"Selecione uma fazenda primeiro",variant:"destructive"});return}try{y(!0);const{data:i,error:f}=await p.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",o);if(f)throw f;const v=(i==null?void 0:i.map(r=>r.receptora_id))||[];if(v.length>0){const{data:r,error:h}=await p.from("receptoras").select("id, identificacao, nome").in("id",v).ilike("identificacao",s.identificacao.trim());if(h)throw h;if(r&&r.length>0){const E=r[0].nome?`"${r[0].nome}"`:"sem nome";throw new Error(`Já existe uma receptora com o brinco "${s.identificacao.trim()}" nesta fazenda (Nome: ${E}).`)}if(s.nome.trim()){const{data:E,error:L}=await p.from("receptoras").select("id, identificacao").in("id",v).ilike("nome",s.nome.trim());if(L)throw L;if(E&&E.length>0)throw new Error(`Já existe uma receptora com o nome "${s.nome.trim()}" nesta fazenda (Brinco: ${E[0].identificacao}).`)}}const l={identificacao:s.identificacao};s.nome.trim()&&(l.nome=s.nome);const{data:D,error:T}=await p.from("receptoras").insert([l]).select().single();if(T)throw T.code==="23505"?new Error("Já existe uma receptora com esse brinco nesta fazenda."):T;await p.from("receptora_fazenda_historico").insert([{receptora_id:D.id,fazenda_id:o,data_inicio:new Date().toISOString().split("T")[0],data_fim:null}]),a({title:"Receptora criada",description:"Receptora criada com sucesso"}),N(!1),P(),t==null||t()}catch(i){a({title:"Erro ao criar receptora",description:i instanceof Error?i.message:"Erro desconhecido",variant:"destructive"})}finally{y(!1)}},[s,o,a,P,t]),w=d.useCallback(async _=>{if(_.preventDefault(),!!n){if(!x.identificacao.trim()){a({title:"Erro de validação",description:"Identificação (brinco) é obrigatória",variant:"destructive"});return}try{y(!0);const i=n.identificacao,f=x.identificacao.trim(),v=i!==f,l={identificacao:f,nome:x.nome.trim()||null},{error:D}=await p.from("receptoras").update(l).eq("id",n.id);if(D)throw D.code==="23505"?new Error("Já existe uma receptora com esse brinco nesta fazenda."):D;if(v)try{await p.from("receptora_renomeacoes_historico").insert([{receptora_id:n.id,brinco_anterior:i,brinco_novo:f,data_renomeacao:new Date().toISOString(),motivo:"EDICAO_MANUAL",observacoes:null}])}catch{}a({title:"Receptora atualizada",description:v?`Receptora atualizada. Brinco alterado de "${i}" para "${f}".`:"Receptora atualizada com sucesso"}),O(!1),C(),t==null||t()}catch(i){a({title:"Erro ao atualizar receptora",description:i instanceof Error?i.message:"Erro desconhecido",variant:"destructive"})}finally{y(!1)}}},[x,n,a,C,t]);return{formData:s,setFormData:m,showDialog:c,setShowDialog:N,editFormData:x,setEditFormData:u,editingReceptora:n,showEditDialog:R,setShowEditDialog:O,submitting:b,handleSubmit:H,handleEditSubmit:w,handleEdit:k,resetForm:P,resetEditForm:C}}function Wa({fazendas:o,selectedFazendaId:t,editingReceptora:a,onSuccess:s,onClose:m}){const{toast:c}=ve(),[N,x]=d.useState(!1),[u,n]=d.useState(""),[M,R]=d.useState(""),[O,b]=d.useState(!1),[y,P]=d.useState(!1),[C,k]=d.useState(!1),H=d.useCallback(()=>{n(""),R(""),b(!1),P(!1)},[]),w=o.filter(i=>i.id!==t);d.useEffect(()=>{(async()=>{if(!a||!u){b(!1),R(""),P(!1);return}try{const{data:f,error:v}=await p.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",u);if(v)return;const l=(f==null?void 0:f.map(r=>r.receptora_id))||[];if(l.length===0){b(!1),R(""),P(!1);return}if(a.nome&&a.nome.trim()){const{data:r,error:h}=await p.from("receptoras").select("id, nome, identificacao").in("id",l).ilike("nome",a.nome.trim());!h&&r&&r.length>0?P(!0):P(!1)}else P(!1);const{data:D,error:T}=await p.from("receptoras").select("id, identificacao").in("id",l).ilike("identificacao",a.identificacao);if(T)return;if(D&&D.length>0){b(!0);const r=async(h,E=0)=>{if(E>10)throw new Error("Não foi possível gerar um brinco disponível após várias tentativas");const L=new Date,B=String(L.getDate()).padStart(2,"0"),W=String(L.getMonth()+1).padStart(2,"0"),te=E===0?`-MOV${B}${W}`:`-MOV${B}${W}-${E}`,K=`${h}${te}`,{data:ee,error:ae}=await p.from("receptoras").select("id, identificacao").in("id",l).ilike("identificacao",K);return ae?K:ee&&ee.length>0?r(h,E+1):K};try{const h=await r(a.identificacao);R(h)}catch{const h=new Date,E=String(h.getDate()).padStart(2,"0"),L=String(h.getMonth()+1).padStart(2,"0");R(`${a.identificacao}-MOV${E}${L}`)}}else b(!1),R("")}catch{b(!1),R("")}})()},[a,u]);const _=d.useCallback(async()=>{if(!a||!u){c({title:"Erro de validação",description:"Selecione uma fazenda de destino",variant:"destructive"});return}if(y&&a.nome&&a.nome.trim()){c({title:"Conflito de nome",description:`Já existe uma receptora com o nome "${a.nome.trim()}" na fazenda destino. Não é possível mover esta receptora.`,variant:"destructive"});return}try{k(!0);const i=a.identificacao;let f=i;if(O&&M){f=M;const{error:l}=await p.from("receptoras").update({identificacao:f}).eq("id",a.id);if(l)throw new Error(`Erro ao atualizar brinco: ${l.message}`);try{await p.from("receptora_renomeacoes_historico").insert([{receptora_id:a.id,brinco_anterior:i,brinco_novo:f,data_renomeacao:new Date().toISOString(),motivo:"MUDANCA_FAZENDA",observacoes:"Renomeação automática devido a conflito de brinco na fazenda destino"}])}catch{}}const{error:v}=await p.rpc("mover_receptora_fazenda",{p_receptora_id:a.id,p_nova_fazenda_id:u,p_data_mudanca:new Date().toISOString().split("T")[0],p_observacoes:null});if(v){let l="Erro ao mover receptora";v.message?l=v.message:v.details&&(l=v.details),c({title:"Erro ao mover receptora",description:l,variant:"destructive"});return}c({title:"Receptora movida",description:O?`Receptora movida com sucesso. Brinco atualizado de "${i}" para "${f}" devido a conflito na fazenda destino.`:"Receptora movida para a nova fazenda com sucesso. Protocolos e histórico não foram afetados."}),x(!1),H(),m==null||m(),s==null||s()}catch(i){c({title:"Erro ao mover receptora",description:i instanceof Error?i.message:"Erro desconhecido ao mover receptora",variant:"destructive"})}finally{k(!1)}},[a,u,O,y,M,c,H,m,s]);return{showMoverFazendaDialog:N,setShowMoverFazendaDialog:x,novaFazendaId:u,setNovaFazendaId:n,novoBrincoProposto:M,temConflitoBrinco:O,temConflitoNome:y,submittingMover:C,fazendasDisponiveis:w,handleMoverFazenda:_,resetMoverState:H}}function Xa({selectedFazendaId:o,fazendas:t,onSuccess:a}){const{toast:s}=ve(),m=new Date().toISOString().split("T")[0],[c,N]=d.useState(!1),[x,u]=d.useState({receptora_id:"",data_nascimento:m,sexo:"",observacoes:""}),[n,M]=d.useState([]),[R,O]=d.useState(!1),[b,y]=d.useState(!1),P=w=>w.includes("FEMEA")?"FEMEA":w.includes("MACHO")?"MACHO":"SEM_SEXO",C=async w=>{const{data:_,error:i}=await p.from("transferencias_embrioes").select("embriao_id, data_te").eq("receptora_id",w).eq("status_te","REALIZADA").order("data_te",{ascending:!1});if(i)throw i;if(!_||_.length===0)return[];const f=_[0].data_te,l=_.filter(S=>S.data_te===f).map(S=>S.embriao_id).filter(Boolean);if(l.length===0)return[];const{data:D}=await p.from("animais").select("embriao_id").in("embriao_id",l),T=new Set((D||[]).map(S=>S.embriao_id)),r=l.filter(S=>!T.has(S));if(r.length===0)return[];const{data:h,error:E}=await p.from("embrioes").select("id, lote_fiv_acasalamento_id").in("id",r);if(E)throw E;const L=[...new Set((h||[]).map(S=>S.lote_fiv_acasalamento_id).filter(Boolean))];let B=[],W=[],te=[],K=[];if(L.length>0){const{data:S}=await p.from("lote_fiv_acasalamentos").select("id, aspiracao_doadora_id, dose_semen_id").in("id",L);B=S||[];const V=[...new Set(B.map($=>$.aspiracao_doadora_id).filter(Boolean))],X=[...new Set(B.map($=>$.dose_semen_id).filter(Boolean))];if(V.length>0){const{data:$}=await p.from("aspiracoes_doadoras").select("id, doadora_id").in("id",V);W=$||[];const Q=[...new Set(W.map(U=>U.doadora_id).filter(Boolean))];if(Q.length>0){const{data:U}=await p.from("doadoras").select("id, registro, raca").in("id",Q);te=U||[]}}if(X.length>0){const{data:$}=await p.from("doses_semen").select("id, touro:touros(id, nome, registro, raca)").in("id",X);K=$||[]}}const ee=new Map(B.map(S=>[S.id,S])),ae=new Map(W.map(S=>[S.id,S])),ne=new Map(te.map(S=>[S.id,S])),se=new Map(K.map(S=>[S.id,S]));return(h||[]).map(S=>{const V=S.lote_fiv_acasalamento_id?ee.get(S.lote_fiv_acasalamento_id):void 0,X=V?ae.get(V.aspiracao_doadora_id):void 0,$=X?ne.get(X.doadora_id):void 0,Q=V?se.get(V.dose_semen_id):void 0,U=(Q==null?void 0:Q.touro)??null;return{embriao_id:S.id,doadora_registro:$==null?void 0:$.registro,touro_nome:U==null?void 0:U.nome,raca:($==null?void 0:$.raca)||(U==null?void 0:U.raca)}})},k=d.useCallback(async w=>{var _;try{O(!0),M([]),u({receptora_id:w.id,data_nascimento:m,sexo:"",observacoes:""}),N(!0);const[i,f]=await Promise.all([C(w.id),p.from("diagnosticos_gestacao").select("sexagem").eq("receptora_id",w.id).eq("tipo_diagnostico","SEXAGEM").order("data_diagnostico",{ascending:!1}).limit(1).maybeSingle()]),v=((_=f==null?void 0:f.data)==null?void 0:_.sexagem)||P(w.status_calculado);u(l=>({...l,sexo:v||""})),M(i),i.length===0&&s({title:"Sem embriões disponíveis",description:"Nenhum embrião elegível para criar animal foi encontrado."})}catch(i){s({title:"Erro ao preparar nascimento",description:i instanceof Error?i.message:"Erro desconhecido",variant:"destructive"})}finally{O(!1)}},[m,s]),H=d.useCallback(async()=>{if(!o){s({title:"Fazenda não selecionada",description:"Selecione a fazenda antes de registrar o nascimento.",variant:"destructive"});return}if(!x.receptora_id){s({title:"Receptora não selecionada",description:"Selecione a receptora para registrar o nascimento.",variant:"destructive"});return}if(!x.data_nascimento){s({title:"Data de nascimento obrigatória",description:"Informe a data de nascimento.",variant:"destructive"});return}if(!x.sexo){s({title:"Sexo obrigatório",description:"Selecione o sexo da prenhez.",variant:"destructive"});return}if(n.length===0){s({title:"Sem embriões vinculados",description:"Nenhum embrião encontrado para a última transferência desta receptora.",variant:"destructive"});return}try{y(!0);const w=t.find(l=>l.id===o),_=(w==null?void 0:w.cliente_id)||null,i=n.map(l=>({embriao_id:l.embriao_id,receptora_id:x.receptora_id,fazenda_id:o,cliente_id:_,data_nascimento:x.data_nascimento,sexo:x.sexo,raca:l.raca||null,pai_nome:l.touro_nome||null,mae_nome:l.doadora_registro||null,observacoes:x.observacoes||null})),{error:f}=await p.from("animais").insert(i);if(f)throw f;const{error:v}=await p.from("receptoras").update({status_reprodutivo:"VAZIA",data_provavel_parto:null}).eq("id",x.receptora_id);if(v)throw v;s({title:"Nascimento registrado",description:`${i.length} animal(is) criado(s) com sucesso.`}),N(!1),M([]),u({receptora_id:"",data_nascimento:m,sexo:"",observacoes:""}),a==null||a()}catch(w){s({title:"Erro ao registrar nascimento",description:w instanceof Error?w.message:"Erro desconhecido",variant:"destructive"})}finally{y(!1)}},[x,n,o,t,m,s,a]);return{showNascimentoDialog:c,setShowNascimentoDialog:N,nascimentoForm:x,setNascimentoForm:u,nascimentoEmbrioes:n,nascimentoLoading:R,submitting:b,handleAbrirNascimento:k,handleRegistrarNascimento:H}}function Qa({open:o,onOpenChange:t,receptora:a,fazendasDisponiveis:s,novaFazendaId:m,onFazendaChange:c,temConflitoBrinco:N,temConflitoNome:x,novoBrincoProposto:u,submitting:n,onConfirmar:M,onCancelar:R}){const O=y=>{t(y),y||R()},b=m&&!x&&!(N&&!u);return e.jsx(fe,{open:o,onOpenChange:O,children:e.jsxs(he,{className:"max-w-md",children:[e.jsxs(pe,{children:[e.jsx(ge,{children:"Mover Receptora"}),e.jsxs(je,{children:["Mover ",a==null?void 0:a.identificacao," para outra fazenda. Protocolos e histórico reprodutivo não serão afetados."]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{htmlFor:"nova_fazenda",children:"Nova Fazenda *"}),e.jsxs(Ee,{value:m,onValueChange:c,children:[e.jsx(ze,{children:e.jsx(Re,{placeholder:"Selecione a fazenda de destino"})}),e.jsx(Me,{children:s.map(y=>e.jsx(oe,{value:y.id,children:y.nome},y.id))})]})]}),x&&(a==null?void 0:a.nome)&&e.jsxs("div",{className:"space-y-2 p-3 bg-red-50 border border-red-200 rounded-md",children:[e.jsx("div",{className:"flex items-start gap-2",children:e.jsx("div",{className:"text-red-800 text-sm font-medium",children:"Conflito de Nome Detectado"})}),e.jsxs("div",{className:"text-red-700 text-sm",children:['Já existe uma receptora com o nome "',a.nome.trim(),'" na fazenda destino.']}),e.jsx("div",{className:"text-red-600 text-xs",children:"Não é possível mover esta receptora. Edite o nome da receptora antes de movê-la."})]}),N&&u&&e.jsxs("div",{className:"space-y-2 p-3 bg-yellow-50 border border-yellow-200 rounded-md",children:[e.jsx("div",{className:"flex items-start gap-2",children:e.jsx("div",{className:"text-yellow-800 text-sm font-medium",children:"Conflito de Brinco Detectado"})}),e.jsxs("div",{className:"text-yellow-700 text-sm",children:['Já existe uma receptora com o brinco "',a==null?void 0:a.identificacao,'" na fazenda destino.']}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Y,{className:"text-yellow-800 text-sm font-medium",children:"Novo Brinco Proposto:"}),e.jsx("div",{className:"p-2 bg-white border border-yellow-300 rounded text-sm font-mono text-yellow-900",children:u}),e.jsx("div",{className:"text-yellow-600 text-xs",children:"O brinco será automaticamente atualizado para permitir a movimentação."})]})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(A,{type:"button",className:"flex-1",onClick:M,disabled:n||!b,children:n?"Movendo...":"Confirmar Movimentação"}),e.jsx(A,{type:"button",variant:"outline",onClick:R,disabled:n,children:"Cancelar"})]})]})]})})}function Ka({open:o,onOpenChange:t,nascimentoForm:a,onFormChange:s,nascimentoEmbrioes:m,nascimentoLoading:c,submitting:N,onRegistrar:x,onCancelar:u}){return e.jsx(fe,{open:o,onOpenChange:t,children:e.jsxs(he,{className:"max-w-2xl",children:[e.jsxs(pe,{children:[e.jsx(ge,{children:"Registrar nascimento"}),e.jsx(je,{children:"Crie os animais a partir da prenhez desta receptora."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{children:"Data de nascimento *"}),e.jsx(ga,{value:a.data_nascimento,onChange:n=>s({...a,data_nascimento:n||""}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{children:"Sexo *"}),e.jsxs(Ee,{value:a.sexo,onValueChange:n=>s({...a,sexo:n}),children:[e.jsx(ze,{children:e.jsx(Re,{placeholder:"Selecione o sexo"})}),e.jsxs(Me,{children:[e.jsx(oe,{value:"FEMEA",children:"Fêmea"}),e.jsx(oe,{value:"MACHO",children:"Macho"}),e.jsx(oe,{value:"SEM_SEXO",children:"Sem sexo"})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{children:"Observações"}),e.jsx(pa,{value:a.observacoes,onChange:n=>s({...a,observacoes:n.target.value}),placeholder:"Observações sobre o nascimento",rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{children:"Embriões vinculados"}),c&&e.jsx("div",{className:"text-sm text-slate-500",children:"Carregando dados..."}),!c&&m.length===0&&e.jsx("div",{className:"text-sm text-slate-500",children:"Nenhum embrião disponível para registro."}),!c&&m.length>0&&e.jsx("div",{className:"border rounded-lg p-3",children:e.jsxs(De,{children:[e.jsx(ye,{children:e.jsxs(ie,{children:[e.jsx(F,{children:"Embrião"}),e.jsx(F,{children:"Doadora"}),e.jsx(F,{children:"Touro"}),e.jsx(F,{children:"Raça"})]})}),e.jsx(Ce,{children:m.map(n=>e.jsxs(ie,{children:[e.jsx(I,{className:"font-medium",children:n.embriao_id.substring(0,8)}),e.jsx(I,{children:n.doadora_registro||"-"}),e.jsx(I,{children:n.touro_nome||"-"}),e.jsx(I,{children:n.raca||"-"})]},n.embriao_id))})]})})]})]}),e.jsxs(ma,{children:[e.jsx(A,{type:"button",variant:"outline",onClick:u,children:"Cancelar"}),e.jsx(A,{type:"button",onClick:x,disabled:N,children:"Registrar nascimento"})]})]})})}function es({fazendaId:o,fazendaNome:t}){const a=Ie(),{fazendas:s,filteredReceptoras:m,statusDisponiveis:c,loadingReceptoras:N,searchTerm:x,setSearchTerm:u,filtroStatus:n,setFiltroStatus:M,reloadReceptoras:R,removeReceptoraFromList:O}=Ja({selectedFazendaId:o}),{formData:b,setFormData:y,showDialog:P,setShowDialog:C,editFormData:k,setEditFormData:H,editingReceptora:w,showEditDialog:_,setShowEditDialog:i,submitting:f,handleSubmit:v,handleEditSubmit:l,handleEdit:D}=Ya({selectedFazendaId:o,onSuccess:R}),[T,r]=d.useState(null),{showMoverFazendaDialog:h,setShowMoverFazendaDialog:E,novaFazendaId:L,setNovaFazendaId:B,novoBrincoProposto:W,temConflitoBrinco:te,temConflitoNome:K,submittingMover:ee,fazendasDisponiveis:ae,handleMoverFazenda:ne,resetMoverState:se}=Wa({fazendas:s,selectedFazendaId:o,editingReceptora:T,onSuccess:()=>{T&&O(T.id),r(null)},onClose:()=>{r(null)}}),S=j=>{r(j),se(),E(!0)},{showNascimentoDialog:V,setShowNascimentoDialog:X,nascimentoForm:$,setNascimentoForm:Q,nascimentoEmbrioes:U,nascimentoLoading:Te,submitting:g,handleAbrirNascimento:z,handleRegistrarNascimento:ue}=Xa({selectedFazendaId:o,fazendas:s,onSuccess:R}),ce=j=>{if(!j)return"-";try{return Na(Ta(j),"dd/MM/yyyy",{locale:ba})}catch{return"-"}};return N?e.jsx(Z,{children:e.jsx(J,{className:"py-8",children:e.jsx("div",{className:"flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"})})})}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"rounded-xl border border-border bg-gradient-to-r from-card via-card to-muted/30 p-4",children:e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex flex-wrap items-end gap-6",children:[e.jsxs("div",{className:"flex items-end gap-3",children:[e.jsx("div",{className:"w-1 h-6 rounded-full bg-primary/40 self-center"}),e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground self-center",children:[e.jsx(Ve,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:"Busca"})]}),e.jsxs("div",{className:"relative flex-1 min-w-[200px]",children:[e.jsx(Ge,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(re,{placeholder:"Buscar por brinco ou nome...",value:x,onChange:j=>u(j.target.value),className:"pl-9 h-9"})]})]}),e.jsx("div",{className:"h-10 w-px bg-border hidden lg:block"}),e.jsxs("div",{className:"flex items-end gap-3",children:[e.jsx("div",{className:"w-1 h-6 rounded-full bg-emerald-500/40 self-center"}),e.jsx("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground self-center",children:e.jsx("span",{children:"Status"})}),e.jsx("div",{className:"w-[180px]",children:e.jsxs(Ee,{value:n,onValueChange:M,children:[e.jsx(ze,{className:"h-9",children:e.jsx(Re,{placeholder:"Filtrar status"})}),e.jsxs(Me,{children:[e.jsx(oe,{value:"todos",children:"Todos os status"}),c.map(j=>e.jsx(oe,{value:j,children:He(j)},j))]})]})})]}),(x||n!=="todos")&&e.jsxs(A,{variant:"outline",size:"sm",onClick:()=>{u(""),M("todos")},className:"h-9",children:[e.jsx(qe,{className:"w-4 h-4 mr-2"}),"Limpar"]})]}),e.jsxs(fe,{open:P,onOpenChange:C,children:[e.jsx(Ue,{asChild:!0,children:e.jsxs(A,{children:[e.jsx(Ze,{className:"w-4 h-4 mr-2"}),"Nova Receptora"]})}),e.jsxs(he,{children:[e.jsxs(pe,{children:[e.jsx(ge,{children:"Cadastrar Receptora"}),e.jsxs(je,{children:["Adicionar receptora em ",t]})]}),e.jsxs("form",{onSubmit:v,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{htmlFor:"identificacao",children:"Brinco/Identificação *"}),e.jsx(re,{id:"identificacao",value:b.identificacao,onChange:j=>y({...b,identificacao:j.target.value}),placeholder:"Ex: 001, A123",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{htmlFor:"nome",children:"Nome (opcional)"}),e.jsx(re,{id:"nome",value:b.nome,onChange:j=>y({...b,nome:j.target.value}),placeholder:"Nome da receptora"})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(A,{type:"submit",className:"flex-1",disabled:f,children:f?"Salvando...":"Cadastrar"}),e.jsx(A,{type:"button",variant:"outline",onClick:()=>C(!1),children:"Cancelar"})]})]})]})]})]})}),e.jsxs(Z,{children:[e.jsx(de,{children:e.jsxs(me,{children:["Receptoras (",m.length,")"]})}),e.jsx(J,{children:m.length===0?e.jsx(Se,{title:"Nenhuma receptora encontrada",description:x||n!=="todos"?"Tente ajustar os filtros":"Cadastre a primeira receptora desta fazenda"}):e.jsxs(De,{children:[e.jsx(ye,{children:e.jsxs(ie,{children:[e.jsx(F,{children:"Brinco"}),e.jsx(F,{children:"Nome"}),e.jsx(F,{children:"Status"}),e.jsx(F,{children:"Data Provável Parto"}),e.jsx(F,{className:"text-right",children:"Ações"})]})}),e.jsx(Ce,{children:m.map(j=>e.jsxs(ie,{children:[e.jsx(I,{className:"font-medium",children:j.identificacao}),e.jsx(I,{children:j.nome||"-"}),e.jsx(I,{children:e.jsx(ra,{status:j.status_calculado||j.status_reprodutivo||"DISPONIVEL"})}),e.jsx(I,{children:ce(j.data_provavel_parto)}),e.jsx(I,{className:"text-right",children:e.jsxs("div",{className:"flex gap-1 justify-end",children:[e.jsx(A,{variant:"ghost",size:"sm",onClick:()=>D(j),title:"Editar",children:e.jsx(ja,{className:"w-4 h-4"})}),e.jsx(A,{variant:"ghost",size:"sm",onClick:()=>a(`/receptoras/${j.id}/historico`),title:"Histórico",children:e.jsx(Je,{className:"w-4 h-4"})}),e.jsx(A,{variant:"ghost",size:"sm",onClick:()=>S(j),title:"Mover para outra fazenda",children:e.jsx(va,{className:"w-4 h-4"})}),(j.status_calculado||"").includes("PRENHE")&&e.jsx(A,{variant:"ghost",size:"sm",onClick:()=>z(j),title:"Registrar nascimento",children:e.jsx(Fe,{className:"w-4 h-4"})})]})})]},j.id))})]})})]}),e.jsx(fe,{open:_,onOpenChange:i,children:e.jsxs(he,{children:[e.jsxs(pe,{children:[e.jsx(ge,{children:"Editar Receptora"}),e.jsxs(je,{children:["Editando ",w==null?void 0:w.identificacao]})]}),e.jsxs("form",{onSubmit:l,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{htmlFor:"edit-identificacao",children:"Brinco/Identificação *"}),e.jsx(re,{id:"edit-identificacao",value:k.identificacao,onChange:j=>H({...k,identificacao:j.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{htmlFor:"edit-nome",children:"Nome"}),e.jsx(re,{id:"edit-nome",value:k.nome,onChange:j=>H({...k,nome:j.target.value})})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(A,{type:"submit",className:"flex-1",disabled:f,children:f?"Salvando...":"Salvar"}),e.jsx(A,{type:"button",variant:"outline",onClick:()=>i(!1),children:"Cancelar"})]})]})]})}),e.jsx(Qa,{open:h,onOpenChange:E,receptora:T,fazendasDisponiveis:ae,novaFazendaId:L,onFazendaChange:B,temConflitoBrinco:te,temConflitoNome:K,novoBrincoProposto:W,submitting:ee,onConfirmar:ne,onCancelar:()=>{E(!1),r(null),se()}}),e.jsx(Ka,{open:V,onOpenChange:X,nascimentoForm:$,onFormChange:Q,nascimentoEmbrioes:U,nascimentoLoading:Te,submitting:g,onRegistrar:ue,onCancelar:()=>X(!1)})]})}const as=["Gir","Gir Leiteiro","Girolando","Nelore","Brahman","Senepol","Angus","Holandês","Jersey"];function ss({fazendaId:o,fazendaNome:t}){var D,T;const a=Ie(),{toast:s}=ve(),[m,c]=d.useState(!0),[N,x]=d.useState([]),[u,n]=d.useState(""),[M,R]=d.useState(null),[O,b]=d.useState(!1),[y,P]=d.useState(!1),[C,k]=d.useState({registro:"",raca:"",racaCustom:""}),[H,w]=d.useState(""),_=d.useCallback(async()=>{try{c(!0);const{data:r,error:h}=await p.from("doadoras").select("*").eq("fazenda_id",o).order("created_at",{ascending:!1});if(h)throw h;const E=await Promise.all((r||[]).map(async L=>{const{data:B}=await p.from("aspiracoes_doadoras").select("total_oocitos, data_aspiracao").eq("doadora_id",L.id).order("data_aspiracao",{ascending:!1}).limit(1).maybeSingle();return{...L,ultima_aspiracao_total_oocitos:B==null?void 0:B.total_oocitos,ultima_aspiracao_data:B==null?void 0:B.data_aspiracao}}));x(E)}catch(r){s({title:"Erro ao carregar doadoras",description:r instanceof Error?r.message:"Erro desconhecido",variant:"destructive"})}finally{c(!1)}},[o,s]);d.useEffect(()=>{_()},[_]);const i=N.filter(r=>{var E,L,B;if(!u.trim())return!0;const h=u.toLowerCase();return((E=r.nome)==null?void 0:E.toLowerCase().includes(h))||((L=r.registro)==null?void 0:L.toLowerCase().includes(h))||((B=r.raca)==null?void 0:B.toLowerCase().includes(h))}),f=r=>{w(r),k(r!=="Outra"?{...C,raca:r,racaCustom:""}:{...C,raca:"",racaCustom:""})},v=async r=>{if(r.preventDefault(),!!C.registro.trim())try{P(!0);const h=H==="Outra"?C.racaCustom:C.raca,{error:E}=await p.from("doadoras").insert({fazenda_id:o,registro:C.registro.trim(),raca:h});if(E)throw E;s({title:"Doadora criada",description:"Doadora cadastrada com sucesso."}),b(!1),k({registro:"",raca:"",racaCustom:""}),w(""),_()}catch(h){s({title:"Erro ao criar doadora",description:h instanceof Error?h.message:"Erro desconhecido",variant:"destructive"})}finally{P(!1)}},l=r=>{if(!r)return"-";switch(r){case"1_estrela":return e.jsx("div",{className:"flex items-center gap-1",children:e.jsx(le,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"})});case"2_estrelas":return e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(le,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"}),e.jsx(le,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"})]});case"3_estrelas":return e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(le,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"}),e.jsx(le,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"}),e.jsx(le,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"})]});case"diamante":return e.jsx("div",{className:"flex items-center gap-1",children:e.jsx(Da,{className:"w-4 h-4 fill-blue-500 text-blue-500"})});default:return"-"}};return m?e.jsx(Z,{children:e.jsx(J,{className:"py-8",children:e.jsx("div",{className:"flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"})})})}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"rounded-xl border border-border bg-gradient-to-r from-card via-card to-muted/30 p-4",children:e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-end gap-3",children:[e.jsx("div",{className:"w-1 h-6 rounded-full bg-primary/40 self-center"}),e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground self-center",children:[e.jsx(Ve,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:"Busca"})]}),e.jsxs("div",{className:"relative flex-1 min-w-[250px]",children:[e.jsx(Ge,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(re,{placeholder:"Buscar por nome ou registro...",value:u,onChange:r=>n(r.target.value),className:"pl-9 h-9"})]}),u&&e.jsx(A,{variant:"outline",size:"sm",onClick:()=>n(""),className:"h-9",children:e.jsx(qe,{className:"w-4 h-4"})})]}),e.jsxs(fe,{open:O,onOpenChange:b,children:[e.jsx(Ue,{asChild:!0,children:e.jsxs(A,{children:[e.jsx(Ze,{className:"w-4 h-4 mr-2"}),"Nova Doadora"]})}),e.jsxs(he,{className:"max-w-md",children:[e.jsxs(pe,{children:[e.jsx(ge,{children:"Cadastrar Doadora"}),e.jsxs(je,{children:["Adicionar doadora em ",t]})]}),e.jsxs("form",{onSubmit:v,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{htmlFor:"registro",children:"Registro *"}),e.jsx(re,{id:"registro",value:C.registro,onChange:r=>k({...C,registro:r.target.value}),placeholder:"Registro da doadora",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{htmlFor:"raca",children:"Raca *"}),e.jsxs(Ee,{value:H,onValueChange:f,children:[e.jsx(ze,{children:e.jsx(Re,{placeholder:"Selecione a raca"})}),e.jsxs(Me,{children:[as.map(r=>e.jsx(oe,{value:r,children:r},r)),e.jsx(oe,{value:"Outra",children:"Outra"})]})]}),H==="Outra"&&e.jsx(re,{id:"raca_custom",value:C.racaCustom,onChange:r=>k({...C,racaCustom:r.target.value,raca:r.target.value}),placeholder:"Digite a raca",className:"mt-2",required:!0})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(A,{type:"submit",className:"flex-1",disabled:y,children:y?"Salvando...":"Criar Doadora"}),e.jsx(A,{type:"button",variant:"outline",onClick:()=>b(!1),disabled:y,children:"Cancelar"})]})]})]})]})]})}),e.jsxs(Z,{children:[e.jsx(de,{children:e.jsxs(me,{children:["Doadoras (",i.length,")"]})}),e.jsx(J,{children:i.length===0?e.jsx(Se,{title:"Nenhuma doadora encontrada",description:u?"Tente ajustar a busca":"Cadastre a primeira doadora desta fazenda"}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(De,{children:[e.jsx(ye,{children:e.jsxs(ie,{children:[e.jsx(F,{children:"Registro"}),e.jsx(F,{children:"Nome"}),e.jsx(F,{children:"Raca"}),e.jsx(F,{children:"Classificacao"}),e.jsx(F,{children:"Ultima Aspiracao"}),e.jsx(F,{children:"Oocitos"}),e.jsx(F,{children:"Estado"}),e.jsx(F,{className:"text-right",children:"Acoes"})]})}),e.jsx(Ce,{children:i.map(r=>e.jsxs(ie,{className:"cursor-pointer hover:bg-slate-50",onClick:()=>a(`/doadoras/${r.id}`),children:[e.jsx(I,{className:"font-medium",children:r.registro}),e.jsx(I,{children:r.nome||"-"}),e.jsx(I,{children:r.raca||"-"}),e.jsx(I,{children:l(r.classificacao_genetica)}),e.jsx(I,{children:r.ultima_aspiracao_data?Sa(r.ultima_aspiracao_data):"-"}),e.jsx(I,{children:r.ultima_aspiracao_total_oocitos??"-"}),e.jsx(I,{children:e.jsx(G,{variant:r.disponivel_aspiracao?"default":"secondary",children:r.disponivel_aspiracao?"Disponivel":"Indisponivel"})}),e.jsx(I,{className:"text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(A,{variant:"ghost",size:"sm",onClick:h=>{h.stopPropagation(),R(r.id)},title:"Ver historico de aspiracoes",children:e.jsx(Je,{className:"w-4 h-4"})}),e.jsx(A,{variant:"ghost",size:"sm",onClick:h=>{h.stopPropagation(),a(`/doadoras/${r.id}`)},title:"Editar doadora",children:e.jsx(wa,{className:"w-4 h-4"})})]})})]},r.id))})]})})})]}),M&&e.jsx(_a,{doadoraId:M,doadoraNome:((D=N.find(r=>r.id===M))==null?void 0:D.nome)||((T=N.find(r=>r.id===M))==null?void 0:T.registro),open:!!M,onClose:()=>R(null)})]})}function Js(){const{id:o}=Ke(),t=Ie(),{toast:a}=ve(),[s,m]=d.useState(!0),[c,N]=d.useState(null),[x,u]=d.useState(""),[n,M]=d.useState({passo2Pendente:0,tePendente:0,dgPendente:0,sexagemPendente:0,prenhesTotal:0}),[R,O]=d.useState({total:0,porStatus:[]}),[b,y]=d.useState({total:0,porRaca:[],oocitos30d:0,aspiracoes30d:0}),[P,C]=d.useState([]);d.useEffect(()=>{o&&k()},[o]);const k=async()=>{var i,f;try{m(!0);const[v,l]=await Promise.all([p.from("fazendas").select("*, cliente:clientes(nome)").eq("id",o).single(),p.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",o)]);if(v.error)throw v.error;const D=v.data;N(D),u(((i=D.cliente)==null?void 0:i.nome)||"");const T=((f=l.data)==null?void 0:f.map(g=>g.receptora_id))||[],[r,h,E,L,B]=await Promise.all([p.from("protocolos_sincronizacao").select("id, status").eq("fazenda_id",o).in("status",["PASSO1_FECHADO","SINCRONIZADO"]),T.length>0?p.from("receptoras").select("id, status_reprodutivo, data_provavel_parto").in("id",T):Promise.resolve({data:[],error:null}),p.from("doadoras").select("id, raca").eq("fazenda_id",o),p.from("aspiracoes_doadoras").select("id, total_oocitos").eq("fazenda_id",o).gte("data_aspiracao",new Date(Date.now()-30*24*60*60*1e3).toISOString().split("T")[0]),p.from("animais").select(`
            id, data_nascimento, sexo, raca, pai_nome, mae_nome,
            receptora:receptoras(identificacao),
            embriao:embrioes(
              lote_fiv_acasalamento:lote_fiv_acasalamentos(
                aspiracao:aspiracoes_doadoras(doadora:doadoras(registro)),
                dose:doses_semen(touro:touros(nome))
              )
            )
          `).eq("fazenda_id",o).order("data_nascimento",{ascending:!1}).limit(50)]),W=r.data||[],te=W.filter(g=>g.status==="PASSO1_FECHADO").length,K=W.filter(g=>g.status==="SINCRONIZADO").length,ee=h.data||[],ae=new Map;let ne=0,se;ee.forEach(g=>{const z=g.status_reprodutivo||"VAZIA";ae.set(z,(ae.get(z)||0)+1),z.includes("PRENHE")&&(ne++,g.data_provavel_parto&&(!se||g.data_provavel_parto<se)&&(se=g.data_provavel_parto))}),O({total:ee.length,porStatus:Array.from(ae.entries()).map(([g,z])=>({status:g,total:z})).sort((g,z)=>z.total-g.total)});let S=0,V=0;if(T.length>0){const[g,z]=await Promise.all([p.from("transferencias_embrioes").select("receptora_id").in("receptora_id",T).eq("status_te","REALIZADA"),p.from("diagnosticos_gestacao").select("receptora_id, tipo_diagnostico").in("receptora_id",T)]),ue=new Set((g.data||[]).map(q=>q.receptora_id)),ce=new Set((z.data||[]).filter(q=>q.tipo_diagnostico==="DG").map(q=>q.receptora_id)),j=new Set((z.data||[]).filter(q=>q.tipo_diagnostico==="SEXAGEM").map(q=>q.receptora_id));S=[...ue].filter(q=>!ce.has(q)).length,V=ee.filter(q=>(q.status_reprodutivo||"").includes("PRENHE")&&ce.has(q.id)).filter(q=>!j.has(q.id)).length}M({passo2Pendente:te,tePendente:K,dgPendente:S,sexagemPendente:V,prenhesTotal:ne,prenhesProximoParto:se});const X=E.data||[],$=new Map;X.forEach(g=>{const z=g.raca||"Sem raça";$.set(z,($.get(z)||0)+1)});const Q=L.data||[],U=Q.reduce((g,z)=>g+(z.total_oocitos||0),0);y({total:X.length,porRaca:Array.from($.entries()).map(([g,z])=>({raca:g,total:z})).sort((g,z)=>z.total-g.total),oocitos30d:U,aspiracoes30d:Q.length});const Te=(B.data||[]).map(g=>{var j,Pe,q,Oe,ke,Be;const z=(j=g.embriao)==null?void 0:j.lote_fiv_acasalamento,ue=(q=(Pe=z==null?void 0:z.aspiracao)==null?void 0:Pe.doadora)==null?void 0:q.registro,ce=(ke=(Oe=z==null?void 0:z.dose)==null?void 0:Oe.touro)==null?void 0:ke.nome;return{id:g.id,data_nascimento:g.data_nascimento,sexo:g.sexo,raca:g.raca,receptora_brinco:(Be=g.receptora)==null?void 0:Be.identificacao,doadora:ue||g.mae_nome||null,touro:ce||g.pai_nome||null}});C(Te)}catch(v){a({title:"Erro ao carregar dados",description:v instanceof Error?v.message:"Erro desconhecido",variant:"destructive"})}finally{m(!1)}},H=()=>{c&&(c.latitude&&c.longitude?window.open(ia(c.latitude,c.longitude),"_blank"):c.localizacao&&window.open(na(c.localizacao),"_blank"))},w=i=>i?new Date(i).toLocaleDateString("pt-BR"):"-",_=n.passo2Pendente+n.tePendente+n.dgPendente+n.sexagemPendente;return s?e.jsx(ea,{}):c?e.jsxs("div",{className:"space-y-6",children:[e.jsx(da,{title:c.nome,description:`Cliente: ${x}`,actions:e.jsx(A,{variant:"outline",size:"icon",onClick:()=>t("/fazendas"),children:e.jsx(ya,{className:"w-4 h-4"})})}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[c.sigla&&e.jsx(Z,{children:e.jsxs(J,{className:"pt-4 flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-muted rounded-lg",children:e.jsx(aa,{className:"w-4 h-4 text-muted-foreground"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Sigla"}),e.jsx("p",{className:"font-semibold",children:c.sigla})]})]})}),c.localizacao&&e.jsx(Z,{className:"cursor-pointer hover:bg-secondary",onClick:H,children:e.jsxs(J,{className:"pt-4 flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-green-100 rounded-lg",children:e.jsx(Ca,{className:"w-4 h-4 text-primary"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Localização"}),e.jsx("p",{className:"font-medium truncate",children:c.localizacao})]}),e.jsx(oa,{className:"w-4 h-4 text-muted-foreground"})]})}),c.responsavel&&e.jsx(Z,{children:e.jsxs(J,{className:"pt-4 flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:e.jsx(Ea,{className:"w-4 h-4 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Responsável"}),e.jsx("p",{className:"font-medium",children:c.responsavel})]})]})}),c.contato_responsavel&&e.jsx(Z,{children:e.jsxs(J,{className:"pt-4 flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-purple-100 rounded-lg",children:e.jsx(Ma,{className:"w-4 h-4 text-purple-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Contato"}),e.jsx("p",{className:"font-medium",children:c.contato_responsavel})]})]})})]}),e.jsxs(ca,{defaultValue:"resumo",className:"space-y-4",children:[e.jsxs(la,{className:"grid w-full grid-cols-4",children:[e.jsxs(be,{value:"resumo",className:"flex items-center gap-2",children:[e.jsx(Le,{className:"w-4 h-4"}),"Resumo",_>0&&e.jsx(G,{variant:"destructive",className:"ml-1 h-5 w-5 p-0 flex items-center justify-center text-xs",children:_})]}),e.jsxs(be,{value:"receptoras",className:"flex items-center gap-2",children:[e.jsx($e,{className:"w-4 h-4"}),"Receptoras",e.jsx(G,{variant:"secondary",className:"ml-1",children:R.total})]}),e.jsxs(be,{value:"doadoras",className:"flex items-center gap-2",children:[e.jsx(sa,{className:"w-4 h-4"}),"Doadoras",e.jsx(G,{variant:"secondary",className:"ml-1",children:b.total})]}),e.jsxs(be,{value:"animais",className:"flex items-center gap-2",children:[e.jsx(Fe,{className:"w-4 h-4"}),"Nascimentos",e.jsx(G,{variant:"secondary",className:"ml-1",children:P.length})]})]}),e.jsxs(we,{value:"resumo",className:"space-y-4",children:[_>0&&e.jsxs(Z,{className:"border-amber-200 bg-amber-50",children:[e.jsx(de,{className:"pb-2",children:e.jsxs(me,{className:"text-base flex items-center gap-2 text-amber-800",children:[e.jsx(za,{className:"w-4 h-4"}),"Serviços Pendentes"]})}),e.jsx(J,{children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:[n.passo2Pendente>0&&e.jsxs(Ne,{to:"/protocolos",className:"flex items-center justify-between p-3 bg-white rounded-lg border hover:border-green-300 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ra,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm",children:"2º Passo"})]}),e.jsx(G,{children:n.passo2Pendente})]}),n.tePendente>0&&e.jsxs(Ne,{to:"/transferencia",className:"flex items-center justify-between p-3 bg-white rounded-lg border hover:border-green-300 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ta,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm",children:"TE"})]}),e.jsx(G,{children:n.tePendente})]}),n.dgPendente>0&&e.jsxs(Ne,{to:"/dg",className:"flex items-center justify-between p-3 bg-white rounded-lg border hover:border-green-300 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Le,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm",children:"DG"})]}),e.jsx(G,{children:n.dgPendente})]}),n.sexagemPendente>0&&e.jsxs(Ne,{to:"/sexagem",className:"flex items-center justify-between p-3 bg-white rounded-lg border hover:border-green-300 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Fe,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm",children:"Sexagem"})]}),e.jsx(G,{children:n.sexagemPendente})]})]})})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs(Z,{children:[e.jsx(de,{className:"pb-2",children:e.jsxs(me,{className:"text-base flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx($e,{className:"w-4 h-4"}),"Receptoras"]}),e.jsx("span",{className:"text-2xl font-bold",children:R.total})]})}),e.jsx(J,{children:R.porStatus.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Nenhuma receptora"}):e.jsxs("div",{className:"space-y-2",children:[R.porStatus.slice(0,5).map(i=>e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:He(i.status)}),e.jsx(G,{variant:"outline",children:i.total})]},i.status)),n.prenhesProximoParto&&e.jsxs("div",{className:"pt-2 mt-2 border-t text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Próximo parto: "}),e.jsx("span",{className:"font-medium",children:w(n.prenhesProximoParto)})]})]})})]}),e.jsxs(Z,{children:[e.jsx(de,{className:"pb-2",children:e.jsxs(me,{className:"text-base flex items-center justify-between",children:[e.jsx("span",{children:"Doadoras"}),e.jsx("span",{className:"text-2xl font-bold",children:b.total})]})}),e.jsx(J,{children:b.total===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Nenhuma doadora"}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{className:"p-2 bg-secondary rounded",children:[e.jsx("p",{className:"text-muted-foreground",children:"Aspirações (30d)"}),e.jsx("p",{className:"font-semibold",children:b.aspiracoes30d})]}),e.jsxs("div",{className:"p-2 bg-secondary rounded",children:[e.jsx("p",{className:"text-muted-foreground",children:"Oócitos (30d)"}),e.jsx("p",{className:"font-semibold",children:b.oocitos30d})]})]}),b.porRaca.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1",children:b.porRaca.slice(0,4).map(i=>e.jsxs(G,{variant:"secondary",className:"text-xs",children:[i.raca,": ",i.total]},i.raca))})]})})]})]})]}),e.jsx(we,{value:"receptoras",children:e.jsx(es,{fazendaId:o,fazendaNome:c.nome})}),e.jsx(we,{value:"doadoras",children:e.jsx(ss,{fazendaId:o,fazendaNome:c.nome})}),e.jsx(we,{value:"animais",children:e.jsxs(Z,{children:[e.jsx(de,{children:e.jsx(me,{className:"text-base",children:"Animais Nascidos"})}),e.jsx(J,{children:P.length===0?e.jsx(Se,{title:"Nenhum animal registrado",description:"Os nascimentos registrados aparecerão aqui."}):e.jsxs(De,{children:[e.jsx(ye,{children:e.jsxs(ie,{children:[e.jsx(F,{children:"Data"}),e.jsx(F,{children:"Sexo"}),e.jsx(F,{children:"Raça"}),e.jsx(F,{children:"Receptora"}),e.jsx(F,{children:"Doadora x Touro"})]})}),e.jsx(Ce,{children:P.map(i=>e.jsxs(ie,{children:[e.jsx(I,{children:w(i.data_nascimento)}),e.jsx(I,{children:e.jsx(G,{variant:i.sexo==="FEMEA"?"default":"secondary",children:i.sexo==="FEMEA"?"F":i.sexo==="MACHO"?"M":"?"})}),e.jsx(I,{children:i.raca||"-"}),e.jsx(I,{children:i.receptora_brinco||"-"}),e.jsxs(I,{className:"text-sm",children:[i.doadora||"?"," x ",i.touro||"?"]})]},i.id))})]})})]})})]})]}):e.jsx(Se,{title:"Fazenda não encontrada",description:"Volte para a lista e selecione outra fazenda.",action:e.jsx(A,{onClick:()=>t("/fazendas"),variant:"outline",children:"Voltar"})})}export{Js as default};
