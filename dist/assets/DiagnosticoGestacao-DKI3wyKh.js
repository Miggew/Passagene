import{r as g,s as v,j as e,g as je}from"./index-CvlUDCD-.js";import{e as Re,b as De}from"./dataEnrichment-vey-_oex.js";import{u as we,C as Ae,a as Se,c as Te}from"./use-toast-BhbfqK05.js";import{T as Ce,a as Ne,b as te,c as D,d as Fe,e as w}from"./table-BAfLAU-a.js";import{S as Pe,a as Ge,b as He,c as Ie,d as J}from"./select-CRV7QsOQ.js";import{I as Le}from"./input-BiDTc9_9.js";import{T as ye}from"./textarea-CWzGJoHk.js";import{P as ze}from"./PageHeader-Don16aHL.js";import{S as Oe}from"./StatusBadge-Dl4aSm-D.js";import{v as $e}from"./receptoraStatus-DUGAnGBM.js";import{D as Ve}from"./DatePickerBR-gAx3gAQT.js";import{g as qe,u as Me,a as Qe,c as Ue,F as Ze,L as Be,A as ke,b as Je,v as oe,d as se}from"./LoteHeader-G7UdQGWm.js";import"./index-BYe3zTS0.js";import"./index-CDlvsNjp.js";import"./check-BbN618wW.js";import"./badge-C6XBkHcG.js";import"./popover-D6dVxm31.js";import"./label-BIMTC7_j.js";import"./EmptyState-DFkj0E0i.js";import"./circle-check-big-C9vVKwgT.js";import"./lock-F3GwCU70.js";function va(){const{toast:A}=we(),K=qe(),[T,re]=g.useState(""),[c,G]=g.useState(null),[x,S]=g.useState([]),[ie,W]=g.useState(!1),[ne,X]=g.useState(!1),[Y,C]=g.useState(!1),[H,N]=g.useState({}),[p,I]=g.useState({veterinario_responsavel:"",tecnico_responsavel:""}),{fazendas:ee,loadFazendas:ae}=Me({statusReceptoraFiltro:"SERVIDA",tipoDiagnosticoFiltro:"DG"}),ce=g.useCallback((a,r)=>({...a,veterinario_dg:r==null?void 0:r.veterinario_responsavel,tecnico_dg:r==null?void 0:r.tecnico_responsavel}),[]),{lotesTE:de,loading:le,loadLotesTE:M}=Qe({statusReceptoraFiltro:"SERVIDA",tipoDiagnosticoFiltro:"DG",fazendas:ee,transformLote:ce});g.useEffect(()=>{ae()},[ae]),g.useEffect(()=>{T?M(T):(G(null),S([]),N({}))},[T,M]),g.useEffect(()=>{c?c.status==="FECHADO"?(I({veterinario_responsavel:c.veterinario_dg||"",tecnico_responsavel:c.tecnico_dg||""}),C(!1),z(c)):c.veterinario_dg&&c.tecnico_dg?(I({veterinario_responsavel:c.veterinario_dg,tecnico_responsavel:c.tecnico_dg}),C(!1),z(c)):(I({veterinario_responsavel:"",tecnico_responsavel:""}),C(!0),S([]),N({})):(S([]),N({}),C(!1))},[c]);const _e=async()=>{if(!oe(p)){A({title:"Erro de validação",description:"Veterinário e técnico responsáveis são obrigatórios",variant:"destructive"});return}if(!c)return;const a={...c,veterinario_dg:p.veterinario_responsavel.trim(),tecnico_dg:p.tecnico_responsavel.trim(),status:"ABERTO"};G(a),C(!1),await z(a)},z=async a=>{var r,f;try{W(!0);const{data:d,error:s}=await v.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",a.fazenda_id);if(s)throw s;const b=(d==null?void 0:d.map(o=>o.receptora_id))||[];if(b.length===0){S([]);return}const[F,n]=await Promise.all([v.from("receptoras").select("id, identificacao, nome, status_reprodutivo").in("id",b).eq("status_reprodutivo","SERVIDA"),v.from("transferencias_embrioes").select("id, receptora_id, embriao_id, data_te").in("receptora_id",b).eq("data_te",a.data_te).eq("status_te","REALIZADA")]);if(F.error)throw F.error;if(n.error)throw n.error;const t=F.data,l=n.data;if(!l||l.length===0){S([]);return}const i=(t==null?void 0:t.map(o=>o.id))||[],m=l.map(o=>o.embriao_id).filter(Boolean);let u=new Map;if(m.length>0){const{data:o,error:_}=await v.from("embrioes").select("id, identificacao, classificacao, lote_fiv_id, lote_fiv_acasalamento_id").in("id",m);if(_)throw _;u=new Map((o==null?void 0:o.map(h=>[h.id,h]))||[])}const j=[...new Set(Array.from(u.values()).map(o=>o.lote_fiv_id).filter(Boolean))],R=Re(Array.from(u.values())),[L,fe,ge]=await Promise.all([j.length>0?v.from("lotes_fiv").select("id, data_abertura").in("id",j):Promise.resolve({data:[],error:null}),De(R),v.from("diagnosticos_gestacao").select("*").in("receptora_id",i).eq("tipo_diagnostico","DG").eq("data_te",a.data_te).order("data_diagnostico",{ascending:!1})]);if(L.error)throw L.error;const ve=new Map(((r=L.data)==null?void 0:r.map(o=>[o.id,o]))||[]),{doadorasMap:he,tourosMap:Ee}=fe,U=new Map;(f=ge.data)==null||f.forEach(o=>{U.has(o.receptora_id)||U.set(o.receptora_id,o)});const O=new Map;l.forEach(o=>{const _=`${o.receptora_id}-${o.data_te}`;O.has(_)||O.set(_,[]),O.get(_).push(o)});const $=[];O.forEach(o=>{const _=o[0],h=t==null?void 0:t.find(q=>q.id===_.receptora_id);if(!h)return;const y=[];let V=null,B=null;if(o.forEach(q=>{const E=u.get(q.embriao_id);if(!E)return;const k=ve.get(E.lote_fiv_id);if(!k)return;V||(V=k.data_abertura,B=Ue(k.data_abertura));const xe=E.lote_fiv_acasalamento_id?he.get(E.lote_fiv_acasalamento_id):void 0,be=E.lote_fiv_acasalamento_id?Ee.get(E.lote_fiv_acasalamento_id):void 0;y.push({te_id:q.id,embriao_id:E.id,embriao_identificacao:E.identificacao,embriao_classificacao:E.classificacao,lote_fiv_id:E.lote_fiv_id,lote_fiv_acasalamento_id:E.lote_fiv_acasalamento_id,doadora_registro:xe,touro_nome:be})}),y.length===0||!V||B===null)return;const P=U.get(_.receptora_id);$.push({receptora_id:_.receptora_id,brinco:h.identificacao,nome:h.nome,status_reprodutivo:h.status_reprodutivo,data_te:_.data_te,embrioes:y,data_abertura_lote:V,dias_gestacao:B,diagnostico_existente:P?{id:P.id,data_diagnostico:P.data_diagnostico,resultado:P.resultado,numero_gestacoes:P.numero_gestacoes||void 0,observacoes:P.observacoes||void 0}:void 0})}),$.sort((o,_)=>o.brinco.localeCompare(_.brinco)),S($);const Z={};$.forEach(o=>{var _;if(o.diagnostico_existente){const h=o.diagnostico_existente.resultado,y=((_=o.diagnostico_existente.numero_gestacoes)==null?void 0:_.toString())||(h==="PRENHE"||h==="RETOQUE"?"1":"");Z[o.receptora_id]={resultado:h,numero_gestacoes:y,observacoes:o.diagnostico_existente.observacoes||"",data_diagnostico:o.diagnostico_existente.data_diagnostico}}else Z[o.receptora_id]={resultado:"",numero_gestacoes:"",observacoes:"",data_diagnostico:K}}),N(Z)}catch(d){A({title:"Erro ao carregar receptoras",description:d instanceof Error?d.message:"Erro desconhecido",variant:"destructive"}),S([])}finally{W(!1)}},ue=(a,r)=>{N(f=>{const d=f[a]||{};let s=d.numero_gestacoes||"";return(r==="PRENHE"||r==="RETOQUE")&&!s?s="1":(r==="VAZIA"||r==="")&&(s=""),{...f,[a]:{...d,resultado:r,numero_gestacoes:s}}})},Q=(a,r,f)=>{N(d=>({...d,[a]:{...d[a],[r]:f}}))},me=async()=>{var r,f;if(!c)return;if(!oe(p)){A({title:"Erro de validação",description:"Veterinário e técnico responsáveis são obrigatórios",variant:"destructive"});return}const a=x.filter(d=>{const s=H[d.receptora_id];return!s||!s.resultado||!s.data_diagnostico});if(a.length>0){A({title:"Erro de validação",description:`Há ${a.length} receptora(s) sem resultado definido`,variant:"destructive"});return}try{X(!0);for(const n of x){const t=n.status_reprodutivo||"VAZIA",l=$e(t,"REALIZAR_DG");if(!l.valido){A({title:"Erro de validação",description:`Receptora ${n.brinco}: ${l.mensagem}`,variant:"destructive"});return}}const d=[],s=[],b=[];if(x.forEach(n=>{var u,j,R;const t=H[n.receptora_id];if(!t||!t.resultado||!t.data_diagnostico)return;const l={receptora_id:n.receptora_id,data_te:n.data_te,tipo_diagnostico:"DG",data_diagnostico:t.data_diagnostico,resultado:t.resultado,observacoes:((u=t.observacoes)==null?void 0:u.trim())||void 0};t.resultado==="PRENHE"||t.resultado==="RETOQUE"?l.numero_gestacoes=t.numero_gestacoes?parseInt(t.numero_gestacoes):1:l.numero_gestacoes=0,(j=p.veterinario_responsavel)!=null&&j.trim()&&(l.veterinario_responsavel=p.veterinario_responsavel.trim()),(R=p.tecnico_responsavel)!=null&&R.trim()&&(l.tecnico_responsavel=p.tecnico_responsavel.trim()),n.diagnostico_existente?s.push({id:n.diagnostico_existente.id,...l}):d.push(l);let i,m=null;t.resultado==="PRENHE"?(i="PRENHE",m=se(n.data_abertura_lote)):t.resultado==="RETOQUE"?(i="PRENHE_RETOQUE",m=se(n.data_abertura_lote)):i="VAZIA",b.push({receptora_id:n.receptora_id,status:i,dataParto:m})}),d.length>0){const{data:n}=await v.from("diagnosticos_gestacao").select("id, receptora_id, data_te, tipo_diagnostico").in("receptora_id",[...new Set(d.map(i=>i.receptora_id))]).eq("tipo_diagnostico","DG"),t=new Map;n==null||n.forEach(i=>{const m=`${i.receptora_id}-${i.data_te}-${i.tipo_diagnostico}`;t.set(m,i.id)});const l=[];if(d.forEach(i=>{const m=`${i.receptora_id}-${i.data_te}-${i.tipo_diagnostico}`,u=t.get(m);u?s.push({id:u,...i}):l.push(i)}),l.length>0){const{error:i}=await v.from("diagnosticos_gestacao").insert(l);if(i)if((r=i.message)!=null&&r.includes("column")||i.code==="42703"){const m=l.map(({veterinario_responsavel:j,tecnico_responsavel:R,...L})=>L),{error:u}=await v.from("diagnosticos_gestacao").insert(m);if(u)throw new Error(`Erro ao inserir diagnósticos: ${u.message}`)}else throw new Error(`Erro ao inserir diagnósticos: ${i.message}`)}}for(const n of s){const{id:t,...l}=n;let{error:i}=await v.from("diagnosticos_gestacao").update(l).eq("id",t);if(i&&((f=i.message)!=null&&f.includes("column")||i.code==="42703")){const{veterinario_responsavel:m,tecnico_responsavel:u,...j}=l,{error:R}=await v.from("diagnosticos_gestacao").update(j).eq("id",t);if(R)throw new Error(`Erro ao atualizar diagnóstico: ${R.message}`)}else if(i)throw new Error(`Erro ao atualizar diagnóstico: ${i.message}`)}for(const n of b){const t={status_reprodutivo:n.status};n.dataParto?t.data_provavel_parto=n.dataParto:n.status==="VAZIA"&&(t.data_provavel_parto=null);const{error:l}=await v.from("receptoras").update(t).eq("id",n.receptora_id);if(l)throw new Error("Erro ao atualizar status da receptora")}const F=x.every(n=>{const t=H[n.receptora_id];return t&&t.resultado&&t.data_diagnostico});G({...c,veterinario_dg:p.veterinario_responsavel.trim(),tecnico_dg:p.tecnico_responsavel.trim(),status:F?"FECHADO":"ABERTO"}),A({title:"Lote salvo com sucesso",description:F?`${x.length} diagnóstico(s) registrado(s). Lote fechado.`:`${x.length} diagnóstico(s) registrado(s)`}),await M(T),c&&await z(c)}catch(d){A({title:"Erro ao salvar lote",description:d instanceof Error?d.message:"Erro desconhecido",variant:"destructive"})}finally{X(!1)}},pe=x.every(a=>{const r=H[a.receptora_id];return r&&r.resultado&&r.data_diagnostico});return e.jsxs("div",{className:"space-y-6",children:[e.jsx(ze,{title:"Diagnóstico de Gestação (DG)",description:"Registrar diagnósticos de gestação por lote de TE"}),e.jsx(Ze,{fazendas:ee,fazendaSelecionada:T,onFazendaChange:re}),T&&e.jsx(Be,{title:"Lotes de Transferência de Embriões",emptyTitle:"Nenhum lote de TE encontrado",emptyDescription:"Selecione outra fazenda ou verifique se há transferências registradas.",lotesTE:de,loteSelecionado:c,loading:le,veterinarioLabel:"Vet. DG",tecnicoLabel:"Téc. DG",getVeterinario:a=>a.veterinario_dg,getTecnico:a=>a.tecnico_dg,onSelectLote:G}),c&&Y&&e.jsx(ke,{title:"Abrir Lote de DG",loteSelecionado:c,loteFormData:p,onFormChange:I,onAbrirLote:_e,onCancelar:()=>{C(!1),G(null)}}),c&&!Y&&x.length>0&&e.jsxs(Ae,{children:[e.jsx(Se,{children:e.jsx(Je,{loteSelecionado:c,receptorasCount:x.length,loteFormData:p,onFormChange:I,veterinarioLabel:"Veterinário Responsável (DG)",tecnicoLabel:"Técnico Responsável (DG)",onSalvarLote:me,submitting:ne,canSave:pe})}),e.jsx(Te,{children:ie?e.jsx(je,{}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(Ce,{children:[e.jsx(Ne,{children:e.jsxs(te,{children:[e.jsx(D,{children:"Receptora"}),e.jsx(D,{children:"Dias Gestação"}),e.jsx(D,{children:"Embrião(ões)"}),e.jsx(D,{children:"Doadora / Touro"}),e.jsx(D,{children:"Data DG"}),e.jsx(D,{children:"Resultado"}),e.jsx(D,{children:"Nº Gest."}),e.jsx(D,{children:"Observações"})]})}),e.jsx(Fe,{children:x.map(a=>{var d;const r=H[a.receptora_id]||{resultado:"",numero_gestacoes:"",observacoes:"",data_diagnostico:K},f=!!a.diagnostico_existente;return e.jsxs(te,{children:[e.jsxs(w,{className:"font-medium",children:[a.brinco,a.nome&&e.jsxs("span",{className:"text-slate-500 text-sm ml-2",children:["(",a.nome,")"]}),f&&e.jsx(Oe,{status:((d=a.diagnostico_existente)==null?void 0:d.resultado)||"",className:"ml-2"})]}),e.jsxs(w,{children:[e.jsx("span",{className:"font-semibold",children:a.dias_gestacao})," dias"]}),e.jsx(w,{children:e.jsx("div",{className:"space-y-1",children:a.embrioes.map((s,b)=>e.jsx("div",{className:"text-sm",children:e.jsxs("div",{className:"font-medium",children:[s.embriao_identificacao||`Embrião ${b+1}`,s.embriao_classificacao&&e.jsxs("span",{className:"text-slate-500 ml-2",children:["(",s.embriao_classificacao,")"]})]})},s.te_id))})}),e.jsx(w,{children:e.jsx("div",{className:"space-y-1",children:a.embrioes.map(s=>e.jsx("div",{className:"text-sm",children:e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:s.doadora_registro||"-"}),s.doadora_registro&&s.touro_nome&&" × ",e.jsx("span",{className:"font-medium",children:s.touro_nome||""})]})},s.te_id))})}),e.jsx(w,{children:e.jsx(Ve,{value:r.data_diagnostico,onChange:s=>Q(a.receptora_id,"data_diagnostico",s||""),className:"w-36",disabled:c.status==="FECHADO"})}),e.jsx(w,{children:e.jsxs(Pe,{value:r.resultado,onValueChange:s=>ue(a.receptora_id,s),disabled:c.status==="FECHADO",children:[e.jsx(Ge,{className:"w-32",children:e.jsx(He,{placeholder:"Resultado"})}),e.jsxs(Ie,{children:[e.jsx(J,{value:"PRENHE",children:"PRENHE"}),e.jsx(J,{value:"VAZIA",children:"VAZIA"}),e.jsx(J,{value:"RETOQUE",children:"RETOQUE"})]})]})}),e.jsx(w,{children:r.resultado==="PRENHE"||r.resultado==="RETOQUE"?e.jsx(Le,{type:"number",min:"1",max:"3",value:r.numero_gestacoes,onChange:s=>Q(a.receptora_id,"numero_gestacoes",s.target.value),placeholder:"1-3",className:"w-20",disabled:c.status==="FECHADO"}):e.jsx("span",{className:"text-slate-400",children:"-"})}),e.jsx(w,{children:e.jsx(ye,{value:r.observacoes,onChange:s=>Q(a.receptora_id,"observacoes",s.target.value),placeholder:"Observações",rows:2,className:"w-48",disabled:c.status==="FECHADO"})})]},a.receptora_id)})})]})})})]})]})}export{va as default};
