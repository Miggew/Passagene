import{r as l,m as Se,s as k,a as ye,j as e,P as ee,n as Ke,R as q,o as Xe,p as Ye,f as F,h as G,q as ea}from"./index-CvlUDCD-.js";import{u as se,C as ue,a as me,b as pe,c as fe}from"./use-toast-BhbfqK05.js";import{I as K}from"./input-BiDTc9_9.js";import{L as O}from"./label-BIMTC7_j.js";import{T as te}from"./textarea-CWzGJoHk.js";import{u as aa,S as oa,a as sa,b as ta,c as ra,d as ia}from"./select-CRV7QsOQ.js";import{P as na,a as ca,b as la}from"./popover-D6dVxm31.js";import{C as da,a as ua,b as ma,c as pa,d as fa,e as ha}from"./command-CBz-a0vF.js";import{D as he,a as ve,b as ge,c as xe,d as je,e as be}from"./dialog-DSJKtNd7.js";import{T as va,a as ga,b as Ce,c as Z,d as xa,e as W}from"./table-BAfLAU-a.js";import{B as ja}from"./badge-C6XBkHcG.js";import{C as ba,Q as Ca}from"./QualidadeSemaforo-B8uShhiy.js";import{c as Re,I as _a,R as Na}from"./index-Mm2kbPk7.js";import{u as re}from"./index-BYe3zTS0.js";import{X as ae}from"./x-DpiajgWI.js";import{D as wa}from"./DatePickerBR-gAx3gAQT.js";import{P as _e,C as Ne,a as Sa,b as ya}from"./ConfirmExitDialog-pidvdbO9.js";import"./checkbox-CQbAiBlU.js";import{v as ze,a as Ra}from"./receptoraStatus-DUGAnGBM.js";import{P as za}from"./plus-BqMf1Hqu.js";import{U as Ee}from"./user-plus-Co7haBoe.js";import{L as Ea}from"./lock-F3GwCU70.js";import{S as Ia}from"./search-B2NaMPhp.js";import"./index-CDlvsNjp.js";import"./check-BbN618wW.js";import"./arrow-left-DavZAJTM.js";import"./circle-check-big-C9vVKwgT.js";import"./alert-dialog-DHPmuE4P.js";function Pa(){const{toast:a}=se(),[s,d]=l.useState(!1),[i,o]=l.useState(!1),[c,m]=l.useState([]),[u,r]=l.useState([]),[x,n]=l.useState([]),[g,E]=l.useState({fazenda_id:"",data_inicio:Se(),veterinario:"",tecnico:"",observacoes:""}),P=l.useCallback(async()=>{try{d(!0);const{data:b,error:t}=await k.from("fazendas").select("*").order("nome",{ascending:!0});if(t)throw t;m(b||[])}catch(b){a({title:"Erro ao carregar fazendas",description:b instanceof Error?b.message:"Erro desconhecido",variant:"destructive"})}finally{d(!1)}},[a]),L=l.useCallback(async b=>{try{o(!0);const{data:t,error:N}=await k.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",b);if(N)throw N;const f=(t==null?void 0:t.map(p=>p.receptora_id))||[];if(f.length===0){r([]),n([]);return}const{data:y,error:$}=await k.from("receptoras").select("id, identificacao, nome, status_reprodutivo").in("id",f).order("identificacao",{ascending:!0});if($)throw $;const U=(y||[]).filter(p=>(p.id?String(p.id).trim():"")!=="").map(async p=>{if(!(p.id?String(p.id).trim():""))return null;const v=p.status_reprodutivo||"VAZIA",S=ze(v,"ENTRAR_PASSO1");return{...p,status:v,motivoIndisponivel:S.valido?void 0:S.mensagem}}),V=(await Promise.all(U)).filter(p=>p!==null),C=V.filter(p=>p.status==="VAZIA");r(C),n(V)}catch(t){a({title:"Erro ao carregar receptoras",description:t instanceof Error?t.message:"Erro desconhecido",variant:"destructive"})}finally{o(!1)}},[a]),j=l.useCallback(b=>new Set(b.filter(t=>t.id&&t.id.trim()!==""&&t.id!==null&&t.id!==void 0).map(t=>String(t.id).trim())),[]),z=l.useCallback(b=>u.filter(t=>{const N=t.id?String(t.id).trim():"";return N!==""&&!b.has(N)}),[u]),B=l.useCallback((b,t)=>{if(!b.trim())return x.filter(f=>{const y=f.id?String(f.id).trim():"";return y!==""&&!t.has(y)&&f.status==="VAZIA"}).map(f=>({...f,disponivel:!0}));const N=b.toLowerCase().trim();return x.filter(f=>{const y=f.id?String(f.id).trim():"";if(y===""||t.has(y))return!1;const $=(f.identificacao||"").toLowerCase(),M=(f.nome||"").toLowerCase();return $.includes(N)||M.includes(N)}).map(f=>({...f,disponivel:f.status==="VAZIA"}))},[x]),_=l.useCallback(b=>{var t;return((t=c.find(N=>N.id===b))==null?void 0:t.nome)||"-"},[c]);return{loading:s,loadingReceptoras:i,fazendas:c,allReceptoras:u,receptorasComStatus:x,protocoloData:g,setProtocoloData:E,loadFazendas:P,loadAllReceptoras:L,getSelectedIds:j,getAvailableReceptoras:z,getReceptorasFiltradas:B,getFazendaNome:_}}function Ta({fazendaId:a,allReceptoras:s,receptorasComStatus:d,selectedIds:i,onReceptorasReload:o}){const{toast:c}=se(),[m,u]=l.useState([]),[r,x]=l.useState(!1),[n,g]=l.useState(!1),[E,P]=l.useState(""),[L,j]=l.useState(!1),[z,B]=l.useState({receptora_id:"",observacoes:"",ciclando_classificacao:null,qualidade_semaforo:null}),[_,b]=l.useState({identificacao:"",nome:"",observacoes:"",ciclando_classificacao:null,qualidade_semaforo:null}),[t,N]=l.useState(!1),f=l.useCallback(()=>{B({receptora_id:"",observacoes:"",ciclando_classificacao:null,qualidade_semaforo:null}),P(""),j(!1)},[]),y=l.useCallback(()=>{b({identificacao:"",nome:"",observacoes:"",ciclando_classificacao:null,qualidade_semaforo:null})},[]),$=l.useCallback(async()=>{var S;const C=((S=z.receptora_id)==null?void 0:S.trim())||"";if(!C){c({title:"Erro",description:"Selecione uma receptora",variant:"destructive"});return}const p=s.find(I=>(I.id?String(I.id).trim():"")===C);if(!p||!p.id){c({title:"Erro",description:"Receptora não encontrada ou inválida",variant:"destructive"});return}const h=p.status_reprodutivo||"VAZIA",v=ze(h,"ENTRAR_PASSO1");if(!v.valido){c({title:"Erro de validação",description:v.mensagem||"A receptora não pode entrar no protocolo no estado atual",variant:"destructive"});return}if(i.has(C)){c({title:"Receptora já adicionada",description:"Esta receptora já está na lista de selecionadas",variant:"destructive"});return}u(I=>{var R;return I.some(A=>(A.id?String(A.id).trim():"")===C)?I:[...I,{id:p.id,identificacao:p.identificacao,nome:p.nome,observacoes:((R=z.observacoes)==null?void 0:R.trim())||void 0,ciclando_classificacao:z.ciclando_classificacao||null,qualidade_semaforo:z.qualidade_semaforo||null}]}),f(),x(!1)},[z,s,i,c,f]),M=l.useCallback(async()=>{if(!_.identificacao.trim()){c({title:"Erro de validação",description:"Identificação (brinco) é obrigatória",variant:"destructive"});return}try{N(!0);const{data:C,error:p}=await k.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",a);if(p)throw p;const h=(C==null?void 0:C.map(R=>R.receptora_id))||[];if(h.length>0){const{data:R,error:A}=await k.from("receptoras").select("id, identificacao, nome").in("id",h).ilike("identificacao",_.identificacao.trim());if(A)throw A;if(R&&R.length>0){const H=R[0].nome?`"${R[0].nome}"`:"sem nome";throw new Error(`Já existe uma receptora com o brinco "${_.identificacao.trim()}" nesta fazenda (Nome: ${H}).`)}}if(_.nome.trim()&&h.length>0){const{data:R,error:A}=await k.from("receptoras").select("id, identificacao").in("id",h).ilike("nome",_.nome.trim());if(A)throw A;if(R&&R.length>0)throw new Error(`Já existe uma receptora com o nome "${_.nome.trim()}" nesta fazenda (Brinco: ${R[0].identificacao}).`)}const v={identificacao:_.identificacao};_.nome.trim()&&(v.nome=_.nome);const{data:S,error:I}=await k.from("receptoras").insert([v]).select().single();if(I)throw I.code==="23505"?new Error("Já existe uma receptora com esse brinco nesta fazenda."):I;const{error:Q}=await k.from("receptora_fazenda_historico").insert([{receptora_id:S.id,fazenda_id:a,data_inicio:Se(),data_fim:null}]);u(R=>[...R,{id:S.id,identificacao:S.identificacao,nome:S.nome,observacoes:_.observacoes||void 0,ciclando_classificacao:_.ciclando_classificacao||null,qualidade_semaforo:_.qualidade_semaforo||null,isNew:!0}]),y(),g(!1),await o()}catch(C){c({title:"Erro ao criar receptora",description:C instanceof Error?C.message:"Erro desconhecido",variant:"destructive"})}finally{N(!1)}},[_,a,c,y,o]),U=l.useCallback(C=>{u(p=>p.filter((h,v)=>v!==C))},[]),T=l.useCallback((C,p)=>{u(h=>h.map((v,S)=>S===C?{...v,ciclando_classificacao:p}:v))},[]),V=l.useCallback((C,p)=>{u(h=>h.map((v,S)=>S===C?{...v,qualidade_semaforo:p}:v))},[]);return{receptorasLocais:m,setReceptorasLocais:u,showAddReceptora:r,setShowAddReceptora:x,showCreateReceptora:n,setShowCreateReceptora:g,buscaReceptora:E,setBuscaReceptora:P,popoverAberto:L,setPopoverAberto:j,addReceptoraForm:z,setAddReceptoraForm:B,createReceptoraForm:_,setCreateReceptoraForm:b,submitting:t,handleAddReceptora:$,handleCreateReceptora:M,handleRemoveReceptora:U,handleUpdateCiclando:T,handleUpdateQualidade:V,resetAddForm:f,resetCreateForm:y}}function Aa({protocoloData:a,receptorasLocais:s}){const d=ye(),{toast:i}=se(),[o,c]=l.useState(!1),[m,u]=l.useState(!1),[r,x]=l.useState(!1),n=l.useRef(!1),g=l.useCallback(()=>!a.fazenda_id||!a.data_inicio||!a.veterinario.trim()||!a.tecnico.trim()?(i({title:"Erro de validação",description:"Fazenda, data de início, veterinário e técnico são obrigatórios",variant:"destructive"}),!1):!0,[a,i]),E=l.useCallback(async()=>{if(n.current||o)return;if(s.length===0){i({title:"Erro de validação",description:"Adicione pelo menos 1 receptora antes de finalizar o 1º passo",variant:"destructive"});return}if(s.filter(t=>!t.id||t.id===""||t.id===null||t.id===void 0).length>0){i({title:"Erro de validação",description:"Seleção de receptora inválida. Refaça a seleção.",variant:"destructive"});return}const j=s.filter(t=>t.id&&t.id!==""&&t.id!==null&&t.id!==void 0);if(j.length!==s.length||j.length===0){i({title:"Erro de validação",description:"Seleção de receptora inválida. Refaça a seleção.",variant:"destructive"});return}const z=j.map(t=>t.id),B=j.map(t=>t.observacoes||null),_=j.map(t=>t.ciclando_classificacao||null),b=j.map(t=>t.qualidade_semaforo||null);try{n.current=!0,c(!0);const t=`VET: ${a.veterinario.trim()} | TEC: ${a.tecnico.trim()}`,{data:N,error:f}=await k.rpc("criar_protocolo_passo1_atomico",{p_fazenda_id:a.fazenda_id,p_data_inicio:a.data_inicio,p_responsavel_inicio:t,p_receptoras_ids:z,p_data_inclusao:a.data_inicio,p_observacoes:a.observacoes.trim()||null,p_receptoras_observacoes:B});if(f)throw f;if(!N)throw new Error("Protocolo criado mas ID não retornado");const{data:y,error:$}=await k.from("protocolo_receptoras").select("id, receptora_id").eq("protocolo_id",N).in("receptora_id",z);if(!$&&y&&y.length>0){const T=new Map(z.map((h,v)=>[h,v])),V=y.map(async h=>{const v=T.get(h.receptora_id);if(v===void 0)return{success:!0};const S=_[v],I=b[v],{error:Q}=await k.from("protocolo_receptoras").update({ciclando_classificacao:S,qualidade_semaforo:I}).eq("id",h.id);return{success:!Q,error:Q}}),p=(await Promise.allSettled(V)).filter(h=>h.status==="rejected"||h.status==="fulfilled"&&h.value&&!h.value.success);p.length>0&&i({title:"Aviso",description:`Protocolo criado, mas ${p.length} classificação(ões) não foram salvas. Edite o protocolo para corrigir.`,variant:"destructive"})}if((await Promise.all(z.map(T=>Ra(T,"EM_SINCRONIZACAO")))).map((T,V)=>({result:T,receptoraId:z[V]})).filter(({result:T})=>T.error).length>0)throw new Error("Erro ao atualizar status das receptoras. Tente novamente.");x(!0)}catch(t){const N=t instanceof Error?t.message:"Erro desconhecido ao finalizar protocolo";i({title:"Erro ao finalizar protocolo",description:N,variant:"destructive"})}finally{c(!1),n.current=!1}},[a,s,i,d,o]),P=l.useCallback(()=>{u(!1),d("/protocolos")},[d]);return{submitting:o,showConfirmExit:m,setShowConfirmExit:u,showResumo:r,setShowResumo:x,handleFinalizarPasso1:E,handleConfirmExit:P,validateProtocoloForm:g}}var Ie="Toggle",ie=l.forwardRef((a,s)=>{const{pressed:d,defaultPressed:i,onPressedChange:o,...c}=a,[m,u]=re({prop:d,onChange:o,defaultProp:i??!1,caller:Ie});return e.jsx(ee.button,{type:"button","aria-pressed":m,"data-state":m?"on":"off","data-disabled":a.disabled?"":void 0,...c,ref:s,onClick:Ke(a.onClick,()=>{a.disabled||u(!m)})})});ie.displayName=Ie;var Pe=ie,D="ToggleGroup",[Te,go]=Xe(D,[Re]),Ae=Re(),ne=q.forwardRef((a,s)=>{const{type:d,...i}=a;if(d==="single"){const o=i;return e.jsx(ka,{...o,ref:s})}if(d==="multiple"){const o=i;return e.jsx(Ga,{...o,ref:s})}throw new Error(`Missing prop \`type\` expected on \`${D}\``)});ne.displayName=D;var[ke,Ge]=Te(D),ka=q.forwardRef((a,s)=>{const{value:d,defaultValue:i,onValueChange:o=()=>{},...c}=a,[m,u]=re({prop:d,defaultProp:i??"",onChange:o,caller:D});return e.jsx(ke,{scope:a.__scopeToggleGroup,type:"single",value:q.useMemo(()=>m?[m]:[],[m]),onItemActivate:u,onItemDeactivate:q.useCallback(()=>u(""),[u]),children:e.jsx(qe,{...c,ref:s})})}),Ga=q.forwardRef((a,s)=>{const{value:d,defaultValue:i,onValueChange:o=()=>{},...c}=a,[m,u]=re({prop:d,defaultProp:i??[],onChange:o,caller:D}),r=q.useCallback(n=>u((g=[])=>[...g,n]),[u]),x=q.useCallback(n=>u((g=[])=>g.filter(E=>E!==n)),[u]);return e.jsx(ke,{scope:a.__scopeToggleGroup,type:"multiple",value:m,onItemActivate:r,onItemDeactivate:x,children:e.jsx(qe,{...c,ref:s})})});ne.displayName=D;var[qa,$a]=Te(D),qe=q.forwardRef((a,s)=>{const{__scopeToggleGroup:d,disabled:i=!1,rovingFocus:o=!0,orientation:c,dir:m,loop:u=!0,...r}=a,x=Ae(d),n=aa(m),g={role:"group",dir:n,...r};return e.jsx(qa,{scope:d,rovingFocus:o,disabled:i,children:o?e.jsx(Na,{asChild:!0,...x,orientation:c,dir:n,loop:u,children:e.jsx(ee.div,{...g,ref:s})}):e.jsx(ee.div,{...g,ref:s})})}),X="ToggleGroupItem",$e=q.forwardRef((a,s)=>{const d=Ge(X,a.__scopeToggleGroup),i=$a(X,a.__scopeToggleGroup),o=Ae(a.__scopeToggleGroup),c=d.value.includes(a.value),m=i.disabled||a.disabled,u={...a,pressed:c,disabled:m},r=q.useRef(null);return i.rovingFocus?e.jsx(_a,{asChild:!0,...o,focusable:!m,active:c,ref:r,children:e.jsx(we,{...u,ref:s})}):e.jsx(we,{...u,ref:s})});$e.displayName=X;var we=q.forwardRef((a,s)=>{const{__scopeToggleGroup:d,value:i,...o}=a,c=Ge(X,d),m={role:"radio","aria-checked":a.pressed,"aria-pressed":void 0},u=c.type==="single"?m:void 0;return e.jsx(ie,{...u,...o,ref:s,onPressedChange:r=>{r?c.onItemActivate(i):c.onItemDeactivate(i)}})}),Ve=ne,Fe=$e;const Oe=Ye("inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground",{variants:{variant:{default:"bg-transparent",outline:"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground"},size:{default:"h-10 px-3",sm:"h-9 px-2.5",lg:"h-11 px-5"}},defaultVariants:{variant:"default",size:"default"}}),Va=l.forwardRef(({className:a,variant:s,size:d,...i},o)=>e.jsx(Pe,{ref:o,className:F(Oe({variant:s,size:d,className:a})),...i}));Va.displayName=Pe.displayName;const Be=l.createContext({size:"default",variant:"default"}),De=l.forwardRef(({className:a,variant:s,size:d,children:i,...o},c)=>e.jsx(Ve,{ref:c,className:F("flex items-center justify-center gap-1",a),...o,children:e.jsx(Be.Provider,{value:{variant:s,size:d},children:i})}));De.displayName=Ve.displayName;const oe=l.forwardRef(({className:a,children:s,variant:d,size:i,...o},c)=>{const m=l.useContext(Be);return e.jsx(Fe,{ref:c,className:F(Oe({variant:m.variant||d,size:m.size||i}),a),...o,children:s})});oe.displayName=Fe.displayName;function Le({ciclandoValue:a,qualidadeValue:s,onChangeCiclando:d,onChangeQualidade:i,disabled:o=!1,size:c="sm"}){const m=c==="sm"?"text-xs":"text-sm",u=c==="sm"?"w-4 h-4":"w-5 h-5";return e.jsxs("div",{className:"flex flex-wrap items-center gap-3 text-slate-600",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:F("text-slate-500 font-medium",m),children:"Ciclo:"}),e.jsxs(De,{type:"single",value:a||void 0,onValueChange:r=>{o||d(r==="CL"||r==="N"?r:null)},disabled:o,className:"gap-1",children:[e.jsx(oe,{value:"CL","aria-label":"CL",size:"sm",variant:"outline",className:F("h-7 px-2 text-xs",a==="CL"&&"bg-blue-100 text-blue-700 border-blue-300 data-[state=on]:bg-blue-100",o&&"opacity-60"),children:"CL"}),e.jsx(oe,{value:"N","aria-label":"N",size:"sm",variant:"outline",className:F("h-7 px-2 text-xs",a==="N"&&"bg-slate-100 text-slate-700 border-slate-300 data-[state=on]:bg-slate-100",o&&"opacity-60"),children:"N"})]}),a&&!o&&e.jsx(G,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 text-slate-400 hover:text-slate-600",onClick:()=>d(null),type:"button",children:e.jsx(ae,{className:"w-3 h-3"})}),!a&&e.jsx("span",{className:F("text-slate-300",m),children:"—"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:F("text-slate-500 font-medium",m),children:"Qualidade:"}),e.jsx("div",{className:"flex items-center gap-1.5",children:[1,2,3].map(r=>e.jsx("button",{type:"button",disabled:o,onClick:()=>{o||i(s===r?null:r)},className:F(u,"rounded-full border-2 transition-all",ea(r),s===r?"border-slate-900 scale-110 ring-2 ring-slate-300":"border-slate-300 opacity-50 hover:opacity-75 hover:scale-105",o&&"opacity-40 cursor-not-allowed",!o&&"cursor-pointer"),title:`Qualidade ${r}`},r))}),s&&!o&&e.jsx(G,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 text-slate-400 hover:text-slate-600",onClick:()=>i(null),type:"button",children:e.jsx(ae,{className:"w-3 h-3"})}),!s&&e.jsx("span",{className:F("text-slate-300",m),children:"—"})]})]})}function xo(){const a=ye(),[s,d]=l.useState("form"),{loading:i,loadingReceptoras:o,fazendas:c,allReceptoras:m,receptorasComStatus:u,protocoloData:r,setProtocoloData:x,loadFazendas:n,loadAllReceptoras:g,getSelectedIds:E,getReceptorasFiltradas:P,getFazendaNome:L}=Pa(),{receptorasLocais:j,showAddReceptora:z,setShowAddReceptora:B,showCreateReceptora:_,setShowCreateReceptora:b,buscaReceptora:t,setBuscaReceptora:N,popoverAberto:f,setPopoverAberto:y,addReceptoraForm:$,setAddReceptoraForm:M,createReceptoraForm:U,setCreateReceptoraForm:T,submitting:V,handleAddReceptora:C,handleCreateReceptora:p,handleRemoveReceptora:h,handleUpdateCiclando:v,handleUpdateQualidade:S,resetAddForm:I,resetCreateForm:Q}=Ta({fazendaId:r.fazenda_id,allReceptoras:m,receptorasComStatus:u,selectedIds:E([]),onReceptorasReload:()=>g(r.fazenda_id)}),{submitting:R,showConfirmExit:A,setShowConfirmExit:H,showResumo:Me,setShowResumo:Qe,handleFinalizarPasso1:Ue,handleConfirmExit:ce,validateProtocoloForm:He}=Aa({protocoloData:r,receptorasLocais:j}),J=V||R,le=l.useMemo(()=>E(j),[E,j]),Ze=l.useMemo(()=>P(t,le),[P,t,le]);l.useEffect(()=>{n()},[n]),l.useEffect(()=>{s==="receptoras"&&r.fazenda_id&&g(r.fazenda_id)},[s,r.fazenda_id,g]);const We=()=>{He()&&d("receptoras")},de=()=>{s==="form"?a("/protocolos"):d("form")},Y=()=>{r.fazenda_id||j.length>0?H(!0):a("/protocolos")},Je=()=>{Qe(!1),a("/protocolos")};return s==="form"?e.jsxs("div",{className:"space-y-6",children:[e.jsx(_e,{currentStep:1,title:"Novo Protocolo",subtitle:"Primeira visita - Cadastrar protocolo de sincronização",onBack:Y,onExit:Y}),e.jsxs(ue,{children:[e.jsx(me,{children:e.jsx(pe,{className:"text-base",children:"Informações do Protocolo"})}),e.jsx(fe,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{htmlFor:"fazenda_id",children:"Fazenda *"}),e.jsxs(oa,{value:r.fazenda_id,onValueChange:w=>x({...r,fazenda_id:w}),children:[e.jsx(sa,{children:e.jsx(ta,{placeholder:"Selecione a fazenda"})}),e.jsx(ra,{children:c.map(w=>e.jsx(ia,{value:w.id,children:w.nome},w.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{htmlFor:"data_inicio",children:"Data de Início *"}),e.jsx(wa,{id:"data_inicio",value:r.data_inicio,onChange:w=>x({...r,data_inicio:w||""}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{htmlFor:"veterinario",children:"Veterinário Responsável *"}),e.jsx(K,{id:"veterinario",value:r.veterinario,onChange:w=>x({...r,veterinario:w.target.value}),placeholder:"Nome do veterinário",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{htmlFor:"tecnico",children:"Técnico Responsável *"}),e.jsx(K,{id:"tecnico",value:r.tecnico,onChange:w=>x({...r,tecnico:w.target.value}),placeholder:"Nome do técnico/funcionário",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{htmlFor:"observacoes",children:"Observações"}),e.jsx(te,{id:"observacoes",value:r.observacoes,onChange:w=>x({...r,observacoes:w.target.value}),placeholder:"Observações sobre o protocolo",rows:3})]}),e.jsx("div",{className:"flex gap-4 pt-4",children:e.jsx(G,{onClick:We,className:"bg-blue-600 hover:bg-blue-700",disabled:i,children:"Continuar para Receptoras"})})]})})]}),e.jsx(Ne,{open:A,onOpenChange:H,onConfirm:ce,title:"Sair sem finalizar?",description:"Se você sair agora, nenhum protocolo será criado. Todos os dados serão perdidos."})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(_e,{currentStep:1,title:"Adicionar Receptoras",subtitle:"Selecione as receptoras para este protocolo",onBack:de,onExit:Y}),e.jsx(Sa,{fazendaNome:L(r.fazenda_id),dataInicio:r.data_inicio,veterinario:r.veterinario,tecnico:r.tecnico}),e.jsxs(ue,{children:[e.jsx(me,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(pe,{className:"text-base",children:["Receptoras do Protocolo (",j.length,")"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(he,{open:z,onOpenChange:w=>{B(w),w||I()},children:[e.jsx(ve,{asChild:!0,children:e.jsxs(G,{className:"bg-green-600 hover:bg-green-700",children:[e.jsx(za,{className:"w-4 h-4 mr-2"}),"Adicionar Receptora"]})}),e.jsxs(ge,{className:"max-w-lg",children:[e.jsxs(xe,{children:[e.jsx(je,{children:"Adicionar Receptora ao Protocolo"}),e.jsx(be,{children:"Busque por identificação ou nome."})]}),e.jsx(Fa,{addReceptoraForm:$,setAddReceptoraForm:M,buscaReceptora:t,setBuscaReceptora:N,popoverAberto:f,setPopoverAberto:y,receptorasFiltradas:Ze,receptorasComStatus:u,loadingReceptoras:o,onAdd:C})]})]}),e.jsxs(he,{open:_,onOpenChange:w=>{b(w),w||Q()},children:[e.jsx(ve,{asChild:!0,children:e.jsxs(G,{variant:"outline",children:[e.jsx(Ee,{className:"w-4 h-4 mr-2"}),"Cadastrar Nova"]})}),e.jsxs(ge,{children:[e.jsxs(xe,{children:[e.jsx(je,{children:"Cadastrar Nova Receptora"}),e.jsx(be,{children:"Preencha os dados da nova receptora."})]}),e.jsx(Oa,{createReceptoraForm:U,setCreateReceptoraForm:T,submitting:J,onCreate:p})]})]})]})]})}),e.jsx(fe,{children:j.length===0?e.jsx("div",{className:"text-center py-8 text-slate-500",children:"Nenhuma receptora adicionada. Adicione pelo menos uma antes de finalizar."}):e.jsx(Ba,{receptorasLocais:j,onRemove:h,onUpdateCiclando:v,onUpdateQualidade:S})})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(G,{variant:"outline",onClick:de,disabled:J,children:"Voltar"}),e.jsxs(G,{onClick:Ue,disabled:j.length===0||J,className:"bg-blue-600 hover:bg-blue-700",size:"lg",children:[e.jsx(Ea,{className:"w-4 h-4 mr-2"}),J?"Finalizando...":"Finalizar 1º Passo"]})]}),e.jsx(Ne,{open:A,onOpenChange:H,onConfirm:ce,title:"Sair sem finalizar?",description:"Se você sair agora, nenhum protocolo será criado. Todos os dados serão perdidos."}),e.jsx(ya,{open:Me,onClose:Je,step:1,fazendaNome:L(r.fazenda_id),dataInicio:r.data_inicio,totalReceptoras:j.length,receptorasConfirmadas:j.length})]})}function Fa({addReceptoraForm:a,setAddReceptoraForm:s,buscaReceptora:d,setBuscaReceptora:i,popoverAberto:o,setPopoverAberto:c,receptorasFiltradas:m,receptorasComStatus:u,loadingReceptoras:r,onAdd:x}){return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{children:"Receptora *"}),e.jsxs(na,{open:o,onOpenChange:c,children:[e.jsx(ca,{asChild:!0,children:e.jsxs(G,{variant:"outline",role:"combobox","aria-expanded":o,className:"w-full justify-between",children:[a.receptora_id?(()=>{const n=u.find(g=>String(g.id).trim()===a.receptora_id.trim());return n?`${n.identificacao}${n.nome?` - ${n.nome}`:""}`:"Selecione uma receptora"})():"Buscar receptora...",e.jsx(Ia,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(la,{className:"w-[400px] p-0",align:"start",children:e.jsxs(da,{shouldFilter:!1,children:[e.jsx(ua,{placeholder:"Buscar por identificação ou nome...",value:d,onValueChange:i}),e.jsx(ma,{children:r?e.jsx("div",{className:"p-4 text-sm text-center text-slate-500",children:"Carregando receptoras..."}):m.length===0?e.jsx(pa,{children:d.trim()?"Nenhuma receptora encontrada":"Nenhuma receptora disponível"}):e.jsx(fa,{children:m.map(n=>{var E,P;const g=n.id?String(n.id).trim():"";return g?e.jsx(ha,{value:`${n.identificacao} ${n.nome||""} ${g}`,onSelect:()=>{n.disponivel&&(s({...a,receptora_id:g}),i(""),c(!1))},disabled:!n.disponivel,className:n.disponivel?"":"opacity-60 cursor-not-allowed",children:e.jsxs("div",{className:"flex flex-col w-full",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("span",{className:"flex-1",children:[n.identificacao,n.nome?` - ${n.nome}`:""]}),e.jsx(ja,{variant:"outline",className:n.disponivel?"bg-green-50 text-green-700 border-green-200":"bg-red-50 text-red-700 border-red-200",children:n.disponivel?"Disponível":"Indisponível"})]}),!n.disponivel&&e.jsx("span",{className:"text-xs text-red-600 mt-1",children:(E=n.motivoIndisponivel)!=null&&E.includes("Status atual:")&&((P=n.motivoIndisponivel.split("Status atual:")[1])==null?void 0:P.trim())||n.status})]})},n.id):null})})})]})})]})]}),e.jsx("div",{className:"space-y-2",children:e.jsx(Le,{ciclandoValue:a.ciclando_classificacao,qualidadeValue:a.qualidade_semaforo,onChangeCiclando:n=>s({...a,ciclando_classificacao:n}),onChangeQualidade:n=>s({...a,qualidade_semaforo:n}),size:"sm"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{children:"Observações"}),e.jsx(te,{value:a.observacoes,onChange:n=>s({...a,observacoes:n.target.value}),placeholder:"Observações sobre a inclusão",rows:2})]}),e.jsx(G,{onClick:x,className:"w-full bg-green-600 hover:bg-green-700",disabled:r||!a.receptora_id,children:"Adicionar"})]})}function Oa({createReceptoraForm:a,setCreateReceptoraForm:s,submitting:d,onCreate:i}){return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{children:"Identificação (Brinco) *"}),e.jsx(K,{value:a.identificacao,onChange:o=>s({...a,identificacao:o.target.value}),placeholder:"Número do brinco"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{children:"Nome"}),e.jsx(K,{value:a.nome,onChange:o=>s({...a,nome:o.target.value}),placeholder:"Nome da receptora (opcional)"})]}),e.jsx("div",{className:"space-y-2",children:e.jsx(Le,{ciclandoValue:a.ciclando_classificacao||null,qualidadeValue:a.qualidade_semaforo||null,onChangeCiclando:o=>s({...a,ciclando_classificacao:o}),onChangeQualidade:o=>s({...a,qualidade_semaforo:o}),size:"sm"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{children:"Observações"}),e.jsx(te,{value:a.observacoes,onChange:o=>s({...a,observacoes:o.target.value}),placeholder:"Observações sobre a receptora",rows:2})]}),e.jsxs(G,{onClick:i,className:"w-full bg-blue-600 hover:bg-blue-700",disabled:d,children:[e.jsx(Ee,{className:"w-4 h-4 mr-2"}),d?"Criando...":"Criar e Adicionar"]})]})}function Ba({receptorasLocais:a,onRemove:s,onUpdateCiclando:d,onUpdateQualidade:i}){return e.jsx("div",{className:"rounded-lg border overflow-hidden",children:e.jsxs(va,{children:[e.jsx(ga,{children:e.jsxs(Ce,{className:"bg-slate-50",children:[e.jsx(Z,{className:"font-semibold",children:"Brinco"}),e.jsx(Z,{className:"font-semibold",children:"Nome"}),e.jsx(Z,{className:"font-semibold",children:"Ciclando"}),e.jsx(Z,{className:"font-semibold",children:"Qualidade"}),e.jsx(Z,{className:"font-semibold",children:"Observações"}),e.jsx(Z,{className:"text-right font-semibold",children:"Ações"})]})}),e.jsx(xa,{children:a.map((o,c)=>{const m=o.id&&o.id.trim()!==""?o.id:`new-${c}`;return e.jsxs(Ce,{className:"hover:bg-slate-50/50",children:[e.jsx(W,{className:"font-medium",children:o.identificacao}),e.jsx(W,{className:"text-slate-600",children:o.nome||"-"}),e.jsx(W,{children:e.jsx(ba,{value:o.ciclando_classificacao,onChange:u=>d(c,u),variant:"editable"})}),e.jsx(W,{children:e.jsx(Ca,{value:o.qualidade_semaforo,onChange:u=>i(c,u),variant:"row"})}),e.jsx(W,{className:"text-slate-600",children:o.observacoes||"-"}),e.jsx(W,{className:"text-right",children:e.jsx(G,{variant:"ghost",size:"sm",onClick:()=>s(c),children:e.jsx(ae,{className:"w-4 h-4"})})})]},m)})})]})})}export{xo as default};
