import{c as xa,r,s as m,b as ta,j as e,B as _e,q as ga,X as Ye,g as va,f as ja}from"./index-B-7HRnm0.js";import{C as Oe,a as Be,b as Me,d as Te}from"./card-DdhhEbXV.js";import{T as Je,a as Xe,b as Fe,c as me,d as Ke,e as ue}from"./table-fky3lpGR.js";import{S as $e,a as He,b as ke,c as Re,d as Ve}from"./select-B0M3FCy4.js";import{I as qe}from"./input-D2h8r4MO.js";import{B as Ue}from"./badge-BCHVCiM7.js";import{P as ba}from"./PageHeader-CT7CFo0W.js";import{E as wa}from"./EmptyState-gn01eel2.js";import{u as ye}from"./use-toast-DDUqdzpY.js";import{h as Ze}from"./error-handler-CBBt1r71.js";import{e as Ce,t as ia,d as ra,f as De,a as Na,g as Da}from"./dateUtils-eJ5e6apA.js";import{D as We,f as Sa,a as ea,b as aa,c as sa,d as oa}from"./dialog-CIXjHraQ.js";import{C as Ea,a as za,b as Fa,c as Ca,d as ya,e as Aa}from"./command-C3-lNK43.js";import{P as La,a as qa,b as Ia}from"./popover-i4alam_g.js";import{L as ge}from"./label-vBcRjcSu.js";import{T as la}from"./textarea-RmDl789L.js";import{P as ma}from"./plus-Cnek-_uY.js";import{C as Pa}from"./check-C6h7QFZL.js";import{A as Oa}from"./arrow-left-D9wDrV6g.js";import{F as Ba}from"./file-text-ElQw19Mr.js";import{P as na}from"./package-DCz2QOfz.js";import{U as da}from"./users-B1VQ-Dt9.js";import{F as Ma}from"./filter-WiIDhzCI.js";import{C as Ta}from"./calendar-D8momPux.js";import{E as $a}from"./eye-C2rdP5in.js";import"./index-B4eR1KA_.js";import"./search-DcAWDjHO.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ha=xa("ChevronsUpDown",[["path",{d:"m7 15 5 5 5-5",key:"1hf1tw"}],["path",{d:"m7 9 5-5 5 5",key:"sgt6xg"}]]);function Ge(i){return{[-1]:"Aspira√ß√£o",0:"Fecunda√ß√£o",1:"Zigoto",2:"Clivagem",3:"Clivagem Avan√ßada",4:"Compacta√ß√£o",5:"M√≥rula / Blastocisto Inicial",6:"Blastocisto",7:"Blastocisto Expandido",8:"Resgate / Sa√≠da Tardia"}[i]||`Dia ${i}`}function ka(i){return i===-1?"bg-blue-100 text-blue-800 border-blue-300":i===0?"bg-green-100 text-green-800 border-green-300":i>=1&&i<=3?"bg-yellow-100 text-yellow-800 border-yellow-300":i>=4&&i<=5||i===6?"bg-orange-100 text-orange-800 border-orange-300":i===7?"bg-purple-100 text-purple-800 border-purple-300":i===8?"bg-red-100 text-red-800 border-red-300":"bg-slate-100 text-slate-800 border-slate-300"}const ua="lotes_fiv_filtros";function pa(){try{const i=localStorage.getItem(ua);return i?JSON.parse(i):{}}catch{return{}}}function Ra(i){try{localStorage.setItem(ua,JSON.stringify(i))}catch{}}const ca=8;function Va(i){return i===0?-1:i>9?8:i-1}function Ua({lotes:i,pacotesParaFiltro:L,fazendasAspiracaoUnicas:S,lotesHistoricos:U}){const[g]=r.useState(()=>pa()),[p,x]=r.useState(g.filtroFazendaAspiracao??""),[y,re]=r.useState(g.filtroFazendaAspiracaoBusca??""),[b,Z]=r.useState(g.filtroDiaCultivo??""),[H,K]=r.useState(!1),[Y,J]=r.useState(g.filtroHistoricoDataInicio??""),[te,W]=r.useState(g.filtroHistoricoDataFim??""),[ne,w]=r.useState(g.filtroHistoricoFazenda??""),[q,I]=r.useState(g.filtroHistoricoFazendaBusca??""),[M,R]=r.useState(!1),[ee,T]=r.useState(g.abaAtiva??"ativos"),[V,Q]=r.useState(g.historicoPage??1);r.useEffect(()=>{Ra({abaAtiva:ee,filtroFazendaAspiracao:p,filtroFazendaAspiracaoBusca:y,filtroDiaCultivo:b,filtroHistoricoDataInicio:Y,filtroHistoricoDataFim:te,filtroHistoricoFazenda:ne,filtroHistoricoFazendaBusca:q,historicoPage:V})},[ee,p,y,b,Y,te,ne,q,V]),r.useEffect(()=>{Q(1)},[Y,te,ne]),r.useEffect(()=>{const o=Math.max(1,Math.ceil(U.length/ca));V>o&&Q(o)},[U.length,V]),r.useEffect(()=>{const o=s=>{const c=s.target;c.closest(".fazenda-busca-container")||K(!1),c.closest(".fazenda-busca-historico-container")||R(!1)};if(H||M)return document.addEventListener("mousedown",o),()=>{document.removeEventListener("mousedown",o)}},[H,M]);const N=r.useMemo(()=>{let o=[...i];if(o=o.filter(s=>s.status==="FECHADO"||s.dia_atual!==void 0&&s.dia_atual>9?!1:s.dia_atual!==void 0&&s.dia_atual<=9),p&&(o=o.filter(s=>{const c=L.find(v=>v.id===s.pacote_aspiracao_id);return(c==null?void 0:c.fazenda_id)===p})),b!==""){const s=parseInt(b);o=o.filter(c=>c.dia_atual===void 0||c.dia_atual===null?!1:(c.dia_atual===0?-1:c.dia_atual-1)===s)}return o},[i,p,b,L]),u=r.useMemo(()=>S.filter(o=>o.nome.toLowerCase().includes(y.toLowerCase())),[S,y]);return{filtroFazendaAspiracao:p,setFiltroFazendaAspiracao:x,filtroFazendaAspiracaoBusca:y,setFiltroFazendaAspiracaoBusca:re,filtroDiaCultivo:b,setFiltroDiaCultivo:Z,showFazendaBusca:H,setShowFazendaBusca:K,fazendasFiltradas:u,lotesFiltrados:N,limparFiltrosAtivos:()=>{x(""),re(""),Z(""),K(!1)},filtroHistoricoDataInicio:Y,setFiltroHistoricoDataInicio:J,filtroHistoricoDataFim:te,setFiltroHistoricoDataFim:W,filtroHistoricoFazenda:ne,setFiltroHistoricoFazenda:w,filtroHistoricoFazendaBusca:q,setFiltroHistoricoFazendaBusca:I,showFazendaBuscaHistorico:M,setShowFazendaBuscaHistorico:R,limparFiltrosHistorico:()=>{J(""),W(""),w(""),I(""),R(!1),Q(1)},abaAtiva:ee,setAbaAtiva:T,historicoPage:V,setHistoricoPage:Q,HISTORICO_PAGE_SIZE:ca}}function Za(){const{toast:i}=ye(),[L,S]=r.useState([]),[U,g]=r.useState([]),[p,x]=r.useState([]),[y,re]=r.useState([]),[b,Z]=r.useState([]),[H,K]=r.useState(!0),[Y,J]=r.useState([]),[te,W]=r.useState([]),ne=r.useCallback(async()=>{try{K(!0);const{data:w,error:q}=await m.from("pacotes_aspiracao").select("*").eq("status","FINALIZADO").order("data_aspiracao",{ascending:!1});if(q)throw q;const{data:I,error:M}=await m.from("fazendas").select("id, nome").order("nome",{ascending:!0});if(M)throw M;x(I||[]);const{data:R,error:ee}=await m.from("clientes").select("id, nome").order("nome",{ascending:!0});ee||Z(R||[]);const T=new Map(I==null?void 0:I.map(t=>[t.id,t.nome])),V=new Map,Q=new Map,N=(w==null?void 0:w.map(t=>t.id))||[];if(N.length>0){const{data:t,error:z}=await m.from("pacotes_aspiracao_fazendas_destino").select("pacote_aspiracao_id, fazenda_destino_id").in("pacote_aspiracao_id",N);!z&&t&&t.forEach(P=>{const d=T.get(P.fazenda_destino_id);if(d){const B=V.get(P.pacote_aspiracao_id)||[];B.push(d),V.set(P.pacote_aspiracao_id,B)}});const{data:E,error:F}=await m.from("aspiracoes_doadoras").select("pacote_aspiracao_id").in("pacote_aspiracao_id",N);!F&&E&&E.forEach(P=>{P.pacote_aspiracao_id&&Q.set(P.pacote_aspiracao_id,(Q.get(P.pacote_aspiracao_id)||0)+1)})}const{data:u,error:l}=await m.from("lotes_fiv").select("*").order("data_abertura",{ascending:!1});if(l)throw l;const f=new Set((u==null?void 0:u.map(t=>t.pacote_aspiracao_id).filter(t=>!!t))||[]),s=(w||[]).filter(t=>t.usado_em_lote_fiv!==void 0?!t.usado_em_lote_fiv:!f.has(t.id)).map(t=>({...t,fazenda_nome:T.get(t.fazenda_id),fazendas_destino_nomes:V.get(t.id)||[],quantidade_doadoras:Q.get(t.id)||0}));g(s);const c=(u==null?void 0:u.map(t=>t.id))||[],{data:v,error:_}=await m.from("lote_fiv_acasalamentos").select("lote_fiv_id").in("lote_fiv_id",c);if(_)throw _;const A=new Map;v==null||v.forEach(t=>{A.set(t.lote_fiv_id,(A.get(t.lote_fiv_id)||0)+1)});const{data:k,error:D}=await m.from("lote_fiv_fazendas_destino").select("lote_fiv_id, fazenda_id").in("lote_fiv_id",c);if(D)throw D;const a=new Map;k==null||k.forEach(t=>{const z=T.get(t.fazenda_id);if(z){const E=a.get(t.lote_fiv_id)||[];E.push(z),a.set(t.lote_fiv_id,E)}});const n=new Map(s.map(t=>[t.id,t]));(w||[]).forEach(t=>{n.has(t.id)||n.set(t.id,{...t,fazenda_nome:T.get(t.fazenda_id),fazendas_destino_nomes:V.get(t.id)||[],quantidade_doadoras:Q.get(t.id)||0})});const j=(u||[]).map(t=>{const z=n.get(t.pacote_aspiracao_id);let E=Ce((z==null?void 0:z.data_aspiracao)||null);if(!E){const d=Ce(t.data_abertura);if(d){const[B,$,le]=d.split("-").map(Number),X=new Date(B,$-1,le);X.setDate(X.getDate()-1);const ie=X.getFullYear(),oe=String(X.getMonth()+1).padStart(2,"0"),ce=String(X.getDate()).padStart(2,"0");E=`${ie}-${oe}-${ce}`}}const F=ia(),P=E?Math.max(0,ra(E,F)):0;return{...t,pacote_nome:z==null?void 0:z.fazenda_nome,pacote_data:z==null?void 0:z.data_aspiracao,fazendas_destino_nomes:a.get(t.id)||[],quantidade_acasalamentos:A.get(t.id)||0,dia_atual:P}}),O=j.filter(t=>t.status==="ABERTO"&&t.dia_atual!==void 0&&t.dia_atual>9);if(O.length>0){const t=O.map(E=>E.id),{error:z}=await m.from("lotes_fiv").update({status:"FECHADO"}).in("id",t);z&&i({title:"Aviso",description:"N√£o foi poss√≠vel fechar automaticamente alguns lotes expirados. Recarregue a p√°gina.",variant:"destructive"}),z||O.forEach(E=>{E.status="FECHADO"})}S(j);const se=new Set(j.map(t=>t.pacote_aspiracao_id).filter(t=>!!t)),de=[];(w||[]).forEach(t=>{se.has(t.id)&&de.push({...t,fazenda_nome:T.get(t.fazenda_id),fazendas_destino_nomes:V.get(t.id)||[],quantidade_doadoras:Q.get(t.id)||0})}),J(de);const he=new Map;de.forEach(t=>{t.fazenda_id&&t.fazenda_nome&&he.set(t.fazenda_id,t.fazenda_nome)}),W(Array.from(he.entries()).map(([t,z])=>({id:t,nome:z})).sort((t,z)=>t.nome.localeCompare(z.nome)))}catch(w){Ze(w,"Erro ao carregar dados")}finally{K(!1)}},[i]);return{lotes:L,pacotes:U,fazendas:p,setFazendas:x,doadoras:y,setDoadoras:re,clientes:b,setClientes:Z,loading:H,setLoading:K,pacotesParaFiltro:Y,fazendasAspiracaoUnicas:te,loadData:ne}}function Qa({setFazendas:i,setDoadoras:L,setClientes:S,setLoading:U}){const{toast:g}=ye(),[p,x]=r.useState(null),[y,re]=r.useState(!1),[b,Z]=r.useState([]),[H,K]=r.useState([]),[Y,J]=r.useState([]),[te,W]=r.useState([]),[ne,w]=r.useState([]),[q,I]=r.useState(""),[M,R]=r.useState([]),[ee,T]=r.useState([]),[V,Q]=r.useState(""),N=r.useCallback(async l=>{try{const{data:f,error:o}=await m.from("embrioes").select("id, lote_fiv_acasalamento_id, created_at").eq("lote_fiv_id",l).order("created_at",{ascending:!1});if(o){J([]);return}const s=new Map;f==null||f.forEach(_=>{if(_.created_at){const A=_.created_at.split("T")[0],k=s.get(A)||[];k.push(_),s.set(A,k)}});const c=[...new Set((f==null?void 0:f.map(_=>_.lote_fiv_acasalamento_id).filter(Boolean))||[])];if(c.length>0){const{data:_,error:A}=await m.from("lote_fiv_acasalamentos").select("id, aspiracao_doadora_id, dose_semen_id").in("id",c);if(!A&&_){const k=[...new Set(_.map(F=>F.aspiracao_doadora_id).filter(Boolean))],{data:D}=await m.from("aspiracoes_doadoras").select("id, doadora_id").in("id",k),a=[...new Set((D==null?void 0:D.map(F=>F.doadora_id).filter(Boolean))||[])],{data:n}=await m.from("doadoras").select("id, registro, nome").in("id",a),j=[...new Set(_.map(F=>F.dose_semen_id).filter(Boolean))],{data:O}=await m.from("doses_semen").select("id, touro_id, touro:touros(id, nome, registro, raca)").in("id",j),se=new Map((D==null?void 0:D.map(F=>[F.id,F]))||[]),de=new Map((n==null?void 0:n.map(F=>[F.id,F]))||[]),he=new Map((O==null?void 0:O.map(F=>[F.id,F]))||[]),t=new Map(_.map(F=>[F.id,F])),E=Array.from(s.keys()).sort((F,P)=>P.localeCompare(F)).map(F=>{const P=s.get(F)||[],d=new Map;P.forEach($=>{$.lote_fiv_acasalamento_id&&d.set($.lote_fiv_acasalamento_id,(d.get($.lote_fiv_acasalamento_id)||0)+1)});const B=Array.from(d.entries()).map(([$,le])=>{var be;const X=t.get($),ie=X?se.get(X.aspiracao_doadora_id):void 0,oe=ie?de.get(ie.doadora_id):void 0,ce=X?he.get(X.dose_semen_id):void 0;return{acasalamento_id:$,quantidade:le,doadora:(oe==null?void 0:oe.registro)||(oe==null?void 0:oe.nome)||"-",dose:ce?((be=ce.touro)==null?void 0:be.nome)||"Touro desconhecido":"-"}});return{id:`${l}-${F}`,data_despacho:F,acasalamentos:B}});J(E);return}}const v=Array.from(s.keys()).map(_=>({id:`${l}-${_}`,data_despacho:_,acasalamentos:[]}));J(v)}catch{J([])}},[]),u=r.useCallback(async l=>{try{U(!0);const{data:f,error:o}=await m.from("lotes_fiv").select("*").eq("id",l).single();if(o)throw o;const{data:s,error:c}=await m.from("pacotes_aspiracao").select("*").eq("id",f.pacote_aspiracao_id).single();if(c){if(c.code==="PGRST116"){g({title:"Pacote n√£o encontrado",description:"O lote referencia um pacote de aspira√ß√£o inexistente. Verifique o v√≠nculo do lote.",variant:"destructive"}),U(!1);return}throw c}Q(s.data_aspiracao);const{data:v,error:_}=await m.from("fazendas").select("nome").eq("id",s.fazenda_id).single();I(_?"":(v==null?void 0:v.nome)||"");const{data:A}=await m.from("pacotes_aspiracao_fazendas_destino").select("fazenda_destino_id").eq("pacote_aspiracao_id",s.id);let k=[];if(!A||A.length===0?s.fazenda_destino_id&&(k=[s.fazenda_destino_id]):k=A.map(h=>h.fazenda_destino_id),K(k),k.length>0){const{data:h,error:pe}=await m.from("fazendas").select("id, nome").in("id",k);pe?R([]):(R((h==null?void 0:h.map(ae=>ae.nome))||[]),h&&i(ae=>{const fe=[...ae];return h.forEach(G=>{fe.find(xe=>xe.id===G.id)||fe.push(G)}),fe}))}else R([]);const{data:D,error:a}=await m.from("lote_fiv_acasalamentos").select("*").eq("lote_fiv_id",l).order("created_at",{ascending:!0});if(a)throw a;const n=(D==null?void 0:D.map(h=>h.aspiracao_doadora_id))||[],{data:j,error:O}=await m.from("aspiracoes_doadoras").select("id, doadora_id, viaveis").in("id",n);if(O)throw O;const se=[...new Set((j==null?void 0:j.map(h=>h.doadora_id))||[])],{data:de,error:he}=await m.from("doadoras").select("id, nome, registro").in("id",se);if(he)throw he;const t=[...new Set((D==null?void 0:D.map(h=>h.dose_semen_id))||[])],{data:z,error:E}=await m.from("doses_semen").select("id, touro_id, touro:touros(id, nome, registro, raca)").in("id",t);if(E)throw E;const F=new Map(de==null?void 0:de.map(h=>[h.id,h])),P=new Map(z==null?void 0:z.map(h=>[h.id,h])),d=new Map(j==null?void 0:j.map(h=>[h.id,h])),{data:B,error:$}=await m.from("embrioes").select("lote_fiv_acasalamento_id").eq("lote_fiv_id",l),le=new Map;!$&&B&&B.forEach(h=>{h.lote_fiv_acasalamento_id&&le.set(h.lote_fiv_acasalamento_id,(le.get(h.lote_fiv_acasalamento_id)||0)+1)});const X=(D||[]).map(h=>{const pe=d.get(h.aspiracao_doadora_id),ae=pe?F.get(pe.doadora_id):void 0,fe=P.get(h.dose_semen_id),G=(fe==null?void 0:fe.touro)??null;return{...h,doadora_nome:(ae==null?void 0:ae.nome)||(ae==null?void 0:ae.registro),doadora_registro:ae==null?void 0:ae.registro,dose_nome:(G==null?void 0:G.nome)||"Touro desconhecido",viaveis:pe==null?void 0:pe.viaveis,total_embrioes_produzidos:le.get(h.id)||0}});Z(X),x({...f,pacote_nome:s.fazenda_id,pacote_data:s.data_aspiracao}),re(!0);const{data:ie,error:oe}=await m.from("aspiracoes_doadoras").select("id, doadora_id, viaveis").eq("pacote_aspiracao_id",f.pacote_aspiracao_id);if(!oe){const h=new Map;D==null||D.forEach(G=>{const xe=G.aspiracao_doadora_id,Ee=G.quantidade_oocitos||0;h.set(xe,(h.get(xe)||0)+Ee)});const ae=(ie||[]).filter(G=>{const xe=G.viaveis??0,Ee=h.get(G.id)||0,Ie=xe-Ee;return xe>0&&Ie>0}).map(G=>({...G,oocitos_disponiveis:(G.viaveis??0)-(h.get(G.id)||0)}));W(ae);const fe=[...new Set((ie==null?void 0:ie.map(G=>G.doadora_id))||[])];if(fe.length>0){const{data:G,error:xe}=await m.from("doadoras").select("id, nome, registro").in("id",fe);!xe&&G&&L(G)}}const{data:ce,error:be}=await m.from("doses_semen").select("id, touro_id, cliente_id, tipo_semen, quantidade, touro:touros(id, nome, registro, raca)").order("created_at",{ascending:!1});if(be)w([]);else try{const h=f==null?void 0:f.doses_selecionadas;h&&Array.isArray(h)&&h.length>0?w((ce||[]).filter(pe=>h.includes(pe.id))):w(ce||[])}catch{w(ce||[])}const{data:we,error:Se}=await m.from("clientes").select("id, nome").order("nome",{ascending:!0});Se||S(we||[]),await N(l)}catch(f){Ze(f,"Erro ao carregar detalhes do lote")}finally{U(!1)}},[g,N,i,L,S,U]);return{selectedLote:p,setSelectedLote:x,showLoteDetail:y,setShowLoteDetail:re,acasalamentos:b,setAcasalamentos:Z,fazendasDestinoIds:H,historicoDespachos:Y,setHistoricoDespachos:J,aspiracoesDisponiveis:te,dosesDisponiveis:ne,fazendaOrigemNome:q,fazendasDestinoNomes:M,dosesDisponiveisNoLote:ee,dataAspiracao:V,loadLoteDetail:u,loadHistoricoDespachos:N}}function Ga({filtroHistoricoDataInicio:i,filtroHistoricoDataFim:L,filtroHistoricoFazenda:S,setHistoricoPage:U}){const{toast:g}=ye(),[p,x]=r.useState([]),[y,re]=r.useState(!1),[b,Z]=r.useState(null),[H,K]=r.useState(null),[Y,J]=r.useState(!1),te=r.useCallback(async()=>{try{re(!0),U(1);let w=m.from("lotes_fiv").select("*").eq("status","FECHADO");i&&(w=w.gte("data_abertura",i)),L&&(w=w.lte("data_abertura",L));const{data:q,error:I}=await w.order("data_abertura",{ascending:!1});if(I)throw I;if(!q||q.length===0){x([]),re(!1);return}const M=q.map(a=>a.id),R=[...new Set(q.map(a=>a.pacote_aspiracao_id).filter(Boolean))],{data:ee}=await m.from("pacotes_aspiracao").select("id, data_aspiracao, fazenda_id, total_oocitos").in("id",R),{data:T}=await m.from("fazendas").select("id, nome").order("nome",{ascending:!0}),V=new Map((T==null?void 0:T.map(a=>[a.id,a.nome]))||[]),Q=(T==null?void 0:T.map(a=>({id:a.id,nome:a.nome})))||[],{data:N}=await m.from("lote_fiv_acasalamentos").select("id, lote_fiv_id, quantidade_embrioes, aspiracao_doadora_id").in("lote_fiv_id",M),{data:u,error:l}=await m.from("embrioes").select("id, lote_fiv_id, lote_fiv_acasalamento_id, classificacao, status_atual").in("lote_fiv_id",M);l&&g({title:"Erro ao buscar embri√µes",description:l.message,variant:"destructive"});const{data:f}=await m.from("lote_fiv_fazendas_destino").select("lote_fiv_id, fazenda_id").in("lote_fiv_id",M),o=[...new Set((N==null?void 0:N.map(a=>a.aspiracao_doadora_id).filter(Boolean))||[])],{data:s}=await m.from("aspiracoes_doadoras").select("id, viaveis").in("id",o),c=new Map((ee==null?void 0:ee.map(a=>[a.id,a]))||[]),v=new Map,_=new Map,A=new Map,k=new Map((s==null?void 0:s.map(a=>[a.id,a]))||[]);N==null||N.forEach(a=>{v.has(a.lote_fiv_id)||v.set(a.lote_fiv_id,[]),v.get(a.lote_fiv_id).push(a)}),u&&u.length>0&&u.forEach(a=>{a.lote_fiv_id&&(_.has(a.lote_fiv_id)||_.set(a.lote_fiv_id,[]),_.get(a.lote_fiv_id).push(a))}),f==null||f.forEach(a=>{A.has(a.lote_fiv_id)||A.set(a.lote_fiv_id,[]);const n=V.get(a.fazenda_id);n&&A.get(a.lote_fiv_id).push(n)});let D=q.map(a=>{const n=c.get(a.pacote_aspiracao_id),j=v.get(a.id)||[],O=_.get(a.id)||[],se=A.get(a.id)||[],de=O.length,he=O.filter(P=>P.status_atual==="TRANSFERIDO").length,t=O.filter(P=>P.status_atual==="CONGELADO").length,z=O.filter(P=>P.status_atual==="DESCARTADO").length,E={};O.forEach(P=>{P.classificacao?E[P.classificacao]=(E[P.classificacao]||0)+1:E.sem_classificacao=(E.sem_classificacao||0)+1});let F=0;return j.forEach(P=>{if(P.aspiracao_doadora_id){const d=k.get(P.aspiracao_doadora_id);d!=null&&d.viaveis&&(F+=d.viaveis)}}),{id:a.id,data_abertura:a.data_abertura,status:a.status,observacoes:a.observacoes,pacote_aspiracao_id:a.pacote_aspiracao_id,pacote_data:n==null?void 0:n.data_aspiracao,pacote_nome:V.get((n==null?void 0:n.fazenda_id)||""),fazenda_origem_nome:V.get((n==null?void 0:n.fazenda_id)||""),fazendas_destino_nomes:se,quantidade_acasalamentos:j.length,total_embrioes_produzidos:de,total_embrioes_transferidos:he,total_embrioes_congelados:t,total_embrioes_descartados:z,embrioes_por_classificacao:{BE:E.BE,BN:E.BN,BX:E.BX,BL:E.BL,BI:E.BI,sem_classificacao:E.sem_classificacao},total_oocitos:n==null?void 0:n.total_oocitos,total_viaveis:F>0?F:void 0}});if(S){const a=Q.find(n=>n.id===S);a&&(D=D.filter(n=>n.fazenda_origem_nome===a.nome))}x(D)}catch(w){Ze(w,"Erro ao carregar hist√≥rico")}finally{re(!1)}},[i,L,S,U,g]),W=r.useCallback(async w=>{try{J(!0);const q=p.find(o=>o.id===w);if(!q){g({title:"Erro",description:"Lote n√£o encontrado",variant:"destructive"});return}const{data:I}=await m.from("pacotes_aspiracao").select("*").eq("id",q.pacote_aspiracao_id).single(),{data:M}=await m.from("lote_fiv_acasalamentos").select("*").eq("lote_fiv_id",w).order("created_at",{ascending:!0}),{data:R}=await m.from("embrioes").select("*").eq("lote_fiv_id",w).order("created_at",{ascending:!0}),ee=[...new Set((M==null?void 0:M.map(o=>o.aspiracao_doadora_id).filter(Boolean))||[])],{data:T}=await m.from("aspiracoes_doadoras").select("*, doadora:doadoras(id, registro, nome)").in("id",ee),V=[...new Set((M==null?void 0:M.map(o=>o.dose_semen_id).filter(Boolean))||[])],{data:Q}=await m.from("doses_semen").select("*, cliente:clientes(nome), touro:touros(id, nome, registro, raca)").in("id",V),N=new Map((T==null?void 0:T.map(o=>[o.id,o]))||[]),u=new Map((Q==null?void 0:Q.map(o=>[o.id,o]))||[]),l=new Map;(R||[]).forEach(o=>{const s=o.lote_fiv_acasalamento_id||"sem_acasalamento";l.has(s)||l.set(s,{total:0,porStatus:{},porClassificacao:{}});const c=l.get(s);c.total++;const v=o.status_atual||"sem_status";c.porStatus[v]=(c.porStatus[v]||0)+1;const _=o.classificacao||"sem_classificacao";c.porClassificacao[_]=(c.porClassificacao[_]||0)+1});const f={lote:q,pacote:I?{id:I.id,data_aspiracao:I.data_aspiracao,horario_inicio:I.horario_inicio,horario_final:I.horario_final,veterinario_responsavel:I.veterinario_responsavel,tecnico_responsavel:I.tecnico_responsavel,total_oocitos:I.total_oocitos,observacoes:I.observacoes}:void 0,acasalamentos:(M||[]).map(o=>{var A,k,D,a;const s=o.aspiracao_doadora_id?N.get(o.aspiracao_doadora_id):null,c=o.dose_semen_id?u.get(o.dose_semen_id):null,v=s==null?void 0:s.doadora,_=l.get(o.id)||{total:0,porStatus:{},porClassificacao:{}};return{id:o.id,aspiracao_id:o.aspiracao_doadora_id,doadora:v?{registro:v.registro,nome:v.nome}:void 0,aspiracao:s?{data_aspiracao:s.data_aspiracao,horario_aspiracao:s.horario_aspiracao,viaveis:s.viaveis,expandidos:s.expandidos,total_oocitos:s.total_oocitos,atresicos:s.atresicos,degenerados:s.degenerados,desnudos:s.desnudos,veterinario_responsavel:s.veterinario_responsavel}:void 0,dose_semen:c?{nome:((A=c.touro)==null?void 0:A.nome)||"Touro desconhecido",registro:(k=c.touro)==null?void 0:k.registro,raca:((D=c.touro)==null?void 0:D.raca)||c.raca,tipo_semen:c.tipo_semen,cliente:(a=c.cliente)==null?void 0:a.nome}:void 0,quantidade_fracionada:o.quantidade_fracionada,quantidade_oocitos:o.quantidade_oocitos,quantidade_embrioes:o.quantidade_embrioes,observacoes:o.observacoes,resumo_embrioes:_}}),embrioes:(R||[]).map(o=>({id:o.id,identificacao:o.identificacao,classificacao:o.classificacao,tipo_embriao:o.tipo_embriao,status_atual:o.status_atual,acasalamento_id:o.lote_fiv_acasalamento_id}))};K(f)}catch(q){Ze(q,"Erro ao carregar detalhes")}finally{J(!1)}},[p,g]),ne=r.useCallback(async w=>{b===w?(Z(null),K(null)):(Z(w),await W(w))},[b,W]);return{lotesHistoricos:p,loadingHistorico:y,loteExpandido:b,detalhesLoteExpandido:H,loadingDetalhes:Y,loadLotesHistoricos:te,handleExpandirLote:ne}}function Ya({id:i,filtroHistoricoDataInicio:L,filtroHistoricoDataFim:S,filtroHistoricoFazenda:U,setHistoricoPage:g}){const p=Za(),x=Qa({setFazendas:p.setFazendas,setDoadoras:p.setDoadoras,setClientes:p.setClientes,setLoading:p.setLoading}),y=Ga({filtroHistoricoDataInicio:L,filtroHistoricoDataFim:S,filtroHistoricoFazenda:U,setHistoricoPage:g});return r.useEffect(()=>{i?x.loadLoteDetail(i):p.loadData()},[i,p.loadData,x.loadLoteDetail]),{lotes:p.lotes,pacotes:p.pacotes,fazendas:p.fazendas,setFazendas:p.setFazendas,doadoras:p.doadoras,clientes:p.clientes,loading:p.loading,selectedLote:x.selectedLote,setSelectedLote:x.setSelectedLote,showLoteDetail:x.showLoteDetail,setShowLoteDetail:x.setShowLoteDetail,acasalamentos:x.acasalamentos,setAcasalamentos:x.setAcasalamentos,fazendasDestinoIds:x.fazendasDestinoIds,historicoDespachos:x.historicoDespachos,setHistoricoDespachos:x.setHistoricoDespachos,aspiracoesDisponiveis:x.aspiracoesDisponiveis,dosesDisponiveis:x.dosesDisponiveis,fazendaOrigemNome:x.fazendaOrigemNome,fazendasDestinoNomes:x.fazendasDestinoNomes,dosesDisponiveisNoLote:x.dosesDisponiveisNoLote,dataAspiracao:x.dataAspiracao,pacotesParaFiltro:p.pacotesParaFiltro,fazendasAspiracaoUnicas:p.fazendasAspiracaoUnicas,lotesHistoricos:y.lotesHistoricos,loadingHistorico:y.loadingHistorico,loteExpandido:y.loteExpandido,detalhesLoteExpandido:y.detalhesLoteExpandido,loadingDetalhes:y.loadingDetalhes,loadData:p.loadData,loadLoteDetail:x.loadLoteDetail,loadLotesHistoricos:y.loadLotesHistoricos,handleExpandirLote:y.handleExpandirLote}}function Ja({pacotes:i,clientes:L,fazendas:S}){var N;const U=ta(),{toast:g}=ye(),[p,x]=r.useState(!1),[y,re]=r.useState(!1),[b,Z]=r.useState({pacote_aspiracao_id:"",observacoes:"",doses_selecionadas:[]}),[H,K]=r.useState(null),[Y,J]=r.useState([]),[te,W]=r.useState([]),[ne,w]=r.useState([]),[q,I]=r.useState(!1),[M,R]=r.useState(""),ee=async u=>{Z({...b,pacote_aspiracao_id:u});const l=i.find(f=>f.id===u);if(K(l||null),l){const{data:f,error:o}=await m.from("aspiracoes_doadoras").select("id, doadora_id, viaveis").eq("pacote_aspiracao_id",u);if(o)return;W(f||[]);const s=[...new Set((f==null?void 0:f.map(_=>_.doadora_id))||[])];if(s.length>0){const{data:_,error:A}=await m.from("doadoras").select("id, nome, registro").in("id",s);if(A)return;w(_||[])}const{data:c,error:v}=await m.from("doses_semen").select("id, cliente_id, touro_id, tipo_semen, quantidade, touro:touros(id, nome, registro, raca)").order("created_at",{ascending:!1});if(v)return;J(c||[])}},T=async u=>{var l,f;if(u.preventDefault(),!b.pacote_aspiracao_id){g({title:"Erro de valida√ß√£o",description:"Pacote de aspira√ß√£o √© obrigat√≥rio",variant:"destructive"});return}if(!H){g({title:"Erro de valida√ß√£o",description:"Pacote selecionado n√£o encontrado",variant:"destructive"});return}try{re(!0);const{data:o,error:s}=await m.from("pacotes_aspiracao").select("id, status").eq("id",b.pacote_aspiracao_id).single();if(s||!o){g({title:"Erro de valida√ß√£o",description:"Pacote de aspira√ß√£o n√£o encontrado ou inv√°lido",variant:"destructive"});return}if(o.status!=="FINALIZADO"){g({title:"Erro de valida√ß√£o",description:"Apenas pacotes FINALIZADOS podem ser usados para criar lotes FIV",variant:"destructive"});return}const c=new Date(H.data_aspiracao);c.setDate(c.getDate()+1);const v=c.toISOString().split("T")[0],_={pacote_aspiracao_id:b.pacote_aspiracao_id,data_abertura:v,data_fecundacao:v,status:"ABERTO",observacoes:b.observacoes||null};if(b.doses_selecionadas&&b.doses_selecionadas.length>0)try{_.doses_selecionadas=b.doses_selecionadas}catch{}let A;const{data:k,error:D}=await m.from("lotes_fiv").insert([_]).select().single();if(D)if((l=D.message)!=null&&l.includes("doses_selecionadas")||D.code==="42703"){delete _.doses_selecionadas;const{data:n,error:j}=await m.from("lotes_fiv").insert([_]).select().single();if(j)throw j;A=n}else throw D;else A=k;const a=(f=H.fazendas_destino_nomes)==null?void 0:f.map(n=>{const j=S.find(O=>O.nome===n);return j==null?void 0:j.id}).filter(n=>!!n);if(a&&a.length>0){const{error:n}=await m.from("lote_fiv_fazendas_destino").insert(a.map(j=>({lote_fiv_id:A.id,fazenda_id:j})));if(n)throw n}try{await m.from("pacotes_aspiracao").update({usado_em_lote_fiv:!0}).eq("id",b.pacote_aspiracao_id)}catch{}g({title:"Lote FIV criado",description:"Lote FIV criado com sucesso. Agora voc√™ pode adicionar acasalamentos."}),x(!1),V(),U(`/lotes-fiv/${A.id}`)}catch(o){const s=o instanceof Error?o.message:"Erro desconhecido";g({title:"Erro ao criar lote",description:s.includes("RLS")||s.includes("policy")?"RLS est√° bloqueando escrita. Configure pol√≠ticas anon no Supabase.":s,variant:"destructive"})}finally{re(!1)}},V=()=>{Z({pacote_aspiracao_id:"",observacoes:"",doses_selecionadas:[]}),K(null),W([]),w([]),J([]),R("")},Q=()=>{x(!1),V()};return e.jsxs(We,{open:p,onOpenChange:x,children:[e.jsx(Sa,{asChild:!0,children:e.jsxs(_e,{children:[e.jsx(ma,{className:"w-4 h-4 mr-2"}),"Novo Lote"]})}),e.jsxs(ea,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(aa,{children:[e.jsx(sa,{children:"Criar Novo Lote FIV"}),e.jsx(oa,{children:"Selecione um pacote de aspira√ß√£o FINALIZADO para criar o lote"})]}),e.jsxs("form",{onSubmit:T,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ge,{htmlFor:"pacote_aspiracao_id",children:"Pacote de Aspira√ß√£o *"}),i.length===0?e.jsxs("div",{className:"border rounded-lg p-4 bg-yellow-50 border-yellow-200",children:[e.jsx("p",{className:"text-sm text-yellow-800 font-medium mb-2",children:"Nenhum pacote dispon√≠vel"}),e.jsxs("p",{className:"text-sm text-yellow-700",children:["Verifique se o pacote de aspira√ß√£o est√° com status ",e.jsx("strong",{children:"FINALIZADO"})," e ainda n√£o foi usado para criar um lote FIV."]})]}):e.jsxs($e,{value:b.pacote_aspiracao_id,onValueChange:ee,children:[e.jsx(He,{children:e.jsx(ke,{placeholder:"Selecione o pacote"})}),e.jsx(Re,{children:i.map(u=>e.jsxs(Ve,{value:u.id,children:[De(u.data_aspiracao)," - ",u.fazenda_nome," (",u.quantidade_doadoras," doadoras)"]},u.id))})]}),H&&e.jsxs("div",{className:"text-sm text-slate-600 space-y-1 mt-2 p-3 bg-slate-50 rounded-lg",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Data do Pacote:"})," ",De(H.data_aspiracao)]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Data de Fecunda√ß√£o do Lote:"})," ",(()=>{const u=new Date(H.data_aspiracao);return u.setDate(u.getDate()+1),De(u.toISOString().split("T")[0])})()]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Fazendas Destino:"})," ",((N=H.fazendas_destino_nomes)==null?void 0:N.join(", "))||"Nenhuma"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Quantidade de Doadoras:"})," ",H.quantidade_doadoras||0]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ge,{children:"Doses de S√™men Dispon√≠veis no Lote"}),Y.length===0?e.jsx("div",{className:"border rounded-lg p-4 bg-slate-50",children:e.jsx("p",{className:"text-sm text-slate-500",children:H?"Carregando doses...":"Selecione um pacote primeiro"})}):e.jsxs(e.Fragment,{children:[(()=>{const u=Y.reduce((s,c)=>{const v=c.touro_id||"sem-touro";return s[v]||(s[v]=[]),s[v].push(c),s},{}),l=Object.entries(u).map(([s,c])=>{var v,_;return{id:s,nome:((v=c[0].touro)==null?void 0:v.nome)||"Touro desconhecido",registro:(_=c[0].touro)==null?void 0:_.registro,doses:c}}),f=l.find(s=>s.id===M),o=(f==null?void 0:f.doses)||[];return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"1. Buscar touro"}),e.jsxs(La,{open:q,onOpenChange:I,children:[e.jsx(qa,{asChild:!0,children:e.jsxs(_e,{variant:"outline",role:"combobox","aria-expanded":q,className:"w-full justify-between font-normal",children:[f?e.jsxs("span",{className:"truncate",children:[f.nome,f.registro&&` (${f.registro})`]}):e.jsx("span",{className:"text-muted-foreground",children:"Buscar touro por nome ou registro..."}),e.jsx(Ha,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(Ia,{className:"w-[400px] p-0",align:"start",children:e.jsxs(Ea,{children:[e.jsx(za,{placeholder:"Buscar touro por nome ou registro..."}),e.jsxs(Fa,{children:[e.jsx(Ca,{children:"Nenhum touro encontrado."}),e.jsx(ya,{children:l.map(s=>e.jsxs(Aa,{value:`${s.nome} ${s.registro||""}`,onSelect:()=>{R(s.id),I(!1)},children:[e.jsx(Pa,{className:ga("mr-2 h-4 w-4",M===s.id?"opacity-100":"opacity-0")}),e.jsxs("span",{className:"truncate",children:[s.nome,s.registro&&e.jsxs("span",{className:"text-muted-foreground ml-1",children:["(",s.registro,")"]})]}),e.jsxs("span",{className:"ml-auto text-xs text-muted-foreground",children:[s.doses.length," ",s.doses.length===1?"dono":"donos"]})]},s.id))})]})]})})]})]}),M&&o.length>0&&e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"2. Selecionar donos para adicionar"}),e.jsx("div",{className:"border rounded-lg p-3 bg-slate-50 space-y-2",children:o.map(s=>{const c=L.find(_=>_.id===s.cliente_id),v=b.doses_selecionadas.includes(s.id);return e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:`dose-${s.id}`,checked:v,onChange:_=>{_.target.checked?Z({...b,doses_selecionadas:[...b.doses_selecionadas,s.id]}):Z({...b,doses_selecionadas:b.doses_selecionadas.filter(A=>A!==s.id)})},className:"rounded"}),e.jsx("label",{htmlFor:`dose-${s.id}`,className:"text-sm cursor-pointer flex-1",children:(c==null?void 0:c.nome)||"Sem cliente"})]},s.id)})})]})]})})(),b.doses_selecionadas.length>0&&e.jsxs("div",{className:"space-y-1.5 mt-4",children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Doses selecionadas (",b.doses_selecionadas.length,")"]}),e.jsx("div",{className:"border rounded-lg p-3 bg-green-50 border-green-200 space-y-1.5 max-h-40 overflow-y-auto",children:b.doses_selecionadas.map(u=>{var o,s;const l=Y.find(c=>c.id===u),f=l?L.find(c=>c.id===l.cliente_id):null;return l?e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("span",{children:[e.jsx("span",{className:"font-medium",children:((o=l.touro)==null?void 0:o.nome)||"Touro"}),((s=l.touro)==null?void 0:s.registro)&&e.jsxs("span",{className:"text-slate-500 ml-1",children:["(",l.touro.registro,")"]}),e.jsxs("span",{className:"text-slate-500 ml-1",children:["- ",(f==null?void 0:f.nome)||"Sem cliente"]})]}),e.jsx("button",{type:"button",onClick:()=>{Z({...b,doses_selecionadas:b.doses_selecionadas.filter(c=>c!==u)})},className:"text-red-500 hover:text-red-700 p-1",children:e.jsx(Ye,{className:"w-4 h-4"})})]},u):null})})]})]}),e.jsx("p",{className:"text-xs text-slate-500",children:"Busque o touro e selecione de quais donos as doses estar√£o dispon√≠veis neste lote"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ge,{htmlFor:"observacoes",children:"Observa√ß√µes"}),e.jsx(la,{id:"observacoes",value:b.observacoes,onChange:u=>Z({...b,observacoes:u.target.value}),placeholder:"Observa√ß√µes sobre o lote",rows:3})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(_e,{type:"submit",className:"flex-1",disabled:y,children:y?"Criando...":"Criar Lote"}),e.jsx(_e,{type:"button",variant:"outline",onClick:Q,disabled:y,children:"Cancelar"})]})]})]})]})}function ze(i){return{[-1]:"Aspira√ß√£o",0:"Fecunda√ß√£o",1:"Zigoto",2:"2 C√©lulas",3:"4 C√©lulas",4:"8 C√©lulas",5:"M√≥rula",6:"Blastocisto",7:"Blastocisto Expandido",8:"Blastocisto Expandido"}[i]||`D${i}`}function Xa({lote:i,acasalamentos:L,aspiracoesDisponiveis:S,dosesDisponiveis:U,dosesDisponiveisNoLote:g,doadoras:p,clientes:x,historicoDespachos:y,dataAspiracao:re,fazendaOrigemNome:b,fazendasDestinoNomes:Z,submitting:H,onBack:K,onAddAcasalamento:Y,onDespacharEmbrioes:J,onUpdateQuantidadeEmbrioes:te,editQuantidadeEmbrioes:W,onUpdateClivados:ne,editClivados:w={}}){var D;const q=ta(),{toast:I}=ye(),[M,R]=r.useState(!1),[ee,T]=r.useState(!1),[V,Q]=r.useState(""),[N,u]=r.useState({aspiracao_doadora_id:"",dose_semen_id:"",quantidade_fracionada:"1.0",quantidade_oocitos:"",observacoes:""});let l=Ce(re||i.pacote_data||null);if(!l){const a=Ce(i.data_abertura);if(a){const[n,j,O]=a.split("-").map(Number),se=new Date(n,j-1,O);se.setDate(se.getDate()-1),l=`${se.getFullYear()}-${String(se.getMonth()+1).padStart(2,"0")}-${String(se.getDate()).padStart(2,"0")}`}}if(!l)return e.jsx("div",{children:"Erro: Data de aspira√ß√£o n√£o encontrada"});const f=ia(),o=Math.max(0,ra(l,f)),s=Va(o),c=Na(l,8),v=De(c),_=Da(c),A=async a=>{if(a.preventDefault(),!N.aspiracao_doadora_id){I({title:"Erro de valida√ß√£o",description:"Doadora √© obrigat√≥ria",variant:"destructive"});return}if(!N.dose_semen_id){I({title:"Erro de valida√ß√£o",description:"Selecione uma dose de s√™men",variant:"destructive"});return}if((parseFloat(N.quantidade_fracionada)||0)<=0){I({title:"Erro de valida√ß√£o",description:"Quantidade fracionada deve ser maior que zero",variant:"destructive"});return}try{await Y(N),R(!1),u({aspiracao_doadora_id:"",dose_semen_id:"",quantidade_fracionada:"1.0",quantidade_oocitos:"",observacoes:""}),Q("")}catch{}},k=()=>{K(),q("/lotes-fiv")};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(_e,{variant:"ghost",size:"sm",onClick:k,children:e.jsx(Oa,{className:"w-4 h-4"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-slate-900",children:"Detalhes do Lote FIV"}),e.jsxs("div",{className:"text-slate-600 mt-1 flex items-center gap-2",children:[e.jsxs("span",{children:["Data de fecunda√ß√£o (D0): ",De(i.data_abertura)," |",l&&` Data aspira√ß√£o (D-1): ${De(l)} |`,s===-1?` D-1 - ${ze(s)} |`:` D${s} - ${ze(s)} |`," ","Status:"]}),e.jsx(Ue,{variant:i.status==="FECHADO"?"default":"secondary",children:i.status})]})]})]}),e.jsxs(Oe,{children:[e.jsx(Be,{children:e.jsx(Me,{children:"Informa√ß√µes do Lote"})}),e.jsxs(Te,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(ge,{children:"Dia Atual"}),e.jsx("p",{className:"text-2xl font-bold",children:s===-1?e.jsxs(e.Fragment,{children:["D-1 ",e.jsxs("span",{className:"text-lg font-normal text-slate-600",children:["- ",ze(s)]})]}):e.jsxs(e.Fragment,{children:["D",s," ",e.jsxs("span",{className:"text-lg font-normal text-slate-600",children:["- ",ze(s)]})]})})]}),e.jsxs("div",{children:[e.jsx(ge,{children:"Data da TE"}),o<7?e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-orange-600",children:v}),e.jsx("p",{className:"text-sm text-slate-500",children:_})]}):e.jsx("p",{className:"text-2xl font-bold text-green-600",children:"Hoje ou passou"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(ge,{children:"Fazenda de Origem"}),e.jsx("p",{className:"font-medium",children:b||i.pacote_nome||"-"})]}),e.jsxs("div",{children:[e.jsx(ge,{children:"Fazendas de Destino"}),e.jsx("p",{className:"font-medium",children:Z.length>0?Z.join(", "):((D=i.fazendas_destino_nomes)==null?void 0:D.join(", "))||"-"})]})]}),i.observacoes&&e.jsxs("div",{children:[e.jsx(ge,{children:"Observa√ß√µes"}),e.jsx("p",{className:"text-slate-600",children:i.observacoes})]}),i.status==="ABERTO"&&o===7&&e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"text-blue-800 font-medium",children:["üìä Este lote est√° no D6 (",ze(6),"). Voc√™ pode preencher a quantidade de embri√µes (pr√©via) e gerar um relat√≥rio."]}),e.jsxs(_e,{variant:"outline",size:"sm",onClick:()=>T(!0),children:[e.jsx(Ba,{className:"w-4 h-4 mr-2"}),"Gerar Relat√≥rio de Pr√©via"]})]})}),(i.status==="ABERTO"&&(o===8||o===9)||i.status==="FECHADO"&&o===9)&&e.jsx("div",{className:"bg-orange-50 border border-orange-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"text-orange-800 font-medium",children:["‚ö†Ô∏è Este lote est√° no ",o===8?"D7":"D8"," (",ze(o===8?7:8),"). ",o===8?"Informe a quantidade de embri√µes para cada acasalamento e despache os embri√µes.":"Per√≠odo de emerg√™ncia (D8). Voc√™ pode adicionar novos acasalamentos e despachar os embri√µes imediatamente."]}),e.jsxs(_e,{variant:"default",size:"sm",onClick:J,disabled:H,children:[e.jsx(na,{className:"w-4 h-4 mr-2"}),H?"Despachando...":"Despachar Todos os Embri√µes"]})]})})]})]}),e.jsxs(Oe,{children:[e.jsx(Be,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Me,{className:"flex items-center gap-2",children:[e.jsx(da,{className:"w-5 h-5"}),"Acasalamentos (",L.length,")"]}),i.status==="ABERTO"&&e.jsxs(_e,{size:"sm",onClick:()=>R(!0),children:[e.jsx(ma,{className:"w-4 h-4 mr-2"}),"Adicionar Acasalamento"]})]})}),e.jsx(Te,{children:L.length===0?e.jsxs("div",{className:"text-center py-8 text-slate-500",children:[e.jsx(da,{className:"w-12 h-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"Nenhum acasalamento cadastrado"}),i.status==="ABERTO"&&e.jsx(_e,{variant:"outline",size:"sm",className:"mt-2",onClick:()=>R(!0),children:"Adicionar primeiro acasalamento"})]}):e.jsxs(Je,{children:[e.jsx(Xe,{children:e.jsxs(Fe,{children:[e.jsx(me,{children:"Doadora"}),e.jsx(me,{children:"Touro"}),e.jsx(me,{className:"text-center",children:"O√≥citos"}),e.jsx(me,{className:"text-center",children:"D3 Clivados"}),e.jsx(me,{className:"text-center",children:"Qtd. Embri√µes"}),e.jsx(me,{className:"text-center",children:"%"}),e.jsx(me,{children:"Observa√ß√µes"})]})}),e.jsx(Ke,{children:L.map(a=>{const n=a.quantidade_oocitos||a.viaveis||0,j=w[a.id],O=a.embrioes_clivados_d3,se=j!==void 0?j:(O==null?void 0:O.toString())??"",de=parseInt(se)||0,he=de>0?de:n,t=W[a.id]!==void 0?parseInt(W[a.id])||0:a.total_embrioes_produzidos||0,z=n>0?(t/n*100).toFixed(1):"0.0";return e.jsxs(Fe,{children:[e.jsx(ue,{children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:a.doadora_registro||"-"}),a.doadora_nome&&e.jsx("p",{className:"text-sm text-slate-500",children:a.doadora_nome})]})}),e.jsx(ue,{children:a.dose_nome||"-"}),e.jsx(ue,{className:"text-center",children:n}),e.jsx(ue,{className:"text-center",children:i.status==="ABERTO"&&s>=3&&ne?e.jsx(qe,{type:"number",min:"0",max:n,className:"w-20 text-center",value:se,onChange:E=>ne(a.id,E.target.value),placeholder:"-"}):e.jsx("span",{children:de>0?de:"-"})}),e.jsx(ue,{className:"text-center",children:i.status==="ABERTO"&&o>=7?e.jsx(qe,{type:"number",min:"0",max:he,className:"w-20 text-center",value:W[a.id]??a.total_embrioes_produzidos??"",onChange:E=>te(a.id,E.target.value),placeholder:"0"}):e.jsx("span",{children:t})}),e.jsx(ue,{className:"text-center",children:e.jsxs(Ue,{variant:parseFloat(z)>=30?"default":"secondary",children:[z,"%"]})}),e.jsx(ue,{className:"max-w-[200px] truncate",children:a.observacoes||"-"})]},a.id)})})]})})]}),y.length>0&&e.jsxs(Oe,{children:[e.jsx(Be,{children:e.jsxs(Me,{className:"flex items-center gap-2",children:[e.jsx(na,{className:"w-5 h-5"}),"Hist√≥rico de Despachos"]})}),e.jsx(Te,{children:e.jsx("div",{className:"space-y-4",children:y.map(a=>e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsxs("p",{className:"font-medium mb-2",children:["Despacho em ",De(a.data_despacho)]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2",children:a.acasalamentos.map((n,j)=>e.jsxs("div",{className:"text-sm bg-slate-50 rounded p-2",children:[e.jsx("span",{className:"font-medium",children:n.doadora}),e.jsxs("span",{className:"text-slate-500",children:[" x ",n.dose]}),e.jsxs("span",{className:"ml-2 text-green-600 font-medium",children:["(",n.quantidade,")"]})]},j))})]},a.id))})})]}),e.jsx(We,{open:M,onOpenChange:R,children:e.jsxs(ea,{className:"max-w-lg",children:[e.jsxs(aa,{children:[e.jsx(sa,{children:"Adicionar Acasalamento"}),e.jsx(oa,{children:"Selecione a doadora e a dose de s√™men para o acasalamento"})]}),e.jsxs("form",{onSubmit:A,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ge,{children:"Doadora *"}),e.jsxs($e,{value:N.aspiracao_doadora_id,onValueChange:a=>{u({...N,aspiracao_doadora_id:a});const n=S.find(j=>j.id===a);n&&u(j=>({...j,aspiracao_doadora_id:a,quantidade_oocitos:String(n.oocitos_disponiveis||n.viaveis||0)}))},children:[e.jsx(He,{children:e.jsx(ke,{placeholder:"Selecione a doadora"})}),e.jsx(Re,{children:S.map(a=>{const n=p.find(j=>j.id===a.doadora_id);return e.jsxs(Ve,{value:a.id,children:[(n==null?void 0:n.registro)||(n==null?void 0:n.nome)||"Doadora"," - ",a.oocitos_disponiveis??a.viaveis??0," o√≥citos dispon√≠veis"]},a.id)})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ge,{children:"Dose de S√™men *"}),e.jsxs($e,{value:N.dose_semen_id,onValueChange:a=>u({...N,dose_semen_id:a}),children:[e.jsx(He,{children:e.jsx(ke,{placeholder:"Selecione a dose"})}),e.jsx(Re,{children:(g.length>0?g:U).map(a=>{var j,O;const n=x.find(se=>se.id===a.cliente_id);return e.jsxs(Ve,{value:a.id,children:[((j=a.touro)==null?void 0:j.nome)||"Touro desconhecido",((O=a.touro)==null?void 0:O.registro)&&` (${a.touro.registro})`,n&&` - ${n.nome}`]},a.id)})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ge,{children:"Qtd. Fracionada"}),e.jsx(qe,{type:"number",step:"0.1",min:"0",value:N.quantidade_fracionada,onChange:a=>u({...N,quantidade_fracionada:a.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ge,{children:"Qtd. O√≥citos"}),e.jsx(qe,{type:"number",min:"0",value:N.quantidade_oocitos,onChange:a=>u({...N,quantidade_oocitos:a.target.value}),placeholder:"Auto"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ge,{children:"Observa√ß√µes"}),e.jsx(la,{value:N.observacoes,onChange:a=>u({...N,observacoes:a.target.value}),placeholder:"Observa√ß√µes sobre o acasalamento",rows:2})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(_e,{type:"submit",className:"flex-1",disabled:H,children:H?"Adicionando...":"Adicionar"}),e.jsx(_e,{type:"button",variant:"outline",onClick:()=>{R(!1),u({aspiracao_doadora_id:"",dose_semen_id:"",quantidade_fracionada:"1.0",quantidade_oocitos:"",observacoes:""})},children:"Cancelar"})]})]})]})}),e.jsx(We,{open:ee,onOpenChange:T,children:e.jsxs(ea,{className:"max-w-2xl",children:[e.jsxs(aa,{children:[e.jsx(sa,{children:"Relat√≥rio de Pr√©via - D6"}),e.jsx(oa,{children:"Resumo dos acasalamentos e embri√µes previstos"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"border rounded-lg p-4 bg-slate-50",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Informa√ß√µes do Lote"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-slate-500",children:"Fazenda Origem:"})," ",b||i.pacote_nome]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-slate-500",children:"Fazendas Destino:"})," ",Z.join(", ")||"-"]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-slate-500",children:"Data TE prevista:"})," ",v]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-slate-500",children:"Total Acasalamentos:"})," ",L.length]})]})]}),e.jsxs(Je,{children:[e.jsx(Xe,{children:e.jsxs(Fe,{children:[e.jsx(me,{children:"Doadora"}),e.jsx(me,{children:"Touro"}),e.jsx(me,{className:"text-center",children:"O√≥citos"}),e.jsx(me,{className:"text-center",children:"Embri√µes (prev.)"})]})}),e.jsx(Ke,{children:L.map(a=>e.jsxs(Fe,{children:[e.jsx(ue,{children:a.doadora_registro||"-"}),e.jsx(ue,{children:a.dose_nome||"-"}),e.jsx(ue,{className:"text-center",children:a.quantidade_oocitos||a.viaveis||0}),e.jsx(ue,{className:"text-center",children:W[a.id]??a.total_embrioes_produzidos??"-"})]},a.id))})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(_e,{onClick:()=>T(!1),children:"Fechar"})})]})]})})]})}function zs(){const{id:i}=va(),L=ta(),{toast:S}=ye(),[U,g]=r.useState(!1),[p,x]=r.useState({}),[y,re]=r.useState({}),[b,Z]=r.useState(()=>pa().historicoPage??1),H=r.useCallback(d=>{Z(d)},[]),{filtroFazendaAspiracao:K,setFiltroFazendaAspiracao:Y,filtroFazendaAspiracaoBusca:J,setFiltroFazendaAspiracaoBusca:te,filtroDiaCultivo:W,setFiltroDiaCultivo:ne,showFazendaBusca:w,setShowFazendaBusca:q,filtroHistoricoDataInicio:I,filtroHistoricoDataFim:M,filtroHistoricoFazenda:R}=Ua({lotes:[],pacotesParaFiltro:[],fazendasAspiracaoUnicas:[],lotesHistoricos:[]}),{lotes:ee,pacotes:T,fazendas:V,doadoras:Q,clientes:N,loading:u,selectedLote:l,setSelectedLote:f,showLoteDetail:o,setShowLoteDetail:s,acasalamentos:c,fazendasDestinoIds:v,historicoDespachos:_,setHistoricoDespachos:A,aspiracoesDisponiveis:k,dosesDisponiveis:D,fazendaOrigemNome:a,fazendasDestinoNomes:n,dosesDisponiveisNoLote:j,dataAspiracao:O,pacotesParaFiltro:se,fazendasAspiracaoUnicas:de,loadLoteDetail:he}=Ya({id:i,filtroHistoricoDataInicio:I,filtroHistoricoDataFim:M,filtroHistoricoFazenda:R,setHistoricoPage:H}),t=Ka(ee,se,K,W),z=Wa(de,J),E=r.useCallback(()=>{Y(""),te(""),ne(""),q(!1)},[Y,te,ne,q]),F=async()=>{var d,B;if(l)try{g(!0);const $=T.find(C=>C.id===l.pacote_aspiracao_id);let le=Ce(($==null?void 0:$.data_aspiracao)||null);if(!le){const C=Ce(l.data_abertura);if(C){const[ve,Ne,Ae]=C.split("-").map(Number),je=new Date(ve,Ne-1,Ae);je.setDate(je.getDate()-1);const Le=je.getFullYear(),Pe=String(je.getMonth()+1).padStart(2,"0"),Qe=String(je.getDate()).padStart(2,"0");le=`${Le}-${Pe}-${Qe}`}}const X=ia();if((le?Math.max(0,ra(le,X)):0)>9){S({title:"Prazo expirado",description:"D8 √© o √∫ltimo dia. N√£o √© poss√≠vel criar embri√µes ap√≥s o D8. O lote ser√° fechado e n√£o aparecer√° mais na lista.",variant:"destructive"}),g(!1);return}const oe=c.filter(C=>{var Ne;return parseInt(p[C.id]||((Ne=C.quantidade_embrioes)==null?void 0:Ne.toString())||"0")>0});if(oe.length===0){S({title:"Nenhum embri√£o para despachar",description:"Preencha a quantidade de embri√µes em pelo menos um acasalamento antes de despachar.",variant:"destructive"});return}for(const C of oe){const ve=parseInt(p[C.id]||((d=C.quantidade_embrioes)==null?void 0:d.toString())||"0"),Ne=C.quantidade_oocitos??0,Ae=y[C.id],je=C.embrioes_clivados_d3,Le=parseInt(Ae??(je==null?void 0:je.toString())??"")||0,Pe=Le>0?Le:Ne;if(ve>Pe){const Qe=C.doadora_nome||C.doadora_registro||"Doadora desconhecida",ha=Le>0?"clivados (D3)":"o√≥citos";S({title:"Valida√ß√£o de quantidade",description:`O acasalamento da doadora "${Qe}" possui ${ve} embri√µes, mas o limite de ${ha} √© ${Pe}. A quantidade de embri√µes n√£o pode exceder esse limite.`,variant:"destructive"});return}}const ce=`${a} - ${n.join(", ")}`,be=new Date().toISOString().split("T")[0];if(!v.length){S({title:"Erro ao despachar",description:"√â necess√°rio ter pelo menos uma fazenda destino configurada no lote.",variant:"destructive"});return}let we="EMB";const Se=le||"",h=Se.slice(8,10)+Se.slice(5,7);if($!=null&&$.fazenda_id){const{data:C,error:ve}=await m.from("fazendas").select("sigla, nome").eq("id",$.fazenda_id).single();!ve&&C&&(C.sigla?we=C.sigla:C.nome&&(we=C.nome.replace(/[^a-zA-Z]/g,"").substring(0,3).toUpperCase()||"EMB"))}const pe=`${we}-${h}`;let ae=1;const{count:fe,error:G}=await m.from("embrioes").select("*",{count:"exact",head:!0}).like("identificacao",`${pe}-%`);!G&&fe!==null&&(ae=fe+1);const xe=[],Ee=[];let Ie=0;for(const C of oe){const ve=parseInt(p[C.id]||((B=C.quantidade_embrioes)==null?void 0:B.toString())||"0");if(ve>0){for(let Ne=0;Ne<ve;Ne++){const Ae=String(ae+Ie).padStart(3,"0"),je={lote_fiv_id:l.id,lote_fiv_acasalamento_id:C.id,status_atual:"FRESCO",identificacao:`${pe}-${Ae}`};xe.push(je),Ie++}Ee.push({acasalamento_id:C.id,quantidade:ve,doadora:C.doadora_registro||C.doadora_nome,dose:C.dose_nome})}}if(xe.length>0){const{error:C}=await m.from("embrioes").insert(xe);if(C)throw C}const fa={id:`${l.id}-${be}`,data_despacho:be,acasalamentos:Ee};A([fa,..._]);const _a=oe.map(C=>m.from("lote_fiv_acasalamentos").update({quantidade_embrioes:null}).eq("id",C.id));await Promise.all(_a),x({}),S({title:"Embri√µes despachados",description:`${xe.length} embri√£o(√µes) foram despachados para ${ce}.`}),he(l.id)}catch($){S({title:"Erro ao despachar embri√µes",description:$ instanceof Error?$.message:"Erro desconhecido",variant:"destructive"})}finally{g(!1)}},P=async d=>{var $,le;if(!l)return;const B=parseFloat(d.quantidade_fracionada)||0;try{g(!0);const X=k.find(fe=>fe.id===d.aspiracao_doadora_id),ie=(X==null?void 0:X.oocitos_disponiveis)??0,oe=parseInt(d.quantidade_oocitos)||0;if(oe>ie)throw S({title:"Erro de valida√ß√£o",description:`A quantidade de o√≥citos (${oe}) n√£o pode ser maior que os o√≥citos dispon√≠veis (${ie})`,variant:"destructive"}),new Error("Valida√ß√£o falhou");const{data:ce,error:be}=await m.from("doses_semen").select("id, quantidade").eq("id",d.dose_semen_id).single();if(be)throw be;const we=(ce==null?void 0:ce.quantidade)??0;if(we<B)throw S({title:"Estoque insuficiente",description:`Quantidade dispon√≠vel (${we}) √© menor que a quantidade fracionada (${B}).`,variant:"destructive"}),new Error("Estoque insuficiente");const Se={lote_fiv_id:l.id,aspiracao_doadora_id:d.aspiracao_doadora_id,dose_semen_id:d.dose_semen_id,quantidade_fracionada:B,quantidade_oocitos:oe>0?oe:null,observacoes:d.observacoes||null},{error:h}=await m.from("lote_fiv_acasalamentos").insert([Se]);if(h){if(h.code==="23505"||($=h.message)!=null&&$.includes("duplicate")||(le=h.message)!=null&&le.includes("unique")){S({title:"Acasalamento duplicado",description:"J√° existe um acasalamento com esta doadora e dose de s√™men neste lote. Edite o existente ou escolha outra combina√ß√£o.",variant:"destructive"});return}throw h}const pe=we-B,{error:ae}=await m.from("doses_semen").update({quantidade:pe}).eq("id",(ce==null?void 0:ce.id)||"");if(ae)throw ae;S({title:"Acasalamento adicionado",description:"Acasalamento adicionado com sucesso"}),await he(l.id)}catch(X){const ie=X instanceof Error?X.message:"Erro desconhecido";throw!ie.includes("Valida√ß√£o")&&!ie.includes("Estoque")&&S({title:"Erro ao adicionar acasalamento",description:ie.includes("RLS")||ie.includes("policy")?"RLS est√° bloqueando escrita. Configure pol√≠ticas anon no Supabase.":ie,variant:"destructive"}),X}finally{g(!1)}};return u&&!l?e.jsx(ja,{}):l&&o?e.jsx(Xa,{lote:l,acasalamentos:c,aspiracoesDisponiveis:k,dosesDisponiveis:D,dosesDisponiveisNoLote:j,doadoras:Q,clientes:N,historicoDespachos:_,dataAspiracao:O,fazendaOrigemNome:a,fazendasDestinoNomes:n,submitting:U,onBack:()=>{s(!1),f(null)},onAddAcasalamento:P,onDespacharEmbrioes:F,onUpdateQuantidadeEmbrioes:(d,B)=>{x({...p,[d]:B})},editQuantidadeEmbrioes:p,onUpdateClivados:async(d,B)=>{re({...y,[d]:B});const $=parseInt(B)||null;await m.from("lote_fiv_acasalamentos").update({embrioes_clivados_d3:$}).eq("id",d)},editClivados:y}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(ba,{title:"Lotes FIV",description:"Gerenciar lotes de fecunda√ß√£o in vitro",actions:e.jsx(Ja,{pacotes:T,clientes:N,fazendas:V})}),e.jsx("div",{className:"rounded-xl border border-border bg-gradient-to-r from-card via-card to-muted/30 p-4 mb-4",children:e.jsxs("div",{className:"flex flex-wrap items-end gap-6",children:[e.jsxs("div",{className:"flex items-end gap-3",children:[e.jsx("div",{className:"w-1 h-6 rounded-full bg-primary/40 self-center"}),e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground self-center",children:[e.jsx(Ma,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:"Filtros"})]}),e.jsxs("div",{className:"flex-1 min-w-[220px] relative fazenda-busca-container",children:[e.jsx("label",{className:"text-[10px] font-medium text-muted-foreground mb-1 block uppercase tracking-wide",children:"Fazenda da Aspira√ß√£o"}),e.jsxs("div",{className:"relative",children:[e.jsx(qe,{id:"filtro-fazenda-aspira√ß√£o",placeholder:"Digite para buscar fazenda...",value:J,onChange:d=>{te(d.target.value),q(!0),d.target.value||Y("")},onFocus:()=>q(!0),className:"h-9"}),K&&e.jsx(_e,{variant:"ghost",size:"sm",className:"absolute right-1 top-1 h-7 w-7 p-0",onClick:()=>{Y(""),te(""),q(!1)},children:e.jsx(Ye,{className:"h-4 w-4"})}),w&&z.length>0&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-card border border-border rounded-lg shadow-lg max-h-60 overflow-auto",children:z.map(d=>e.jsx("div",{className:"px-4 py-2 hover:bg-muted cursor-pointer text-sm",onClick:()=>{Y(d.id),te(d.nome),q(!1)},children:d.nome},d.id))}),w&&J&&z.length===0&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-card border border-border rounded-lg shadow-lg p-4 text-sm text-muted-foreground",children:"Nenhuma fazenda encontrada"})]})]})]}),e.jsx("div",{className:"h-10 w-px bg-border hidden lg:block"}),e.jsxs("div",{className:"flex items-end gap-3",children:[e.jsx("div",{className:"w-1 h-6 rounded-full bg-emerald-500/40 self-center"}),e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground self-center",children:[e.jsx(Ta,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:"Cultivo"})]}),e.jsxs("div",{className:"w-[180px]",children:[e.jsx("label",{className:"text-[10px] font-medium text-muted-foreground mb-1 block uppercase tracking-wide",children:"Dia do Cultivo"}),e.jsxs($e,{value:W||void 0,onValueChange:d=>ne(d||""),children:[e.jsx(He,{id:"filtro-dia-cultivo",className:"h-9",children:e.jsx(ke,{placeholder:"Todos os dias"})}),e.jsx(Re,{children:[0,1,2,3,4,5,6,7,8].map(d=>e.jsxs(Ve,{value:d.toString(),children:["D",d," - ",Ge(d)]},d))})]})]})]}),e.jsx("div",{className:"h-10 w-px bg-border hidden lg:block"}),(K||W)&&e.jsx("div",{className:"flex items-end ml-auto",children:e.jsxs(_e,{variant:"outline",onClick:E,className:"h-9",children:[e.jsx(Ye,{className:"w-4 h-4 mr-2"}),"Limpar Filtros"]})})]})}),e.jsxs(Oe,{children:[e.jsx(Be,{children:e.jsx(Me,{children:"Lista de Lotes FIV"})}),e.jsx(Te,{children:t.length===0?e.jsx(wa,{title:ee.length===0?"Nenhum lote cadastrado":"Nenhum lote encontrado",description:ee.length===0?"Crie um novo lote para come√ßar.":"Ajuste os filtros para encontrar outros lotes."}):e.jsxs(Je,{children:[e.jsx(Xe,{children:e.jsxs(Fe,{children:[e.jsx(me,{children:"Aspira√ß√£o"}),e.jsx(me,{children:"Fazendas Destino"}),e.jsx(me,{children:"Dia do Cultivo"}),e.jsx(me,{children:"Acasalamentos"}),e.jsx(me,{className:"text-right",children:"A√ß√µes"})]})}),e.jsx(Ke,{children:t.map(d=>e.jsxs(Fe,{children:[e.jsxs(ue,{children:[d.pacote_data&&De(d.pacote_data)," - ",d.pacote_nome]}),e.jsx(ue,{children:e.jsx("div",{className:"flex flex-wrap gap-1",children:d.fazendas_destino_nomes&&d.fazendas_destino_nomes.length>0?d.fazendas_destino_nomes.map((B,$)=>e.jsx(Ue,{variant:"outline",className:"text-xs",children:B},$)):e.jsx("span",{className:"text-muted-foreground",children:"-"})})}),e.jsx(ue,{children:d.dia_atual!==void 0?e.jsx(Ue,{variant:"outline",className:`font-semibold ${ka(d.dia_atual===0?-1:d.dia_atual>9?8:d.dia_atual-1)}`,children:(()=>{const B=d.dia_atual===0?-1:d.dia_atual>9?8:d.dia_atual-1;return B===-1?`D-1 - ${Ge(B)}`:`D${B} - ${Ge(B)}`})()}):e.jsx("span",{className:"text-muted-foreground",children:"-"})}),e.jsx(ue,{children:d.quantidade_acasalamentos??0}),e.jsx(ue,{className:"text-right",children:e.jsx(_e,{variant:"ghost",size:"sm",onClick:()=>L(`/lotes-fiv/${d.id}`),children:e.jsx($a,{className:"w-4 h-4"})})})]},d.id))})]})})]})]})}function Ka(i,L,S,U){return r.useMemo(()=>{let g=[...i];if(g=g.filter(p=>p.status==="FECHADO"||p.dia_atual!==void 0&&p.dia_atual>9?!1:p.dia_atual!==void 0&&p.dia_atual<=9),S&&(g=g.filter(p=>{const x=L.find(y=>y.id===p.pacote_aspiracao_id);return(x==null?void 0:x.fazenda_id)===S})),U!==""){const p=parseInt(U);g=g.filter(x=>x.dia_atual===void 0||x.dia_atual===null?!1:(x.dia_atual===0?-1:x.dia_atual-1)===p)}return g},[i,S,U,L])}function Wa(i,L){return r.useMemo(()=>i.filter(S=>S.nome.toLowerCase().includes(L.toLowerCase())),[i,L])}export{zs as default};
