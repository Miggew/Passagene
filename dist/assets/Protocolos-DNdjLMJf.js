import{c as It,r as o,h as ia,j as e,P as Ke,l as zt,R as ee,i as Et,p as Rt,q as W,B as J,X as Ae,t as Dt,s as D,b as Ga,f as Na,d as kt}from"./index-B-7HRnm0.js";import{C as fe,a as Ie,b as ze,d as xe,c as Ca}from"./card-DdhhEbXV.js";import{I as le}from"./input-D2h8r4MO.js";import{T as qa}from"./textarea-RmDl789L.js";import{S as Ue,a as Be,b as Ze,c as Qe,d as Je}from"./select-B0M3FCy4.js";import{P as Tt,a as Ot,b as Ft}from"./popover-i4alam_g.js";import{C as Gt,a as qt,b as Mt,c as $t,d as Lt,e as Vt}from"./command-C3-lNK43.js";import{D as wa,f as ya,a as Pa,b as Sa,c as Aa,d as Ia}from"./dialog-CIXjHraQ.js";import{A as We,a as Ye,b as Xe,c as ea,d as aa,e as ta,f as oa,g as sa}from"./alert-dialog-CSZ8uCy0.js";import{B as Ee}from"./badge-BCHVCiM7.js";import{L as ge}from"./label-vBcRjcSu.js";import{T as Ht,c as za}from"./tabs-ChsREKvA.js";import{P as Ut}from"./PageHeader-CT7CFo0W.js";import{D as Ea}from"./DatePickerBR-XHkKTcYs.js";import{C as Ma,Q as $a}from"./QualidadeSemaforo-CErGLmdF.js";import{f as Bt,g as Zt}from"./StatusBadge-B48hPBgT.js";import{c as La,I as Qt,R as Jt}from"./index-C7yzDtsu.js";import{u as Kt}from"./index-B4eR1KA_.js";import{f as Ra,t as Va}from"./dateUtils-eJ5e6apA.js";import{C as Wt}from"./check-C6h7QFZL.js";import{v as Ha,a as Yt}from"./receptoraStatus-D9dFVedA.js";import{u as he}from"./use-toast-DDUqdzpY.js";import{h as Da}from"./error-handler-CBBt1r71.js";import{P as Xt}from"./plus-Cnek-_uY.js";import{U as Ua}from"./user-plus-BAzWkuBB.js";import{L as ka}from"./lock-Cgm1EcXF.js";import{C as eo}from"./circle-check-big-ybUp-L0y.js";import{S as ao}from"./search-DcAWDjHO.js";import"./chevron-right-DntnbvYp.js";import"./pt-BR-DS62bWKG.js";import"./differenceInCalendarDays-CrzntjZV.js";import"./calendar-D8momPux.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const to=It("ClipboardCheck",[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}],["path",{d:"m9 14 2 2 4-4",key:"df797q"}]]);var Ba="Toggle",na=o.forwardRef((a,r)=>{const{pressed:l,defaultPressed:d,onPressedChange:s,...n}=a,[g,u]=ia({prop:l,onChange:s,defaultProp:d??!1,caller:Ba});return e.jsx(Ke.button,{type:"button","aria-pressed":g,"data-state":g?"on":"off","data-disabled":a.disabled?"":void 0,...n,ref:r,onClick:zt(a.onClick,()=>{a.disabled||u(!g)})})});na.displayName=Ba;var Za=na,te="ToggleGroup",[Qa,as]=Et(te,[La]),Ja=La(),ca=ee.forwardRef((a,r)=>{const{type:l,...d}=a;if(l==="single"){const s=d;return e.jsx(oo,{...s,ref:r})}if(l==="multiple"){const s=d;return e.jsx(so,{...s,ref:r})}throw new Error(`Missing prop \`type\` expected on \`${te}\``)});ca.displayName=te;var[Ka,Wa]=Qa(te),oo=ee.forwardRef((a,r)=>{const{value:l,defaultValue:d,onValueChange:s=()=>{},...n}=a,[g,u]=ia({prop:l,defaultProp:d??"",onChange:s,caller:te});return e.jsx(Ka,{scope:a.__scopeToggleGroup,type:"single",value:ee.useMemo(()=>g?[g]:[],[g]),onItemActivate:u,onItemDeactivate:ee.useCallback(()=>u(""),[u]),children:e.jsx(Ya,{...n,ref:r})})}),so=ee.forwardRef((a,r)=>{const{value:l,defaultValue:d,onValueChange:s=()=>{},...n}=a,[g,u]=ia({prop:l,defaultProp:d??[],onChange:s,caller:te}),i=ee.useCallback(c=>u((R=[])=>[...R,c]),[u]),I=ee.useCallback(c=>u((R=[])=>R.filter(T=>T!==c)),[u]);return e.jsx(Ka,{scope:a.__scopeToggleGroup,type:"multiple",value:g,onItemActivate:i,onItemDeactivate:I,children:e.jsx(Ya,{...n,ref:r})})});ca.displayName=te;var[ro,io]=Qa(te),Ya=ee.forwardRef((a,r)=>{const{__scopeToggleGroup:l,disabled:d=!1,rovingFocus:s=!0,orientation:n,dir:g,loop:u=!0,...i}=a,I=Ja(l),c=Kt(g),R={role:"group",dir:c,...i};return e.jsx(ro,{scope:l,rovingFocus:s,disabled:d,children:s?e.jsx(Jt,{asChild:!0,...I,orientation:n,dir:c,loop:u,children:e.jsx(Ke.div,{...R,ref:r})}):e.jsx(Ke.div,{...R,ref:r})})}),Re="ToggleGroupItem",Xa=ee.forwardRef((a,r)=>{const l=Wa(Re,a.__scopeToggleGroup),d=io(Re,a.__scopeToggleGroup),s=Ja(a.__scopeToggleGroup),n=l.value.includes(a.value),g=d.disabled||a.disabled,u={...a,pressed:n,disabled:g},i=ee.useRef(null);return d.rovingFocus?e.jsx(Qt,{asChild:!0,...s,focusable:!g,active:n,ref:i,children:e.jsx(Ta,{...u,ref:r})}):e.jsx(Ta,{...u,ref:r})});Xa.displayName=Re;var Ta=ee.forwardRef((a,r)=>{const{__scopeToggleGroup:l,value:d,...s}=a,n=Wa(Re,l),g={role:"radio","aria-checked":a.pressed,"aria-pressed":void 0},u=n.type==="single"?g:void 0;return e.jsx(na,{...u,...s,ref:r,onPressedChange:i=>{i?n.onItemActivate(d):n.onItemDeactivate(d)}})}),et=ca,at=Xa;const tt=Rt("inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground",{variants:{variant:{default:"bg-transparent",outline:"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground"},size:{default:"h-10 px-3",sm:"h-9 px-2.5",lg:"h-11 px-5"}},defaultVariants:{variant:"default",size:"default"}}),no=o.forwardRef(({className:a,variant:r,size:l,...d},s)=>e.jsx(Za,{ref:s,className:W(tt({variant:r,size:l,className:a})),...d}));no.displayName=Za.displayName;const ot=o.createContext({size:"default",variant:"default"}),st=o.forwardRef(({className:a,variant:r,size:l,children:d,...s},n)=>e.jsx(et,{ref:n,className:W("flex items-center justify-center gap-1",a),...s,children:e.jsx(ot.Provider,{value:{variant:r,size:l},children:d})}));st.displayName=et.displayName;const ra=o.forwardRef(({className:a,children:r,variant:l,size:d,...s},n)=>{const g=o.useContext(ot);return e.jsx(at,{ref:n,className:W(tt({variant:g.variant||l,size:g.size||d}),a),...s,children:r})});ra.displayName=at.displayName;function rt({ciclandoValue:a,qualidadeValue:r,onChangeCiclando:l,onChangeQualidade:d,disabled:s=!1,size:n="sm"}){const g=n==="sm"?"text-xs":"text-sm",u=n==="sm"?"w-4 h-4":"w-5 h-5";return e.jsxs("div",{className:"flex flex-wrap items-center gap-3 text-foreground",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:W("text-muted-foreground font-medium",g),children:"Ciclo:"}),e.jsxs(st,{type:"single",value:a??"",onValueChange:i=>{s||l(i==="CL"||i==="N"?i:null)},disabled:s,className:"gap-1",children:[e.jsx(ra,{value:"CL","aria-label":"CL",size:"sm",variant:"outline",className:W("h-7 px-2 text-xs",a==="CL"&&"bg-primary/10 text-primary border-primary/30 data-[state=on]:bg-primary/10",s&&"opacity-60"),children:"CL"}),e.jsx(ra,{value:"N","aria-label":"N",size:"sm",variant:"outline",className:W("h-7 px-2 text-xs",a==="N"&&"bg-muted text-muted-foreground border-border data-[state=on]:bg-muted",s&&"opacity-60"),children:"N"})]}),a&&!s&&e.jsx(J,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 text-muted-foreground hover:text-foreground",onClick:()=>l(null),type:"button",children:e.jsx(Ae,{className:"w-3 h-3"})}),!a&&e.jsx("span",{className:W("text-muted-foreground/50",g),children:"—"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:W("text-muted-foreground font-medium",g),children:"Qualidade:"}),e.jsx("div",{className:"flex items-center gap-1.5",children:[1,2,3].map(i=>e.jsx("button",{type:"button",disabled:s,onClick:()=>{s||d(r===i?null:i)},className:W(u,"rounded-full border-2 transition-all",Dt(i),r===i?"border-foreground scale-110 ring-2 ring-muted-foreground/30":"border-muted-foreground/30 opacity-50 hover:opacity-75 hover:scale-105",s&&"opacity-40 cursor-not-allowed",!s&&"cursor-pointer"),title:`Qualidade ${i}`},i))}),r&&!s&&e.jsx(J,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 text-muted-foreground hover:text-foreground",onClick:()=>d(null),type:"button",children:e.jsx(Ae,{className:"w-3 h-3"})}),!r&&e.jsx("span",{className:W("text-muted-foreground/50",g),children:"—"})]})]})}function Oa({fazendaNome:a,dataInicio:r,veterinario:l,tecnico:d,passo2Data:s,passo2Tecnico:n,showPasso2:g=!1}){return e.jsxs(fe,{children:[e.jsx(Ie,{className:"pb-3",children:e.jsx(ze,{className:"text-base",children:"Informações do Protocolo"})}),e.jsx(xe,{children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(ce,{label:"Fazenda",value:a}),e.jsx(ce,{label:"Data Início",value:Ra(r)}),l&&e.jsx(ce,{label:"Veterinário",value:l}),d&&e.jsx(ce,{label:"Técnico",value:d}),g&&e.jsxs(e.Fragment,{children:[e.jsx(ce,{label:"Data 2º Passo",value:s?Ra(s):"-"}),e.jsx(ce,{label:"Técnico 2º Passo",value:n||"-"})]})]})})]})}function ce({label:a,value:r}){return e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:a}),e.jsx("p",{className:"text-base text-foreground",children:r})]})}function co({open:a,onOpenChange:r,onConfirm:l,title:d="Sair sem salvar?",description:s="Se você sair agora, todas as alterações serão perdidas."}){return e.jsx(We,{open:a,onOpenChange:r,children:e.jsxs(Ye,{children:[e.jsxs(Xe,{children:[e.jsx(ea,{children:d}),e.jsx(aa,{children:s})]}),e.jsxs(ta,{children:[e.jsx(oa,{children:"Cancelar"}),e.jsx(sa,{onClick:l,children:"Sim, sair"})]})]})})}function lo({receptoras:a,motivosInapta:r,isFinalized:l,onStatusChange:d,onMotivoChange:s,hideCard:n=!1}){const g=i=>{const c={INICIADA:{label:"Pendente",className:"bg-muted text-muted-foreground border-border"},APTA:{label:"Apta",className:"bg-primary/15 text-primary border-primary/30"},INAPTA:{label:"Inapta",className:"bg-destructive/15 text-destructive border-destructive/30"}}[i]||{label:i,className:""};return e.jsx(Ee,{variant:"outline",className:c.className,children:c.label})},u=a.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Nenhuma receptora no protocolo"}):e.jsx("div",{className:"overflow-x-auto rounded-lg border border-border",children:e.jsxs("div",{className:"min-w-[750px] w-full",children:[e.jsxs("div",{className:"grid grid-cols-[minmax(160px,1.5fr)_36px_36px_36px_16px_80px_80px_70px_minmax(120px,1fr)] gap-0 bg-muted text-[10px] font-semibold text-muted-foreground uppercase tracking-wide",children:[e.jsx("div",{className:"px-3 py-2",children:"Receptora"}),e.jsx("div",{className:"px-1 py-2 text-center",title:"Protocolos",children:"P"}),e.jsx("div",{className:"px-1 py-2 text-center",title:"Gestações",children:"G"}),e.jsx("div",{className:"px-1 py-2 text-center",title:"Desde última",children:"D"}),e.jsx("div",{className:"border-r border-border/50"}),e.jsx("div",{className:"px-2 py-2 text-center",children:"Ciclando"}),e.jsx("div",{className:"px-2 py-2 text-center",children:"Qualidade"}),e.jsx("div",{className:"px-2 py-2 text-center",children:"Avaliação"}),e.jsx("div",{className:"px-2 py-2",children:"Motivo"})]}),a.map((i,I)=>{const c=i.historicoStats;return e.jsxs("div",{className:"group grid grid-cols-[minmax(160px,1.5fr)_36px_36px_36px_16px_80px_80px_70px_minmax(120px,1fr)] gap-0 items-center border-t border-border hover:bg-muted/50",children:[e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5",children:[e.jsx("span",{className:"flex items-center justify-center w-5 h-5 rounded-full bg-primary/10 text-primary text-[10px] font-bold shrink-0",children:I+1}),e.jsxs("div",{className:"flex flex-col min-w-0",children:[e.jsx("span",{className:"font-medium text-sm text-foreground truncate",children:i.identificacao}),i.nome&&e.jsx("span",{className:"text-[10px] text-muted-foreground truncate",children:i.nome})]})]}),e.jsx("div",{className:"px-1 py-1.5 text-center",children:e.jsx("span",{className:"inline-flex items-center justify-center w-6 h-5 text-[10px] font-medium bg-muted text-foreground rounded",children:(c==null?void 0:c.totalProtocolos)??0})}),e.jsx("div",{className:"px-1 py-1.5 text-center",children:e.jsx("span",{className:"inline-flex items-center justify-center w-6 h-5 text-[10px] font-medium bg-primary/15 text-primary rounded",children:(c==null?void 0:c.gestacoes)??0})}),e.jsx("div",{className:"px-1 py-1.5 text-center",children:e.jsx("span",{className:"inline-flex items-center justify-center w-6 h-5 text-[10px] font-medium bg-amber-500/15 text-amber-600 dark:text-amber-400 rounded",children:(c==null?void 0:c.protocolosDesdeUltimaGestacao)??0})}),e.jsx("div",{className:"border-r border-border/50 h-full"}),e.jsx("div",{className:"px-2 py-1 flex justify-center",children:e.jsx(Ma,{value:i.pr_ciclando_classificacao,variant:"display",disabled:!0})}),e.jsx("div",{className:"px-2 py-1 flex justify-center",children:e.jsx($a,{value:i.pr_qualidade_semaforo,variant:"single",disabled:!0})}),e.jsx("div",{className:"px-2 py-1 flex justify-center",children:l?g(i.pr_status):e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{type:"button",onClick:()=>d(i.id,i.pr_status==="APTA"?"INICIADA":"APTA"),className:W("w-7 h-7 rounded-md flex items-center justify-center transition-all",i.pr_status==="APTA"?"bg-primary text-primary-foreground shadow-sm":"bg-muted hover:bg-primary/20 text-muted-foreground hover:text-primary"),title:"Confirmar (Apta)",children:e.jsx(Wt,{className:"w-4 h-4"})}),e.jsx("button",{type:"button",onClick:()=>d(i.id,i.pr_status==="INAPTA"?"INICIADA":"INAPTA"),className:W("w-6 h-6 rounded-md flex items-center justify-center transition-all",i.pr_status==="INAPTA"?"bg-destructive text-destructive-foreground shadow-sm":"bg-muted hover:bg-destructive/20 text-muted-foreground hover:text-destructive"),title:"Rejeitar (Inapta)",children:e.jsx(Ae,{className:"w-3.5 h-3.5"})})]})}),e.jsx("div",{className:"px-2 py-1",children:i.pr_status==="INAPTA"&&!l?e.jsx(le,{type:"text",placeholder:"Motivo...",value:r[i.id]||i.pr_motivo_inapta||"",onChange:R=>s(i.id,R.target.value),className:"h-6 text-xs px-2"}):e.jsx("span",{className:"text-xs text-muted-foreground truncate block",children:i.pr_motivo_inapta||"-"})})]},i.id)})]})});return n?u:e.jsxs(fe,{children:[e.jsx(Ie,{className:"pb-3",children:e.jsxs(ze,{className:"text-base",children:["Receptoras para Revisão (",a.length,")"]})}),e.jsx(xe,{className:"pt-0",children:u})]})}function uo(){const{toast:a}=he(),[r,l]=o.useState(!1),[d,s]=o.useState(!1),[n,g]=o.useState([]),[u,i]=o.useState([]),[I,c]=o.useState([]),[R,T]=o.useState({fazenda_id:"",data_inicio:Va(),veterinario:"",tecnico:"",observacoes:""}),O=o.useCallback(async()=>{try{l(!0);const{data:x,error:f}=await D.from("fazendas").select("*").order("nome",{ascending:!0});if(f)throw f;g(x||[])}catch(x){a({title:"Erro ao carregar fazendas",description:x instanceof Error?x.message:"Erro desconhecido",variant:"destructive"})}finally{l(!1)}},[a]),j=o.useCallback(async x=>{const f=new Map;if(x.length===0)return f;try{const{data:p}=await D.from("protocolo_receptoras").select("receptora_id, created_at").in("receptora_id",x).order("created_at",{ascending:!1}),{data:N}=await D.from("diagnosticos_gestacao").select("receptora_id, data_diagnostico").in("receptora_id",x).in("resultado",["PRENHE","PRENHE_IA"]).order("data_diagnostico",{ascending:!1}),h=new Map;(p||[]).forEach(v=>{const C=h.get(v.receptora_id)||[];C.push(v.created_at),h.set(v.receptora_id,C)});const A=new Map;(N||[]).forEach(v=>{const C=A.get(v.receptora_id)||[];C.push(v.data_diagnostico),A.set(v.receptora_id,C)}),x.forEach(v=>{const C=h.get(v)||[],Q=A.get(v)||[],w=C.length,E=Q.length;let b=w;if(Q.length>0&&C.length>0){const y=new Date(Q[0]);b=C.filter(M=>new Date(M)>y).length}f.set(v,{totalProtocolos:w,gestacoes:E,protocolosDesdeUltimaGestacao:b})})}catch(p){console.error("Erro ao carregar histórico stats:",p)}return f},[]),_=o.useCallback(async x=>{try{s(!0);const{data:f,error:p}=await D.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",x);if(p)throw p;const N=(f==null?void 0:f.map(w=>w.receptora_id))||[];if(N.length===0){i([]),c([]);return}const[h,A]=await Promise.all([D.from("receptoras").select("id, identificacao, nome, status_reprodutivo").in("id",N).order("identificacao",{ascending:!0}),j(N)]);if(h.error)throw h.error;const C=(h.data||[]).filter(w=>(w.id?String(w.id).trim():"")!=="").map(w=>{const E=w.id?String(w.id).trim():"",b=w.status_reprodutivo||"VAZIA",y=Ha(b,"ENTRAR_PASSO1");return{...w,status:b,motivoIndisponivel:y.valido?void 0:y.mensagem,historicoStats:A.get(E)}}),Q=C.filter(w=>w.status==="VAZIA");i(Q),c(C)}catch(f){a({title:"Erro ao carregar receptoras",description:f instanceof Error?f.message:"Erro desconhecido",variant:"destructive"})}finally{s(!1)}},[a,j]),F=o.useCallback(x=>new Set(x.filter(f=>f.id&&f.id.trim()!==""&&f.id!==null&&f.id!==void 0).map(f=>String(f.id).trim())),[]),S=o.useCallback(x=>u.filter(f=>{const p=f.id?String(f.id).trim():"";return p!==""&&!x.has(p)}),[u]),z=o.useCallback((x,f)=>{if(!x.trim())return I.filter(N=>{const h=N.id?String(N.id).trim():"";return h!==""&&!f.has(h)&&N.status==="VAZIA"}).map(N=>({...N,disponivel:!0}));const p=x.toLowerCase().trim();return I.filter(N=>{const h=N.id?String(N.id).trim():"";if(h===""||f.has(h))return!1;const A=(N.identificacao||"").toLowerCase(),v=(N.nome||"").toLowerCase();return A.includes(p)||v.includes(p)}).map(N=>({...N,disponivel:N.status==="VAZIA"}))},[I]),m=o.useCallback(x=>{var f;return((f=n.find(p=>p.id===x))==null?void 0:f.nome)||"-"},[n]);return{loading:r,loadingReceptoras:d,fazendas:n,allReceptoras:u,receptorasComStatus:I,protocoloData:R,setProtocoloData:T,loadFazendas:O,loadAllReceptoras:_,getSelectedIds:F,getAvailableReceptoras:S,getReceptorasFiltradas:z,getFazendaNome:m}}function po({fazendaId:a,allReceptoras:r,receptorasComStatus:l,selectedIds:d,onReceptorasReload:s}){const{toast:n}=he(),[g,u]=o.useState([]),[i,I]=o.useState(!1),[c,R]=o.useState(!1),[T,O]=o.useState(""),[j,_]=o.useState(!1),[F,S]=o.useState({receptora_id:"",observacoes:"",ciclando_classificacao:null,qualidade_semaforo:null}),[z,m]=o.useState({identificacao:"",nome:"",observacoes:"",ciclando_classificacao:null,qualidade_semaforo:null}),[x,f]=o.useState(!1),p=o.useCallback(()=>{S({receptora_id:"",observacoes:"",ciclando_classificacao:null,qualidade_semaforo:null}),O(""),_(!1)},[]),N=o.useCallback(()=>{m({identificacao:"",nome:"",observacoes:"",ciclando_classificacao:null,qualidade_semaforo:null})},[]),h=o.useCallback(async()=>{var K;const w=((K=F.receptora_id)==null?void 0:K.trim())||"";if(!w){n({title:"Erro",description:"Selecione uma receptora",variant:"destructive"});return}const E=r.find(V=>(V.id?String(V.id).trim():"")===w);if(!E||!E.id){n({title:"Erro",description:"Receptora não encontrada ou inválida",variant:"destructive"});return}const b=E.status_reprodutivo||"VAZIA",y=Ha(b,"ENTRAR_PASSO1");if(!y.valido){n({title:"Erro de validação",description:y.mensagem||"A receptora não pode entrar no protocolo no estado atual",variant:"destructive"});return}if(d.has(w)){n({title:"Receptora já adicionada",description:"Esta receptora já está na lista de selecionadas",variant:"destructive"});return}const M=l.find(V=>(V.id?String(V.id).trim():"")===w);u(V=>{var U;return V.some(Y=>(Y.id?String(Y.id).trim():"")===w)?V:[...V,{id:E.id,identificacao:E.identificacao,nome:E.nome,observacoes:((U=F.observacoes)==null?void 0:U.trim())||void 0,ciclando_classificacao:F.ciclando_classificacao||null,qualidade_semaforo:F.qualidade_semaforo||null,historicoStats:M==null?void 0:M.historicoStats}]}),p(),I(!1)},[F,r,d,n,p]),A=o.useCallback(async()=>{if(!z.identificacao.trim()){n({title:"Erro de validação",description:"Identificação (brinco) é obrigatória",variant:"destructive"});return}try{f(!0);const{data:w,error:E}=await D.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",a);if(E)throw E;const b=(w==null?void 0:w.map(k=>k.receptora_id))||[];if(b.length>0){const{data:k,error:U}=await D.from("receptoras").select("id, identificacao, nome").in("id",b).ilike("identificacao",z.identificacao.trim());if(U)throw U;if(k&&k.length>0){const Y=k[0].nome?`"${k[0].nome}"`:"sem nome";throw new Error(`Já existe uma receptora com o brinco "${z.identificacao.trim()}" nesta fazenda (Nome: ${Y}).`)}}if(z.nome.trim()&&b.length>0){const{data:k,error:U}=await D.from("receptoras").select("id, identificacao").in("id",b).ilike("nome",z.nome.trim());if(U)throw U;if(k&&k.length>0)throw new Error(`Já existe uma receptora com o nome "${z.nome.trim()}" nesta fazenda (Brinco: ${k[0].identificacao}).`)}const y={identificacao:z.identificacao};z.nome.trim()&&(y.nome=z.nome);const{data:M,error:K}=await D.from("receptoras").insert([y]).select().single();if(K)throw K.code==="23505"?new Error("Já existe uma receptora com esse brinco nesta fazenda."):K;const{error:V}=await D.from("receptora_fazenda_historico").insert([{receptora_id:M.id,fazenda_id:a,data_inicio:Va(),data_fim:null}]);u(k=>[...k,{id:M.id,identificacao:M.identificacao,nome:M.nome,observacoes:z.observacoes||void 0,ciclando_classificacao:z.ciclando_classificacao||null,qualidade_semaforo:z.qualidade_semaforo||null,isNew:!0}]),N(),R(!1),await s()}catch(w){n({title:"Erro ao criar receptora",description:w instanceof Error?w.message:"Erro desconhecido",variant:"destructive"})}finally{f(!1)}},[z,a,n,N,s]),v=o.useCallback(w=>{u(E=>E.filter((b,y)=>y!==w))},[]),C=o.useCallback((w,E)=>{u(b=>b.map((y,M)=>M===w?{...y,ciclando_classificacao:E}:y))},[]),Q=o.useCallback((w,E)=>{u(b=>b.map((y,M)=>M===w?{...y,qualidade_semaforo:E}:y))},[]);return{receptorasLocais:g,setReceptorasLocais:u,showAddReceptora:i,setShowAddReceptora:I,showCreateReceptora:c,setShowCreateReceptora:R,buscaReceptora:T,setBuscaReceptora:O,popoverAberto:j,setPopoverAberto:_,addReceptoraForm:F,setAddReceptoraForm:S,createReceptoraForm:z,setCreateReceptoraForm:m,submitting:x,handleAddReceptora:h,handleCreateReceptora:A,handleRemoveReceptora:v,handleUpdateCiclando:C,handleUpdateQualidade:Q,resetAddForm:p,resetCreateForm:N}}function mo({protocoloData:a,receptorasLocais:r,onSuccess:l}){const d=Ga(),{toast:s}=he(),[n,g]=o.useState(!1),[u,i]=o.useState(!1),I=o.useRef(!1),c=o.useCallback(()=>!a.fazenda_id||!a.data_inicio||!a.veterinario.trim()?(s({title:"Erro de validação",description:"Fazenda, data de início e veterinário são obrigatórios",variant:"destructive"}),!1):!0,[a,s]),R=o.useCallback(async()=>{var x,f,p,N;if(I.current||n)return;if(r.length===0){s({title:"Erro de validação",description:"Adicione pelo menos 1 receptora antes de finalizar o 1º passo",variant:"destructive"});return}if(r.filter(h=>!h.id||h.id===""||h.id===null||h.id===void 0).length>0){s({title:"Erro de validação",description:"Seleção de receptora inválida. Refaça a seleção.",variant:"destructive"});return}const j=r.filter(h=>h.id&&h.id!==""&&h.id!==null&&h.id!==void 0);if(j.length!==r.length||j.length===0){s({title:"Erro de validação",description:"Seleção de receptora inválida. Refaça a seleção.",variant:"destructive"});return}const _=j.map(h=>h.id);if(new Set(_).size!==_.length){s({title:"Erro de validação",description:"Existem receptoras duplicadas na seleção. Remova as duplicatas.",variant:"destructive"});return}const S=j.map(h=>h.observacoes||null),z=j.map(h=>h.ciclando_classificacao||null),m=j.map(h=>h.qualidade_semaforo||null);try{I.current=!0,g(!0);const h=a.tecnico.trim(),A=h?`VET: ${a.veterinario.trim()} | TEC: ${h}`:`VET: ${a.veterinario.trim()}`,{data:v,error:C}=await D.rpc("criar_protocolo_passo1_atomico",{p_fazenda_id:a.fazenda_id,p_data_inicio:a.data_inicio,p_responsavel_inicio:A,p_receptoras_ids:_,p_data_inclusao:a.data_inicio,p_observacoes:a.observacoes.trim()||null,p_receptoras_observacoes:S});if(C)throw console.error("=== ERRO RPC criar_protocolo_passo1_atomico ==="),console.error("Code:",C.code),console.error("Message:",C.message),console.error("Details:",C.details),console.error("Hint:",C.hint),console.error("Full error:",JSON.stringify(C,null,2)),console.error("Receptoras enviadas:",_),C.code==="23505"||(x=C.message)!=null&&x.includes("duplicate")||(f=C.message)!=null&&f.includes("unique")?new Error("Uma ou mais receptoras já estão em um protocolo ativo. Verifique a seleção."):C.code==="23503"||(p=C.message)!=null&&p.includes("foreign key")?new Error("Receptora ou fazenda inválida. Recarregue a página e tente novamente."):C.code==="PGRST202"||(N=C.message)!=null&&N.includes("Could not find")?new Error("Função do banco de dados não encontrada. Contate o suporte."):new Error(C.message||`Erro ao criar protocolo (código: ${C.code})`);if(!v)throw new Error("Protocolo criado mas ID não retornado");const{data:Q,error:w}=await D.from("protocolo_receptoras").select("id, receptora_id").eq("protocolo_id",v).in("receptora_id",_);if(!w&&Q&&Q.length>0){const y=new Map(_.map((k,U)=>[k,U])),M=Q.map(async k=>{const U=y.get(k.receptora_id);if(U===void 0)return{success:!0};const Y=z[U],oe=m[U],{error:L}=await D.from("protocolo_receptoras").update({ciclando_classificacao:Y,qualidade_semaforo:oe}).eq("id",k.id);return{success:!L,error:L}}),V=(await Promise.allSettled(M)).filter(k=>k.status==="rejected"||k.status==="fulfilled"&&k.value&&!k.value.success);V.length>0&&s({title:"Aviso",description:`Protocolo criado, mas ${V.length} classificação(ões) não foram salvas. Edite o protocolo para corrigir.`,variant:"destructive"})}if((await Promise.all(_.map(y=>Yt(y,"EM_SINCRONIZACAO")))).map((y,M)=>({result:y,receptoraId:_[M]})).filter(({result:y})=>y.error).length>0)throw new Error("Erro ao atualizar status das receptoras. Tente novamente.");s({title:"1º passo concluído",description:`${r.length} receptora(s) em protocolo`}),l==null||l()}catch(h){const A=h instanceof Error?h.message:"Erro desconhecido ao finalizar protocolo";s({title:"Erro ao finalizar protocolo",description:A,variant:"destructive"})}finally{g(!1),I.current=!1}},[a,r,s,d,n]),T=o.useCallback(()=>{i(!1),d("/protocolos")},[d]);return{submitting:n,showConfirmExit:u,setShowConfirmExit:i,handleFinalizarPasso1:R,handleConfirmExit:T,validateProtocoloForm:c}}const it="protocolos_filtros",ye=50,fo=()=>{try{const a=localStorage.getItem(it);return a?JSON.parse(a):{}}catch{return{}}};function xo(){const a=fo(),[r,l]=o.useState(!0),[d,s]=o.useState(!1),[n,g]=o.useState([]),[u,i]=o.useState([]),[I,c]=o.useState(0),[R,T]=o.useState({finalizadas:0,utilizadas:0,sincronizadas:0}),[O,j]=o.useState(a.filtroStatus||"all"),[_,F]=o.useState(a.fazendaFilter??""),[S,z]=o.useState(a.filtroDataInicio??""),[m,x]=o.useState(a.filtroDataFim??""),[f,p]=o.useState(a.filtroDataTipo??"data_inicio"),[N,h]=o.useState(a.protocolosPage??1);o.useEffect(()=>{const E={filtroStatus:O,fazendaFilter:_,filtroDataInicio:S,filtroDataFim:m,filtroDataTipo:f,protocolosPage:N};localStorage.setItem(it,JSON.stringify(E))},[O,_,S,m,f,N]);const A=o.useCallback(async()=>{const{data:E,error:b}=await D.from("fazendas").select("*").order("nome",{ascending:!0});if(b)throw b;i(E||[])},[]),v=o.useCallback(async(E,b)=>{try{s(!0);const y=(b==null?void 0:b.fazendaFilter)!==void 0?b.fazendaFilter:_,M=(b==null?void 0:b.filtroDataInicio)!==void 0?b.filtroDataInicio:S,K=(b==null?void 0:b.filtroDataFim)!==void 0?b.filtroDataFim:m,V=(b==null?void 0:b.filtroStatus)!==void 0?b.filtroStatus:O,k=(b==null?void 0:b.filtroDataTipo)!==void 0?b.filtroDataTipo:f,Y=((E!==void 0?E:N)-1)*ye,oe=Y+ye*2-1;let L=D.from("protocolos_sincronizacao").select("*",{count:"exact"});y&&y!=="all"&&(L=L.eq("fazenda_id",y));const ve=k==="passo2_data"?"passo2_data":"data_inicio";M&&(L=L.gte(ve,M)),K&&(L=L.lte(ve,K)),V==="aguardando_2_passo"?L=L.eq("status","PASSO1_FECHADO"):V==="sincronizado"?L=L.eq("status","SINCRONIZADO"):V==="fechado"&&(L=L.in("status",["FECHADO","EM_TE"])),L=L.order("data_inicio",{ascending:!1}).range(Y,oe);const{data:de,error:be,count:De}=await L;if(be)throw be;const ke=(de||[]).map(G=>G.id),Te=[...new Set((de||[]).map(G=>G.fazenda_id))],{data:_e}=await D.from("protocolo_receptoras").select("protocolo_id, status").in("protocolo_id",ke),Oe=(_e||[]).reduce((G,q)=>(G[q.protocolo_id]=(G[q.protocolo_id]||0)+1,G),{}),Fe=(_e||[]).reduce((G,q)=>((q.status==="APTA"||q.status==="INAPTA"||q.status==="UTILIZADA")&&G.finalizadas++,q.status==="UTILIZADA"&&G.utilizadas++,q.status==="APTA"&&G.sincronizadas++,G),{finalizadas:0,utilizadas:0,sincronizadas:0}),{data:Ge}=await D.from("fazendas").select("id, nome").in("id",Te),qe=(Ge||[]).reduce((G,q)=>(G[q.id]=q.nome,G),{}),Me=(de||[]).map(G=>{const q=Oe[G.id]||0;return q===0?null:{...G,fazenda_nome:qe[G.fazenda_id]||"N/A",receptoras_count:q}}).filter(G=>G!==null).slice(0,ye);g(Me),c(De||0),T(Fe)}catch(y){Da(y,"Erro ao carregar protocolos"),g([]),T({finalizadas:0,utilizadas:0,sincronizadas:0})}finally{s(!1)}},[_,S,m,f,O,N]),C=o.useCallback(async()=>{try{l(!0),await A(),await v()}catch(E){Da(E,"Erro ao carregar dados")}finally{l(!1)}},[A,v]),Q=o.useCallback(()=>{F(""),z(""),x(""),p("data_inicio"),j("all"),h(1)},[]),w=o.useCallback(E=>{const b=new Date,y=new Date(b);y.setDate(b.getDate()-E),z(y.toISOString().split("T")[0]),x(b.toISOString().split("T")[0])},[]);return{loading:r,loadingProtocolos:d,protocolos:n,fazendas:u,protocolosTotalCount:I,statsAproveitamento:R,filtroStatus:O,setFiltroStatus:j,fazendaFilter:_,setFazendaFilter:F,filtroDataInicio:S,setFiltroDataInicio:z,filtroDataFim:m,setFiltroDataFim:x,filtroDataTipo:f,setFiltroDataTipo:p,protocolosPage:N,setProtocolosPage:h,pageSize:ye,loadData:C,loadProtocolos:v,limparFiltros:Q,aplicarAtalhoData:w}}function go(){const a=Ga(),{toast:r}=he(),[l,d]=o.useState(!1),[s,n]=o.useState(null),[g,u]=o.useState(""),[i,I]=o.useState([]),c=o.useCallback(async O=>{const j=new Map;if(O.length===0)return j;try{const{data:_}=await D.from("protocolo_receptoras").select("receptora_id, created_at").in("receptora_id",O).order("created_at",{ascending:!1}),{data:F}=await D.from("diagnosticos_gestacao").select("receptora_id, data_diagnostico").in("receptora_id",O).in("resultado",["PRENHE","PRENHE_IA"]).order("data_diagnostico",{ascending:!1}),S=new Map;(_||[]).forEach(m=>{const x=S.get(m.receptora_id)||[];x.push(m.created_at),S.set(m.receptora_id,x)});const z=new Map;(F||[]).forEach(m=>{const x=z.get(m.receptora_id)||[];x.push(m.data_diagnostico),z.set(m.receptora_id,x)}),O.forEach(m=>{const x=S.get(m)||[],f=z.get(m)||[],p=x.length,N=f.length;let h=p;if(f.length>0&&x.length>0){const A=new Date(f[0]);h=x.filter(v=>new Date(v)>A).length}j.set(m,{totalProtocolos:p,gestacoes:N,protocolosDesdeUltimaGestacao:h})})}catch(_){console.error("Erro ao carregar histórico stats:",_)}return j},[]),R=o.useCallback(async O=>{try{const{data:j,error:_}=await D.from("protocolo_receptoras").select("*").eq("protocolo_id",O);if(_){r({title:"Erro ao carregar receptoras",description:_.message,variant:"destructive"}),I([]);return}if(!j||j.length===0){r({title:"Erro: Protocolo inconsistente",description:"Este protocolo não possui receptoras vinculadas.",variant:"destructive"}),I([]);return}const F=j.map(p=>p.receptora_id),[S,z]=await Promise.all([D.from("receptoras").select("*").in("id",F),c(F)]);if(S.error){r({title:"Erro ao carregar dados das receptoras",description:S.error.message,variant:"destructive"}),I([]);return}const m=S.data||[],x=new Map(m.map(p=>[p.id,p])),f=[];for(const p of j){const N=x.get(p.receptora_id);N&&f.push({...N,pr_id:p.id,pr_status:p.status,pr_motivo_inapta:p.motivo_inapta,pr_observacoes:p.observacoes,pr_ciclando_classificacao:"ciclando_classificacao"in p&&(p.ciclando_classificacao==="CL"||p.ciclando_classificacao==="N")?p.ciclando_classificacao:null,pr_qualidade_semaforo:"qualidade_semaforo"in p&&typeof p.qualidade_semaforo=="number"&&p.qualidade_semaforo>=1&&p.qualidade_semaforo<=3?p.qualidade_semaforo:null,historicoStats:z.get(p.receptora_id)})}I(f)}catch(j){r({title:"Erro ao carregar receptoras",description:j instanceof Error?j.message:"Erro desconhecido",variant:"destructive"})}},[r,c]),T=o.useCallback(async O=>{try{d(!0);const{data:j,error:_}=await D.from("protocolos_sincronizacao").select("*").eq("id",O).single();if(_)throw _;if(j.status!=="PASSO1_FECHADO"&&j.status!=="SINCRONIZADO"){r({title:"Erro",description:"Este protocolo não está aguardando o 2º passo",variant:"destructive"}),a("/protocolos");return}n(j);const{data:F,error:S}=await D.from("fazendas").select("nome").eq("id",j.fazenda_id).single();if(S)throw S;u(F.nome),await R(O)}catch(j){r({title:"Erro ao carregar dados",description:j instanceof Error?j.message:"Erro desconhecido",variant:"destructive"})}finally{d(!1)}},[a,r,R]);return{loading:l,protocolo:s,setProtocolo:n,fazendaNome:g,receptoras:i,setReceptoras:I,loadData:T,loadReceptoras:R}}function ho({protocoloId:a,protocolo:r,receptoras:l,setReceptoras:d,setProtocolo:s,passo2Form:n,motivosInapta:g,onSuccess:u}){const{toast:i}=he(),[I,c]=o.useState(!1),R=o.useCallback((j,_)=>{d(F=>F.map(S=>S.id===j?{...S,pr_status:_,pr_motivo_inapta:_==="APTA"||_==="INICIADA"?void 0:S.pr_motivo_inapta}:S))},[d]),T=o.useCallback((j,_)=>{d(F=>F.map(S=>S.id===j?{...S,pr_motivo_inapta:_.trim()||void 0}:S))},[d]),O=o.useCallback(async()=>{if(I)return;if(!n.data||!n.tecnico.trim()){i({title:"Erro de validação",description:"Data e técnico responsável são obrigatórios",variant:"destructive"});return}const j=l.filter(_=>_.pr_status==="INICIADA");if(j.length>0){i({title:"Erro",description:`Ainda há ${j.length} receptora(s) pendente(s) de revisão`,variant:"destructive"});return}if(l.length===0){i({title:"Erro",description:"Não é possível finalizar protocolo sem receptoras",variant:"destructive"});return}try{c(!0);const _=new Date,F=`${_.getFullYear()}-${String(_.getMonth()+1).padStart(2,"0")}-${String(_.getDate()).padStart(2,"0")}`,S=l.filter(A=>A.pr_status==="APTA"),z=l.filter(A=>A.pr_status==="INAPTA"),x=S.length>0?"SINCRONIZADO":"FECHADO",f=[...S.map(async A=>{const{error:v}=await D.from("protocolo_receptoras").update({status:"APTA",motivo_inapta:null}).eq("protocolo_id",a).eq("receptora_id",A.id);if(v)throw v}),...z.map(async A=>{const v=g[A.id]||A.pr_motivo_inapta||null,{error:C}=await D.from("protocolo_receptoras").update({status:"INAPTA",motivo_inapta:v}).eq("protocolo_id",a).eq("receptora_id",A.id);if(C)throw C})];await Promise.all(f);const{error:p}=await D.from("protocolos_sincronizacao").update({status:x,passo2_data:n.data,passo2_tecnico_responsavel:n.tecnico.trim(),data_retirada:F,responsavel_retirada:(r==null?void 0:r.responsavel_inicio)||null}).eq("id",a);if(p)throw p;s({...r,status:x,passo2_data:n.data,passo2_tecnico_responsavel:n.tecnico.trim(),data_retirada:F,responsavel_retirada:(r==null?void 0:r.responsavel_inicio)||null});const N=[...S.map(async A=>{const{error:v}=await D.from("receptoras").update({status_reprodutivo:"SINCRONIZADA"}).eq("id",A.id);if(v)throw v}),...z.map(async A=>{const{error:v}=await D.from("receptoras").update({status_reprodutivo:"VAZIA"}).eq("id",A.id);if(v)throw v})];await Promise.all(N);const h=l.filter(A=>A.pr_status==="APTA").length;i({title:"2º passo concluído",description:`${h} receptora(s) confirmadas para TE`}),u==null||u()}catch(_){i({title:"Erro ao finalizar 2º passo",description:_ instanceof Error?_.message:"Erro desconhecido",variant:"destructive"})}finally{c(!1)}},[I,n,l,a,r,g,s,i]);return{submitting:I,handleStatusChange:R,handleMotivoChange:T,handleFinalizarPasso2:O}}const Pe="passagene_protocolo_passo1_rascunho",Se="passagene_protocolo_passo2_rascunho",Fa=24;function ts(){const[a,r]=o.useState("passo1"),[l,d]=o.useState(!1),[s,n]=o.useState(!1),[g,u]=o.useState(null),i=o.useRef(null),{loading:I,loadData:c,loadProtocolos:R}=xo(),[T,O]=o.useState("form"),{loading:j,loadingReceptoras:_,fazendas:F,allReceptoras:S,receptorasComStatus:z,protocoloData:m,setProtocoloData:x,loadFazendas:f,loadAllReceptoras:p,getSelectedIds:N,getReceptorasFiltradas:h,getFazendaNome:A}=uo(),{receptorasLocais:v,setReceptorasLocais:C,showAddReceptora:Q,setShowAddReceptora:w,showCreateReceptora:E,setShowCreateReceptora:b,buscaReceptora:y,setBuscaReceptora:M,popoverAberto:K,setPopoverAberto:V,addReceptoraForm:k,setAddReceptoraForm:U,createReceptoraForm:Y,setCreateReceptoraForm:oe,submitting:L,handleAddReceptora:ve,handleCreateReceptora:de,handleRemoveReceptora:be,handleUpdateCiclando:De,handleUpdateQualidade:ke,resetAddForm:Te,resetCreateForm:_e}=po({fazendaId:m.fazenda_id,allReceptoras:S,receptorasComStatus:z,selectedIds:N([]),onReceptorasReload:()=>p(m.fazenda_id)}),{submitting:Oe,showConfirmExit:Fe,setShowConfirmExit:Ge,handleFinalizarPasso1:qe,handleConfirmExit:la,validateProtocoloForm:Me}=mo({protocoloData:m,receptorasLocais:v,onSuccess:()=>{Nt(),Ce(),R(1)}}),G=L||Oe,[q,da]=o.useState(""),[se,$e]=o.useState([]),[nt,ua]=o.useState(!1),[re,pa]=o.useState(""),[X,ue]=o.useState({data:new Date().toISOString().split("T")[0],tecnico:""}),[pe,me]=o.useState({}),[jo,No]=o.useState(!1),{loading:ct,protocolo:H,setProtocolo:ma,fazendaNome:lt,receptoras:Z,setReceptoras:je,loadData:fa}=go(),{submitting:Le,handleStatusChange:dt,handleMotivoChange:ut,handleFinalizarPasso2:pt}=ho({protocoloId:q,protocolo:H,receptoras:Z,setReceptoras:je,setProtocolo:ma,passo2Form:X,motivosInapta:pe,onSuccess:()=>{_a(),ne(),R(1),He()}}),xa=o.useMemo(()=>N(v),[N,v]),mt=o.useMemo(()=>h(y,xa),[h,y,xa]),ga=o.useMemo(()=>re?se.filter(t=>t.fazenda_id===re):se,[se,re]),ft=o.useMemo(()=>{const t=new Map;return se.forEach(P=>{t.has(P.fazenda_id)||t.set(P.fazenda_id,P.fazenda_nome)}),Array.from(t.entries()).map(([P,$])=>({id:P,nome:$}))},[se]),ie=o.useMemo(()=>({pendentes:Z.filter(t=>t.pr_status==="INICIADA").length,confirmadas:Z.filter(t=>t.pr_status==="APTA").length,descartadas:Z.filter(t=>t.pr_status==="INAPTA").length}),[Z]),Ve=(H==null?void 0:H.status)==="SINCRONIZADO",xt=ie.pendentes===0&&X.data&&X.tecnico.trim(),Ne=o.useCallback(()=>{try{const t=localStorage.getItem(Pe);if(!t)return null;const P=JSON.parse(t);return(Date.now()-P.timestamp)/(1e3*60*60)>Fa?(localStorage.removeItem(Pe),null):P}catch{return null}},[]),ha=o.useCallback(()=>{const t={protocoloData:m,receptorasLocais:v,currentStep:T,timestamp:Date.now()};localStorage.setItem(Pe,JSON.stringify(t))},[m,v,T]),Ce=o.useCallback(()=>{localStorage.removeItem(Pe)},[]),gt=o.useCallback(()=>{const t=Ne();t&&(x(t.protocoloData),C(t.receptorasLocais),O(t.currentStep)),d(!1)},[Ne,x,C]),ht=o.useCallback(()=>{Ce(),d(!1)},[Ce]),va=o.useCallback(()=>{try{const t=localStorage.getItem(Se);if(!t)return null;const P=JSON.parse(t);return(Date.now()-P.timestamp)/(1e3*60*60)>Fa?(localStorage.removeItem(Se),null):P}catch{return null}},[]),ba=o.useCallback(()=>{if(!q)return;const t={};Z.forEach($=>{$.pr_status&&(t[$.id]=$.pr_status)});const P={protocoloSelecionadoId:q,passo2Form:X,motivosInapta:pe,statusAlterados:t,timestamp:Date.now()};localStorage.setItem(Se,JSON.stringify(P))},[q,X,pe,Z]),ne=o.useCallback(()=>{localStorage.removeItem(Se)},[]),vt=o.useCallback(t=>{ue(t.passo2Form),me(t.motivosInapta),Object.keys(t.statusAlterados).length>0&&je(P=>P.map($=>({...$,pr_status:t.statusAlterados[$.id]||$.pr_status}))),ne(),u(null),n(!1)},[je,ne]),bt=o.useCallback(()=>{ne(),u(null),n(!1)},[ne]),He=o.useCallback(async()=>{try{ua(!0);const{data:t,error:P}=await D.from("protocolos_sincronizacao").select("id, fazenda_id, data_inicio, status").eq("status","PASSO1_FECHADO").order("data_inicio",{ascending:!1});if(P)throw P;if(!t||t.length===0){$e([]);return}const $=t.map(B=>B.id),ae=[...new Set(t.map(B=>B.fazenda_id))],[Pt,St]=await Promise.all([D.from("protocolo_receptoras").select("protocolo_id").in("protocolo_id",$),D.from("fazendas").select("id, nome").in("id",ae)]),we={};(Pt.data||[]).forEach(B=>{we[B.protocolo_id]=(we[B.protocolo_id]||0)+1});const ja={};(St.data||[]).forEach(B=>{ja[B.id]=B.nome});const At=t.filter(B=>(we[B.id]||0)>0).map(B=>({id:B.id,fazenda_id:B.fazenda_id,fazenda_nome:ja[B.fazenda_id]||"N/A",data_inicio:B.data_inicio,receptoras_count:we[B.id]||0}));$e(At)}catch(t){console.error("Erro ao carregar protocolos passo 2:",t),$e([])}finally{ua(!1)}},[]);o.useEffect(()=>{c(),f(),He()},[c,f,He]),o.useEffect(()=>{T==="receptoras"&&m.fazenda_id&&p(m.fazenda_id)},[T,m.fazenda_id,p]),o.useEffect(()=>{q&&fa(q)},[q,fa]),o.useEffect(()=>{H&&(H.passo2_data||H.passo2_tecnico_responsavel)&&ue({data:H.passo2_data||new Date().toISOString().split("T")[0],tecnico:H.passo2_tecnico_responsavel||""})},[H]),o.useEffect(()=>{if(Z.length>0){const t={};Z.filter(P=>P.pr_status==="INAPTA"&&P.pr_motivo_inapta).forEach(P=>{t[P.id]=P.pr_motivo_inapta||""}),me(t)}},[Z]),o.useEffect(()=>{if(H&&Z.length>0&&i.current!==H.id){i.current=H.id;const t=va();t&&t.protocoloSelecionadoId===H.id&&(u(t),n(!0))}},[H,Z.length,va]),o.useEffect(()=>{const t=Ne();t&&(t.receptorasLocais.length>0||t.currentStep==="receptoras")&&d(!0)},[Ne]),o.useEffect(()=>{if(T==="receptoras"||v.length>0){const t=setTimeout(()=>{ha()},1e3);return()=>clearTimeout(t)}},[m,v,T,ha]),o.useEffect(()=>{if(q&&Z.length>0){const t=setTimeout(()=>{ba()},1e3);return()=>clearTimeout(t)}},[q,X,pe,Z,ba]);const _t=()=>{Me()&&O("receptoras")},jt=()=>{T==="receptoras"&&O("form")},Nt=()=>{O("form"),x({fazenda_id:"",data_inicio:new Date().toISOString().split("T")[0],veterinario:"",tecnico:"",observacoes:""}),C([]),Ce()},Ct=(t,P)=>{dt(t,P),(P==="APTA"||P==="INICIADA")&&me($=>{const ae={...$};return delete ae[t],ae})},wt=(t,P)=>{ut(t,P),me($=>({...$,[t]:P.trim()}))},_a=()=>{da(""),ma(null),je([]),ue({data:new Date().toISOString().split("T")[0],tecnico:""}),me({}),pa(""),ne()},yt=t=>{if(!t)return"-";const[P,$,ae]=t.split("-");return`${ae}/${$}/${P}`};return I?e.jsx(Na,{}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(Ut,{title:"Protocolos de Sincronização",description:"Gerenciar protocolos em 2 passos"}),e.jsx("div",{className:"mt-4",children:e.jsxs(Ht,{value:a,onValueChange:t=>r(t),className:"w-full",children:[e.jsx("div",{className:"rounded-xl border border-border bg-card p-1.5 mb-4",children:e.jsx("div",{className:"flex gap-1",children:[{value:"passo1",label:"1º Passo",icon:kt,count:0},{value:"passo2",label:"2º Passo",icon:to,count:se.length}].map(({value:t,label:P,icon:$,count:ae})=>e.jsxs("button",{type:"button",onClick:()=>r(t),className:`
                      relative flex-1 flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg
                      text-sm font-medium transition-all duration-200
                      ${a===t?"bg-muted/80 text-foreground shadow-sm":"text-muted-foreground hover:text-foreground hover:bg-muted/40"}
                    `,children:[a===t&&e.jsx("div",{className:"absolute bottom-0 left-1/2 -translate-x-1/2 w-10 h-0.5 bg-primary rounded-full"}),e.jsx("div",{className:`
                      flex items-center justify-center w-7 h-7 rounded-md transition-colors
                      ${a===t?"bg-primary/15":"bg-muted/50"}
                    `,children:e.jsx($,{className:`w-4 h-4 ${a===t?"text-primary":"text-muted-foreground"}`})}),e.jsx("span",{children:P}),ae>0&&e.jsx("span",{className:`inline-flex items-center justify-center min-w-5 h-5 px-1.5 text-[10px] font-bold rounded-full ${a===t?"bg-primary/15 text-primary":"bg-muted text-muted-foreground"}`,children:ae})]},t))})}),e.jsx(za,{value:"passo1",children:T==="form"?e.jsx(e.Fragment,{children:e.jsx("div",{className:"rounded-xl border border-border bg-card overflow-hidden mb-4",children:e.jsxs("div",{className:"flex flex-wrap items-stretch",children:[e.jsxs("div",{className:"flex items-center gap-3 px-4 py-3 border-r border-border bg-gradient-to-b from-primary/5 to-transparent",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-1 h-6 rounded-full bg-primary/40"}),e.jsx("span",{className:"text-[10px] font-semibold text-muted-foreground uppercase tracking-wider",children:"Responsáveis"})]}),e.jsx(le,{placeholder:"Veterinário *",value:m.veterinario,onChange:t=>x({...m,veterinario:t.target.value}),className:"h-9 w-[160px] bg-background/80 border-primary/20 focus:border-primary/40"}),e.jsx(le,{placeholder:"Técnico",value:m.tecnico,onChange:t=>x({...m,tecnico:t.target.value}),className:"h-9 w-[160px] bg-background"})]}),e.jsxs("div",{className:"flex items-center gap-3 px-4 py-3 border-r border-border",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-1 h-6 rounded-full bg-primary/40"}),e.jsx("span",{className:"text-[10px] font-semibold text-muted-foreground uppercase tracking-wider",children:"Local"})]}),e.jsxs(Ue,{value:m.fazenda_id,onValueChange:t=>x({...m,fazenda_id:t}),disabled:!m.veterinario,children:[e.jsx(Be,{className:"h-9 w-[180px] bg-background",children:e.jsx(Ze,{placeholder:"Fazenda *"})}),e.jsx(Qe,{children:F.map(t=>e.jsx(Je,{value:t.id,children:t.nome},t.id))})]}),e.jsx(Ea,{value:m.data_inicio,onChange:t=>x({...m,data_inicio:t||""}),className:"h-9 w-[130px] bg-background"})]}),e.jsx("div",{className:"flex items-center gap-2 px-4 py-3 ml-auto bg-gradient-to-b from-muted/50 to-transparent",children:e.jsx(J,{onClick:_t,disabled:j||!m.fazenda_id||!m.veterinario||!m.data_inicio,className:"h-9 px-6 bg-primary hover:bg-primary-dark shadow-sm shadow-primary/25",children:"Continuar"})})]})})}):e.jsxs(e.Fragment,{children:[e.jsx(Oa,{fazendaNome:A(m.fazenda_id),dataInicio:m.data_inicio,veterinario:m.veterinario,tecnico:m.tecnico}),e.jsxs(fe,{className:"mt-4",children:[e.jsx(Ie,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(ze,{className:"text-base",children:["Receptoras do Protocolo (",v.length,")"]}),e.jsx(Ca,{children:"Adicione as receptoras para este protocolo"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(wa,{open:Q,onOpenChange:t=>{w(t),t||Te()},children:[e.jsx(ya,{asChild:!0,children:e.jsxs(J,{size:"sm",children:[e.jsx(Xt,{className:"w-4 h-4 mr-2"}),"Adicionar"]})}),e.jsxs(Pa,{className:"max-w-lg",children:[e.jsxs(Sa,{children:[e.jsx(Aa,{children:"Adicionar Receptora"}),e.jsx(Ia,{children:"Busque por identificação ou nome."})]}),e.jsx(vo,{addReceptoraForm:k,setAddReceptoraForm:U,buscaReceptora:y,setBuscaReceptora:M,popoverAberto:K,setPopoverAberto:V,receptorasFiltradas:mt,receptorasComStatus:z,loadingReceptoras:_,onAdd:ve})]})]}),e.jsxs(wa,{open:E,onOpenChange:t=>{b(t),t||_e()},children:[e.jsx(ya,{asChild:!0,children:e.jsxs(J,{variant:"outline",size:"sm",children:[e.jsx(Ua,{className:"w-4 h-4 mr-2"}),"Nova"]})}),e.jsxs(Pa,{children:[e.jsxs(Sa,{children:[e.jsx(Aa,{children:"Cadastrar Nova Receptora"}),e.jsx(Ia,{children:"Preencha os dados da nova receptora."})]}),e.jsx(bo,{createReceptoraForm:Y,setCreateReceptoraForm:oe,submitting:G,onCreate:de})]})]})]})]})}),e.jsx(xe,{className:"pt-0",children:v.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Nenhuma receptora adicionada. Adicione pelo menos uma antes de finalizar."}):e.jsx(_o,{receptorasLocais:v,onRemove:be,onUpdateCiclando:De,onUpdateQualidade:ke})})]}),e.jsxs("div",{className:"flex items-center justify-between mt-4",children:[e.jsx(J,{variant:"outline",onClick:jt,disabled:G,children:"Voltar"}),e.jsxs(J,{onClick:qe,disabled:v.length===0||G,className:"bg-primary hover:bg-primary-dark",children:[e.jsx(ka,{className:"w-4 h-4 mr-2"}),G?"Finalizando...":"Finalizar 1º Passo"]})]}),e.jsx(co,{open:Fe,onOpenChange:Ge,onConfirm:la,title:"Sair sem finalizar?",description:"Se você sair agora, nenhum protocolo será criado."})]})}),e.jsx(za,{value:"passo2",children:q?ct?e.jsx(fe,{children:e.jsx(xe,{className:"py-8",children:e.jsx(Na,{})})}):H?e.jsxs(e.Fragment,{children:[e.jsx(Oa,{fazendaNome:lt,dataInicio:H.data_inicio,veterinario:H.responsavel_inicio||"-",tecnico:H.tecnico_responsavel||"-",passo2Data:X.data,passo2Tecnico:X.tecnico,showPasso2:!0}),e.jsxs(fe,{className:"mt-4",children:[e.jsx(Ie,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(ze,{className:"text-base",children:["Receptoras para Avaliação (",Z.length,")"]}),e.jsx(Ca,{children:Ve?"Protocolo já finalizado":ie.pendentes>0?`${ie.pendentes} receptora(s) aguardando avaliação`:"Todas as receptoras foram avaliadas"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(Ee,{variant:"outline",className:"bg-green-500/10 text-green-600 dark:text-green-400 border-green-500/30",children:[e.jsx(eo,{className:"w-3 h-3 mr-1"}),ie.confirmadas," aptas"]}),ie.descartadas>0&&e.jsxs(Ee,{variant:"outline",className:"bg-red-500/10 text-red-600 dark:text-red-400 border-red-500/30",children:[ie.descartadas," inaptas"]})]})]})}),e.jsx(xe,{className:"pt-0",children:e.jsx(lo,{receptoras:Z,motivosInapta:pe,isFinalized:Ve,onStatusChange:Ct,onMotivoChange:wt,hideCard:!0})})]}),!Ve&&e.jsxs("div",{className:"flex items-center justify-between mt-4",children:[e.jsx(J,{variant:"outline",onClick:_a,disabled:Le,children:"Voltar"}),e.jsxs(J,{onClick:pt,disabled:!xt||Le,className:"bg-primary hover:bg-primary-dark",children:[e.jsx(ka,{className:"w-4 h-4 mr-2"}),Le?"Finalizando...":"Finalizar 2º Passo"]})]})]}):null:e.jsx("div",{className:"rounded-xl border border-border bg-card overflow-hidden mb-4",children:e.jsxs("div",{className:"flex flex-wrap items-stretch",children:[e.jsxs("div",{className:"flex items-center gap-3 px-4 py-3 border-r border-border bg-gradient-to-b from-primary/5 to-transparent",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-1 h-6 rounded-full bg-primary/40"}),e.jsx("span",{className:"text-[10px] font-semibold text-muted-foreground uppercase tracking-wider",children:"Responsável"})]}),e.jsx(le,{placeholder:"Nome do responsável *",value:X.tecnico,onChange:t=>ue(P=>({...P,tecnico:t.target.value})),className:"h-9 w-[180px] bg-background/80 border-primary/20 focus:border-primary/40"})]}),e.jsxs("div",{className:"flex items-center gap-3 px-4 py-3 border-r border-border",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-1 h-6 rounded-full bg-primary/40"}),e.jsx("span",{className:"text-[10px] font-semibold text-muted-foreground uppercase tracking-wider",children:"Fazenda"})]}),e.jsxs(Ue,{value:re,onValueChange:pa,children:[e.jsx(Be,{className:"h-9 w-[180px] bg-background",children:e.jsx(Ze,{placeholder:"Selecione a fazenda"})}),e.jsx(Qe,{children:ft.map(t=>e.jsx(Je,{value:t.id,children:t.nome},t.id))})]})]}),e.jsxs("div",{className:"flex items-center gap-3 px-4 py-3 border-r border-border flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-1 h-6 rounded-full bg-primary/40"}),e.jsx("span",{className:"text-[10px] font-semibold text-muted-foreground uppercase tracking-wider",children:"Protocolo"})]}),e.jsxs(Ue,{value:q,onValueChange:t=>{da(t)},disabled:!X.tecnico.trim()||!re,children:[e.jsx(Be,{className:"h-9 min-w-[280px] bg-background",children:e.jsx(Ze,{placeholder:re?"Selecione um protocolo *":"Selecione a fazenda primeiro"})}),e.jsx(Qe,{children:nt?e.jsx("div",{className:"p-2 text-sm text-muted-foreground text-center",children:"Carregando..."}):ga.length===0?e.jsx("div",{className:"p-2 text-sm text-muted-foreground text-center",children:"Nenhum protocolo nesta fazenda"}):ga.map(t=>e.jsxs(Je,{value:t.id,children:[t.fazenda_nome," • ",yt(t.data_inicio)," • ",t.receptoras_count," rec."]},t.id))})]}),e.jsx(Ea,{value:X.data,onChange:t=>ue(P=>({...P,data:t||""})),className:"h-9 w-[130px] bg-background"})]})]})})})]})}),e.jsx(We,{open:l,onOpenChange:d,children:e.jsxs(Ye,{children:[e.jsxs(Xe,{children:[e.jsx(ea,{children:"Retomar trabalho anterior?"}),e.jsx(aa,{children:"Foi encontrado um rascunho do 1º Passo não finalizado. Deseja continuar de onde parou?"})]}),e.jsxs(ta,{children:[e.jsx(oa,{onClick:ht,children:"Descartar"}),e.jsx(sa,{onClick:gt,className:"bg-primary hover:bg-primary-dark",children:"Continuar"})]})]})}),e.jsx(We,{open:s,onOpenChange:n,children:e.jsxs(Ye,{children:[e.jsxs(Xe,{children:[e.jsx(ea,{children:"Retomar avaliação anterior?"}),e.jsx(aa,{children:"Foi encontrada uma avaliação do 2º Passo não finalizada para este protocolo. Deseja continuar de onde parou?"})]}),e.jsxs(ta,{children:[e.jsx(oa,{onClick:bt,children:"Descartar"}),e.jsx(sa,{onClick:()=>g&&vt(g),className:"bg-primary hover:bg-primary-dark",children:"Continuar"})]})]})})]})}function vo({addReceptoraForm:a,setAddReceptoraForm:r,buscaReceptora:l,setBuscaReceptora:d,popoverAberto:s,setPopoverAberto:n,receptorasFiltradas:g,receptorasComStatus:u,loadingReceptoras:i,onAdd:I}){return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ge,{children:"Receptora *"}),e.jsxs(Tt,{open:s,onOpenChange:n,children:[e.jsx(Ot,{asChild:!0,children:e.jsxs(J,{variant:"outline",role:"combobox","aria-expanded":s,className:"w-full justify-between",children:[a.receptora_id?(()=>{const c=u.find(R=>String(R.id).trim()===a.receptora_id.trim());return c?`${c.identificacao}${c.nome?` - ${c.nome}`:""}`:"Selecione uma receptora"})():"Buscar receptora...",e.jsx(ao,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(Ft,{className:"w-[400px] p-0",align:"start",children:e.jsxs(Gt,{shouldFilter:!1,children:[e.jsx(qt,{placeholder:"Buscar por identificação ou nome...",value:l,onValueChange:d}),e.jsx(Mt,{children:i?e.jsx("div",{className:"p-4 text-sm text-center text-muted-foreground",children:"Carregando..."}):g.length===0?e.jsx($t,{children:l.trim()?"Nenhuma encontrada":"Nenhuma disponível"}):e.jsx(Lt,{children:g.map(c=>{const R=c.id?String(c.id).trim():"";if(!R)return null;const T=c.historicoStats;return e.jsx(Vt,{value:`${c.identificacao} ${c.nome||""} ${R}`,onSelect:()=>{c.disponivel&&(r({...a,receptora_id:R}),d(""),n(!1))},disabled:!c.disponivel,className:`group ${c.disponivel?"":"opacity-50 cursor-not-allowed"}`,children:e.jsxs("div",{className:"flex items-center justify-between w-full gap-2",children:[e.jsxs("div",{className:"flex flex-col min-w-0 flex-shrink",children:[e.jsx("span",{className:`font-medium truncate ${c.disponivel?"group-data-[selected=true]:text-accent-foreground":"text-muted-foreground"}`,children:c.identificacao}),c.nome&&e.jsx("span",{className:"text-xs text-muted-foreground truncate group-data-[selected=true]:text-accent-foreground/70",children:c.nome})]}),c.disponivel&&T&&e.jsxs("div",{className:"flex items-center gap-1 shrink-0 ml-auto",children:[e.jsxs("span",{className:"text-[10px] bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 px-1.5 py-0.5 rounded font-medium",title:"Protocolos",children:[T.totalProtocolos,"P"]}),e.jsxs("span",{className:"text-[10px] bg-emerald-100 dark:bg-emerald-900 text-emerald-700 dark:text-emerald-300 px-1.5 py-0.5 rounded font-medium",title:"Gestações",children:[T.gestacoes,"G"]}),e.jsxs("span",{className:"text-[10px] bg-amber-100 dark:bg-amber-900 text-amber-700 dark:text-amber-300 px-1.5 py-0.5 rounded font-medium",title:"Desde última gestação",children:[T.protocolosDesdeUltimaGestacao,"D"]})]}),!c.disponivel&&e.jsx(Ee,{variant:"outline",className:`ml-auto text-[10px] px-1.5 py-0 shrink-0 ${Zt(c.status)}`,children:Bt(c.status)})]})},c.id)})})})]})})]})]}),e.jsx("div",{className:"space-y-2",children:e.jsx(rt,{ciclandoValue:a.ciclando_classificacao,qualidadeValue:a.qualidade_semaforo,onChangeCiclando:c=>r({...a,ciclando_classificacao:c}),onChangeQualidade:c=>r({...a,qualidade_semaforo:c}),size:"sm"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ge,{children:"Observações"}),e.jsx(qa,{value:a.observacoes,onChange:c=>r({...a,observacoes:c.target.value}),placeholder:"Observações",rows:2})]}),e.jsx(J,{onClick:I,className:"w-full",disabled:i||!a.receptora_id,children:"Adicionar"})]})}function bo({createReceptoraForm:a,setCreateReceptoraForm:r,submitting:l,onCreate:d}){return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ge,{children:"Identificação (Brinco) *"}),e.jsx(le,{value:a.identificacao,onChange:s=>r({...a,identificacao:s.target.value}),placeholder:"Número do brinco"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ge,{children:"Nome"}),e.jsx(le,{value:a.nome,onChange:s=>r({...a,nome:s.target.value}),placeholder:"Nome da receptora (opcional)"})]}),e.jsx("div",{className:"space-y-2",children:e.jsx(rt,{ciclandoValue:a.ciclando_classificacao||null,qualidadeValue:a.qualidade_semaforo||null,onChangeCiclando:s=>r({...a,ciclando_classificacao:s}),onChangeQualidade:s=>r({...a,qualidade_semaforo:s}),size:"sm"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ge,{children:"Observações"}),e.jsx(qa,{value:a.observacoes,onChange:s=>r({...a,observacoes:s.target.value}),placeholder:"Observações",rows:2})]}),e.jsxs(J,{onClick:d,className:"w-full",disabled:l,children:[e.jsx(Ua,{className:"w-4 h-4 mr-2"}),l?"Criando...":"Criar e Adicionar"]})]})}function _o({receptorasLocais:a,onRemove:r,onUpdateCiclando:l,onUpdateQualidade:d}){return e.jsx("div",{className:"overflow-x-auto rounded-lg border border-border",children:e.jsxs("div",{className:"min-w-[700px] w-full",children:[e.jsxs("div",{className:"grid grid-cols-[minmax(160px,1.5fr)_36px_36px_36px_16px_90px_90px_minmax(100px,1fr)_40px] gap-0 bg-muted text-[10px] font-semibold text-muted-foreground uppercase tracking-wide",children:[e.jsx("div",{className:"px-3 py-2",children:"Receptora"}),e.jsx("div",{className:"px-1 py-2 text-center",title:"Protocolos",children:"P"}),e.jsx("div",{className:"px-1 py-2 text-center",title:"Gestações",children:"G"}),e.jsx("div",{className:"px-1 py-2 text-center",title:"Desde última",children:"D"}),e.jsx("div",{className:"border-r border-border/50"}),e.jsx("div",{className:"px-2 py-2 text-center",children:"Ciclando"}),e.jsx("div",{className:"px-2 py-2 text-center",children:"Qualidade"}),e.jsx("div",{className:"px-2 py-2",children:"Obs."}),e.jsx("div",{className:"px-2 py-2"})]}),a.map((s,n)=>{const g=s.id&&s.id.trim()!==""?s.id:`new-${n}`,u=s.historicoStats;return e.jsxs("div",{className:"group grid grid-cols-[minmax(160px,1.5fr)_36px_36px_36px_16px_90px_90px_minmax(100px,1fr)_40px] gap-0 items-center border-t border-border hover:bg-muted/50",children:[e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5",children:[e.jsx("span",{className:"flex items-center justify-center w-5 h-5 rounded-full bg-primary/10 text-primary text-[10px] font-bold shrink-0",children:n+1}),e.jsxs("div",{className:"flex flex-col min-w-0",children:[e.jsx("span",{className:"font-medium text-sm text-foreground truncate",children:s.identificacao}),s.nome&&e.jsx("span",{className:"text-[10px] text-muted-foreground truncate",children:s.nome})]})]}),e.jsx("div",{className:"px-1 py-1.5 text-center",children:e.jsx("span",{className:"inline-flex items-center justify-center w-6 h-5 text-[10px] font-medium bg-muted text-foreground rounded",children:(u==null?void 0:u.totalProtocolos)??0})}),e.jsx("div",{className:"px-1 py-1.5 text-center",children:e.jsx("span",{className:"inline-flex items-center justify-center w-6 h-5 text-[10px] font-medium bg-primary/15 text-primary rounded",children:(u==null?void 0:u.gestacoes)??0})}),e.jsx("div",{className:"px-1 py-1.5 text-center",children:e.jsx("span",{className:"inline-flex items-center justify-center w-6 h-5 text-[10px] font-medium bg-orange-500/15 text-orange-600 dark:text-orange-400 rounded",children:(u==null?void 0:u.protocolosDesdeUltimaGestacao)??0})}),e.jsx("div",{className:"border-r border-border/50 h-full"}),e.jsx("div",{className:"px-2 py-1 flex justify-center",children:e.jsx(Ma,{value:s.ciclando_classificacao,onChange:i=>l(n,i),variant:"editable"})}),e.jsx("div",{className:"px-2 py-1 flex justify-center",children:e.jsx($a,{value:s.qualidade_semaforo,onChange:i=>d(n,i),variant:"row"})}),e.jsx("div",{className:"px-2 py-1.5 text-xs text-muted-foreground truncate",children:s.observacoes||"-"}),e.jsx("div",{className:"px-1 py-1 flex justify-center",children:e.jsx(J,{variant:"ghost",size:"sm",className:"h-7 w-7 p-0 opacity-0 group-hover:opacity-100 transition-opacity",onClick:()=>r(n),children:e.jsx(Ae,{className:"w-4 h-4 text-muted-foreground hover:text-destructive"})})})]},g)})]})})}export{ts as default};
