import{f as k,r,s as m,j as e,a as q,B as p}from"./index-DmNymSE5.js";import{C as V,a as $,b as H,d as M}from"./card-SrkIpKk5.js";import{I as _}from"./input-CUsCheD8.js";import{L as n}from"./label-u6KawL_e.js";import{T as G}from"./textarea-BuM8ilf-.js";import{S as X,a as J,b as K,c as Q,d as U}from"./select-yD1hylSL.js";import{P as W,a as Y,b as Z}from"./popover-BabFSUJ1.js";import{C as ee,a as ae,b as se,c as F,d as ie,e as re}from"./command-DzSUBoEJ.js";import{B as te}from"./badge-BB9l9AxT.js";import{u as oe}from"./use-toast-8Wh80yTN.js";import{D as ne}from"./DatePickerBR-DL95UOFW.js";import{A as de}from"./arrow-left-4eR3Pk6r.js";import{S as ce}from"./search-52vUzEUy.js";import{X as le}from"./x-BKw_NAIH.js";import"./index-BoubMqWY.js";import"./index-C79PyqkA.js";import"./index-BMCBZPUE.js";import"./index-BMurdLVa.js";import"./check-D6LfuFSM.js";import"./dialog-j4QKUGZf.js";import"./calendar-u0e6cTgk.js";function Be(){const u=k(),{toast:d}=oe(),[E,j]=r.useState(!0),[f,g]=r.useState(!1),[z,w]=r.useState([]),h=r.useRef(0),[A,b]=r.useState([]),[B,v]=r.useState(!1),[T,N]=r.useState(!1),[s,t]=r.useState({fazenda_id:"",fazendas_destino_ids:[],data_aspiracao:new Date().toISOString().split("T")[0],horario_inicio:"",veterinario_responsavel:"",tecnico_responsavel:"",observacoes:""}),[c,C]=r.useState(""),D=c.trim(),I=D.length>=2,x=A.filter(a=>!s.fazendas_destino_ids.includes(a.id));r.useEffect(()=>{P()},[]),r.useEffect(()=>{const a=D;if(!a){b([]),v(!1);return}const i=++h.current;v(!0),m.from("fazendas").select("id, nome").ilike("nome",`%${a}%`).order("nome",{ascending:!0}).limit(50).then(({data:o,error:l})=>{i===h.current&&b(o||[])}).finally(()=>{i===h.current&&v(!1)})},[c]);const P=async()=>{try{j(!0);const{data:a,error:i}=await m.from("fazendas").select("id, nome").order("nome",{ascending:!0});if(i)throw i;w(a||[])}catch(a){d({title:"Erro ao carregar fazendas",description:a instanceof Error?a.message:"Erro desconhecido",variant:"destructive"})}finally{j(!1)}};r.useEffect(()=>{},[c,x.length]);const R=async a=>{if(a.preventDefault(),!s.fazenda_id||s.fazendas_destino_ids.length===0||!s.data_aspiracao){d({title:"Erro de validação",description:"Fazenda, pelo menos uma fazenda destino e data são obrigatórios",variant:"destructive"});return}if(!s.veterinario_responsavel.trim()){d({title:"Erro de validação",description:"Veterinário responsável é obrigatório",variant:"destructive"});return}if(!s.tecnico_responsavel.trim()){d({title:"Erro de validação",description:"Técnico responsável é obrigatório",variant:"destructive"});return}try{g(!0);const i=s.fazendas_destino_ids[0],o={fazenda_id:s.fazenda_id,fazenda_destino_id:i,data_aspiracao:s.data_aspiracao,horario_inicio:s.horario_inicio||null,veterinario_responsavel:s.veterinario_responsavel.trim(),tecnico_responsavel:s.tecnico_responsavel.trim(),observacoes:s.observacoes.trim()||null,status:"EM_ANDAMENTO"},{data:l,error:S}=await m.from("pacotes_aspiracao").insert([o]).select().single();if(S)throw S;const L=s.fazendas_destino_ids.map(O=>({pacote_aspiracao_id:l.id,fazenda_destino_id:O})),{error:y}=await m.from("pacotes_aspiracao_fazendas_destino").insert(L);if(y)throw y;d({title:"Aspiração criada",description:"Aspiração criada com sucesso"}),u(`/aspiracoes/${l.id}`)}catch(i){d({title:"Erro ao criar aspiração",description:i instanceof Error?i.message:"Erro desconhecido",variant:"destructive"})}finally{g(!1)}};return E?e.jsx(q,{}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(p,{onClick:()=>u("/aspiracoes"),variant:"outline",size:"icon",children:e.jsx(de,{className:"w-4 h-4"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-slate-900",children:"Nova Aspiração"}),e.jsx("p",{className:"text-slate-600 mt-1",children:"Criar nova aspiração"})]})]}),e.jsxs(V,{children:[e.jsx($,{children:e.jsx(H,{children:"Informações da Aspiração"})}),e.jsx(M,{children:e.jsxs("form",{onSubmit:R,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"fazenda_id",children:"Fazenda da Aspiração *"}),e.jsxs(X,{value:s.fazenda_id,onValueChange:a=>t({...s,fazenda_id:a}),children:[e.jsx(J,{children:e.jsx(K,{placeholder:"Selecione a fazenda"})}),e.jsx(Q,{children:z.map(a=>e.jsx(U,{value:a.id,children:a.nome},a.id))})]})]}),e.jsxs("div",{className:"space-y-2 col-span-2",children:[e.jsx(n,{children:"Fazendas Destino *"}),e.jsx("div",{className:"space-y-2",children:e.jsxs(W,{open:T,onOpenChange:a=>{N(a)},children:[e.jsx(Y,{asChild:!0,children:e.jsxs(p,{variant:"outline",className:"w-full justify-between",children:[c.trim()===""?"Buscar/selecionar fazenda destino":`Busca: ${c}`,e.jsx(ce,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(Z,{className:"w-[400px] p-0",align:"start",children:e.jsxs(ee,{shouldFilter:!1,children:[e.jsx(ae,{placeholder:"Buscar fazenda destino...",value:c,onValueChange:C}),e.jsx(se,{children:I?B?e.jsx("div",{className:"p-2 text-sm text-slate-500",children:"Buscando..."}):x.length===0?e.jsx(F,{children:"Nenhuma fazenda encontrada"}):e.jsx(ie,{children:x.map(a=>e.jsx(re,{value:`${a.nome} ${a.id}`,onSelect:()=>{s.fazendas_destino_ids.includes(a.id)||t({...s,fazendas_destino_ids:[...s.fazendas_destino_ids,a.id]}),C(""),N(!1)},children:a.nome},a.id))}):e.jsx(F,{children:"Digite pelo menos 2 letras para buscar"})})]})})]})}),s.fazendas_destino_ids.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:s.fazendas_destino_ids.map(a=>{const i=z.find(o=>o.id===a);return i?e.jsxs(te,{variant:"outline",className:"flex items-center gap-1 pr-1",children:[i.nome,e.jsx("button",{type:"button",onClick:o=>{o.preventDefault(),t({...s,fazendas_destino_ids:s.fazendas_destino_ids.filter(l=>l!==a)})},className:"ml-1 hover:bg-slate-200 rounded-full p-0.5",children:e.jsx(le,{className:"w-3 h-3"})})]},a):null})}),s.fazendas_destino_ids.length===0&&e.jsx("p",{className:"text-sm text-slate-500",children:"Selecione pelo menos uma fazenda destino"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"data_aspiracao",children:"Data da Aspiração *"}),e.jsx(ne,{id:"data_aspiracao",value:s.data_aspiracao,onChange:a=>t({...s,data_aspiracao:a||""}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"horario_inicio",children:"Horário de Início"}),e.jsx(_,{id:"horario_inicio",type:"time",value:s.horario_inicio,onChange:a=>t({...s,horario_inicio:a.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"veterinario_responsavel",children:"Veterinário Responsável *"}),e.jsx(_,{id:"veterinario_responsavel",value:s.veterinario_responsavel,onChange:a=>t({...s,veterinario_responsavel:a.target.value}),placeholder:"Nome do veterinário",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"tecnico_responsavel",children:"Técnico Responsável *"}),e.jsx(_,{id:"tecnico_responsavel",value:s.tecnico_responsavel,onChange:a=>t({...s,tecnico_responsavel:a.target.value}),placeholder:"Nome do técnico",required:!0})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"observacoes",children:"Observações"}),e.jsx(G,{id:"observacoes",value:s.observacoes,onChange:a=>t({...s,observacoes:a.target.value}),placeholder:"Observações sobre a aspiração",rows:3})]}),e.jsxs("div",{className:"flex gap-4 pt-4",children:[e.jsx(p,{type:"submit",className:"flex-1 bg-green-600 hover:bg-green-700",disabled:f,children:f?"Criando...":"Criar Aspiração"}),e.jsx(p,{type:"button",variant:"outline",onClick:()=>u("/aspiracoes"),disabled:f,children:"Cancelar"})]})]})})]})]})}export{Be as default};
