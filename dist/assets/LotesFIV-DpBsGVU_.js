import{r as d,s as l,y as Te,m as va,z as ja,a as ga,j as e,h as re,k as we,C as $a,E as ca,G as Ha,U as ma,g as ba,i as ka}from"./index-CvlUDCD-.js";import{u as Be,C as He,a as ke,b as Ve,c as Re}from"./use-toast-BhbfqK05.js";import{T as Je,a as Ke,b as ze,c as Z,d as We,e as G}from"./table-BAfLAU-a.js";import{S as ea,a as aa,b as sa,c as ta,d as oa,C as Va,e as Ra}from"./select-CRV7QsOQ.js";import{I as Oe}from"./input-BiDTc9_9.js";import{L as de}from"./label-BIMTC7_j.js";import{B as Ae}from"./badge-C6XBkHcG.js";import{P as Ua}from"./PageHeader-Don16aHL.js";import{E as Ca}from"./EmptyState-DFkj0E0i.js";import{h as ia}from"./error-handler-CiAOpFaY.js";import{T as Qa,a as Za,b as Ea,c as za}from"./tabs-DVZOasbN.js";import{D as pa,a as Ga,b as xa,c as ha,d as fa,e as ua}from"./dialog-DSJKtNd7.js";import{T as La}from"./textarea-CWzGJoHk.js";import{P as qa}from"./plus-BqMf1Hqu.js";import{A as Xa}from"./arrow-left-DavZAJTM.js";import{F as Ya}from"./file-text-Bqoui6Pg.js";import{P as _a}from"./package-L5ylPkNI.js";import{D as Aa}from"./DatePickerBR-gAx3gAQT.js";import{X as Ia}from"./x-DpiajgWI.js";import{S as Ja}from"./search-B2NaMPhp.js";import{E as Ka}from"./eye-DdmlOBU3.js";import"./index-BYe3zTS0.js";import"./index-CDlvsNjp.js";import"./check-BbN618wW.js";import"./index-Mm2kbPk7.js";import"./popover-D6dVxm31.js";function la(a){return{[-1]:"Aspira√ß√£o",0:"Fecunda√ß√£o",1:"Zigoto",2:"Clivagem",3:"Clivagem Avan√ßada",4:"Compacta√ß√£o",5:"M√≥rula / Blastocisto Inicial",6:"Blastocisto",7:"Blastocisto Expandido",8:"Resgate / Sa√≠da Tardia"}[a]||`Dia ${a}`}function Wa(a){return a===-1?"bg-blue-100 text-blue-800 border-blue-300":a===0?"bg-green-100 text-green-800 border-green-300":a>=1&&a<=3?"bg-yellow-100 text-yellow-800 border-yellow-300":a>=4&&a<=5||a===6?"bg-orange-100 text-orange-800 border-orange-300":a===7?"bg-purple-100 text-purple-800 border-purple-300":a===8?"bg-red-100 text-red-800 border-red-300":"bg-slate-100 text-slate-800 border-slate-300"}const Oa="lotes_fiv_filtros";function es(){try{const a=localStorage.getItem(Oa);return a?JSON.parse(a):{}}catch{return{}}}function as(a){try{localStorage.setItem(Oa,JSON.stringify(a))}catch{}}const ya=8;function ss(a){return a===0?-1:a>9?8:a-1}function Fa({lotes:a,pacotesParaFiltro:O,fazendasAspiracaoUnicas:i,lotesHistoricos:$}){const[n]=d.useState(()=>es()),[x,f]=d.useState(n.filtroFazendaAspiracao??""),[S,W]=d.useState(n.filtroFazendaAspiracaoBusca??""),[_,R]=d.useState(n.filtroDiaCultivo??""),[w,X]=d.useState(!1),[K,Y]=d.useState(n.filtroHistoricoDataInicio??""),[ee,b]=d.useState(n.filtroHistoricoDataFim??""),[se,v]=d.useState(n.filtroHistoricoFazenda??""),[V,E]=d.useState(n.filtroHistoricoFazendaBusca??""),[C,L]=d.useState(!1),[h,m]=d.useState(n.abaAtiva??"ativos"),[U,q]=d.useState(n.historicoPage??1);d.useEffect(()=>{as({abaAtiva:h,filtroFazendaAspiracao:x,filtroFazendaAspiracaoBusca:S,filtroDiaCultivo:_,filtroHistoricoDataInicio:K,filtroHistoricoDataFim:ee,filtroHistoricoFazenda:se,filtroHistoricoFazendaBusca:V,historicoPage:U})},[h,x,S,_,K,ee,se,V,U]),d.useEffect(()=>{q(1)},[K,ee,se]),d.useEffect(()=>{const o=Math.max(1,Math.ceil($.length/ya));U>o&&q(o)},[$.length,U]),d.useEffect(()=>{const o=r=>{const j=r.target;j.closest(".fazenda-busca-container")||X(!1),j.closest(".fazenda-busca-historico-container")||L(!1)};if(w||C)return document.addEventListener("mousedown",o),()=>{document.removeEventListener("mousedown",o)}},[w,C]);const u=d.useMemo(()=>{let o=[...a];if(o=o.filter(r=>r.status==="FECHADO"||r.dia_atual!==void 0&&r.dia_atual>9?!1:r.dia_atual!==void 0&&r.dia_atual<=9),x&&(o=o.filter(r=>{const j=O.find(T=>T.id===r.pacote_aspiracao_id);return(j==null?void 0:j.fazenda_id)===x})),_!==""){const r=parseInt(_);o=o.filter(j=>j.dia_atual===void 0||j.dia_atual===null?!1:(j.dia_atual===0?-1:j.dia_atual-1)===r)}return o},[a,x,_,O]),N=d.useMemo(()=>i.filter(o=>o.nome.toLowerCase().includes(S.toLowerCase())),[i,S]);return{filtroFazendaAspiracao:x,setFiltroFazendaAspiracao:f,filtroFazendaAspiracaoBusca:S,setFiltroFazendaAspiracaoBusca:W,filtroDiaCultivo:_,setFiltroDiaCultivo:R,showFazendaBusca:w,setShowFazendaBusca:X,fazendasFiltradas:N,lotesFiltrados:u,limparFiltrosAtivos:()=>{f(""),W(""),R(""),X(!1)},filtroHistoricoDataInicio:K,setFiltroHistoricoDataInicio:Y,filtroHistoricoDataFim:ee,setFiltroHistoricoDataFim:b,filtroHistoricoFazenda:se,setFiltroHistoricoFazenda:v,filtroHistoricoFazendaBusca:V,setFiltroHistoricoFazendaBusca:E,showFazendaBuscaHistorico:C,setShowFazendaBuscaHistorico:L,limparFiltrosHistorico:()=>{Y(""),b(""),v(""),E(""),L(!1),q(1)},abaAtiva:h,setAbaAtiva:m,historicoPage:U,setHistoricoPage:q,HISTORICO_PAGE_SIZE:ya}}function ts(){const{toast:a}=Be(),[O,i]=d.useState([]),[$,n]=d.useState([]),[x,f]=d.useState([]),[S,W]=d.useState([]),[_,R]=d.useState([]),[w,X]=d.useState(!0),[K,Y]=d.useState([]),[ee,b]=d.useState([]),se=d.useCallback(async()=>{try{X(!0);const{data:v,error:V}=await l.from("pacotes_aspiracao").select("*").eq("status","FINALIZADO").order("data_aspiracao",{ascending:!1});if(V)throw V;const{data:E,error:C}=await l.from("fazendas").select("id, nome").order("nome",{ascending:!0});if(C)throw C;f(E||[]);const{data:L,error:h}=await l.from("clientes").select("id, nome").order("nome",{ascending:!0});h||R(L||[]);const m=new Map(E==null?void 0:E.map(t=>[t.id,t.nome])),U=new Map,q=new Map,u=(v==null?void 0:v.map(t=>t.id))||[];if(u.length>0){const{data:t,error:z}=await l.from("pacotes_aspiracao_fazendas_destino").select("pacote_aspiracao_id, fazenda_destino_id").in("pacote_aspiracao_id",u);!z&&t&&t.forEach(Q=>{const ce=m.get(Q.fazenda_destino_id);if(ce){const ve=U.get(Q.pacote_aspiracao_id)||[];ve.push(ce),U.set(Q.pacote_aspiracao_id,ve)}});const{data:M,error:F}=await l.from("aspiracoes_doadoras").select("pacote_aspiracao_id").in("pacote_aspiracao_id",u);!F&&M&&M.forEach(Q=>{Q.pacote_aspiracao_id&&q.set(Q.pacote_aspiracao_id,(q.get(Q.pacote_aspiracao_id)||0)+1)})}const{data:N,error:D}=await l.from("lotes_fiv").select("*").order("data_abertura",{ascending:!1});if(D)throw D;const I=new Set((N==null?void 0:N.map(t=>t.pacote_aspiracao_id).filter(t=>!!t))||[]),r=(v||[]).filter(t=>t.usado_em_lote_fiv!==void 0?!t.usado_em_lote_fiv:!I.has(t.id)).map(t=>({...t,fazenda_nome:m.get(t.fazenda_id),fazendas_destino_nomes:U.get(t.id)||[],quantidade_doadoras:q.get(t.id)||0}));n(r);const j=(N==null?void 0:N.map(t=>t.id))||[],{data:T,error:A}=await l.from("lote_fiv_acasalamentos").select("lote_fiv_id").in("lote_fiv_id",j);if(A)throw A;const H=new Map;T==null||T.forEach(t=>{H.set(t.lote_fiv_id,(H.get(t.lote_fiv_id)||0)+1)});const{data:k,error:B}=await l.from("lote_fiv_fazendas_destino").select("lote_fiv_id, fazenda_id").in("lote_fiv_id",j);if(B)throw B;const s=new Map;k==null||k.forEach(t=>{const z=m.get(t.fazenda_id);if(z){const M=s.get(t.lote_fiv_id)||[];M.push(z),s.set(t.lote_fiv_id,M)}});const c=new Map(r.map(t=>[t.id,t]));(v||[]).forEach(t=>{c.has(t.id)||c.set(t.id,{...t,fazenda_nome:m.get(t.fazenda_id),fazendas_destino_nomes:U.get(t.id)||[],quantidade_doadoras:q.get(t.id)||0})});const y=(N||[]).map(t=>{const z=c.get(t.pacote_aspiracao_id);let M=Te((z==null?void 0:z.data_aspiracao)||null);if(!M){const ce=Te(t.data_abertura);if(ce){const[ve,he,Se]=ce.split("-").map(Number),me=new Date(ve,he-1,Se);me.setDate(me.getDate()-1);const je=me.getFullYear(),fe=String(me.getMonth()+1).padStart(2,"0"),De=String(me.getDate()).padStart(2,"0");M=`${je}-${fe}-${De}`}}const F=va(),Q=M?Math.max(0,ja(F,M)):0;return{...t,pacote_nome:z==null?void 0:z.fazenda_nome,pacote_data:z==null?void 0:z.data_aspiracao,fazendas_destino_nomes:s.get(t.id)||[],quantidade_acasalamentos:H.get(t.id)||0,dia_atual:Q}}),J=y.filter(t=>t.status==="ABERTO"&&t.dia_atual!==void 0&&t.dia_atual>9);if(J.length>0){const t=J.map(z=>z.id);l.from("lotes_fiv").update({status:"FECHADO"}).in("id",t).then(({error:z})=>{z&&a({title:"Aviso",description:"N√£o foi poss√≠vel fechar automaticamente alguns lotes expirados. Recarregue a p√°gina.",variant:"destructive"})})}i(y);const te=new Set(y.map(t=>t.pacote_aspiracao_id).filter(t=>!!t)),ne=[];(v||[]).forEach(t=>{te.has(t.id)&&ne.push({...t,fazenda_nome:m.get(t.fazenda_id),fazendas_destino_nomes:U.get(t.id)||[],quantidade_doadoras:q.get(t.id)||0})}),Y(ne);const xe=new Map;ne.forEach(t=>{t.fazenda_id&&t.fazenda_nome&&xe.set(t.fazenda_id,t.fazenda_nome)}),b(Array.from(xe.entries()).map(([t,z])=>({id:t,nome:z})).sort((t,z)=>t.nome.localeCompare(z.nome)))}catch(v){ia(v,"Erro ao carregar dados")}finally{X(!1)}},[a]);return{lotes:O,pacotes:$,fazendas:x,setFazendas:f,doadoras:S,setDoadoras:W,clientes:_,setClientes:R,loading:w,setLoading:X,pacotesParaFiltro:K,fazendasAspiracaoUnicas:ee,loadData:se}}function os({setFazendas:a,setDoadoras:O,setClientes:i,setLoading:$}){const{toast:n}=Be(),[x,f]=d.useState(null),[S,W]=d.useState(!1),[_,R]=d.useState([]),[w,X]=d.useState([]),[K,Y]=d.useState([]),[ee,b]=d.useState([]),[se,v]=d.useState([]),[V,E]=d.useState(""),[C,L]=d.useState([]),[h,m]=d.useState([]),[U,q]=d.useState(""),u=d.useCallback(async D=>{try{const{data:I,error:o}=await l.from("embrioes").select("id, lote_fiv_acasalamento_id, created_at").eq("lote_fiv_id",D).order("created_at",{ascending:!1});if(o){Y([]);return}const r=new Map;I==null||I.forEach(A=>{if(A.created_at){const H=A.created_at.split("T")[0],k=r.get(H)||[];k.push(A),r.set(H,k)}});const j=[...new Set((I==null?void 0:I.map(A=>A.lote_fiv_acasalamento_id).filter(Boolean))||[])];if(j.length>0){const{data:A,error:H}=await l.from("lote_fiv_acasalamentos").select("id, aspiracao_doadora_id, dose_semen_id").in("id",j);if(!H&&A){const k=[...new Set(A.map(F=>F.aspiracao_doadora_id).filter(Boolean))],{data:B}=await l.from("aspiracoes_doadoras").select("id, doadora_id").in("id",k),s=[...new Set((B==null?void 0:B.map(F=>F.doadora_id).filter(Boolean))||[])],{data:c}=await l.from("doadoras").select("id, registro, nome").in("id",s),y=[...new Set(A.map(F=>F.dose_semen_id).filter(Boolean))],{data:J}=await l.from("doses_semen").select("id, touro_id, touro:touros(id, nome, registro, raca)").in("id",y),te=new Map((B==null?void 0:B.map(F=>[F.id,F]))||[]),ne=new Map((c==null?void 0:c.map(F=>[F.id,F]))||[]),xe=new Map((J==null?void 0:J.map(F=>[F.id,F]))||[]),t=new Map(A.map(F=>[F.id,F])),M=Array.from(r.keys()).sort((F,Q)=>Q.localeCompare(F)).map(F=>{const Q=r.get(F)||[],ce=new Map;Q.forEach(he=>{he.lote_fiv_acasalamento_id&&ce.set(he.lote_fiv_acasalamento_id,(ce.get(he.lote_fiv_acasalamento_id)||0)+1)});const ve=Array.from(ce.entries()).map(([he,Se])=>{var Ce;const me=t.get(he),je=me?te.get(me.aspiracao_doadora_id):void 0,fe=je?ne.get(je.doadora_id):void 0,De=me?xe.get(me.dose_semen_id):void 0;return{acasalamento_id:he,quantidade:Se,doadora:(fe==null?void 0:fe.registro)||(fe==null?void 0:fe.nome)||"-",dose:De?((Ce=De.touro)==null?void 0:Ce.nome)||"Touro desconhecido":"-"}});return{id:`${D}-${F}`,data_despacho:F,acasalamentos:ve}});Y(M);return}}const T=Array.from(r.keys()).map(A=>({id:`${D}-${A}`,data_despacho:A,acasalamentos:[]}));Y(T)}catch{Y([])}},[]),N=d.useCallback(async D=>{try{$(!0);const{data:I,error:o}=await l.from("lotes_fiv").select("*").eq("id",D).single();if(o)throw o;const{data:r,error:j}=await l.from("pacotes_aspiracao").select("*").eq("id",I.pacote_aspiracao_id).single();if(j){if(j.code==="PGRST116"){n({title:"Pacote n√£o encontrado",description:"O lote referencia um pacote de aspira√ß√£o inexistente. Verifique o v√≠nculo do lote.",variant:"destructive"}),$(!1);return}throw j}q(r.data_aspiracao);const{data:T,error:A}=await l.from("fazendas").select("nome").eq("id",r.fazenda_id).single();E(A?"":(T==null?void 0:T.nome)||"");const{data:H}=await l.from("pacotes_aspiracao_fazendas_destino").select("fazenda_destino_id").eq("pacote_aspiracao_id",r.id);let k=[];if(!H||H.length===0?r.fazenda_destino_id&&(k=[r.fazenda_destino_id]):k=H.map(g=>g.fazenda_destino_id),X(k),k.length>0){const{data:g,error:ue}=await l.from("fazendas").select("id, nome").in("id",k);ue?L([]):(L((g==null?void 0:g.map(le=>le.nome))||[]),g&&a(le=>{const _e=[...le];return g.forEach(ae=>{_e.find(ge=>ge.id===ae.id)||_e.push(ae)}),_e}))}else L([]);const{data:B,error:s}=await l.from("lote_fiv_acasalamentos").select("*").eq("lote_fiv_id",D).order("created_at",{ascending:!0});if(s)throw s;const c=(B==null?void 0:B.map(g=>g.aspiracao_doadora_id))||[],{data:y,error:J}=await l.from("aspiracoes_doadoras").select("id, doadora_id, viaveis").in("id",c);if(J)throw J;const te=[...new Set((y==null?void 0:y.map(g=>g.doadora_id))||[])],{data:ne,error:xe}=await l.from("doadoras").select("id, nome, registro").in("id",te);if(xe)throw xe;const t=[...new Set((B==null?void 0:B.map(g=>g.dose_semen_id))||[])],{data:z,error:M}=await l.from("doses_semen").select("id, touro_id, touro:touros(id, nome, registro, raca)").in("id",t);if(M)throw M;const F=new Map(ne==null?void 0:ne.map(g=>[g.id,g])),Q=new Map(z==null?void 0:z.map(g=>[g.id,g])),ce=new Map(y==null?void 0:y.map(g=>[g.id,g])),{data:ve,error:he}=await l.from("embrioes").select("lote_fiv_acasalamento_id").eq("lote_fiv_id",D),Se=new Map;!he&&ve&&ve.forEach(g=>{g.lote_fiv_acasalamento_id&&Se.set(g.lote_fiv_acasalamento_id,(Se.get(g.lote_fiv_acasalamento_id)||0)+1)});const me=(B||[]).map(g=>{const ue=ce.get(g.aspiracao_doadora_id),le=ue?F.get(ue.doadora_id):void 0,_e=Q.get(g.dose_semen_id),ae=(_e==null?void 0:_e.touro)??null;return{...g,doadora_nome:(le==null?void 0:le.nome)||(le==null?void 0:le.registro),doadora_registro:le==null?void 0:le.registro,dose_nome:(ae==null?void 0:ae.nome)||"Touro desconhecido",viaveis:ue==null?void 0:ue.viaveis,total_embrioes_produzidos:Se.get(g.id)||0}});R(me),f({...I,pacote_nome:r.fazenda_id,pacote_data:r.data_aspiracao}),W(!0);const{data:je,error:fe}=await l.from("aspiracoes_doadoras").select("id, doadora_id, viaveis").eq("pacote_aspiracao_id",I.pacote_aspiracao_id);if(!fe){const g=new Map;B==null||B.forEach(ae=>{const ge=ae.aspiracao_doadora_id,p=ae.quantidade_oocitos||0;g.set(ge,(g.get(ge)||0)+p)});const le=(je||[]).filter(ae=>{const ge=ae.viaveis??0,p=g.get(ae.id)||0,ie=ge-p;return ge>0&&ie>0}).map(ae=>({...ae,oocitos_disponiveis:(ae.viaveis??0)-(g.get(ae.id)||0)}));b(le);const _e=[...new Set((je==null?void 0:je.map(ae=>ae.doadora_id))||[])];if(_e.length>0){const{data:ae,error:ge}=await l.from("doadoras").select("id, nome, registro").in("id",_e);!ge&&ae&&O(ae)}}const{data:De,error:Ce}=await l.from("doses_semen").select("id, touro_id, cliente_id, tipo_semen, quantidade, touro:touros(id, nome, registro, raca)").order("created_at",{ascending:!1});if(Ce)v([]);else try{const g=I==null?void 0:I.doses_selecionadas;g&&Array.isArray(g)&&g.length>0?v((De||[]).filter(ue=>g.includes(ue.id))):v(De||[])}catch{v(De||[])}const{data:ra,error:na}=await l.from("clientes").select("id, nome").order("nome",{ascending:!0});na||i(ra||[]),await u(D)}catch(I){ia(I,"Erro ao carregar detalhes do lote")}finally{$(!1)}},[n,u,a,O,i,$]);return{selectedLote:x,setSelectedLote:f,showLoteDetail:S,setShowLoteDetail:W,acasalamentos:_,setAcasalamentos:R,fazendasDestinoIds:w,historicoDespachos:K,setHistoricoDespachos:Y,aspiracoesDisponiveis:ee,dosesDisponiveis:se,fazendaOrigemNome:V,fazendasDestinoNomes:C,dosesDisponiveisNoLote:h,dataAspiracao:U,loadLoteDetail:N,loadHistoricoDespachos:u}}function is({filtroHistoricoDataInicio:a,filtroHistoricoDataFim:O,filtroHistoricoFazenda:i,setHistoricoPage:$}){const{toast:n}=Be(),[x,f]=d.useState([]),[S,W]=d.useState(!1),[_,R]=d.useState(null),[w,X]=d.useState(null),[K,Y]=d.useState(!1),ee=d.useCallback(async()=>{try{W(!0),$(1);let v=l.from("lotes_fiv").select("*").eq("status","FECHADO");a&&(v=v.gte("data_abertura",a)),O&&(v=v.lte("data_abertura",O));const{data:V,error:E}=await v.order("data_abertura",{ascending:!1});if(E)throw E;if(!V||V.length===0){f([]),W(!1);return}const C=V.map(s=>s.id),L=[...new Set(V.map(s=>s.pacote_aspiracao_id).filter(Boolean))],{data:h}=await l.from("pacotes_aspiracao").select("id, data_aspiracao, fazenda_id, total_oocitos").in("id",L),{data:m}=await l.from("fazendas").select("id, nome").order("nome",{ascending:!0}),U=new Map((m==null?void 0:m.map(s=>[s.id,s.nome]))||[]),q=(m==null?void 0:m.map(s=>({id:s.id,nome:s.nome})))||[],{data:u}=await l.from("lote_fiv_acasalamentos").select("id, lote_fiv_id, quantidade_embrioes, aspiracao_doadora_id").in("lote_fiv_id",C),{data:N,error:D}=await l.from("embrioes").select("id, lote_fiv_id, lote_fiv_acasalamento_id, classificacao, status_atual").in("lote_fiv_id",C);D&&n({title:"Erro ao buscar embri√µes",description:D.message,variant:"destructive"});const{data:I}=await l.from("lote_fiv_fazendas_destino").select("lote_fiv_id, fazenda_id").in("lote_fiv_id",C),o=[...new Set((u==null?void 0:u.map(s=>s.aspiracao_doadora_id).filter(Boolean))||[])],{data:r}=await l.from("aspiracoes_doadoras").select("id, viaveis").in("id",o),j=new Map((h==null?void 0:h.map(s=>[s.id,s]))||[]),T=new Map,A=new Map,H=new Map,k=new Map((r==null?void 0:r.map(s=>[s.id,s]))||[]);u==null||u.forEach(s=>{T.has(s.lote_fiv_id)||T.set(s.lote_fiv_id,[]),T.get(s.lote_fiv_id).push(s)}),N&&N.length>0&&N.forEach(s=>{s.lote_fiv_id&&(A.has(s.lote_fiv_id)||A.set(s.lote_fiv_id,[]),A.get(s.lote_fiv_id).push(s))}),I==null||I.forEach(s=>{H.has(s.lote_fiv_id)||H.set(s.lote_fiv_id,[]);const c=U.get(s.fazenda_id);c&&H.get(s.lote_fiv_id).push(c)});let B=V.map(s=>{const c=j.get(s.pacote_aspiracao_id),y=T.get(s.id)||[],J=A.get(s.id)||[],te=H.get(s.id)||[],ne=J.length,xe=J.filter(Q=>Q.status_atual==="TRANSFERIDO").length,t=J.filter(Q=>Q.status_atual==="CONGELADO").length,z=J.filter(Q=>Q.status_atual==="DESCARTADO").length,M={};J.forEach(Q=>{Q.classificacao?M[Q.classificacao]=(M[Q.classificacao]||0)+1:M.sem_classificacao=(M.sem_classificacao||0)+1});let F=0;return y.forEach(Q=>{if(Q.aspiracao_doadora_id){const ce=k.get(Q.aspiracao_doadora_id);ce!=null&&ce.viaveis&&(F+=ce.viaveis)}}),{id:s.id,data_abertura:s.data_abertura,status:s.status,observacoes:s.observacoes,pacote_aspiracao_id:s.pacote_aspiracao_id,pacote_data:c==null?void 0:c.data_aspiracao,pacote_nome:U.get((c==null?void 0:c.fazenda_id)||""),fazenda_origem_nome:U.get((c==null?void 0:c.fazenda_id)||""),fazendas_destino_nomes:te,quantidade_acasalamentos:y.length,total_embrioes_produzidos:ne,total_embrioes_transferidos:xe,total_embrioes_congelados:t,total_embrioes_descartados:z,embrioes_por_classificacao:{BE:M.BE,BN:M.BN,BX:M.BX,BL:M.BL,BI:M.BI,sem_classificacao:M.sem_classificacao},total_oocitos:c==null?void 0:c.total_oocitos,total_viaveis:F>0?F:void 0}});if(i){const s=q.find(c=>c.id===i);s&&(B=B.filter(c=>c.fazenda_origem_nome===s.nome))}f(B)}catch(v){ia(v,"Erro ao carregar hist√≥rico")}finally{W(!1)}},[a,O,i,$,n]),b=d.useCallback(async v=>{try{Y(!0);const V=x.find(o=>o.id===v);if(!V){n({title:"Erro",description:"Lote n√£o encontrado",variant:"destructive"});return}const{data:E}=await l.from("pacotes_aspiracao").select("*").eq("id",V.pacote_aspiracao_id).single(),{data:C}=await l.from("lote_fiv_acasalamentos").select("*").eq("lote_fiv_id",v).order("created_at",{ascending:!0}),{data:L}=await l.from("embrioes").select("*").eq("lote_fiv_id",v).order("created_at",{ascending:!0}),h=[...new Set((C==null?void 0:C.map(o=>o.aspiracao_doadora_id).filter(Boolean))||[])],{data:m}=await l.from("aspiracoes_doadoras").select("*, doadora:doadoras(id, registro, nome)").in("id",h),U=[...new Set((C==null?void 0:C.map(o=>o.dose_semen_id).filter(Boolean))||[])],{data:q}=await l.from("doses_semen").select("*, cliente:clientes(nome), touro:touros(id, nome, registro, raca)").in("id",U),u=new Map((m==null?void 0:m.map(o=>[o.id,o]))||[]),N=new Map((q==null?void 0:q.map(o=>[o.id,o]))||[]),D=new Map;(L||[]).forEach(o=>{const r=o.lote_fiv_acasalamento_id||"sem_acasalamento";D.has(r)||D.set(r,{total:0,porStatus:{},porClassificacao:{}});const j=D.get(r);j.total++;const T=o.status_atual||"sem_status";j.porStatus[T]=(j.porStatus[T]||0)+1;const A=o.classificacao||"sem_classificacao";j.porClassificacao[A]=(j.porClassificacao[A]||0)+1});const I={lote:V,pacote:E?{id:E.id,data_aspiracao:E.data_aspiracao,horario_inicio:E.horario_inicio,horario_final:E.horario_final,veterinario_responsavel:E.veterinario_responsavel,tecnico_responsavel:E.tecnico_responsavel,total_oocitos:E.total_oocitos,observacoes:E.observacoes}:void 0,acasalamentos:(C||[]).map(o=>{var H,k,B,s;const r=o.aspiracao_doadora_id?u.get(o.aspiracao_doadora_id):null,j=o.dose_semen_id?N.get(o.dose_semen_id):null,T=r==null?void 0:r.doadora,A=D.get(o.id)||{total:0,porStatus:{},porClassificacao:{}};return{id:o.id,aspiracao_id:o.aspiracao_doadora_id,doadora:T?{registro:T.registro,nome:T.nome}:void 0,aspiracao:r?{data_aspiracao:r.data_aspiracao,horario_aspiracao:r.horario_aspiracao,viaveis:r.viaveis,expandidos:r.expandidos,total_oocitos:r.total_oocitos,atresicos:r.atresicos,degenerados:r.degenerados,desnudos:r.desnudos,veterinario_responsavel:r.veterinario_responsavel}:void 0,dose_semen:j?{nome:((H=j.touro)==null?void 0:H.nome)||"Touro desconhecido",registro:(k=j.touro)==null?void 0:k.registro,raca:((B=j.touro)==null?void 0:B.raca)||j.raca,tipo_semen:j.tipo_semen,cliente:(s=j.cliente)==null?void 0:s.nome}:void 0,quantidade_fracionada:o.quantidade_fracionada,quantidade_oocitos:o.quantidade_oocitos,quantidade_embrioes:o.quantidade_embrioes,observacoes:o.observacoes,resumo_embrioes:A}}),embrioes:(L||[]).map(o=>({id:o.id,identificacao:o.identificacao,classificacao:o.classificacao,tipo_embriao:o.tipo_embriao,status_atual:o.status_atual,acasalamento_id:o.lote_fiv_acasalamento_id}))};X(I)}catch(V){ia(V,"Erro ao carregar detalhes")}finally{Y(!1)}},[x,n]),se=d.useCallback(async v=>{_===v?(R(null),X(null)):(R(v),await b(v))},[_,b]);return{lotesHistoricos:x,loadingHistorico:S,loteExpandido:_,detalhesLoteExpandido:w,loadingDetalhes:K,loadLotesHistoricos:ee,handleExpandirLote:se}}function rs({id:a,filtroHistoricoDataInicio:O,filtroHistoricoDataFim:i,filtroHistoricoFazenda:$,setHistoricoPage:n}){const x=ts(),f=os({setFazendas:x.setFazendas,setDoadoras:x.setDoadoras,setClientes:x.setClientes,setLoading:x.setLoading}),S=is({filtroHistoricoDataInicio:O,filtroHistoricoDataFim:i,filtroHistoricoFazenda:$,setHistoricoPage:n});return d.useEffect(()=>{a?f.loadLoteDetail(a):x.loadData()},[a,x.loadData,f.loadLoteDetail]),{lotes:x.lotes,pacotes:x.pacotes,fazendas:x.fazendas,setFazendas:x.setFazendas,doadoras:x.doadoras,clientes:x.clientes,loading:x.loading,selectedLote:f.selectedLote,setSelectedLote:f.setSelectedLote,showLoteDetail:f.showLoteDetail,setShowLoteDetail:f.setShowLoteDetail,acasalamentos:f.acasalamentos,setAcasalamentos:f.setAcasalamentos,fazendasDestinoIds:f.fazendasDestinoIds,historicoDespachos:f.historicoDespachos,setHistoricoDespachos:f.setHistoricoDespachos,aspiracoesDisponiveis:f.aspiracoesDisponiveis,dosesDisponiveis:f.dosesDisponiveis,fazendaOrigemNome:f.fazendaOrigemNome,fazendasDestinoNomes:f.fazendasDestinoNomes,dosesDisponiveisNoLote:f.dosesDisponiveisNoLote,dataAspiracao:f.dataAspiracao,pacotesParaFiltro:x.pacotesParaFiltro,fazendasAspiracaoUnicas:x.fazendasAspiracaoUnicas,lotesHistoricos:S.lotesHistoricos,loadingHistorico:S.loadingHistorico,loteExpandido:S.loteExpandido,detalhesLoteExpandido:S.detalhesLoteExpandido,loadingDetalhes:S.loadingDetalhes,loadData:x.loadData,loadLoteDetail:f.loadLoteDetail,loadLotesHistoricos:S.loadLotesHistoricos,handleExpandirLote:S.handleExpandirLote}}function ns({pacotes:a,clientes:O,fazendas:i}){var h;const $=ga(),{toast:n}=Be(),[x,f]=d.useState(!1),[S,W]=d.useState(!1),[_,R]=d.useState({pacote_aspiracao_id:"",observacoes:"",doses_selecionadas:[]}),[w,X]=d.useState(null),[K,Y]=d.useState([]),[ee,b]=d.useState([]),[se,v]=d.useState([]),V=async m=>{R({..._,pacote_aspiracao_id:m});const U=a.find(q=>q.id===m);if(X(U||null),U){const{data:q,error:u}=await l.from("aspiracoes_doadoras").select("id, doadora_id, viaveis").eq("pacote_aspiracao_id",m);if(u)return;b(q||[]);const N=[...new Set((q==null?void 0:q.map(o=>o.doadora_id))||[])];if(N.length>0){const{data:o,error:r}=await l.from("doadoras").select("id, nome, registro").in("id",N);if(r)return;v(o||[])}const{data:D,error:I}=await l.from("doses_semen").select("id, cliente_id, touro_id, tipo_semen, quantidade, touro:touros(id, nome, registro, raca)").order("created_at",{ascending:!1});if(I)return;Y(D||[])}},E=async m=>{var U,q;if(m.preventDefault(),!_.pacote_aspiracao_id){n({title:"Erro de valida√ß√£o",description:"Pacote de aspira√ß√£o √© obrigat√≥rio",variant:"destructive"});return}if(!w){n({title:"Erro de valida√ß√£o",description:"Pacote selecionado n√£o encontrado",variant:"destructive"});return}try{W(!0);const{data:u,error:N}=await l.from("pacotes_aspiracao").select("id, status").eq("id",_.pacote_aspiracao_id).single();if(N||!u){n({title:"Erro de valida√ß√£o",description:"Pacote de aspira√ß√£o n√£o encontrado ou inv√°lido",variant:"destructive"});return}if(u.status!=="FINALIZADO"){n({title:"Erro de valida√ß√£o",description:"Apenas pacotes FINALIZADOS podem ser usados para criar lotes FIV",variant:"destructive"});return}const D=new Date(w.data_aspiracao);D.setDate(D.getDate()+1);const I=D.toISOString().split("T")[0],o={pacote_aspiracao_id:_.pacote_aspiracao_id,data_abertura:I,data_fecundacao:I,status:"ABERTO",observacoes:_.observacoes||null};if(_.doses_selecionadas&&_.doses_selecionadas.length>0)try{o.doses_selecionadas=_.doses_selecionadas}catch{}let r;const{data:j,error:T}=await l.from("lotes_fiv").insert([o]).select().single();if(T)if((U=T.message)!=null&&U.includes("doses_selecionadas")||T.code==="42703"){delete o.doses_selecionadas;const{data:H,error:k}=await l.from("lotes_fiv").insert([o]).select().single();if(k)throw k;r=H}else throw T;else r=j;const A=(q=w.fazendas_destino_nomes)==null?void 0:q.map(H=>{const k=i.find(B=>B.nome===H);return k==null?void 0:k.id}).filter(H=>!!H);if(A&&A.length>0){const{error:H}=await l.from("lote_fiv_fazendas_destino").insert(A.map(k=>({lote_fiv_id:r.id,fazenda_id:k})));if(H)throw H}try{await l.from("pacotes_aspiracao").update({usado_em_lote_fiv:!0}).eq("id",_.pacote_aspiracao_id)}catch{}n({title:"Lote FIV criado",description:"Lote FIV criado com sucesso. Agora voc√™ pode adicionar acasalamentos."}),f(!1),C(),$(`/lotes-fiv/${r.id}`)}catch(u){const N=u instanceof Error?u.message:"Erro desconhecido";n({title:"Erro ao criar lote",description:N.includes("RLS")||N.includes("policy")?"RLS est√° bloqueando escrita. Configure pol√≠ticas anon no Supabase.":N,variant:"destructive"})}finally{W(!1)}},C=()=>{R({pacote_aspiracao_id:"",observacoes:"",doses_selecionadas:[]}),X(null),b([]),v([]),Y([])},L=()=>{f(!1),C()};return e.jsxs(pa,{open:x,onOpenChange:f,children:[e.jsx(Ga,{asChild:!0,children:e.jsxs(re,{className:"bg-green-600 hover:bg-green-700",children:[e.jsx(qa,{className:"w-4 h-4 mr-2"}),"Novo Lote"]})}),e.jsxs(xa,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(ha,{children:[e.jsx(fa,{children:"Criar Novo Lote FIV"}),e.jsx(ua,{children:"Selecione um pacote de aspira√ß√£o FINALIZADO para criar o lote"})]}),e.jsxs("form",{onSubmit:E,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(de,{htmlFor:"pacote_aspiracao_id",children:"Pacote de Aspira√ß√£o *"}),a.length===0?e.jsxs("div",{className:"border rounded-lg p-4 bg-yellow-50 border-yellow-200",children:[e.jsx("p",{className:"text-sm text-yellow-800 font-medium mb-2",children:"Nenhum pacote dispon√≠vel"}),e.jsxs("p",{className:"text-sm text-yellow-700",children:["Verifique se o pacote de aspira√ß√£o est√° com status ",e.jsx("strong",{children:"FINALIZADO"})," e ainda n√£o foi usado para criar um lote FIV."]})]}):e.jsxs(ea,{value:_.pacote_aspiracao_id,onValueChange:V,children:[e.jsx(aa,{children:e.jsx(sa,{placeholder:"Selecione o pacote"})}),e.jsx(ta,{children:a.map(m=>e.jsxs(oa,{value:m.id,children:[we(m.data_aspiracao)," - ",m.fazenda_nome," (",m.quantidade_doadoras," doadoras)"]},m.id))})]}),w&&e.jsxs("div",{className:"text-sm text-slate-600 space-y-1 mt-2 p-3 bg-slate-50 rounded-lg",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Data do Pacote:"})," ",we(w.data_aspiracao)]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Data de Fecunda√ß√£o do Lote:"})," ",(()=>{const m=new Date(w.data_aspiracao);return m.setDate(m.getDate()+1),we(m.toISOString().split("T")[0])})()]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Fazendas Destino:"})," ",((h=w.fazendas_destino_nomes)==null?void 0:h.join(", "))||"Nenhuma"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Quantidade de Doadoras:"})," ",w.quantidade_doadoras||0]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(de,{children:"Doses de S√™men Dispon√≠veis no Lote *"}),e.jsx("div",{className:"border rounded-lg p-4 max-h-60 overflow-y-auto",children:K.length===0?e.jsx("p",{className:"text-sm text-slate-500",children:w?"Carregando doses...":"Selecione um pacote primeiro"}):e.jsx("div",{className:"space-y-2",children:K.map(m=>{var u,N;const U=O.find(D=>D.id===m.cliente_id),q=_.doses_selecionadas.includes(m.id);return e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:`dose-${m.id}`,checked:q,onChange:D=>{D.target.checked?R({..._,doses_selecionadas:[..._.doses_selecionadas,m.id]}):R({..._,doses_selecionadas:_.doses_selecionadas.filter(I=>I!==m.id)})},className:"rounded"}),e.jsxs("label",{htmlFor:`dose-${m.id}`,className:"text-sm cursor-pointer flex-1",children:[e.jsx("span",{className:"font-medium",children:((u=m.touro)==null?void 0:u.nome)||"Touro desconhecido"}),((N=m.touro)==null?void 0:N.registro)&&e.jsxs("span",{className:"text-slate-500 ml-2",children:["(",m.touro.registro,")"]}),U&&e.jsxs("span",{className:"text-slate-500 ml-2",children:["- ",U.nome]})]})]},m.id)})})}),e.jsx("p",{className:"text-xs text-slate-500",children:"Selecione as doses de s√™men que estar√£o dispon√≠veis para uso neste lote"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(de,{htmlFor:"observacoes",children:"Observa√ß√µes"}),e.jsx(La,{id:"observacoes",value:_.observacoes,onChange:m=>R({..._,observacoes:m.target.value}),placeholder:"Observa√ß√µes sobre o lote",rows:3})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(re,{type:"submit",className:"flex-1 bg-green-600 hover:bg-green-700",disabled:S,children:S?"Criando...":"Criar Lote"}),e.jsx(re,{type:"button",variant:"outline",onClick:L,disabled:S,children:"Cancelar"})]})]})]})]})}function Ie(a){return{[-1]:"Aspira√ß√£o",0:"Fecunda√ß√£o",1:"Zigoto",2:"2 C√©lulas",3:"4 C√©lulas",4:"8 C√©lulas",5:"M√≥rula",6:"Blastocisto",7:"Blastocisto Expandido",8:"Blastocisto Expandido"}[a]||`D${a}`}function ds({lote:a,acasalamentos:O,aspiracoesDisponiveis:i,dosesDisponiveis:$,dosesDisponiveisNoLote:n,doadoras:x,clientes:f,historicoDespachos:S,dataAspiracao:W,fazendaOrigemNome:_,fazendasDestinoNomes:R,submitting:w,onBack:X,onAddAcasalamento:K,onDespacharEmbrioes:Y,onUpdateQuantidadeEmbrioes:ee,editQuantidadeEmbrioes:b,onUpdateClivados:se,editClivados:v={}}){var B;const V=ga(),{toast:E}=Be(),[C,L]=d.useState(!1),[h,m]=d.useState(!1),[U,q]=d.useState(""),[u,N]=d.useState({aspiracao_doadora_id:"",dose_semen_id:"",quantidade_fracionada:"1.0",quantidade_oocitos:"",observacoes:""});let D=Te(W||a.pacote_data||null);if(!D){const s=Te(a.data_abertura);if(s){const[c,y,J]=s.split("-").map(Number),te=new Date(c,y-1,J);te.setDate(te.getDate()-1),D=`${te.getFullYear()}-${String(te.getMonth()+1).padStart(2,"0")}-${String(te.getDate()).padStart(2,"0")}`}}if(!D)return e.jsx("div",{children:"Erro: Data de aspira√ß√£o n√£o encontrada"});const I=va(),o=Math.max(0,ja(I,D)),r=ss(o),j=$a(D,8),T=ca(j),A=Ha(j),H=async s=>{if(s.preventDefault(),!u.aspiracao_doadora_id){E({title:"Erro de valida√ß√£o",description:"Doadora √© obrigat√≥ria",variant:"destructive"});return}if(!u.dose_semen_id){E({title:"Erro de valida√ß√£o",description:"Selecione uma dose de s√™men",variant:"destructive"});return}if((parseFloat(u.quantidade_fracionada)||0)<=0){E({title:"Erro de valida√ß√£o",description:"Quantidade fracionada deve ser maior que zero",variant:"destructive"});return}try{await K(u),L(!1),N({aspiracao_doadora_id:"",dose_semen_id:"",quantidade_fracionada:"1.0",quantidade_oocitos:"",observacoes:""}),q("")}catch{}},k=()=>{X(),V("/lotes-fiv")};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(re,{variant:"ghost",size:"sm",onClick:k,children:e.jsx(Xa,{className:"w-4 h-4"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-slate-900",children:"Detalhes do Lote FIV"}),e.jsxs("div",{className:"text-slate-600 mt-1 flex items-center gap-2",children:[e.jsxs("span",{children:["Data de fecunda√ß√£o (D0): ",we(a.data_abertura)," |",D&&` Data aspira√ß√£o (D-1): ${ca(D)} |`,r===-1?` D-1 - ${Ie(r)} |`:` D${r} - ${Ie(r)} |`," ","Status:"]}),e.jsx(Ae,{variant:a.status==="FECHADO"?"default":"secondary",children:a.status})]})]})]}),e.jsxs(He,{children:[e.jsx(ke,{children:e.jsx(Ve,{children:"Informa√ß√µes do Lote"})}),e.jsxs(Re,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(de,{children:"Dia Atual"}),e.jsx("p",{className:"text-2xl font-bold",children:r===-1?e.jsxs(e.Fragment,{children:["D-1 ",e.jsxs("span",{className:"text-lg font-normal text-slate-600",children:["- ",Ie(r)]})]}):e.jsxs(e.Fragment,{children:["D",r," ",e.jsxs("span",{className:"text-lg font-normal text-slate-600",children:["- ",Ie(r)]})]})})]}),e.jsxs("div",{children:[e.jsx(de,{children:"Data da TE"}),o<7?e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-orange-600",children:T}),e.jsx("p",{className:"text-sm text-slate-500",children:A})]}):e.jsx("p",{className:"text-2xl font-bold text-green-600",children:"Hoje ou passou"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(de,{children:"Fazenda de Origem"}),e.jsx("p",{className:"font-medium",children:_||a.pacote_nome||"-"})]}),e.jsxs("div",{children:[e.jsx(de,{children:"Fazendas de Destino"}),e.jsx("p",{className:"font-medium",children:R.length>0?R.join(", "):((B=a.fazendas_destino_nomes)==null?void 0:B.join(", "))||"-"})]})]}),a.observacoes&&e.jsxs("div",{children:[e.jsx(de,{children:"Observa√ß√µes"}),e.jsx("p",{className:"text-slate-600",children:a.observacoes})]}),a.status==="ABERTO"&&o===7&&e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"text-blue-800 font-medium",children:["üìä Este lote est√° no D6 (",Ie(6),"). Voc√™ pode preencher a quantidade de embri√µes (pr√©via) e gerar um relat√≥rio."]}),e.jsxs(re,{variant:"outline",size:"sm",onClick:()=>m(!0),children:[e.jsx(Ya,{className:"w-4 h-4 mr-2"}),"Gerar Relat√≥rio de Pr√©via"]})]})}),(a.status==="ABERTO"&&(o===8||o===9)||a.status==="FECHADO"&&o===9)&&e.jsx("div",{className:"bg-orange-50 border border-orange-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"text-orange-800 font-medium",children:["‚ö†Ô∏è Este lote est√° no ",o===8?"D7":"D8"," (",Ie(o===8?7:8),"). ",o===8?"Informe a quantidade de embri√µes para cada acasalamento e despache os embri√µes.":"Per√≠odo de emerg√™ncia (D8). Voc√™ pode adicionar novos acasalamentos e despachar os embri√µes imediatamente."]}),e.jsxs(re,{variant:"default",size:"sm",onClick:Y,disabled:w,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(_a,{className:"w-4 h-4 mr-2"}),w?"Despachando...":"Despachar Todos os Embri√µes"]})]})})]})]}),e.jsxs(He,{children:[e.jsx(ke,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Ve,{className:"flex items-center gap-2",children:[e.jsx(ma,{className:"w-5 h-5"}),"Acasalamentos (",O.length,")"]}),a.status==="ABERTO"&&e.jsxs(re,{size:"sm",onClick:()=>L(!0),className:"bg-green-600 hover:bg-green-700",children:[e.jsx(qa,{className:"w-4 h-4 mr-2"}),"Adicionar Acasalamento"]})]})}),e.jsx(Re,{children:O.length===0?e.jsxs("div",{className:"text-center py-8 text-slate-500",children:[e.jsx(ma,{className:"w-12 h-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"Nenhum acasalamento cadastrado"}),a.status==="ABERTO"&&e.jsx(re,{variant:"outline",size:"sm",className:"mt-2",onClick:()=>L(!0),children:"Adicionar primeiro acasalamento"})]}):e.jsxs(Je,{children:[e.jsx(Ke,{children:e.jsxs(ze,{children:[e.jsx(Z,{children:"Doadora"}),e.jsx(Z,{children:"Touro"}),e.jsx(Z,{className:"text-center",children:"O√≥citos"}),e.jsx(Z,{className:"text-center",children:"D3 Clivados"}),e.jsx(Z,{className:"text-center",children:"Qtd. Embri√µes"}),e.jsx(Z,{className:"text-center",children:"%"}),e.jsx(Z,{children:"Observa√ß√µes"})]})}),e.jsx(We,{children:O.map(s=>{const c=s.viaveis||0,y=v[s.id],J=s.embrioes_clivados_d3,te=y!==void 0?y:(J==null?void 0:J.toString())??"",ne=parseInt(te)||0,xe=ne>0?ne:c,t=b[s.id]!==void 0?parseInt(b[s.id])||0:s.total_embrioes_produzidos||0,z=c>0?(t/c*100).toFixed(1):"0.0";return e.jsxs(ze,{children:[e.jsx(G,{children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.doadora_registro||"-"}),s.doadora_nome&&e.jsx("p",{className:"text-sm text-slate-500",children:s.doadora_nome})]})}),e.jsx(G,{children:s.dose_nome||"-"}),e.jsx(G,{className:"text-center",children:c}),e.jsx(G,{className:"text-center",children:a.status==="ABERTO"&&r>=3&&se?e.jsx(Oe,{type:"number",min:"0",max:c,className:"w-20 text-center",value:te,onChange:M=>se(s.id,M.target.value),placeholder:"-"}):e.jsx("span",{children:ne>0?ne:"-"})}),e.jsx(G,{className:"text-center",children:a.status==="ABERTO"&&o>=7?e.jsx(Oe,{type:"number",min:"0",max:xe,className:"w-20 text-center",value:b[s.id]??s.total_embrioes_produzidos??"",onChange:M=>ee(s.id,M.target.value),placeholder:"0"}):e.jsx("span",{children:t})}),e.jsx(G,{className:"text-center",children:e.jsxs(Ae,{variant:parseFloat(z)>=30?"default":"secondary",children:[z,"%"]})}),e.jsx(G,{className:"max-w-[200px] truncate",children:s.observacoes||"-"})]},s.id)})})]})})]}),S.length>0&&e.jsxs(He,{children:[e.jsx(ke,{children:e.jsxs(Ve,{className:"flex items-center gap-2",children:[e.jsx(_a,{className:"w-5 h-5"}),"Hist√≥rico de Despachos"]})}),e.jsx(Re,{children:e.jsx("div",{className:"space-y-4",children:S.map(s=>e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsxs("p",{className:"font-medium mb-2",children:["Despacho em ",ca(s.data_despacho)]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2",children:s.acasalamentos.map((c,y)=>e.jsxs("div",{className:"text-sm bg-slate-50 rounded p-2",children:[e.jsx("span",{className:"font-medium",children:c.doadora}),e.jsxs("span",{className:"text-slate-500",children:[" x ",c.dose]}),e.jsxs("span",{className:"ml-2 text-green-600 font-medium",children:["(",c.quantidade,")"]})]},y))})]},s.id))})})]}),e.jsx(pa,{open:C,onOpenChange:L,children:e.jsxs(xa,{className:"max-w-lg",children:[e.jsxs(ha,{children:[e.jsx(fa,{children:"Adicionar Acasalamento"}),e.jsx(ua,{children:"Selecione a doadora e a dose de s√™men para o acasalamento"})]}),e.jsxs("form",{onSubmit:H,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(de,{children:"Doadora *"}),e.jsxs(ea,{value:u.aspiracao_doadora_id,onValueChange:s=>{N({...u,aspiracao_doadora_id:s});const c=i.find(y=>y.id===s);c&&N(y=>({...y,aspiracao_doadora_id:s,quantidade_oocitos:String(c.oocitos_disponiveis||c.viaveis||0)}))},children:[e.jsx(aa,{children:e.jsx(sa,{placeholder:"Selecione a doadora"})}),e.jsx(ta,{children:i.map(s=>{const c=x.find(y=>y.id===s.doadora_id);return e.jsxs(oa,{value:s.id,children:[(c==null?void 0:c.registro)||(c==null?void 0:c.nome)||"Doadora"," - ",s.oocitos_disponiveis??s.viaveis??0," o√≥citos dispon√≠veis"]},s.id)})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(de,{children:"Dose de S√™men *"}),e.jsxs(ea,{value:u.dose_semen_id,onValueChange:s=>N({...u,dose_semen_id:s}),children:[e.jsx(aa,{children:e.jsx(sa,{placeholder:"Selecione a dose"})}),e.jsx(ta,{children:(n.length>0?n:$).map(s=>{var y,J;const c=f.find(te=>te.id===s.cliente_id);return e.jsxs(oa,{value:s.id,children:[((y=s.touro)==null?void 0:y.nome)||"Touro desconhecido",((J=s.touro)==null?void 0:J.registro)&&` (${s.touro.registro})`,c&&` - ${c.nome}`]},s.id)})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(de,{children:"Qtd. Fracionada"}),e.jsx(Oe,{type:"number",step:"0.1",min:"0",value:u.quantidade_fracionada,onChange:s=>N({...u,quantidade_fracionada:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(de,{children:"Qtd. O√≥citos"}),e.jsx(Oe,{type:"number",min:"0",value:u.quantidade_oocitos,onChange:s=>N({...u,quantidade_oocitos:s.target.value}),placeholder:"Auto"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(de,{children:"Observa√ß√µes"}),e.jsx(La,{value:u.observacoes,onChange:s=>N({...u,observacoes:s.target.value}),placeholder:"Observa√ß√µes sobre o acasalamento",rows:2})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(re,{type:"submit",className:"flex-1 bg-green-600 hover:bg-green-700",disabled:w,children:w?"Adicionando...":"Adicionar"}),e.jsx(re,{type:"button",variant:"outline",onClick:()=>{L(!1),N({aspiracao_doadora_id:"",dose_semen_id:"",quantidade_fracionada:"1.0",quantidade_oocitos:"",observacoes:""})},children:"Cancelar"})]})]})]})}),e.jsx(pa,{open:h,onOpenChange:m,children:e.jsxs(xa,{className:"max-w-2xl",children:[e.jsxs(ha,{children:[e.jsx(fa,{children:"Relat√≥rio de Pr√©via - D6"}),e.jsx(ua,{children:"Resumo dos acasalamentos e embri√µes previstos"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"border rounded-lg p-4 bg-slate-50",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Informa√ß√µes do Lote"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-slate-500",children:"Fazenda Origem:"})," ",_||a.pacote_nome]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-slate-500",children:"Fazendas Destino:"})," ",R.join(", ")||"-"]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-slate-500",children:"Data TE prevista:"})," ",T]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-slate-500",children:"Total Acasalamentos:"})," ",O.length]})]})]}),e.jsxs(Je,{children:[e.jsx(Ke,{children:e.jsxs(ze,{children:[e.jsx(Z,{children:"Doadora"}),e.jsx(Z,{children:"Touro"}),e.jsx(Z,{className:"text-center",children:"O√≥citos"}),e.jsx(Z,{className:"text-center",children:"Embri√µes (prev.)"})]})}),e.jsx(We,{children:O.map(s=>e.jsxs(ze,{children:[e.jsx(G,{children:s.doadora_registro||"-"}),e.jsx(G,{children:s.dose_nome||"-"}),e.jsx(G,{className:"text-center",children:s.viaveis||0}),e.jsx(G,{className:"text-center",children:b[s.id]??s.total_embrioes_produzidos??"-"})]},s.id))})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(re,{onClick:()=>m(!1),children:"Fechar"})})]})]})})]})}function cs({lotesHistoricos:a,fazendas:O,detalhesLoteExpandido:i,loteExpandido:$,loadingHistorico:n,loadingDetalhes:x,filtroHistoricoDataInicio:f,setFiltroHistoricoDataInicio:S,filtroHistoricoDataFim:W,setFiltroHistoricoDataFim:_,filtroHistoricoFazenda:R,setFiltroHistoricoFazenda:w,filtroHistoricoFazendaBusca:X,setFiltroHistoricoFazendaBusca:K,showFazendaBuscaHistorico:Y,setShowFazendaBuscaHistorico:ee,historicoPage:b,setHistoricoPage:se,HISTORICO_PAGE_SIZE:v,onLoadHistorico:V,onExpandirLote:E}){const C=Math.max(1,Math.ceil(a.length/v)),L=()=>{S(""),_(""),w(""),K(""),ee(!1),V()};return e.jsxs("div",{className:"mt-0",children:[e.jsxs("div",{className:"flex gap-4 mb-6 flex-wrap items-end",children:[e.jsxs("div",{className:"flex-1 min-w-[280px]",children:[e.jsxs("div",{className:"mb-2",children:[e.jsx(de,{className:"text-sm font-medium text-slate-700",children:"Per√≠odo de Busca"}),e.jsx("p",{className:"text-xs text-slate-500 mt-0.5",children:"Filtro pela data D0 (Fecunda√ß√£o) do lote"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(de,{htmlFor:"filtro-historico-data-inicio",className:"text-xs text-slate-500 font-normal",children:"Data In√≠cio"}),e.jsx(Aa,{value:f,onChange:h=>S(h||""),placeholder:"Data inicial"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx(de,{htmlFor:"filtro-historico-data-fim",className:"text-xs text-slate-500 font-normal",children:"Data Fim"}),e.jsx(Aa,{value:W,onChange:h=>_(h||""),placeholder:"Data final"})]})]})]}),e.jsxs("div",{className:"flex-1 min-w-[250px] relative fazenda-busca-historico-container",children:[e.jsx(de,{htmlFor:"filtro-historico-fazenda",children:"Fazenda de Origem"}),e.jsxs("div",{className:"relative",children:[e.jsx(Oe,{id:"filtro-historico-fazenda",placeholder:"Digite para buscar fazenda...",value:X,onChange:h=>{K(h.target.value),ee(!0),h.target.value||w("")},onFocus:()=>ee(!0)}),R&&e.jsx(re,{variant:"ghost",size:"sm",className:"absolute right-1 top-1 h-7 w-7 p-0",onClick:()=>{w(""),K(""),ee(!1)},children:e.jsx(Ia,{className:"h-4 w-4"})}),Y&&O.length>0&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-white border rounded-md shadow-lg max-h-60 overflow-auto",children:O.filter(h=>h.nome.toLowerCase().includes(X.toLowerCase())).map(h=>e.jsx("div",{className:"px-4 py-2 hover:bg-slate-100 cursor-pointer",onClick:()=>{w(h.id),K(h.nome),ee(!1)},children:h.nome},h.id))}),Y&&X&&O.filter(h=>h.nome.toLowerCase().includes(X.toLowerCase())).length===0&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-white border rounded-md shadow-lg p-4 text-sm text-slate-500",children:"Nenhuma fazenda encontrada"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(re,{onClick:V,disabled:n,className:"bg-blue-600 hover:bg-blue-700",children:[e.jsx(Ja,{className:"w-4 h-4 mr-2"}),"Buscar"]}),(f||W||R)&&e.jsx(re,{variant:"outline",onClick:L,children:"Limpar"})]})]}),n?e.jsx("div",{className:"py-8",children:e.jsx(ba,{})}):a.length===0?e.jsx(Ca,{title:"Nenhum lote hist√≥rico encontrado",description:"Ajuste os filtros ou tente outro per√≠odo."}):e.jsxs("div",{className:"space-y-4",children:[a.slice((b-1)*v,b*v).map(h=>e.jsx(ls,{lote:h,isExpanded:$===h.id,detalhes:$===h.id?i:null,loadingDetalhes:x&&$===h.id,onExpandir:()=>E(h.id)},h.id)),e.jsxs("div",{className:"flex items-center justify-between pt-2 text-sm text-slate-600",children:[e.jsxs("div",{children:[a.length," lotes no hist√≥rico"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(re,{variant:"outline",size:"sm",onClick:()=>se(Math.max(1,b-1)),disabled:b===1,children:"Anterior"}),e.jsxs("span",{children:["P√°gina ",Math.min(b,C)," de ",C]}),e.jsx(re,{variant:"outline",size:"sm",onClick:()=>se(Math.min(C,b+1)),disabled:b>=C,children:"Pr√≥xima"})]})]})]})]})}function ls({lote:a,isExpanded:O,detalhes:i,loadingDetalhes:$,onExpandir:n}){return e.jsxs(He,{className:"border-l-4 border-l-slate-400",children:[e.jsx(ke,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Ve,{className:"text-lg",children:["Lote FIV - ",we(a.data_abertura)]}),e.jsx(re,{variant:"outline",size:"sm",onClick:n,disabled:$,children:O?e.jsxs(e.Fragment,{children:[e.jsx(Va,{className:"w-4 h-4 mr-2"}),"Recolher"]}):e.jsxs(e.Fragment,{children:[e.jsx(Ra,{className:"w-4 h-4 mr-2"}),"Ver Detalhes Completos"]})})]})}),e.jsxs(Re,{className:"pt-0",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Informa√ß√µes B√°sicas"}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Data da Aspira√ß√£o:"})," ",a.pacote_data?we(a.pacote_data):"-"]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Fazenda Origem:"})," ",a.fazenda_origem_nome||"-"]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Data de Abertura:"})," ",we(a.data_abertura)]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Status:"})," ",e.jsx(Ae,{variant:"outline",children:a.status})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Fazendas Destino"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:a.fazendas_destino_nomes&&a.fazendas_destino_nomes.length>0?a.fazendas_destino_nomes.map((x,f)=>e.jsx(Ae,{variant:"outline",className:"text-xs",children:x},f)):e.jsx("span",{className:"text-slate-400 text-sm",children:"-"})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Estat√≠sticas"}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Acasalamentos:"})," ",a.quantidade_acasalamentos||0]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total de Embri√µes:"})," ",a.total_embrioes_produzidos||0]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total Transferidos:"})," ",e.jsx("span",{className:"text-green-700 font-semibold",children:a.total_embrioes_transferidos||0})]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total Congelados:"})," ",e.jsx("span",{className:"text-blue-700 font-semibold",children:a.total_embrioes_congelados||0})]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total Descartados:"})," ",e.jsx("span",{className:"text-red-700 font-semibold",children:a.total_embrioes_descartados||0})]}),a.total_oocitos&&e.jsxs("p",{className:"mt-2 pt-2 border-t border-slate-200",children:[e.jsx("span",{className:"font-medium",children:"Total de O√≥citos:"})," ",a.total_oocitos]}),a.total_viaveis&&e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"O√≥citos Vi√°veis:"})," ",a.total_viaveis]})]})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2 lg:col-span-3",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Embri√µes por Classifica√ß√£o"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-6 gap-2",children:[a.embrioes_por_classificacao.BE&&e.jsxs("div",{className:"bg-green-50 p-2 rounded border",children:[e.jsx("p",{className:"text-xs font-medium text-green-800",children:"BE"}),e.jsx("p",{className:"text-lg font-bold text-green-900",children:a.embrioes_por_classificacao.BE})]}),a.embrioes_por_classificacao.BN&&e.jsxs("div",{className:"bg-blue-50 p-2 rounded border",children:[e.jsx("p",{className:"text-xs font-medium text-blue-800",children:"BN"}),e.jsx("p",{className:"text-lg font-bold text-blue-900",children:a.embrioes_por_classificacao.BN})]}),a.embrioes_por_classificacao.BX&&e.jsxs("div",{className:"bg-yellow-50 p-2 rounded border",children:[e.jsx("p",{className:"text-xs font-medium text-yellow-800",children:"BX"}),e.jsx("p",{className:"text-lg font-bold text-yellow-900",children:a.embrioes_por_classificacao.BX})]}),a.embrioes_por_classificacao.BL&&e.jsxs("div",{className:"bg-orange-50 p-2 rounded border",children:[e.jsx("p",{className:"text-xs font-medium text-orange-800",children:"BL"}),e.jsx("p",{className:"text-lg font-bold text-orange-900",children:a.embrioes_por_classificacao.BL})]}),a.embrioes_por_classificacao.BI&&e.jsxs("div",{className:"bg-red-50 p-2 rounded border",children:[e.jsx("p",{className:"text-xs font-medium text-red-800",children:"BI"}),e.jsx("p",{className:"text-lg font-bold text-red-900",children:a.embrioes_por_classificacao.BI})]}),a.embrioes_por_classificacao.sem_classificacao&&e.jsxs("div",{className:"bg-slate-50 p-2 rounded border",children:[e.jsx("p",{className:"text-xs font-medium text-slate-800",children:"Sem Classifica√ß√£o"}),e.jsx("p",{className:"text-lg font-bold text-slate-900",children:a.embrioes_por_classificacao.sem_classificacao})]})]})]}),a.observacoes&&e.jsxs("div",{className:"space-y-2 md:col-span-2 lg:col-span-3",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Observa√ß√µes"}),e.jsx("p",{className:"text-sm text-slate-600 bg-slate-50 p-3 rounded border",children:a.observacoes})]})]}),O&&e.jsx(ms,{detalhes:i,loadingDetalhes:$})]})]})}function ms({detalhes:a,loadingDetalhes:O}){return O?e.jsx("div",{className:"mt-4 pt-4 border-t border-slate-200 py-4",children:e.jsx(ba,{})}):a?e.jsxs("div",{className:"mt-4 pt-4 border-t border-slate-200 space-y-4",children:[a.pacote&&e.jsxs("div",{className:"bg-slate-50 p-3 rounded border text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(_a,{className:"w-4 h-4 text-slate-600"}),e.jsx("span",{className:"font-semibold",children:"Pacote de Aspira√ß√£o"})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-x-4 gap-y-1",children:[a.pacote.data_aspiracao&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Data:"})," ",e.jsx("span",{className:"font-medium",children:we(a.pacote.data_aspiracao)})]}),a.pacote.horario_inicio&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Hora In√≠cio:"})," ",e.jsx("span",{className:"font-medium",children:a.pacote.horario_inicio})]}),a.pacote.horario_final&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Hora Fim Aspira√ß√£o:"})," ",e.jsx("span",{className:"font-medium",children:a.pacote.horario_final})]}),a.pacote.veterinario_responsavel&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Vet:"})," ",e.jsx("span",{className:"font-medium",children:a.pacote.veterinario_responsavel})]}),a.pacote.tecnico_responsavel&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"T√©cnico:"})," ",e.jsx("span",{className:"font-medium",children:a.pacote.tecnico_responsavel})]}),a.pacote.total_oocitos&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"O√≥citos Totais:"})," ",e.jsx("span",{className:"font-medium",children:a.pacote.total_oocitos})]}),a.pacote.observacoes&&e.jsxs("div",{className:"col-span-full mt-1 pt-1 border-t border-slate-200",children:[e.jsx("span",{className:"text-slate-600",children:"Obs:"})," ",e.jsx("span",{className:"text-slate-700",children:a.pacote.observacoes})]})]})]}),a.acasalamentos.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(ma,{className:"w-4 h-4 text-slate-600"}),e.jsxs("span",{className:"font-semibold text-sm",children:["Acasalamentos e Embri√µes (",a.acasalamentos.length,")"]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(Je,{children:[e.jsx(Ke,{children:e.jsxs(ze,{className:"bg-slate-50",children:[e.jsx(Z,{className:"h-8 text-xs font-semibold",children:"#"}),e.jsx(Z,{className:"h-8 text-xs font-semibold",children:"Doadora"}),e.jsx(Z,{className:"h-8 text-xs font-semibold",children:"Aspira√ß√£o"}),e.jsx(Z,{className:"h-8 text-xs font-semibold",children:"O√≥citos"}),e.jsx(Z,{className:"h-8 text-xs font-semibold",children:"Vi√°veis"}),e.jsx(Z,{className:"h-8 text-xs font-semibold",children:"S√™men"}),e.jsx(Z,{className:"h-8 text-xs font-semibold",children:"Dose"}),e.jsx(Z,{className:"h-8 text-xs font-semibold",children:"Embri√µes Prod."}),e.jsx(Z,{className:"h-8 text-xs font-semibold",children:"Total Emb."}),e.jsx(Z,{className:"h-8 text-xs font-semibold",children:"Transf."}),e.jsx(Z,{className:"h-8 text-xs font-semibold",children:"Cong."}),e.jsx(Z,{className:"h-8 text-xs font-semibold",children:"Desc."}),e.jsx(Z,{className:"h-8 text-xs font-semibold",children:"Outros"}),e.jsx(Z,{className:"h-8 text-xs font-semibold",children:"Classifica√ß√£o"})]})}),e.jsx(We,{children:a.acasalamentos.map((i,$)=>{var X,K,Y,ee,b,se,v,V,E,C;const n=i.resumo_embrioes,x=(n==null?void 0:n.porStatus.TRANSFERIDO)||0,f=(n==null?void 0:n.porStatus.CONGELADO)||0,S=(n==null?void 0:n.porStatus.DESCARTADO)||0,W=n?n.total-x-f-S:0,_=n&&Object.entries(n.porClassificacao).filter(([L])=>L!=="sem_classificacao").sort((L,h)=>h[1]-L[1]).map(([L,h])=>`${L}(${h})`).join(", ")||"-",R=$>0?a.acasalamentos[$-1]:null,w=R&&i.aspiracao_id&&i.aspiracao_id===R.aspiracao_id;return e.jsxs(ze,{className:`text-xs ${w?"bg-slate-50/50":""}`,children:[e.jsx(G,{className:"py-2 font-medium",children:$+1}),e.jsx(G,{className:"py-2",children:w?e.jsx("div",{className:"text-slate-400 italic text-[10px]",children:"‚Ü≥"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"font-medium",children:((X=i.doadora)==null?void 0:X.registro)||"-"}),((K=i.doadora)==null?void 0:K.nome)&&e.jsx("div",{className:"text-slate-500 text-[11px]",children:i.doadora.nome})]})}),e.jsx(G,{className:"py-2",children:w?e.jsx("div",{className:"text-slate-400 italic text-[10px]",children:"‚Ü≥"}):e.jsxs(e.Fragment,{children:[((Y=i.aspiracao)==null?void 0:Y.data_aspiracao)&&e.jsx("div",{children:we(i.aspiracao.data_aspiracao)}),((ee=i.aspiracao)==null?void 0:ee.horario_aspiracao)&&e.jsx("div",{className:"text-slate-500 text-[11px]",children:i.aspiracao.horario_aspiracao})]})}),e.jsx(G,{className:"py-2",children:w?e.jsx("div",{className:"text-slate-400 italic text-[10px]",children:"‚Ü≥ (mesma aspira√ß√£o)"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"font-medium",children:((b=i.aspiracao)==null?void 0:b.total_oocitos)??"-"}),i.aspiracao&&e.jsxs("div",{className:"text-[10px] text-slate-500 space-x-1",children:[i.aspiracao.expandidos!==void 0&&e.jsxs("span",{children:["Exp:",i.aspiracao.expandidos]}),i.aspiracao.atresicos!==void 0&&e.jsxs("span",{children:["At:",i.aspiracao.atresicos]}),i.aspiracao.degenerados!==void 0&&e.jsxs("span",{children:["Deg:",i.aspiracao.degenerados]}),i.aspiracao.desnudos!==void 0&&e.jsxs("span",{children:["Des:",i.aspiracao.desnudos]})]})]})}),e.jsx(G,{className:"py-2",children:w?e.jsx("div",{className:"text-slate-400 italic text-[10px]",children:"‚Ü≥"}):e.jsx("span",{className:"font-medium text-green-700",children:((se=i.aspiracao)==null?void 0:se.viaveis)??"-"})}),e.jsxs(G,{className:"py-2",children:[e.jsx("div",{className:"font-medium",children:((v=i.dose_semen)==null?void 0:v.nome)||"-"}),e.jsxs("div",{className:"text-[10px] text-slate-500 space-x-1",children:[((V=i.dose_semen)==null?void 0:V.raca)&&e.jsx("span",{children:i.dose_semen.raca}),((E=i.dose_semen)==null?void 0:E.tipo_semen)&&e.jsxs("span",{children:["‚Ä¢ ",i.dose_semen.tipo_semen]})]}),((C=i.dose_semen)==null?void 0:C.cliente)&&e.jsx("div",{className:"text-[10px] text-slate-500",children:i.dose_semen.cliente})]}),e.jsx(G,{className:"py-2 text-center",children:e.jsx("span",{className:"font-medium",children:i.quantidade_fracionada})}),e.jsxs(G,{className:"py-2 text-center",children:[e.jsx("span",{className:"font-medium text-blue-700",children:i.quantidade_embrioes??"-"}),i.quantidade_oocitos!==void 0&&e.jsxs("div",{className:"text-[10px] text-slate-500",children:["Usados: ",i.quantidade_oocitos]})]}),e.jsx(G,{className:"py-2 text-center",children:n&&n.total>0?e.jsx("span",{className:"font-semibold",children:n.total}):e.jsx("span",{className:"text-slate-400",children:"-"})}),e.jsx(G,{className:"py-2 text-center",children:x>0?e.jsx("span",{className:"text-green-700 font-medium",children:x}):e.jsx("span",{className:"text-slate-400",children:"-"})}),e.jsx(G,{className:"py-2 text-center",children:f>0?e.jsx("span",{className:"text-blue-700 font-medium",children:f}):e.jsx("span",{className:"text-slate-400",children:"-"})}),e.jsx(G,{className:"py-2 text-center",children:S>0?e.jsx("span",{className:"text-red-700 font-medium",children:S}):e.jsx("span",{className:"text-slate-400",children:"-"})}),e.jsx(G,{className:"py-2 text-center",children:W>0?e.jsx("span",{className:"text-slate-600 font-medium",children:W}):e.jsx("span",{className:"text-slate-400",children:"-"})}),e.jsx(G,{className:"py-2 text-[11px] text-slate-700",children:n&&_!=="-"?e.jsxs("div",{className:"flex flex-wrap gap-1",children:[_.split(", ").map((L,h)=>e.jsx(Ae,{variant:"outline",className:"text-[10px] px-1 py-0 border-slate-300",children:L},h)),n.porClassificacao.sem_classificacao&&e.jsxs(Ae,{variant:"outline",className:"text-[10px] px-1 py-0 border-slate-300 text-slate-500",children:["Sem class.(",n.porClassificacao.sem_classificacao,")"]})]}):e.jsx("span",{className:"text-slate-400",children:"-"})})]},i.id)})})]})})]}),a.acasalamentos.some(i=>i.observacoes)&&e.jsxs("div",{className:"bg-amber-50 p-2 rounded border border-amber-200 text-xs",children:[e.jsx("div",{className:"font-semibold mb-1 text-amber-900",children:"Observa√ß√µes dos Acasalamentos:"}),a.acasalamentos.filter(i=>i.observacoes).map((i,$)=>{var n;return e.jsxs("div",{className:"mb-1",children:[e.jsxs("span",{className:"font-medium",children:["#",$+1," (",((n=i.doadora)==null?void 0:n.registro)||"N/A","):"]})," ",i.observacoes]},i.id)})]})]}):e.jsx("div",{className:"mt-4 pt-4 border-t border-slate-200 text-center text-slate-500 py-4 text-sm",children:"Erro ao carregar detalhes"})}function Ms(){const{id:a}=ka(),O=ga(),{toast:i}=Be(),[$,n]=d.useState(!1),[x,f]=d.useState({}),[S,W]=d.useState({}),_=Fa({lotes:[],pacotesParaFiltro:[],fazendasAspiracaoUnicas:[],lotesHistoricos:[]}),{lotes:R,pacotes:w,fazendas:X,doadoras:K,clientes:Y,loading:ee,selectedLote:b,setSelectedLote:se,showLoteDetail:v,setShowLoteDetail:V,acasalamentos:E,fazendasDestinoIds:C,historicoDespachos:L,setHistoricoDespachos:h,aspiracoesDisponiveis:m,dosesDisponiveis:U,fazendaOrigemNome:q,fazendasDestinoNomes:u,dosesDisponiveisNoLote:N,dataAspiracao:D,pacotesParaFiltro:I,fazendasAspiracaoUnicas:o,lotesHistoricos:r,loadingHistorico:j,loteExpandido:T,detalhesLoteExpandido:A,loadingDetalhes:H,loadLoteDetail:k,loadLotesHistoricos:B,handleExpandirLote:s}=rs({id:a,filtroHistoricoDataInicio:_.filtroHistoricoDataInicio,filtroHistoricoDataFim:_.filtroHistoricoDataFim,filtroHistoricoFazenda:_.filtroHistoricoFazenda,setHistoricoPage:_.setHistoricoPage}),{filtroFazendaAspiracao:c,setFiltroFazendaAspiracao:y,filtroFazendaAspiracaoBusca:J,setFiltroFazendaAspiracaoBusca:te,filtroDiaCultivo:ne,setFiltroDiaCultivo:xe,showFazendaBusca:t,setShowFazendaBusca:z,fazendasFiltradas:M,lotesFiltrados:F,limparFiltrosAtivos:Q,filtroHistoricoDataInicio:ce,setFiltroHistoricoDataInicio:ve,filtroHistoricoDataFim:he,setFiltroHistoricoDataFim:Se,filtroHistoricoFazenda:me,setFiltroHistoricoFazenda:je,filtroHistoricoFazendaBusca:fe,setFiltroHistoricoFazendaBusca:De,showFazendaBuscaHistorico:Ce,setShowFazendaBuscaHistorico:ra,abaAtiva:na,setAbaAtiva:g,historicoPage:ue,setHistoricoPage:le,HISTORICO_PAGE_SIZE:_e}=Fa({lotes:R,pacotesParaFiltro:I,fazendasAspiracaoUnicas:o,lotesHistoricos:r}),ae=async()=>{var p,ie;if(b)try{n(!0);const oe=w.find(P=>P.id===b.pacote_aspiracao_id);let pe=Te((oe==null?void 0:oe.data_aspiracao)||null);if(!pe){const P=Te(b.data_abertura);if(P){const[be,Ee,Pe]=P.split("-").map(Number),Ne=new Date(be,Ee-1,Pe);Ne.setDate(Ne.getDate()-1);const $e=Ne.getFullYear(),Ye=String(Ne.getMonth()+1).padStart(2,"0"),da=String(Ne.getDate()).padStart(2,"0");pe=`${$e}-${Ye}-${da}`}}const Le=va();if((pe?Math.max(0,ja(Le,pe)):0)>9){i({title:"Prazo expirado",description:"D8 √© o √∫ltimo dia. N√£o √© poss√≠vel criar embri√µes ap√≥s o D8. O lote ser√° fechado e n√£o aparecer√° mais na lista.",variant:"destructive"}),n(!1);return}const Fe=E.filter(P=>{var Ee;return parseInt(x[P.id]||((Ee=P.quantidade_embrioes)==null?void 0:Ee.toString())||"0")>0});if(Fe.length===0){i({title:"Nenhum embri√£o para despachar",description:"Preencha a quantidade de embri√µes em pelo menos um acasalamento antes de despachar.",variant:"destructive"});return}for(const P of Fe){const be=parseInt(x[P.id]||((p=P.quantidade_embrioes)==null?void 0:p.toString())||"0"),Ee=P.quantidade_oocitos??0,Pe=S[P.id],Ne=P.embrioes_clivados_d3,$e=parseInt(Pe??(Ne==null?void 0:Ne.toString())??"")||0,Ye=$e>0?$e:Ee;if(be>Ye){const da=P.doadora_nome||P.doadora_registro||"Doadora desconhecida",Pa=$e>0?"clivados (D3)":"o√≥citos";i({title:"Valida√ß√£o de quantidade",description:`O acasalamento da doadora "${da}" possui ${be} embri√µes, mas o limite de ${Pa} √© ${Ye}. A quantidade de embri√µes n√£o pode exceder esse limite.`,variant:"destructive"});return}}const Me=`${q} - ${u.join(", ")}`,Ue=new Date().toISOString().split("T")[0];if(!C.length){i({title:"Erro ao despachar",description:"√â necess√°rio ter pelo menos uma fazenda destino configurada no lote.",variant:"destructive"});return}let qe="EMB";const Qe=pe||"",Ze=Qe.slice(8,10)+Qe.slice(5,7);if(oe!=null&&oe.fazenda_id){const{data:P,error:be}=await l.from("fazendas").select("sigla, nome").eq("id",oe.fazenda_id).single();!be&&P&&(P.sigla?qe=P.sigla:P.nome&&(qe=P.nome.replace(/[^a-zA-Z]/g,"").substring(0,3).toUpperCase()||"EMB"))}const Ge=`${qe}-${Ze}`;let Na=1;const{count:Da,error:Ta}=await l.from("embrioes").select("*",{count:"exact",head:!0}).like("identificacao",`${Ge}-%`);!Ta&&Da!==null&&(Na=Da+1);const Xe=[],wa=[];let Sa=0;for(const P of Fe){const be=parseInt(x[P.id]||((ie=P.quantidade_embrioes)==null?void 0:ie.toString())||"0");if(be>0){for(let Ee=0;Ee<be;Ee++){const Pe=String(Na+Sa).padStart(3,"0"),Ne={lote_fiv_id:b.id,lote_fiv_acasalamento_id:P.id,status_atual:"FRESCO",identificacao:`${Ge}-${Pe}`};Xe.push(Ne),Sa++}wa.push({acasalamento_id:P.id,quantidade:be,doadora:P.doadora_registro||P.doadora_nome,dose:P.dose_nome})}}if(Xe.length>0){const{error:P}=await l.from("embrioes").insert(Xe);if(P)throw P}const Ba={id:`${b.id}-${Ue}`,data_despacho:Ue,acasalamentos:wa};h([Ba,...L]);const Ma=Fe.map(P=>l.from("lote_fiv_acasalamentos").update({quantidade_embrioes:null}).eq("id",P.id));await Promise.all(Ma),f({}),i({title:"Embri√µes despachados",description:`${Xe.length} embri√£o(√µes) foram despachados para ${Me}.`}),k(b.id)}catch(oe){i({title:"Erro ao despachar embri√µes",description:oe instanceof Error?oe.message:"Erro desconhecido",variant:"destructive"})}finally{n(!1)}},ge=async p=>{if(!b)return;const ie=parseFloat(p.quantidade_fracionada)||0;try{n(!0);const oe=m.find(Ge=>Ge.id===p.aspiracao_doadora_id),pe=(oe==null?void 0:oe.oocitos_disponiveis)??0,Le=parseInt(p.quantidade_oocitos)||0;if(Le>pe)throw i({title:"Erro de valida√ß√£o",description:`A quantidade de o√≥citos (${Le}) n√£o pode ser maior que os o√≥citos dispon√≠veis (${pe})`,variant:"destructive"}),new Error("Valida√ß√£o falhou");const{data:ye,error:Fe}=await l.from("doses_semen").select("id, quantidade").eq("id",p.dose_semen_id).single();if(Fe)throw Fe;const Me=(ye==null?void 0:ye.quantidade)??0;if(Me<ie)throw i({title:"Estoque insuficiente",description:`Quantidade dispon√≠vel (${Me}) √© menor que a quantidade fracionada (${ie}).`,variant:"destructive"}),new Error("Estoque insuficiente");const Ue={lote_fiv_id:b.id,aspiracao_doadora_id:p.aspiracao_doadora_id,dose_semen_id:p.dose_semen_id,quantidade_fracionada:ie,quantidade_oocitos:Le>0?Le:null,observacoes:p.observacoes||null},{error:qe}=await l.from("lote_fiv_acasalamentos").insert([Ue]);if(qe)throw qe;const Qe=Me-ie,{error:Ze}=await l.from("doses_semen").update({quantidade:Qe}).eq("id",(ye==null?void 0:ye.id)||"");if(Ze)throw Ze;i({title:"Acasalamento adicionado",description:"Acasalamento adicionado com sucesso"}),await k(b.id)}catch(oe){const pe=oe instanceof Error?oe.message:"Erro desconhecido";throw!pe.includes("Valida√ß√£o")&&!pe.includes("Estoque")&&i({title:"Erro ao adicionar acasalamento",description:pe.includes("RLS")||pe.includes("policy")?"RLS est√° bloqueando escrita. Configure pol√≠ticas anon no Supabase.":pe,variant:"destructive"}),oe}finally{n(!1)}};return ee&&!b?e.jsx(ba,{}):b&&v?e.jsx(ds,{lote:b,acasalamentos:E,aspiracoesDisponiveis:m,dosesDisponiveis:U,dosesDisponiveisNoLote:N,doadoras:K,clientes:Y,historicoDespachos:L,dataAspiracao:D,fazendaOrigemNome:q,fazendasDestinoNomes:u,submitting:$,onBack:()=>{V(!1),se(null)},onAddAcasalamento:ge,onDespacharEmbrioes:ae,onUpdateQuantidadeEmbrioes:(p,ie)=>{f({...x,[p]:ie})},editQuantidadeEmbrioes:x,onUpdateClivados:async(p,ie)=>{W({...S,[p]:ie});const oe=parseInt(ie)||null;await l.from("lote_fiv_acasalamentos").update({embrioes_clivados_d3:oe}).eq("id",p)},editClivados:S}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(Ua,{title:"Lotes FIV",description:"Gerenciar lotes de fecunda√ß√£o in vitro",actions:e.jsx(ns,{pacotes:w,clientes:Y,fazendas:X})}),e.jsxs(He,{children:[e.jsx(ke,{children:e.jsx(Ve,{children:"Lista de Lotes FIV"})}),e.jsx(Re,{children:e.jsxs(Qa,{value:na,onValueChange:p=>g(p),children:[e.jsxs(Za,{className:"mb-6",children:[e.jsx(Ea,{value:"ativos",children:"Lotes Ativos"}),e.jsx(Ea,{value:"historico",children:"Hist√≥rico"})]}),e.jsxs(za,{value:"ativos",className:"mt-0",children:[e.jsxs("div",{className:"flex gap-4 mb-6 flex-wrap",children:[e.jsxs("div",{className:"flex-1 min-w-[250px] relative fazenda-busca-container",children:[e.jsx(de,{htmlFor:"filtro-fazenda-aspira√ß√£o",children:"Filtrar por Fazenda da Aspira√ß√£o"}),e.jsxs("div",{className:"relative",children:[e.jsx(Oe,{id:"filtro-fazenda-aspira√ß√£o",placeholder:"Digite para buscar fazenda...",value:J,onChange:p=>{te(p.target.value),z(!0),p.target.value||y("")},onFocus:()=>z(!0)}),c&&e.jsx(re,{variant:"ghost",size:"sm",className:"absolute right-1 top-1 h-7 w-7 p-0",onClick:()=>{y(""),te(""),z(!1)},children:e.jsx(Ia,{className:"h-4 w-4"})}),t&&M.length>0&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-white border rounded-md shadow-lg max-h-60 overflow-auto",children:M.map(p=>e.jsx("div",{className:"px-4 py-2 hover:bg-slate-100 cursor-pointer",onClick:()=>{y(p.id),te(p.nome),z(!1)},children:p.nome},p.id))}),t&&J&&M.length===0&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-white border rounded-md shadow-lg p-4 text-sm text-slate-500",children:"Nenhuma fazenda encontrada"})]})]}),e.jsxs("div",{className:"flex-1 min-w-[200px]",children:[e.jsx(de,{htmlFor:"filtro-dia-cultivo",children:"Filtrar por Dia do Cultivo"}),e.jsxs(ea,{value:ne||void 0,onValueChange:p=>xe(p||""),children:[e.jsx(aa,{id:"filtro-dia-cultivo",children:e.jsx(sa,{placeholder:"Todos os dias"})}),e.jsx(ta,{children:[0,1,2,3,4,5,6,7,8].map(p=>e.jsxs(oa,{value:p.toString(),children:["D",p," - ",la(p)]},p))})]})]}),(c||ne)&&e.jsx("div",{className:"flex items-end",children:e.jsx(re,{variant:"outline",onClick:Q,children:"Limpar Filtros"})})]}),F.length===0?e.jsx(Ca,{title:R.length===0?"Nenhum lote cadastrado":"Nenhum lote encontrado",description:R.length===0?"Crie um novo lote para come√ßar.":"Ajuste os filtros para encontrar outros lotes."}):e.jsxs(Je,{children:[e.jsx(Ke,{children:e.jsxs(ze,{children:[e.jsx(Z,{children:"Aspira√ß√£o"}),e.jsx(Z,{children:"Fazendas Destino"}),e.jsx(Z,{children:"Dia do Cultivo"}),e.jsx(Z,{children:"Acasalamentos"}),e.jsx(Z,{className:"text-right",children:"A√ß√µes"})]})}),e.jsx(We,{children:F.map(p=>e.jsxs(ze,{children:[e.jsxs(G,{children:[p.pacote_data&&we(p.pacote_data)," - ",p.pacote_nome]}),e.jsx(G,{children:e.jsx("div",{className:"flex flex-wrap gap-1",children:p.fazendas_destino_nomes&&p.fazendas_destino_nomes.length>0?p.fazendas_destino_nomes.map((ie,oe)=>e.jsx(Ae,{variant:"outline",className:"text-xs",children:ie},oe)):e.jsx("span",{className:"text-slate-400",children:"-"})})}),e.jsx(G,{children:p.dia_atual!==void 0?e.jsx(Ae,{variant:"outline",className:`font-semibold ${Wa(p.dia_atual===0?-1:p.dia_atual>9?8:p.dia_atual-1)}`,children:(()=>{const ie=p.dia_atual===0?-1:p.dia_atual>9?8:p.dia_atual-1;return ie===-1?`D-1 - ${la(ie)}`:`D${ie} - ${la(ie)}`})()}):e.jsx("span",{className:"text-slate-400",children:"-"})}),e.jsx(G,{children:p.quantidade_acasalamentos??0}),e.jsx(G,{className:"text-right",children:e.jsx(re,{variant:"ghost",size:"sm",onClick:()=>O(`/lotes-fiv/${p.id}`),children:e.jsx(Ka,{className:"w-4 h-4"})})})]},p.id))})]})]}),e.jsx(za,{value:"historico",className:"mt-0",children:e.jsx(cs,{lotesHistoricos:r,fazendas:X,detalhesLoteExpandido:A,loteExpandido:T,loadingHistorico:j,loadingDetalhes:H,filtroHistoricoDataInicio:ce,setFiltroHistoricoDataInicio:ve,filtroHistoricoDataFim:he,setFiltroHistoricoDataFim:Se,filtroHistoricoFazenda:me,setFiltroHistoricoFazenda:je,filtroHistoricoFazendaBusca:fe,setFiltroHistoricoFazendaBusca:De,showFazendaBuscaHistorico:Ce,setShowFazendaBuscaHistorico:ra,historicoPage:ue,setHistoricoPage:le,HISTORICO_PAGE_SIZE:_e,onLoadHistorico:B,onExpandirLote:s})})]})})]})]})}export{Ms as default};
