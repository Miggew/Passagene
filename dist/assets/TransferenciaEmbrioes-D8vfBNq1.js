import{r as i,s as d,h as oa,j as e,g as ke,B as ce,a as ia,A as sa}from"./index-DM5u2d-F.js";import{C as na,a as ca,b as da,d as la}from"./card-B_EQ6x91.js";import{S as qe,a as Be,b as Ve,c as Ge,d as Ze}from"./select-B_NoJ61H.js";import{I as $e}from"./input-CtUEWea1.js";import{L as ae}from"./label-Bhhf9ayq.js";import{T as pa}from"./textarea-Kj1o8r55.js";import{P as _a}from"./PageHeader-JgO8x5IE.js";import{u as aa}from"./use-toast-BOUGyrIz.js";import{b as fa}from"./dataEnrichment-DxfL8bbp.js";import{v as ua}from"./receptoraStatus-Bbt-P6Vj.js";import{D as ma,b as ha,c as va,d as ga,e as xa,f as ba}from"./dialog-2y4jBKyr.js";import{T as Je,a as Ke,b as Pe,c as G,d as We,e as Z}from"./table-CEKyj1ed.js";import{F as Ue}from"./file-text-FTh7JeGJ.js";import{B as Oe}from"./badge-D_AVhbx8.js";import{C as ja,Q as Ea}from"./QualidadeSemaforo-CtCykpmc.js";import{T as Na}from"./trash-2-Bf7rr4V6.js";import{S as ra}from"./StatusBadge-CySQHNUG.js";import{T as wa}from"./triangle-alert-ha7v3V29.js";import{S as Ca}from"./switch-Cfl6x_qC.js";import{D as ea}from"./DatePickerBR-BEWFLeoy.js";import"./index-ClZPXJQX.js";import"./index-sCsFC1oc.js";import"./index-CWb7Yp_3.js";import"./index-BEVMOrkK.js";import"./check-Y5eEMkO8.js";import"./x-DsJYRTDR.js";import"./popover-CNdtTvFz.js";import"./statusLabels-IklKT8dE.js";import"./calendar-B_KmJ-VL.js";const Aa=!0;function Ra({dataPasso2:a,incluirCioLivre:_,filtroClienteId:E,filtroRaca:z,formData:x}){const{toast:C}=aa(),[c,R]=i.useState([]),[j,S]=i.useState([]),[p,N]=i.useState([]),[O,l]=i.useState([]),[h,k]=i.useState([]),[M,I]=i.useState([]),[Y,K]=i.useState(!0),[de,je]=i.useState(!1),[A,we]=i.useState([]),[ve,ge]=i.useState([]),[H,Ce]=i.useState({}),[P,re]=i.useState({}),L=i.useCallback(async r=>{var g,m;if(!r.fazenda_id||!((((g=r.transferenciasIdsSessao)==null?void 0:g.length)||0)>0||(((m=r.transferenciasSessao)==null?void 0:m.length)||0)>0))return;let f=null;if(r.pacote_id){const v=r.pacote_id.substring(0,36);/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(v)&&(f=v)}const b={fazenda_id:r.fazenda_id,pacote_id:f,data_passo2:r.data_passo2||null,data_te:r.data_te||null,veterinario_responsavel:r.veterinario_responsavel||null,tecnico_responsavel:r.tecnico_responsavel||null,origem_embriao:r.origem_embriao||null,filtro_cliente_id:r.filtro_cliente_id||null,filtro_raca:r.filtro_raca||null,incluir_cio_livre:!!r.incluir_cio_livre,transferencias_ids:r.transferenciasIdsSessao||[],protocolo_receptora_ids:r.transferenciasSessao||[],status:"ABERTA",updated_at:new Date().toISOString()};await d.from("transferencias_sessoes").upsert(b,{onConflict:"fazenda_id,status"})},[]),y=i.useCallback(async r=>{r&&await d.from("transferencias_sessoes").update({status:"ENCERRADA",updated_at:new Date().toISOString()}).eq("fazenda_id",r).eq("status","ABERTA")},[]),ee=i.useCallback(r=>{const n=Array.isArray(r==null?void 0:r.transferencias_ids)?r.transferencias_ids:[],f=Array.isArray(r==null?void 0:r.protocolo_receptora_ids)?r.protocolo_receptora_ids:[],b=(r==null?void 0:r.origem_embriao)==="CONGELADO"?"CONGELADO":"PACOTE",g=(r==null?void 0:r.data_te)||new Date().toISOString().split("T")[0];return{transferenciasIds:n,protocoloReceptoraIds:f,filtros:{origem_embriao:b,filtro_cliente_id:(r==null?void 0:r.filtro_cliente_id)||"",filtro_raca:(r==null?void 0:r.filtro_raca)||"",data_passo2:(r==null?void 0:r.data_passo2)||new Date().toISOString().split("T")[0],incluir_cio_livre:!!(r!=null&&r.incluir_cio_livre)},camposPacote:{data_te:g,veterinario_responsavel:(r==null?void 0:r.veterinario_responsavel)||"",tecnico_responsavel:(r==null?void 0:r.tecnico_responsavel)||""},formData:{fazenda_id:(r==null?void 0:r.fazenda_id)||"",pacote_id:(r==null?void 0:r.pacote_id)||"",protocolo_id:(r==null?void 0:r.protocolo_id)||"",data_te:g,veterinario_responsavel:(r==null?void 0:r.veterinario_responsavel)||"",tecnico_responsavel:(r==null?void 0:r.tecnico_responsavel)||""}}},[]),le=i.useCallback(r=>{ge(r.transferenciasIds),we(r.protocoloReceptoraIds)},[]),pe=i.useCallback(async()=>{try{const{data:r}=await d.from("transferencias_sessoes").select("*").eq("status","ABERTA").order("updated_at",{ascending:!1}).limit(1);if(r&&r.length>0){const n=r[0],f=Array.isArray(n==null?void 0:n.transferencias_ids)?n.transferencias_ids:[];let b=Array.isArray(n==null?void 0:n.protocolo_receptora_ids)?n.protocolo_receptora_ids:[];if(b.length===0&&f.length>0){const{data:v}=await d.from("transferencias_embrioes").select("protocolo_receptora_id").in("id",f);v&&(b=[...new Set(v.map(D=>D.protocolo_receptora_id).filter(D=>!!D))])}let g=!1;if(b.length>0){const{data:v}=await d.from("protocolo_receptoras").select("id, status").in("id",b);v&&(g=v.some(D=>D.status!=="UTILIZADA"))}if(!g)return await d.from("transferencias_sessoes").update({status:"ENCERRADA",updated_at:new Date().toISOString()}).eq("id",n.id),null;const m=ee(n);return le({transferenciasIds:m.transferenciasIds,protocoloReceptoraIds:m.protocoloReceptoraIds}),m}return null}catch{return null}},[ee,le]),fe=i.useCallback(async()=>{try{const{data:r,error:n}=await d.from("clientes").select("id, nome").order("nome",{ascending:!0});if(n)throw n;S(r||[])}catch{S([])}},[]),w=i.useCallback(async()=>{try{let r=d.from("protocolos_sincronizacao").select("id");a&&(r=r.eq("passo2_data",a));const{data:n,error:f}=await r;if(f)throw f;const b=[...new Set((n||[]).map($=>$.id).filter(Boolean))];if(b.length===0){R([]),K(!1);return}const{data:g,error:m}=await d.from("v_protocolo_receptoras_status").select("receptora_id").eq("fase_ciclo","SINCRONIZADA").in("protocolo_id",b);if(m)throw m;const v=[...new Set((g||[]).map($=>$.receptora_id).filter(Boolean))];if(v.length===0){R([]),K(!1);return}const{data:D,error:B}=await d.from("vw_receptoras_fazenda_atual").select("fazenda_id_atual").in("receptora_id",v);if(B)throw B;const ue=[...new Set((D||[]).map($=>$.fazenda_id_atual).filter(Boolean))];if(ue.length===0){R([]),K(!1);return}const{data:Ee,error:U}=await d.from("fazendas").select("id, nome").in("id",ue).order("nome",{ascending:!0});if(U)throw U;R(Ee||[]),K(!1)}catch(r){C({title:"Erro ao carregar fazendas",description:r instanceof Error?r.message:"Erro desconhecido",variant:"destructive"}),K(!1)}},[a,C]),q=i.useCallback(async()=>{var r;try{const n=oa(),f=new Date().toISOString().slice(0,10);n===f&&await d.rpc("descartar_embrioes_d9");const[g,m]=await Promise.all([d.from("transferencias_embrioes").select("embriao_id"),d.from("embrioes").select("*").eq("status_atual","FRESCO").order("created_at",{ascending:!1})]),v=((r=g.data)==null?void 0:r.map(t=>t.embriao_id))||[];if(m.error)throw m.error;const D=[...m.data||[]].filter(t=>!v.includes(t.id)&&t.status_atual!=="TRANSFERIDO").sort((t,u)=>{const J=new Date(t.created_at||0).getTime();return new Date(u.created_at||0).getTime()-J});if(!D||D.length===0){N([]);return}const B=D.map(t=>t.id),ue=[...new Set(D.filter(t=>t.lote_fiv_id).map(t=>t.lote_fiv_id))];let Ee=new Map,U=new Map,$=new Map,Re=new Map;const[Le,xe,ye]=await Promise.all([B.length>0?d.from("v_embrioes_disponiveis_te").select("embriao_id, d7_pronto, d8_limite").in("embriao_id",B):Promise.resolve({data:null,error:null}),d.from("fazendas").select("id, nome"),ue.length>0?d.from("lotes_fiv").select("id, pacote_aspiracao_id").in("id",ue):Promise.resolve({data:null,error:null})]),Ie=new Map((Le.data||[]).map(t=>[t.embriao_id,{d7_pronto:t.d7_pronto,d8_limite:t.d8_limite}]));xe.data&&(Re=new Map(xe.data.map(t=>[t.id,t.nome])));const Ne=ye.data;if(Ne&&Ne.length>0){Ne.forEach(u=>{u.pacote_aspiracao_id&&U.set(u.id,u.pacote_aspiracao_id)});const t=[...new Set(Ne.map(u=>u.pacote_aspiracao_id).filter(Boolean))];if(t.length>0){const[u,J]=await Promise.all([d.from("pacotes_aspiracao").select("*").in("id",t),d.from("pacotes_aspiracao_fazendas_destino").select("pacote_aspiracao_id, fazenda_destino_id").in("pacote_aspiracao_id",t)]),X=J.data;X&&X.forEach(T=>{const se=$.get(T.pacote_aspiracao_id)||[];se.includes(T.fazenda_destino_id)||se.push(T.fazenda_destino_id),$.set(T.pacote_aspiracao_id,se)});const he=u.data;he&&he.forEach(T=>{if(T.fazenda_destino_id){const se=$.get(T.id)||[];se.includes(T.fazenda_destino_id)||se.push(T.fazenda_destino_id),$.set(T.id,se)}Ee.set(T.id,{id:T.id,data_aspiracao:T.data_aspiracao,fazenda_nome:Re.get(T.fazenda_id),quantidade_doadoras:0,horario_inicio:T.horario_inicio,veterinario_responsavel:T.veterinario_responsavel,total_oocitos:T.total_oocitos})})}}const De=D.map(t=>t.lote_fiv_acasalamento_id).filter(t=>!!t);let me=new Map,ze=new Map;if(De.length>0){const{data:t}=await d.from("lote_fiv_acasalamentos").select("id, aspiracao_doadora_id, dose_semen_id").in("id",De);if(t){me=new Map(t.map(F=>[F.id,F]));const u=[...new Set(t.map(F=>F.aspiracao_doadora_id).filter(Boolean))],J=[...new Set(t.map(F=>F.dose_semen_id).filter(Boolean))],[X,he]=await Promise.all([u.length>0?d.from("aspiracoes_doadoras").select("id, doadora_id").in("id",u):Promise.resolve({data:null}),J.length>0?d.from("doses_semen").select("id, touro_id, touro:touros(id, nome, registro, raca)").in("id",J):Promise.resolve({data:null})]),T=X.data,se=he.data;if(se&&(ze=new Map(se.map(F=>{const ne=F.touro,be=Array.isArray(ne)?ne[0]:ne;return[F.id,(be==null?void 0:be.nome)||"Touro desconhecido"]})),t.forEach(F=>{if(F.dose_semen_id){const ne=ze.get(F.dose_semen_id);if(ne){const be=me.get(F.id);me.set(F.id,{...be,touro_nome:ne})}}})),T){const F=[...new Set(T.map(ne=>ne.doadora_id))];if(F.length>0){const{data:ne}=await d.from("doadoras").select("id, registro").in("id",F);if(ne){const be=new Map(ne.map(oe=>[oe.id,oe.registro])),Me=new Map(T.map(oe=>[oe.id,oe.doadora_id]));t.forEach(oe=>{if(oe.aspiracao_doadora_id){const Xe=Me.get(oe.aspiracao_doadora_id);if(Xe){const Ye=be.get(Xe);if(Ye){const ta=me.get(oe.id);me.set(oe.id,{...ta,doadora_registro:Ye})}}}})}}}}}const Se=new Map;D.forEach(t=>{var T,se;if(!t.lote_fiv_id||!t.created_at)return;const u=t.created_at.split("T")[0],J=`${t.lote_fiv_id}-${u}`;let X=Se.get(J);if(!X){const F=U.get(t.lote_fiv_id),ne=F?Ee.get(F):void 0,be=F?$.get(F)||[]:[],Me=be.map(oe=>Re.get(oe)).filter(oe=>!!oe);X={id:J,lote_fiv_id:t.lote_fiv_id,data_despacho:u,fazendas_destino_ids:be,fazendas_destino_nomes:Me,pacote_info:ne||{id:F||"",data_aspiracao:u,quantidade_doadoras:0},embrioes:[],total:0,frescos:0,congelados:0},Se.set(J,X)}const he=me.get(t.lote_fiv_acasalamento_id||"");X.embrioes.push({...t,doadora_registro:he==null?void 0:he.doadora_registro,touro_nome:he==null?void 0:he.touro_nome,d7_pronto:(T=Ie.get(t.id))==null?void 0:T.d7_pronto,d8_limite:(se=Ie.get(t.id))==null?void 0:se.d8_limite}),X.total++,t.status_atual==="FRESCO"&&X.frescos++,t.status_atual==="CONGELADO"&&X.congelados++});const Fe=[...new Set(Array.from(Se.values()).map(t=>t.lote_fiv_id))],{data:o}=await d.from("lotes_fiv").select("id, disponivel_para_transferencia").in("id",Fe),V=new Map((o==null?void 0:o.map(t=>[t.id,t.disponivel_para_transferencia===!0]))||[]),s=Array.from(Se.values()).map(t=>{const u=t.embrioes.filter(J=>!J.classificacao||J.classificacao.trim()==="").length;return{pacote:t,semClassificacao:u,total:t.total,disponivel:V.get(t.lote_fiv_id)}}).filter(t=>t.disponivel!==!1&&t.total>0&&t.semClassificacao===0).map(t=>t.pacote).sort((t,u)=>u.data_despacho.localeCompare(t.data_despacho));N(s)}catch(n){C({title:"Erro ao carregar pacotes de embriões",description:n instanceof Error?n.message:"Erro desconhecido",variant:"destructive"}),N([])}},[C]),Q=i.useCallback(async()=>{var n;const r=z.trim().toLowerCase();if(!E&&!r){k([]);return}try{je(!0);let f=d.from("embrioes").select("*").eq("status_atual","CONGELADO").not("cliente_id","is",null);E&&(f=f.eq("cliente_id",E));const[b,g]=await Promise.all([d.from("transferencias_embrioes").select("embriao_id"),f.order("created_at",{ascending:!1})]);if(b.error)throw b.error;if(g.error)throw g.error;const m=((n=b.data)==null?void 0:n.map(D=>D.embriao_id))||[],v=(g.data||[]).filter(D=>!m.includes(D.id)&&D.status_atual!=="TRANSFERIDO");if(v.length===0){k([]);return}k(v)}catch(f){C({title:"Erro ao carregar embriões congelados",description:f instanceof Error?f.message:"Erro desconhecido",variant:"destructive"}),k([])}finally{je(!1)}},[E,z,C]),W=i.useCallback(async r=>{try{const{data:n,error:f}=await d.from("cio_livre").select("receptora_id, data_cio").eq("status","DISPONIVEL").eq("fazenda_id",r);if(f&&f.code!=="PGRST205")throw f;const b=(n||[]).map(B=>B.receptora_id).filter(B=>!!B);if(b.length===0)return{receptoras:[],receptorasDisponiveis:0};const{data:g,error:m}=await d.from("receptoras").select("id, identificacao, status_reprodutivo").in("id",b);if(m)throw m;const v=new Map((n||[]).map(B=>[B.receptora_id,B.data_cio])),D=(g||[]).map(B=>({receptora_id:B.id,brinco:B.identificacao||"N/A",identificacao:B.identificacao||"",protocolo_id:void 0,protocolo_receptora_id:void 0,data_te_prevista:void 0,data_limite_te:void 0,quantidade_embrioes:0,ciclando_classificacao:void 0,qualidade_semaforo:void 0,origem:"CIO_LIVRE",data_cio:v.get(B.id),status_reprodutivo:B.status_reprodutivo}));return{receptoras:D,receptorasDisponiveis:D.length}}catch(n){return C({title:"Erro ao carregar receptoras",description:n instanceof Error?n.message:"Erro desconhecido",variant:"destructive"}),{receptoras:[],receptorasDisponiveis:0}}},[C]),ie=i.useCallback(async(r,n)=>{const f=(n==null?void 0:n.contagem)??H,b=(n==null?void 0:n.info)??P;try{let g=d.from("protocolos_sincronizacao").select("id");a&&(g=g.eq("passo2_data",a));const{data:m,error:v}=await g;if(v)throw v;const D=[...new Set((m||[]).map(s=>s.id).filter(Boolean))];if(D.length===0)return I([]),{receptorasDisponiveis:0};const{data:B,error:ue}=await d.from("v_protocolo_receptoras_status").select("receptora_id, brinco, data_te_prevista, data_limite_te, protocolo_id").eq("fase_ciclo","SINCRONIZADA").in("protocolo_id",D);if(ue&&ue.code!=="PGRST205")throw ue;const Ee=B||[],U=[...new Set(Ee.map(s=>s.receptora_id).filter(Boolean))];if(U.length===0)return I([]),{receptorasDisponiveis:0};const{data:$,error:Re}=await d.from("vw_receptoras_fazenda_atual").select("receptora_id").in("receptora_id",U).eq("fazenda_id_atual",r);if(Re)throw Re;const Le=new Set(($||[]).map(s=>s.receptora_id).filter(Boolean)),xe=Ee.filter(s=>Le.has(s.receptora_id)),ye=[...new Set(xe.map(s=>s.receptora_id).filter(Boolean))];if(ye.length===0)return I([]),{receptorasDisponiveis:0};const{data:Ie,error:Ne}=await d.from("receptoras").select("id, identificacao, status_reprodutivo").in("id",ye);if(Ne)throw Ne;const De=new Map((Ie||[]).map(s=>[s.id,s])),me=[...new Set(xe.map(s=>s.protocolo_id).filter(Boolean))];let ze=[];if(me.length>0){const{data:s,error:t}=await d.from("protocolo_receptoras").select("id, receptora_id, protocolo_id, status, ciclando_classificacao, qualidade_semaforo").in("protocolo_id",me).neq("status","INAPTA").neq("status","UTILIZADA");if(t&&t.code!=="PGRST205")throw t;ze=s||[]}const Se=new Map(ze.map(s=>[s.receptora_id,s]));let o=xe.map(s=>{const t=De.get(s.receptora_id),u=Se.get(s.receptora_id),J=f[s.receptora_id]||0;return{receptora_id:s.receptora_id,brinco:s.brinco||(t==null?void 0:t.identificacao)||"N/A",identificacao:(t==null?void 0:t.identificacao)||"",protocolo_id:(u==null?void 0:u.protocolo_id)||s.protocolo_id,protocolo_receptora_id:(u==null?void 0:u.id)||"",data_te_prevista:s.data_te_prevista,data_limite_te:s.data_limite_te,quantidade_embrioes:J,ciclando_classificacao:(u==null?void 0:u.ciclando_classificacao)??null,qualidade_semaforo:(u==null?void 0:u.qualidade_semaforo)??null,origem:"PROTOCOLO",status_reprodutivo:t==null?void 0:t.status_reprodutivo}}).filter(s=>s.status_reprodutivo==="SINCRONIZADA"||f[s.receptora_id]>0);if(_){const{receptoras:s}=await W(r);o=[...o,...s]}const V=Object.values(b).filter(s=>(f[s.receptora_id]||0)>=1),te=new Set(o.map(s=>s.receptora_id));return V.forEach(s=>{te.has(s.receptora_id)||o.push({...s,quantidade_embrioes:f[s.receptora_id]||0})}),o=o.map(s=>({...s,quantidade_embrioes:f[s.receptora_id]||0})),I(o),{receptorasDisponiveis:o.length}}catch(g){return C({title:"Erro ao carregar receptoras",description:g instanceof Error?g.message:"Erro desconhecido",variant:"destructive"}),I([]),{receptorasDisponiveis:0}}},[a,_,H,P,W,C]),Ae=i.useCallback(async(r,n)=>{await ie(r,n)},[ie]);return i.useEffect(()=>{if(x.fazenda_id){const r=p.filter(n=>n.fazendas_destino_ids.includes(x.fazenda_id));l(r)}else l([])},[x.fazenda_id,p]),i.useEffect(()=>{(async()=>{if(ve.length===0){Ce({}),re({});return}const{data:n,error:f}=await d.from("transferencias_embrioes").select("id, receptora_id, protocolo_receptora_id, receptoras(id, identificacao, status_reprodutivo)").in("id",ve);if(f)return;const b={},g={};(n||[]).forEach(m=>{if(!m.receptora_id)return;b[m.receptora_id]=(b[m.receptora_id]||0)+1;const v=Array.isArray(m.receptoras)?m.receptoras[0]:m.receptoras;g[m.receptora_id]={receptora_id:m.receptora_id,brinco:(v==null?void 0:v.identificacao)||"N/A",identificacao:(v==null?void 0:v.identificacao)||"",protocolo_id:void 0,protocolo_receptora_id:m.protocolo_receptora_id||"",quantidade_embrioes:b[m.receptora_id],origem:m.protocolo_receptora_id?"PROTOCOLO":"CIO_LIVRE",status_reprodutivo:(v==null?void 0:v.status_reprodutivo)||"SERVIDA"}}),Ce(b),re(g)})()},[ve]),{fazendas:c,clientes:j,pacotes:p,pacotesFiltrados:O,embrioesCongelados:h,receptoras:M,setReceptoras:I,loading:Y,loadingCongelados:de,transferenciasSessao:A,setTransferenciasSessao:we,transferenciasIdsSessao:ve,setTransferenciasIdsSessao:ge,contagemSessaoPorReceptora:H,setContagemSessaoPorReceptora:Ce,receptorasSessaoInfo:P,setReceptorasSessaoInfo:re,loadFazendas:w,loadPacotes:q,loadClientes:fe,loadEmbrioesCongelados:Q,carregarReceptorasDaFazenda:ie,recarregarReceptoras:Ae,salvarSessaoNoBanco:L,encerrarSessaoNoBanco:y,restaurarSessaoEmAndamento:pe}}const _e={origemEmbriao:"PACOTE",filtroClienteId:"",filtroRaca:"",dataPasso2:"",incluirCioLivre:!1,embrioesPage:1},Te={showRelatorioDialog:!1,relatorioData:[],isVisualizacaoApenas:!1};function Sa(){const[a,_]=i.useState(_e.origemEmbriao),[E,z]=i.useState(_e.filtroClienteId),[x,C]=i.useState(_e.filtroRaca),[c,R]=i.useState(_e.dataPasso2),[j,S]=i.useState(_e.incluirCioLivre),[p,N]=i.useState(_e.embrioesPage),[O,l]=i.useState(Te.showRelatorioDialog),[h,k]=i.useState(Te.relatorioData),[M,I]=i.useState(Te.isVisualizacaoApenas),Y=i.useCallback(()=>{_(_e.origemEmbriao),z(_e.filtroClienteId),C(_e.filtroRaca),R(_e.dataPasso2),S(_e.incluirCioLivre),N(_e.embrioesPage)},[]),K=i.useCallback(()=>{l(Te.showRelatorioDialog),k(Te.relatorioData),I(Te.isVisualizacaoApenas)},[]),de=i.useCallback(()=>{Y(),K()},[Y,K]),je=i.useCallback(H=>{k(H),I(!0),l(!0)},[]),A=i.useCallback(H=>{k(H),I(!1),l(!0)},[]),we=i.useCallback(()=>{l(!1),I(!1)},[]),ve=i.useCallback(H=>{_(H.origem_embriao==="CONGELADO"?"CONGELADO":"PACOTE"),z(H.filtro_cliente_id||""),C(H.filtro_raca||""),R(H.data_passo2||new Date().toISOString().split("T")[0]),S(!!H.incluir_cio_livre),H.embrioes_page&&N(H.embrioes_page)},[]),ge=i.useCallback(()=>({origemEmbriao:a,filtroClienteId:E,filtroRaca:x,dataPasso2:c,incluirCioLivre:j,embrioesPage:p}),[a,E,x,c,j,p]);return{origemEmbriao:a,setOrigemEmbriao:_,filtroClienteId:E,setFiltroClienteId:z,filtroRaca:x,setFiltroRaca:C,dataPasso2:c,setDataPasso2:R,incluirCioLivre:j,setIncluirCioLivre:S,embrioesPage:p,setEmbrioesPage:N,showRelatorioDialog:O,setShowRelatorioDialog:l,relatorioData:h,setRelatorioData:k,isVisualizacaoApenas:M,setIsVisualizacaoApenas:I,resetFilters:Y,resetRelatorio:K,resetAll:de,abrirRelatorioVisualizacao:je,abrirRelatorioEncerramento:A,fecharRelatorio:we,aplicarFiltrosSessao:ve,getFiltersState:ge}}function Da({formData:a,setFormData:_,origemEmbriao:E,receptoras:z,contagemSessaoPorReceptora:x,setContagemSessaoPorReceptora:C,receptorasSessaoInfo:c,setReceptorasSessaoInfo:R,transferenciasSessao:j,setTransferenciasSessao:S,transferenciasIdsSessao:p,setTransferenciasIdsSessao:N,numerosFixosMap:O,setSubmitting:l,setRelatorioData:h,setShowRelatorioDialog:k,setIsVisualizacaoApenas:M,resetFiltros:I,loadPacotes:Y,loadEmbrioesCongelados:K,recarregarReceptoras:de,encerrarSessaoNoBanco:je}){const{toast:A}=aa(),we=i.useCallback(async()=>{if(!a.receptora_id){A({title:"Nenhuma receptora selecionada",description:"Selecione uma receptora para descartar.",variant:"destructive"});return}const P=z.find(y=>y.receptora_id===a.receptora_id),re=(P==null?void 0:P.brinco)||a.receptora_id,L=(P==null?void 0:P.origem)||"PROTOCOLO";try{if(l(!0),L==="CIO_LIVRE"){const{error:y}=await d.from("cio_livre").update({status:"DESCARTADA"}).eq("receptora_id",a.receptora_id).eq("status","DISPONIVEL");if(y)throw y}else if(a.protocolo_receptora_id){const{error:y}=await d.from("protocolo_receptoras").update({status:"INAPTA",motivo_inapta:"Descartada no menu de TE - não recebeu embrião"}).eq("id",a.protocolo_receptora_id);if(y)throw y}a.receptora_id&&await d.from("receptoras").update({status_reprodutivo:"VAZIA"}).eq("id",a.receptora_id),A({title:"Receptora descartada",description:L==="CIO_LIVRE"?`${re} foi descartada e saiu da lista de cio livre.`:`${re} foi descartada e não receberá embrião neste protocolo.`}),_(y=>({...y,receptora_id:"",protocolo_receptora_id:""})),a.fazenda_id&&await de(a.fazenda_id)}catch(y){A({title:"Erro ao descartar receptora",description:y instanceof Error?y.message:"Erro desconhecido",variant:"destructive"})}finally{l(!1)}},[a,z,_,l,de,A]),ve=i.useCallback(async P=>{var le,pe,fe,w;P.preventDefault();const re=E==="PACOTE";if(!a.embriao_id){A({title:"Embrião não selecionado",description:"Por favor, selecione um embrião para realizar a transferência.",variant:"destructive"});return}if(!a.fazenda_id||!a.receptora_id||!a.data_te||re&&!a.pacote_id){A({title:"Erro de validação",description:"Todos os campos obrigatórios devem ser preenchidos",variant:"destructive"});return}const L=z.find(q=>q.receptora_id===a.receptora_id);if(!L){A({title:"Receptora não disponível",description:"A receptora selecionada não está disponível para transferência.",variant:"destructive"});return}const y=x[a.receptora_id]||0,ee=y===1;if(y>=2){A({title:"Limite atingido",description:"Esta receptora já recebeu o máximo de 2 embriões permitidos.",variant:"destructive"});return}if(a.receptora_id&&!ee){const q=L.status_reprodutivo||"VAZIA",Q=L.origem==="CIO_LIVRE"?"SINCRONIZADA":q,W=ua(Q,"REALIZAR_TE");if(!W.valido){A({title:"Erro de validação",description:W.mensagem||"A receptora não pode receber embrião no estado atual",variant:"destructive"});return}}if(!a.veterinario_responsavel||a.veterinario_responsavel.trim()===""){A({title:"Erro de validação",description:"Veterinário responsável é obrigatório. Por favor, informe o nome do veterinário.",variant:"destructive"});return}try{l(!0);const q={embriao_id:a.embriao_id,receptora_id:a.receptora_id,protocolo_receptora_id:a.protocolo_receptora_id||null,data_te:a.data_te,tipo_te:E==="CONGELADO"?"CONGELADO":"FRESCO",veterinario_responsavel:a.veterinario_responsavel.trim(),tecnico_responsavel:((le=a.tecnico_responsavel)==null?void 0:le.trim())||null,status_te:"REALIZADA",observacoes:((pe=a.observacoes)==null?void 0:pe.trim())||null},{data:Q,error:W}=await d.from("transferencias_embrioes").insert([q]).select("id");if(W){if(W.code==="23505"&&((fe=W.message)!=null&&fe.includes("unq_embriao_te_realizada"))){E==="CONGELADO"?K():Y();return}throw W}Q&&((w=Q[0])!=null&&w.id)&&N(r=>[...r,Q[0].id]),await d.from("embrioes").update({status_atual:"TRANSFERIDO"}).eq("id",a.embriao_id),a.protocolo_receptora_id&&S(r=>r.includes(a.protocolo_receptora_id)?r:[...r,a.protocolo_receptora_id]);const ie={...x};ie[a.receptora_id]=(ie[a.receptora_id]||0)+1,C(ie);const Ae={...c};Ae[a.receptora_id]={...L,quantidade_embrioes:ie[a.receptora_id]},R(Ae),A({title:"Transferência registrada",description:`Embrião transferido para ${L.brinco} com sucesso.`}),_(r=>({...r,embriao_id:"",receptora_id:"",protocolo_receptora_id:"",observacoes:""})),E==="CONGELADO"?K():Y(),a.fazenda_id&&await de(a.fazenda_id,{contagem:ie,info:Ae})}catch(q){A({title:"Erro ao registrar transferência",description:q instanceof Error?q.message:"Erro desconhecido",variant:"destructive"})}finally{l(!1)}},[a,E,z,x,c,_,l,N,S,C,R,Y,K,de,A]),ge=i.useCallback(async(P=!1)=>{if(!(p.length>0)){P||A({title:"Nenhuma transferência na sessão",description:"Não há transferências para gerar relatório.",variant:"destructive"});return}try{const{data:L,error:y}=await d.from("transferencias_embrioes").select(`
          *,
          embrioes (id, identificacao, classificacao, status_atual, lote_fiv_id, lote_fiv_acasalamento_id),
          receptoras (id, identificacao, nome)
        `).in("id",p).eq("status_te","REALIZADA").order("created_at",{ascending:!0});if(y)throw y;if(!L||L.length===0){A({title:"Erro ao gerar relatório",description:"Não foi possível encontrar as transferências da sessão.",variant:"destructive"});return}const ee=L.map(w=>{var q;return(q=w.embrioes)==null?void 0:q.lote_fiv_acasalamento_id}).filter(w=>!!w),{doadorasMap:le,tourosMap:pe}=await fa(ee),fe=L.map(w=>{var r,n,f,b,g;const q=(r=w.embrioes)==null?void 0:r.lote_fiv_acasalamento_id,Q=q&&le.get(q)||"N/A",W=q&&pe.get(q)||"N/A";return{numero_embriao:((n=w.embrioes)==null?void 0:n.identificacao)||(O&&O.get(w.embriao_id||"")?String(O.get(w.embriao_id||"")):null)||(w.embriao_id?w.embriao_id.substring(0,8):"N/A"),doadora:Q,touro:W,classificacao:((f=w.embrioes)==null?void 0:f.classificacao)||"N/A",receptora_brinco:((b=w.receptoras)==null?void 0:b.identificacao)||"N/A",receptora_nome:((g=w.receptoras)==null?void 0:g.nome)||"N/A",data_te:w.data_te,veterinario:w.veterinario_responsavel||"N/A",tecnico:w.tecnico_responsavel||"N/A",observacoes:w.observacoes||""}});h(fe),k(!0)}catch(L){A({title:"Erro ao gerar relatório",description:L instanceof Error?L.message:"Erro desconhecido",variant:"destructive"}),M(!1)}},[p,O,h,k,M,A]),H=i.useCallback(async()=>{if(p.length===0){A({title:"Nenhuma transferência na sessão",description:"Não há transferências para visualizar.",variant:"destructive"});return}M(!0),await ge(!0)},[p,M,ge,A]),Ce=i.useCallback(async()=>{if(p.length===0){A({title:"Nenhuma transferência na sessão",description:"Não há transferências para encerrar nesta sessão.",variant:"destructive"});return}try{l(!0);let P=[...j];if(P.length===0){const{data:pe,error:fe}=await d.from("transferencias_embrioes").select("protocolo_receptora_id").in("id",p);if(fe)throw fe;P=[...new Set((pe||[]).map(w=>w.protocolo_receptora_id).filter(w=>!!w))]}const{data:re,error:L}=await d.from("transferencias_embrioes").select("receptora_id").in("id",p).eq("status_te","REALIZADA");if(L)throw L;const y=[...new Set((re||[]).map(pe=>pe.receptora_id).filter(Boolean))];if(y.length===0)throw new Error("Nenhuma receptora encontrada para encerrar a sessão.");const{error:ee}=await d.rpc("encerrar_sessao_te",{p_receptora_ids:y,p_protocolo_receptora_ids:P});if(ee)throw(ee==null?void 0:ee.code)==="PGRST202"?new Error("Função encerrar_sessao_te não encontrada no banco. Aplique o SQL em docs/db/003_encerrar_sessao_te.sql e tente novamente."):ee;await je(a.fazenda_id),A({title:"Sessão encerrada",description:`${p.length} transferência(s) finalizada(s) com sucesso.`});const le=a.fazenda_id;_({fazenda_id:"",pacote_id:"",protocolo_id:"",embriao_id:"",receptora_id:"",protocolo_receptora_id:"",data_te:new Date().toISOString().split("T")[0],veterinario_responsavel:"",tecnico_responsavel:"",observacoes:""}),S([]),N([]),C({}),R({}),I(),await Y(),le&&await de(le)}catch(P){A({title:"Erro ao encerrar sessão",description:P instanceof Error?P.message:"Erro desconhecido",variant:"destructive"})}finally{l(!1)}},[a,j,p,_,l,S,N,C,R,I,Y,de,je,A]);return{handleDescartarReceptora:we,handleSubmit:ve,visualizarRelatorioSessao:H,gerarRelatorioSessao:ge,handleEncerrarSessao:Ce}}function za({open:a,onOpenChange:_,relatorioData:E,fazendaNome:z,dataTe:x,veterinarioResponsavel:C,tecnicoResponsavel:c,isVisualizacaoApenas:R,submitting:j,onFechar:S,onConfirmarEncerrar:p}){return e.jsx(ma,{open:a,onOpenChange:_,children:e.jsxs(ha,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(va,{children:[e.jsxs(ga,{className:"flex items-center gap-2",children:[e.jsx(Ue,{className:"w-5 h-5"}),"Relatório da Sessão de Transferência de Embriões"]}),e.jsxs(xa,{children:["Fazenda: ",z||"N/A"," | Data da TE: ",x?ke(x):"N/A"," | Total: ",E.length," transferência(s)"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Veterinário Responsável:"})," ",C||"N/A"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Técnico Responsável:"})," ",c||"N/A"]})]}),e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsxs(Je,{children:[e.jsx(Ke,{children:e.jsxs(Pe,{children:[e.jsx(G,{className:"text-center",children:"Código"}),e.jsx(G,{children:"Doadora"}),e.jsx(G,{children:"Touro"}),e.jsx(G,{children:"Classificação"}),e.jsx(G,{children:"Receptora (Brinco)"}),e.jsx(G,{children:"Receptora (Nome)"}),e.jsx(G,{children:"Data TE"}),e.jsx(G,{children:"Observações"})]})}),e.jsx(We,{children:E.map((N,O)=>e.jsxs(Pe,{children:[e.jsx(Z,{className:"text-center font-semibold",children:N.numero_embriao}),e.jsx(Z,{children:N.doadora}),e.jsx(Z,{children:N.touro}),e.jsx(Z,{children:N.classificacao}),e.jsx(Z,{className:"font-semibold",children:N.receptora_brinco}),e.jsx(Z,{children:N.receptora_nome}),e.jsx(Z,{children:N.data_te?ke(N.data_te):"N/A"}),e.jsx(Z,{className:"text-sm text-slate-600",children:N.observacoes||"-"})]},O))})]})})]}),e.jsxs(ba,{children:[e.jsx(ce,{type:"button",variant:"outline",onClick:S,children:"Fechar"}),!R&&e.jsx(ce,{type:"button",onClick:async()=>{S(),await p()},className:"bg-blue-600 hover:bg-blue-700",disabled:j,children:j?"Encerrando...":"Confirmar e Encerrar Sessão"})]})]})})}function ya({receptoras:a,selectedReceptoraId:_,contagemSessaoPorReceptora:E,submitting:z,onSelectReceptora:x,onDescartarReceptora:C}){return e.jsxs("div",{className:"space-y-2",children:[e.jsx(ae,{children:"6. Selecionar Receptora *"}),e.jsx("div",{className:"border rounded-lg p-4 max-h-60 overflow-y-auto",children:a.length===0?e.jsx("p",{className:"text-sm text-slate-500",children:"Nenhuma receptora sincronizada encontrada para esta fazenda."}):e.jsx("div",{className:"space-y-2",children:a.map(c=>{const R=E[c.receptora_id]||0,j=R<2,S=_===c.receptora_id;return e.jsxs("div",{className:`flex items-center justify-between p-2 rounded cursor-pointer ${S?"bg-green-100 border-green-500 border":j?"hover:bg-slate-50":"opacity-50 cursor-not-allowed"}`,onClick:()=>{j&&x(c.receptora_id,c.protocolo_receptora_id||"")},children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"receptora",checked:S,onChange:()=>{},disabled:!j,className:"w-4 h-4"}),e.jsx("span",{className:"font-medium",children:c.brinco}),c.origem==="CIO_LIVRE"&&e.jsx(Oe,{variant:"outline",className:"text-xs bg-purple-50 text-purple-700",children:"CIO LIVRE"}),c.ciclando_classificacao&&e.jsx(ja,{classificacao:c.ciclando_classificacao}),c.qualidade_semaforo&&e.jsx(Ea,{qualidade:c.qualidade_semaforo})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[R>0&&e.jsxs(Oe,{variant:"secondary",children:[R,"/2 embriões"]}),S&&e.jsx(ce,{type:"button",variant:"ghost",size:"sm",onClick:p=>{p.stopPropagation(),C()},className:"text-red-600 hover:text-red-700 hover:bg-red-50",disabled:z,children:e.jsx(Na,{className:"w-4 h-4"})})]})]},c.receptora_id)})})})]})}const He=20;function Ia({pacote:a,embrioes:_,numerosFixosMap:E,selectedEmbriaoId:z,embrioesPage:x,hasD8Limite:C,onSelectEmbriao:c,onPageChange:R}){const j=[..._].sort((l,h)=>{const k=l.identificacao||"",M=h.identificacao||"";if(k&&M)return k.localeCompare(M);if(k&&!M)return-1;if(!k&&M)return 1;const I=E.get(l.id)||9999,Y=E.get(h.id)||9999;return I-Y}),S=Math.max(1,Math.ceil(j.length/He)),p=Math.min(x,S),N=(p-1)*He,O=j.slice(N,N+He);return e.jsxs("div",{className:"space-y-4",children:[e.jsx(ae,{children:"7. Selecionar Embrião do Pacote *"}),e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"font-semibold text-slate-900",children:"Pacote selecionado"}),e.jsxs("p",{className:"text-sm text-slate-600",children:["Data Despacho: ",ke(a.data_despacho)," | Total: ",a.total," embrião(ões)"]}),C&&e.jsxs("div",{className:"mt-2 flex items-center gap-2 text-sm text-amber-700",children:[e.jsx(wa,{className:"w-4 h-4"}),"Embriões em D8: transferir ou congelar hoje. No D9 serão descartados automaticamente."]})]}),e.jsxs("div",{className:"max-h-96 overflow-y-auto",children:[e.jsxs(Je,{children:[e.jsx(Ke,{children:e.jsxs(Pe,{children:[e.jsx(G,{className:"w-12"}),e.jsx(G,{className:"text-center w-28",children:"Código"}),e.jsx(G,{children:"Doadora"}),e.jsx(G,{children:"Touro"}),e.jsx(G,{children:"Classificação"}),e.jsx(G,{children:"Status"}),e.jsx(G,{children:"Dia"})]})}),e.jsx(We,{children:O.map(l=>{const h=E.get(l.id)||0;return e.jsxs(Pe,{className:z===l.id?"bg-green-50":"cursor-pointer hover:bg-slate-50",onClick:()=>c(l.id),children:[e.jsx(Z,{children:e.jsx("input",{type:"radio",name:"embriao",value:l.id,checked:z===l.id,onChange:()=>c(l.id),className:"w-4 h-4"})}),e.jsx(Z,{className:"text-center font-medium font-mono text-xs",children:l.identificacao||`#${h}`}),e.jsx(Z,{children:l.doadora_registro||"-"}),e.jsx(Z,{children:l.touro_nome||"-"}),e.jsx(Z,{children:l.classificacao?e.jsx(Oe,{variant:"outline",children:l.classificacao}):e.jsx("span",{className:"text-slate-400",children:"-"})}),e.jsx(Z,{children:e.jsx(ra,{status:l.status_atual})}),e.jsx(Z,{children:l.d8_limite?e.jsx(Oe,{variant:"destructive",children:"D8"}):l.d7_pronto?e.jsx(Oe,{variant:"outline",className:"bg-emerald-50 text-emerald-700 border-emerald-200",children:"D7"}):e.jsx("span",{className:"text-slate-400",children:"-"})})]},l.id)})})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-between text-sm text-slate-600",children:[e.jsxs("div",{children:[_.length," embrião(ões) disponíveis"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ce,{type:"button",variant:"outline",size:"sm",onClick:()=>R(Math.max(1,x-1)),disabled:x===1,children:"Anterior"}),e.jsxs("span",{children:["Página ",p," de ",S]}),e.jsx(ce,{type:"button",variant:"outline",size:"sm",onClick:()=>R(Math.min(S,x+1)),disabled:x>=S,children:"Próxima"})]})]})]})]})]})}const Qe=20;function Ta({embrioes:a,selectedEmbriaoId:_,embrioesPage:E,loadingCongelados:z,filtroClienteId:x,filtroRaca:C,onSelectEmbriao:c,onPageChange:R}){const j=x||C.trim(),S=[...a].sort((h,k)=>{const M=h.created_at?new Date(h.created_at).getTime():0;return(k.created_at?new Date(k.created_at).getTime():0)-M}),p=Math.max(1,Math.ceil(S.length/Qe)),N=Math.min(E,p),O=(N-1)*Qe,l=S.slice(O,O+Qe);return e.jsxs("div",{className:"space-y-4",children:[e.jsx(ae,{children:"7. Selecionar Embrião Congelado *"}),e.jsxs("div",{className:"border rounded-lg p-4",children:[!j&&e.jsx("div",{className:"text-sm text-slate-500",children:"Selecione um cliente ou informe a raça para listar embriões congelados."}),z&&e.jsx("div",{className:"text-sm text-slate-500",children:"Carregando embriões congelados..."}),!z&&a.length===0&&j&&e.jsx("div",{className:"text-sm text-slate-500",children:"Nenhum embrião congelado encontrado para os filtros aplicados."}),!z&&a.length>0&&e.jsxs("div",{className:"max-h-96 overflow-y-auto",children:[e.jsxs(Je,{children:[e.jsx(Ke,{children:e.jsxs(Pe,{children:[e.jsx(G,{className:"w-12"}),e.jsx(G,{children:"Código"}),e.jsx(G,{children:"Doadora"}),e.jsx(G,{children:"Touro"}),e.jsx(G,{children:"Classificação"}),e.jsx(G,{children:"Status"})]})}),e.jsx(We,{children:l.map(h=>e.jsxs(Pe,{className:_===h.id?"bg-green-50":"cursor-pointer hover:bg-slate-50",onClick:()=>c(h.id),children:[e.jsx(Z,{children:e.jsx("input",{type:"radio",name:"embriao",value:h.id,checked:_===h.id,onChange:()=>c(h.id),className:"w-4 h-4"})}),e.jsx(Z,{className:"font-mono text-xs",children:h.identificacao||h.id.substring(0,8)}),e.jsx(Z,{children:h.doadora_registro||"-"}),e.jsx(Z,{children:h.touro_nome||"-"}),e.jsx(Z,{children:h.classificacao?e.jsx(Oe,{variant:"outline",children:h.classificacao}):e.jsx("span",{className:"text-slate-400",children:"-"})}),e.jsx(Z,{children:e.jsx(ra,{status:h.status_atual})})]},h.id))})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-between text-sm text-slate-600",children:[e.jsxs("div",{children:[a.length," embrião(ões) disponíveis"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ce,{type:"button",variant:"outline",size:"sm",onClick:()=>R(Math.max(1,E-1)),disabled:E===1,children:"Anterior"}),e.jsxs("span",{children:["Página ",N," de ",p]}),e.jsx(ce,{type:"button",variant:"outline",size:"sm",onClick:()=>R(Math.min(p,E+1)),disabled:E>=p,children:"Próxima"})]})]})]})]})]})}const Oa=20;function lr(){var Fe;const[a,_]=i.useState({fazenda_id:"",pacote_id:"",protocolo_id:"",receptora_id:"",protocolo_receptora_id:"",embriao_id:"",data_te:new Date().toISOString().split("T")[0],veterinario_responsavel:"",tecnico_responsavel:"",observacoes:""}),[E,z]=i.useState({data_te:"",veterinario_responsavel:"",tecnico_responsavel:""}),[x,C]=i.useState(!1),{origemEmbriao:c,setOrigemEmbriao:R,filtroClienteId:j,setFiltroClienteId:S,filtroRaca:p,setFiltroRaca:N,dataPasso2:O,setDataPasso2:l,incluirCioLivre:h,setIncluirCioLivre:k,embrioesPage:M,setEmbrioesPage:I,showRelatorioDialog:Y,setShowRelatorioDialog:K,relatorioData:de,setRelatorioData:je,isVisualizacaoApenas:A,setIsVisualizacaoApenas:we,resetAll:ve,aplicarFiltrosSessao:ge,fecharRelatorio:H}=Sa(),{fazendas:Ce,clientes:P,pacotes:re,pacotesFiltrados:L,embrioesCongelados:y,receptoras:ee,setReceptoras:le,loading:pe,loadingCongelados:fe,transferenciasSessao:w,setTransferenciasSessao:q,transferenciasIdsSessao:Q,setTransferenciasIdsSessao:W,contagemSessaoPorReceptora:ie,setContagemSessaoPorReceptora:Ae,receptorasSessaoInfo:r,setReceptorasSessaoInfo:n,loadFazendas:f,loadPacotes:b,loadClientes:g,loadEmbrioesCongelados:m,carregarReceptorasDaFazenda:v,recarregarReceptoras:D,salvarSessaoNoBanco:B,encerrarSessaoNoBanco:ue,restaurarSessaoEmAndamento:Ee}=Ra({dataPasso2:O,incluirCioLivre:h,filtroClienteId:j,filtroRaca:p,formData:a}),U=re.find(o=>o.id===a.pacote_id),$=i.useMemo(()=>(U==null?void 0:U.embrioes.filter(o=>o.status_atual==="FRESCO"))||[],[U]),Re=$.some(o=>o.d8_limite),Le=i.useRef(0),xe=i.useMemo(()=>{if(!a.pacote_id||!U)return new Map;const o=[...$].sort((te,s)=>{const t=te.doadora_registro||"",u=s.doadora_registro||"";if(t!==u)return t.localeCompare(u);const J=te.created_at?new Date(te.created_at).getTime():0,X=s.created_at?new Date(s.created_at).getTime():0;return J!==X?J-X:(te.id||"").localeCompare(s.id||"")}),V=new Map;return o.forEach((te,s)=>{V.set(te.id,s+1)}),V},[a.pacote_id,U,$]),{handleDescartarReceptora:ye,handleSubmit:Ie,visualizarRelatorioSessao:Ne,handleEncerrarSessao:De}=Da({formData:a,setFormData:_,origemEmbriao:c,receptoras:ee,contagemSessaoPorReceptora:ie,setContagemSessaoPorReceptora:Ae,receptorasSessaoInfo:r,setReceptorasSessaoInfo:n,transferenciasSessao:w,setTransferenciasSessao:q,transferenciasIdsSessao:Q,setTransferenciasIdsSessao:W,numerosFixosMap:xe,setSubmitting:C,setRelatorioData:je,setShowRelatorioDialog:K,setIsVisualizacaoApenas:we,resetFiltros:ve,loadPacotes:b,loadEmbrioesCongelados:m,recarregarReceptoras:D,encerrarSessaoNoBanco:ue}),me=()=>{const o={fazenda_id:a.fazenda_id,pacote_id:a.pacote_id,data_passo2:O,data_te:a.data_te,veterinario_responsavel:a.veterinario_responsavel,tecnico_responsavel:a.tecnico_responsavel,origem_embriao:c,filtro_cliente_id:j,filtro_raca:p,incluir_cio_livre:h,transferenciasSessao:w,transferenciasIdsSessao:Q,embrioes_page:M};B(o)},ze=async o=>{if(!o){_({...a,fazenda_id:"",pacote_id:"",protocolo_id:"",embriao_id:"",receptora_id:"",protocolo_receptora_id:""}),z({data_te:"",veterinario_responsavel:"",tecnico_responsavel:""}),q([]),W([]),le([]);return}q([]),W([]),z({data_te:"",veterinario_responsavel:"",tecnico_responsavel:""}),await v(o),_({...a,fazenda_id:o,pacote_id:"",protocolo_id:"",embriao_id:"",receptora_id:"",protocolo_receptora_id:""})},Se=o=>{var te;const V=re.find(s=>s.id===o);(te=V==null?void 0:V.pacote_info)!=null&&te.veterinario_responsavel&&!a.veterinario_responsavel?(_(s=>({...s,pacote_id:o,veterinario_responsavel:V.pacote_info.veterinario_responsavel||""})),z(s=>({...s,veterinario_responsavel:V.pacote_info.veterinario_responsavel||""}))):_(s=>({...s,pacote_id:o}))};return i.useEffect(()=>{(async()=>{await Promise.all([f(),b(),g()]);const V=await Ee();V&&(ge(V.filtros),z(V.camposPacote),_(te=>({...te,...V.formData,embriao_id:"",receptora_id:"",protocolo_receptora_id:"",observacoes:""})))})()},[]),i.useEffect(()=>{(a.fazenda_id||a.pacote_id||Q.length>0)&&me()},[a.fazenda_id,a.pacote_id,a.protocolo_id,a.data_te,a.veterinario_responsavel,a.tecnico_responsavel,c,j,p,O,h,w.length,Q.length,M]),i.useEffect(()=>{f()},[O]),i.useEffect(()=>{a.fazenda_id&&v(a.fazenda_id)},[a.fazenda_id,O,h]),i.useEffect(()=>{c==="CONGELADO"&&(j||p.trim())&&m()},[c,j,p]),i.useEffect(()=>{I(1)},[a.pacote_id]),i.useEffect(()=>{c==="CONGELADO"&&(I(1),_(o=>({...o,embriao_id:""})))},[c,j,p]),i.useEffect(()=>{!a.pacote_id||!U||(Le.current+=1)},[a.pacote_id,U,xe]),i.useEffect(()=>{const o=Math.max(1,Math.ceil($.length/Oa));M>o&&I(o)},[$.length,M]),pe?e.jsx(ia,{}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(_a,{title:"Transferência de Embriões (TE)",description:"Destinar embriões para receptoras sincronizadas"}),e.jsxs(na,{children:[e.jsx(ca,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(da,{className:"flex items-center gap-2",children:[e.jsx(sa,{className:"w-5 h-5"}),"Nova Transferência"]}),a.fazenda_id&&Q.length>0&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(ce,{type:"button",onClick:Ne,className:"bg-slate-600 hover:bg-slate-700",disabled:x,variant:"default",title:"Visualizar relatório da sessão atual sem encerrar",children:[e.jsx(Ue,{className:"w-4 h-4 mr-2"}),"Visualizar Relatório (",Q.length," transferência",Q.length>1?"s":"",")"]}),e.jsxs(ce,{type:"button",onClick:De,className:"bg-blue-600 hover:bg-blue-700",disabled:x,variant:"default",children:[e.jsx(Ue,{className:"w-4 h-4 mr-2"}),x?"Gerando...":`Encerrar Sessão (${Q.length} transferência${Q.length>1?"s":""})`]})]})]})}),e.jsx(la,{children:e.jsxs("form",{onSubmit:Ie,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4 border-b pb-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ae,{htmlFor:"fazenda_id",children:"1. Fazenda onde estão as receptoras *"}),e.jsxs(qe,{value:a.fazenda_id,onValueChange:ze,children:[e.jsx(Be,{children:e.jsx(Ve,{placeholder:"Selecione a fazenda"})}),e.jsx(Ge,{children:Ce.map(o=>e.jsx(Ze,{value:o.id,children:o.nome},o.id))})]})]}),a.fazenda_id&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(ae,{htmlFor:"data_passo2",children:"2. Data do 2º Passo (opcional)"}),e.jsx(ea,{id:"data_passo2",value:O,onChange:o=>l(o||"")}),O&&e.jsx("div",{className:"flex justify-end",children:e.jsx(ce,{type:"button",variant:"ghost",size:"sm",onClick:()=>l(""),children:"Limpar data"})})]}),a.fazenda_id&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ca,{id:"incluir-cio-livre",checked:h,onCheckedChange:k}),e.jsx(ae,{htmlFor:"incluir-cio-livre",className:"cursor-pointer text-sm",children:"Incluir receptoras de CIO livre"})]}),a.fazenda_id&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(ae,{children:"3. Origem do Embrião *"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx(ce,{type:"button",variant:c==="PACOTE"?"default":"outline",onClick:()=>R("PACOTE"),className:c==="PACOTE"?"bg-green-600 hover:bg-green-700":"",children:"Pacote (Frescos)"}),e.jsx(ce,{type:"button",variant:c==="CONGELADO"?"default":"outline",onClick:()=>R("CONGELADO"),className:c==="CONGELADO"?"bg-blue-600 hover:bg-blue-700":"",children:"Congelados"})]})]}),a.fazenda_id&&c==="PACOTE"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(ae,{htmlFor:"pacote_id",children:"4. Pacote de Embriões *"}),e.jsxs(qe,{value:a.pacote_id,onValueChange:Se,children:[e.jsx(Be,{children:e.jsx(Ve,{placeholder:"Selecione o pacote"})}),e.jsx(Ge,{children:L.map(o=>{var V;return e.jsxs(Ze,{value:o.id,children:[((V=o.pacote_info)==null?void 0:V.fazenda_nome)||"N/A"," - ",ke(o.data_despacho)," (",o.frescos," frescos)"]},o.id)})})]})]}),a.fazenda_id&&c==="CONGELADO"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx(ae,{children:"4. Filtros para Embriões Congelados"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ae,{htmlFor:"filtro_cliente",children:"Cliente"}),e.jsxs(qe,{value:j,onValueChange:S,children:[e.jsx(Be,{children:e.jsx(Ve,{placeholder:"Selecione o cliente"})}),e.jsx(Ge,{children:P.map(o=>e.jsx(Ze,{value:o.id,children:o.nome},o.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ae,{htmlFor:"filtro_raca",children:"Raça"}),e.jsx($e,{id:"filtro_raca",value:p,onChange:o=>N(o.target.value),placeholder:"Digite a raça"})]})]})]}),(a.pacote_id||c==="CONGELADO")&&a.fazenda_id&&e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ae,{htmlFor:"data_te",children:"5. Data da TE *"}),e.jsx(ea,{id:"data_te",value:a.data_te,onChange:o=>_({...a,data_te:o||""})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ae,{htmlFor:"veterinario_responsavel",children:"Veterinário Responsável *"}),e.jsx($e,{id:"veterinario_responsavel",value:a.veterinario_responsavel,onChange:o=>_({...a,veterinario_responsavel:o.target.value}),placeholder:"Nome do veterinário"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ae,{htmlFor:"tecnico_responsavel",children:"Técnico Responsável"}),e.jsx($e,{id:"tecnico_responsavel",value:a.tecnico_responsavel,onChange:o=>_({...a,tecnico_responsavel:o.target.value}),placeholder:"Nome do técnico"})]})]}),(a.pacote_id||c==="CONGELADO"&&(j||p.trim()))&&a.fazenda_id&&e.jsx(ya,{receptoras:ee,selectedReceptoraId:a.receptora_id,contagemSessaoPorReceptora:ie,submitting:x,onSelectReceptora:(o,V)=>{_({...a,receptora_id:o,protocolo_receptora_id:V})},onDescartarReceptora:ye}),a.pacote_id&&U&&e.jsx(Ia,{pacote:U,embrioes:$,numerosFixosMap:xe,selectedEmbriaoId:a.embriao_id,embrioesPage:M,hasD8Limite:Re,onSelectEmbriao:o=>_({...a,embriao_id:o}),onPageChange:I}),c==="CONGELADO"&&e.jsx(Ta,{embrioes:y,selectedEmbriaoId:a.embriao_id,embrioesPage:M,loadingCongelados:fe,filtroClienteId:j,filtroRaca:p,onSelectEmbriao:o=>_({...a,embriao_id:o}),onPageChange:I}),a.embriao_id&&a.receptora_id&&e.jsx("div",{className:"space-y-4 border-t pt-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(ae,{htmlFor:"observacoes",children:"Observações"}),e.jsx(pa,{id:"observacoes",value:a.observacoes,onChange:o=>_({...a,observacoes:o.target.value}),placeholder:"Observações sobre a transferência",rows:3})]})})]}),a.embriao_id&&a.receptora_id&&e.jsx("div",{className:"flex justify-end",children:e.jsx(ce,{type:"submit",className:"bg-green-600 hover:bg-green-700",disabled:x,children:x?"Registrando...":"Registrar Transferência"})})]})})]}),e.jsx(za,{open:Y,onOpenChange:K,relatorioData:de,fazendaNome:((Fe=Ce.find(o=>o.id===a.fazenda_id))==null?void 0:Fe.nome)||"N/A",dataTe:a.data_te,veterinarioResponsavel:a.veterinario_responsavel,tecnicoResponsavel:a.tecnico_responsavel,isVisualizacaoApenas:A,submitting:x,onFechar:H,onConfirmarEncerrar:De})]})}export{lr as default};
