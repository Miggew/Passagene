import{c as He,r as c,s as j,j as e,B as H,a as Ne}from"./index-DM5u2d-F.js";import{C as he,a as xe,b as ve,d as ge}from"./card-B_EQ6x91.js";import{T as we,a as Ee,b as te,c as X,d as Se,e as Z}from"./table-CEKyj1ed.js";import{D as oe,b as ie,c as ne,d as ce,e as le,f as Pe,a as $e}from"./dialog-2y4jBKyr.js";import{S as de,a as me,b as ue,c as fe,d as K}from"./select-B_NoJ61H.js";import{I as ee}from"./input-CtUEWea1.js";import{L as P}from"./label-Bhhf9ayq.js";import{S as Le}from"./StatusBadge-CySQHNUG.js";import{P as Ue}from"./PageHeader-JgO8x5IE.js";import{E as qe}from"./EmptyState-ChaxWsz8.js";import Ve from"./ReceptoraHistorico-Ceo8QMsb.js";import{f as Ze}from"./statusLabels-IklKT8dE.js";import{h as be}from"./error-handler-BKHO4AyN.js";import{u as je}from"./use-toast-BOUGyrIz.js";import{T as Ye}from"./textarea-Kj1o8r55.js";import{m as De,a as Ce,D as Je,f as Xe,p as Ge}from"./DatePickerBR-BEWFLeoy.js";import{S as We}from"./search-QDhw42Qv.js";import{P as Qe}from"./plus-DJrruxx9.js";import{B as Ke}from"./baby-Cs4whXQA.js";import{S as ea}from"./square-pen-Cfxri2C7.js";import{H as aa}from"./history-Xos89q5T.js";import"./index-CWb7Yp_3.js";import"./index-sCsFC1oc.js";import"./x-DsJYRTDR.js";import"./index-ClZPXJQX.js";import"./index-BEVMOrkK.js";import"./check-Y5eEMkO8.js";import"./badge-D_AVhbx8.js";import"./sheet-D_5EJbIK.js";import"./calendar-B_KmJ-VL.js";import"./user-plus-B-iQ8mQq.js";import"./popover-CNdtTvFz.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ta=He("ArrowRight",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]]);function ra(s,r){const t=na(s);let o;if(t.date){const l=ca(t.date,2);o=la(l.restDateString,l.year)}if(!o||isNaN(o.getTime()))return new Date(NaN);const h=o.getTime();let x=0,u;if(t.time&&(x=da(t.time),isNaN(x)))return new Date(NaN);if(t.timezone){if(u=ma(t.timezone),isNaN(u))return new Date(NaN)}else{const l=new Date(h+x),d=new Date(0);return d.setFullYear(l.getUTCFullYear(),l.getUTCMonth(),l.getUTCDate()),d.setHours(l.getUTCHours(),l.getUTCMinutes(),l.getUTCSeconds(),l.getUTCMilliseconds()),d}return new Date(h+x+u)}const se={dateTimeDelimiter:/[T ]/,timeZoneDelimiter:/[Z ]/i,timezone:/([Z+-].*)$/},sa=/^-?(?:(\d{3})|(\d{2})(?:-?(\d{2}))?|W(\d{2})(?:-?(\d{1}))?|)$/,oa=/^(\d{2}(?:[.,]\d*)?)(?::?(\d{2}(?:[.,]\d*)?))?(?::?(\d{2}(?:[.,]\d*)?))?$/,ia=/^([+-])(\d{2})(?::?(\d{2}))?$/;function na(s){const r={},a=s.split(se.dateTimeDelimiter);let t;if(a.length>2)return r;if(/:/.test(a[0])?t=a[0]:(r.date=a[0],t=a[1],se.timeZoneDelimiter.test(r.date)&&(r.date=s.split(se.timeZoneDelimiter)[0],t=s.substr(r.date.length,s.length))),t){const o=se.timezone.exec(t);o?(r.time=t.replace(o[1],""),r.timezone=o[1]):r.time=t}return r}function ca(s,r){const a=new RegExp("^(?:(\\d{4}|[+-]\\d{"+(4+r)+"})|(\\d{2}|[+-]\\d{"+(2+r)+"})$)"),t=s.match(a);if(!t)return{year:NaN,restDateString:""};const o=t[1]?parseInt(t[1]):null,h=t[2]?parseInt(t[2]):null;return{year:h===null?o:h*100,restDateString:s.slice((t[1]||t[2]).length)}}function la(s,r){if(r===null)return new Date(NaN);const a=s.match(sa);if(!a)return new Date(NaN);const t=!!a[4],o=ae(a[1]),h=ae(a[2])-1,x=ae(a[3]),u=ae(a[4]),l=ae(a[5])-1;if(t)return xa(r,u,l)?ua(r,u,l):new Date(NaN);{const d=new Date(0);return!pa(r,h,x)||!ha(r,o)?new Date(NaN):(d.setUTCFullYear(r,h,Math.max(o,x)),d)}}function ae(s){return s?parseInt(s):1}function da(s){const r=s.match(oa);if(!r)return NaN;const a=_e(r[1]),t=_e(r[2]),o=_e(r[3]);return va(a,t,o)?a*De+t*Ce+o*1e3:NaN}function _e(s){return s&&parseFloat(s.replace(",","."))||0}function ma(s){if(s==="Z")return 0;const r=s.match(ia);if(!r)return 0;const a=r[1]==="+"?-1:1,t=parseInt(r[2]),o=r[3]&&parseInt(r[3])||0;return ga(t,o)?a*(t*De+o*Ce):NaN}function ua(s,r,a){const t=new Date(0);t.setUTCFullYear(s,0,4);const o=t.getUTCDay()||7,h=(r-1)*7+a+1-o;return t.setUTCDate(t.getUTCDate()+h),t}const fa=[31,null,31,30,31,30,31,31,30,31,30,31];function ye(s){return s%400===0||s%4===0&&s%100!==0}function pa(s,r,a){return r>=0&&r<=11&&a>=1&&a<=(fa[r]||(ye(s)?29:28))}function ha(s,r){return r>=1&&r<=(ye(s)?366:365)}function xa(s,r,a){return r>=1&&r<=53&&a>=0&&a<=6}function va(s,r,a){return s===24?r===0&&a===0:a>=0&&a<60&&r>=0&&r<60&&s>=0&&s<25}function ga(s,r){return r>=0&&r<=59}function _a({selectedFazendaId:s}){const[r,a]=c.useState([]),[t,o]=c.useState([]),[h,x]=c.useState([]),[u,l]=c.useState([]),[d,z]=c.useState(!0),[C,R]=c.useState(!1),[y,S]=c.useState(""),[D,A]=c.useState("all"),k=c.useCallback(()=>{let i=t;if(D!=="all"&&(i=i.filter(n=>n.status_calculado===D)),y.trim()){const n=y.toLowerCase();i=i.filter(N=>{var M;return N.identificacao.toLowerCase().includes(n)||((M=N.nome)==null?void 0:M.toLowerCase().includes(n))})}x(i)},[t,D,y]);c.useEffect(()=>{k()},[k]);const $=c.useCallback(async()=>{try{z(!0);const{data:i,error:n}=await j.from("fazendas").select("id, nome, cliente_id").order("nome",{ascending:!0});if(n)throw n;a(i||[])}catch(i){be(i,"Erro ao carregar fazendas")}finally{z(!1)}},[]),g=c.useCallback(async()=>{if(!s){o([]),x([]),l([]);return}try{R(!0);const{data:i,error:n}=await j.from("vw_receptoras_fazenda_atual").select("receptora_id, fazenda_nome_atual").eq("fazenda_id_atual",s);if(n)throw n;const N=(i==null?void 0:i.map(_=>_.receptora_id))||[];if(N.length===0){o([]),x([]),l([]);return}const{data:M,error:E}=await j.from("receptoras").select("*").in("id",N).order("identificacao",{ascending:!0});if(E)throw E;const b=new Map((i==null?void 0:i.map(_=>[_.receptora_id,_.fazenda_nome_atual]))||[]),F=(M||[]).map(_=>({..._,fazenda_nome_atual:b.get(_.id)})).map(_=>({..._,status_calculado:_.status_reprodutivo||"VAZIA"})),L=["PRENHE","PRENHE_RETOQUE","PRENHE_FEMEA","PRENHE_MACHO","PRENHE_SEM_SEXO","PRENHE_2_SEXOS"],U=F.filter(_=>L.includes(_.status_calculado)||_.status_calculado.includes("PRENHE"));if(U.length>0){const _=U.map(Y=>Y.id),{data:V,error:W}=await j.from("diagnosticos_gestacao").select("receptora_id, numero_gestacoes").in("receptora_id",_).in("resultado",["PRENHE","PRENHE_FEMEA","PRENHE_MACHO","PRENHE_SEM_SEXO","PRENHE_2_SEXOS"]).not("numero_gestacoes","is",null);if(!W&&V){const Y=new Map;V.forEach(O=>{if(O.numero_gestacoes&&O.numero_gestacoes>1){const p=Y.get(O.receptora_id)||0;O.numero_gestacoes>p&&Y.set(O.receptora_id,O.numero_gestacoes)}}),F.forEach(O=>{const p=Y.get(O.id);p&&p>1&&(O.numero_gestacoes=p)})}}const q=Array.from(new Set(F.map(_=>_.status_calculado))).filter(_=>_).sort();l(q),o(F),x(F),A("all")}catch(i){be(i,"Erro ao carregar receptoras")}finally{R(!1)}},[s]),w=c.useCallback(async()=>{await g()},[g]),m=c.useCallback((i,n)=>{o(N=>N.map(M=>M.id===i?{...M,...n}:M))},[]),v=c.useCallback(i=>{o(n=>n.filter(N=>N.id!==i)),x(n=>n.filter(N=>N.id!==i))},[]);return{fazendas:r,receptoras:t,filteredReceptoras:h,statusDisponiveis:u,loadingFazendas:d,loadingReceptoras:C,searchTerm:y,setSearchTerm:S,filtroStatus:D,setFiltroStatus:A,loadFazendas:$,loadReceptoras:g,reloadReceptoras:w,updateReceptoraInList:m,removeReceptoraFromList:v}}function ja({selectedFazendaId:s,onSuccess:r}){const{toast:a}=je(),[t,o]=c.useState({identificacao:"",nome:""}),[h,x]=c.useState(!1),[u,l]=c.useState({identificacao:"",nome:""}),[d,z]=c.useState(null),[C,R]=c.useState(!1),[y,S]=c.useState(!1),D=c.useCallback(()=>{o({identificacao:"",nome:""})},[]),A=c.useCallback(()=>{l({identificacao:"",nome:""}),z(null)},[]),k=c.useCallback(w=>{z(w),l({identificacao:w.identificacao,nome:w.nome||""}),R(!0)},[]),$=c.useCallback(async w=>{if(w.preventDefault(),!t.identificacao.trim()){a({title:"Erro de validação",description:"Identificação (brinco) é obrigatória",variant:"destructive"});return}if(!s){a({title:"Erro de validação",description:"Selecione uma fazenda primeiro",variant:"destructive"});return}try{S(!0);const{data:m,error:v}=await j.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",s);if(v)throw v;const i=(m==null?void 0:m.map(E=>E.receptora_id))||[];if(i.length>0){const{data:E,error:b}=await j.from("receptoras").select("id, identificacao, nome").in("id",i).ilike("identificacao",t.identificacao.trim());if(b)throw b;if(E&&E.length>0){const T=E[0].nome?`"${E[0].nome}"`:"sem nome";throw new Error(`Já existe uma receptora com o brinco "${t.identificacao.trim()}" nesta fazenda (Nome: ${T}).`)}if(t.nome.trim()){const{data:T,error:F}=await j.from("receptoras").select("id, identificacao").in("id",i).ilike("nome",t.nome.trim());if(F)throw F;if(T&&T.length>0)throw new Error(`Já existe uma receptora com o nome "${t.nome.trim()}" nesta fazenda (Brinco: ${T[0].identificacao}).`)}}const n={identificacao:t.identificacao};t.nome.trim()&&(n.nome=t.nome);const{data:N,error:M}=await j.from("receptoras").insert([n]).select().single();if(M)throw M.code==="23505"?new Error("Já existe uma receptora com esse brinco nesta fazenda."):M;await j.from("receptora_fazenda_historico").insert([{receptora_id:N.id,fazenda_id:s,data_inicio:new Date().toISOString().split("T")[0],data_fim:null}]),a({title:"Receptora criada",description:"Receptora criada com sucesso"}),x(!1),D(),r==null||r()}catch(m){a({title:"Erro ao criar receptora",description:m instanceof Error?m.message:"Erro desconhecido",variant:"destructive"})}finally{S(!1)}},[t,s,a,D,r]),g=c.useCallback(async w=>{if(w.preventDefault(),!!d){if(!u.identificacao.trim()){a({title:"Erro de validação",description:"Identificação (brinco) é obrigatória",variant:"destructive"});return}try{S(!0);const m=d.identificacao,v=u.identificacao.trim(),i=m!==v,n={identificacao:v,nome:u.nome.trim()||null},{error:N}=await j.from("receptoras").update(n).eq("id",d.id);if(N)throw N.code==="23505"?new Error("Já existe uma receptora com esse brinco nesta fazenda."):N;if(i)try{await j.from("receptora_renomeacoes_historico").insert([{receptora_id:d.id,brinco_anterior:m,brinco_novo:v,data_renomeacao:new Date().toISOString(),motivo:"EDICAO_MANUAL",observacoes:null}])}catch{}a({title:"Receptora atualizada",description:i?`Receptora atualizada. Brinco alterado de "${m}" para "${v}".`:"Receptora atualizada com sucesso"}),R(!1),A(),r==null||r()}catch(m){a({title:"Erro ao atualizar receptora",description:m instanceof Error?m.message:"Erro desconhecido",variant:"destructive"})}finally{S(!1)}}},[u,d,a,A,r]);return{formData:t,setFormData:o,showDialog:h,setShowDialog:x,editFormData:u,setEditFormData:l,editingReceptora:d,showEditDialog:C,setShowEditDialog:R,submitting:y,handleSubmit:$,handleEditSubmit:g,handleEdit:k,resetForm:D,resetEditForm:A}}function Na({fazendas:s,selectedFazendaId:r,editingReceptora:a,onSuccess:t,onClose:o}){const{toast:h}=je(),[x,u]=c.useState(!1),[l,d]=c.useState(""),[z,C]=c.useState(""),[R,y]=c.useState(!1),[S,D]=c.useState(!1),[A,k]=c.useState(!1),$=c.useCallback(()=>{d(""),C(""),y(!1),D(!1)},[]),g=s.filter(m=>m.id!==r);c.useEffect(()=>{(async()=>{if(!a||!l){y(!1),C(""),D(!1);return}try{const{data:v,error:i}=await j.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",l);if(i)return;const n=(v==null?void 0:v.map(E=>E.receptora_id))||[];if(n.length===0){y(!1),C(""),D(!1);return}if(a.nome&&a.nome.trim()){const{data:E,error:b}=await j.from("receptoras").select("id, nome, identificacao").in("id",n).ilike("nome",a.nome.trim());!b&&E&&E.length>0?D(!0):D(!1)}else D(!1);const{data:N,error:M}=await j.from("receptoras").select("id, identificacao").in("id",n).ilike("identificacao",a.identificacao);if(M)return;if(N&&N.length>0){y(!0);const E=async(b,T=0)=>{if(T>10)throw new Error("Não foi possível gerar um brinco disponível após várias tentativas");const F=new Date,L=String(F.getDate()).padStart(2,"0"),U=String(F.getMonth()+1).padStart(2,"0"),q=T===0?`-MOV${L}${U}`:`-MOV${L}${U}-${T}`,_=`${b}${q}`,{data:V,error:W}=await j.from("receptoras").select("id, identificacao").in("id",n).ilike("identificacao",_);return W?_:V&&V.length>0?E(b,T+1):_};try{const b=await E(a.identificacao);C(b)}catch{const b=new Date,T=String(b.getDate()).padStart(2,"0"),F=String(b.getMonth()+1).padStart(2,"0");C(`${a.identificacao}-MOV${T}${F}`)}}else y(!1),C("")}catch{y(!1),C("")}})()},[a,l]);const w=c.useCallback(async()=>{if(!a||!l){h({title:"Erro de validação",description:"Selecione uma fazenda de destino",variant:"destructive"});return}if(S&&a.nome&&a.nome.trim()){h({title:"Conflito de nome",description:`Já existe uma receptora com o nome "${a.nome.trim()}" na fazenda destino. Não é possível mover esta receptora.`,variant:"destructive"});return}try{k(!0);const m=a.identificacao;let v=m;if(R&&z){v=z;const{error:n}=await j.from("receptoras").update({identificacao:v}).eq("id",a.id);if(n)throw new Error(`Erro ao atualizar brinco: ${n.message}`);try{await j.from("receptora_renomeacoes_historico").insert([{receptora_id:a.id,brinco_anterior:m,brinco_novo:v,data_renomeacao:new Date().toISOString(),motivo:"MUDANCA_FAZENDA",observacoes:"Renomeação automática devido a conflito de brinco na fazenda destino"}])}catch{}}const{error:i}=await j.rpc("mover_receptora_fazenda",{p_receptora_id:a.id,p_nova_fazenda_id:l,p_data_mudanca:new Date().toISOString().split("T")[0],p_observacoes:null});if(i){let n="Erro ao mover receptora";i.message?n=i.message:i.details&&(n=i.details),h({title:"Erro ao mover receptora",description:n,variant:"destructive"});return}h({title:"Receptora movida",description:R?`Receptora movida com sucesso. Brinco atualizado de "${m}" para "${v}" devido a conflito na fazenda destino.`:"Receptora movida para a nova fazenda com sucesso. Protocolos e histórico não foram afetados."}),u(!1),$(),o==null||o(),t==null||t()}catch(m){h({title:"Erro ao mover receptora",description:m instanceof Error?m.message:"Erro desconhecido ao mover receptora",variant:"destructive"})}finally{k(!1)}},[a,l,R,S,z,h,$,o,t]);return{showMoverFazendaDialog:x,setShowMoverFazendaDialog:u,novaFazendaId:l,setNovaFazendaId:d,novoBrincoProposto:z,temConflitoBrinco:R,temConflitoNome:S,submittingMover:A,fazendasDisponiveis:g,handleMoverFazenda:w,resetMoverState:$}}function ba({selectedFazendaId:s,fazendas:r,onSuccess:a}){const{toast:t}=je(),o=new Date().toISOString().split("T")[0],[h,x]=c.useState(!1),[u,l]=c.useState({receptora_id:"",data_nascimento:o,sexo:"",observacoes:""}),[d,z]=c.useState([]),[C,R]=c.useState(!1),[y,S]=c.useState(!1),D=g=>g.includes("FEMEA")?"FEMEA":g.includes("MACHO")?"MACHO":"SEM_SEXO",A=async g=>{const{data:w,error:m}=await j.from("transferencias_embrioes").select("embriao_id, data_te").eq("receptora_id",g).eq("status_te","REALIZADA").order("data_te",{ascending:!1});if(m)throw m;if(!w||w.length===0)return[];const v=w[0].data_te,n=w.filter(p=>p.data_te===v).map(p=>p.embriao_id).filter(Boolean);if(n.length===0)return[];const{data:N}=await j.from("animais").select("embriao_id").in("embriao_id",n),M=new Set((N||[]).map(p=>p.embriao_id)),E=n.filter(p=>!M.has(p));if(E.length===0)return[];const{data:b,error:T}=await j.from("embrioes").select("id, lote_fiv_acasalamento_id").in("id",E);if(T)throw T;const F=[...new Set((b||[]).map(p=>p.lote_fiv_acasalamento_id).filter(Boolean))];let L=[],U=[],q=[],_=[];if(F.length>0){const{data:p}=await j.from("lote_fiv_acasalamentos").select("id, aspiracao_doadora_id, dose_semen_id").in("id",F);L=p||[];const J=[...new Set(L.map(I=>I.aspiracao_doadora_id).filter(Boolean))],Q=[...new Set(L.map(I=>I.dose_semen_id).filter(Boolean))];if(J.length>0){const{data:I}=await j.from("aspiracoes_doadoras").select("id, doadora_id").in("id",J);U=I||[];const G=[...new Set(U.map(B=>B.doadora_id).filter(Boolean))];if(G.length>0){const{data:B}=await j.from("doadoras").select("id, registro, raca").in("id",G);q=B||[]}}if(Q.length>0){const{data:I}=await j.from("doses_semen").select("id, touro:touros(id, nome, registro, raca)").in("id",Q);_=I||[]}}const V=new Map(L.map(p=>[p.id,p])),W=new Map(U.map(p=>[p.id,p])),Y=new Map(q.map(p=>[p.id,p])),O=new Map(_.map(p=>[p.id,p]));return(b||[]).map(p=>{const J=p.lote_fiv_acasalamento_id?V.get(p.lote_fiv_acasalamento_id):void 0,Q=J?W.get(J.aspiracao_doadora_id):void 0,I=Q?Y.get(Q.doadora_id):void 0,G=J?O.get(J.dose_semen_id):void 0,B=(G==null?void 0:G.touro)??null;return{embriao_id:p.id,doadora_registro:I==null?void 0:I.registro,touro_nome:B==null?void 0:B.nome,raca:(I==null?void 0:I.raca)||(B==null?void 0:B.raca)}})},k=c.useCallback(async g=>{var w;try{R(!0),z([]),l({receptora_id:g.id,data_nascimento:o,sexo:"",observacoes:""}),x(!0);const[m,v]=await Promise.all([A(g.id),j.from("diagnosticos_gestacao").select("sexagem").eq("receptora_id",g.id).eq("tipo_diagnostico","SEXAGEM").order("data_diagnostico",{ascending:!1}).limit(1).maybeSingle()]),i=((w=v==null?void 0:v.data)==null?void 0:w.sexagem)||D(g.status_calculado);l(n=>({...n,sexo:i||""})),z(m),m.length===0&&t({title:"Sem embriões disponíveis",description:"Nenhum embrião elegível para criar animal foi encontrado."})}catch(m){t({title:"Erro ao preparar nascimento",description:m instanceof Error?m.message:"Erro desconhecido",variant:"destructive"})}finally{R(!1)}},[o,t]),$=c.useCallback(async()=>{if(!s){t({title:"Fazenda não selecionada",description:"Selecione a fazenda antes de registrar o nascimento.",variant:"destructive"});return}if(!u.receptora_id){t({title:"Receptora não selecionada",description:"Selecione a receptora para registrar o nascimento.",variant:"destructive"});return}if(!u.data_nascimento){t({title:"Data de nascimento obrigatória",description:"Informe a data de nascimento.",variant:"destructive"});return}if(!u.sexo){t({title:"Sexo obrigatório",description:"Selecione o sexo da prenhez.",variant:"destructive"});return}if(d.length===0){t({title:"Sem embriões vinculados",description:"Nenhum embrião encontrado para a última transferência desta receptora.",variant:"destructive"});return}try{S(!0);const g=r.find(n=>n.id===s),w=(g==null?void 0:g.cliente_id)||null,m=d.map(n=>({embriao_id:n.embriao_id,receptora_id:u.receptora_id,fazenda_id:s,cliente_id:w,data_nascimento:u.data_nascimento,sexo:u.sexo,raca:n.raca||null,pai_nome:n.touro_nome||null,mae_nome:n.doadora_registro||null,observacoes:u.observacoes||null})),{error:v}=await j.from("animais").insert(m);if(v)throw v;const{error:i}=await j.from("receptoras").update({status_reprodutivo:"VAZIA",data_provavel_parto:null}).eq("id",u.receptora_id);if(i)throw i;t({title:"Nascimento registrado",description:`${m.length} animal(is) criado(s) com sucesso.`}),x(!1),z([]),l({receptora_id:"",data_nascimento:o,sexo:"",observacoes:""}),a==null||a()}catch(g){t({title:"Erro ao registrar nascimento",description:g instanceof Error?g.message:"Erro desconhecido",variant:"destructive"})}finally{S(!1)}},[u,d,s,r,o,t,a]);return{showNascimentoDialog:h,setShowNascimentoDialog:x,nascimentoForm:u,setNascimentoForm:l,nascimentoEmbrioes:d,nascimentoLoading:C,submitting:y,handleAbrirNascimento:k,handleRegistrarNascimento:$}}function wa({open:s,onOpenChange:r,receptora:a,fazendasDisponiveis:t,novaFazendaId:o,onFazendaChange:h,temConflitoBrinco:x,temConflitoNome:u,novoBrincoProposto:l,submitting:d,onConfirmar:z,onCancelar:C}){const R=S=>{r(S),S||C()},y=o&&!u&&!(x&&!l);return e.jsx(oe,{open:s,onOpenChange:R,children:e.jsxs(ie,{className:"max-w-md",children:[e.jsxs(ne,{children:[e.jsx(ce,{children:"Mover Receptora"}),e.jsxs(le,{children:["Mover ",a==null?void 0:a.identificacao," para outra fazenda. Protocolos e histórico reprodutivo não serão afetados."]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"nova_fazenda",children:"Nova Fazenda *"}),e.jsxs(de,{value:o,onValueChange:h,children:[e.jsx(me,{children:e.jsx(ue,{placeholder:"Selecione a fazenda de destino"})}),e.jsx(fe,{children:t.map(S=>e.jsx(K,{value:S.id,children:S.nome},S.id))})]})]}),u&&(a==null?void 0:a.nome)&&e.jsxs("div",{className:"space-y-2 p-3 bg-red-50 border border-red-200 rounded-md",children:[e.jsx("div",{className:"flex items-start gap-2",children:e.jsx("div",{className:"text-red-800 text-sm font-medium",children:"Conflito de Nome Detectado"})}),e.jsxs("div",{className:"text-red-700 text-sm",children:['Já existe uma receptora com o nome "',a.nome.trim(),'" na fazenda destino.']}),e.jsx("div",{className:"text-red-600 text-xs",children:"Não é possível mover esta receptora. Edite o nome da receptora antes de movê-la."})]}),x&&l&&e.jsxs("div",{className:"space-y-2 p-3 bg-yellow-50 border border-yellow-200 rounded-md",children:[e.jsx("div",{className:"flex items-start gap-2",children:e.jsx("div",{className:"text-yellow-800 text-sm font-medium",children:"Conflito de Brinco Detectado"})}),e.jsxs("div",{className:"text-yellow-700 text-sm",children:['Já existe uma receptora com o brinco "',a==null?void 0:a.identificacao,'" na fazenda destino.']}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(P,{className:"text-yellow-800 text-sm font-medium",children:"Novo Brinco Proposto:"}),e.jsx("div",{className:"p-2 bg-white border border-yellow-300 rounded text-sm font-mono text-yellow-900",children:l}),e.jsx("div",{className:"text-yellow-600 text-xs",children:"O brinco será automaticamente atualizado para permitir a movimentação."})]})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(H,{type:"button",className:"flex-1 bg-green-600 hover:bg-green-700",onClick:z,disabled:d||!y,children:d?"Movendo...":"Confirmar Movimentação"}),e.jsx(H,{type:"button",variant:"outline",onClick:C,disabled:d,children:"Cancelar"})]})]})]})})}function Ea({open:s,onOpenChange:r,nascimentoForm:a,onFormChange:t,nascimentoEmbrioes:o,nascimentoLoading:h,submitting:x,onRegistrar:u,onCancelar:l}){return e.jsx(oe,{open:s,onOpenChange:r,children:e.jsxs(ie,{className:"max-w-2xl",children:[e.jsxs(ne,{children:[e.jsx(ce,{children:"Registrar nascimento"}),e.jsx(le,{children:"Crie os animais a partir da prenhez desta receptora."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{children:"Data de nascimento *"}),e.jsx(Je,{value:a.data_nascimento,onChange:d=>t({...a,data_nascimento:d||""}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{children:"Sexo *"}),e.jsxs(de,{value:a.sexo,onValueChange:d=>t({...a,sexo:d}),children:[e.jsx(me,{children:e.jsx(ue,{placeholder:"Selecione o sexo"})}),e.jsxs(fe,{children:[e.jsx(K,{value:"FEMEA",children:"Fêmea"}),e.jsx(K,{value:"MACHO",children:"Macho"}),e.jsx(K,{value:"SEM_SEXO",children:"Sem sexo"})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{children:"Observações"}),e.jsx(Ye,{value:a.observacoes,onChange:d=>t({...a,observacoes:d.target.value}),placeholder:"Observações sobre o nascimento",rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{children:"Embriões vinculados"}),h&&e.jsx("div",{className:"text-sm text-slate-500",children:"Carregando dados..."}),!h&&o.length===0&&e.jsx("div",{className:"text-sm text-slate-500",children:"Nenhum embrião disponível para registro."}),!h&&o.length>0&&e.jsx("div",{className:"border rounded-lg p-3",children:e.jsxs(we,{children:[e.jsx(Ee,{children:e.jsxs(te,{children:[e.jsx(X,{children:"Embrião"}),e.jsx(X,{children:"Doadora"}),e.jsx(X,{children:"Touro"}),e.jsx(X,{children:"Raça"})]})}),e.jsx(Se,{children:o.map(d=>e.jsxs(te,{children:[e.jsx(Z,{className:"font-medium",children:d.embriao_id.substring(0,8)}),e.jsx(Z,{children:d.doadora_registro||"-"}),e.jsx(Z,{children:d.touro_nome||"-"}),e.jsx(Z,{children:d.raca||"-"})]},d.embriao_id))})]})})]})]}),e.jsxs(Pe,{children:[e.jsx(H,{type:"button",variant:"outline",onClick:l,children:"Cancelar"}),e.jsx(H,{type:"button",onClick:u,disabled:x,children:"Registrar nascimento"})]})]})})}function rt(){const[s,r]=c.useState(""),[a,t]=c.useState(!1),[o,h]=c.useState(""),{fazendas:x,filteredReceptoras:u,statusDisponiveis:l,loadingFazendas:d,loadingReceptoras:z,searchTerm:C,setSearchTerm:R,filtroStatus:y,setFiltroStatus:S,loadFazendas:D,loadReceptoras:A,reloadReceptoras:k,removeReceptoraFromList:$}=_a({selectedFazendaId:s}),{formData:g,setFormData:w,showDialog:m,setShowDialog:v,editFormData:i,setEditFormData:n,editingReceptora:N,showEditDialog:M,setShowEditDialog:E,submitting:b,handleSubmit:T,handleEditSubmit:F,handleEdit:L}=ja({selectedFazendaId:s,onSuccess:k}),{showMoverFazendaDialog:U,setShowMoverFazendaDialog:q,novaFazendaId:_,setNovaFazendaId:V,novoBrincoProposto:W,temConflitoBrinco:Y,temConflitoNome:O,submittingMover:p,fazendasDisponiveis:J,handleMoverFazenda:Q,resetMoverState:I}=Na({fazendas:x,selectedFazendaId:s,editingReceptora:N,onSuccess:k,onClose:()=>E(!1)}),{showNascimentoDialog:G,setShowNascimentoDialog:B,nascimentoForm:ze,setNascimentoForm:Re,nascimentoEmbrioes:Me,nascimentoLoading:Te,submitting:Fe,handleAbrirNascimento:Ie,handleRegistrarNascimento:ke}=ba({selectedFazendaId:s,fazendas:x,onSuccess:k});c.useEffect(()=>{D()},[D]),c.useEffect(()=>{s&&A()},[s,A]);const Ae=async()=>{o&&$(o),await k()},Oe=f=>{if(!f)return"";try{const re=ra(f);return Number.isNaN(re.getTime())?"":Xe(re,"dd/MM/yyyy",{locale:Ge})}catch{return""}},Be=f=>{if(!f.status_calculado.includes("PRENHE")||!f.data_provavel_parto)return!1;const re=new Date(f.data_provavel_parto),pe=new Date;return pe.setDate(pe.getDate()+20),re<=pe};return d?e.jsx(Ne,{}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(Ue,{title:"Receptoras",description:"Gerenciar receptoras por fazenda"}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(he,{children:[e.jsx(xe,{children:e.jsx(ve,{children:"Selecione a Fazenda *"})}),e.jsx(ge,{children:e.jsxs(de,{value:s,onValueChange:r,children:[e.jsx(me,{className:"w-full",children:e.jsx(ue,{placeholder:"Selecione uma fazenda para listar receptoras"})}),e.jsx(fe,{children:x.map(f=>e.jsx(K,{value:f.id,children:f.nome},f.id))})]})})]}),s?e.jsxs(e.Fragment,{children:[e.jsxs(he,{children:[e.jsx(xe,{children:e.jsx(ve,{children:"Filtros"})}),e.jsx(ge,{children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 max-w-md",children:[e.jsx(P,{htmlFor:"filtro-status",children:"Status"}),e.jsxs(de,{value:y,onValueChange:S,children:[e.jsx(me,{id:"filtro-status",children:e.jsx(ue,{placeholder:"Todas"})}),e.jsxs(fe,{children:[e.jsx(K,{value:"all",children:"Todas"}),l.map(f=>e.jsx(K,{value:f,children:Ze(f)},f))]})]})]}),e.jsxs("div",{className:"flex-1 max-w-md",children:[e.jsx(P,{htmlFor:"busca",children:"Buscar por brinco ou nome"}),e.jsxs("div",{className:"relative",children:[e.jsx(We,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4"}),e.jsx(ee,{id:"busca",placeholder:"Buscar por brinco ou nome...",value:C,onChange:f=>R(f.target.value),className:"pl-10"})]})]})]})})]}),e.jsx("div",{className:"flex items-center justify-end",children:e.jsxs(oe,{open:m,onOpenChange:v,children:[e.jsx($e,{asChild:!0,children:e.jsxs(H,{className:"bg-green-600 hover:bg-green-700",children:[e.jsx(Qe,{className:"w-4 h-4 mr-2"}),"Nova Receptora"]})}),e.jsxs(ie,{className:"max-w-md",children:[e.jsxs(ne,{children:[e.jsx(ce,{children:"Criar Nova Receptora"}),e.jsx(le,{children:"Criar receptora na fazenda selecionada"})]}),e.jsxs("form",{onSubmit:T,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"identificacao",children:"Identificação (Brinco) *"}),e.jsx(ee,{id:"identificacao",value:g.identificacao,onChange:f=>w({...g,identificacao:f.target.value}),placeholder:"Número do brinco",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"nome",children:"Nome"}),e.jsx(ee,{id:"nome",value:g.nome,onChange:f=>w({...g,nome:f.target.value}),placeholder:"Nome da receptora (opcional)"})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(H,{type:"submit",className:"flex-1 bg-green-600 hover:bg-green-700",disabled:b,children:b?"Salvando...":"Salvar"}),e.jsx(H,{type:"button",variant:"outline",onClick:()=>v(!1),disabled:b,children:"Cancelar"})]})]})]})]})}),e.jsxs(he,{children:[e.jsx(xe,{children:e.jsxs(ve,{children:["Lista de Receptoras (",u.length,")"]})}),e.jsx(ge,{children:z?e.jsx("div",{className:"py-8",children:e.jsx(Ne,{})}):e.jsxs(we,{children:[e.jsx(Ee,{children:e.jsxs(te,{children:[e.jsx(X,{children:"Brinco"}),e.jsx(X,{children:"Nome"}),e.jsx(X,{children:"Status Atual"}),e.jsx(X,{children:"Data de parto"}),e.jsx(X,{className:"text-right",children:"Ações"})]})}),e.jsx(Se,{children:u.length===0?e.jsx(te,{children:e.jsx(Z,{colSpan:5,className:"text-center text-slate-500",children:C?"Nenhuma receptora encontrada":"Nenhuma receptora cadastrada nesta fazenda"})}):u.map(f=>e.jsxs(te,{children:[e.jsx(Z,{className:"font-medium",children:f.identificacao}),e.jsx(Z,{children:f.nome||"-"}),e.jsx(Z,{children:e.jsx(Le,{status:f.status_calculado,count:f.numero_gestacoes})}),e.jsx(Z,{children:f.status_calculado.includes("PRENHE")&&f.data_provavel_parto?Oe(f.data_provavel_parto):"—"}),e.jsx(Z,{className:"text-right",children:e.jsxs("div",{className:"flex gap-1 justify-end",children:[Be(f)&&e.jsx(H,{variant:"ghost",size:"sm",onClick:()=>Ie(f),title:"Registrar nascimento",children:e.jsx(Ke,{className:"w-4 h-4"})}),e.jsx(H,{variant:"ghost",size:"sm",onClick:()=>L(f),title:"Editar",children:e.jsx(ea,{className:"w-4 h-4"})}),e.jsx(H,{variant:"ghost",size:"sm",onClick:()=>{h(f.id),t(!0)},title:"Ver histórico",children:e.jsx(aa,{className:"w-4 h-4"})})]})})]},f.id))})]})})]})]}):e.jsx(qe,{title:"Selecione uma fazenda",description:"Escolha uma fazenda para listar receptoras e aplicar filtros."}),e.jsx(Ea,{open:G,onOpenChange:B,nascimentoForm:ze,onFormChange:Re,nascimentoEmbrioes:Me,nascimentoLoading:Te,submitting:Fe,onRegistrar:ke,onCancelar:()=>B(!1)}),e.jsx(oe,{open:M,onOpenChange:E,children:e.jsxs(ie,{className:"max-w-md",children:[e.jsxs(ne,{children:[e.jsx(ce,{children:"Editar Receptora"}),e.jsx(le,{children:"Atualizar dados da receptora"})]}),e.jsxs("form",{onSubmit:F,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"edit_identificacao",children:"Identificação (Brinco) *"}),e.jsx(ee,{id:"edit_identificacao",value:i.identificacao,onChange:f=>n({...i,identificacao:f.target.value}),placeholder:"Número do brinco",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"edit_nome",children:"Nome"}),e.jsx(ee,{id:"edit_nome",value:i.nome,onChange:f=>n({...i,nome:f.target.value}),placeholder:"Nome da receptora (opcional)"})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(H,{type:"submit",className:"flex-1 bg-green-600 hover:bg-green-700",disabled:b,children:b?"Salvando...":"Salvar Alterações"}),e.jsx(H,{type:"button",variant:"outline",onClick:()=>E(!1),disabled:b,children:"Cancelar"})]})]}),e.jsxs("div",{className:"relative my-4",children:[e.jsx("div",{className:"absolute inset-0 flex items-center",children:e.jsx("span",{className:"w-full border-t"})}),e.jsx("div",{className:"relative flex justify-center text-xs uppercase",children:e.jsx("span",{className:"bg-white px-2 text-slate-500",children:"Ou"})})]}),e.jsxs(H,{type:"button",variant:"outline",className:"w-full",onClick:()=>{q(!0),V("")},disabled:b,children:[e.jsx(ta,{className:"w-4 h-4 mr-2"}),"Mover para outra fazenda"]})]})}),e.jsx(wa,{open:U,onOpenChange:q,receptora:N,fazendasDisponiveis:J,novaFazendaId:_,onFazendaChange:V,temConflitoBrinco:Y,temConflitoNome:O,novoBrincoProposto:W,submitting:p,onConfirmar:Q,onCancelar:()=>{q(!1),I()}}),e.jsx(Ve,{receptoraId:o,open:a,onClose:()=>t(!1),onUpdated:Ae})]})]})}export{rt as default};
