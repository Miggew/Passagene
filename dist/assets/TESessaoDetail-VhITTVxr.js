import{b as ee,ac as ae,r as d,s as C,j as e,f as se,B as b}from"./index-B-7HRnm0.js";import{b as re}from"./dataEnrichment-B3oy6j3b.js";import{C as F,d as O,a as te,b as oe,c as ie}from"./card-DdhhEbXV.js";import{B as ne}from"./badge-BCHVCiM7.js";import{I as ce}from"./input-D2h8r4MO.js";import{E as le}from"./EmptyState-gn01eel2.js";import{Q as de,C as me}from"./QualidadeSemaforo-CErGLmdF.js";import{C as w}from"./CountBadge-BBpPT0CT.js";import{R as $}from"./ResultBadge-HI1HZW2T.js";import{u as pe}from"./use-toast-DDUqdzpY.js";import{D as fe}from"./index-C6kCM6Yd.js";import{A as ue}from"./arrow-left-D9wDrV6g.js";import{S as xe}from"./search-DcAWDjHO.js";import"./popover-i4alam_g.js";import"./check-C6h7QFZL.js";function Te(){const z=ee(),[S]=ae(),{toast:E}=pe(),p=S.get("fazenda")||"",x=S.get("data_te")||"",_=S.get("vet")||"",[G,k]=d.useState(!0),[g,M]=d.useState(null),[c,T]=d.useState([]),[j,Q]=d.useState(""),[i,N]=d.useState(1),h=20;d.useEffect(()=>{if(!p||!x){E({title:"Parâmetros inválidos",description:"Faltam parâmetros para identificar a sessão",variant:"destructive"}),z("/transferencia");return}V()},[p,x,_]);const V=async()=>{try{k(!0);let a=C.from("transferencias_embrioes").select(`
          id,
          receptora_id,
          embriao_id,
          protocolo_receptora_id,
          data_te,
          tipo_te,
          veterinario_responsavel,
          tecnico_responsavel,
          observacoes,
          status_te,
          embrioes (id, identificacao, classificacao),
          receptoras (id, identificacao, nome)
        `).eq("status_te","REALIZADA").eq("data_te",x);_&&(a=a.eq("veterinario_responsavel",_));const{data:r,error:t}=await a;if(t)throw t;if(!r||r.length===0){T([]),M({fazenda_nome:p,data_te:x,veterinario_responsavel:_||void 0}),k(!1);return}const l=[...new Set(r.map(s=>s.receptora_id).filter(Boolean))],{data:n}=await C.from("vw_receptoras_fazenda_atual").select("receptora_id, fazenda_nome_atual").in("receptora_id",l),v=new Map((n||[]).map(s=>[s.receptora_id,s.fazenda_nome_atual])),D=r.map(s=>s.protocolo_receptora_id).filter(s=>!!s);let A=new Map,B=new Map;if(D.length>0){const{data:s}=await C.from("protocolo_receptoras").select("id, receptora_id, ciclando_classificacao, qualidade_semaforo").in("id",D);(s||[]).forEach(o=>{A.set(o.receptora_id,o.ciclando_classificacao),B.set(o.receptora_id,o.qualidade_semaforo)})}const U=r.map(s=>s.embriao_id).filter(Boolean),{data:I}=await C.from("embrioes").select("id, lote_fiv_acasalamento_id").in("id",U),Z=new Map((I||[]).map(s=>[s.id,s.lote_fiv_acasalamento_id])),J=(I||[]).map(s=>s.lote_fiv_acasalamento_id).filter(s=>!!s),{doadorasMap:W,tourosMap:X}=await re(J),Y=r.filter(s=>v.get(s.receptora_id)===p).map(s=>{var L,P,q,R;const o=Z.get(s.embriao_id);return{id:s.id,receptora_id:s.receptora_id,receptora_brinco:((L=s.receptoras)==null?void 0:L.identificacao)||"-",receptora_nome:(P=s.receptoras)==null?void 0:P.nome,ciclando_classificacao:A.get(s.receptora_id)||null,qualidade_semaforo:B.get(s.receptora_id)||null,embriao_identificacao:(q=s.embrioes)==null?void 0:q.identificacao,doadora_registro:o?W.get(o):void 0,touro_nome:o?X.get(o):void 0,classificacao:(R=s.embrioes)==null?void 0:R.classificacao,tipo_te:s.tipo_te,observacoes:s.observacoes}}).sort((s,o)=>s.receptora_brinco.localeCompare(o.receptora_brinco));T(Y);const u=r.find(s=>v.get(s.receptora_id)===p);M({fazenda_nome:p,data_te:x,veterinario_responsavel:(u==null?void 0:u.veterinario_responsavel)||_||void 0,tecnico_responsavel:u==null?void 0:u.tecnico_responsavel})}catch(a){console.error("Erro ao carregar sessão:",a),E({title:"Erro ao carregar dados",description:a instanceof Error?a.message:"Erro desconhecido",variant:"destructive"})}finally{k(!1)}},f=d.useMemo(()=>{if(!j.trim())return c;const a=j.toLowerCase();return c.filter(r=>{var t,l,n,v;return r.receptora_brinco.toLowerCase().includes(a)||((t=r.receptora_nome)==null?void 0:t.toLowerCase().includes(a))||((l=r.embriao_identificacao)==null?void 0:l.toLowerCase().includes(a))||((n=r.doadora_registro)==null?void 0:n.toLowerCase().includes(a))||((v=r.touro_nome)==null?void 0:v.toLowerCase().includes(a))})},[c,j]),m=Math.ceil(f.length/h),H=f.slice((i-1)*h,i*h),y=d.useMemo(()=>{const a=c.length,r=c.filter(n=>n.tipo_te==="FRESCO").length,t=c.filter(n=>n.tipo_te==="CONGELADO").length,l=new Set(c.map(n=>n.receptora_id)).size;return{total:a,frescos:r,congelados:t,receptoras:l}},[c]),K=a=>{if(!a)return"-";const[r,t,l]=a.split("-");return`${l}/${t}/${r}`};return G?e.jsx(se,{}):g?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(b,{variant:"ghost",size:"sm",onClick:()=>z(-1),children:e.jsx(ue,{className:"w-4 h-4"})}),e.jsx("h1",{className:"text-xl font-semibold text-foreground",children:"Sessão de Transferência"})]}),e.jsx(F,{children:e.jsxs(O,{className:"pt-4 pb-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-xs font-medium text-muted-foreground",children:"Fazenda"}),e.jsx("p",{className:"text-base font-semibold text-foreground",children:g.fazenda_nome})]}),e.jsx("div",{className:"h-8 w-px bg-border"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xs font-medium text-muted-foreground",children:"Data TE"}),e.jsx("p",{className:"text-sm text-foreground",children:K(g.data_te)})]}),e.jsx("div",{className:"h-8 w-px bg-border"}),e.jsx(ne,{variant:"default",className:"bg-primary hover:bg-primary-dark",children:"Realizada"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Receptoras:"}),e.jsx(w,{value:y.receptoras,variant:"default"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Total:"}),e.jsx(w,{value:y.total,variant:"primary"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Frescos:"}),e.jsx(w,{value:y.frescos,variant:"success"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Congelados:"}),e.jsx(w,{value:y.congelados,variant:"cyan"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4 pt-3 border-t border-border",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h4",{className:"text-[10px] font-semibold text-muted-foreground uppercase tracking-wide",children:"Veterinário"}),e.jsx("p",{className:"text-xs text-foreground",children:g.veterinario_responsavel||"—"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("h4",{className:"text-[10px] font-semibold text-muted-foreground uppercase tracking-wide",children:"Técnico"}),e.jsx("p",{className:"text-xs text-foreground",children:g.tecnico_responsavel||"—"})]})]})]})}),e.jsxs(F,{children:[e.jsx(te,{className:"pb-2 pt-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(oe,{className:"text-base",children:["Transferências (",f.length,")"]}),e.jsx(ie,{children:"Lista de todas as transferências realizadas na sessão"})]}),e.jsxs("div",{className:"relative w-64",children:[e.jsx(xe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(ce,{placeholder:"Buscar receptora, embrião...",value:j,onChange:a=>{Q(a.target.value),N(1)},className:"pl-9 h-9"})]})]})}),e.jsx(O,{className:"pt-0 pb-2",children:f.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:c.length===0?"Nenhuma transferência encontrada nesta sessão":"Nenhuma transferência corresponde à busca"}):e.jsxs(e.Fragment,{children:[e.jsx(fe,{data:H,rowKey:"id",rowNumber:!0,emptyMessage:"Nenhuma transferência encontrada",columns:[{key:"receptora_brinco",label:"Receptora"},{key:"ciclando_classificacao",label:"Ciclo",align:"center"},{key:"qualidade_semaforo",label:"Qual.",align:"center"},{key:"embriao_identificacao",label:"Embrião"},{key:"doadora_registro",label:"Doadora"},{key:"touro_nome",label:"Touro"},{key:"classificacao",label:"Class.",align:"center"},{key:"tipo_te",label:"Tipo",align:"center"}],renderCell:(a,r)=>{switch(r.key){case"receptora_brinco":return e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-sm text-foreground",children:a.receptora_brinco}),a.receptora_nome&&e.jsx("span",{className:"text-[10px] text-muted-foreground block",children:a.receptora_nome})]});case"ciclando_classificacao":return e.jsx(me,{value:a.ciclando_classificacao,variant:"display",disabled:!0});case"qualidade_semaforo":return e.jsx(de,{value:a.qualidade_semaforo,variant:"single",disabled:!0});case"embriao_identificacao":return e.jsx("span",{className:"text-xs font-mono font-medium text-foreground",children:a.embriao_identificacao||"-"});case"doadora_registro":return e.jsx("span",{className:"text-foreground",children:a.doadora_registro||"-"});case"touro_nome":return e.jsx("span",{className:"text-muted-foreground",children:a.touro_nome||"-"});case"classificacao":return a.classificacao?e.jsx($,{result:a.classificacao,size:"sm"}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"-"});case"tipo_te":return e.jsx($,{result:a.tipo_te});default:return null}}}),m>1&&e.jsxs("div",{className:"flex items-center justify-between mt-4 pt-4 border-t border-border",children:[e.jsxs("span",{className:"text-sm text-muted-foreground",children:["Mostrando ",(i-1)*h+1," a ",Math.min(i*h,f.length)," de ",f.length]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(b,{variant:"outline",size:"sm",onClick:()=>N(a=>Math.max(1,a-1)),disabled:i===1,children:"Anterior"}),e.jsx("div",{className:"flex items-center gap-1",children:Array.from({length:Math.min(5,m)},(a,r)=>{let t;return m<=5||i<=3?t=r+1:i>=m-2?t=m-4+r:t=i-2+r,e.jsx(b,{variant:i===t?"default":"outline",size:"sm",className:`w-9 h-9 p-0 ${i===t?"bg-primary hover:bg-primary-dark":""}`,onClick:()=>N(t),children:t},t)})}),e.jsx(b,{variant:"outline",size:"sm",onClick:()=>N(a=>Math.min(m,a+1)),disabled:i===m,children:"Próximo"})]})]})]})})]})]}):e.jsx(le,{title:"Sessão não encontrada",description:"Não foi possível carregar os dados da sessão.",action:e.jsx(b,{onClick:()=>z("/transferencia"),variant:"outline",children:"Voltar para TE"})})}export{Te as default};
