import{c as Ie,r as d,s as g,j as e,B as L,a as ke,i as Xe,h as Qe,D as Ke,L as _e,l as ea}from"./index-TMaXuGT-.js";import{f as qe}from"./statusLabels-IklKT8dE.js";import{N as aa,g as sa,a as ta}from"./coordinates-CP-XuR7c.js";import{C as Z,d as J,a as de,b as me}from"./card-DMaHdbj2.js";import{T as De,a as Ce,b as oe,c as F,d as Ee,e as I}from"./table-BcP2BpwR.js";import{T as ra,a as oa,b as we,c as be}from"./tabs-CNW-roJk.js";import{B as G}from"./badge-CUxYsHH9.js";import{P as ia}from"./PageHeader-B9IxJGm-.js";import{E as ye}from"./EmptyState-BdHwPhgd.js";import{u as Ne}from"./use-toast-BfiUt0Jw.js";import{D as fe,b as pe,c as ge,d as je,e as ve,f as na,a as Ue}from"./dialog-9Ry6kCpW.js";import{S as ze,a as Re,b as Me,c as Pe,d as re}from"./select-mKWZhFeY.js";import{I as te}from"./input-CS01soKQ.js";import{L as Y}from"./label-CDZKlFri.js";import{S as ca}from"./StatusBadge-CMfF4j6L.js";import{u as la,a as da,b as ma}from"./hooks-CRpet8tk.js";import{u as ua}from"./index-DzzTZhuj.js";import{T as ha}from"./textarea-4z0ihLXQ.js";import{m as Ve,a as Ge,D as xa,f as fa,p as pa}from"./DatePickerBR-CA4qskvz.js";import{S as Ze}from"./search-FTckgCkA.js";import{P as Je}from"./plus-BwrqBzf6.js";import{S as ga}from"./square-pen-B8zVsYtp.js";import{H as Ye,P as ja,D as va,G as Na,S as le}from"./DoadoraHistoricoAspiracoes-D-uMfWrE.js";import{B as Fe}from"./baby-qOdji3xf.js";import{f as _a}from"./dateUtils-eJ5e6apA.js";import{A as wa}from"./arrow-left-BZEOW66l.js";import{M as ba}from"./map-pin-C77ztlex.js";import{U as Sa}from"./user-DGBsfv5P.js";import{P as ya}from"./phone-xs-z0ddj.js";import{A as $e}from"./activity-Cg9VC26c.js";import{B as He}from"./beef-XcQHWfCD.js";import{C as Da}from"./chevron-right-BwBsAfCk.js";import"./index-DJtW2YFv.js";import"./index-CbBZSCMq.js";import"./x-_4GU21wu.js";import"./index-CleRECL4.js";import"./check-BrBvYO5V.js";import"./popover-C4Z9du6z.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ca=Ie("ArrowRight",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ea=Ie("CircleAlert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const za=Ie("ClipboardList",[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}],["path",{d:"M12 11h4",key:"1jrz19"}],["path",{d:"M12 16h4",key:"n85exb"}],["path",{d:"M8 11h.01",key:"1dfujw"}],["path",{d:"M8 16h.01",key:"18s6g9"}]]);function Ra(r,t){const s=Ta(r);let m;if(s.date){const h=Fa(s.date,2);m=Ia(h.restDateString,h.year)}if(!m||isNaN(m.getTime()))return new Date(NaN);const l=m.getTime();let j=0,x;if(s.time&&(j=ka(s.time),isNaN(j)))return new Date(NaN);if(s.timezone){if(x=Oa(s.timezone),isNaN(x))return new Date(NaN)}else{const h=new Date(l+j),n=new Date(0);return n.setFullYear(h.getUTCFullYear(),h.getUTCMonth(),h.getUTCDate()),n.setHours(h.getUTCHours(),h.getUTCMinutes(),h.getUTCSeconds(),h.getUTCMilliseconds()),n}return new Date(l+j+x)}const Se={dateTimeDelimiter:/[T ]/,timeZoneDelimiter:/[Z ]/i,timezone:/([Z+-].*)$/},Ma=/^-?(?:(\d{3})|(\d{2})(?:-?(\d{2}))?|W(\d{2})(?:-?(\d{1}))?|)$/,Pa=/^(\d{2}(?:[.,]\d*)?)(?::?(\d{2}(?:[.,]\d*)?))?(?::?(\d{2}(?:[.,]\d*)?))?$/,Aa=/^([+-])(\d{2})(?::?(\d{2}))?$/;function Ta(r){const t={},a=r.split(Se.dateTimeDelimiter);let s;if(a.length>2)return t;if(/:/.test(a[0])?s=a[0]:(t.date=a[0],s=a[1],Se.timeZoneDelimiter.test(t.date)&&(t.date=r.split(Se.timeZoneDelimiter)[0],s=r.substr(t.date.length,r.length))),s){const m=Se.timezone.exec(s);m?(t.time=s.replace(m[1],""),t.timezone=m[1]):t.time=s}return t}function Fa(r,t){const a=new RegExp("^(?:(\\d{4}|[+-]\\d{"+(4+t)+"})|(\\d{2}|[+-]\\d{"+(2+t)+"})$)"),s=r.match(a);if(!s)return{year:NaN,restDateString:""};const m=s[1]?parseInt(s[1]):null,l=s[2]?parseInt(s[2]):null;return{year:l===null?m:l*100,restDateString:r.slice((s[1]||s[2]).length)}}function Ia(r,t){if(t===null)return new Date(NaN);const a=r.match(Ma);if(!a)return new Date(NaN);const s=!!a[4],m=xe(a[1]),l=xe(a[2])-1,j=xe(a[3]),x=xe(a[4]),h=xe(a[5])-1;if(s)return qa(t,x,h)?Ba(t,x,h):new Date(NaN);{const n=new Date(0);return!$a(t,l,j)||!Ha(t,m)?new Date(NaN):(n.setUTCFullYear(t,l,Math.max(m,j)),n)}}function xe(r){return r?parseInt(r):1}function ka(r){const t=r.match(Pa);if(!t)return NaN;const a=Te(t[1]),s=Te(t[2]),m=Te(t[3]);return Ua(a,s,m)?a*Ve+s*Ge+m*1e3:NaN}function Te(r){return r&&parseFloat(r.replace(",","."))||0}function Oa(r){if(r==="Z")return 0;const t=r.match(Aa);if(!t)return 0;const a=t[1]==="+"?-1:1,s=parseInt(t[2]),m=t[3]&&parseInt(t[3])||0;return Va(s,m)?a*(s*Ve+m*Ge):NaN}function Ba(r,t,a){const s=new Date(0);s.setUTCFullYear(r,0,4);const m=s.getUTCDay()||7,l=(t-1)*7+a+1-m;return s.setUTCDate(s.getUTCDate()+l),s}const La=[31,null,31,30,31,30,31,31,30,31,30,31];function We(r){return r%400===0||r%4===0&&r%100!==0}function $a(r,t,a){return t>=0&&t<=11&&a>=1&&a<=(La[t]||(We(r)?29:28))}function Ha(r,t){return t>=1&&t<=(We(r)?366:365)}function qa(r,t,a){return t>=1&&t<=53&&a>=0&&a<=6}function Ua(r,t,a){return r===24?t===0&&a===0:a>=0&&a<60&&t>=0&&t<60&&r>=0&&r<25}function Va(r,t){return t>=0&&t<=59}function Ga({selectedFazendaId:r}){const[t,a]=d.useState(""),[s,m]=d.useState("all"),l=ua(t,300),[j,x]=d.useState(new Map),[h,n]=d.useState(new Set),{data:P=[],isLoading:R,refetch:k}=la(),{data:S=[],isLoading:E,refetch:M}=da(r||void 0);ma();const C=d.useMemo(()=>S.filter(c=>!h.has(c.id)).map(c=>{const y=j.get(c.id);return y?{...c,...y}:c}),[S,j,h]),$=d.useMemo(()=>Array.from(new Set(C.map(c=>c.status_calculado))).filter(c=>c).sort(),[C]),H=d.useMemo(()=>{let c=C;if(s!=="all"&&(c=c.filter(y=>y.status_calculado===s)),l.trim()){const y=l.toLowerCase();c=c.filter(A=>{var o;return A.identificacao.toLowerCase().includes(y)||((o=A.nome)==null?void 0:o.toLowerCase().includes(y))})}return c},[C,s,l]),_=async()=>{await k()},w=async()=>{r&&(x(new Map),n(new Set),await M())},i=async()=>{await w()},v=d.useCallback((c,y)=>{x(A=>{const o=new Map(A),f=o.get(c)||{};return o.set(c,{...f,...y}),o})},[]),N=d.useCallback(c=>{n(y=>new Set(y).add(c))},[]);return{fazendas:P,receptoras:C,filteredReceptoras:H,statusDisponiveis:$,loadingFazendas:R,loadingReceptoras:E,searchTerm:t,setSearchTerm:a,filtroStatus:s,setFiltroStatus:m,loadFazendas:_,loadReceptoras:w,reloadReceptoras:i,updateReceptoraInList:v,removeReceptoraFromList:N}}function Za({selectedFazendaId:r,onSuccess:t}){const{toast:a}=Ne(),[s,m]=d.useState({identificacao:"",nome:""}),[l,j]=d.useState(!1),[x,h]=d.useState({identificacao:"",nome:""}),[n,P]=d.useState(null),[R,k]=d.useState(!1),[S,E]=d.useState(!1),M=d.useCallback(()=>{m({identificacao:"",nome:""})},[]),C=d.useCallback(()=>{h({identificacao:"",nome:""}),P(null)},[]),$=d.useCallback(w=>{P(w),h({identificacao:w.identificacao,nome:w.nome||""}),k(!0)},[]),H=d.useCallback(async w=>{if(w.preventDefault(),!s.identificacao.trim()){a({title:"Erro de validação",description:"Identificação (brinco) é obrigatória",variant:"destructive"});return}if(!r){a({title:"Erro de validação",description:"Selecione uma fazenda primeiro",variant:"destructive"});return}try{E(!0);const{data:i,error:v}=await g.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",r);if(v)throw v;const N=(i==null?void 0:i.map(o=>o.receptora_id))||[];if(N.length>0){const{data:o,error:f}=await g.from("receptoras").select("id, identificacao, nome").in("id",N).ilike("identificacao",s.identificacao.trim());if(f)throw f;if(o&&o.length>0){const D=o[0].nome?`"${o[0].nome}"`:"sem nome";throw new Error(`Já existe uma receptora com o brinco "${s.identificacao.trim()}" nesta fazenda (Nome: ${D}).`)}if(s.nome.trim()){const{data:D,error:O}=await g.from("receptoras").select("id, identificacao").in("id",N).ilike("nome",s.nome.trim());if(O)throw O;if(D&&D.length>0)throw new Error(`Já existe uma receptora com o nome "${s.nome.trim()}" nesta fazenda (Brinco: ${D[0].identificacao}).`)}}const c={identificacao:s.identificacao};s.nome.trim()&&(c.nome=s.nome);const{data:y,error:A}=await g.from("receptoras").insert([c]).select().single();if(A)throw A.code==="23505"?new Error("Já existe uma receptora com esse brinco nesta fazenda."):A;await g.from("receptora_fazenda_historico").insert([{receptora_id:y.id,fazenda_id:r,data_inicio:new Date().toISOString().split("T")[0],data_fim:null}]),a({title:"Receptora criada",description:"Receptora criada com sucesso"}),j(!1),M(),t==null||t()}catch(i){a({title:"Erro ao criar receptora",description:i instanceof Error?i.message:"Erro desconhecido",variant:"destructive"})}finally{E(!1)}},[s,r,a,M,t]),_=d.useCallback(async w=>{if(w.preventDefault(),!!n){if(!x.identificacao.trim()){a({title:"Erro de validação",description:"Identificação (brinco) é obrigatória",variant:"destructive"});return}try{E(!0);const i=n.identificacao,v=x.identificacao.trim(),N=i!==v,c={identificacao:v,nome:x.nome.trim()||null},{error:y}=await g.from("receptoras").update(c).eq("id",n.id);if(y)throw y.code==="23505"?new Error("Já existe uma receptora com esse brinco nesta fazenda."):y;if(N)try{await g.from("receptora_renomeacoes_historico").insert([{receptora_id:n.id,brinco_anterior:i,brinco_novo:v,data_renomeacao:new Date().toISOString(),motivo:"EDICAO_MANUAL",observacoes:null}])}catch{}a({title:"Receptora atualizada",description:N?`Receptora atualizada. Brinco alterado de "${i}" para "${v}".`:"Receptora atualizada com sucesso"}),k(!1),C(),t==null||t()}catch(i){a({title:"Erro ao atualizar receptora",description:i instanceof Error?i.message:"Erro desconhecido",variant:"destructive"})}finally{E(!1)}}},[x,n,a,C,t]);return{formData:s,setFormData:m,showDialog:l,setShowDialog:j,editFormData:x,setEditFormData:h,editingReceptora:n,showEditDialog:R,setShowEditDialog:k,submitting:S,handleSubmit:H,handleEditSubmit:_,handleEdit:$,resetForm:M,resetEditForm:C}}function Ja({fazendas:r,selectedFazendaId:t,editingReceptora:a,onSuccess:s,onClose:m}){const{toast:l}=Ne(),[j,x]=d.useState(!1),[h,n]=d.useState(""),[P,R]=d.useState(""),[k,S]=d.useState(!1),[E,M]=d.useState(!1),[C,$]=d.useState(!1),H=d.useCallback(()=>{n(""),R(""),S(!1),M(!1)},[]),_=r.filter(i=>i.id!==t);d.useEffect(()=>{(async()=>{if(!a||!h){S(!1),R(""),M(!1);return}try{const{data:v,error:N}=await g.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",h);if(N)return;const c=(v==null?void 0:v.map(o=>o.receptora_id))||[];if(c.length===0){S(!1),R(""),M(!1);return}if(a.nome&&a.nome.trim()){const{data:o,error:f}=await g.from("receptoras").select("id, nome, identificacao").in("id",c).ilike("nome",a.nome.trim());!f&&o&&o.length>0?M(!0):M(!1)}else M(!1);const{data:y,error:A}=await g.from("receptoras").select("id, identificacao").in("id",c).ilike("identificacao",a.identificacao);if(A)return;if(y&&y.length>0){S(!0);const o=async(f,D=0)=>{if(D>10)throw new Error("Não foi possível gerar um brinco disponível após várias tentativas");const O=new Date,T=String(O.getDate()).padStart(2,"0"),W=String(O.getMonth()+1).padStart(2,"0"),ae=D===0?`-MOV${T}${W}`:`-MOV${T}${W}-${D}`,X=`${f}${ae}`,{data:Q,error:ee}=await g.from("receptoras").select("id, identificacao").in("id",c).ilike("identificacao",X);return ee?X:Q&&Q.length>0?o(f,D+1):X};try{const f=await o(a.identificacao);R(f)}catch{const f=new Date,D=String(f.getDate()).padStart(2,"0"),O=String(f.getMonth()+1).padStart(2,"0");R(`${a.identificacao}-MOV${D}${O}`)}}else S(!1),R("")}catch{S(!1),R("")}})()},[a,h]);const w=d.useCallback(async()=>{if(!a||!h){l({title:"Erro de validação",description:"Selecione uma fazenda de destino",variant:"destructive"});return}if(E&&a.nome&&a.nome.trim()){l({title:"Conflito de nome",description:`Já existe uma receptora com o nome "${a.nome.trim()}" na fazenda destino. Não é possível mover esta receptora.`,variant:"destructive"});return}try{$(!0);const i=a.identificacao;let v=i;if(k&&P){v=P;const{error:c}=await g.from("receptoras").update({identificacao:v}).eq("id",a.id);if(c)throw new Error(`Erro ao atualizar brinco: ${c.message}`);try{await g.from("receptora_renomeacoes_historico").insert([{receptora_id:a.id,brinco_anterior:i,brinco_novo:v,data_renomeacao:new Date().toISOString(),motivo:"MUDANCA_FAZENDA",observacoes:"Renomeação automática devido a conflito de brinco na fazenda destino"}])}catch{}}const{error:N}=await g.rpc("mover_receptora_fazenda",{p_receptora_id:a.id,p_nova_fazenda_id:h,p_data_mudanca:new Date().toISOString().split("T")[0],p_observacoes:null});if(N){let c="Erro ao mover receptora";N.message?c=N.message:N.details&&(c=N.details),l({title:"Erro ao mover receptora",description:c,variant:"destructive"});return}l({title:"Receptora movida",description:k?`Receptora movida com sucesso. Brinco atualizado de "${i}" para "${v}" devido a conflito na fazenda destino.`:"Receptora movida para a nova fazenda com sucesso. Protocolos e histórico não foram afetados."}),x(!1),H(),m==null||m(),s==null||s()}catch(i){l({title:"Erro ao mover receptora",description:i instanceof Error?i.message:"Erro desconhecido ao mover receptora",variant:"destructive"})}finally{$(!1)}},[a,h,k,E,P,l,H,m,s]);return{showMoverFazendaDialog:j,setShowMoverFazendaDialog:x,novaFazendaId:h,setNovaFazendaId:n,novoBrincoProposto:P,temConflitoBrinco:k,temConflitoNome:E,submittingMover:C,fazendasDisponiveis:_,handleMoverFazenda:w,resetMoverState:H}}function Ya({selectedFazendaId:r,fazendas:t,onSuccess:a}){const{toast:s}=Ne(),m=new Date().toISOString().split("T")[0],[l,j]=d.useState(!1),[x,h]=d.useState({receptora_id:"",data_nascimento:m,sexo:"",observacoes:""}),[n,P]=d.useState([]),[R,k]=d.useState(!1),[S,E]=d.useState(!1),M=_=>_.includes("FEMEA")?"FEMEA":_.includes("MACHO")?"MACHO":"SEM_SEXO",C=async _=>{const{data:w,error:i}=await g.from("transferencias_embrioes").select("embriao_id, data_te").eq("receptora_id",_).eq("status_te","REALIZADA").order("data_te",{ascending:!1});if(i)throw i;if(!w||w.length===0)return[];const v=w[0].data_te,c=w.filter(b=>b.data_te===v).map(b=>b.embriao_id).filter(Boolean);if(c.length===0)return[];const{data:y}=await g.from("animais").select("embriao_id").in("embriao_id",c),A=new Set((y||[]).map(b=>b.embriao_id)),o=c.filter(b=>!A.has(b));if(o.length===0)return[];const{data:f,error:D}=await g.from("embrioes").select("id, lote_fiv_acasalamento_id").in("id",o);if(D)throw D;const O=[...new Set((f||[]).map(b=>b.lote_fiv_acasalamento_id).filter(Boolean))];let T=[],W=[],ae=[],X=[];if(O.length>0){const{data:b}=await g.from("lote_fiv_acasalamentos").select("id, aspiracao_doadora_id, dose_semen_id").in("id",O);T=b||[];const U=[...new Set(T.map(B=>B.aspiracao_doadora_id).filter(Boolean))],K=[...new Set(T.map(B=>B.dose_semen_id).filter(Boolean))];if(U.length>0){const{data:B}=await g.from("aspiracoes_doadoras").select("id, doadora_id").in("id",U);W=B||[];const V=[...new Set(W.map(q=>q.doadora_id).filter(Boolean))];if(V.length>0){const{data:q}=await g.from("doadoras").select("id, registro, raca").in("id",V);ae=q||[]}}if(K.length>0){const{data:B}=await g.from("doses_semen").select("id, touro:touros(id, nome, registro, raca)").in("id",K);X=B||[]}}const Q=new Map(T.map(b=>[b.id,b])),ee=new Map(W.map(b=>[b.id,b])),ie=new Map(ae.map(b=>[b.id,b])),se=new Map(X.map(b=>[b.id,b]));return(f||[]).map(b=>{const U=b.lote_fiv_acasalamento_id?Q.get(b.lote_fiv_acasalamento_id):void 0,K=U?ee.get(U.aspiracao_doadora_id):void 0,B=K?ie.get(K.doadora_id):void 0,V=U?se.get(U.dose_semen_id):void 0,q=(V==null?void 0:V.touro)??null;return{embriao_id:b.id,doadora_registro:B==null?void 0:B.registro,touro_nome:q==null?void 0:q.nome,raca:(B==null?void 0:B.raca)||(q==null?void 0:q.raca)}})},$=d.useCallback(async _=>{var w;try{k(!0),P([]),h({receptora_id:_.id,data_nascimento:m,sexo:"",observacoes:""}),j(!0);const[i,v]=await Promise.all([C(_.id),g.from("diagnosticos_gestacao").select("sexagem").eq("receptora_id",_.id).eq("tipo_diagnostico","SEXAGEM").order("data_diagnostico",{ascending:!1}).limit(1).maybeSingle()]),N=((w=v==null?void 0:v.data)==null?void 0:w.sexagem)||M(_.status_calculado);h(c=>({...c,sexo:N||""})),P(i),i.length===0&&s({title:"Sem embriões disponíveis",description:"Nenhum embrião elegível para criar animal foi encontrado."})}catch(i){s({title:"Erro ao preparar nascimento",description:i instanceof Error?i.message:"Erro desconhecido",variant:"destructive"})}finally{k(!1)}},[m,s]),H=d.useCallback(async()=>{if(!r){s({title:"Fazenda não selecionada",description:"Selecione a fazenda antes de registrar o nascimento.",variant:"destructive"});return}if(!x.receptora_id){s({title:"Receptora não selecionada",description:"Selecione a receptora para registrar o nascimento.",variant:"destructive"});return}if(!x.data_nascimento){s({title:"Data de nascimento obrigatória",description:"Informe a data de nascimento.",variant:"destructive"});return}if(!x.sexo){s({title:"Sexo obrigatório",description:"Selecione o sexo da prenhez.",variant:"destructive"});return}if(n.length===0){s({title:"Sem embriões vinculados",description:"Nenhum embrião encontrado para a última transferência desta receptora.",variant:"destructive"});return}try{E(!0);const _=t.find(c=>c.id===r),w=(_==null?void 0:_.cliente_id)||null,i=n.map(c=>({embriao_id:c.embriao_id,receptora_id:x.receptora_id,fazenda_id:r,cliente_id:w,data_nascimento:x.data_nascimento,sexo:x.sexo,raca:c.raca||null,pai_nome:c.touro_nome||null,mae_nome:c.doadora_registro||null,observacoes:x.observacoes||null})),{error:v}=await g.from("animais").insert(i);if(v)throw v;const{error:N}=await g.from("receptoras").update({status_reprodutivo:"VAZIA",data_provavel_parto:null}).eq("id",x.receptora_id);if(N)throw N;s({title:"Nascimento registrado",description:`${i.length} animal(is) criado(s) com sucesso.`}),j(!1),P([]),h({receptora_id:"",data_nascimento:m,sexo:"",observacoes:""}),a==null||a()}catch(_){s({title:"Erro ao registrar nascimento",description:_ instanceof Error?_.message:"Erro desconhecido",variant:"destructive"})}finally{E(!1)}},[x,n,r,t,m,s,a]);return{showNascimentoDialog:l,setShowNascimentoDialog:j,nascimentoForm:x,setNascimentoForm:h,nascimentoEmbrioes:n,nascimentoLoading:R,submitting:S,handleAbrirNascimento:$,handleRegistrarNascimento:H}}function Wa({open:r,onOpenChange:t,receptora:a,fazendasDisponiveis:s,novaFazendaId:m,onFazendaChange:l,temConflitoBrinco:j,temConflitoNome:x,novoBrincoProposto:h,submitting:n,onConfirmar:P,onCancelar:R}){const k=E=>{t(E),E||R()},S=m&&!x&&!(j&&!h);return e.jsx(fe,{open:r,onOpenChange:k,children:e.jsxs(pe,{className:"max-w-md",children:[e.jsxs(ge,{children:[e.jsx(je,{children:"Mover Receptora"}),e.jsxs(ve,{children:["Mover ",a==null?void 0:a.identificacao," para outra fazenda. Protocolos e histórico reprodutivo não serão afetados."]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{htmlFor:"nova_fazenda",children:"Nova Fazenda *"}),e.jsxs(ze,{value:m,onValueChange:l,children:[e.jsx(Re,{children:e.jsx(Me,{placeholder:"Selecione a fazenda de destino"})}),e.jsx(Pe,{children:s.map(E=>e.jsx(re,{value:E.id,children:E.nome},E.id))})]})]}),x&&(a==null?void 0:a.nome)&&e.jsxs("div",{className:"space-y-2 p-3 bg-red-50 border border-red-200 rounded-md",children:[e.jsx("div",{className:"flex items-start gap-2",children:e.jsx("div",{className:"text-red-800 text-sm font-medium",children:"Conflito de Nome Detectado"})}),e.jsxs("div",{className:"text-red-700 text-sm",children:['Já existe uma receptora com o nome "',a.nome.trim(),'" na fazenda destino.']}),e.jsx("div",{className:"text-red-600 text-xs",children:"Não é possível mover esta receptora. Edite o nome da receptora antes de movê-la."})]}),j&&h&&e.jsxs("div",{className:"space-y-2 p-3 bg-yellow-50 border border-yellow-200 rounded-md",children:[e.jsx("div",{className:"flex items-start gap-2",children:e.jsx("div",{className:"text-yellow-800 text-sm font-medium",children:"Conflito de Brinco Detectado"})}),e.jsxs("div",{className:"text-yellow-700 text-sm",children:['Já existe uma receptora com o brinco "',a==null?void 0:a.identificacao,'" na fazenda destino.']}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Y,{className:"text-yellow-800 text-sm font-medium",children:"Novo Brinco Proposto:"}),e.jsx("div",{className:"p-2 bg-white border border-yellow-300 rounded text-sm font-mono text-yellow-900",children:h}),e.jsx("div",{className:"text-yellow-600 text-xs",children:"O brinco será automaticamente atualizado para permitir a movimentação."})]})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(L,{type:"button",className:"flex-1",onClick:P,disabled:n||!S,children:n?"Movendo...":"Confirmar Movimentação"}),e.jsx(L,{type:"button",variant:"outline",onClick:R,disabled:n,children:"Cancelar"})]})]})]})})}function Xa({open:r,onOpenChange:t,nascimentoForm:a,onFormChange:s,nascimentoEmbrioes:m,nascimentoLoading:l,submitting:j,onRegistrar:x,onCancelar:h}){return e.jsx(fe,{open:r,onOpenChange:t,children:e.jsxs(pe,{className:"max-w-2xl",children:[e.jsxs(ge,{children:[e.jsx(je,{children:"Registrar nascimento"}),e.jsx(ve,{children:"Crie os animais a partir da prenhez desta receptora."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{children:"Data de nascimento *"}),e.jsx(xa,{value:a.data_nascimento,onChange:n=>s({...a,data_nascimento:n||""}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{children:"Sexo *"}),e.jsxs(ze,{value:a.sexo,onValueChange:n=>s({...a,sexo:n}),children:[e.jsx(Re,{children:e.jsx(Me,{placeholder:"Selecione o sexo"})}),e.jsxs(Pe,{children:[e.jsx(re,{value:"FEMEA",children:"Fêmea"}),e.jsx(re,{value:"MACHO",children:"Macho"}),e.jsx(re,{value:"SEM_SEXO",children:"Sem sexo"})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{children:"Observações"}),e.jsx(ha,{value:a.observacoes,onChange:n=>s({...a,observacoes:n.target.value}),placeholder:"Observações sobre o nascimento",rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{children:"Embriões vinculados"}),l&&e.jsx("div",{className:"text-sm text-slate-500",children:"Carregando dados..."}),!l&&m.length===0&&e.jsx("div",{className:"text-sm text-slate-500",children:"Nenhum embrião disponível para registro."}),!l&&m.length>0&&e.jsx("div",{className:"border rounded-lg p-3",children:e.jsxs(De,{children:[e.jsx(Ce,{children:e.jsxs(oe,{children:[e.jsx(F,{children:"Embrião"}),e.jsx(F,{children:"Doadora"}),e.jsx(F,{children:"Touro"}),e.jsx(F,{children:"Raça"})]})}),e.jsx(Ee,{children:m.map(n=>e.jsxs(oe,{children:[e.jsx(I,{className:"font-medium",children:n.embriao_id.substring(0,8)}),e.jsx(I,{children:n.doadora_registro||"-"}),e.jsx(I,{children:n.touro_nome||"-"}),e.jsx(I,{children:n.raca||"-"})]},n.embriao_id))})]})})]})]}),e.jsxs(na,{children:[e.jsx(L,{type:"button",variant:"outline",onClick:h,children:"Cancelar"}),e.jsx(L,{type:"button",onClick:x,disabled:j,children:"Registrar nascimento"})]})]})})}function Qa({fazendaId:r,fazendaNome:t}){const a=ke(),[s,m]=d.useState(null),{fazendas:l,filteredReceptoras:j,statusDisponiveis:x,loadingReceptoras:h,searchTerm:n,setSearchTerm:P,filtroStatus:R,setFiltroStatus:k,reloadReceptoras:S,removeReceptoraFromList:E}=Ga({selectedFazendaId:r}),{formData:M,setFormData:C,showDialog:$,setShowDialog:H,editFormData:_,setEditFormData:w,editingReceptora:i,showEditDialog:v,setShowEditDialog:N,submitting:c,handleSubmit:y,handleEditSubmit:A,handleEdit:o}=Za({selectedFazendaId:r,onSuccess:S}),[f,D]=d.useState(null),{showMoverFazendaDialog:O,setShowMoverFazendaDialog:T,novaFazendaId:W,setNovaFazendaId:ae,novoBrincoProposto:X,temConflitoBrinco:Q,temConflitoNome:ee,submittingMover:ie,fazendasDisponiveis:se,handleMoverFazenda:b,resetMoverState:U}=Ja({fazendas:l,selectedFazendaId:r,editingReceptora:f,onSuccess:()=>{f&&E(f.id),D(null)},onClose:()=>{D(null)}}),K=u=>{D(u),U(),T(!0)},{showNascimentoDialog:B,setShowNascimentoDialog:V,nascimentoForm:q,setNascimentoForm:Ae,nascimentoEmbrioes:p,nascimentoLoading:z,submitting:ue,handleAbrirNascimento:ne,handleRegistrarNascimento:ce}=Ya({selectedFazendaId:r,fazendas:l,onSuccess:S}),he=u=>{if(!u)return"-";try{return fa(Ra(u),"dd/MM/yyyy",{locale:pa})}catch{return"-"}};return h?e.jsx(Z,{children:e.jsx(J,{className:"py-8",children:e.jsx("div",{className:"flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"})})})}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsxs("div",{className:"relative flex-1 max-w-xs",children:[e.jsx(Ze,{className:"absolute left-2 top-2.5 h-4 w-4 text-slate-400"}),e.jsx(te,{placeholder:"Buscar por brinco ou nome...",value:n,onChange:u=>P(u.target.value),className:"pl-8"})]}),e.jsxs(ze,{value:R,onValueChange:k,children:[e.jsx(Re,{className:"w-[180px]",children:e.jsx(Me,{placeholder:"Filtrar status"})}),e.jsxs(Pe,{children:[e.jsx(re,{value:"todos",children:"Todos os status"}),x.map(u=>e.jsx(re,{value:u,children:qe(u)},u))]})]})]}),e.jsxs(fe,{open:$,onOpenChange:H,children:[e.jsx(Ue,{asChild:!0,children:e.jsxs(L,{children:[e.jsx(Je,{className:"w-4 h-4 mr-2"}),"Nova Receptora"]})}),e.jsxs(pe,{children:[e.jsxs(ge,{children:[e.jsx(je,{children:"Cadastrar Receptora"}),e.jsxs(ve,{children:["Adicionar receptora em ",t]})]}),e.jsxs("form",{onSubmit:y,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{htmlFor:"identificacao",children:"Brinco/Identificação *"}),e.jsx(te,{id:"identificacao",value:M.identificacao,onChange:u=>C({...M,identificacao:u.target.value}),placeholder:"Ex: 001, A123",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{htmlFor:"nome",children:"Nome (opcional)"}),e.jsx(te,{id:"nome",value:M.nome,onChange:u=>C({...M,nome:u.target.value}),placeholder:"Nome da receptora"})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(L,{type:"submit",className:"flex-1",disabled:c,children:c?"Salvando...":"Cadastrar"}),e.jsx(L,{type:"button",variant:"outline",onClick:()=>H(!1),children:"Cancelar"})]})]})]})]})]}),e.jsxs(Z,{children:[e.jsx(de,{children:e.jsxs(me,{children:["Receptoras (",j.length,")"]})}),e.jsx(J,{children:j.length===0?e.jsx(ye,{title:"Nenhuma receptora encontrada",description:n||R!=="todos"?"Tente ajustar os filtros":"Cadastre a primeira receptora desta fazenda"}):e.jsxs(De,{children:[e.jsx(Ce,{children:e.jsxs(oe,{children:[e.jsx(F,{children:"Brinco"}),e.jsx(F,{children:"Nome"}),e.jsx(F,{children:"Status"}),e.jsx(F,{children:"Data Provável Parto"}),e.jsx(F,{className:"text-right",children:"Ações"})]})}),e.jsx(Ee,{children:j.map(u=>e.jsxs(oe,{children:[e.jsx(I,{className:"font-medium",children:u.identificacao}),e.jsx(I,{children:u.nome||"-"}),e.jsx(I,{children:e.jsx(ca,{status:u.status_calculado||u.status_reprodutivo||"DISPONIVEL"})}),e.jsx(I,{children:he(u.data_provavel_parto)}),e.jsx(I,{className:"text-right",children:e.jsxs("div",{className:"flex gap-1 justify-end",children:[e.jsx(L,{variant:"ghost",size:"sm",onClick:()=>o(u),title:"Editar",children:e.jsx(ga,{className:"w-4 h-4"})}),e.jsx(L,{variant:"ghost",size:"sm",onClick:()=>a(`/receptoras/${u.id}/historico`),title:"Histórico",children:e.jsx(Ye,{className:"w-4 h-4"})}),e.jsx(L,{variant:"ghost",size:"sm",onClick:()=>K(u),title:"Mover para outra fazenda",children:e.jsx(Ca,{className:"w-4 h-4"})}),(u.status_calculado||"").includes("PRENHE")&&e.jsx(L,{variant:"ghost",size:"sm",onClick:()=>ne(u),title:"Registrar nascimento",children:e.jsx(Fe,{className:"w-4 h-4"})})]})})]},u.id))})]})})]}),e.jsx(fe,{open:v,onOpenChange:N,children:e.jsxs(pe,{children:[e.jsxs(ge,{children:[e.jsx(je,{children:"Editar Receptora"}),e.jsxs(ve,{children:["Editando ",i==null?void 0:i.identificacao]})]}),e.jsxs("form",{onSubmit:A,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{htmlFor:"edit-identificacao",children:"Brinco/Identificação *"}),e.jsx(te,{id:"edit-identificacao",value:_.identificacao,onChange:u=>w({..._,identificacao:u.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{htmlFor:"edit-nome",children:"Nome"}),e.jsx(te,{id:"edit-nome",value:_.nome,onChange:u=>w({..._,nome:u.target.value})})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(L,{type:"submit",className:"flex-1",disabled:c,children:c?"Salvando...":"Salvar"}),e.jsx(L,{type:"button",variant:"outline",onClick:()=>N(!1),children:"Cancelar"})]})]})]})}),e.jsx(Wa,{open:O,onOpenChange:T,receptora:f,fazendasDisponiveis:se,novaFazendaId:W,onFazendaChange:ae,temConflitoBrinco:Q,temConflitoNome:ee,novoBrincoProposto:X,submitting:ie,onConfirmar:b,onCancelar:()=>{T(!1),D(null),U()}}),e.jsx(Xa,{open:B,onOpenChange:V,nascimentoForm:q,onFormChange:Ae,nascimentoEmbrioes:p,nascimentoLoading:z,submitting:ue,onRegistrar:ce,onCancelar:()=>V(!1)})]})}const Ka=["Gir","Gir Leiteiro","Girolando","Nelore","Brahman","Senepol","Angus","Holandês","Jersey"];function es({fazendaId:r,fazendaNome:t}){var y,A;const a=ke(),{toast:s}=Ne(),[m,l]=d.useState(!0),[j,x]=d.useState([]),[h,n]=d.useState(""),[P,R]=d.useState(null),[k,S]=d.useState(!1),[E,M]=d.useState(!1),[C,$]=d.useState({registro:"",raca:"",racaCustom:""}),[H,_]=d.useState(""),w=d.useCallback(async()=>{try{l(!0);const{data:o,error:f}=await g.from("doadoras").select("*").eq("fazenda_id",r).order("created_at",{ascending:!1});if(f)throw f;const D=await Promise.all((o||[]).map(async O=>{const{data:T}=await g.from("aspiracoes_doadoras").select("total_oocitos, data_aspiracao").eq("doadora_id",O.id).order("data_aspiracao",{ascending:!1}).limit(1).maybeSingle();return{...O,ultima_aspiracao_total_oocitos:T==null?void 0:T.total_oocitos,ultima_aspiracao_data:T==null?void 0:T.data_aspiracao}}));x(D)}catch(o){s({title:"Erro ao carregar doadoras",description:o instanceof Error?o.message:"Erro desconhecido",variant:"destructive"})}finally{l(!1)}},[r,s]);d.useEffect(()=>{w()},[w]);const i=j.filter(o=>{var D,O,T;if(!h.trim())return!0;const f=h.toLowerCase();return((D=o.nome)==null?void 0:D.toLowerCase().includes(f))||((O=o.registro)==null?void 0:O.toLowerCase().includes(f))||((T=o.raca)==null?void 0:T.toLowerCase().includes(f))}),v=o=>{_(o),$(o!=="Outra"?{...C,raca:o,racaCustom:""}:{...C,raca:"",racaCustom:""})},N=async o=>{if(o.preventDefault(),!!C.registro.trim())try{M(!0);const f=H==="Outra"?C.racaCustom:C.raca,{error:D}=await g.from("doadoras").insert({fazenda_id:r,registro:C.registro.trim(),raca:f});if(D)throw D;s({title:"Doadora criada",description:"Doadora cadastrada com sucesso."}),S(!1),$({registro:"",raca:"",racaCustom:""}),_(""),w()}catch(f){s({title:"Erro ao criar doadora",description:f instanceof Error?f.message:"Erro desconhecido",variant:"destructive"})}finally{M(!1)}},c=o=>{if(!o)return"-";switch(o){case"1_estrela":return e.jsx("div",{className:"flex items-center gap-1",children:e.jsx(le,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"})});case"2_estrelas":return e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(le,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"}),e.jsx(le,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"})]});case"3_estrelas":return e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(le,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"}),e.jsx(le,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"}),e.jsx(le,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"})]});case"diamante":return e.jsx("div",{className:"flex items-center gap-1",children:e.jsx(Na,{className:"w-4 h-4 fill-blue-500 text-blue-500"})});default:return"-"}};return m?e.jsx(Z,{children:e.jsx(J,{className:"py-8",children:e.jsx("div",{className:"flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"})})})}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-2 flex-1",children:e.jsxs("div",{className:"relative flex-1 max-w-xs",children:[e.jsx(Ze,{className:"absolute left-2 top-2.5 h-4 w-4 text-slate-400"}),e.jsx(te,{placeholder:"Buscar por nome ou registro...",value:h,onChange:o=>n(o.target.value),className:"pl-8"})]})}),e.jsxs(fe,{open:k,onOpenChange:S,children:[e.jsx(Ue,{asChild:!0,children:e.jsxs(L,{children:[e.jsx(Je,{className:"w-4 h-4 mr-2"}),"Nova Doadora"]})}),e.jsxs(pe,{className:"max-w-md",children:[e.jsxs(ge,{children:[e.jsx(je,{children:"Cadastrar Doadora"}),e.jsxs(ve,{children:["Adicionar doadora em ",t]})]}),e.jsxs("form",{onSubmit:N,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{htmlFor:"registro",children:"Registro *"}),e.jsx(te,{id:"registro",value:C.registro,onChange:o=>$({...C,registro:o.target.value}),placeholder:"Registro da doadora",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{htmlFor:"raca",children:"Raca *"}),e.jsxs(ze,{value:H,onValueChange:v,children:[e.jsx(Re,{children:e.jsx(Me,{placeholder:"Selecione a raca"})}),e.jsxs(Pe,{children:[Ka.map(o=>e.jsx(re,{value:o,children:o},o)),e.jsx(re,{value:"Outra",children:"Outra"})]})]}),H==="Outra"&&e.jsx(te,{id:"raca_custom",value:C.racaCustom,onChange:o=>$({...C,racaCustom:o.target.value,raca:o.target.value}),placeholder:"Digite a raca",className:"mt-2",required:!0})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(L,{type:"submit",className:"flex-1",disabled:E,children:E?"Salvando...":"Criar Doadora"}),e.jsx(L,{type:"button",variant:"outline",onClick:()=>S(!1),disabled:E,children:"Cancelar"})]})]})]})]})]}),e.jsxs(Z,{children:[e.jsx(de,{children:e.jsxs(me,{children:["Doadoras (",i.length,")"]})}),e.jsx(J,{children:i.length===0?e.jsx(ye,{title:"Nenhuma doadora encontrada",description:h?"Tente ajustar a busca":"Cadastre a primeira doadora desta fazenda"}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(De,{children:[e.jsx(Ce,{children:e.jsxs(oe,{children:[e.jsx(F,{children:"Registro"}),e.jsx(F,{children:"Nome"}),e.jsx(F,{children:"Raca"}),e.jsx(F,{children:"Classificacao"}),e.jsx(F,{children:"Ultima Aspiracao"}),e.jsx(F,{children:"Oocitos"}),e.jsx(F,{children:"Estado"}),e.jsx(F,{className:"text-right",children:"Acoes"})]})}),e.jsx(Ee,{children:i.map(o=>e.jsxs(oe,{className:"cursor-pointer hover:bg-slate-50",onClick:()=>a(`/doadoras/${o.id}`),children:[e.jsx(I,{className:"font-medium",children:o.registro}),e.jsx(I,{children:o.nome||"-"}),e.jsx(I,{children:o.raca||"-"}),e.jsx(I,{children:c(o.classificacao_genetica)}),e.jsx(I,{children:o.ultima_aspiracao_data?_a(o.ultima_aspiracao_data):"-"}),e.jsx(I,{children:o.ultima_aspiracao_total_oocitos??"-"}),e.jsx(I,{children:e.jsx(G,{variant:o.disponivel_aspiracao?"default":"secondary",children:o.disponivel_aspiracao?"Disponivel":"Indisponivel"})}),e.jsx(I,{className:"text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(L,{variant:"ghost",size:"sm",onClick:f=>{f.stopPropagation(),R(o.id)},title:"Ver historico de aspiracoes",children:e.jsx(Ye,{className:"w-4 h-4"})}),e.jsx(L,{variant:"ghost",size:"sm",onClick:f=>{f.stopPropagation(),a(`/doadoras/${o.id}`)},title:"Editar doadora",children:e.jsx(ja,{className:"w-4 h-4"})})]})})]},o.id))})]})})})]}),P&&e.jsx(va,{doadoraId:P,doadoraNome:((y=j.find(o=>o.id===P))==null?void 0:y.nome)||((A=j.find(o=>o.id===P))==null?void 0:A.registro),open:!!P,onClose:()=>R(null)})]})}function Bs(){const{id:r}=Xe(),t=ke(),{toast:a}=Ne(),[s,m]=d.useState(!0),[l,j]=d.useState(null),[x,h]=d.useState(""),[n,P]=d.useState({passo2Pendente:0,tePendente:0,dgPendente:0,sexagemPendente:0,prenhesTotal:0}),[R,k]=d.useState({total:0,porStatus:[]}),[S,E]=d.useState({total:0,porRaca:[],oocitos30d:0,aspiracoes30d:0}),[M,C]=d.useState([]);d.useEffect(()=>{r&&$()},[r]);const $=async()=>{var i,v;try{m(!0);const[N,c]=await Promise.all([g.from("fazendas").select("*, cliente:clientes(nome)").eq("id",r).single(),g.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",r)]);if(N.error)throw N.error;const y=N.data;j(y),h(((i=y.cliente)==null?void 0:i.nome)||"");const A=((v=c.data)==null?void 0:v.map(p=>p.receptora_id))||[],[o,f,D,O,T]=await Promise.all([g.from("protocolos_sincronizacao").select("id, status").eq("fazenda_id",r).in("status",["PASSO1_FECHADO","PRIMEIRO_PASSO_FECHADO","SINCRONIZADO"]),A.length>0?g.from("receptoras").select("id, status_reprodutivo, data_provavel_parto").in("id",A):Promise.resolve({data:[],error:null}),g.from("doadoras").select("id, raca").eq("fazenda_id",r),g.from("aspiracoes_doadoras").select("id, total_oocitos").eq("fazenda_id",r).gte("data_aspiracao",new Date(Date.now()-30*24*60*60*1e3).toISOString().split("T")[0]),g.from("animais").select(`
            id, data_nascimento, sexo, raca, pai_nome, mae_nome,
            receptora:receptoras(identificacao),
            embriao:embrioes(
              lote_fiv_acasalamento:lote_fiv_acasalamentos(
                aspiracao:aspiracoes_doadoras(doadora:doadoras(registro)),
                dose:doses_semen(touro:touros(nome))
              )
            )
          `).eq("fazenda_id",r).order("data_nascimento",{ascending:!1}).limit(50)]),W=o.data||[],ae=W.filter(p=>p.status==="PASSO1_FECHADO"||p.status==="PRIMEIRO_PASSO_FECHADO").length,X=W.filter(p=>p.status==="SINCRONIZADO").length,Q=f.data||[],ee=new Map;let ie=0,se;Q.forEach(p=>{const z=p.status_reprodutivo||"VAZIA";ee.set(z,(ee.get(z)||0)+1),z.includes("PRENHE")&&(ie++,p.data_provavel_parto&&(!se||p.data_provavel_parto<se)&&(se=p.data_provavel_parto))}),k({total:Q.length,porStatus:Array.from(ee.entries()).map(([p,z])=>({status:p,total:z})).sort((p,z)=>z.total-p.total)});let b=0,U=0;if(A.length>0){const[p,z]=await Promise.all([g.from("transferencias_embrioes").select("receptora_id").in("receptora_id",A).eq("status_te","REALIZADA"),g.from("diagnosticos_gestacao").select("receptora_id, tipo_diagnostico").in("receptora_id",A)]),ue=new Set((p.data||[]).map(u=>u.receptora_id)),ne=new Set((z.data||[]).filter(u=>u.tipo_diagnostico==="DG").map(u=>u.receptora_id)),ce=new Set((z.data||[]).filter(u=>u.tipo_diagnostico==="SEXAGEM").map(u=>u.receptora_id));b=[...ue].filter(u=>!ne.has(u)).length,U=Q.filter(u=>(u.status_reprodutivo||"").includes("PRENHE")&&ne.has(u.id)).filter(u=>!ce.has(u.id)).length}P({passo2Pendente:ae,tePendente:X,dgPendente:b,sexagemPendente:U,prenhesTotal:ie,prenhesProximoParto:se});const K=D.data||[],B=new Map;K.forEach(p=>{const z=p.raca||"Sem raça";B.set(z,(B.get(z)||0)+1)});const V=O.data||[],q=V.reduce((p,z)=>p+(z.total_oocitos||0),0);E({total:K.length,porRaca:Array.from(B.entries()).map(([p,z])=>({raca:p,total:z})).sort((p,z)=>z.total-p.total),oocitos30d:q,aspiracoes30d:V.length});const Ae=(T.data||[]).map(p=>{var ce,he,u,Oe,Be,Le;const z=(ce=p.embriao)==null?void 0:ce.lote_fiv_acasalamento,ue=(u=(he=z==null?void 0:z.aspiracao)==null?void 0:he.doadora)==null?void 0:u.registro,ne=(Be=(Oe=z==null?void 0:z.dose)==null?void 0:Oe.touro)==null?void 0:Be.nome;return{id:p.id,data_nascimento:p.data_nascimento,sexo:p.sexo,raca:p.raca,receptora_brinco:(Le=p.receptora)==null?void 0:Le.identificacao,doadora:ue||p.mae_nome||null,touro:ne||p.pai_nome||null}});C(Ae)}catch(N){a({title:"Erro ao carregar dados",description:N instanceof Error?N.message:"Erro desconhecido",variant:"destructive"})}finally{m(!1)}},H=()=>{l&&(l.latitude&&l.longitude?window.open(sa(l.latitude,l.longitude),"_blank"):l.localizacao&&window.open(ta(l.localizacao),"_blank"))},_=i=>i?new Date(i).toLocaleDateString("pt-BR"):"-",w=n.passo2Pendente+n.tePendente+n.dgPendente+n.sexagemPendente;return s?e.jsx(Qe,{}):l?e.jsxs("div",{className:"space-y-6",children:[e.jsx(ia,{title:l.nome,description:`Cliente: ${x}`,actions:e.jsx(L,{variant:"outline",size:"icon",onClick:()=>t("/fazendas"),children:e.jsx(wa,{className:"w-4 h-4"})})}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[l.sigla&&e.jsx(Z,{children:e.jsxs(J,{className:"pt-4 flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-muted rounded-lg",children:e.jsx(za,{className:"w-4 h-4 text-muted-foreground"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Sigla"}),e.jsx("p",{className:"font-semibold",children:l.sigla})]})]})}),l.localizacao&&e.jsx(Z,{className:"cursor-pointer hover:bg-secondary",onClick:H,children:e.jsxs(J,{className:"pt-4 flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-green-100 rounded-lg",children:e.jsx(ba,{className:"w-4 h-4 text-primary"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Localização"}),e.jsx("p",{className:"font-medium truncate",children:l.localizacao})]}),e.jsx(aa,{className:"w-4 h-4 text-muted-foreground"})]})}),l.responsavel&&e.jsx(Z,{children:e.jsxs(J,{className:"pt-4 flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:e.jsx(Sa,{className:"w-4 h-4 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Responsável"}),e.jsx("p",{className:"font-medium",children:l.responsavel})]})]})}),l.contato_responsavel&&e.jsx(Z,{children:e.jsxs(J,{className:"pt-4 flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-purple-100 rounded-lg",children:e.jsx(ya,{className:"w-4 h-4 text-purple-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Contato"}),e.jsx("p",{className:"font-medium",children:l.contato_responsavel})]})]})})]}),e.jsxs(ra,{defaultValue:"resumo",className:"space-y-4",children:[e.jsxs(oa,{className:"grid w-full grid-cols-4",children:[e.jsxs(we,{value:"resumo",className:"flex items-center gap-2",children:[e.jsx($e,{className:"w-4 h-4"}),"Resumo",w>0&&e.jsx(G,{variant:"destructive",className:"ml-1 h-5 w-5 p-0 flex items-center justify-center text-xs",children:w})]}),e.jsxs(we,{value:"receptoras",className:"flex items-center gap-2",children:[e.jsx(He,{className:"w-4 h-4"}),"Receptoras",e.jsx(G,{variant:"secondary",className:"ml-1",children:R.total})]}),e.jsxs(we,{value:"doadoras",className:"flex items-center gap-2",children:[e.jsx(Ke,{className:"w-4 h-4"}),"Doadoras",e.jsx(G,{variant:"secondary",className:"ml-1",children:S.total})]}),e.jsxs(we,{value:"animais",className:"flex items-center gap-2",children:[e.jsx(Fe,{className:"w-4 h-4"}),"Nascimentos",e.jsx(G,{variant:"secondary",className:"ml-1",children:M.length})]})]}),e.jsxs(be,{value:"resumo",className:"space-y-4",children:[w>0&&e.jsxs(Z,{className:"border-amber-200 bg-amber-50",children:[e.jsx(de,{className:"pb-2",children:e.jsxs(me,{className:"text-base flex items-center gap-2 text-amber-800",children:[e.jsx(Ea,{className:"w-4 h-4"}),"Serviços Pendentes"]})}),e.jsx(J,{children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:[n.passo2Pendente>0&&e.jsxs(_e,{to:"/protocolos",className:"flex items-center justify-between p-3 bg-white rounded-lg border hover:border-green-300 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Da,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm",children:"2º Passo"})]}),e.jsx(G,{children:n.passo2Pendente})]}),n.tePendente>0&&e.jsxs(_e,{to:"/transferencia",className:"flex items-center justify-between p-3 bg-white rounded-lg border hover:border-green-300 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ea,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm",children:"TE"})]}),e.jsx(G,{children:n.tePendente})]}),n.dgPendente>0&&e.jsxs(_e,{to:"/dg",className:"flex items-center justify-between p-3 bg-white rounded-lg border hover:border-green-300 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($e,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm",children:"DG"})]}),e.jsx(G,{children:n.dgPendente})]}),n.sexagemPendente>0&&e.jsxs(_e,{to:"/sexagem",className:"flex items-center justify-between p-3 bg-white rounded-lg border hover:border-green-300 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Fe,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm",children:"Sexagem"})]}),e.jsx(G,{children:n.sexagemPendente})]})]})})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs(Z,{children:[e.jsx(de,{className:"pb-2",children:e.jsxs(me,{className:"text-base flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(He,{className:"w-4 h-4"}),"Receptoras"]}),e.jsx("span",{className:"text-2xl font-bold",children:R.total})]})}),e.jsx(J,{children:R.porStatus.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Nenhuma receptora"}):e.jsxs("div",{className:"space-y-2",children:[R.porStatus.slice(0,5).map(i=>e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:qe(i.status)}),e.jsx(G,{variant:"outline",children:i.total})]},i.status)),n.prenhesProximoParto&&e.jsxs("div",{className:"pt-2 mt-2 border-t text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Próximo parto: "}),e.jsx("span",{className:"font-medium",children:_(n.prenhesProximoParto)})]})]})})]}),e.jsxs(Z,{children:[e.jsx(de,{className:"pb-2",children:e.jsxs(me,{className:"text-base flex items-center justify-between",children:[e.jsx("span",{children:"Doadoras"}),e.jsx("span",{className:"text-2xl font-bold",children:S.total})]})}),e.jsx(J,{children:S.total===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Nenhuma doadora"}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{className:"p-2 bg-secondary rounded",children:[e.jsx("p",{className:"text-muted-foreground",children:"Aspirações (30d)"}),e.jsx("p",{className:"font-semibold",children:S.aspiracoes30d})]}),e.jsxs("div",{className:"p-2 bg-secondary rounded",children:[e.jsx("p",{className:"text-muted-foreground",children:"Oócitos (30d)"}),e.jsx("p",{className:"font-semibold",children:S.oocitos30d})]})]}),S.porRaca.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1",children:S.porRaca.slice(0,4).map(i=>e.jsxs(G,{variant:"secondary",className:"text-xs",children:[i.raca,": ",i.total]},i.raca))})]})})]})]})]}),e.jsx(be,{value:"receptoras",children:e.jsx(Qa,{fazendaId:r,fazendaNome:l.nome})}),e.jsx(be,{value:"doadoras",children:e.jsx(es,{fazendaId:r,fazendaNome:l.nome})}),e.jsx(be,{value:"animais",children:e.jsxs(Z,{children:[e.jsx(de,{children:e.jsx(me,{className:"text-base",children:"Animais Nascidos"})}),e.jsx(J,{children:M.length===0?e.jsx(ye,{title:"Nenhum animal registrado",description:"Os nascimentos registrados aparecerão aqui."}):e.jsxs(De,{children:[e.jsx(Ce,{children:e.jsxs(oe,{children:[e.jsx(F,{children:"Data"}),e.jsx(F,{children:"Sexo"}),e.jsx(F,{children:"Raça"}),e.jsx(F,{children:"Receptora"}),e.jsx(F,{children:"Doadora x Touro"})]})}),e.jsx(Ee,{children:M.map(i=>e.jsxs(oe,{children:[e.jsx(I,{children:_(i.data_nascimento)}),e.jsx(I,{children:e.jsx(G,{variant:i.sexo==="FEMEA"?"default":"secondary",children:i.sexo==="FEMEA"?"F":i.sexo==="MACHO"?"M":"?"})}),e.jsx(I,{children:i.raca||"-"}),e.jsx(I,{children:i.receptora_brinco||"-"}),e.jsxs(I,{className:"text-sm",children:[i.doadora||"?"," x ",i.touro||"?"]})]},i.id))})]})})]})})]})]}):e.jsx(ye,{title:"Fazenda não encontrada",description:"Volte para a lista e selecione outra fazenda.",action:e.jsx(L,{onClick:()=>t("/fazendas"),variant:"outline",children:"Voltar"})})}export{Bs as default};
