import{d as ce,r as n,s as l,j as e,h as de,B as S,U as k,a6 as R}from"./index-6OJhfjKP.js";import{C as _,d as N,a as me,b as ue}from"./card-D-gf0lmS.js";import{T as he,a as pe,b as G,c as x,d as xe,e as f}from"./table-B_Z-CztY.js";import{D as fe,b as je,c as ge,d as ve,e as _e}from"./dialog-CFjhGf-B.js";import{S as L,a as q,b as F,c as H,d as u}from"./select-B7v4ZPbC.js";import{I as O}from"./input-_UHZ9n1P.js";import{L as j}from"./label-BTrzYRkl.js";import{C as Ne}from"./checkbox-De4S9Zn8.js";import{B as E}from"./badge-ChTtRB_d.js";import{S as J}from"./switch-BFbS250T.js";import{P as be}from"./PageHeader-P7sO2uqv.js";import{E as W}from"./EmptyState-CEfkJzHC.js";import{u as ye}from"./use-toast-DasFaehQ.js";import{P as we}from"./plus-Dnfaq_2C.js";import{S as Ce}from"./search-DHWddfjN.js";import{S as Se}from"./square-pen-CDisL43u.js";import"./index-CtR1jODk.js";import"./x-kO07YPaG.js";import"./check-CgmfRmMI.js";function Ge(){const{toast:d}=ye(),{permissions:T}=ce(),[K,B]=n.useState(!0),[g,Q]=n.useState([]),[X,Y]=n.useState([]),[Z,ee]=n.useState([]),[v,se]=n.useState(""),[b,re]=n.useState("todos"),[ie,y]=n.useState(!1),[t,z]=n.useState(null),[I,V]=n.useState(!1),[r,m]=n.useState({nome:"",email:"",user_type:"operacional",cliente_id:"",active:!0,hub_permissions:[]}),U=T==null?void 0:T.isAdmin;n.useEffect(()=>{U&&D()},[U]);const D=async()=>{try{B(!0);const{data:s,error:i}=await l.from("hubs").select("*").order("display_order");if(i)throw i;Y(s||[]);const{data:a,error:o}=await l.from("clientes").select("id, nome").order("nome");if(o)throw o;ee(a||[]);const{data:c,error:h}=await l.from("user_profiles").select("*").order("nome");if(h)throw h;const{data:w,error:C}=await l.from("user_hub_permissions").select("user_id, hub_code").eq("can_access",!0);if(C)throw C;const P=new Map;(w||[]).forEach(p=>{const M=P.get(p.user_id)||[];M.push(p.hub_code),P.set(p.user_id,M)});const le=(c||[]).map(p=>({...p,hub_permissions:P.get(p.id)||[]}));Q(le)}catch(s){d({title:"Erro ao carregar dados",description:s instanceof Error?s.message:"Erro desconhecido",variant:"destructive"})}finally{B(!1)}},A=g.filter(s=>{var o,c;const i=!v||((o=s.nome)==null?void 0:o.toLowerCase().includes(v.toLowerCase()))||((c=s.email)==null?void 0:c.toLowerCase().includes(v.toLowerCase())),a=b==="todos"||s.user_type===b;return i&&a}),$=s=>{s?(z(s),m({nome:s.nome||"",email:s.email||"",user_type:s.user_type,cliente_id:s.cliente_id||"",active:s.active,hub_permissions:s.hub_permissions})):(z(null),m({nome:"",email:"",user_type:"operacional",cliente_id:"",active:!0,hub_permissions:[]})),y(!0)},ae=s=>{m(i=>{const a=i.hub_permissions;return a.includes(s)?{...i,hub_permissions:a.filter(o=>o!==s)}:{...i,hub_permissions:[...a,s]}})},te=async s=>{if(s.preventDefault(),!r.nome.trim()||!r.email.trim()){d({title:"Erro de validação",description:"Nome e email são obrigatórios",variant:"destructive"});return}if(r.user_type==="cliente"&&!r.cliente_id){d({title:"Erro de validação",description:"Selecione um cliente para usuários do tipo Cliente",variant:"destructive"});return}try{if(V(!0),t){const{error:i}=await l.from("user_profiles").update({nome:r.nome,user_type:r.user_type,cliente_id:r.user_type==="cliente"?r.cliente_id:null,active:r.active}).eq("id",t.id);if(i)throw i;const{error:a}=await l.from("user_hub_permissions").delete().eq("user_id",t.id);if(a)throw a;if(r.hub_permissions.length>0&&r.user_type!=="admin"){const o=r.hub_permissions.map(h=>({user_id:t.id,hub_code:h,can_access:!0})),{error:c}=await l.from("user_hub_permissions").insert(o);if(c)throw c}d({title:"Usuário atualizado",description:"Perfil e permissões atualizados com sucesso"})}else{const{data:i,error:a}=await l.from("user_profiles").select("id").eq("email",r.email.toLowerCase()).maybeSingle();if(a)throw a;if(i){d({title:"Usuário já existe",description:"Já existe um perfil para este email. Use a opção de editar.",variant:"destructive"});return}const{data:o,error:c}=await l.from("user_profiles").insert({nome:r.nome,email:r.email.toLowerCase(),user_type:r.user_type,cliente_id:r.user_type==="cliente"?r.cliente_id:null,active:r.active}).select().single();if(c)throw c;if(r.hub_permissions.length>0&&r.user_type!=="admin"){const h=r.hub_permissions.map(C=>({user_id:o.id,hub_code:C,can_access:!0})),{error:w}=await l.from("user_hub_permissions").insert(h);if(w)throw w}d({title:"Usuário criado",description:"Perfil criado. O usuário precisa fazer cadastro com este email."})}y(!1),D()}catch(i){d({title:"Erro ao salvar",description:i instanceof Error?i.message:"Erro desconhecido",variant:"destructive"})}finally{V(!1)}},oe=async s=>{try{const{error:i}=await l.from("user_profiles").update({active:!s.active}).eq("id",s.id);if(i)throw i;d({title:s.active?"Usuário desativado":"Usuário ativado",description:`${s.nome} foi ${s.active?"desativado":"ativado"}`}),D()}catch(i){d({title:"Erro ao atualizar",description:i instanceof Error?i.message:"Erro desconhecido",variant:"destructive"})}},ne=s=>{switch(s){case"admin":return e.jsx(E,{className:"bg-primary-subtle text-primary-subtle-foreground",children:"Admin"});case"cliente":return e.jsx(E,{className:"bg-secondary text-secondary-foreground",children:"Cliente"});default:return e.jsx(E,{variant:"outline",className:"text-muted-foreground",children:"Operacional"})}};return U?K?e.jsx(de,{}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(be,{title:"Administração de Usuários",description:"Gerencie perfis e permissões de acesso",actions:e.jsxs(S,{onClick:()=>$(),children:[e.jsx(we,{className:"w-4 h-4 mr-2"}),"Novo Usuário"]})}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(_,{children:e.jsx(N,{className:"pt-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(k,{className:"w-5 h-5 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total"}),e.jsx("p",{className:"text-2xl font-bold",children:g.length})]})]})})}),e.jsx(_,{children:e.jsx(N,{className:"pt-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(R,{className:"w-5 h-5 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Admins"}),e.jsx("p",{className:"text-2xl font-bold",children:g.filter(s=>s.user_type==="admin").length})]})]})})}),e.jsx(_,{children:e.jsx(N,{className:"pt-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(k,{className:"w-5 h-5 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Operacionais"}),e.jsx("p",{className:"text-2xl font-bold",children:g.filter(s=>s.user_type==="operacional").length})]})]})})}),e.jsx(_,{children:e.jsx(N,{className:"pt-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(k,{className:"w-5 h-5 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Clientes"}),e.jsx("p",{className:"text-2xl font-bold",children:g.filter(s=>s.user_type==="cliente").length})]})]})})})]}),e.jsxs("div",{className:"flex flex-wrap gap-4 items-center",children:[e.jsxs("div",{className:"relative flex-1 min-w-[200px] max-w-xs",children:[e.jsx(Ce,{className:"absolute left-2 top-2.5 h-4 w-4 text-muted-foreground"}),e.jsx(O,{placeholder:"Buscar por nome ou email...",value:v,onChange:s=>se(s.target.value),className:"pl-8"})]}),e.jsxs(L,{value:b,onValueChange:re,children:[e.jsx(q,{className:"w-[150px]",children:e.jsx(F,{placeholder:"Tipo"})}),e.jsxs(H,{children:[e.jsx(u,{value:"todos",children:"Todos"}),e.jsx(u,{value:"admin",children:"Admin"}),e.jsx(u,{value:"operacional",children:"Operacional"}),e.jsx(u,{value:"cliente",children:"Cliente"})]})]})]}),e.jsxs(_,{children:[e.jsx(me,{children:e.jsxs(ue,{children:["Usuários (",A.length,")"]})}),e.jsx(N,{children:A.length===0?e.jsx(W,{title:"Nenhum usuário encontrado",description:v||b!=="todos"?"Tente ajustar os filtros":"Cadastre o primeiro usuário"}):e.jsxs(he,{children:[e.jsx(pe,{children:e.jsxs(G,{children:[e.jsx(x,{children:"Nome"}),e.jsx(x,{children:"Email"}),e.jsx(x,{children:"Tipo"}),e.jsx(x,{children:"Hubs"}),e.jsx(x,{children:"Ativo"}),e.jsx(x,{className:"text-right",children:"Ações"})]})}),e.jsx(xe,{children:A.map(s=>e.jsxs(G,{className:s.active?"":"opacity-50",children:[e.jsx(f,{className:"font-medium",children:s.nome||"-"}),e.jsx(f,{children:s.email}),e.jsx(f,{children:ne(s.user_type)}),e.jsx(f,{children:s.user_type==="admin"?e.jsx("span",{className:"text-primary text-sm font-medium",children:"Acesso total"}):s.hub_permissions.length>0?e.jsx("div",{className:"flex flex-wrap gap-1",children:s.hub_permissions.map(i=>e.jsx(E,{variant:"outline",className:"text-xs",children:i},i))}):e.jsx("span",{className:"text-muted-foreground text-sm",children:"Nenhum"})}),e.jsx(f,{children:e.jsx(J,{checked:s.active,onCheckedChange:()=>oe(s)})}),e.jsx(f,{className:"text-right",children:e.jsxs(S,{variant:"ghost",size:"sm",onClick:()=>$(s),children:[e.jsx(Se,{className:"w-4 h-4 mr-1"}),"Editar"]})})]},s.id))})]})})]}),e.jsx(fe,{open:ie,onOpenChange:y,children:e.jsxs(je,{className:"max-w-lg",children:[e.jsxs(ge,{children:[e.jsx(ve,{children:t?"Editar Usuário":"Novo Usuário"}),e.jsx(_e,{children:t?`Editando ${t.nome||t.email}`:"Preencha os dados do novo usuário"})]}),e.jsxs("form",{onSubmit:te,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"nome",children:"Nome *"}),e.jsx(O,{id:"nome",value:r.nome,onChange:s=>m({...r,nome:s.target.value}),placeholder:"Nome completo",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"email",children:"Email *"}),e.jsx(O,{id:"email",type:"email",value:r.email,onChange:s=>m({...r,email:s.target.value}),placeholder:"email@exemplo.com",required:!0,disabled:!!t}),!t&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"O usuário precisará fazer cadastro com este email"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"user_type",children:"Tipo de Usuário *"}),e.jsxs(L,{value:r.user_type,onValueChange:s=>m({...r,user_type:s}),children:[e.jsx(q,{children:e.jsx(F,{})}),e.jsxs(H,{children:[e.jsx(u,{value:"admin",children:"Admin (acesso total)"}),e.jsx(u,{value:"operacional",children:"Operacional"}),e.jsx(u,{value:"cliente",children:"Cliente"})]})]})]}),r.user_type==="cliente"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"cliente_id",children:"Cliente Vinculado *"}),e.jsxs(L,{value:r.cliente_id,onValueChange:s=>m({...r,cliente_id:s}),children:[e.jsx(q,{children:e.jsx(F,{placeholder:"Selecione o cliente"})}),e.jsx(H,{children:Z.map(s=>e.jsx(u,{value:s.id,children:s.nome},s.id))})]})]}),r.user_type!=="admin"&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs(j,{className:"flex items-center gap-2",children:[e.jsx(R,{className:"w-4 h-4"}),"Permissões de Acesso"]}),e.jsx("div",{className:"grid grid-cols-2 gap-3 p-3 border rounded-lg",children:X.map(s=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ne,{id:`hub-${s.code}`,checked:r.hub_permissions.includes(s.code),onCheckedChange:()=>ae(s.code)}),e.jsx("label",{htmlFor:`hub-${s.code}`,className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 cursor-pointer",children:s.name})]},s.id))}),r.hub_permissions.length===0&&e.jsx("p",{className:"text-xs text-amber-600",children:"Sem permissões, o usuário não terá acesso a nenhum hub"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(J,{id:"active",checked:r.active,onCheckedChange:s=>m({...r,active:s})}),e.jsx(j,{htmlFor:"active",children:"Usuário ativo"})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(S,{type:"submit",className:"flex-1",disabled:I,children:I?"Salvando...":t?"Salvar":"Criar Usuário"}),e.jsx(S,{type:"button",variant:"outline",onClick:()=>y(!1),children:"Cancelar"})]})]})]})})]}):e.jsx("div",{className:"space-y-6",children:e.jsx(W,{title:"Acesso negado",description:"Apenas administradores podem acessar esta página."})})}export{Ge as default};
