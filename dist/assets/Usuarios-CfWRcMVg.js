import{d as ne,r as n,s as l,j as e,h as le,B as S,U as ce,a6 as de}from"./index-TMaXuGT-.js";import{C as _,d as b,a as me,b as ue}from"./card-DMaHdbj2.js";import{T as he,a as pe,b as M,c as x,d as xe,e as j}from"./table-BcP2BpwR.js";import{D as je,b as fe,c as ge,d as ve,e as _e}from"./dialog-9Ry6kCpW.js";import{S as k,a as L,b as q,c as F,d as u}from"./select-mKWZhFeY.js";import{I as H}from"./input-CS01soKQ.js";import{L as f}from"./label-CDZKlFri.js";import{C as be}from"./checkbox-CBnFIxKh.js";import{B as E}from"./badge-CUxYsHH9.js";import{S as R}from"./switch-B_EUsKic.js";import{P as Ne}from"./PageHeader-B9IxJGm-.js";import{E as G}from"./EmptyState-BdHwPhgd.js";import{u as ye}from"./use-toast-BfiUt0Jw.js";import{P as we}from"./plus-BwrqBzf6.js";import{S as Ce}from"./search-FTckgCkA.js";import{S as Se}from"./square-pen-B8zVsYtp.js";import"./index-CbBZSCMq.js";import"./x-_4GU21wu.js";import"./index-CleRECL4.js";import"./check-BrBvYO5V.js";function Je(){const{toast:d}=ye(),{permissions:T}=ne(),[J,O]=n.useState(!0),[g,W]=n.useState([]),[K,Q]=n.useState([]),[X,Y]=n.useState([]),[v,Z]=n.useState(""),[N,ee]=n.useState("todos"),[se,y]=n.useState(!1),[t,B]=n.useState(null),[z,I]=n.useState(!1),[i,m]=n.useState({nome:"",email:"",user_type:"operacional",cliente_id:"",active:!0,hub_permissions:[]}),U=T==null?void 0:T.isAdmin;n.useEffect(()=>{U&&D()},[U]);const D=async()=>{try{O(!0);const{data:s,error:r}=await l.from("hubs").select("*").order("display_order");if(r)throw r;Q(s||[]);const{data:a,error:o}=await l.from("clientes").select("id, nome").order("nome");if(o)throw o;Y(a||[]);const{data:c,error:h}=await l.from("user_profiles").select("*").order("nome");if(h)throw h;const{data:w,error:C}=await l.from("user_hub_permissions").select("user_id, hub_code").eq("can_access",!0);if(C)throw C;const P=new Map;(w||[]).forEach(p=>{const $=P.get(p.user_id)||[];$.push(p.hub_code),P.set(p.user_id,$)});const oe=(c||[]).map(p=>({...p,hub_permissions:P.get(p.id)||[]}));W(oe)}catch(s){d({title:"Erro ao carregar dados",description:s instanceof Error?s.message:"Erro desconhecido",variant:"destructive"})}finally{O(!1)}},A=g.filter(s=>{var o,c;const r=!v||((o=s.nome)==null?void 0:o.toLowerCase().includes(v.toLowerCase()))||((c=s.email)==null?void 0:c.toLowerCase().includes(v.toLowerCase())),a=N==="todos"||s.user_type===N;return r&&a}),V=s=>{s?(B(s),m({nome:s.nome||"",email:s.email||"",user_type:s.user_type,cliente_id:s.cliente_id||"",active:s.active,hub_permissions:s.hub_permissions})):(B(null),m({nome:"",email:"",user_type:"operacional",cliente_id:"",active:!0,hub_permissions:[]})),y(!0)},ie=s=>{m(r=>{const a=r.hub_permissions;return a.includes(s)?{...r,hub_permissions:a.filter(o=>o!==s)}:{...r,hub_permissions:[...a,s]}})},re=async s=>{if(s.preventDefault(),!i.nome.trim()||!i.email.trim()){d({title:"Erro de validação",description:"Nome e email são obrigatórios",variant:"destructive"});return}if(i.user_type==="cliente"&&!i.cliente_id){d({title:"Erro de validação",description:"Selecione um cliente para usuários do tipo Cliente",variant:"destructive"});return}try{if(I(!0),t){const{error:r}=await l.from("user_profiles").update({nome:i.nome,user_type:i.user_type,cliente_id:i.user_type==="cliente"?i.cliente_id:null,active:i.active}).eq("id",t.id);if(r)throw r;const{error:a}=await l.from("user_hub_permissions").delete().eq("user_id",t.id);if(a)throw a;if(i.hub_permissions.length>0&&i.user_type!=="admin"){const o=i.hub_permissions.map(h=>({user_id:t.id,hub_code:h,can_access:!0})),{error:c}=await l.from("user_hub_permissions").insert(o);if(c)throw c}d({title:"Usuário atualizado",description:"Perfil e permissões atualizados com sucesso"})}else{const{data:r,error:a}=await l.from("user_profiles").select("id").eq("email",i.email.toLowerCase()).maybeSingle();if(a)throw a;if(r){d({title:"Usuário já existe",description:"Já existe um perfil para este email. Use a opção de editar.",variant:"destructive"});return}const{data:o,error:c}=await l.from("user_profiles").insert({nome:i.nome,email:i.email.toLowerCase(),user_type:i.user_type,cliente_id:i.user_type==="cliente"?i.cliente_id:null,active:i.active}).select().single();if(c)throw c;if(i.hub_permissions.length>0&&i.user_type!=="admin"){const h=i.hub_permissions.map(C=>({user_id:o.id,hub_code:C,can_access:!0})),{error:w}=await l.from("user_hub_permissions").insert(h);if(w)throw w}d({title:"Usuário criado",description:"Perfil criado. O usuário precisa fazer cadastro com este email."})}y(!1),D()}catch(r){d({title:"Erro ao salvar",description:r instanceof Error?r.message:"Erro desconhecido",variant:"destructive"})}finally{I(!1)}},ae=async s=>{try{const{error:r}=await l.from("user_profiles").update({active:!s.active}).eq("id",s.id);if(r)throw r;d({title:s.active?"Usuário desativado":"Usuário ativado",description:`${s.nome} foi ${s.active?"desativado":"ativado"}`}),D()}catch(r){d({title:"Erro ao atualizar",description:r instanceof Error?r.message:"Erro desconhecido",variant:"destructive"})}},te=s=>{switch(s){case"admin":return e.jsx(E,{className:"bg-purple-100 text-purple-800",children:"Admin"});case"cliente":return e.jsx(E,{className:"bg-blue-100 text-blue-800",children:"Cliente"});default:return e.jsx(E,{className:"bg-gray-100 text-gray-800",children:"Operacional"})}};return U?J?e.jsx(le,{}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(Ne,{title:"Administração de Usuários",description:"Gerencie perfis e permissões de acesso",actions:e.jsxs(S,{onClick:()=>V(),children:[e.jsx(we,{className:"w-4 h-4 mr-2"}),"Novo Usuário"]})}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(_,{children:e.jsx(b,{className:"pt-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ce,{className:"w-5 h-5 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total"}),e.jsx("p",{className:"text-2xl font-bold",children:g.length})]})]})})}),e.jsx(_,{children:e.jsxs(b,{className:"pt-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Admins"}),e.jsx("p",{className:"text-2xl font-bold",children:g.filter(s=>s.user_type==="admin").length})]})}),e.jsx(_,{children:e.jsxs(b,{className:"pt-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Operacionais"}),e.jsx("p",{className:"text-2xl font-bold",children:g.filter(s=>s.user_type==="operacional").length})]})}),e.jsx(_,{children:e.jsxs(b,{className:"pt-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Clientes"}),e.jsx("p",{className:"text-2xl font-bold",children:g.filter(s=>s.user_type==="cliente").length})]})})]}),e.jsxs("div",{className:"flex flex-wrap gap-4 items-center",children:[e.jsxs("div",{className:"relative flex-1 min-w-[200px] max-w-xs",children:[e.jsx(Ce,{className:"absolute left-2 top-2.5 h-4 w-4 text-muted-foreground"}),e.jsx(H,{placeholder:"Buscar por nome ou email...",value:v,onChange:s=>Z(s.target.value),className:"pl-8"})]}),e.jsxs(k,{value:N,onValueChange:ee,children:[e.jsx(L,{className:"w-[150px]",children:e.jsx(q,{placeholder:"Tipo"})}),e.jsxs(F,{children:[e.jsx(u,{value:"todos",children:"Todos"}),e.jsx(u,{value:"admin",children:"Admin"}),e.jsx(u,{value:"operacional",children:"Operacional"}),e.jsx(u,{value:"cliente",children:"Cliente"})]})]})]}),e.jsxs(_,{children:[e.jsx(me,{children:e.jsxs(ue,{children:["Usuários (",A.length,")"]})}),e.jsx(b,{children:A.length===0?e.jsx(G,{title:"Nenhum usuário encontrado",description:v||N!=="todos"?"Tente ajustar os filtros":"Cadastre o primeiro usuário"}):e.jsxs(he,{children:[e.jsx(pe,{children:e.jsxs(M,{children:[e.jsx(x,{children:"Nome"}),e.jsx(x,{children:"Email"}),e.jsx(x,{children:"Tipo"}),e.jsx(x,{children:"Hubs"}),e.jsx(x,{children:"Ativo"}),e.jsx(x,{className:"text-right",children:"Ações"})]})}),e.jsx(xe,{children:A.map(s=>e.jsxs(M,{className:s.active?"":"opacity-50",children:[e.jsx(j,{className:"font-medium",children:s.nome||"-"}),e.jsx(j,{children:s.email}),e.jsx(j,{children:te(s.user_type)}),e.jsx(j,{children:s.user_type==="admin"?e.jsx("span",{className:"text-purple-600 text-sm",children:"Acesso total"}):s.hub_permissions.length>0?e.jsx("div",{className:"flex flex-wrap gap-1",children:s.hub_permissions.map(r=>e.jsx(E,{variant:"outline",className:"text-xs",children:r},r))}):e.jsx("span",{className:"text-muted-foreground text-sm",children:"Nenhum"})}),e.jsx(j,{children:e.jsx(R,{checked:s.active,onCheckedChange:()=>ae(s)})}),e.jsx(j,{className:"text-right",children:e.jsxs(S,{variant:"ghost",size:"sm",onClick:()=>V(s),children:[e.jsx(Se,{className:"w-4 h-4 mr-1"}),"Editar"]})})]},s.id))})]})})]}),e.jsx(je,{open:se,onOpenChange:y,children:e.jsxs(fe,{className:"max-w-lg",children:[e.jsxs(ge,{children:[e.jsx(ve,{children:t?"Editar Usuário":"Novo Usuário"}),e.jsx(_e,{children:t?`Editando ${t.nome||t.email}`:"Preencha os dados do novo usuário"})]}),e.jsxs("form",{onSubmit:re,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"nome",children:"Nome *"}),e.jsx(H,{id:"nome",value:i.nome,onChange:s=>m({...i,nome:s.target.value}),placeholder:"Nome completo",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"email",children:"Email *"}),e.jsx(H,{id:"email",type:"email",value:i.email,onChange:s=>m({...i,email:s.target.value}),placeholder:"email@exemplo.com",required:!0,disabled:!!t}),!t&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"O usuário precisará fazer cadastro com este email"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"user_type",children:"Tipo de Usuário *"}),e.jsxs(k,{value:i.user_type,onValueChange:s=>m({...i,user_type:s}),children:[e.jsx(L,{children:e.jsx(q,{})}),e.jsxs(F,{children:[e.jsx(u,{value:"admin",children:"Admin (acesso total)"}),e.jsx(u,{value:"operacional",children:"Operacional"}),e.jsx(u,{value:"cliente",children:"Cliente"})]})]})]}),i.user_type==="cliente"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"cliente_id",children:"Cliente Vinculado *"}),e.jsxs(k,{value:i.cliente_id,onValueChange:s=>m({...i,cliente_id:s}),children:[e.jsx(L,{children:e.jsx(q,{placeholder:"Selecione o cliente"})}),e.jsx(F,{children:X.map(s=>e.jsx(u,{value:s.id,children:s.nome},s.id))})]})]}),i.user_type!=="admin"&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs(f,{className:"flex items-center gap-2",children:[e.jsx(de,{className:"w-4 h-4"}),"Permissões de Acesso"]}),e.jsx("div",{className:"grid grid-cols-2 gap-3 p-3 border rounded-lg",children:K.map(s=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(be,{id:`hub-${s.code}`,checked:i.hub_permissions.includes(s.code),onCheckedChange:()=>ie(s.code)}),e.jsx("label",{htmlFor:`hub-${s.code}`,className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 cursor-pointer",children:s.name})]},s.id))}),i.hub_permissions.length===0&&e.jsx("p",{className:"text-xs text-amber-600",children:"Sem permissões, o usuário não terá acesso a nenhum hub"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(R,{id:"active",checked:i.active,onCheckedChange:s=>m({...i,active:s})}),e.jsx(f,{htmlFor:"active",children:"Usuário ativo"})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(S,{type:"submit",className:"flex-1",disabled:z,children:z?"Salvando...":t?"Salvar":"Criar Usuário"}),e.jsx(S,{type:"button",variant:"outline",onClick:()=>y(!1),children:"Cancelar"})]})]})]})})]}):e.jsx("div",{className:"space-y-6",children:e.jsx(G,{title:"Acesso negado",description:"Apenas administradores podem acessar esta página."})})}export{Je as default};
