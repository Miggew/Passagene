import{j as e,a as Z,r as n,s as w,i as G,h as K,B as V}from"./index-TMaXuGT-.js";import{C as z,a as O,b as L,d as B}from"./card-DMaHdbj2.js";import{E as X}from"./EmptyState-BdHwPhgd.js";import{P as U,a as ee,b as ae,C as se}from"./ConfirmExitDialog-BKCLuD3f.js";import{L as $}from"./label-CDZKlFri.js";import{I as W}from"./input-CS01soKQ.js";import{D as te}from"./DatePickerBR-CA4qskvz.js";import{B as oe}from"./badge-CUxYsHH9.js";import{C as J}from"./checkbox-CBnFIxKh.js";import{T as re,a as ie,b as H,c as q,d as ne,e as R}from"./table-BcP2BpwR.js";import{C as ce,Q as le}from"./QualidadeSemaforo-DkL0c3kE.js";import{u as Y}from"./use-toast-BfiUt0Jw.js";import{L as de}from"./lock-BkPpUXrw.js";import"./arrow-left-BZEOW66l.js";import"./x-_4GU21wu.js";import"./dateUtils-eJ5e6apA.js";import"./dialog-9Ry6kCpW.js";import"./index-CbBZSCMq.js";import"./circle-check-big-3OdUs8RJ.js";import"./alert-dialog-Duzdx643.js";import"./chevron-right-BwBsAfCk.js";import"./popover-C4Z9du6z.js";import"./index-CleRECL4.js";import"./check-BrBvYO5V.js";function pe({pendentes:c,confirmadas:o,descartadas:t}){return e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs(z,{className:"border-slate-200",children:[e.jsx(O,{className:"pb-2",children:e.jsx(L,{className:"text-sm font-medium text-slate-500",children:"Aguardando"})}),e.jsx(B,{children:e.jsx("p",{className:"text-3xl font-bold text-slate-900",children:c})})]}),e.jsxs(z,{className:"border-green-200 bg-green-50/50",children:[e.jsx(O,{className:"pb-2",children:e.jsx(L,{className:"text-sm font-medium text-green-700",children:"Confirmadas"})}),e.jsx(B,{children:e.jsx("p",{className:"text-3xl font-bold text-green-600",children:o})})]}),e.jsxs(z,{className:"border-red-200 bg-red-50/50",children:[e.jsx(O,{className:"pb-2",children:e.jsx(L,{className:"text-sm font-medium text-red-700",children:"Descartadas"})}),e.jsx(B,{children:e.jsx("p",{className:"text-3xl font-bold text-red-600",children:t})})]})]})}function me({data:c,tecnico:o,onDataChange:t,onTecnicoChange:u}){return e.jsxs(z,{className:"border-blue-200 bg-blue-50/30",children:[e.jsx(O,{className:"pb-3",children:e.jsx(L,{className:"text-base text-blue-900",children:"Dados do 2º Passo"})}),e.jsx(B,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:"passo2_data",className:"text-blue-900",children:"Data de Realização *"}),e.jsx(te,{id:"passo2_data",value:c,onChange:_=>t(_||""),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:"passo2_tecnico",className:"text-blue-900",children:"Técnico Responsável *"}),e.jsx(W,{id:"passo2_tecnico",value:o,onChange:_=>u(_.target.value),placeholder:"Nome do técnico responsável",required:!0,className:"bg-white"})]})]})})]})}function ue({receptoras:c,motivosInapta:o,isFinalized:t,onStatusChange:u,onMotivoChange:_}){const h=a=>{const x={INICIADA:{label:"Aguardando",className:"bg-slate-100 text-slate-700 border-slate-200"},APTA:{label:"Confirmada",className:"bg-green-100 text-green-700 border-green-200"},INAPTA:{label:"Descartada",className:"bg-red-100 text-red-700 border-red-200"}}[a]||{label:a,className:""};return e.jsx(oe,{variant:"outline",className:x.className,children:x.label})};return e.jsxs(z,{children:[e.jsx(O,{className:"pb-3",children:e.jsxs(L,{className:"text-base",children:["Receptoras para Revisão (",c.length,")"]})}),e.jsx(B,{children:e.jsx("div",{className:"rounded-lg border overflow-hidden",children:e.jsxs(re,{children:[e.jsx(ie,{children:e.jsxs(H,{className:"bg-slate-50",children:[e.jsx(q,{className:"font-semibold",children:"Brinco"}),e.jsx(q,{className:"font-semibold",children:"Nome"}),e.jsx(q,{className:"font-semibold",children:"Ciclando"}),e.jsx(q,{className:"font-semibold",children:"Qualidade"}),e.jsx(q,{className:"font-semibold",children:"Avaliação"}),e.jsx(q,{className:"font-semibold",children:"Motivo (se INAPTA)"})]})}),e.jsx(ne,{children:c.length===0?e.jsx(H,{children:e.jsx(R,{colSpan:6,className:"text-center text-slate-500 py-8",children:"Nenhuma receptora no protocolo"})}):c.map(a=>e.jsxs(H,{className:"hover:bg-slate-50/50",children:[e.jsx(R,{className:"font-medium",children:a.identificacao}),e.jsx(R,{className:"text-slate-600",children:a.nome||"-"}),e.jsx(R,{children:e.jsx(ce,{value:a.pr_ciclando_classificacao,variant:"display",disabled:!0})}),e.jsx(R,{children:e.jsx(le,{value:a.pr_qualidade_semaforo,variant:"single",disabled:!0})}),e.jsx(R,{children:t?h(a.pr_status):e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(J,{id:`apta-${a.id}`,checked:a.pr_status==="APTA",onCheckedChange:f=>{f?u(a.id,"APTA"):u(a.id,"INICIADA")},className:"data-[state=checked]:bg-green-600 data-[state=checked]:border-green-600"}),e.jsx($,{htmlFor:`apta-${a.id}`,className:"text-sm font-medium cursor-pointer text-green-700",children:"APTA"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(J,{id:`inapta-${a.id}`,checked:a.pr_status==="INAPTA",onCheckedChange:f=>{f?u(a.id,"INAPTA"):u(a.id,"INICIADA")},className:"data-[state=checked]:bg-red-600 data-[state=checked]:border-red-600"}),e.jsx($,{htmlFor:`inapta-${a.id}`,className:"text-sm font-medium cursor-pointer text-red-700",children:"INAPTA"})]})]})}),e.jsx(R,{children:a.pr_status==="INAPTA"&&!t?e.jsx(W,{type:"text",placeholder:"Justificativa (opcional)",value:o[a.id]||a.pr_motivo_inapta||"",onChange:f=>_(a.id,f.target.value),className:"w-full max-w-[200px]"}):e.jsx("span",{className:"text-slate-500 text-sm",children:a.pr_motivo_inapta||"-"})})]},a.id))})]})})})]})}function he(){const c=Z(),{toast:o}=Y(),[t,u]=n.useState(!0),[_,h]=n.useState(null),[a,f]=n.useState(""),[x,s]=n.useState([]),I=n.useCallback(async d=>{try{const{data:p,error:b}=await w.from("protocolo_receptoras").select("*").eq("protocolo_id",d);if(b){o({title:"Erro ao carregar receptoras",description:b.message,variant:"destructive"}),s([]);return}if(!p||p.length===0){o({title:"Erro: Protocolo inconsistente",description:"Este protocolo não possui receptoras vinculadas.",variant:"destructive"}),s([]);return}const C=[];for(const i of p){const{data:N,error:l}=await w.from("receptoras").select("*").eq("id",i.receptora_id).single();l||C.push({...N,pr_id:i.id,pr_status:i.status,pr_motivo_inapta:i.motivo_inapta,pr_observacoes:i.observacoes,pr_ciclando_classificacao:"ciclando_classificacao"in i&&(i.ciclando_classificacao==="CL"||i.ciclando_classificacao==="N")?i.ciclando_classificacao:null,pr_qualidade_semaforo:"qualidade_semaforo"in i&&typeof i.qualidade_semaforo=="number"&&i.qualidade_semaforo>=1&&i.qualidade_semaforo<=3?i.qualidade_semaforo:null})}s(C)}catch(p){o({title:"Erro ao carregar receptoras",description:p instanceof Error?p.message:"Erro desconhecido",variant:"destructive"})}},[o]),D=n.useCallback(async d=>{try{u(!0);const{data:p,error:b}=await w.from("protocolos_sincronizacao").select("*").eq("id",d).single();if(b)throw b;if(p.status!=="PASSO1_FECHADO"&&p.status!=="PRIMEIRO_PASSO_FECHADO"&&p.status!=="SINCRONIZADO"){o({title:"Erro",description:"Este protocolo não está aguardando o 2º passo",variant:"destructive"}),c("/protocolos");return}h(p);const{data:C,error:i}=await w.from("fazendas").select("nome").eq("id",p.fazenda_id).single();if(i)throw i;f(C.nome),await I(d)}catch(p){o({title:"Erro ao carregar dados",description:p instanceof Error?p.message:"Erro desconhecido",variant:"destructive"})}finally{u(!1)}},[c,o,I]);return{loading:t,protocolo:_,setProtocolo:h,fazendaNome:a,receptoras:x,setReceptoras:s,loadData:D,loadReceptoras:I}}function fe({protocoloId:c,protocolo:o,receptoras:t,setReceptoras:u,setProtocolo:_,passo2Form:h,motivosInapta:a}){const f=Z(),{toast:x}=Y(),[s,I]=n.useState(!1),[D,d]=n.useState(!1),p=n.useCallback((N,l)=>{u(E=>E.map(g=>g.id===N?{...g,pr_status:l,pr_motivo_inapta:l==="APTA"||l==="INICIADA"?void 0:g.pr_motivo_inapta}:g))},[u]),b=n.useCallback((N,l)=>{u(E=>E.map(g=>g.id===N?{...g,pr_motivo_inapta:l.trim()||void 0}:g))},[u]),C=n.useCallback(async()=>{if(s)return;if(!h.data||!h.tecnico.trim()){x({title:"Erro de validação",description:"Data e técnico responsável são obrigatórios",variant:"destructive"});return}const N=t.filter(l=>l.pr_status==="INICIADA");if(N.length>0){x({title:"Erro",description:`Ainda há ${N.length} receptora(s) pendente(s) de revisão`,variant:"destructive"});return}if(t.length===0){x({title:"Erro",description:"Não é possível finalizar protocolo sem receptoras",variant:"destructive"});return}try{I(!0);const l=new Date,E=`${l.getFullYear()}-${String(l.getMonth()+1).padStart(2,"0")}-${String(l.getDate()).padStart(2,"0")}`,g=t.filter(v=>v.pr_status==="APTA"),S=t.filter(v=>v.pr_status==="INAPTA"),T=g.length>0?"SINCRONIZADO":"FECHADO",y=[...g.map(async v=>{const{error:j}=await w.from("protocolo_receptoras").update({status:"APTA",motivo_inapta:null}).eq("protocolo_id",c).eq("receptora_id",v.id);if(j)throw j}),...S.map(async v=>{const j=a[v.id]||v.pr_motivo_inapta||null,{error:M}=await w.from("protocolo_receptoras").update({status:"INAPTA",motivo_inapta:j}).eq("protocolo_id",c).eq("receptora_id",v.id);if(M)throw M})];await Promise.all(y);const{error:k}=await w.from("protocolos_sincronizacao").update({status:T,passo2_data:h.data,passo2_tecnico_responsavel:h.tecnico.trim(),data_retirada:E,responsavel_retirada:(o==null?void 0:o.responsavel_inicio)||null}).eq("id",c);if(k)throw k;_({...o,status:T,passo2_data:h.data,passo2_tecnico_responsavel:h.tecnico.trim(),data_retirada:E,responsavel_retirada:(o==null?void 0:o.responsavel_inicio)||null});const F=[...g.map(async v=>{const{error:j}=await w.from("receptoras").update({status_reprodutivo:"SINCRONIZADA"}).eq("id",v.id);if(j)throw j}),...S.map(async v=>{const{error:j}=await w.from("receptoras").update({status_reprodutivo:"VAZIA"}).eq("id",v.id);if(j)throw j})];await Promise.all(F),d(!0)}catch(l){x({title:"Erro ao finalizar 2º passo",description:l instanceof Error?l.message:"Erro desconhecido",variant:"destructive"})}finally{I(!1)}},[s,h,t,c,o,a,_,x]),i=n.useCallback(()=>{d(!1);const N=t.filter(l=>l.pr_status==="APTA").length;x({title:"2º passo concluído com sucesso",description:`${N} receptoras confirmadas para TE`}),f("/protocolos")},[t,f,x]);return{submitting:s,showResumo:D,setShowResumo:d,handleStatusChange:p,handleMotivoChange:b,handleFinalizarPasso2:C,handleCloseResumo:i}}function Me(){const{id:c}=G(),o=Z(),[t,u]=n.useState({data:new Date().toISOString().split("T")[0],tecnico:""}),[_,h]=n.useState({}),[a,f]=n.useState(!1),{loading:x,protocolo:s,setProtocolo:I,fazendaNome:D,receptoras:d,setReceptoras:p,loadData:b}=he(),{submitting:C,showResumo:i,handleStatusChange:N,handleMotivoChange:l,handleFinalizarPasso2:E,handleCloseResumo:g}=fe({protocoloId:c||"",protocolo:s,receptoras:d,setReceptoras:p,setProtocolo:I,passo2Form:t,motivosInapta:_}),S=n.useRef(!1),A=n.useMemo(()=>({pendentes:d.filter(r=>r.pr_status==="INICIADA").length,confirmadas:d.filter(r=>r.pr_status==="APTA").length,descartadas:d.filter(r=>r.pr_status==="INAPTA").length}),[d]),T=n.useMemo(()=>{const r=t.data&&t.tecnico.trim();return(A.pendentes>0||!r)&&(s==null?void 0:s.status)!=="SINCRONIZADO"},[A.pendentes,t,s]),y=(s==null?void 0:s.status)==="SINCRONIZADO";n.useEffect(()=>{c&&b(c)},[c,b]),n.useEffect(()=>{if(s){(s.passo2_data||s.passo2_tecnico_responsavel)&&u({data:s.passo2_data||new Date().toISOString().split("T")[0],tecnico:s.passo2_tecnico_responsavel||""});const r={};d.filter(m=>m.pr_status==="INAPTA"&&m.pr_motivo_inapta).forEach(m=>{r[m.id]=m.pr_motivo_inapta||""}),h(r)}},[s,d]),n.useEffect(()=>{if(!T){S.current=!1;return}S.current=!0;const r=P=>(P.preventDefault(),P.returnValue="Você tem receptoras pendentes de revisão. Deseja sair?",P.returnValue),m=P=>{T&&(P.preventDefault(),window.history.pushState(null,"",window.location.href),f(!0))};return window.history.pushState(null,"",window.location.href),window.addEventListener("beforeunload",r),window.addEventListener("popstate",m),()=>{window.removeEventListener("beforeunload",r),window.removeEventListener("popstate",m)}},[T]);const k=()=>{T?f(!0):(S.current=!1,o("/protocolos"))},F=()=>{f(!1),S.current=!1,o("/protocolos")},v=(r,m)=>{N(r,m),(m==="APTA"||m==="INICIADA")&&h(P=>{const Q={...P};return delete Q[r],Q})},j=(r,m)=>{l(r,m),h(P=>({...P,[r]:m.trim()}))};if(x)return e.jsx(K,{});if(!s)return e.jsx("div",{className:"space-y-6",children:e.jsx(X,{title:"Protocolo não encontrado",description:"Volte para a lista e selecione outro protocolo.",action:e.jsx(V,{onClick:()=>o("/protocolos"),variant:"outline",children:"Voltar para Protocolos"})})});if(d.length===0&&!x)return e.jsxs("div",{className:"space-y-6",children:[e.jsx(U,{currentStep:2,title:`2º Passo - ${D}`,subtitle:"Revisar e confirmar receptoras",onBack:k,showExit:!1}),e.jsxs(z,{className:"border-red-200 bg-red-50",children:[e.jsx(O,{children:e.jsx(L,{className:"text-red-700",children:"Protocolo Inconsistente"})}),e.jsxs(B,{className:"space-y-4",children:[e.jsx("p",{className:"text-red-800",children:"Este protocolo não possui receptoras vinculadas."}),e.jsx(V,{onClick:()=>o("/protocolos"),variant:"outline",children:"Voltar para Protocolos"})]})]})]});const M=A.pendentes===0&&t.data&&t.tecnico.trim();return e.jsxs("div",{className:"space-y-6",children:[e.jsx(U,{currentStep:2,title:`2º Passo - ${D}`,subtitle:"Revisar e confirmar receptoras",onBack:k,onExit:k,showExit:!y}),!y&&e.jsx(me,{data:t.data,tecnico:t.tecnico,onDataChange:r=>u(m=>({...m,data:r})),onTecnicoChange:r=>u(m=>({...m,tecnico:r}))}),e.jsx(ee,{fazendaNome:D,dataInicio:s.data_inicio,veterinario:s.responsavel_inicio,tecnico:s.tecnico_responsavel,passo2Data:s.passo2_data||t.data,passo2Tecnico:s.passo2_tecnico_responsavel||t.tecnico,showPasso2:!0}),e.jsx(pe,{pendentes:A.pendentes,confirmadas:A.confirmadas,descartadas:A.descartadas}),e.jsx(ue,{receptoras:d,motivosInapta:_,isFinalized:y,onStatusChange:v,onMotivoChange:j}),!y&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:!M&&e.jsx("span",{children:!t.data||!t.tecnico.trim()?"Preencha a data e o técnico responsável":`${A.pendentes} receptora(s) aguardando avaliação`})}),e.jsxs(V,{onClick:E,disabled:!M||C,size:"lg",children:[e.jsx(de,{className:"w-4 h-4 mr-2"}),C?"Finalizando...":"Finalizar 2º Passo"]})]}),e.jsx(ae,{open:i,onClose:g,step:2,fazendaNome:D,dataInicio:s.data_inicio,totalReceptoras:d.length,receptorasConfirmadas:A.confirmadas,receptorasDescartadas:A.descartadas}),e.jsx(se,{open:a,onOpenChange:f,onConfirm:F,title:"Cancelar 2º Passo?",description:"Você tem mudanças pendentes. Ao sair, as alterações não serão salvas."})]})}export{Me as default};
