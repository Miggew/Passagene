import{r as d,j as e,P as le,h as _a,R,i as Ca,k as Na,l as P,B as C,m as wa,f as Sa,n as Ie,s as y}from"./index-DmNymSE5.js";import{v as ze,a as ya}from"./receptoraStatus-DOv_raBa.js";import{C as re,a as te,b as ie,d as ne}from"./card-SrkIpKk5.js";import{I as Y}from"./input-CUsCheD8.js";import{L as E}from"./label-u6KawL_e.js";import{T as ce}from"./textarea-BuM8ilf-.js";import{S as Ra,a as Ia,b as za,c as Ea,d as Pa}from"./select-yD1hylSL.js";import{P as Ta,a as Aa,b as Ga}from"./popover-BabFSUJ1.js";import{C as Da,a as ka,b as Fa,c as qa,d as $a,e as Va}from"./command-DzSUBoEJ.js";import{D as Ee,a as Pe,b as Te,c as Ae,d as Ge,e as De}from"./dialog-j4QKUGZf.js";import{A as ke,a as Fe,b as qe,c as $e,d as Ve,e as Le,f as Oe,g as Be}from"./alert-dialog-DGw4iz2S.js";import{T as La,a as Oa,b as Me,c as L,d as Ba,e as O}from"./table-BEqiB4gi.js";import{B as Qe}from"./badge-BB9l9AxT.js";import{P as He}from"./PageHeader-C6hPTib0.js";import{u as Ma}from"./use-toast-8Wh80yTN.js";import{C as Qa,Q as Ha}from"./QualidadeSemaforo-DOiVLgyG.js";import{c as We,I as Ua,R as Za}from"./index-DntbqoHW.js";import{u as pe}from"./index-BMCBZPUE.js";import{u as Ja}from"./index-BoubMqWY.js";import{X as ee}from"./x-BKw_NAIH.js";import{D as Ka}from"./DatePickerBR-DL95UOFW.js";import{A as Ue}from"./arrow-left-4eR3Pk6r.js";import{P as Wa}from"./plus-BZvL1qCK.js";import{S as Xa}from"./search-52vUzEUy.js";import{U as Ze}from"./user-plus-wGsTTIAJ.js";import{L as Ya}from"./lock-c77r9b7d.js";import"./index-C79PyqkA.js";import"./index-BMurdLVa.js";import"./check-D6LfuFSM.js";import"./calendar-u0e6cTgk.js";var Xe="Toggle",me=d.forwardRef((r,s)=>{const{pressed:l,defaultPressed:m,onPressedChange:t,...u}=r,[i,h]=pe({prop:l,onChange:t,defaultProp:m??!1,caller:Xe});return e.jsx(le.button,{type:"button","aria-pressed":i,"data-state":i?"on":"off","data-disabled":r.disabled?"":void 0,...u,ref:s,onClick:_a(r.onClick,()=>{r.disabled||h(!i)})})});me.displayName=Xe;var Ye=me,D="ToggleGroup",[ea,Fo]=Ca(D,[We]),aa=We(),ue=R.forwardRef((r,s)=>{const{type:l,...m}=r;if(l==="single"){const t=m;return e.jsx(eo,{...t,ref:s})}if(l==="multiple"){const t=m;return e.jsx(ao,{...t,ref:s})}throw new Error(`Missing prop \`type\` expected on \`${D}\``)});ue.displayName=D;var[oa,sa]=ea(D),eo=R.forwardRef((r,s)=>{const{value:l,defaultValue:m,onValueChange:t=()=>{},...u}=r,[i,h]=pe({prop:l,defaultProp:m??"",onChange:t,caller:D});return e.jsx(oa,{scope:r.__scopeToggleGroup,type:"single",value:R.useMemo(()=>i?[i]:[],[i]),onItemActivate:h,onItemDeactivate:R.useCallback(()=>h(""),[h]),children:e.jsx(ra,{...u,ref:s})})}),ao=R.forwardRef((r,s)=>{const{value:l,defaultValue:m,onValueChange:t=()=>{},...u}=r,[i,h]=pe({prop:l,defaultProp:m??[],onChange:t,caller:D}),v=R.useCallback(G=>h((I=[])=>[...I,G]),[h]),F=R.useCallback(G=>h((I=[])=>I.filter(B=>B!==G)),[h]);return e.jsx(oa,{scope:r.__scopeToggleGroup,type:"multiple",value:i,onItemActivate:v,onItemDeactivate:F,children:e.jsx(ra,{...u,ref:s})})});ue.displayName=D;var[oo,so]=ea(D),ra=R.forwardRef((r,s)=>{const{__scopeToggleGroup:l,disabled:m=!1,rovingFocus:t=!0,orientation:u,dir:i,loop:h=!0,...v}=r,F=aa(l),G=Ja(i),I={role:"group",dir:G,...v};return e.jsx(oo,{scope:l,rovingFocus:t,disabled:m,children:t?e.jsx(Za,{asChild:!0,...F,orientation:u,dir:G,loop:h,children:e.jsx(le.div,{...I,ref:s})}):e.jsx(le.div,{...I,ref:s})})}),ae="ToggleGroupItem",ta=R.forwardRef((r,s)=>{const l=sa(ae,r.__scopeToggleGroup),m=so(ae,r.__scopeToggleGroup),t=aa(r.__scopeToggleGroup),u=l.value.includes(r.value),i=m.disabled||r.disabled,h={...r,pressed:u,disabled:i},v=R.useRef(null);return m.rovingFocus?e.jsx(Ua,{asChild:!0,...t,focusable:!i,active:u,ref:v,children:e.jsx(Je,{...h,ref:s})}):e.jsx(Je,{...h,ref:s})});ta.displayName=ae;var Je=R.forwardRef((r,s)=>{const{__scopeToggleGroup:l,value:m,...t}=r,u=sa(ae,l),i={role:"radio","aria-checked":r.pressed,"aria-pressed":void 0},h=u.type==="single"?i:void 0;return e.jsx(me,{...h,...t,ref:s,onPressedChange:v=>{v?u.onItemActivate(m):u.onItemDeactivate(m)}})}),ia=ue,na=ta;const ca=Na("inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground",{variants:{variant:{default:"bg-transparent",outline:"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground"},size:{default:"h-10 px-3",sm:"h-9 px-2.5",lg:"h-11 px-5"}},defaultVariants:{variant:"default",size:"default"}}),ro=d.forwardRef(({className:r,variant:s,size:l,...m},t)=>e.jsx(Ye,{ref:t,className:P(ca({variant:s,size:l,className:r})),...m}));ro.displayName=Ye.displayName;const la=d.createContext({size:"default",variant:"default"}),da=d.forwardRef(({className:r,variant:s,size:l,children:m,...t},u)=>e.jsx(ia,{ref:u,className:P("flex items-center justify-center gap-1",r),...t,children:e.jsx(la.Provider,{value:{variant:s,size:l},children:m})}));da.displayName=ia.displayName;const de=d.forwardRef(({className:r,children:s,variant:l,size:m,...t},u)=>{const i=d.useContext(la);return e.jsx(na,{ref:u,className:P(ca({variant:i.variant||l,size:i.size||m}),r),...t,children:s})});de.displayName=na.displayName;function Ke({ciclandoValue:r,qualidadeValue:s,onChangeCiclando:l,onChangeQualidade:m,disabled:t=!1,size:u="sm"}){const i=u==="sm"?"text-xs":"text-sm",h=u==="sm"?"w-4 h-4":"w-5 h-5";return e.jsxs("div",{className:"flex flex-wrap items-center gap-3 text-slate-600",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:P("text-slate-500 font-medium",i),children:"Ciclo:"}),e.jsxs(da,{type:"single",value:r||void 0,onValueChange:v=>{t||l(v==="CL"||v==="N"?v:null)},disabled:t,className:"gap-1",children:[e.jsx(de,{value:"CL","aria-label":"CL",size:"sm",variant:"outline",className:P("h-7 px-2 text-xs",r==="CL"&&"bg-blue-100 text-blue-700 border-blue-300 data-[state=on]:bg-blue-100",t&&"opacity-60"),children:"CL"}),e.jsx(de,{value:"N","aria-label":"N",size:"sm",variant:"outline",className:P("h-7 px-2 text-xs",r==="N"&&"bg-slate-100 text-slate-700 border-slate-300 data-[state=on]:bg-slate-100",t&&"opacity-60"),children:"N"})]}),r&&!t&&e.jsx(C,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 text-slate-400 hover:text-slate-600",onClick:()=>l(null),type:"button",children:e.jsx(ee,{className:"w-3 h-3"})}),!r&&e.jsx("span",{className:P("text-slate-300",i),children:"—"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:P("text-slate-500 font-medium",i),children:"Qualidade:"}),e.jsx("div",{className:"flex items-center gap-1.5",children:[1,2,3].map(v=>e.jsx("button",{type:"button",disabled:t,onClick:()=>{t||m(s===v?null:v)},className:P(h,"rounded-full border-2 transition-all",wa(v),s===v?"border-slate-900 scale-110 ring-2 ring-slate-300":"border-slate-300 opacity-50 hover:opacity-75 hover:scale-105",t&&"opacity-40 cursor-not-allowed",!t&&"cursor-pointer"),title:`Qualidade ${v}`},v))}),s&&!t&&e.jsx(C,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 text-slate-400 hover:text-slate-600",onClick:()=>m(null),type:"button",children:e.jsx(ee,{className:"w-3 h-3"})}),!s&&e.jsx("span",{className:P("text-slate-300",i),children:"—"})]})]})}function qo(){var we;const r=Sa(),{toast:s}=Ma(),[l,m]=d.useState(!1),[t,u]=d.useState(!1),i=d.useRef(!1),[h,v]=d.useState("form"),[F,G]=d.useState([]),[I,B]=d.useState([]),[K,fe]=d.useState([]),[he,xe]=d.useState(!1),[ve,W]=d.useState(!1),[pa,ge]=d.useState(!1),[ma,je]=d.useState(!1),[M,X]=d.useState(""),[oe,Q]=d.useState(!1),[n,H]=d.useState({fazenda_id:"",data_inicio:Ie(),veterinario:"",tecnico:"",observacoes:""}),[N,U]=d.useState([]),[w,q]=d.useState({receptora_id:"",observacoes:"",ciclando_classificacao:null,qualidade_semaforo:null}),[x,k]=d.useState({identificacao:"",nome:"",observacoes:""});d.useEffect(()=>{ua()},[]),d.useEffect(()=>{h==="receptoras"&&n.fazenda_id?be(n.fazenda_id):h!=="receptoras"&&B([])},[h,n.fazenda_id]);const ua=async()=>{try{const{data:a,error:o}=await y.from("fazendas").select("*").order("nome",{ascending:!0});if(o)throw o;G(a||[])}catch(a){s({title:"Erro ao carregar fazendas",description:a instanceof Error?a.message:"Erro desconhecido",variant:"destructive"})}},be=async a=>{try{xe(!0);const{data:o,error:p}=await y.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",a);if(p)throw p;const b=(o==null?void 0:o.map(S=>S.receptora_id))||[];if(b.length===0){B([]),fe([]);return}const{data:j,error:g}=await y.from("receptoras").select("id, identificacao, nome, status_reprodutivo").in("id",b).order("identificacao",{ascending:!0});if(g)throw g;const f=(j||[]||[]).filter(S=>(S.id?String(S.id).trim():"")!=="").map(async S=>{if(!(S.id?String(S.id).trim():""))return null;const z=S.status_reprodutivo||"VAZIA",V=ze(z,"ENTRAR_PASSO1");return{...S,status:z,motivoIndisponivel:V.valido?void 0:V.mensagem}}),T=(await Promise.all(f)).filter(S=>S!==null),Z=T.filter(S=>S.status==="VAZIA");B(Z),fe(T)}catch(o){s({title:"Erro ao carregar receptoras",description:o instanceof Error?o.message:"Erro desconhecido",variant:"destructive"})}finally{xe(!1)}},$=d.useMemo(()=>new Set(N.filter(a=>a.id&&a.id.trim()!==""&&a.id!==null&&a.id!==void 0).map(a=>String(a.id).trim())),[N]);d.useMemo(()=>I.filter(a=>{const o=a.id?String(a.id).trim():"";return o!==""&&!$.has(o)}),[I,$]);const _e=d.useMemo(()=>{if(!M.trim())return K.filter(o=>{const p=o.id?String(o.id).trim():"";return p!==""&&!$.has(p)&&o.status==="VAZIA"}).map(o=>({...o,disponivel:!0}));const a=M.toLowerCase().trim();return K.filter(o=>{const p=o.id?String(o.id).trim():"";if(p===""||$.has(p))return!1;const b=(o.identificacao||"").toLowerCase(),j=(o.nome||"").toLowerCase();return b.includes(a)||j.includes(a)}).map(o=>({...o,disponivel:o.status==="VAZIA"}))},[M,K,$]),fa=()=>{if(!n.fazenda_id||!n.data_inicio||!n.veterinario.trim()||!n.tecnico.trim()){s({title:"Erro de validação",description:"Fazenda, data de início, veterinário e técnico são obrigatórios",variant:"destructive"});return}v("receptoras")},ha=async()=>{var j;const a=((j=w.receptora_id)==null?void 0:j.trim())||"";if(!a){s({title:"Erro",description:"Selecione uma receptora",variant:"destructive"});return}const o=I.find(g=>(g.id?String(g.id).trim():"")===a);if(!o||!o.id){s({title:"Erro",description:"Receptora não encontrada ou inválida",variant:"destructive"});return}const p=o.status_reprodutivo||"VAZIA",b=ze(p,"ENTRAR_PASSO1");if(!b.valido){s({title:"Erro de validação",description:b.mensagem||"A receptora não pode entrar no protocolo no estado atual",variant:"destructive"});return}if($.has(a)){s({title:"Receptora já adicionada",description:"Esta receptora já está na lista de selecionadas",variant:"destructive"});return}U(g=>{var f;return g.some(_=>(_.id?String(_.id).trim():"")===a)?g:[...g,{id:o.id,identificacao:o.identificacao,nome:o.nome,observacoes:((f=w.observacoes)==null?void 0:f.trim())||void 0,ciclando_classificacao:w.ciclando_classificacao||null,qualidade_semaforo:w.qualidade_semaforo||null}]}),q({receptora_id:"",observacoes:"",ciclando_classificacao:null,qualidade_semaforo:null}),X(""),Q(!1),ge(!1)},xa=async()=>{if(!x.identificacao.trim()){s({title:"Erro de validação",description:"Identificação (brinco) é obrigatória",variant:"destructive"});return}try{u(!0);const{data:a,error:o}=await y.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",n.fazenda_id);if(o)throw o;const p=(a==null?void 0:a.map(f=>f.receptora_id))||[];if(p.length>0){const{data:f,error:_}=await y.from("receptoras").select("id, identificacao, nome").in("id",p).ilike("identificacao",x.identificacao.trim());if(_)throw _;if(f&&f.length>0){const T=f[0].nome?`"${f[0].nome}"`:"sem nome",Z=`Já existe uma receptora com o brinco "${x.identificacao.trim()}" nesta fazenda (Nome: ${T}).`;throw new Error(Z)}}if(x.nome.trim()&&p.length>0){const{data:f,error:_}=await y.from("receptoras").select("id, identificacao").in("id",p).ilike("nome",x.nome.trim());if(_)throw _;if(f&&f.length>0)throw new Error(`Já existe uma receptora com o nome "${x.nome.trim()}" nesta fazenda (Brinco: ${f[0].identificacao}).`)}const b={identificacao:x.identificacao};x.nome.trim()&&(b.nome=x.nome);const{data:j,error:g}=await y.from("receptoras").insert([b]).select().single();if(g)throw g.code==="23505"?new Error("Já existe uma receptora com esse brinco nesta fazenda."):g;const{error:c}=await y.from("receptora_fazenda_historico").insert([{receptora_id:j.id,fazenda_id:n.fazenda_id,data_inicio:Ie(),data_fim:null}]);U([...N,{id:j.id,identificacao:j.identificacao,nome:j.nome,observacoes:x.observacoes||void 0,ciclando_classificacao:x.ciclando_classificacao||null,qualidade_semaforo:x.qualidade_semaforo||null,isNew:!0}]),k({identificacao:"",nome:"",observacoes:"",ciclando_classificacao:null,qualidade_semaforo:null}),je(!1),be(n.fazenda_id)}catch(a){s({title:"Erro ao criar receptora",description:a instanceof Error?a.message:"Erro desconhecido",variant:"destructive"})}finally{u(!1)}},va=a=>{U(N.filter((o,p)=>p!==a))},ga=async()=>{if(i.current||t)return;if(N.length===0){s({title:"Erro de validação",description:"Adicione pelo menos 1 receptora antes de finalizar o 1º passo",variant:"destructive"});return}if(N.filter(c=>!c.id||c.id===""||c.id===null||c.id===void 0).length>0){s({title:"Erro de validação",description:"Seleção de receptora inválida. Refaça a seleção.",variant:"destructive"});return}const o=N.filter(c=>c.id&&c.id!==""&&c.id!==null&&c.id!==void 0);if(o.length!==N.length||o.length===0){s({title:"Erro de validação",description:"Seleção de receptora inválida. Refaça a seleção.",variant:"destructive"});return}const p=o.map(c=>c.id),b=o.map(c=>c.observacoes||null),j=o.map(c=>c.ciclando_classificacao||null),g=o.map(c=>c.qualidade_semaforo||null);try{i.current=!0,u(!0);const c=`VET: ${n.veterinario.trim()} | TEC: ${n.tecnico.trim()}`,{data:f,error:_}=await y.rpc("criar_protocolo_passo1_atomico",{p_fazenda_id:n.fazenda_id,p_data_inicio:n.data_inicio,p_responsavel_inicio:c,p_receptoras_ids:p,p_data_inclusao:n.data_inicio,p_observacoes:n.observacoes.trim()||null,p_receptoras_observacoes:b});if(_)throw _;if(!f)throw new Error("Protocolo criado mas ID não retornado");const{data:T,error:Z}=await y.from("protocolo_receptoras").select("id, receptora_id").eq("protocolo_id",f).in("receptora_id",p);if(!Z&&T&&T.length>0){const z=new Map(p.map((A,J)=>[A,J])),V=T.map(async A=>{const J=z.get(A.receptora_id);if(J===void 0)return{success:!0};const ja=j[J],ba=g[J],{error:Re}=await y.from("protocolo_receptoras").update({ciclando_classificacao:ja,qualidade_semaforo:ba}).eq("id",A.id);return{success:!Re,error:Re}}),ye=(await Promise.allSettled(V)).filter(A=>A.status==="rejected"||A.status==="fulfilled"&&A.value&&!A.value.success);ye.length>0&&s({title:"Aviso",description:`Protocolo criado, mas ${ye.length} classificação(ões) não foram salvas. Edite o protocolo para corrigir.`,variant:"destructive"})}if((await Promise.all(p.map(z=>ya(z,"EM_SINCRONIZACAO")))).map((z,V)=>({result:z,receptoraId:p[V]})).filter(({result:z})=>z.error).length>0)throw new Error("Erro ao atualizar status das receptoras. Tente novamente.");s({title:"Protocolo criado com sucesso",description:`${N.length} receptoras adicionadas ao protocolo`}),r("/protocolos")}catch(c){const f=c instanceof Error?c.message:"Erro desconhecido ao finalizar protocolo";s({title:"Erro ao finalizar protocolo",description:f,variant:"destructive"})}finally{u(!1),i.current=!1}},Ce=()=>{h==="form"?r("/protocolos"):v("form")},se=()=>{n.fazenda_id||N.length>0?W(!0):r("/protocolos")},Ne=()=>{W(!1),r("/protocolos")};return h==="form"?e.jsxs("div",{className:"space-y-6",children:[e.jsx(He,{title:"Novo Protocolo",description:"Primeira visita - Cadastrar novo protocolo de sincronização",actions:e.jsx(C,{variant:"outline",size:"icon",onClick:se,children:e.jsx(Ue,{className:"w-4 h-4"})})}),e.jsxs(re,{children:[e.jsx(te,{children:e.jsx(ie,{children:"Informações do Protocolo"})}),e.jsx(ne,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"fazenda_id",children:"Fazenda *"}),e.jsxs(Ra,{value:n.fazenda_id,onValueChange:a=>H({...n,fazenda_id:a}),children:[e.jsx(Ia,{children:e.jsx(za,{placeholder:"Selecione a fazenda"})}),e.jsx(Ea,{children:F.map(a=>e.jsx(Pa,{value:a.id,children:a.nome},a.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"data_inicio",children:"Data de Início *"}),e.jsx(Ka,{id:"data_inicio",value:n.data_inicio,onChange:a=>H({...n,data_inicio:a||""}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"veterinario",children:"Veterinário Responsável *"}),e.jsx(Y,{id:"veterinario",value:n.veterinario,onChange:a=>H({...n,veterinario:a.target.value}),placeholder:"Nome do veterinário",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"tecnico",children:"Técnico Responsável *"}),e.jsx(Y,{id:"tecnico",value:n.tecnico,onChange:a=>H({...n,tecnico:a.target.value}),placeholder:"Nome do técnico/funcionário",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"observacoes",children:"Observações"}),e.jsx(ce,{id:"observacoes",value:n.observacoes,onChange:a=>H({...n,observacoes:a.target.value}),placeholder:"Observações sobre o protocolo",rows:3})]}),e.jsxs("div",{className:"flex gap-4 pt-4",children:[e.jsx(C,{onClick:fa,className:"bg-green-600 hover:bg-green-700",disabled:l,children:"Continuar para Receptoras"}),e.jsx(C,{type:"button",variant:"outline",onClick:se,disabled:l,children:"Sair"})]})]})})]}),e.jsx(ke,{open:ve,onOpenChange:W,children:e.jsxs(Fe,{children:[e.jsxs(qe,{children:[e.jsx($e,{children:"Sair sem finalizar?"}),e.jsx(Ve,{children:"Se você sair agora, nenhum protocolo será criado. Todos os dados preenchidos serão perdidos."})]}),e.jsxs(Le,{children:[e.jsx(Oe,{children:"Cancelar"}),e.jsx(Be,{onClick:Ne,children:"Sim, sair"})]})]})})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(He,{title:"Adicionar Receptoras",description:"Selecione as receptoras para este protocolo",actions:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(C,{variant:"outline",size:"icon",onClick:Ce,children:e.jsx(Ue,{className:"w-4 h-4"})}),e.jsxs(C,{variant:"outline",onClick:se,children:[e.jsx(ee,{className:"w-4 h-4 mr-2"}),"Sair"]})]})}),e.jsxs(re,{children:[e.jsx(te,{children:e.jsx(ie,{children:"Informações do Protocolo"})}),e.jsxs(ne,{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Fazenda"}),e.jsx("p",{className:"text-base text-slate-900",children:((we=F.find(a=>a.id===n.fazenda_id))==null?void 0:we.nome)||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Data Início"}),e.jsx("p",{className:"text-base text-slate-900",children:n.data_inicio})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Veterinário"}),e.jsx("p",{className:"text-base text-slate-900",children:n.veterinario})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Técnico"}),e.jsx("p",{className:"text-base text-slate-900",children:n.tecnico})]})]})]}),e.jsxs(re,{children:[e.jsx(te,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(ie,{children:["Receptoras do Protocolo (",N.length,")"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(Ee,{open:pa,onOpenChange:a=>{ge(a),a||(q({receptora_id:"",observacoes:"",ciclando_classificacao:null,qualidade_semaforo:null}),X(""),Q(!1))},children:[e.jsx(Pe,{asChild:!0,children:e.jsxs(C,{className:"bg-green-600 hover:bg-green-700",children:[e.jsx(Wa,{className:"w-4 h-4 mr-2"}),"Adicionar Receptora"]})}),e.jsxs(Te,{className:"max-w-lg",children:[e.jsxs(Ae,{children:[e.jsx(Ge,{children:"Adicionar Receptora ao Protocolo"}),e.jsx(De,{children:"Busque por identificação ou nome. Receptoras adequadas aparecerão como disponíveis. Receptoras inadequadas mostrarão o motivo ao serem pesquisadas."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{children:"Receptora *"}),e.jsxs(Ta,{open:oe,onOpenChange:Q,children:[e.jsx(Aa,{asChild:!0,children:e.jsxs(C,{variant:"outline",role:"combobox","aria-expanded":oe,className:"w-full justify-between",onClick:()=>Q(!oe),children:[w.receptora_id?(()=>{const a=K.find(o=>String(o.id).trim()===w.receptora_id.trim());return a?`${a.identificacao}${a.nome?` - ${a.nome}`:""}`:"Selecione uma receptora"})():"Buscar receptora...",e.jsx(Xa,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(Ga,{className:"w-[400px] p-0",align:"start",children:e.jsxs(Da,{shouldFilter:!1,children:[e.jsx(ka,{placeholder:"Buscar por identificação ou nome...",value:M,onValueChange:X}),e.jsx(Fa,{children:he?e.jsx("div",{className:"p-4 text-sm text-center text-slate-500",children:"Carregando receptoras..."}):_e.length===0?e.jsx(qa,{children:M.trim()?"Nenhuma receptora encontrada":"Nenhuma receptora disponível"}):e.jsx($a,{children:_e.map(a=>{var b,j;const o=a.id?String(a.id).trim():"";if(!o)return null;const p=`${a.identificacao} ${a.nome||""}`.trim();return e.jsx(Va,{value:`${p} ${o}`,onSelect:()=>{a.disponivel&&(q({...w,receptora_id:o}),X(""),Q(!1))},disabled:!a.disponivel,className:a.disponivel?"":"opacity-60 cursor-not-allowed",children:e.jsxs("div",{className:"flex flex-col w-full",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("span",{className:"flex-1",children:[a.identificacao,a.nome?` - ${a.nome}`:""]}),a.disponivel?e.jsx(Qe,{variant:"outline",className:"bg-green-50 text-green-700 border-green-200 shrink-0",children:"Disponível"}):e.jsx(Qe,{variant:"outline",className:"bg-red-50 text-red-700 border-red-200 shrink-0",children:"Indisponível"})]}),!a.disponivel&&e.jsx("span",{className:"text-xs text-red-600 mt-1",children:(b=a.motivoIndisponivel)!=null&&b.includes("Status atual:")&&((j=a.motivoIndisponivel.split("Status atual:")[1])==null?void 0:j.trim())||a.status})]})},a.id)})})})]})})]})]}),e.jsx("div",{className:"space-y-2",children:e.jsx(Ke,{ciclandoValue:w.ciclando_classificacao,qualidadeValue:w.qualidade_semaforo,onChangeCiclando:a=>q({...w,ciclando_classificacao:a}),onChangeQualidade:a=>q({...w,qualidade_semaforo:a}),size:"sm"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{children:"Observações"}),e.jsx(ce,{value:w.observacoes,onChange:a=>q({...w,observacoes:a.target.value}),placeholder:"Observações sobre a inclusão",rows:2})]}),e.jsx(C,{onClick:ha,className:"w-full bg-green-600 hover:bg-green-700",disabled:he||!w.receptora_id,children:"Adicionar"})]})]})]}),e.jsxs(Ee,{open:ma,onOpenChange:a=>{je(a),a||k({identificacao:"",nome:"",observacoes:"",ciclando_classificacao:null,qualidade_semaforo:null})},children:[e.jsx(Pe,{asChild:!0,children:e.jsxs(C,{variant:"outline",children:[e.jsx(Ze,{className:"w-4 h-4 mr-2"}),"Cadastrar Nova"]})}),e.jsxs(Te,{children:[e.jsxs(Ae,{children:[e.jsx(Ge,{children:"Cadastrar Nova Receptora"}),e.jsx(De,{children:"Preencha os dados da nova receptora para cadastrá-la e adicioná-la ao protocolo."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{children:"Identificação (Brinco) *"}),e.jsx(Y,{value:x.identificacao,onChange:a=>k({...x,identificacao:a.target.value}),placeholder:"Número do brinco"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{children:"Nome"}),e.jsx(Y,{value:x.nome,onChange:a=>k({...x,nome:a.target.value}),placeholder:"Nome da receptora (opcional)"})]}),e.jsx("div",{className:"space-y-2",children:e.jsx(Ke,{ciclandoValue:x.ciclando_classificacao,qualidadeValue:x.qualidade_semaforo,onChangeCiclando:a=>k({...x,ciclando_classificacao:a}),onChangeQualidade:a=>k({...x,qualidade_semaforo:a}),size:"sm"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{children:"Observações"}),e.jsx(ce,{value:x.observacoes,onChange:a=>k({...x,observacoes:a.target.value}),placeholder:"Observações sobre a receptora",rows:2})]}),e.jsxs(C,{onClick:xa,className:"w-full bg-blue-600 hover:bg-blue-700",disabled:t,children:[e.jsx(Ze,{className:"w-4 h-4 mr-2"}),t?"Criando...":"Criar e Adicionar"]})]})]})]})]})]})}),e.jsx(ne,{children:N.length===0?e.jsx("div",{className:"text-center py-8 text-slate-500",children:"Nenhuma receptora adicionada. Adicione pelo menos uma antes de finalizar."}):e.jsxs(La,{children:[e.jsx(Oa,{children:e.jsxs(Me,{children:[e.jsx(L,{children:"Brinco"}),e.jsx(L,{children:"Nome"}),e.jsx(L,{children:"Ciclando"}),e.jsx(L,{children:"Qualidade"}),e.jsx(L,{children:"Observações"}),e.jsx(L,{className:"text-right",children:"Ações"})]})}),e.jsx(Ba,{children:N.map((a,o)=>{const p=a.id&&a.id.trim()!==""?a.id:`new-${o}`,b=g=>{U(c=>c.map((f,_)=>_===o?{...f,ciclando_classificacao:g}:f))},j=g=>{U(c=>c.map((f,_)=>_===o?{...f,qualidade_semaforo:g}:f))};return e.jsxs(Me,{children:[e.jsx(O,{className:"font-medium",children:a.identificacao}),e.jsx(O,{children:a.nome||"-"}),e.jsx(O,{children:e.jsx(Qa,{value:a.ciclando_classificacao,onChange:b,variant:"editable"})}),e.jsx(O,{children:e.jsx(Ha,{value:a.qualidade_semaforo,onChange:j,variant:"row"})}),e.jsx(O,{children:a.observacoes||"-"}),e.jsx(O,{className:"text-right",children:e.jsx(C,{variant:"ghost",size:"sm",onClick:()=>va(o),children:e.jsx(ee,{className:"w-4 h-4"})})})]},p)})})]})})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs(C,{onClick:ga,disabled:N.length===0||t||i.current,className:"bg-blue-600 hover:bg-blue-700",children:[e.jsx(Ya,{className:"w-4 h-4 mr-2"}),t||i.current?"Finalizando...":"Finalizar 1º Passo"]}),e.jsx(C,{variant:"outline",onClick:Ce,disabled:t||i.current,children:"Voltar"})]}),e.jsx(ke,{open:ve,onOpenChange:W,children:e.jsxs(Fe,{children:[e.jsxs(qe,{children:[e.jsx($e,{children:"Sair sem finalizar?"}),e.jsx(Ve,{children:"Se você sair agora, nenhum protocolo será criado. Todos os dados preenchidos serão perdidos."})]}),e.jsxs(Le,{children:[e.jsx(Oe,{children:"Cancelar"}),e.jsx(Be,{onClick:Ne,children:"Sim, sair"})]})]})})]})}export{qo as default};
