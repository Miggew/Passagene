import{j as a,f as M,h as w,r as d,a as A,s as X,g as Z}from"./index-CWtHucPz.js";import{C as H,a as P,b as B,c as I,u as K}from"./use-toast-C_ednEV-.js";import{T as G,a as O,b as y,c as u,d as $,e as x}from"./table-2v-HqcxP.js";import{D as Q,a as W,b as Y,c as aa,d as ea,e as sa}from"./dialog-DG0TUp-m.js";import{S as V,a as q,b as U,c as J,d as _}from"./select-BUr2m4f3.js";import{I as R}from"./input-bF23Jkur.js";import{L as T}from"./label-CDN-yMr6.js";import{P as ra}from"./PageHeader-DqMTzrbX.js";import{E as ta}from"./EmptyState-B00kV8BS.js";import{S as ia}from"./search-B6nVOFfl.js";import{X as oa}from"./x-BtWTyRSy.js";import{D as la,H as na,P as ca,G as da,S as C}from"./DoadoraHistoricoAspiracoes-bH2o-q3T.js";import{f as ma}from"./dateUtils-eJ5e6apA.js";import{B as ha}from"./badge-DewFfdNp.js";import{u as ua,c as xa}from"./hooks-BHMrHO5Y.js";import{u as ja}from"./useListFilter-EgHurVux.js";import"./index-Dast7Jda.js";import{P as pa}from"./plus-CgYPqLq7.js";import"./index-RvRMy3My.js";import"./index-H2w26JuE.js";import"./check-D_BDiPDp.js";function fa({fazendas:s,selectedFazendaId:e,onFazendaChange:i,title:r="Selecione a Fazenda",placeholder:t="Selecione uma fazenda",required:o=!1}){return a.jsxs(H,{children:[a.jsx(P,{children:a.jsxs(B,{children:[r,o&&" *"]})}),a.jsx(I,{children:a.jsxs(V,{value:e,onValueChange:i,children:[a.jsx(q,{className:"w-full",children:a.jsx(U,{placeholder:t})}),a.jsx(J,{children:s.map(n=>a.jsx(_,{value:n.id,children:n.nome},n.id))})]})})]})}function L({className:s,...e}){return a.jsx("div",{className:M("animate-pulse rounded-md bg-muted",s),...e})}function ga({columns:s,rows:e=5,headers:i,showHeader:r=!0}){return a.jsxs(G,{children:[r&&a.jsx(O,{children:a.jsx(y,{children:i?i.map((t,o)=>a.jsx(u,{children:t},o)):Array.from({length:s}).map((t,o)=>a.jsx(u,{children:a.jsx(L,{className:"h-4 w-20"})},o))})}),a.jsx($,{children:Array.from({length:e}).map((t,o)=>a.jsx(y,{children:Array.from({length:s}).map((n,c)=>a.jsx(x,{children:a.jsx(L,{className:`h-4 ${c===0?"w-24":c===s-1?"w-16":"w-32"}`})},c))},o))})]})}function va({value:s,onChange:e,placeholder:i="Buscar...",label:r,id:t="search-input",className:o="",showClearButton:n=!0}){return a.jsxs("div",{className:`space-y-2 ${o}`,children:[r&&a.jsx(T,{htmlFor:t,children:r}),a.jsxs("div",{className:"relative",children:[a.jsx(ia,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4"}),a.jsx(R,{id:t,placeholder:i,value:s,onChange:c=>e(c.target.value),className:"pl-10 pr-10"}),n&&s&&a.jsx(w,{type:"button",variant:"ghost",size:"sm",className:"absolute right-1 top-1/2 transform -translate-y-1/2 h-7 w-7 p-0 hover:bg-slate-100",onClick:()=>e(""),children:a.jsx(oa,{className:"w-4 h-4 text-slate-400"})})]})]})}const Na=(s,e)=>{var i,r,t;return((i=s.nome)==null?void 0:i.toLowerCase().includes(e))||((r=s.registro)==null?void 0:r.toLowerCase().includes(e))||((t=s.raca)==null?void 0:t.toLowerCase().includes(e))||!1};function Ca(){const[s,e]=d.useState(""),[i,r]=d.useState(null),{data:t=[],isLoading:o,refetch:n}=ua(),{data:c=[],isLoading:l,refetch:j}=xa(s||void 0),{filtered:g,searchTerm:v,setSearchTerm:p,clearFilters:D,hasActiveFilters:b}=ja({data:c,searchFn:Na});return{loading:o||(s?l:!1),fazendas:t,doadoras:c,filteredDoadoras:g,selectedFazendaId:s,setSelectedFazendaId:e,searchTerm:v,setSearchTerm:p,clearFilters:D,hasActiveFilters:b,historicoDoadoraId:i,setHistoricoDoadoraId:r,loadFazendas:async()=>{await n()},loadDoadoras:async()=>{s&&await j()}}}const wa=["Holandesa","Jersey","Gir","Girolando"],k={registro:"",raca:"",racaCustom:""};function Da({selectedFazendaId:s,onSuccess:e}){const i=A(),{toast:r}=K(),[t,o]=d.useState(!1),[n,c]=d.useState(!1),[l,j]=d.useState(k),[g,v]=d.useState(""),p=d.useCallback(()=>{j(k),v("")},[]),D=d.useCallback(m=>{v(m),j(m==="Outra"?f=>({...f,raca:"",racaCustom:""}):f=>({...f,raca:m,racaCustom:""}))},[]),b=d.useCallback(m=>{o(m),m||p()},[p]),F=d.useCallback(async m=>{if(m.preventDefault(),!s){r({title:"Erro de validacao",description:"Selecione a fazenda primeiro",variant:"destructive"});return}if(!l.registro.trim()){r({title:"Erro de validacao",description:"Registro e obrigatorio",variant:"destructive"});return}const f=g==="Outra"?l.racaCustom.trim():l.raca.trim();if(!f){r({title:"Erro de validacao",description:"Raca e obrigatoria",variant:"destructive"});return}try{c(!0);const N={fazenda_id:s,registro:l.registro.trim(),raca:f},{data:h,error:S}=await X.from("doadoras").insert([N]).select().single();if(S)throw S;r({title:"Doadora criada",description:"Doadora criada com sucesso"}),o(!1),p(),e(),h!=null&&h.id&&i(`/doadoras/${h.id}`)}catch(N){const h=N instanceof Error?N.message:"Erro desconhecido";r({title:"Erro ao criar doadora",description:h.includes("RLS")||h.includes("policy")?"RLS esta bloqueando escrita. Configure politicas anon no Supabase.":h,variant:"destructive"})}finally{c(!1)}},[l,g,s,r,p,e,i]);return{formData:l,setFormData:j,racaSelecionada:g,setRacaSelecionada:v,showDialog:t,setShowDialog:o,submitting:n,resetForm:p,handleSubmit:F,handleDialogClose:b,handleRacaChange:D}}function Ka(){var S,E;const s=A(),{loading:e,fazendas:i,filteredDoadoras:r,selectedFazendaId:t,setSelectedFazendaId:o,searchTerm:n,setSearchTerm:c,historicoDoadoraId:l,setHistoricoDoadoraId:j,loadFazendas:g,loadDoadoras:v}=Ca(),{formData:p,setFormData:D,racaSelecionada:b,showDialog:F,submitting:m,handleSubmit:f,handleDialogClose:N,handleRacaChange:h}=Da({selectedFazendaId:t,onSuccess:v});return d.useEffect(()=>{g()},[g]),e&&i.length===0?a.jsx(Z,{}):a.jsxs("div",{className:"space-y-6",children:[a.jsx(ra,{title:"Doadoras",description:"Gerenciar doadoras do sistema"}),a.jsx(fa,{fazendas:i,selectedFazendaId:t,onFazendaChange:o,placeholder:"Selecione uma fazenda para visualizar doadoras"}),t?a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("div",{className:"flex-1 max-w-md",children:a.jsx(va,{value:n,onChange:c,placeholder:"Buscar por nome ou registro..."})}),a.jsx(ba,{showDialog:F,handleDialogClose:N,formData:p,setFormData:D,racaSelecionada:b,handleRacaChange:h,submitting:m,handleSubmit:f})]}),a.jsxs(H,{children:[a.jsx(P,{children:a.jsx(B,{children:"Lista de Doadoras"})}),a.jsx(I,{children:e?a.jsx(ga,{columns:8,rows:6,headers:["Registro","Nome","Ultima Aspiracao","Oocitos","Estado","Raca","Classificacao","Acoes"]}):a.jsx(Sa,{doadoras:r,searchTerm:n,navigate:s,setHistoricoDoadoraId:j})})]}),l&&a.jsx(la,{doadoraId:l,doadoraNome:((S=r.find(z=>z.id===l))==null?void 0:S.nome)||((E=r.find(z=>z.id===l))==null?void 0:E.registro),open:!!l,onClose:()=>j(null)})]}):a.jsx(ta,{title:"Selecione uma fazenda",description:"Escolha uma fazenda para visualizar e gerenciar doadoras."})]})}function ba({showDialog:s,handleDialogClose:e,formData:i,setFormData:r,racaSelecionada:t,handleRacaChange:o,submitting:n,handleSubmit:c}){return a.jsxs(Q,{open:s,onOpenChange:e,children:[a.jsx(W,{asChild:!0,children:a.jsxs(w,{className:"bg-green-600 hover:bg-green-700",children:[a.jsx(pa,{className:"w-4 h-4 mr-2"}),"Nova Doadora"]})}),a.jsxs(Y,{className:"max-w-md",children:[a.jsxs(aa,{children:[a.jsx(ea,{children:"Criar Nova Doadora"}),a.jsx(sa,{children:"Preencha os campos basicos. As informacoes detalhadas podem ser preenchidas apos a criacao."})]}),a.jsxs("form",{onSubmit:c,className:"space-y-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(T,{htmlFor:"registro",children:"Registro *"}),a.jsx(R,{id:"registro",value:i.registro,onChange:l=>r({...i,registro:l.target.value}),placeholder:"Registro da doadora",required:!0})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(T,{htmlFor:"raca",children:"Raca *"}),a.jsxs(V,{value:t,onValueChange:o,children:[a.jsx(q,{children:a.jsx(U,{placeholder:"Selecione a raca"})}),a.jsxs(J,{children:[wa.map(l=>a.jsx(_,{value:l,children:l},l)),a.jsx(_,{value:"Outra",children:"Outra"})]})]}),t==="Outra"&&a.jsx(R,{id:"raca_custom",value:i.racaCustom,onChange:l=>r({...i,racaCustom:l.target.value,raca:l.target.value}),placeholder:"Digite a raca",className:"mt-2",required:!0})]}),a.jsxs("div",{className:"flex gap-2 pt-2",children:[a.jsx(w,{type:"submit",className:"flex-1 bg-green-600 hover:bg-green-700",disabled:n,children:n?"Salvando...":"Criar Doadora"}),a.jsx(w,{type:"button",variant:"outline",onClick:()=>e(!1),disabled:n,children:"Cancelar"})]})]})]})]})}function Sa({doadoras:s,searchTerm:e,navigate:i,setHistoricoDoadoraId:r}){return a.jsx("div",{className:"overflow-x-auto",children:a.jsxs(G,{children:[a.jsx(O,{children:a.jsxs(y,{children:[a.jsx(u,{children:"Registro"}),a.jsx(u,{children:"Nome"}),a.jsx(u,{children:"Ultima Aspiracao"}),a.jsx(u,{children:"Oocitos"}),a.jsx(u,{children:"Estado"}),a.jsx(u,{children:"Raca (Campos Especiais)"}),a.jsx(u,{children:"Classificacao"}),a.jsx(u,{className:"text-right",children:"Acoes"})]})}),a.jsx($,{children:s.length===0?a.jsx(y,{children:a.jsx(x,{colSpan:8,className:"text-center text-slate-500",children:e?"Nenhuma doadora encontrada":"Nenhuma doadora cadastrada nesta fazenda"})}):s.map(t=>a.jsx(ya,{doadora:t,navigate:i,setHistoricoDoadoraId:r},t.id))})]})})}const ya=d.memo(function({doadora:e,navigate:i,setHistoricoDoadoraId:r}){const t=Fa(e);return a.jsxs(y,{className:"cursor-pointer hover:bg-slate-50",onClick:()=>i(`/doadoras/${e.id}`),children:[a.jsx(x,{className:"font-medium",children:e.registro}),a.jsx(x,{children:e.nome||"-"}),a.jsx(x,{children:e.ultima_aspiracao_data?ma(e.ultima_aspiracao_data):"-"}),a.jsx(x,{children:e.ultima_aspiracao_total_oocitos??"-"}),a.jsx(x,{children:a.jsx(ha,{variant:e.disponivel_aspiracao?"default":"secondary",children:e.disponivel_aspiracao?"Disponivel":"Indisponivel"})}),a.jsx(x,{children:a.jsxs("div",{className:"flex flex-col gap-1",children:[a.jsx("span",{children:e.raca||"-"}),t&&a.jsx("span",{className:"text-xs text-slate-500",children:t})]})}),a.jsx(x,{children:za(e.classificacao_genetica)}),a.jsx(x,{className:"text-right",children:a.jsxs("div",{className:"flex items-center justify-end gap-2",children:[a.jsx(w,{variant:"ghost",size:"sm",onClick:o=>{o.stopPropagation(),r(e.id)},title:"Ver historico de aspiracoes",children:a.jsx(na,{className:"w-4 h-4"})}),a.jsx(w,{variant:"ghost",size:"sm",onClick:o=>{o.stopPropagation(),i(`/doadoras/${e.id}`)},title:"Editar doadora",children:a.jsx(ca,{className:"w-4 h-4"})})]})})]})});function Fa(s){if(s.raca==="Gir"){const e=[];return s.gpta&&e.push(`GPTA: ${s.gpta}`),s.controle_leiteiro&&e.push(`Controle Leiteiro: ${s.controle_leiteiro}`),s.beta_caseina&&e.push(`Beta Caseina: ${s.beta_caseina}`),s.link_abcz&&e.push("Link ABCZ"),e.length>0?e.join(", "):null}return null}function za(s){if(!s)return"-";switch(s){case"1_estrela":return a.jsx("div",{className:"flex items-center gap-1",children:a.jsx(C,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"})});case"2_estrelas":return a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(C,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"}),a.jsx(C,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"})]});case"3_estrelas":return a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(C,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"}),a.jsx(C,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"}),a.jsx(C,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"})]});case"diamante":return a.jsx("div",{className:"flex items-center gap-1",children:a.jsx(da,{className:"w-4 h-4 fill-blue-500 text-blue-500"})});default:return"-"}}export{Ka as default};
