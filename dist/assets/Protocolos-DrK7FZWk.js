import{r as o,j as e,P as Me,m as Is,R as K,n as zs,o as Es,g as ee,B as T,p as ys,s as D,a as Re,h as Le}from"./index-6OJhfjKP.js";import{C as J,a as ie,b as ne,d as W,c as da}from"./card-D-gf0lmS.js";import{I as ue}from"./input-_UHZ9n1P.js";import{T as ja}from"./textarea-DMqLWH95.js";import{T as We,a as Ke,b as de,c as L,d as Ye,e as G}from"./table-B_Z-CztY.js";import{u as Rs,S as Ce,a as Se,b as Pe,c as we,d as re}from"./select-B7v4ZPbC.js";import{P as Ds,a as Ts,b as ks}from"./popover-CUxnE3Xp.js";import{C as ba,a as Fs,b as Os,c as qs,d as Gs,e as $s,f as Ls}from"./command-B2YX0Sd5.js";import{D as Ve,b as Be,c as He,d as Ze,e as Qe,a as ma}from"./dialog-CFjhGf-B.js";import{B as le}from"./badge-ChTtRB_d.js";import{L as Q}from"./label-BTrzYRkl.js";import{T as ua,a as pa,b as Ae,c as Ie}from"./tabs-DFK_xrkO.js";import{P as Ms}from"./PageHeader-P7sO2uqv.js";import{E as Vs}from"./EmptyState-CEfkJzHC.js";import{f as fe,t as Na}from"./dateUtils-eJ5e6apA.js";import{D as ze,C as Bs}from"./DatePickerBR-CEQaSWUC.js";import{C as _a,Q as Ca}from"./QualidadeSemaforo-3E-fl4SO.js";import{c as Sa,I as Hs,R as Zs}from"./index-ea8B15na.js";import{u as Xe}from"./index-CtR1jODk.js";import{X as Ue}from"./x-kO07YPaG.js";import{C as Qs}from"./circle-check-big-BnGgGwro.js";import{A as Us,a as Js,b as Ws,c as Ks,d as Ys,e as Xs,f as et,g as at}from"./alert-dialog-C4TLnUZs.js";import{C as xa}from"./checkbox-De4S9Zn8.js";import{v as Pa,a as st}from"./receptoraStatus-Bay2bJct.js";import{u as ge}from"./use-toast-DasFaehQ.js";import{h as ha}from"./error-handler-CXUXfXq4.js";import{C as tt,F as ot}from"./filter-cmdSYwTm.js";import{P as rt}from"./plus-Dnfaq_2C.js";import{U as wa}from"./user-plus-CcifB0Ou.js";import{L as it}from"./lock-B1qxSH_C.js";import{S as nt}from"./save-CusHMB-Y.js";import{S as Aa}from"./search-DHWddfjN.js";import{a as ct}from"./chevron-right-BdMx8zjt.js";import{F as lt}from"./file-text-BxNF5_jJ.js";import"./check-CgmfRmMI.js";var Ia="Toggle",ea=o.forwardRef((a,s)=>{const{pressed:n,defaultPressed:i,onPressedChange:t,...d}=a,[r,m]=Xe({prop:n,onChange:t,defaultProp:i??!1,caller:Ia});return e.jsx(Me.button,{type:"button","aria-pressed":r,"data-state":r?"on":"off","data-disabled":a.disabled?"":void 0,...d,ref:s,onClick:Is(a.onClick,()=>{a.disabled||m(!r)})})});ea.displayName=Ia;var za=ea,ce="ToggleGroup",[Ea,xo]=zs(ce,[Sa]),ya=Sa(),aa=K.forwardRef((a,s)=>{const{type:n,...i}=a;if(n==="single"){const t=i;return e.jsx(dt,{...t,ref:s})}if(n==="multiple"){const t=i;return e.jsx(mt,{...t,ref:s})}throw new Error(`Missing prop \`type\` expected on \`${ce}\``)});aa.displayName=ce;var[Ra,Da]=Ea(ce),dt=K.forwardRef((a,s)=>{const{value:n,defaultValue:i,onValueChange:t=()=>{},...d}=a,[r,m]=Xe({prop:n,defaultProp:i??"",onChange:t,caller:ce});return e.jsx(Ra,{scope:a.__scopeToggleGroup,type:"single",value:K.useMemo(()=>r?[r]:[],[r]),onItemActivate:m,onItemDeactivate:K.useCallback(()=>m(""),[m]),children:e.jsx(Ta,{...d,ref:s})})}),mt=K.forwardRef((a,s)=>{const{value:n,defaultValue:i,onValueChange:t=()=>{},...d}=a,[r,m]=Xe({prop:n,defaultProp:i??[],onChange:t,caller:ce}),x=K.useCallback(p=>m((w=[])=>[...w,p]),[m]),C=K.useCallback(p=>m((w=[])=>w.filter(y=>y!==p)),[m]);return e.jsx(Ra,{scope:a.__scopeToggleGroup,type:"multiple",value:r,onItemActivate:x,onItemDeactivate:C,children:e.jsx(Ta,{...d,ref:s})})});aa.displayName=ce;var[ut,pt]=Ea(ce),Ta=K.forwardRef((a,s)=>{const{__scopeToggleGroup:n,disabled:i=!1,rovingFocus:t=!0,orientation:d,dir:r,loop:m=!0,...x}=a,C=ya(n),p=Rs(r),w={role:"group",dir:p,...x};return e.jsx(ut,{scope:n,rovingFocus:t,disabled:i,children:t?e.jsx(Zs,{asChild:!0,...C,orientation:d,dir:p,loop:m,children:e.jsx(Me.div,{...w,ref:s})}):e.jsx(Me.div,{...w,ref:s})})}),ye="ToggleGroupItem",ka=K.forwardRef((a,s)=>{const n=Da(ye,a.__scopeToggleGroup),i=pt(ye,a.__scopeToggleGroup),t=ya(a.__scopeToggleGroup),d=n.value.includes(a.value),r=i.disabled||a.disabled,m={...a,pressed:d,disabled:r},x=K.useRef(null);return i.rovingFocus?e.jsx(Hs,{asChild:!0,...t,focusable:!r,active:d,ref:x,children:e.jsx(fa,{...m,ref:s})}):e.jsx(fa,{...m,ref:s})});ka.displayName=ye;var fa=K.forwardRef((a,s)=>{const{__scopeToggleGroup:n,value:i,...t}=a,d=Da(ye,n),r={role:"radio","aria-checked":a.pressed,"aria-pressed":void 0},m=d.type==="single"?r:void 0;return e.jsx(ea,{...m,...t,ref:s,onPressedChange:x=>{x?d.onItemActivate(i):d.onItemDeactivate(i)}})}),Fa=aa,Oa=ka;const qa=Es("inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground",{variants:{variant:{default:"bg-transparent",outline:"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground"},size:{default:"h-10 px-3",sm:"h-9 px-2.5",lg:"h-11 px-5"}},defaultVariants:{variant:"default",size:"default"}}),xt=o.forwardRef(({className:a,variant:s,size:n,...i},t)=>e.jsx(za,{ref:t,className:ee(qa({variant:s,size:n,className:a})),...i}));xt.displayName=za.displayName;const Ga=o.createContext({size:"default",variant:"default"}),$a=o.forwardRef(({className:a,variant:s,size:n,children:i,...t},d)=>e.jsx(Fa,{ref:d,className:ee("flex items-center justify-center gap-1",a),...t,children:e.jsx(Ga.Provider,{value:{variant:s,size:n},children:i})}));$a.displayName=Fa.displayName;const Je=o.forwardRef(({className:a,children:s,variant:n,size:i,...t},d)=>{const r=o.useContext(Ga);return e.jsx(Oa,{ref:d,className:ee(qa({variant:r.variant||n,size:r.size||i}),a),...t,children:s})});Je.displayName=Oa.displayName;function La({ciclandoValue:a,qualidadeValue:s,onChangeCiclando:n,onChangeQualidade:i,disabled:t=!1,size:d="sm"}){const r=d==="sm"?"text-xs":"text-sm",m=d==="sm"?"w-4 h-4":"w-5 h-5";return e.jsxs("div",{className:"flex flex-wrap items-center gap-3 text-slate-600",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:ee("text-slate-500 font-medium",r),children:"Ciclo:"}),e.jsxs($a,{type:"single",value:a||void 0,onValueChange:x=>{t||n(x==="CL"||x==="N"?x:null)},disabled:t,className:"gap-1",children:[e.jsx(Je,{value:"CL","aria-label":"CL",size:"sm",variant:"outline",className:ee("h-7 px-2 text-xs",a==="CL"&&"bg-blue-100 text-blue-700 border-blue-300 data-[state=on]:bg-blue-100",t&&"opacity-60"),children:"CL"}),e.jsx(Je,{value:"N","aria-label":"N",size:"sm",variant:"outline",className:ee("h-7 px-2 text-xs",a==="N"&&"bg-slate-100 text-slate-700 border-slate-300 data-[state=on]:bg-slate-100",t&&"opacity-60"),children:"N"})]}),a&&!t&&e.jsx(T,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 text-slate-400 hover:text-slate-600",onClick:()=>n(null),type:"button",children:e.jsx(Ue,{className:"w-3 h-3"})}),!a&&e.jsx("span",{className:ee("text-slate-300",r),children:"—"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:ee("text-slate-500 font-medium",r),children:"Qualidade:"}),e.jsx("div",{className:"flex items-center gap-1.5",children:[1,2,3].map(x=>e.jsx("button",{type:"button",disabled:t,onClick:()=>{t||i(s===x?null:x)},className:ee(m,"rounded-full border-2 transition-all",ys(x),s===x?"border-slate-900 scale-110 ring-2 ring-slate-300":"border-slate-300 opacity-50 hover:opacity-75 hover:scale-105",t&&"opacity-40 cursor-not-allowed",!t&&"cursor-pointer"),title:`Qualidade ${x}`},x))}),s&&!t&&e.jsx(T,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 text-slate-400 hover:text-slate-600",onClick:()=>i(null),type:"button",children:e.jsx(Ue,{className:"w-3 h-3"})}),!s&&e.jsx("span",{className:ee("text-slate-300",r),children:"—"})]})]})}function ga({fazendaNome:a,dataInicio:s,veterinario:n,tecnico:i,passo2Data:t,passo2Tecnico:d,showPasso2:r=!1}){return e.jsxs(J,{children:[e.jsx(ie,{className:"pb-3",children:e.jsx(ne,{className:"text-base",children:"Informações do Protocolo"})}),e.jsx(W,{children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(me,{label:"Fazenda",value:a}),e.jsx(me,{label:"Data Início",value:fe(s)}),n&&e.jsx(me,{label:"Veterinário",value:n}),i&&e.jsx(me,{label:"Técnico",value:i}),r&&e.jsxs(e.Fragment,{children:[e.jsx(me,{label:"Data 2º Passo",value:t?fe(t):"-"}),e.jsx(me,{label:"Técnico 2º Passo",value:d||"-"})]})]})})]})}function me({label:a,value:s}){return e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:a}),e.jsx("p",{className:"text-base text-slate-900",children:s})]})}function ht({pendentes:a,confirmadas:s,descartadas:n}){return e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs(J,{className:"border-slate-200",children:[e.jsx(ie,{className:"pb-2",children:e.jsx(ne,{className:"text-sm font-medium text-slate-500",children:"Aguardando"})}),e.jsx(W,{children:e.jsx("p",{className:"text-3xl font-bold text-slate-900",children:a})})]}),e.jsxs(J,{className:"border-green-200 bg-green-50/50",children:[e.jsx(ie,{className:"pb-2",children:e.jsx(ne,{className:"text-sm font-medium text-green-700",children:"Confirmadas"})}),e.jsx(W,{children:e.jsx("p",{className:"text-3xl font-bold text-green-600",children:s})})]}),e.jsxs(J,{className:"border-red-200 bg-red-50/50",children:[e.jsx(ie,{className:"pb-2",children:e.jsx(ne,{className:"text-sm font-medium text-red-700",children:"Descartadas"})}),e.jsx(W,{children:e.jsx("p",{className:"text-3xl font-bold text-red-600",children:n})})]})]})}function va({open:a,onClose:s,step:n,fazendaNome:i,dataInicio:t,totalReceptoras:d,receptorasConfirmadas:r,receptorasDescartadas:m=0}){const x=n===1,C=x?"1º Passo Concluído":"2º Passo Concluído",p=x?"Protocolo criado com sucesso":"Revisão das receptoras concluída",w=x?"As receptoras estão em sincronização":"As receptoras confirmadas estão prontas para TE";return e.jsx(Ve,{open:a,onOpenChange:()=>s(),children:e.jsxs(Be,{className:"max-w-lg",children:[e.jsxs(He,{children:[e.jsxs(Ze,{className:"flex items-center gap-2",children:[e.jsx(Qs,{className:"w-6 h-6 text-green-600"}),C]}),e.jsx(Qe,{children:p})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 p-4 bg-slate-50 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Fazenda"}),e.jsx("p",{className:"text-base text-slate-900",children:i})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Data do Protocolo"}),e.jsx("p",{className:"text-base text-slate-900",children:fe(t)})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"p-4 bg-green-50 border border-green-200 rounded-lg text-center",children:[e.jsx("p",{className:"text-sm font-medium text-green-700 mb-1",children:x?"Receptoras Adicionadas":"Confirmadas para TE"}),e.jsx("p",{className:"text-3xl font-bold text-green-600",children:r})]}),!x&&e.jsxs("div",{className:"p-4 bg-red-50 border border-red-200 rounded-lg text-center",children:[e.jsx("p",{className:"text-sm font-medium text-red-700 mb-1",children:"Descartadas"}),e.jsx("p",{className:"text-3xl font-bold text-red-600",children:m})]}),x&&e.jsxs("div",{className:"p-4 bg-blue-50 border border-blue-200 rounded-lg text-center",children:[e.jsx("p",{className:"text-sm font-medium text-blue-700 mb-1",children:"Total no Protocolo"}),e.jsx("p",{className:"text-3xl font-bold text-blue-600",children:d})]})]}),e.jsx("div",{className:"p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("strong",{children:"Próximos passos:"})," ",w]})}),e.jsx(T,{onClick:s,className:"w-full",children:"OK - Voltar para Protocolos"})]})]})})}function ft({open:a,onOpenChange:s,onConfirm:n,title:i="Sair sem salvar?",description:t="Se você sair agora, todas as alterações serão perdidas."}){return e.jsx(Us,{open:a,onOpenChange:s,children:e.jsxs(Js,{children:[e.jsxs(Ws,{children:[e.jsx(Ks,{children:i}),e.jsx(Ys,{children:t})]}),e.jsxs(Xs,{children:[e.jsx(et,{children:"Cancelar"}),e.jsx(at,{onClick:n,children:"Sim, sair"})]})]})})}function gt({receptoras:a,motivosInapta:s,isFinalized:n,onStatusChange:i,onMotivoChange:t}){const d=r=>{const x={INICIADA:{label:"Aguardando",className:"bg-slate-100 text-slate-700 border-slate-200"},APTA:{label:"Confirmada",className:"bg-green-100 text-green-700 border-green-200"},INAPTA:{label:"Descartada",className:"bg-red-100 text-red-700 border-red-200"}}[r]||{label:r,className:""};return e.jsx(le,{variant:"outline",className:x.className,children:x.label})};return e.jsxs(J,{children:[e.jsx(ie,{className:"pb-3",children:e.jsxs(ne,{className:"text-base",children:["Receptoras para Revisão (",a.length,")"]})}),e.jsx(W,{children:e.jsx("div",{className:"rounded-lg border overflow-hidden",children:e.jsxs(We,{children:[e.jsx(Ke,{children:e.jsxs(de,{className:"bg-slate-50",children:[e.jsx(L,{className:"font-semibold",children:"Brinco"}),e.jsx(L,{className:"font-semibold",children:"Nome"}),e.jsx(L,{className:"font-semibold",children:"Ciclando"}),e.jsx(L,{className:"font-semibold",children:"Qualidade"}),e.jsx(L,{className:"font-semibold",children:"Avaliação"}),e.jsx(L,{className:"font-semibold",children:"Motivo (se INAPTA)"})]})}),e.jsx(Ye,{children:a.length===0?e.jsx(de,{children:e.jsx(G,{colSpan:6,className:"text-center text-slate-500 py-8",children:"Nenhuma receptora no protocolo"})}):a.map(r=>e.jsxs(de,{className:"hover:bg-slate-50/50",children:[e.jsx(G,{className:"font-medium",children:r.identificacao}),e.jsx(G,{className:"text-slate-600",children:r.nome||"-"}),e.jsx(G,{children:e.jsx(_a,{value:r.pr_ciclando_classificacao,variant:"display",disabled:!0})}),e.jsx(G,{children:e.jsx(Ca,{value:r.pr_qualidade_semaforo,variant:"single",disabled:!0})}),e.jsx(G,{children:n?d(r.pr_status):e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(xa,{id:`apta-${r.id}`,checked:r.pr_status==="APTA",onCheckedChange:m=>{m?i(r.id,"APTA"):i(r.id,"INICIADA")},className:"data-[state=checked]:bg-green-600 data-[state=checked]:border-green-600"}),e.jsx(Q,{htmlFor:`apta-${r.id}`,className:"text-sm font-medium cursor-pointer text-green-700",children:"APTA"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(xa,{id:`inapta-${r.id}`,checked:r.pr_status==="INAPTA",onCheckedChange:m=>{m?i(r.id,"INAPTA"):i(r.id,"INICIADA")},className:"data-[state=checked]:bg-red-600 data-[state=checked]:border-red-600"}),e.jsx(Q,{htmlFor:`inapta-${r.id}`,className:"text-sm font-medium cursor-pointer text-red-700",children:"INAPTA"})]})]})}),e.jsx(G,{children:r.pr_status==="INAPTA"&&!n?e.jsx(ue,{type:"text",placeholder:"Justificativa (opcional)",value:s[r.id]||r.pr_motivo_inapta||"",onChange:m=>t(r.id,m.target.value),className:"w-full max-w-[200px]"}):e.jsx("span",{className:"text-slate-500 text-sm",children:r.pr_motivo_inapta||"-"})})]},r.id))})]})})})]})}function vt(){const{toast:a}=ge(),[s,n]=o.useState(!1),[i,t]=o.useState(!1),[d,r]=o.useState([]),[m,x]=o.useState([]),[C,p]=o.useState([]),[w,y]=o.useState({fazenda_id:"",data_inicio:Na(),veterinario:"",tecnico:"",observacoes:""}),A=o.useCallback(async()=>{try{n(!0);const{data:_,error:c}=await D.from("fazendas").select("*").order("nome",{ascending:!0});if(c)throw c;r(_||[])}catch(_){a({title:"Erro ao carregar fazendas",description:_ instanceof Error?_.message:"Erro desconhecido",variant:"destructive"})}finally{n(!1)}},[a]),k=o.useCallback(async _=>{try{t(!0);const{data:c,error:S}=await D.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",_);if(S)throw S;const I=(c==null?void 0:c.map(v=>v.receptora_id))||[];if(I.length===0){x([]),p([]);return}const{data:E,error:M}=await D.from("receptoras").select("id, identificacao, nome, status_reprodutivo").in("id",I).order("identificacao",{ascending:!0});if(M)throw M;const Y=(E||[]).filter(v=>(v.id?String(v.id).trim():"")!=="").map(async v=>{if(!(v.id?String(v.id).trim():""))return null;const P=v.status_reprodutivo||"VAZIA",F=Pa(P,"ENTRAR_PASSO1");return{...v,status:P,motivoIndisponivel:F.valido?void 0:F.mensagem}}),f=(await Promise.all(Y)).filter(v=>v!==null),b=f.filter(v=>v.status==="VAZIA");x(b),p(f)}catch(c){a({title:"Erro ao carregar receptoras",description:c instanceof Error?c.message:"Erro desconhecido",variant:"destructive"})}finally{t(!1)}},[a]),R=o.useCallback(_=>new Set(_.filter(c=>c.id&&c.id.trim()!==""&&c.id!==null&&c.id!==void 0).map(c=>String(c.id).trim())),[]),g=o.useCallback(_=>m.filter(c=>{const S=c.id?String(c.id).trim():"";return S!==""&&!_.has(S)}),[m]),z=o.useCallback((_,c)=>{if(!_.trim())return C.filter(I=>{const E=I.id?String(I.id).trim():"";return E!==""&&!c.has(E)&&I.status==="VAZIA"}).map(I=>({...I,disponivel:!0}));const S=_.toLowerCase().trim();return C.filter(I=>{const E=I.id?String(I.id).trim():"";if(E===""||c.has(E))return!1;const M=(I.identificacao||"").toLowerCase(),Z=(I.nome||"").toLowerCase();return M.includes(S)||Z.includes(S)}).map(I=>({...I,disponivel:I.status==="VAZIA"}))},[C]),h=o.useCallback(_=>{var c;return((c=d.find(S=>S.id===_))==null?void 0:c.nome)||"-"},[d]);return{loading:s,loadingReceptoras:i,fazendas:d,allReceptoras:m,receptorasComStatus:C,protocoloData:w,setProtocoloData:y,loadFazendas:A,loadAllReceptoras:k,getSelectedIds:R,getAvailableReceptoras:g,getReceptorasFiltradas:z,getFazendaNome:h}}function jt({fazendaId:a,allReceptoras:s,receptorasComStatus:n,selectedIds:i,onReceptorasReload:t}){const{toast:d}=ge(),[r,m]=o.useState([]),[x,C]=o.useState(!1),[p,w]=o.useState(!1),[y,A]=o.useState(""),[k,R]=o.useState(!1),[g,z]=o.useState({receptora_id:"",observacoes:"",ciclando_classificacao:null,qualidade_semaforo:null}),[h,_]=o.useState({identificacao:"",nome:"",observacoes:"",ciclando_classificacao:null,qualidade_semaforo:null}),[c,S]=o.useState(!1),I=o.useCallback(()=>{z({receptora_id:"",observacoes:"",ciclando_classificacao:null,qualidade_semaforo:null}),A(""),R(!1)},[]),E=o.useCallback(()=>{_({identificacao:"",nome:"",observacoes:"",ciclando_classificacao:null,qualidade_semaforo:null})},[]),M=o.useCallback(async()=>{var F;const b=((F=g.receptora_id)==null?void 0:F.trim())||"";if(!b){d({title:"Erro",description:"Selecione uma receptora",variant:"destructive"});return}const v=s.find(q=>(q.id?String(q.id).trim():"")===b);if(!v||!v.id){d({title:"Erro",description:"Receptora não encontrada ou inválida",variant:"destructive"});return}const u=v.status_reprodutivo||"VAZIA",P=Pa(u,"ENTRAR_PASSO1");if(!P.valido){d({title:"Erro de validação",description:P.mensagem||"A receptora não pode entrar no protocolo no estado atual",variant:"destructive"});return}if(i.has(b)){d({title:"Receptora já adicionada",description:"Esta receptora já está na lista de selecionadas",variant:"destructive"});return}m(q=>{var N;return q.some(V=>(V.id?String(V.id).trim():"")===b)?q:[...q,{id:v.id,identificacao:v.identificacao,nome:v.nome,observacoes:((N=g.observacoes)==null?void 0:N.trim())||void 0,ciclando_classificacao:g.ciclando_classificacao||null,qualidade_semaforo:g.qualidade_semaforo||null}]}),I(),C(!1)},[g,s,i,d,I]),Z=o.useCallback(async()=>{if(!h.identificacao.trim()){d({title:"Erro de validação",description:"Identificação (brinco) é obrigatória",variant:"destructive"});return}try{S(!0);const{data:b,error:v}=await D.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",a);if(v)throw v;const u=(b==null?void 0:b.map(N=>N.receptora_id))||[];if(u.length>0){const{data:N,error:V}=await D.from("receptoras").select("id, identificacao, nome").in("id",u).ilike("identificacao",h.identificacao.trim());if(V)throw V;if(N&&N.length>0){const B=N[0].nome?`"${N[0].nome}"`:"sem nome";throw new Error(`Já existe uma receptora com o brinco "${h.identificacao.trim()}" nesta fazenda (Nome: ${B}).`)}}if(h.nome.trim()&&u.length>0){const{data:N,error:V}=await D.from("receptoras").select("id, identificacao").in("id",u).ilike("nome",h.nome.trim());if(V)throw V;if(N&&N.length>0)throw new Error(`Já existe uma receptora com o nome "${h.nome.trim()}" nesta fazenda (Brinco: ${N[0].identificacao}).`)}const P={identificacao:h.identificacao};h.nome.trim()&&(P.nome=h.nome);const{data:F,error:q}=await D.from("receptoras").insert([P]).select().single();if(q)throw q.code==="23505"?new Error("Já existe uma receptora com esse brinco nesta fazenda."):q;const{error:U}=await D.from("receptora_fazenda_historico").insert([{receptora_id:F.id,fazenda_id:a,data_inicio:Na(),data_fim:null}]);m(N=>[...N,{id:F.id,identificacao:F.identificacao,nome:F.nome,observacoes:h.observacoes||void 0,ciclando_classificacao:h.ciclando_classificacao||null,qualidade_semaforo:h.qualidade_semaforo||null,isNew:!0}]),E(),w(!1),await t()}catch(b){d({title:"Erro ao criar receptora",description:b instanceof Error?b.message:"Erro desconhecido",variant:"destructive"})}finally{S(!1)}},[h,a,d,E,t]),Y=o.useCallback(b=>{m(v=>v.filter((u,P)=>P!==b))},[]),j=o.useCallback((b,v)=>{m(u=>u.map((P,F)=>F===b?{...P,ciclando_classificacao:v}:P))},[]),f=o.useCallback((b,v)=>{m(u=>u.map((P,F)=>F===b?{...P,qualidade_semaforo:v}:P))},[]);return{receptorasLocais:r,setReceptorasLocais:m,showAddReceptora:x,setShowAddReceptora:C,showCreateReceptora:p,setShowCreateReceptora:w,buscaReceptora:y,setBuscaReceptora:A,popoverAberto:k,setPopoverAberto:R,addReceptoraForm:g,setAddReceptoraForm:z,createReceptoraForm:h,setCreateReceptoraForm:_,submitting:c,handleAddReceptora:M,handleCreateReceptora:Z,handleRemoveReceptora:Y,handleUpdateCiclando:j,handleUpdateQualidade:f,resetAddForm:I,resetCreateForm:E}}function bt({protocoloData:a,receptorasLocais:s}){const n=Re(),{toast:i}=ge(),[t,d]=o.useState(!1),[r,m]=o.useState(!1),[x,C]=o.useState(!1),p=o.useRef(!1),w=o.useCallback(()=>!a.fazenda_id||!a.data_inicio||!a.veterinario.trim()||!a.tecnico.trim()?(i({title:"Erro de validação",description:"Fazenda, data de início, veterinário e técnico são obrigatórios",variant:"destructive"}),!1):!0,[a,i]),y=o.useCallback(async()=>{if(p.current||t)return;if(s.length===0){i({title:"Erro de validação",description:"Adicione pelo menos 1 receptora antes de finalizar o 1º passo",variant:"destructive"});return}if(s.filter(c=>!c.id||c.id===""||c.id===null||c.id===void 0).length>0){i({title:"Erro de validação",description:"Seleção de receptora inválida. Refaça a seleção.",variant:"destructive"});return}const R=s.filter(c=>c.id&&c.id!==""&&c.id!==null&&c.id!==void 0);if(R.length!==s.length||R.length===0){i({title:"Erro de validação",description:"Seleção de receptora inválida. Refaça a seleção.",variant:"destructive"});return}const g=R.map(c=>c.id),z=R.map(c=>c.observacoes||null),h=R.map(c=>c.ciclando_classificacao||null),_=R.map(c=>c.qualidade_semaforo||null);try{p.current=!0,d(!0);const c=`VET: ${a.veterinario.trim()} | TEC: ${a.tecnico.trim()}`,{data:S,error:I}=await D.rpc("criar_protocolo_passo1_atomico",{p_fazenda_id:a.fazenda_id,p_data_inicio:a.data_inicio,p_responsavel_inicio:c,p_receptoras_ids:g,p_data_inclusao:a.data_inicio,p_observacoes:a.observacoes.trim()||null,p_receptoras_observacoes:z});if(I)throw I;if(!S)throw new Error("Protocolo criado mas ID não retornado");const{data:E,error:M}=await D.from("protocolo_receptoras").select("id, receptora_id").eq("protocolo_id",S).in("receptora_id",g);if(!M&&E&&E.length>0){const j=new Map(g.map((u,P)=>[u,P])),f=E.map(async u=>{const P=j.get(u.receptora_id);if(P===void 0)return{success:!0};const F=h[P],q=_[P],{error:U}=await D.from("protocolo_receptoras").update({ciclando_classificacao:F,qualidade_semaforo:q}).eq("id",u.id);return{success:!U,error:U}}),v=(await Promise.allSettled(f)).filter(u=>u.status==="rejected"||u.status==="fulfilled"&&u.value&&!u.value.success);v.length>0&&i({title:"Aviso",description:`Protocolo criado, mas ${v.length} classificação(ões) não foram salvas. Edite o protocolo para corrigir.`,variant:"destructive"})}if((await Promise.all(g.map(j=>st(j,"EM_SINCRONIZACAO")))).map((j,f)=>({result:j,receptoraId:g[f]})).filter(({result:j})=>j.error).length>0)throw new Error("Erro ao atualizar status das receptoras. Tente novamente.");C(!0)}catch(c){const S=c instanceof Error?c.message:"Erro desconhecido ao finalizar protocolo";i({title:"Erro ao finalizar protocolo",description:S,variant:"destructive"})}finally{d(!1),p.current=!1}},[a,s,i,n,t]),A=o.useCallback(()=>{m(!1),n("/protocolos")},[n]);return{submitting:t,showConfirmExit:r,setShowConfirmExit:m,showResumo:x,setShowResumo:C,handleFinalizarPasso1:y,handleConfirmExit:A,validateProtocoloForm:w}}const Ma="protocolos_filtros",Ee=50,Nt=()=>{try{const a=localStorage.getItem(Ma);return a?JSON.parse(a):{}}catch{return{}}};function _t(){const a=Nt(),[s,n]=o.useState(!0),[i,t]=o.useState(!1),[d,r]=o.useState([]),[m,x]=o.useState([]),[C,p]=o.useState(0),w=a.filtroStatus&&a.filtroStatus!=="all"?a.filtroStatus:"aguardando_2_passo",[y,A]=o.useState(w),[k,R]=o.useState(a.fazendaFilter??""),[g,z]=o.useState(a.filtroDataInicio??""),[h,_]=o.useState(a.filtroDataFim??""),[c,S]=o.useState(a.protocolosPage??1);o.useEffect(()=>{const j={filtroStatus:y,fazendaFilter:k,filtroDataInicio:g,filtroDataFim:h,protocolosPage:c};localStorage.setItem(Ma,JSON.stringify(j))},[y,k,g,h,c]);const I=o.useCallback(async()=>{const{data:j,error:f}=await D.from("fazendas").select("*").order("nome",{ascending:!0});if(f)throw f;x(j||[])},[]),E=o.useCallback(async(j,f)=>{try{t(!0);const b=(f==null?void 0:f.fazendaFilter)!==void 0?f.fazendaFilter:k,v=(f==null?void 0:f.filtroDataInicio)!==void 0?f.filtroDataInicio:g,u=(f==null?void 0:f.filtroDataFim)!==void 0?f.filtroDataFim:h,P=(f==null?void 0:f.filtroStatus)!==void 0?f.filtroStatus:y,q=((j!==void 0?j:c)-1)*Ee,U=q+Ee*2-1;let N=D.from("protocolos_sincronizacao").select("*",{count:"exact"});b&&b!=="all"&&(N=N.eq("fazenda_id",b)),v&&(N=N.gte("data_inicio",v)),u&&(N=N.lte("data_inicio",u)),P==="aguardando_2_passo"?N=N.in("status",["PASSO1_FECHADO","PRIMEIRO_PASSO_FECHADO"]):P==="sincronizado"?N=N.in("status",["SINCRONIZADO","PASSO2_FECHADO"]):P==="fechado"&&(N=N.in("status",["FECHADO","EM_TE"])),N=N.order("data_inicio",{ascending:!1}).range(q,U);const{data:V,error:B,count:De}=await N;if(B)throw B;const Te=(V||[]).map($=>$.id),ke=[...new Set((V||[]).map($=>$.fazenda_id))],{data:Fe}=await D.from("protocolo_receptoras").select("protocolo_id").in("protocolo_id",Te),Oe=(Fe||[]).reduce(($,X)=>($[X.protocolo_id]=($[X.protocolo_id]||0)+1,$),{}),{data:pe}=await D.from("fazendas").select("id, nome").in("id",ke),qe=(pe||[]).reduce(($,X)=>($[X.id]=X.nome,$),{}),Ge=(V||[]).map($=>{const X=Oe[$.id]||0;return X===0?null:{...$,fazenda_nome:qe[$.fazenda_id]||"N/A",receptoras_count:X}}).filter($=>$!==null).slice(0,Ee);r(Ge),p(De||0)}catch(b){ha(b,"Erro ao carregar protocolos"),r([])}finally{t(!1)}},[k,g,h,y,c]),M=o.useCallback(async()=>{try{n(!0),await I(),await E()}catch(j){ha(j,"Erro ao carregar dados")}finally{n(!1)}},[I,E]),Z=o.useCallback(()=>{R(""),z(""),_(""),A("all"),S(1)},[]),Y=o.useCallback(j=>{const f=new Date,b=new Date(f);b.setDate(f.getDate()-j),z(b.toISOString().split("T")[0]),_(f.toISOString().split("T")[0])},[]);return{loading:s,loadingProtocolos:i,protocolos:d,fazendas:m,protocolosTotalCount:C,filtroStatus:y,setFiltroStatus:A,fazendaFilter:k,setFazendaFilter:R,filtroDataInicio:g,setFiltroDataInicio:z,filtroDataFim:h,setFiltroDataFim:_,protocolosPage:c,setProtocolosPage:S,pageSize:Ee,loadData:M,loadProtocolos:E,limparFiltros:Z,aplicarAtalhoData:Y}}function Ct(){const a=Re(),{toast:s}=ge(),[n,i]=o.useState(!0),[t,d]=o.useState(null),[r,m]=o.useState(""),[x,C]=o.useState([]),p=o.useCallback(async y=>{try{const{data:A,error:k}=await D.from("protocolo_receptoras").select("*").eq("protocolo_id",y);if(k){s({title:"Erro ao carregar receptoras",description:k.message,variant:"destructive"}),C([]);return}if(!A||A.length===0){s({title:"Erro: Protocolo inconsistente",description:"Este protocolo não possui receptoras vinculadas.",variant:"destructive"}),C([]);return}const R=[];for(const g of A){const{data:z,error:h}=await D.from("receptoras").select("*").eq("id",g.receptora_id).single();h||R.push({...z,pr_id:g.id,pr_status:g.status,pr_motivo_inapta:g.motivo_inapta,pr_observacoes:g.observacoes,pr_ciclando_classificacao:"ciclando_classificacao"in g&&(g.ciclando_classificacao==="CL"||g.ciclando_classificacao==="N")?g.ciclando_classificacao:null,pr_qualidade_semaforo:"qualidade_semaforo"in g&&typeof g.qualidade_semaforo=="number"&&g.qualidade_semaforo>=1&&g.qualidade_semaforo<=3?g.qualidade_semaforo:null})}C(R)}catch(A){s({title:"Erro ao carregar receptoras",description:A instanceof Error?A.message:"Erro desconhecido",variant:"destructive"})}},[s]),w=o.useCallback(async y=>{try{i(!0);const{data:A,error:k}=await D.from("protocolos_sincronizacao").select("*").eq("id",y).single();if(k)throw k;if(A.status!=="PASSO1_FECHADO"&&A.status!=="PRIMEIRO_PASSO_FECHADO"&&A.status!=="SINCRONIZADO"){s({title:"Erro",description:"Este protocolo não está aguardando o 2º passo",variant:"destructive"}),a("/protocolos");return}d(A);const{data:R,error:g}=await D.from("fazendas").select("nome").eq("id",A.fazenda_id).single();if(g)throw g;m(R.nome),await p(y)}catch(A){s({title:"Erro ao carregar dados",description:A instanceof Error?A.message:"Erro desconhecido",variant:"destructive"})}finally{i(!1)}},[a,s,p]);return{loading:n,protocolo:t,setProtocolo:d,fazendaNome:r,receptoras:x,setReceptoras:C,loadData:w,loadReceptoras:p}}function St({protocoloId:a,protocolo:s,receptoras:n,setReceptoras:i,setProtocolo:t,passo2Form:d,motivosInapta:r}){const m=Re(),{toast:x}=ge(),[C,p]=o.useState(!1),[w,y]=o.useState(!1),A=o.useCallback((z,h)=>{i(_=>_.map(c=>c.id===z?{...c,pr_status:h,pr_motivo_inapta:h==="APTA"||h==="INICIADA"?void 0:c.pr_motivo_inapta}:c))},[i]),k=o.useCallback((z,h)=>{i(_=>_.map(c=>c.id===z?{...c,pr_motivo_inapta:h.trim()||void 0}:c))},[i]),R=o.useCallback(async()=>{if(C)return;if(!d.data||!d.tecnico.trim()){x({title:"Erro de validação",description:"Data e técnico responsável são obrigatórios",variant:"destructive"});return}const z=n.filter(h=>h.pr_status==="INICIADA");if(z.length>0){x({title:"Erro",description:`Ainda há ${z.length} receptora(s) pendente(s) de revisão`,variant:"destructive"});return}if(n.length===0){x({title:"Erro",description:"Não é possível finalizar protocolo sem receptoras",variant:"destructive"});return}try{p(!0);const h=new Date,_=`${h.getFullYear()}-${String(h.getMonth()+1).padStart(2,"0")}-${String(h.getDate()).padStart(2,"0")}`,c=n.filter(j=>j.pr_status==="APTA"),S=n.filter(j=>j.pr_status==="INAPTA"),E=c.length>0?"SINCRONIZADO":"FECHADO",M=[...c.map(async j=>{const{error:f}=await D.from("protocolo_receptoras").update({status:"APTA",motivo_inapta:null}).eq("protocolo_id",a).eq("receptora_id",j.id);if(f)throw f}),...S.map(async j=>{const f=r[j.id]||j.pr_motivo_inapta||null,{error:b}=await D.from("protocolo_receptoras").update({status:"INAPTA",motivo_inapta:f}).eq("protocolo_id",a).eq("receptora_id",j.id);if(b)throw b})];await Promise.all(M);const{error:Z}=await D.from("protocolos_sincronizacao").update({status:E,passo2_data:d.data,passo2_tecnico_responsavel:d.tecnico.trim(),data_retirada:_,responsavel_retirada:(s==null?void 0:s.responsavel_inicio)||null}).eq("id",a);if(Z)throw Z;t({...s,status:E,passo2_data:d.data,passo2_tecnico_responsavel:d.tecnico.trim(),data_retirada:_,responsavel_retirada:(s==null?void 0:s.responsavel_inicio)||null});const Y=[...c.map(async j=>{const{error:f}=await D.from("receptoras").update({status_reprodutivo:"SINCRONIZADA"}).eq("id",j.id);if(f)throw f}),...S.map(async j=>{const{error:f}=await D.from("receptoras").update({status_reprodutivo:"VAZIA"}).eq("id",j.id);if(f)throw f})];await Promise.all(Y),y(!0)}catch(h){x({title:"Erro ao finalizar 2º passo",description:h instanceof Error?h.message:"Erro desconhecido",variant:"destructive"})}finally{p(!1)}},[C,d,n,a,s,r,t,x]),g=o.useCallback(()=>{y(!1);const z=n.filter(h=>h.pr_status==="APTA").length;x({title:"2º passo concluído com sucesso",description:`${z} receptoras confirmadas para TE`}),m("/protocolos")},[n,m,x]);return{submitting:C,showResumo:w,setShowResumo:y,handleStatusChange:A,handleMotivoChange:k,handleFinalizarPasso2:R,handleCloseResumo:g}}function ho(){const a=Re(),[s,n]=o.useState("nova-sessao"),[i,t]=o.useState("passo1"),{loading:d,loadingProtocolos:r,protocolos:m,fazendas:x,filtroStatus:C,setFiltroStatus:p,fazendaFilter:w,setFazendaFilter:y,filtroDataInicio:A,setFiltroDataInicio:k,filtroDataFim:R,setFiltroDataFim:g,protocolosPage:z,setProtocolosPage:h,pageSize:_,loadData:c,loadProtocolos:S,limparFiltros:I,aplicarAtalhoData:E}=_t(),[M,Z]=o.useState("form"),{loading:Y,loadingReceptoras:j,fazendas:f,allReceptoras:b,receptorasComStatus:v,protocoloData:u,setProtocoloData:P,loadFazendas:F,loadAllReceptoras:q,getSelectedIds:U,getReceptorasFiltradas:N,getFazendaNome:V}=vt(),{receptorasLocais:B,setReceptorasLocais:De,showAddReceptora:Te,setShowAddReceptora:ke,showCreateReceptora:Fe,setShowCreateReceptora:Oe,buscaReceptora:pe,setBuscaReceptora:qe,popoverAberto:sa,setPopoverAberto:Ge,addReceptoraForm:$,setAddReceptoraForm:X,createReceptoraForm:Va,setCreateReceptoraForm:Ba,submitting:Ha,handleAddReceptora:Za,handleCreateReceptora:Qa,handleRemoveReceptora:Ua,handleUpdateCiclando:Ja,handleUpdateQualidade:Wa,resetAddForm:Ka,resetCreateForm:Ya}=jt({fazendaId:u.fazenda_id,allReceptoras:b,receptorasComStatus:v,selectedIds:U([]),onReceptorasReload:()=>q(u.fazenda_id)}),{submitting:Xa,showConfirmExit:es,setShowConfirmExit:as,showResumo:ss,setShowResumo:ts,handleFinalizarPasso1:os,handleConfirmExit:rs,validateProtocoloForm:is}=bt({protocoloData:u,receptorasLocais:B}),ve=Ha||Xa,[ae,$e]=o.useState(""),[se,je]=o.useState({data:new Date().toISOString().split("T")[0],tecnico:""}),[ta,be]=o.useState({}),[Et,yt]=o.useState(!1),{loading:ns,protocolo:H,setProtocolo:oa,fazendaNome:ra,receptoras:te,setReceptoras:ia,loadData:na}=Ct(),{submitting:ca,showResumo:cs,handleStatusChange:ls,handleMotivoChange:ds,handleFinalizarPasso2:ms,handleCloseResumo:us}=St({protocoloId:ae,protocolo:H,receptoras:te,setReceptoras:ia,setProtocolo:oa,passo2Form:se,motivosInapta:ta}),la=o.useMemo(()=>U(B),[U,B]),ps=o.useMemo(()=>N(pe,la),[N,pe,la]),xe=o.useMemo(()=>m.filter(l=>l.status==="PASSO1_FECHADO"||l.status==="PRIMEIRO_PASSO_FECHADO"),[m]),oe=o.useMemo(()=>({pendentes:te.filter(l=>l.pr_status==="INICIADA").length,confirmadas:te.filter(l=>l.pr_status==="APTA").length,descartadas:te.filter(l=>l.pr_status==="INAPTA").length}),[te]),Ne=(H==null?void 0:H.status)==="SINCRONIZADO",xs=oe.pendentes===0&&se.data&&se.tecnico.trim();o.useEffect(()=>{c(),F()},[c,F]),o.useEffect(()=>{M==="receptoras"&&u.fazenda_id&&q(u.fazenda_id)},[M,u.fazenda_id,q]),o.useEffect(()=>{ae&&na(ae)},[ae,na]),o.useEffect(()=>{if(H){(H.passo2_data||H.passo2_tecnico_responsavel)&&je({data:H.passo2_data||new Date().toISOString().split("T")[0],tecnico:H.passo2_tecnico_responsavel||""});const l={};te.filter(O=>O.pr_status==="INAPTA"&&O.pr_motivo_inapta).forEach(O=>{l[O.id]=O.pr_motivo_inapta||""}),be(l)}},[H,te]);const hs=()=>{h(1),S(1,{fazendaFilter:w,filtroDataInicio:A,filtroDataFim:R,filtroStatus:C})},fs=()=>{I(),S(1,{fazendaFilter:"",filtroDataInicio:"",filtroDataFim:"",filtroStatus:"all"})},gs=async()=>{const l=Math.max(1,z-1);h(l),await S(l)},vs=async()=>{const l=z+1;h(l),await S(l)},js=()=>{is()&&Z("receptoras")},bs=()=>{M==="receptoras"&&Z("form")},Ns=()=>{Z("form"),P({fazenda_id:"",data_inicio:new Date().toISOString().split("T")[0],veterinario:"",tecnico:"",observacoes:""}),De([])},_s=()=>{ts(!1),Ns(),S(1)},Cs=(l,O)=>{ls(l,O),(O==="APTA"||O==="INICIADA")&&be(he=>{const _e={...he};return delete _e[l],_e})},Ss=(l,O)=>{ds(l,O),be(he=>({...he,[l]:O.trim()}))},Ps=()=>{$e(""),oa(null),ia([]),je({data:new Date().toISOString().split("T")[0],tecnico:""}),be({})},ws=()=>{us(),Ps(),S(1)},As=l=>{if(!l)return"-";const[O,he,_e]=l.split("-");return`${_e}/${he}/${O}`};return d?e.jsx(Le,{}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(Ms,{title:"Protocolos de Sincronização",description:"Gerenciar protocolos em 2 passos"}),e.jsxs(ua,{value:s,onValueChange:l=>n(l),className:"w-full",children:[e.jsxs(pa,{className:"grid w-full max-w-md grid-cols-2",children:[e.jsxs(Ae,{value:"nova-sessao",className:"gap-2",children:[e.jsx(ba,{className:"h-4 w-4"}),"Nova Sessão"]}),e.jsxs(Ae,{value:"historico",className:"gap-2",onClick:()=>S(1),children:[e.jsx(tt,{className:"h-4 w-4"}),"Histórico"]})]}),e.jsx(Ie,{value:"nova-sessao",className:"mt-4",children:e.jsxs(ua,{value:i,onValueChange:l=>t(l),className:"w-full",children:[e.jsxs(pa,{className:"grid w-full max-w-sm grid-cols-2 mb-4",children:[e.jsx(Ae,{value:"passo1",className:"gap-2",children:"1º Passo"}),e.jsxs(Ae,{value:"passo2",className:"gap-2",children:["2º Passo",xe.length>0&&e.jsx(le,{variant:"secondary",className:"ml-1 h-5 px-1.5",children:xe.length})]})]}),e.jsx(Ie,{value:"passo1",children:M==="form"?e.jsx(e.Fragment,{children:e.jsx(J,{className:"mb-4",children:e.jsxs(W,{className:"pt-4 pb-4",children:[e.jsxs("div",{className:"flex flex-wrap items-end gap-3",children:[e.jsxs("div",{className:"flex-1 min-w-[160px] max-w-[200px]",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground mb-1 block",children:"Veterinário *"}),e.jsx(ue,{placeholder:"Nome do veterinário",value:u.veterinario,onChange:l=>P({...u,veterinario:l.target.value}),className:"h-9"})]}),e.jsxs("div",{className:"flex-1 min-w-[160px] max-w-[200px]",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground mb-1 block",children:"Técnico *"}),e.jsx(ue,{placeholder:"Nome do técnico",value:u.tecnico,onChange:l=>P({...u,tecnico:l.target.value}),className:"h-9"})]}),e.jsxs("div",{className:"flex-1 min-w-[160px] max-w-[200px]",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground mb-1 block",children:"Fazenda *"}),e.jsxs(Ce,{value:u.fazenda_id,onValueChange:l=>P({...u,fazenda_id:l}),disabled:!u.veterinario||!u.tecnico,children:[e.jsx(Se,{className:"h-9",children:e.jsx(Pe,{placeholder:"Selecione"})}),e.jsx(we,{children:f.map(l=>e.jsx(re,{value:l.id,children:l.nome},l.id))})]})]}),e.jsxs("div",{className:"flex-1 min-w-[140px] max-w-[160px]",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground mb-1 block",children:"Data Início *"}),e.jsx(ze,{value:u.data_inicio,onChange:l=>P({...u,data_inicio:l||""}),className:"h-9"})]}),e.jsx(T,{onClick:js,disabled:Y||!u.fazenda_id||!u.veterinario||!u.tecnico||!u.data_inicio,className:"h-9 bg-primary hover:bg-primary-dark",children:"Continuar"})]}),!u.veterinario||!u.tecnico?e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Preencha veterinário e técnico para selecionar a fazenda"}):u.fazenda_id?null:e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Selecione uma fazenda para continuar"})]})})}):e.jsxs(e.Fragment,{children:[e.jsx(ga,{fazendaNome:V(u.fazenda_id),dataInicio:u.data_inicio,veterinario:u.veterinario,tecnico:u.tecnico}),e.jsxs(J,{className:"mt-4",children:[e.jsx(ie,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(ne,{className:"text-base",children:["Receptoras do Protocolo (",B.length,")"]}),e.jsx(da,{children:"Adicione as receptoras para este protocolo"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(Ve,{open:Te,onOpenChange:l=>{ke(l),l||Ka()},children:[e.jsx(ma,{asChild:!0,children:e.jsxs(T,{size:"sm",children:[e.jsx(rt,{className:"w-4 h-4 mr-2"}),"Adicionar"]})}),e.jsxs(Be,{className:"max-w-lg",children:[e.jsxs(He,{children:[e.jsx(Ze,{children:"Adicionar Receptora"}),e.jsx(Qe,{children:"Busque por identificação ou nome."})]}),e.jsx(At,{addReceptoraForm:$,setAddReceptoraForm:X,buscaReceptora:pe,setBuscaReceptora:qe,popoverAberto:sa,setPopoverAberto:Ge,receptorasFiltradas:ps,receptorasComStatus:v,loadingReceptoras:j,onAdd:Za})]})]}),e.jsxs(Ve,{open:Fe,onOpenChange:l=>{Oe(l),l||Ya()},children:[e.jsx(ma,{asChild:!0,children:e.jsxs(T,{variant:"outline",size:"sm",children:[e.jsx(wa,{className:"w-4 h-4 mr-2"}),"Nova"]})}),e.jsxs(Be,{children:[e.jsxs(He,{children:[e.jsx(Ze,{children:"Cadastrar Nova Receptora"}),e.jsx(Qe,{children:"Preencha os dados da nova receptora."})]}),e.jsx(It,{createReceptoraForm:Va,setCreateReceptoraForm:Ba,submitting:ve,onCreate:Qa})]})]})]})]})}),e.jsx(W,{className:"pt-0",children:B.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Nenhuma receptora adicionada. Adicione pelo menos uma antes de finalizar."}):e.jsx(zt,{receptorasLocais:B,onRemove:Ua,onUpdateCiclando:Ja,onUpdateQualidade:Wa})})]}),e.jsxs("div",{className:"flex items-center justify-between mt-4",children:[e.jsx(T,{variant:"outline",onClick:bs,disabled:ve,children:"Voltar"}),e.jsxs(T,{onClick:os,disabled:B.length===0||ve,className:"bg-primary hover:bg-primary-dark",children:[e.jsx(it,{className:"w-4 h-4 mr-2"}),ve?"Finalizando...":"Finalizar 1º Passo"]})]}),e.jsx(ft,{open:es,onOpenChange:as,onConfirm:rs,title:"Sair sem finalizar?",description:"Se você sair agora, nenhum protocolo será criado."}),e.jsx(va,{open:ss,onClose:_s,step:1,fazendaNome:V(u.fazenda_id),dataInicio:u.data_inicio,totalReceptoras:B.length,receptorasConfirmadas:B.length})]})}),e.jsxs(Ie,{value:"passo2",children:[e.jsx(J,{className:"mb-4",children:e.jsxs(W,{className:"pt-4 pb-4",children:[e.jsxs("div",{className:"flex flex-wrap items-end gap-3",children:[e.jsxs("div",{className:"flex-1 min-w-[280px] max-w-[350px]",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground mb-1 block",children:"Protocolo Aguardando 2º Passo"}),e.jsxs(Ce,{value:ae,onValueChange:l=>{$e(l)},children:[e.jsx(Se,{className:"h-9",children:e.jsx(Pe,{placeholder:"Selecione um protocolo"})}),e.jsx(we,{children:xe.length===0?e.jsx("div",{className:"p-2 text-sm text-muted-foreground text-center",children:"Nenhum protocolo aguardando"}):xe.map(l=>e.jsxs(re,{value:l.id,children:[l.fazenda_nome," • ",As(l.data_inicio)," • ",l.receptoras_count," rec."]},l.id))})]})]}),e.jsxs("div",{className:"flex-1 min-w-[160px] max-w-[200px]",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground mb-1 block",children:"Técnico 2º Passo *"}),e.jsx(ue,{placeholder:"Nome do técnico",value:se.tecnico,onChange:l=>je(O=>({...O,tecnico:l.target.value})),className:"h-9",disabled:!ae||Ne})]}),e.jsxs("div",{className:"flex-1 min-w-[140px] max-w-[160px]",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground mb-1 block",children:"Data 2º Passo *"}),e.jsx(ze,{value:se.data,onChange:l=>je(O=>({...O,data:l||""})),className:"h-9",disabled:!ae||Ne})]}),e.jsxs(T,{onClick:ms,disabled:!xs||ca||Ne,className:"h-9 bg-primary hover:bg-primary-dark",children:[e.jsx(nt,{className:"h-4 w-4 mr-2"}),ca?"Salvando...":"Finalizar"]})]}),ae?!se.tecnico||!se.data?e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Preencha o técnico e a data do 2º passo"}):oe.pendentes>0?e.jsxs("p",{className:"text-xs text-amber-600 mt-2",children:[oe.pendentes," receptora(s) aguardando avaliação"]}):null:e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:xe.length===0?"Nenhum protocolo aguardando 2º passo":"Selecione um protocolo para continuar"})]})}),ns?e.jsx(J,{children:e.jsx(W,{className:"py-8",children:e.jsx(Le,{})})}):ae&&H?e.jsxs(e.Fragment,{children:[e.jsx(ga,{fazendaNome:ra,dataInicio:H.data_inicio,veterinario:H.responsavel_inicio,tecnico:H.tecnico_responsavel,passo2Data:se.data,passo2Tecnico:se.tecnico,showPasso2:!0}),e.jsx("div",{className:"mt-4",children:e.jsx(ht,{pendentes:oe.pendentes,confirmadas:oe.confirmadas,descartadas:oe.descartadas})}),e.jsx("div",{className:"mt-4",children:e.jsx(gt,{receptoras:te,motivosInapta:ta,isFinalized:Ne,onStatusChange:Cs,onMotivoChange:Ss})}),e.jsx(va,{open:cs,onClose:ws,step:2,fazendaNome:ra,dataInicio:H.data_inicio,totalReceptoras:te.length,receptorasConfirmadas:oe.confirmadas,receptorasDescartadas:oe.descartadas})]}):null]})]})}),e.jsxs(Ie,{value:"historico",className:"space-y-6 mt-6",children:[e.jsxs(J,{children:[e.jsx(ie,{className:"pb-4",children:e.jsxs(ne,{className:"text-lg flex items-center gap-2",children:[e.jsx(ot,{className:"h-5 w-5"}),"Filtros"]})}),e.jsxs(W,{children:[e.jsxs("div",{className:"grid gap-4 sm:grid-cols-2 lg:grid-cols-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{children:"Status"}),e.jsxs(Ce,{value:C,onValueChange:p,children:[e.jsx(Se,{children:e.jsx(Pe,{placeholder:"Todos"})}),e.jsxs(we,{children:[e.jsx(re,{value:"all",children:"Todos"}),e.jsx(re,{value:"aguardando_2_passo",children:"Aguardando 2º Passo"}),e.jsx(re,{value:"sincronizado",children:"Sincronizados"}),e.jsx(re,{value:"fechado",children:"Fechados"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{children:"Fazenda"}),e.jsxs(Ce,{value:w||"all",onValueChange:l=>y(l==="all"?"":l),children:[e.jsx(Se,{children:e.jsx(Pe,{placeholder:"Todas"})}),e.jsxs(we,{children:[e.jsx(re,{value:"all",children:"Todas"}),x.map(l=>e.jsx(re,{value:l.id,children:l.nome},l.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{children:"Data Início (de)"}),e.jsx(ze,{value:A,onChange:k})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{children:"Data Início (até)"}),e.jsx(ze,{value:R,onChange:g})]})]}),e.jsxs("div",{className:"flex flex-wrap items-end gap-4 mt-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-2 flex-1",children:[e.jsx(Q,{className:"w-full text-sm font-medium",children:"Atalhos:"}),e.jsx(T,{variant:"outline",size:"sm",onClick:()=>E(7),children:"7 dias"}),e.jsx(T,{variant:"outline",size:"sm",onClick:()=>E(30),children:"30 dias"}),e.jsx(T,{variant:"outline",size:"sm",onClick:()=>E(90),children:"90 dias"})]}),e.jsxs(T,{onClick:hs,disabled:r,className:"bg-primary hover:bg-primary-dark",children:[e.jsx(Aa,{className:"w-4 h-4 mr-2"}),"Buscar"]})]})]})]}),e.jsxs(J,{children:[e.jsxs(ie,{children:[e.jsxs(ne,{className:"text-lg",children:["Protocolos (",m.length,")"]}),e.jsx(da,{children:"Lista de todos os protocolos de sincronização"})]}),e.jsx(W,{children:r?e.jsx(Le,{}):m.length===0?e.jsx(Vs,{title:"Nenhum protocolo encontrado",description:"Ajuste os filtros ou crie um novo protocolo.",action:e.jsx(T,{variant:"outline",onClick:fs,children:"Limpar filtros"})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(We,{children:[e.jsx(Ke,{children:e.jsxs(de,{children:[e.jsx(L,{children:"Fazenda"}),e.jsx(L,{children:"Data Início"}),e.jsx(L,{children:"Data 2º Passo"}),e.jsx(L,{children:"Receptoras"}),e.jsx(L,{children:"Status"}),e.jsx(L,{className:"text-right",children:"Ações"})]})}),e.jsx(Ye,{children:m.map(l=>e.jsx(Pt,{protocolo:l,navigate:a,onIniciar2Passo:O=>{$e(O),n("nova-sessao"),t("passo2")}},l.id))})]})}),e.jsxs("div",{className:"flex items-center justify-between pt-4 border-t mt-4",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Página ",z]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(T,{variant:"outline",size:"sm",onClick:gs,disabled:z===1||r,children:[e.jsx(Bs,{className:"w-4 h-4"}),"Anterior"]}),e.jsxs(T,{variant:"outline",size:"sm",onClick:vs,disabled:m.length<_||r,children:["Próxima",e.jsx(ct,{className:"w-4 h-4"})]})]})]})]})})]})]})]})]})}function Pt({protocolo:a,navigate:s,onIniciar2Passo:n}){const i=a.status==="PASSO1_FECHADO"||a.status==="PRIMEIRO_PASSO_FECHADO",t=a.status==="FECHADO"||a.status==="EM_TE",d=a.status==="SINCRONIZADO"||a.status==="PASSO2_FECHADO";return e.jsxs(de,{children:[e.jsx(G,{className:"font-medium",children:a.fazenda_nome}),e.jsx(G,{children:fe(a.data_inicio)}),e.jsx(G,{children:a.passo2_data?fe(a.passo2_data):"-"}),e.jsx(G,{children:a.receptoras_count}),e.jsx(G,{children:e.jsx(wt,{isFechado:t,isSincronizado:d,isAguardando2Passo:i,status:a.status})}),e.jsx(G,{children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[i&&e.jsxs(T,{variant:"default",size:"sm",onClick:()=>n(a.id),className:"bg-primary hover:bg-primary-dark",children:[e.jsx(ba,{className:"w-4 h-4 mr-2"}),"2º Passo"]}),e.jsxs(T,{variant:"outline",size:"sm",onClick:()=>s(`/protocolos/${a.id}/relatorio`),children:[e.jsx(lt,{className:"w-4 h-4 mr-2"}),"Relatório"]})]})})]})}function wt({isFechado:a,isSincronizado:s,isAguardando2Passo:n,status:i}){return a?e.jsx(le,{variant:"secondary",className:"bg-muted-foreground hover:bg-muted-foreground/90 text-white",children:"Fechado"}):s?e.jsx(le,{variant:"default",className:"bg-primary hover:bg-primary-dark text-primary-foreground",children:"Sincronizado"}):n?e.jsx(le,{variant:"outline",className:"border-emerald-500 bg-emerald-50 text-emerald-700 hover:bg-emerald-100",children:"Aguardando 2º Passo"}):e.jsx(le,{variant:"default",children:i||"N/A"})}function At({addReceptoraForm:a,setAddReceptoraForm:s,buscaReceptora:n,setBuscaReceptora:i,popoverAberto:t,setPopoverAberto:d,receptorasFiltradas:r,receptorasComStatus:m,loadingReceptoras:x,onAdd:C}){return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{children:"Receptora *"}),e.jsxs(Ds,{open:t,onOpenChange:d,children:[e.jsx(Ts,{asChild:!0,children:e.jsxs(T,{variant:"outline",role:"combobox","aria-expanded":t,className:"w-full justify-between",children:[a.receptora_id?(()=>{const p=m.find(w=>String(w.id).trim()===a.receptora_id.trim());return p?`${p.identificacao}${p.nome?` - ${p.nome}`:""}`:"Selecione uma receptora"})():"Buscar receptora...",e.jsx(Aa,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(ks,{className:"w-[400px] p-0",align:"start",children:e.jsxs(Fs,{shouldFilter:!1,children:[e.jsx(Os,{placeholder:"Buscar por identificação ou nome...",value:n,onValueChange:i}),e.jsx(qs,{children:x?e.jsx("div",{className:"p-4 text-sm text-center text-muted-foreground",children:"Carregando..."}):r.length===0?e.jsx(Gs,{children:n.trim()?"Nenhuma encontrada":"Nenhuma disponível"}):e.jsx($s,{children:r.map(p=>{const w=p.id?String(p.id).trim():"";return w?e.jsx(Ls,{value:`${p.identificacao} ${p.nome||""} ${w}`,onSelect:()=>{p.disponivel&&(s({...a,receptora_id:w}),i(""),d(!1))},disabled:!p.disponivel,className:p.disponivel?"":"opacity-60 cursor-not-allowed",children:e.jsx("div",{className:"flex flex-col w-full",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("span",{className:"flex-1",children:[p.identificacao,p.nome?` - ${p.nome}`:""]}),e.jsx(le,{variant:"outline",className:p.disponivel?"bg-green-50 text-green-700 border-green-200":"bg-red-50 text-red-700 border-red-200",children:p.disponivel?"Disponível":"Indisponível"})]})})},p.id):null})})})]})})]})]}),e.jsx("div",{className:"space-y-2",children:e.jsx(La,{ciclandoValue:a.ciclando_classificacao,qualidadeValue:a.qualidade_semaforo,onChangeCiclando:p=>s({...a,ciclando_classificacao:p}),onChangeQualidade:p=>s({...a,qualidade_semaforo:p}),size:"sm"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{children:"Observações"}),e.jsx(ja,{value:a.observacoes,onChange:p=>s({...a,observacoes:p.target.value}),placeholder:"Observações",rows:2})]}),e.jsx(T,{onClick:C,className:"w-full",disabled:x||!a.receptora_id,children:"Adicionar"})]})}function It({createReceptoraForm:a,setCreateReceptoraForm:s,submitting:n,onCreate:i}){return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{children:"Identificação (Brinco) *"}),e.jsx(ue,{value:a.identificacao,onChange:t=>s({...a,identificacao:t.target.value}),placeholder:"Número do brinco"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{children:"Nome"}),e.jsx(ue,{value:a.nome,onChange:t=>s({...a,nome:t.target.value}),placeholder:"Nome da receptora (opcional)"})]}),e.jsx("div",{className:"space-y-2",children:e.jsx(La,{ciclandoValue:a.ciclando_classificacao||null,qualidadeValue:a.qualidade_semaforo||null,onChangeCiclando:t=>s({...a,ciclando_classificacao:t}),onChangeQualidade:t=>s({...a,qualidade_semaforo:t}),size:"sm"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{children:"Observações"}),e.jsx(ja,{value:a.observacoes,onChange:t=>s({...a,observacoes:t.target.value}),placeholder:"Observações",rows:2})]}),e.jsxs(T,{onClick:i,className:"w-full",disabled:n,children:[e.jsx(wa,{className:"w-4 h-4 mr-2"}),n?"Criando...":"Criar e Adicionar"]})]})}function zt({receptorasLocais:a,onRemove:s,onUpdateCiclando:n,onUpdateQualidade:i}){return e.jsx("div",{className:"rounded-lg border overflow-hidden",children:e.jsxs(We,{children:[e.jsx(Ke,{children:e.jsxs(de,{className:"bg-secondary",children:[e.jsx(L,{className:"font-semibold",children:"Brinco"}),e.jsx(L,{className:"font-semibold",children:"Nome"}),e.jsx(L,{className:"font-semibold",children:"Ciclando"}),e.jsx(L,{className:"font-semibold",children:"Qualidade"}),e.jsx(L,{className:"font-semibold",children:"Obs."}),e.jsx(L,{className:"text-right font-semibold",children:"Ações"})]})}),e.jsx(Ye,{children:a.map((t,d)=>{const r=t.id&&t.id.trim()!==""?t.id:`new-${d}`;return e.jsxs(de,{className:"hover:bg-secondary/50",children:[e.jsx(G,{className:"font-medium",children:t.identificacao}),e.jsx(G,{className:"text-muted-foreground",children:t.nome||"-"}),e.jsx(G,{children:e.jsx(_a,{value:t.ciclando_classificacao,onChange:m=>n(d,m),variant:"editable"})}),e.jsx(G,{children:e.jsx(Ca,{value:t.qualidade_semaforo,onChange:m=>i(d,m),variant:"row"})}),e.jsx(G,{className:"text-muted-foreground max-w-[150px] truncate",children:t.observacoes||"-"}),e.jsx(G,{className:"text-right",children:e.jsx(T,{variant:"ghost",size:"sm",onClick:()=>s(d),children:e.jsx(Ue,{className:"w-4 h-4"})})})]},r)})})]})})}export{ho as default};
