import{r as o,s as T,a as I,j as a,g as L,h as E,k as U}from"./index-CvlUDCD-.js";import{u as B,C as G,a as A,b as O,c as $}from"./use-toast-BhbfqK05.js";import{T as Z,a as K,b as F,c as b,d as Q,e as C}from"./table-BAfLAU-a.js";import{D as W,a as X,b as Y,c as aa,d as ea,e as sa}from"./dialog-DSJKtNd7.js";import{S as q,a as V,b as J,c as M,d as R}from"./select-CRV7QsOQ.js";import{I as k}from"./input-BiDTc9_9.js";import{L as P}from"./label-BIMTC7_j.js";import{P as ra}from"./PageHeader-Don16aHL.js";import{E as ta}from"./EmptyState-DFkj0E0i.js";import{D as ia,H as oa,P as la,G as ca,S as N}from"./DoadoraHistoricoAspiracoes-CmA2ei9_.js";import{B as na}from"./badge-C6XBkHcG.js";import{S as da}from"./search-B2NaMPhp.js";import{P as ma}from"./plus-BqMf1Hqu.js";import"./index-BYe3zTS0.js";import"./x-DpiajgWI.js";import"./index-CDlvsNjp.js";import"./check-BbN618wW.js";function ua(){const{toast:e}=B(),[r,i]=o.useState(!0),[t,n]=o.useState([]),[m,u]=o.useState([]),[D,s]=o.useState([]),[d,S]=o.useState(""),[p,g]=o.useState(""),[y,_]=o.useState(null),w=o.useCallback(()=>{if(!p.trim()){s(m);return}const l=p.toLowerCase(),c=m.filter(f=>{var v,j,z;return((v=f.nome)==null?void 0:v.toLowerCase().includes(l))||((j=f.registro)==null?void 0:j.toLowerCase().includes(l))||((z=f.raca)==null?void 0:z.toLowerCase().includes(l))});s(c)},[m,p]);o.useEffect(()=>{w()},[w]);const h=o.useCallback(async()=>{try{i(!0);const{data:l,error:c}=await T.from("fazendas").select("id, nome").order("nome",{ascending:!0});if(c)throw c;n(l||[])}catch(l){e({title:"Erro ao carregar fazendas",description:l instanceof Error?l.message:"Erro desconhecido",variant:"destructive"})}finally{i(!1)}},[e]),x=o.useCallback(async()=>{if(!d){u([]),s([]);return}try{i(!0);const{data:l,error:c}=await T.from("doadoras").select("*").eq("fazenda_id",d).order("created_at",{ascending:!1});if(c)throw c;const f=await Promise.all((l||[]).map(async v=>{const{data:j,error:z}=await T.from("aspiracoes_doadoras").select("total_oocitos, data_aspiracao").eq("doadora_id",v.id).order("data_aspiracao",{ascending:!1}).limit(1).maybeSingle();return z||!j?{...v,ultima_aspiracao_total_oocitos:void 0,ultima_aspiracao_data:void 0}:{...v,ultima_aspiracao_total_oocitos:j.total_oocitos,ultima_aspiracao_data:j.data_aspiracao}}));u(f),s(f)}catch(l){e({title:"Erro ao carregar doadoras",description:l instanceof Error?l.message:"Erro desconhecido",variant:"destructive"})}finally{i(!1)}},[d,e]);return o.useEffect(()=>{d?x():(u([]),s([]))},[d,x]),{loading:r,fazendas:t,doadoras:m,filteredDoadoras:D,selectedFazendaId:d,setSelectedFazendaId:S,searchTerm:p,setSearchTerm:g,historicoDoadoraId:y,setHistoricoDoadoraId:_,loadFazendas:h,loadDoadoras:x}}const ha=["Holandesa","Jersey","Gir","Girolando"],H={registro:"",raca:"",racaCustom:""};function xa({selectedFazendaId:e,onSuccess:r}){const i=I(),{toast:t}=B(),[n,m]=o.useState(!1),[u,D]=o.useState(!1),[s,d]=o.useState(H),[S,p]=o.useState(""),g=o.useCallback(()=>{d(H),p("")},[]),y=o.useCallback(h=>{p(h),d(h==="Outra"?x=>({...x,raca:"",racaCustom:""}):x=>({...x,raca:h,racaCustom:""}))},[]),_=o.useCallback(h=>{m(h),h||g()},[g]),w=o.useCallback(async h=>{if(h.preventDefault(),!e){t({title:"Erro de validacao",description:"Selecione a fazenda primeiro",variant:"destructive"});return}if(!s.registro.trim()){t({title:"Erro de validacao",description:"Registro e obrigatorio",variant:"destructive"});return}const x=S==="Outra"?s.racaCustom.trim():s.raca.trim();if(!x){t({title:"Erro de validacao",description:"Raca e obrigatoria",variant:"destructive"});return}try{D(!0);const l={fazenda_id:e,registro:s.registro.trim(),raca:x},{data:c,error:f}=await T.from("doadoras").insert([l]).select().single();if(f)throw f;t({title:"Doadora criada",description:"Doadora criada com sucesso"}),m(!1),g(),r(),c!=null&&c.id&&i(`/doadoras/${c.id}`)}catch(l){const c=l instanceof Error?l.message:"Erro desconhecido";t({title:"Erro ao criar doadora",description:c.includes("RLS")||c.includes("policy")?"RLS esta bloqueando escrita. Configure politicas anon no Supabase.":c,variant:"destructive"})}finally{D(!1)}},[s,S,e,t,g,r,i]);return{formData:s,setFormData:d,racaSelecionada:S,setRacaSelecionada:p,showDialog:n,setShowDialog:m,submitting:u,resetForm:g,handleSubmit:w,handleDialogClose:_,handleRacaChange:y}}function Ga(){var f,v;const e=I(),{loading:r,fazendas:i,filteredDoadoras:t,selectedFazendaId:n,setSelectedFazendaId:m,searchTerm:u,setSearchTerm:D,historicoDoadoraId:s,setHistoricoDoadoraId:d,loadFazendas:S,loadDoadoras:p}=ua(),{formData:g,setFormData:y,racaSelecionada:_,showDialog:w,submitting:h,handleSubmit:x,handleDialogClose:l,handleRacaChange:c}=xa({selectedFazendaId:n,onSuccess:p});return o.useEffect(()=>{S()},[S]),r&&i.length===0?a.jsx(L,{}):a.jsxs("div",{className:"space-y-6",children:[a.jsx(ra,{title:"Doadoras",description:"Gerenciar doadoras do sistema"}),a.jsx(fa,{fazendas:i,selectedFazendaId:n,setSelectedFazendaId:m}),n?a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(pa,{searchTerm:u,setSearchTerm:D}),a.jsx(ja,{showDialog:w,handleDialogClose:l,formData:g,setFormData:y,racaSelecionada:_,handleRacaChange:c,submitting:h,handleSubmit:x})]}),a.jsxs(G,{children:[a.jsx(A,{children:a.jsx(O,{children:"Lista de Doadoras"})}),a.jsx($,{children:r?a.jsx("div",{className:"py-8",children:a.jsx(L,{})}):a.jsx(ga,{doadoras:t,searchTerm:u,navigate:e,setHistoricoDoadoraId:d})})]}),s&&a.jsx(ia,{doadoraId:s,doadoraNome:((f=t.find(j=>j.id===s))==null?void 0:f.nome)||((v=t.find(j=>j.id===s))==null?void 0:v.registro),open:!!s,onClose:()=>d(null)})]}):a.jsx(ta,{title:"Selecione uma fazenda",description:"Escolha uma fazenda para visualizar e gerenciar doadoras."})]})}function fa({fazendas:e,selectedFazendaId:r,setSelectedFazendaId:i}){return a.jsxs(G,{children:[a.jsx(A,{children:a.jsx(O,{children:"Selecione a Fazenda"})}),a.jsx($,{children:a.jsxs(q,{value:r,onValueChange:i,children:[a.jsx(V,{className:"w-full",children:a.jsx(J,{placeholder:"Selecione uma fazenda para visualizar doadoras"})}),a.jsx(M,{children:e.map(t=>a.jsx(R,{value:t.id,children:t.nome},t.id))})]})})]})}function pa({searchTerm:e,setSearchTerm:r}){return a.jsx("div",{className:"flex items-center gap-4 flex-1",children:a.jsxs("div",{className:"relative flex-1 max-w-md",children:[a.jsx(da,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4"}),a.jsx(k,{placeholder:"Buscar por nome ou registro...",value:e,onChange:i=>r(i.target.value),className:"pl-10"})]})})}function ja({showDialog:e,handleDialogClose:r,formData:i,setFormData:t,racaSelecionada:n,handleRacaChange:m,submitting:u,handleSubmit:D}){return a.jsxs(W,{open:e,onOpenChange:r,children:[a.jsx(X,{asChild:!0,children:a.jsxs(E,{className:"bg-green-600 hover:bg-green-700",children:[a.jsx(ma,{className:"w-4 h-4 mr-2"}),"Nova Doadora"]})}),a.jsxs(Y,{className:"max-w-md",children:[a.jsxs(aa,{children:[a.jsx(ea,{children:"Criar Nova Doadora"}),a.jsx(sa,{children:"Preencha os campos basicos. As informacoes detalhadas podem ser preenchidas apos a criacao."})]}),a.jsxs("form",{onSubmit:D,className:"space-y-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(P,{htmlFor:"registro",children:"Registro *"}),a.jsx(k,{id:"registro",value:i.registro,onChange:s=>t({...i,registro:s.target.value}),placeholder:"Registro da doadora",required:!0})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(P,{htmlFor:"raca",children:"Raca *"}),a.jsxs(q,{value:n,onValueChange:m,children:[a.jsx(V,{children:a.jsx(J,{placeholder:"Selecione a raca"})}),a.jsxs(M,{children:[ha.map(s=>a.jsx(R,{value:s,children:s},s)),a.jsx(R,{value:"Outra",children:"Outra"})]})]}),n==="Outra"&&a.jsx(k,{id:"raca_custom",value:i.racaCustom,onChange:s=>t({...i,racaCustom:s.target.value,raca:s.target.value}),placeholder:"Digite a raca",className:"mt-2",required:!0})]}),a.jsxs("div",{className:"flex gap-2 pt-2",children:[a.jsx(E,{type:"submit",className:"flex-1 bg-green-600 hover:bg-green-700",disabled:u,children:u?"Salvando...":"Criar Doadora"}),a.jsx(E,{type:"button",variant:"outline",onClick:()=>r(!1),disabled:u,children:"Cancelar"})]})]})]})]})}function ga({doadoras:e,searchTerm:r,navigate:i,setHistoricoDoadoraId:t}){return a.jsx("div",{className:"overflow-x-auto",children:a.jsxs(Z,{children:[a.jsx(K,{children:a.jsxs(F,{children:[a.jsx(b,{children:"Registro"}),a.jsx(b,{children:"Nome"}),a.jsx(b,{children:"Ultima Aspiracao"}),a.jsx(b,{children:"Oocitos"}),a.jsx(b,{children:"Estado"}),a.jsx(b,{children:"Raca (Campos Especiais)"}),a.jsx(b,{children:"Classificacao"}),a.jsx(b,{className:"text-right",children:"Acoes"})]})}),a.jsx(Q,{children:e.length===0?a.jsx(F,{children:a.jsx(C,{colSpan:8,className:"text-center text-slate-500",children:r?"Nenhuma doadora encontrada":"Nenhuma doadora cadastrada nesta fazenda"})}):e.map(n=>a.jsx(va,{doadora:n,navigate:i,setHistoricoDoadoraId:t},n.id))})]})})}function va({doadora:e,navigate:r,setHistoricoDoadoraId:i}){const t=Ca(e);return a.jsxs(F,{className:"cursor-pointer hover:bg-slate-50",onClick:()=>r(`/doadoras/${e.id}`),children:[a.jsx(C,{className:"font-medium",children:e.registro}),a.jsx(C,{children:e.nome||"-"}),a.jsx(C,{children:e.ultima_aspiracao_data?U(e.ultima_aspiracao_data):"-"}),a.jsx(C,{children:e.ultima_aspiracao_total_oocitos??"-"}),a.jsx(C,{children:a.jsx(na,{variant:e.disponivel_aspiracao?"default":"secondary",children:e.disponivel_aspiracao?"Disponivel":"Indisponivel"})}),a.jsx(C,{children:a.jsxs("div",{className:"flex flex-col gap-1",children:[a.jsx("span",{children:e.raca||"-"}),t&&a.jsx("span",{className:"text-xs text-slate-500",children:t})]})}),a.jsx(C,{children:Da(e.classificacao_genetica)}),a.jsx(C,{className:"text-right",children:a.jsxs("div",{className:"flex items-center justify-end gap-2",children:[a.jsx(E,{variant:"ghost",size:"sm",onClick:n=>{n.stopPropagation(),i(e.id)},title:"Ver historico de aspiracoes",children:a.jsx(oa,{className:"w-4 h-4"})}),a.jsx(E,{variant:"ghost",size:"sm",onClick:n=>{n.stopPropagation(),r(`/doadoras/${e.id}`)},title:"Editar doadora",children:a.jsx(la,{className:"w-4 h-4"})})]})})]})}function Ca(e){if(e.raca==="Gir"){const r=[];return e.gpta&&r.push(`GPTA: ${e.gpta}`),e.controle_leiteiro&&r.push(`Controle Leiteiro: ${e.controle_leiteiro}`),e.beta_caseina&&r.push(`Beta Caseina: ${e.beta_caseina}`),e.link_abcz&&r.push("Link ABCZ"),r.length>0?r.join(", "):null}return null}function Da(e){if(!e)return"-";switch(e){case"1_estrela":return a.jsx("div",{className:"flex items-center gap-1",children:a.jsx(N,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"})});case"2_estrelas":return a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(N,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"}),a.jsx(N,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"})]});case"3_estrelas":return a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(N,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"}),a.jsx(N,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"}),a.jsx(N,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"})]});case"diamante":return a.jsx("div",{className:"flex items-center gap-1",children:a.jsx(ca,{className:"w-4 h-4 fill-blue-500 text-blue-500"})});default:return"-"}}export{Ga as default};
