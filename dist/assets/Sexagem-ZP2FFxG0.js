import{a as Pe,r as m,s as b,j as e,B as Oe,i as Ge}from"./index-BPMeM9-O.js";import{a as Le,e as Ve,c as ke,b as Xe}from"./dataEnrichment-CnFMnwmv.js";import{C as re,d as ie,a as $e,b as Be,c as qe}from"./card-8azKTSNJ.js";import{T as Ze,a as Ue,b as je,c as M,d as Qe,e as C}from"./table-l_s8S0JA.js";import{S as ne,a as ce,b as de,c as le,d as G}from"./select-La4nrp5K.js";import{I as me}from"./input-tqcTRdPv.js";import{B as Se}from"./badge-CeJDYfYs.js";import{P as Je}from"./PageHeader-DQ4rM2jO.js";import{u as Ke}from"./use-toast-BGNwDi9e.js";import{D as We}from"./DatePickerBR-CHtWVvxh.js";import{g as Ye,u as ea,a as aa,c as sa,D as $,v as ta}from"./useLotesTE-C4AjE1Ta.js";import{U as oa}from"./user-BTDnQyTa.js";import{M as ra}from"./map-pin-B27L4YNJ.js";import{S as ia}from"./save-CVRLcPrA.js";import{T as na}from"./triangle-alert-h0K6D8II.js";import"./index-C5PY5DOm.js";import"./check-Bdb-Yd05.js";import"./chevron-right-BkIAhNYS.js";import"./popover-D1vF_0kq.js";import"./pt-BR-CyDikW87.js";import"./calendar-CuUQg-xw.js";import"./dateUtils-eJ5e6apA.js";function Ba(){const{toast:L}=Ke();Pe();const J=Ye(),[j,Ne]=m.useState(""),[i,B]=m.useState(null),[v,R]=m.useState([]),[Ae,ue]=m.useState(!1),[xe,ge]=m.useState(!1),[V,I]=m.useState({}),[E,K]=m.useState({veterinario_responsavel:"",tecnico_responsavel:""}),[we,ca]=m.useState([]),[da,la]=m.useState(!1),[_e,ma]=m.useState("todos"),[ua,xa]=m.useState("todos"),[k,ga]=m.useState(""),[_a,pa]=m.useState(""),[fa,ha]=m.useState(""),[va,Ea]=m.useState("data_sexagem"),[ba,Fe]=m.useState([]),[pe,ja]=m.useState(1),W=15,{fazendas:Y,loadFazendas:ee}=ea({statusReceptoraFiltro:["PRENHE","PRENHE_RETOQUE"]}),Me=m.useCallback((a,s)=>({...a,veterinario_sexagem:s==null?void 0:s.veterinario_responsavel,tecnico_sexagem:s==null?void 0:s.tecnico_responsavel}),[]),{lotesTE:fe,loading:he,loadLotesTE:ve}=aa({statusReceptoraFiltro:["PRENHE","PRENHE_RETOQUE"],transformLote:Me});m.useEffect(()=>{ee(),Ce()},[ee]),m.useEffect(()=>{var a;if(j){const s=(a=Y.find(r=>r.id===j))==null?void 0:a.nome;ve(j,s)}else B(null),R([]),I({})},[j]),m.useEffect(()=>{i?((i.veterinario_sexagem||i.tecnico_sexagem)&&K({veterinario_responsavel:i.veterinario_sexagem||E.veterinario_responsavel,tecnico_responsavel:i.tecnico_sexagem||E.tecnico_responsavel}),Re(i)):(R([]),I({}))},[i]);const Ce=async()=>{const{data:a}=await b.from("fazendas").select("id, nome").order("nome");Fe(a||[])},Re=async a=>{try{ue(!0);const{data:s}=await b.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",a.fazenda_id),r=(s==null?void 0:s.map(o=>o.receptora_id))||[],{data:t}=await b.from("receptoras").select("id, identificacao, nome, status_reprodutivo").in("id",r).in("status_reprodutivo",["PRENHE","PRENHE_RETOQUE"]),l=(t==null?void 0:t.map(o=>o.id))||[];if(l.length===0){R([]);return}const[x,w,y]=await Promise.all([b.from("transferencias_embrioes").select("id, receptora_id, embriao_id, data_te").in("receptora_id",l).eq("data_te",a.data_te).eq("status_te","REALIZADA"),b.from("diagnosticos_gestacao").select("*").in("receptora_id",l).eq("tipo_diagnostico","DG").eq("data_te",a.data_te).order("data_diagnostico",{ascending:!1}),b.from("diagnosticos_gestacao").select("*").in("receptora_id",l).eq("tipo_diagnostico","SEXAGEM").eq("data_te",a.data_te).order("data_diagnostico",{ascending:!1})]),z=x.data,c=w.data,d=y.data;if(!z||z.length===0){R([]);return}const u=z.map(o=>o.embriao_id).filter(Boolean);let g=new Map;if(u.length>0){const{data:o}=await b.from("embrioes").select("id, identificacao, classificacao, lote_fiv_id, lote_fiv_acasalamento_id").in("id",u);o&&(g=new Map(o.map(n=>[n.id,n])))}const D=Array.from(g.values()),S=Le(D),te=Ve(D),[N,q]=await Promise.all([ke(S),Xe(te)]),{doadorasMap:T,tourosMap:Z}=q,P=new Map;c==null||c.forEach(o=>{P.has(o.receptora_id)||P.set(o.receptora_id,o)});const _=new Map;d==null||d.forEach(o=>{_.has(o.receptora_id)||_.set(o.receptora_id,o)});const H=new Map;z.forEach(o=>{const n=`${o.receptora_id}-${o.data_te}`;H.has(n)||H.set(n,[]),H.get(n).push(o)});const p=[];H.forEach(o=>{const n=o[0],f=t==null?void 0:t.find(Q=>Q.id===n.receptora_id);if(!f)return;const O=[];let A=null,U=null;if(o.forEach(Q=>{const h=g.get(Q.embriao_id);if(!h)return;const oe=N.get(h.lote_fiv_id);if(!oe)return;A||(A=oe.data_abertura,U=sa(oe.data_abertura));const De=h.lote_fiv_acasalamento_id?T.get(h.lote_fiv_acasalamento_id):void 0,Te=h.lote_fiv_acasalamento_id?Z.get(h.lote_fiv_acasalamento_id):void 0;O.push({te_id:Q.id,embriao_id:h.id,embriao_identificacao:h.identificacao,embriao_classificacao:h.classificacao,lote_fiv_id:h.lote_fiv_id,lote_fiv_acasalamento_id:h.lote_fiv_acasalamento_id,doadora_registro:De,touro_nome:Te})}),O.length===0||!A||U===null)return;const X=P.get(n.receptora_id);!X||X.resultado==="VAZIA"||p.push({receptora_id:n.receptora_id,brinco:f.identificacao,nome:f.nome,data_te:n.data_te,embrioes:O,data_abertura_lote:A,dias_gestacao:U,numero_gestacoes:X.numero_gestacoes||1,diagnostico_existente:_.get(n.receptora_id)?{id:_.get(n.receptora_id).id,data_diagnostico:_.get(n.receptora_id).data_diagnostico,resultado:_.get(n.receptora_id).resultado,numero_gestacoes:_.get(n.receptora_id).numero_gestacoes,observacoes:_.get(n.receptora_id).observacoes}:void 0})}),p.sort((o,n)=>o.brinco.localeCompare(n.brinco)),R(p);const F={};p.forEach(o=>{if(o.diagnostico_existente){const n=_.get(o.receptora_id);let f=new Array(o.numero_gestacoes).fill("").map(()=>""),O=o.diagnostico_existente.observacoes||"";if(n!=null&&n.observacoes){const A=n.observacoes.match(/SEXAGENS:([^|]+)/);if(A){for(f=A[1].split(",").map(X=>X.trim());f.length<o.numero_gestacoes;)f.push("");f=f.slice(0,o.numero_gestacoes),O=n.observacoes.replace(/SEXAGENS:[^|]+\|?/,"").trim()}}f.every(A=>!A)&&(n!=null&&n.sexagem)&&(f[0]=n.sexagem),F[o.receptora_id]={data_sexagem:o.diagnostico_existente.data_diagnostico,sexagens:f,observacoes:O}}else F[o.receptora_id]={data_sexagem:J,sexagens:new Array(o.numero_gestacoes).fill("").map(()=>""),observacoes:""}}),I(F)}catch(s){L({title:"Erro ao carregar receptoras",description:s instanceof Error?s.message:"Erro desconhecido",variant:"destructive"}),R([])}finally{ue(!1)}},He=(a,s,r)=>{I(t=>{const l=t[a]||{data_sexagem:J,sexagens:[],observacoes:""},x=[...l.sexagens];return x[s]=r,{...t,[a]:{...l,sexagens:x}}})},Ee=(a,s,r)=>{I(t=>({...t,[a]:{...t[a],[s]:r}}))},Ie=a=>{const s=a.filter(x=>x&&x!=="VAZIA");if(s.length===0)return"VAZIA";const r=s.includes("FEMEA"),t=s.includes("MACHO"),l=s.includes("SEM_SEXO");return r&&!t&&!l?"PRENHE_FEMEA":t&&!r&&!l?"PRENHE_MACHO":r&&t?"PRENHE_2_SEXOS":"PRENHE_SEM_SEXO"},ye=async()=>{var s;if(!i)return;if(!ta(E)){L({title:"Erro de validação",description:"Veterinário responsável é obrigatório",variant:"destructive"});return}const a=v.filter(r=>{const t=V[r.receptora_id];return!t||!t.data_sexagem||!t.sexagens||t.sexagens.every(l=>!l)});if(a.length>0){L({title:"Erro de validação",description:`Há ${a.length} receptora(s) sem sexagem definida`,variant:"destructive"});return}try{ge(!0);const r=[],t=[],l=[];v.forEach(c=>{var P,_,H;const d=V[c.receptora_id];if(!d||!d.data_sexagem)return;const u=d.sexagens.filter(p=>p&&p!=="VAZIA"),g=Ie(d.sexagens),D=g==="VAZIA"?"VAZIA":"PRENHE";let S=null;if(D==="PRENHE"){const p=u.every(o=>o==="FEMEA")&&u.length>0,F=u.every(o=>o==="MACHO")&&u.length>0;p?S="FEMEA":F?S="MACHO":S=u.find(o=>o==="FEMEA"||o==="MACHO")||null}(S==="PRENHE"||S==="SEM_SEXO")&&(S=u.find(F=>F==="FEMEA"||F==="MACHO")||null);const te=D==="VAZIA"?0:u.length;let N=((P=d.observacoes)==null?void 0:P.trim())||"";const q=d.sexagens.filter(p=>p),T=q.length>0?q.join(","):"";T&&(N.includes("SEXAGENS:")?N=N.replace(/SEXAGENS:[^|]+/,`SEXAGENS:${T}`):N=N?`SEXAGENS:${T}|${N}`:`SEXAGENS:${T}`);const Z={receptora_id:c.receptora_id,data_te:c.data_te,tipo_diagnostico:"SEXAGEM",data_diagnostico:d.data_sexagem,resultado:D,sexagem:S,numero_gestacoes:te,observacoes:N||void 0,veterinario_responsavel:((_=E.veterinario_responsavel)==null?void 0:_.trim())||void 0,tecnico_responsavel:((H=E.tecnico_responsavel)==null?void 0:H.trim())||void 0};c.diagnostico_existente?t.push({id:c.diagnostico_existente.id,...Z}):r.push(Z),l.push({receptora_id:c.receptora_id,status:g})});const x=[];r.length>0&&x.push(b.from("diagnosticos_gestacao").insert(r).then(({error:c})=>{if(c)throw new Error(`Erro ao inserir sexagens: ${c.message}`)})),t.forEach(c=>{const{id:d,...u}=c;x.push(b.from("diagnosticos_gestacao").update(u).eq("id",d).then(({error:g})=>{if(g)throw new Error(`Erro ao atualizar sexagem: ${g.message}`)}))}),await Promise.all(x);const w=new Map;l.forEach(({receptora_id:c,status:d})=>{w.has(d)||w.set(d,[]),w.get(d).push(c)});for(const[c,d]of w.entries()){const u={status_reprodutivo:c};c==="VAZIA"&&(u.data_provavel_parto=null);const{error:g}=await b.from("receptoras").update(u).in("id",d);if(g)throw console.error("Erro ao atualizar status:",g,"Status:",c,"IDs:",d),new Error(`Erro ao atualizar status das receptoras: ${g.message}`);console.log(`Status atualizado para ${c}:`,d)}const y=v.every(c=>{const d=V[c.receptora_id];return d&&d.data_sexagem&&d.sexagens&&d.sexagens.some(u=>u)});L({title:"Lote salvo com sucesso",description:y?`${v.length} sexagem(ns) registrada(s). Lote fechado.`:`${v.length} sexagem(ns) registrada(s)`}),y?(B(null),R([]),I({})):B({...i,veterinario_sexagem:E.veterinario_responsavel.trim(),tecnico_sexagem:E.tecnico_responsavel.trim(),status:"ABERTO"});const z=(s=Y.find(c=>c.id===j))==null?void 0:s.nome;ee(),j&&ve(j,z)}catch(r){L({title:"Erro ao salvar lote",description:r instanceof Error?r.message:"Erro desconhecido",variant:"destructive"})}finally{ge(!1)}},ze=v.every(a=>{const s=V[a.receptora_id];return s&&s.data_sexagem&&s.sexagens&&s.sexagens.some(r=>r)}),be=a=>{if(!a)return"-";const[s,r,t]=a.split("-");return`${t}/${r}/${s}`},ae=we.filter(a=>{var t;const s=!k||a.fazenda_nome.toLowerCase().includes(k.toLowerCase())||((t=a.veterinario_responsavel)==null?void 0:t.toLowerCase().includes(k.toLowerCase()))||a.receptoras.some(l=>{var x;return l.receptora_brinco.toLowerCase().includes(k.toLowerCase())||((x=l.receptora_nome)==null?void 0:x.toLowerCase().includes(k.toLowerCase()))}),r=_e==="todos"||a.fazenda_nome===_e;return s&&r}),se=ae.reduce((a,s)=>({total:a.total+s.total_receptoras,femeas:a.femeas+s.femeas,machos:a.machos+s.machos,vazias:a.vazias+s.vazias}),{total:0,femeas:0,machos:0,vazias:0});return se.total>0&&Math.round(se.vazias/se.total*100),Math.ceil(ae.length/W),ae.slice((pe-1)*W,pe*W),e.jsxs("div",{className:"space-y-6",children:[e.jsx(Je,{title:"Sexagem Fetal",description:"Registrar sexagem fetal por lote de receptoras prenhes"}),e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"rounded-xl border border-border bg-gradient-to-r from-card via-card to-muted/30 p-4 mb-4",children:[e.jsxs("div",{className:"flex flex-wrap items-end gap-6",children:[e.jsxs("div",{className:"flex items-end gap-3",children:[e.jsx("div",{className:"w-1 h-6 rounded-full bg-primary/40 self-center"}),e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground self-center",children:[e.jsx(oa,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:"Responsáveis"})]}),e.jsxs("div",{className:"flex-1 min-w-[160px]",children:[e.jsx("label",{className:"text-[10px] font-medium text-muted-foreground mb-1 block uppercase tracking-wide",children:"Veterinário *"}),e.jsx(me,{placeholder:"Nome do veterinário",value:E.veterinario_responsavel,onChange:a=>K(s=>({...s,veterinario_responsavel:a.target.value})),className:"h-9"})]}),e.jsxs("div",{className:"flex-1 min-w-[160px]",children:[e.jsx("label",{className:"text-[10px] font-medium text-muted-foreground mb-1 block uppercase tracking-wide",children:"Técnico"}),e.jsx(me,{placeholder:"Nome do técnico",value:E.tecnico_responsavel,onChange:a=>K(s=>({...s,tecnico_responsavel:a.target.value})),className:"h-9"})]})]}),e.jsx("div",{className:"h-10 w-px bg-border hidden lg:block"}),e.jsxs("div",{className:"flex items-end gap-3",children:[e.jsx("div",{className:"w-1 h-6 rounded-full bg-emerald-500/40 self-center"}),e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground self-center",children:[e.jsx(ra,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:"Local"})]}),e.jsxs("div",{className:"flex-1 min-w-[160px]",children:[e.jsx("label",{className:"text-[10px] font-medium text-muted-foreground mb-1 block uppercase tracking-wide",children:"Fazenda *"}),e.jsxs(ne,{value:j,onValueChange:Ne,disabled:!E.veterinario_responsavel,children:[e.jsx(ce,{className:"h-9",children:e.jsx(de,{placeholder:"Selecione a fazenda"})}),e.jsx(le,{children:Y.map(a=>e.jsx(G,{value:a.id,children:a.nome},a.id))})]})]}),e.jsxs("div",{className:"flex-1 min-w-[200px]",children:[e.jsx("label",{className:"text-[10px] font-medium text-muted-foreground mb-1 block uppercase tracking-wide",children:"Lote TE *"}),e.jsxs(ne,{value:(i==null?void 0:i.id)||"",onValueChange:a=>{const s=fe.find(r=>r.id===a);B(s||null)},disabled:!j||he,children:[e.jsx(ce,{className:"h-9",children:e.jsx(de,{placeholder:he?"Carregando...":"Selecione o lote"})}),e.jsx(le,{children:fe.map(a=>{const s=a.dias_gestacao!==void 0&&a.dias_gestacao<$.SEXAGEM;return e.jsx(G,{value:a.id,children:e.jsxs("span",{className:s?"text-amber-600":"",children:[be(a.data_te)," • ",a.dias_gestacao??"?","d • ",a.quantidade_receptoras," rec.",s&&" ⚠️"]})},a.id)})})]})]})]}),e.jsx("div",{className:"h-10 w-px bg-border hidden lg:block"}),e.jsx("div",{className:"flex items-end gap-3 ml-auto",children:e.jsxs(Oe,{onClick:ye,disabled:!i||!ze||xe||(i==null?void 0:i.status)==="FECHADO"||(i==null?void 0:i.dias_gestacao)!==void 0&&i.dias_gestacao<$.SEXAGEM,className:"h-9 px-6 bg-primary hover:bg-primary-dark shadow-sm",children:[e.jsx(ia,{className:"w-4 h-4 mr-2"}),xe?"Salvando...":"Salvar Lote"]})})]}),i&&i.dias_gestacao!==void 0&&i.dias_gestacao<$.SEXAGEM&&e.jsxs("div",{className:"flex items-center gap-2 mt-3 p-2 bg-amber-50 dark:bg-amber-950/50 border border-amber-200 dark:border-amber-800 rounded-lg",children:[e.jsx(na,{className:"h-4 w-4 text-amber-600 dark:text-amber-400 flex-shrink-0"}),e.jsxs("p",{className:"text-xs text-amber-700 dark:text-amber-300",children:["Este lote está com ",i.dias_gestacao," dias. Sexagem requer mínimo de ",$.SEXAGEM," dias (faltam ",$.SEXAGEM-i.dias_gestacao,")."]})]})]}),Ae?e.jsx(re,{children:e.jsx(ie,{className:"py-8",children:e.jsx(Ge,{})})}):i&&v.length>0?e.jsxs(re,{children:[e.jsx($e,{className:"pb-3",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{children:[e.jsx(Be,{className:"text-base",children:"Receptoras do Lote"}),e.jsxs(qe,{children:[v.length," receptora(s) • TE em ",be(i.data_te)]})]}),i.status==="FECHADO"&&e.jsx(Se,{variant:"secondary",children:"Lote Fechado"})]})})}),e.jsx(ie,{className:"pt-0",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(Ze,{children:[e.jsx(Ue,{children:e.jsxs(je,{children:[e.jsx(M,{children:"Receptora"}),e.jsx(M,{children:"Dias Gest."}),e.jsx(M,{children:"Embrião"}),e.jsx(M,{children:"Doadora × Touro"}),e.jsx(M,{children:"Nº Gest."}),e.jsx(M,{children:"Data Sexagem"}),e.jsx(M,{children:"Sexagem(ns)"}),e.jsx(M,{children:"Obs."})]})}),e.jsx(Qe,{children:v.map(a=>{const s=V[a.receptora_id]||{data_sexagem:J,sexagens:new Array(a.numero_gestacoes).fill("").map(()=>""),observacoes:""},r=i.status==="FECHADO";return e.jsxs(je,{children:[e.jsx(C,{className:"font-medium",children:e.jsxs("div",{className:"flex items-center gap-2",children:[a.brinco,a.nome&&e.jsxs("span",{className:"text-muted-foreground text-xs",children:["(",a.nome,")"]})]})}),e.jsx(C,{children:e.jsxs(Se,{variant:"outline",className:"font-mono",children:[a.dias_gestacao,"d"]})}),e.jsx(C,{children:e.jsx("div",{className:"space-y-0.5",children:a.embrioes.map((t,l)=>e.jsxs("div",{className:"text-sm",children:[t.embriao_identificacao||`#${l+1}`,t.embriao_classificacao&&e.jsxs("span",{className:"text-muted-foreground text-xs ml-1",children:["(",t.embriao_classificacao,")"]})]},t.te_id))})}),e.jsx(C,{children:e.jsx("div",{className:"space-y-0.5 text-sm",children:a.embrioes.map(t=>e.jsxs("div",{children:[t.doadora_registro||"-",t.touro_nome&&` × ${t.touro_nome}`]},t.te_id))})}),e.jsx(C,{className:"text-center font-medium",children:a.numero_gestacoes}),e.jsx(C,{children:e.jsx(We,{value:s.data_sexagem,onChange:t=>Ee(a.receptora_id,"data_sexagem",t||""),className:"w-32",disabled:r})}),e.jsx(C,{children:e.jsx("div",{className:"flex gap-1",children:Array.from({length:a.numero_gestacoes},(t,l)=>{const x=s.sexagens[l]||"",w=a.numero_gestacoes>1?`G${l+1}`:"--";return e.jsxs(ne,{value:x,onValueChange:y=>He(a.receptora_id,l,y),disabled:r,children:[e.jsx(ce,{className:"w-24 h-9",children:e.jsx(de,{placeholder:w})}),e.jsxs(le,{children:[e.jsx(G,{value:"FEMEA",children:"Fêmea"}),e.jsx(G,{value:"MACHO",children:"Macho"}),e.jsx(G,{value:"SEM_SEXO",children:"Sem sexo"}),e.jsx(G,{value:"VAZIA",children:"Vazia"})]})]},l)})})}),e.jsx(C,{children:e.jsx(me,{value:s.observacoes,onChange:t=>Ee(a.receptora_id,"observacoes",t.target.value),placeholder:"Obs.",className:"w-32 h-9",disabled:r})})]},a.receptora_id)})})]})})})]}):i&&v.length===0?e.jsx(re,{children:e.jsx(ie,{className:"py-8 text-center text-muted-foreground",children:"Nenhuma receptora prenhe encontrada neste lote"})}):null]})]})}export{Ba as default};
