import{a as Le,r as m,s as g,j as e,B as Me,i as Oe}from"./index-BPMeM9-O.js";import{e as qe,b as Ve}from"./dataEnrichment-CnFMnwmv.js";import{C as ne,d as ce,a as Be,b as Ue,c as Qe}from"./card-8azKTSNJ.js";import{T as Ze,a as Je,b as Ne,c as D,d as Ke,e as S}from"./table-l_s8S0JA.js";import{S as de,a as le,b as me,c as ue,d as M}from"./select-La4nrp5K.js";import{I as J}from"./input-tqcTRdPv.js";import{B as we}from"./badge-CeJDYfYs.js";import{P as We}from"./PageHeader-DQ4rM2jO.js";import{u as Xe}from"./use-toast-BGNwDi9e.js";import{v as Ye}from"./receptoraStatus-CrpDZcn1.js";import{D as ea}from"./DatePickerBR-CHtWVvxh.js";import{g as aa,u as sa,a as ta,c as oa,D as O,v as ra,b as Re}from"./useLotesTE-C4AjE1Ta.js";import{U as ia}from"./user-BTDnQyTa.js";import{M as na}from"./map-pin-B27L4YNJ.js";import{S as ca}from"./save-CVRLcPrA.js";import{T as da}from"./triangle-alert-h0K6D8II.js";import"./index-C5PY5DOm.js";import"./check-Bdb-Yd05.js";import"./chevron-right-BkIAhNYS.js";import"./popover-D1vF_0kq.js";import"./pt-BR-CyDikW87.js";import"./calendar-CuUQg-xw.js";import"./dateUtils-eJ5e6apA.js";function Qa(){Le();const{toast:F}=Xe(),pe=aa(),[R,De]=m.useState(""),[n,q]=m.useState(null),[x,C]=m.useState([]),[Se,_e]=m.useState(!1),[fe,ge]=m.useState(!1),[H,I]=m.useState({}),[h,K]=m.useState({veterinario_responsavel:"",tecnico_responsavel:""}),[la,ma]=m.useState([]),[Ce,ua]=m.useState([]),[pa,_a]=m.useState(!1),[he,fa]=m.useState("todos"),[ga,ha]=m.useState("todos"),[G,va]=m.useState(""),[Te,xa]=m.useState("data_dg"),[$,ba]=m.useState(""),[k,ja]=m.useState(""),[Ea,Ae]=m.useState([]),[ve,Na]=m.useState(1),W=15,{fazendas:X,loadFazendas:Y}=sa({statusReceptoraFiltro:"SERVIDA"}),Fe=m.useCallback((a,s)=>({...a,veterinario_dg:s==null?void 0:s.veterinario_responsavel,tecnico_dg:s==null?void 0:s.tecnico_responsavel}),[]),{lotesTE:xe,loading:be,loadLotesTE:je}=ta({statusReceptoraFiltro:"SERVIDA",transformLote:Fe});m.useEffect(()=>{Y(),Ie()},[Y]),m.useEffect(()=>{var a;if(R){const s=(a=X.find(l=>l.id===R))==null?void 0:a.nome;je(R,s)}else q(null),C([]),I({})},[R]),m.useEffect(()=>{n?((n.veterinario_dg||n.tecnico_dg)&&K({veterinario_responsavel:n.veterinario_dg||h.veterinario_responsavel,tecnico_responsavel:n.tecnico_dg||h.tecnico_responsavel}),Pe(n)):(C([]),I({}))},[n]);const Ie=async()=>{const{data:a}=await g.from("fazendas").select("id, nome").order("nome");Ae(a||[])},Pe=async a=>{var s,l;try{_e(!0);const{data:t,error:u}=await g.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",a.fazenda_id);if(u)throw u;const E=(t==null?void 0:t.map(r=>r.receptora_id))||[];if(E.length===0){C([]);return}const[v,N]=await Promise.all([g.from("receptoras").select("id, identificacao, nome, status_reprodutivo").in("id",E).eq("status_reprodutivo","SERVIDA"),g.from("transferencias_embrioes").select("id, receptora_id, embriao_id, data_te").in("receptora_id",E).eq("data_te",a.data_te).eq("status_te","REALIZADA")]);if(v.error)throw v.error;if(N.error)throw N.error;const w=v.data,T=N.data;if(!T||T.length===0){C([]);return}const se=(w==null?void 0:w.map(r=>r.id))||[],c=T.map(r=>r.embriao_id).filter(Boolean);let i=new Map;if(c.length>0){const{data:r,error:_}=await g.from("embrioes").select("id, identificacao, classificacao, lote_fiv_id, lote_fiv_acasalamento_id").in("id",c);if(_)throw _;i=new Map((r==null?void 0:r.map(b=>[b.id,b]))||[])}const d=[...new Set(Array.from(i.values()).map(r=>r.lote_fiv_id).filter(Boolean))],o=qe(Array.from(i.values())),[p,f,P]=await Promise.all([d.length>0?g.from("lotes_fiv").select("id, data_abertura").in("id",d):Promise.resolve({data:[],error:null}),Ve(o),g.from("diagnosticos_gestacao").select("*").in("receptora_id",se).eq("tipo_diagnostico","DG").eq("data_te",a.data_te).order("data_diagnostico",{ascending:!1})]);if(p.error)throw p.error;const A=new Map(((s=p.data)==null?void 0:s.map(r=>[r.id,r]))||[]),{doadorasMap:y,tourosMap:Ge}=f,te=new Map;(l=P.data)==null||l.forEach(r=>{te.has(r.receptora_id)||te.set(r.receptora_id,r)});const B=new Map;T.forEach(r=>{const _=`${r.receptora_id}-${r.data_te}`;B.has(_)||B.set(_,[]),B.get(_).push(r)});const U=[];B.forEach(r=>{const _=r[0],b=w==null?void 0:w.find(Z=>Z.id===_.receptora_id);if(!b)return;const L=[];let Q=null,re=null;if(r.forEach(Z=>{const j=i.get(Z.embriao_id);if(!j)return;const ie=A.get(j.lote_fiv_id);if(!ie)return;Q||(Q=ie.data_abertura,re=oa(ie.data_abertura));const $e=j.lote_fiv_acasalamento_id?y.get(j.lote_fiv_acasalamento_id):void 0,ke=j.lote_fiv_acasalamento_id?Ge.get(j.lote_fiv_acasalamento_id):void 0;L.push({te_id:Z.id,embriao_id:j.id,embriao_identificacao:j.identificacao,embriao_classificacao:j.classificacao,lote_fiv_id:j.lote_fiv_id,lote_fiv_acasalamento_id:j.lote_fiv_acasalamento_id,doadora_registro:$e,touro_nome:ke})}),L.length===0||!Q||re===null)return;const z=te.get(_.receptora_id);U.push({receptora_id:_.receptora_id,brinco:b.identificacao,nome:b.nome,status_reprodutivo:b.status_reprodutivo,data_te:_.data_te,embrioes:L,data_abertura_lote:Q,dias_gestacao:re,diagnostico_existente:z?{id:z.id,data_diagnostico:z.data_diagnostico,resultado:z.resultado,numero_gestacoes:z.numero_gestacoes||void 0,observacoes:z.observacoes||void 0}:void 0})}),U.sort((r,_)=>r.brinco.localeCompare(_.brinco)),C(U);const oe={};U.forEach(r=>{var _;if(r.diagnostico_existente){const b=r.diagnostico_existente.resultado,L=((_=r.diagnostico_existente.numero_gestacoes)==null?void 0:_.toString())||(b==="PRENHE"||b==="RETOQUE"?"1":"");oe[r.receptora_id]={resultado:b,numero_gestacoes:L,observacoes:r.diagnostico_existente.observacoes||"",data_diagnostico:r.diagnostico_existente.data_diagnostico}}else oe[r.receptora_id]={resultado:"",numero_gestacoes:"",observacoes:"",data_diagnostico:pe}}),I(oe)}catch(t){F({title:"Erro ao carregar receptoras",description:t instanceof Error?t.message:"Erro desconhecido",variant:"destructive"}),C([])}finally{_e(!1)}},ye=(a,s)=>{I(l=>{const t=l[a]||{};let u=t.numero_gestacoes||"";return(s==="PRENHE"||s==="RETOQUE")&&!u?u="1":(s==="VAZIA"||s==="")&&(u=""),{...l,[a]:{...t,resultado:s,numero_gestacoes:u}}})},ee=(a,s,l)=>{I(t=>({...t,[a]:{...t[a],[s]:l}}))},ze=async()=>{var s,l;if(!n)return;if(!ra(h)){F({title:"Erro de validação",description:"Veterinário responsável é obrigatório",variant:"destructive"});return}const a=x.filter(t=>{const u=H[t.receptora_id];return!u||!u.resultado||!u.data_diagnostico});if(a.length>0){F({title:"Erro de validação",description:`Há ${a.length} receptora(s) sem resultado definido`,variant:"destructive"});return}try{ge(!0);for(const c of x){const i=c.status_reprodutivo||"VAZIA",d=Ye(i,"REALIZAR_DG");if(!d.valido){F({title:"Erro de validação",description:`Receptora ${c.brinco}: ${d.mensagem}`,variant:"destructive"});return}}const t=[],u=[],E=[];if(x.forEach(c=>{var f,P,A;const i=H[c.receptora_id];if(!i||!i.resultado||!i.data_diagnostico)return;const d={receptora_id:c.receptora_id,data_te:c.data_te,tipo_diagnostico:"DG",data_diagnostico:i.data_diagnostico,resultado:i.resultado,observacoes:((f=i.observacoes)==null?void 0:f.trim())||void 0};i.resultado==="PRENHE"||i.resultado==="RETOQUE"?d.numero_gestacoes=i.numero_gestacoes?parseInt(i.numero_gestacoes):1:d.numero_gestacoes=0,(P=h.veterinario_responsavel)!=null&&P.trim()&&(d.veterinario_responsavel=h.veterinario_responsavel.trim()),(A=h.tecnico_responsavel)!=null&&A.trim()&&(d.tecnico_responsavel=h.tecnico_responsavel.trim()),c.diagnostico_existente?u.push({id:c.diagnostico_existente.id,...d}):t.push(d);let o,p=null;i.resultado==="PRENHE"?(o="PRENHE",p=Re(c.data_abertura_lote)):i.resultado==="RETOQUE"?(o="PRENHE_RETOQUE",p=Re(c.data_abertura_lote)):o="VAZIA",E.push({receptora_id:c.receptora_id,status:o,dataParto:p})}),t.length>0){const{data:c}=await g.from("diagnosticos_gestacao").select("id, receptora_id, data_te, tipo_diagnostico").in("receptora_id",[...new Set(t.map(o=>o.receptora_id))]).eq("tipo_diagnostico","DG"),i=new Map;c==null||c.forEach(o=>{const p=`${o.receptora_id}-${o.data_te}-${o.tipo_diagnostico}`;i.set(p,o.id)});const d=[];if(t.forEach(o=>{const p=`${o.receptora_id}-${o.data_te}-${o.tipo_diagnostico}`,f=i.get(p);f?u.push({id:f,...o}):d.push(o)}),d.length>0){const{error:o}=await g.from("diagnosticos_gestacao").insert(d);if(o)if((s=o.message)!=null&&s.includes("column")||o.code==="42703"){const p=d.map(({veterinario_responsavel:P,tecnico_responsavel:A,...y})=>y),{error:f}=await g.from("diagnosticos_gestacao").insert(p);if(f)throw new Error(`Erro ao inserir diagnósticos: ${f.message}`)}else throw new Error(`Erro ao inserir diagnósticos: ${o.message}`)}}const v=u.map(async c=>{var p;const{id:i,...d}=c;let{error:o}=await g.from("diagnosticos_gestacao").update(d).eq("id",i);if(o&&((p=o.message)!=null&&p.includes("column")||o.code==="42703")){const{veterinario_responsavel:f,tecnico_responsavel:P,...A}=d,{error:y}=await g.from("diagnosticos_gestacao").update(A).eq("id",i);if(y)throw new Error(`Erro ao atualizar diagnóstico: ${y.message}`)}else if(o)throw new Error(`Erro ao atualizar diagnóstico: ${o.message}`)});await Promise.all(v);const N=new Map;E.forEach(({receptora_id:c,status:i,dataParto:d})=>{const o=`${i}|${d||"null"}`;N.has(o)||N.set(o,{ids:[],dataParto:d||null}),N.get(o).ids.push(c)});const w=Array.from(N.entries()).map(async([c,{ids:i,dataParto:d}])=>{const o=c.split("|")[0],p={status_reprodutivo:o};d?p.data_provavel_parto=d:o==="VAZIA"&&(p.data_provavel_parto=null);const{error:f}=await g.from("receptoras").update(p).in("id",i);if(f)throw new Error("Erro ao atualizar status das receptoras")});await Promise.all(w);const T=x.every(c=>{const i=H[c.receptora_id];return i&&i.resultado&&i.data_diagnostico});F({title:"Lote salvo com sucesso",description:T?`${x.length} diagnóstico(s) registrado(s). Lote fechado.`:`${x.length} diagnóstico(s) registrado(s)`}),T?(q(null),C([]),I({})):q({...n,veterinario_dg:h.veterinario_responsavel.trim(),tecnico_dg:h.tecnico_responsavel.trim(),status:"ABERTO"});const se=(l=X.find(c=>c.id===R))==null?void 0:l.nome;Y(),R&&je(R,se)}catch(t){F({title:"Erro ao salvar lote",description:t instanceof Error?t.message:"Erro desconhecido",variant:"destructive"})}finally{ge(!1)}},He=x.every(a=>{const s=H[a.receptora_id];return s&&s.resultado&&s.data_diagnostico}),Ee=a=>{if(!a)return"-";const[s,l,t]=a.split("-");return`${t}/${l}/${s}`},ae=Ce.filter(a=>{var u;const s=!G||a.fazenda_nome.toLowerCase().includes(G.toLowerCase())||((u=a.veterinario_responsavel)==null?void 0:u.toLowerCase().includes(G.toLowerCase()))||a.receptoras.some(E=>{var v;return E.receptora_brinco.toLowerCase().includes(G.toLowerCase())||((v=E.receptora_nome)==null?void 0:v.toLowerCase().includes(G.toLowerCase()))}),l=he==="todos"||a.fazenda_nome===he;let t=!0;return Te==="data_dg"?($&&(t=t&&a.data_diagnostico>=$),k&&(t=t&&a.data_diagnostico<=k)):($||k)&&(t=a.receptoras.some(v=>{if(!v.data_provavel_parto)return!1;const N=!$||v.data_provavel_parto>=$,w=!k||v.data_provavel_parto<=k;return N&&w})),s&&l&&t});Math.ceil(ae.length/W),ae.slice((ve-1)*W,ve*W);const V=ae.reduce((a,s)=>({total:a.total+s.total_receptoras,prenhes:a.prenhes+s.prenhes,vazias:a.vazias+s.vazias,retoques:a.retoques+s.retoques,sessoes:a.sessoes+1}),{total:0,prenhes:0,vazias:0,retoques:0,sessoes:0});return V.total>0&&Math.round((V.prenhes+V.retoques)/V.total*100),e.jsxs("div",{className:"space-y-6",children:[e.jsx(We,{title:"Diagnóstico de Gestação (DG)",description:"Registrar diagnósticos de gestação por lote de TE"}),e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"rounded-xl border border-border bg-gradient-to-r from-card via-card to-muted/30 p-4 mb-4",children:[e.jsxs("div",{className:"flex flex-wrap items-end gap-6",children:[e.jsxs("div",{className:"flex items-end gap-3",children:[e.jsx("div",{className:"w-1 h-6 rounded-full bg-primary/40 self-center"}),e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground self-center",children:[e.jsx(ia,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:"Responsáveis"})]}),e.jsxs("div",{className:"flex-1 min-w-[160px]",children:[e.jsx("label",{className:"text-[10px] font-medium text-muted-foreground mb-1 block uppercase tracking-wide",children:"Veterinário *"}),e.jsx(J,{placeholder:"Nome do veterinário",value:h.veterinario_responsavel,onChange:a=>K(s=>({...s,veterinario_responsavel:a.target.value})),className:"h-9"})]}),e.jsxs("div",{className:"flex-1 min-w-[160px]",children:[e.jsx("label",{className:"text-[10px] font-medium text-muted-foreground mb-1 block uppercase tracking-wide",children:"Técnico"}),e.jsx(J,{placeholder:"Nome do técnico",value:h.tecnico_responsavel,onChange:a=>K(s=>({...s,tecnico_responsavel:a.target.value})),className:"h-9"})]})]}),e.jsx("div",{className:"h-10 w-px bg-border hidden lg:block"}),e.jsxs("div",{className:"flex items-end gap-3",children:[e.jsx("div",{className:"w-1 h-6 rounded-full bg-emerald-500/40 self-center"}),e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground self-center",children:[e.jsx(na,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:"Local"})]}),e.jsxs("div",{className:"flex-1 min-w-[160px]",children:[e.jsx("label",{className:"text-[10px] font-medium text-muted-foreground mb-1 block uppercase tracking-wide",children:"Fazenda *"}),e.jsxs(de,{value:R,onValueChange:De,disabled:!h.veterinario_responsavel,children:[e.jsx(le,{className:"h-9",children:e.jsx(me,{placeholder:"Selecione a fazenda"})}),e.jsx(ue,{children:X.map(a=>e.jsx(M,{value:a.id,children:a.nome},a.id))})]})]}),e.jsxs("div",{className:"flex-1 min-w-[200px]",children:[e.jsx("label",{className:"text-[10px] font-medium text-muted-foreground mb-1 block uppercase tracking-wide",children:"Lote TE *"}),e.jsxs(de,{value:(n==null?void 0:n.id)||"",onValueChange:a=>{const s=xe.find(l=>l.id===a);q(s||null)},disabled:!R||be,children:[e.jsx(le,{className:"h-9",children:e.jsx(me,{placeholder:be?"Carregando...":"Selecione o lote"})}),e.jsx(ue,{children:xe.map(a=>{const s=a.dias_gestacao!==void 0&&a.dias_gestacao<O.DG;return e.jsx(M,{value:a.id,children:e.jsxs("span",{className:s?"text-amber-600":"",children:[Ee(a.data_te)," • ",a.dias_gestacao??"?","d • ",a.quantidade_receptoras," rec.",s&&" ⚠️"]})},a.id)})})]})]})]}),e.jsx("div",{className:"h-10 w-px bg-border hidden lg:block"}),e.jsx("div",{className:"flex items-end gap-3 ml-auto",children:e.jsxs(Me,{onClick:ze,disabled:!n||!He||fe||(n==null?void 0:n.status)==="FECHADO"||(n==null?void 0:n.dias_gestacao)!==void 0&&n.dias_gestacao<O.DG,className:"h-9 px-6 bg-primary hover:bg-primary-dark shadow-sm",children:[e.jsx(ca,{className:"w-4 h-4 mr-2"}),fe?"Salvando...":"Salvar Lote"]})})]}),n&&n.dias_gestacao!==void 0&&n.dias_gestacao<O.DG&&e.jsxs("div",{className:"flex items-center gap-2 mt-3 p-2 bg-amber-50 dark:bg-amber-950/50 border border-amber-200 dark:border-amber-800 rounded-lg",children:[e.jsx(da,{className:"h-4 w-4 text-amber-600 dark:text-amber-400 flex-shrink-0"}),e.jsxs("p",{className:"text-xs text-amber-700 dark:text-amber-300",children:["Este lote está com ",n.dias_gestacao," dias. DG requer mínimo de ",O.DG," dias (faltam ",O.DG-n.dias_gestacao,")."]})]})]}),Se?e.jsx(ne,{children:e.jsx(ce,{className:"py-8",children:e.jsx(Oe,{})})}):n&&x.length>0?e.jsxs(ne,{children:[e.jsx(Be,{className:"pb-3",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{children:[e.jsx(Ue,{className:"text-base",children:"Receptoras do Lote"}),e.jsxs(Qe,{children:[x.length," receptora(s) • TE em ",Ee(n.data_te)]})]}),n.status==="FECHADO"&&e.jsx(we,{variant:"secondary",children:"Lote Fechado"})]})})}),e.jsx(ce,{className:"pt-0",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(Ze,{children:[e.jsx(Je,{children:e.jsxs(Ne,{children:[e.jsx(D,{children:"Receptora"}),e.jsx(D,{children:"Dias Gest."}),e.jsx(D,{children:"Embrião"}),e.jsx(D,{children:"Doadora × Touro"}),e.jsx(D,{children:"Data DG"}),e.jsx(D,{children:"Resultado"}),e.jsx(D,{children:"Nº Gest."}),e.jsx(D,{children:"Obs."})]})}),e.jsx(Ke,{children:x.map(a=>{const s=H[a.receptora_id]||{resultado:"",numero_gestacoes:"",observacoes:"",data_diagnostico:pe},l=n.status==="FECHADO";return e.jsxs(Ne,{children:[e.jsx(S,{className:"font-medium",children:e.jsxs("div",{className:"flex items-center gap-2",children:[a.brinco,a.nome&&e.jsxs("span",{className:"text-muted-foreground text-xs",children:["(",a.nome,")"]})]})}),e.jsx(S,{children:e.jsxs(we,{variant:"outline",className:"font-mono",children:[a.dias_gestacao,"d"]})}),e.jsx(S,{children:e.jsx("div",{className:"space-y-0.5",children:a.embrioes.map((t,u)=>e.jsxs("div",{className:"text-sm",children:[t.embriao_identificacao||`#${u+1}`,t.embriao_classificacao&&e.jsxs("span",{className:"text-muted-foreground text-xs ml-1",children:["(",t.embriao_classificacao,")"]})]},t.te_id))})}),e.jsx(S,{children:e.jsx("div",{className:"space-y-0.5 text-sm",children:a.embrioes.map(t=>e.jsxs("div",{children:[t.doadora_registro||"-",t.touro_nome&&` × ${t.touro_nome}`]},t.te_id))})}),e.jsx(S,{children:e.jsx(ea,{value:s.data_diagnostico,onChange:t=>ee(a.receptora_id,"data_diagnostico",t||""),className:"w-32",disabled:l})}),e.jsx(S,{children:e.jsxs(de,{value:s.resultado,onValueChange:t=>ye(a.receptora_id,t),disabled:l,children:[e.jsx(le,{className:"w-28 h-9",children:e.jsx(me,{placeholder:"--"})}),e.jsxs(ue,{children:[e.jsx(M,{value:"PRENHE",children:"PRENHE"}),e.jsx(M,{value:"VAZIA",children:"VAZIA"}),e.jsx(M,{value:"RETOQUE",children:"RETOQUE"})]})]})}),e.jsx(S,{children:s.resultado==="PRENHE"||s.resultado==="RETOQUE"?e.jsx(J,{type:"number",min:"1",max:"3",value:s.numero_gestacoes,onChange:t=>ee(a.receptora_id,"numero_gestacoes",t.target.value),className:"w-16 h-9",disabled:l}):e.jsx("span",{className:"text-muted-foreground",children:"-"})}),e.jsx(S,{children:e.jsx(J,{value:s.observacoes,onChange:t=>ee(a.receptora_id,"observacoes",t.target.value),placeholder:"Obs.",className:"w-32 h-9",disabled:l})})]},a.receptora_id)})})]})})})]}):n&&x.length===0?e.jsx(ne,{children:e.jsx(ce,{className:"py-8 text-center text-muted-foreground",children:"Nenhuma receptora encontrada neste lote"})}):null]})]})}export{Qa as default};
