import{r as o,j as e,p as we,I as ke,P as se,w as me,o as oe,a8 as Ee,h as ne,d as Se,s as N,i as Te,B as q,U as K,a9 as J}from"./index-BPMeM9-O.js";import{C as O,d as H,a as Pe,b as Ue}from"./card-8azKTSNJ.js";import{T as Ie,a as De,b as ce,c as R,d as Re,e as A}from"./table-l_s8S0JA.js";import{D as Ae,b as Be,c as Fe,d as Le,e as qe}from"./dialog-CLDnxY7R.js";import{g as Oe,S as W,a as Q,b as Y,c as Z,d as T}from"./select-La4nrp5K.js";import{I as ee}from"./input-tqcTRdPv.js";import{L as B}from"./label-fluRYl3j.js";import{u as He}from"./index-C5PY5DOm.js";import{C as ze}from"./check-Bdb-Yd05.js";import{B as $}from"./badge-CeJDYfYs.js";import{S as le}from"./switch-CZPJOLE5.js";import{P as Me}from"./PageHeader-DQ4rM2jO.js";import{E as de}from"./EmptyState-yqSFIU3C.js";import{u as $e}from"./use-toast-BGNwDi9e.js";import{P as Ve}from"./plus-Ah0p7ggz.js";import{F as Ge}from"./filter-DouKIrIu.js";import{S as Xe}from"./search-SyV5imYB.js";import{X as Ke}from"./x-BxiwAMrM.js";import{S as Je}from"./square-pen-qjgDjx3q.js";var V="Checkbox",[We,bs]=we(V),[Qe,re]=We(V);function Ye(t){const{__scopeCheckbox:l,checked:m,children:j,defaultChecked:n,disabled:i,form:C,name:y,onCheckedChange:g,required:k,value:p="on",internal_do_not_use_render:x}=t,[u,S]=He({prop:m,defaultProp:n??!1,onChange:g,caller:V}),[E,b]=o.useState(null),[c,d]=o.useState(null),h=o.useRef(!1),U=E?!!C||!!E.closest("form"):!0,r={checked:u,disabled:i,setChecked:S,control:E,setControl:b,name:y,form:C,value:p,hasConsumerStoppedPropagationRef:h,required:k,defaultChecked:P(n)?!1:n,isFormControl:U,bubbleInput:c,setBubbleInput:d};return e.jsx(Qe,{scope:l,...r,children:Ze(x)?x(r):j})}var ue="CheckboxTrigger",he=o.forwardRef(({__scopeCheckbox:t,onKeyDown:l,onClick:m,...j},n)=>{const{control:i,value:C,disabled:y,checked:g,required:k,setControl:p,setChecked:x,hasConsumerStoppedPropagationRef:u,isFormControl:S,bubbleInput:E}=re(ue,t),b=me(n,p),c=o.useRef(g);return o.useEffect(()=>{const d=i==null?void 0:i.form;if(d){const h=()=>x(c.current);return d.addEventListener("reset",h),()=>d.removeEventListener("reset",h)}},[i,x]),e.jsx(se.button,{type:"button",role:"checkbox","aria-checked":P(g)?"mixed":g,"aria-required":k,"data-state":ge(g),"data-disabled":y?"":void 0,disabled:y,value:C,...j,ref:b,onKeyDown:oe(l,d=>{d.key==="Enter"&&d.preventDefault()}),onClick:oe(m,d=>{x(h=>P(h)?!0:!h),E&&S&&(u.current=d.isPropagationStopped(),u.current||d.stopPropagation())})})});he.displayName=ue;var te=o.forwardRef((t,l)=>{const{__scopeCheckbox:m,name:j,checked:n,defaultChecked:i,required:C,disabled:y,value:g,onCheckedChange:k,form:p,...x}=t;return e.jsx(Ye,{__scopeCheckbox:m,checked:n,defaultChecked:i,disabled:y,required:C,onCheckedChange:k,name:j,form:p,value:g,internal_do_not_use_render:({isFormControl:u})=>e.jsxs(e.Fragment,{children:[e.jsx(he,{...x,ref:l,__scopeCheckbox:m}),u&&e.jsx(je,{__scopeCheckbox:m})]})})});te.displayName=V;var pe="CheckboxIndicator",xe=o.forwardRef((t,l)=>{const{__scopeCheckbox:m,forceMount:j,...n}=t,i=re(pe,m);return e.jsx(ke,{present:j||P(i.checked)||i.checked===!0,children:e.jsx(se.span,{"data-state":ge(i.checked),"data-disabled":i.disabled?"":void 0,...n,ref:l,style:{pointerEvents:"none",...t.style}})})});xe.displayName=pe;var fe="CheckboxBubbleInput",je=o.forwardRef(({__scopeCheckbox:t,...l},m)=>{const{control:j,hasConsumerStoppedPropagationRef:n,checked:i,defaultChecked:C,required:y,disabled:g,name:k,value:p,form:x,bubbleInput:u,setBubbleInput:S}=re(fe,t),E=me(m,S),b=Oe(i),c=Ee(j);o.useEffect(()=>{const h=u;if(!h)return;const U=window.HTMLInputElement.prototype,v=Object.getOwnPropertyDescriptor(U,"checked").set,F=!n.current;if(b!==i&&v){const L=new Event("click",{bubbles:F});h.indeterminate=P(i),v.call(h,P(i)?!1:i),h.dispatchEvent(L)}},[u,b,i,n]);const d=o.useRef(P(i)?!1:i);return e.jsx(se.input,{type:"checkbox","aria-hidden":!0,defaultChecked:C??d.current,required:y,disabled:g,name:k,value:p,form:x,...l,tabIndex:-1,ref:E,style:{...l.style,...c,position:"absolute",pointerEvents:"none",opacity:0,margin:0,transform:"translateX(-100%)"}})});je.displayName=fe;function Ze(t){return typeof t=="function"}function P(t){return t==="indeterminate"}function ge(t){return P(t)?"indeterminate":t?"checked":"unchecked"}const be=o.forwardRef(({className:t,...l},m)=>e.jsx(te,{ref:m,className:ne("peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",t),...l,children:e.jsx(xe,{className:ne("flex items-center justify-center text-current"),children:e.jsx(ze,{className:"h-4 w-4"})})}));be.displayName=te.displayName;function vs(){const{toast:t}=$e(),{permissions:l}=Se(),[m,j]=o.useState(!0),[n,i]=o.useState([]),[C,y]=o.useState([]),[g,k]=o.useState([]),[p,x]=o.useState(""),[u,S]=o.useState("todos"),[E,b]=o.useState(!1),[c,d]=o.useState(null),[h,U]=o.useState(!1),[r,v]=o.useState({nome:"",email:"",user_type:"operacional",cliente_id:"",active:!0,hub_permissions:[]}),F=l==null?void 0:l.isAdmin;o.useEffect(()=>{F&&L()},[F]);const L=async()=>{try{j(!0);const{data:s,error:a}=await N.from("hubs").select("*").order("display_order");if(a)throw a;y(s||[]);const{data:f,error:_}=await N.from("clientes").select("id, nome").order("nome");if(_)throw _;k(f||[]);const{data:w,error:I}=await N.from("user_profiles").select("*").order("nome");if(I)throw I;const{data:z,error:M}=await N.from("user_hub_permissions").select("user_id, hub_code").eq("can_access",!0);if(M)throw M;const X=new Map;(z||[]).forEach(D=>{const ie=X.get(D.user_id)||[];ie.push(D.hub_code),X.set(D.user_id,ie)});const ye=(w||[]).map(D=>({...D,hub_permissions:X.get(D.id)||[]}));i(ye)}catch(s){t({title:"Erro ao carregar dados",description:s instanceof Error?s.message:"Erro desconhecido",variant:"destructive"})}finally{j(!1)}},G=n.filter(s=>{var _,w;const a=!p||((_=s.nome)==null?void 0:_.toLowerCase().includes(p.toLowerCase()))||((w=s.email)==null?void 0:w.toLowerCase().includes(p.toLowerCase())),f=u==="todos"||s.user_type===u;return a&&f}),ae=s=>{s?(d(s),v({nome:s.nome||"",email:s.email||"",user_type:s.user_type,cliente_id:s.cliente_id||"",active:s.active,hub_permissions:s.hub_permissions})):(d(null),v({nome:"",email:"",user_type:"operacional",cliente_id:"",active:!0,hub_permissions:[]})),b(!0)},ve=s=>{v(a=>{const f=a.hub_permissions;return f.includes(s)?{...a,hub_permissions:f.filter(_=>_!==s)}:{...a,hub_permissions:[...f,s]}})},_e=async s=>{if(s.preventDefault(),!r.nome.trim()||!r.email.trim()){t({title:"Erro de validação",description:"Nome e email são obrigatórios",variant:"destructive"});return}if(r.user_type==="cliente"&&!r.cliente_id){t({title:"Erro de validação",description:"Selecione um cliente para usuários do tipo Cliente",variant:"destructive"});return}try{if(U(!0),c){const{error:a}=await N.from("user_profiles").update({nome:r.nome,user_type:r.user_type,cliente_id:r.user_type==="cliente"?r.cliente_id:null,active:r.active}).eq("id",c.id);if(a)throw a;const{error:f}=await N.from("user_hub_permissions").delete().eq("user_id",c.id);if(f)throw f;if(r.hub_permissions.length>0&&r.user_type!=="admin"){const _=r.hub_permissions.map(I=>({user_id:c.id,hub_code:I,can_access:!0})),{error:w}=await N.from("user_hub_permissions").insert(_);if(w)throw w}t({title:"Usuário atualizado",description:"Perfil e permissões atualizados com sucesso"})}else{const{data:a,error:f}=await N.from("user_profiles").select("id").eq("email",r.email.toLowerCase()).maybeSingle();if(f)throw f;if(a){t({title:"Usuário já existe",description:"Já existe um perfil para este email. Use a opção de editar.",variant:"destructive"});return}const{data:_,error:w}=await N.from("user_profiles").insert({nome:r.nome,email:r.email.toLowerCase(),user_type:r.user_type,cliente_id:r.user_type==="cliente"?r.cliente_id:null,active:r.active}).select().single();if(w)throw w;if(r.hub_permissions.length>0&&r.user_type!=="admin"){const I=r.hub_permissions.map(M=>({user_id:_.id,hub_code:M,can_access:!0})),{error:z}=await N.from("user_hub_permissions").insert(I);if(z)throw z}t({title:"Usuário criado",description:"Perfil criado. O usuário precisa fazer cadastro com este email."})}b(!1),L()}catch(a){t({title:"Erro ao salvar",description:a instanceof Error?a.message:"Erro desconhecido",variant:"destructive"})}finally{U(!1)}},Ne=async s=>{try{const{error:a}=await N.from("user_profiles").update({active:!s.active}).eq("id",s.id);if(a)throw a;t({title:s.active?"Usuário desativado":"Usuário ativado",description:`${s.nome} foi ${s.active?"desativado":"ativado"}`}),L()}catch(a){t({title:"Erro ao atualizar",description:a instanceof Error?a.message:"Erro desconhecido",variant:"destructive"})}},Ce=s=>{switch(s){case"admin":return e.jsx($,{className:"bg-primary-subtle text-primary-subtle-foreground",children:"Admin"});case"cliente":return e.jsx($,{className:"bg-secondary text-secondary-foreground",children:"Cliente"});default:return e.jsx($,{variant:"outline",className:"text-muted-foreground",children:"Operacional"})}};return F?m?e.jsx(Te,{}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(Me,{title:"Administração de Usuários",description:"Gerencie perfis e permissões de acesso",actions:e.jsxs(q,{onClick:()=>ae(),children:[e.jsx(Ve,{className:"w-4 h-4 mr-2"}),"Novo Usuário"]})}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(O,{children:e.jsx(H,{className:"pt-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{className:"w-5 h-5 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total"}),e.jsx("p",{className:"text-2xl font-bold",children:n.length})]})]})})}),e.jsx(O,{children:e.jsx(H,{className:"pt-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(J,{className:"w-5 h-5 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Admins"}),e.jsx("p",{className:"text-2xl font-bold",children:n.filter(s=>s.user_type==="admin").length})]})]})})}),e.jsx(O,{children:e.jsx(H,{className:"pt-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{className:"w-5 h-5 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Operacionais"}),e.jsx("p",{className:"text-2xl font-bold",children:n.filter(s=>s.user_type==="operacional").length})]})]})})}),e.jsx(O,{children:e.jsx(H,{className:"pt-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{className:"w-5 h-5 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Clientes"}),e.jsx("p",{className:"text-2xl font-bold",children:n.filter(s=>s.user_type==="cliente").length})]})]})})})]}),e.jsx("div",{className:"rounded-xl border border-border bg-gradient-to-r from-card via-card to-muted/30 p-4",children:e.jsxs("div",{className:"flex flex-wrap items-end gap-6",children:[e.jsxs("div",{className:"flex items-end gap-3",children:[e.jsx("div",{className:"w-1 h-6 rounded-full bg-primary/40 self-center"}),e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground self-center",children:[e.jsx(Ge,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:"Busca"})]}),e.jsxs("div",{className:"relative flex-1 min-w-[250px]",children:[e.jsx(Xe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(ee,{placeholder:"Buscar por nome ou email...",value:p,onChange:s=>x(s.target.value),className:"pl-9 h-9"})]})]}),e.jsx("div",{className:"h-10 w-px bg-border hidden lg:block"}),e.jsxs("div",{className:"flex items-end gap-3",children:[e.jsx("div",{className:"w-1 h-6 rounded-full bg-emerald-500/40 self-center"}),e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground self-center",children:[e.jsx(J,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:"Tipo"})]}),e.jsx("div",{className:"w-[160px]",children:e.jsxs(W,{value:u,onValueChange:S,children:[e.jsx(Q,{className:"h-9",children:e.jsx(Y,{placeholder:"Tipo"})}),e.jsxs(Z,{children:[e.jsx(T,{value:"todos",children:"Todos"}),e.jsx(T,{value:"admin",children:"Admin"}),e.jsx(T,{value:"operacional",children:"Operacional"}),e.jsx(T,{value:"cliente",children:"Cliente"})]})]})})]}),(p||u!=="todos")&&e.jsxs(q,{variant:"outline",size:"sm",onClick:()=>{x(""),S("todos")},className:"h-9 ml-auto",children:[e.jsx(Ke,{className:"w-4 h-4 mr-2"}),"Limpar Filtros"]})]})}),e.jsxs(O,{children:[e.jsx(Pe,{children:e.jsxs(Ue,{children:["Usuários (",G.length,")"]})}),e.jsx(H,{children:G.length===0?e.jsx(de,{title:"Nenhum usuário encontrado",description:p||u!=="todos"?"Tente ajustar os filtros":"Cadastre o primeiro usuário"}):e.jsxs(Ie,{children:[e.jsx(De,{children:e.jsxs(ce,{children:[e.jsx(R,{children:"Nome"}),e.jsx(R,{children:"Email"}),e.jsx(R,{children:"Tipo"}),e.jsx(R,{children:"Hubs"}),e.jsx(R,{children:"Ativo"}),e.jsx(R,{className:"text-right",children:"Ações"})]})}),e.jsx(Re,{children:G.map(s=>e.jsxs(ce,{className:s.active?"":"opacity-50",children:[e.jsx(A,{className:"font-medium",children:s.nome||"-"}),e.jsx(A,{children:s.email}),e.jsx(A,{children:Ce(s.user_type)}),e.jsx(A,{children:s.user_type==="admin"?e.jsx("span",{className:"text-primary text-sm font-medium",children:"Acesso total"}):s.hub_permissions.length>0?e.jsx("div",{className:"flex flex-wrap gap-1",children:s.hub_permissions.map(a=>e.jsx($,{variant:"outline",className:"text-xs",children:a},a))}):e.jsx("span",{className:"text-muted-foreground text-sm",children:"Nenhum"})}),e.jsx(A,{children:e.jsx(le,{checked:s.active,onCheckedChange:()=>Ne(s)})}),e.jsx(A,{className:"text-right",children:e.jsxs(q,{variant:"ghost",size:"sm",onClick:()=>ae(s),children:[e.jsx(Je,{className:"w-4 h-4 mr-1"}),"Editar"]})})]},s.id))})]})})]}),e.jsx(Ae,{open:E,onOpenChange:b,children:e.jsxs(Be,{className:"max-w-lg",children:[e.jsxs(Fe,{children:[e.jsx(Le,{children:c?"Editar Usuário":"Novo Usuário"}),e.jsx(qe,{children:c?`Editando ${c.nome||c.email}`:"Preencha os dados do novo usuário"})]}),e.jsxs("form",{onSubmit:_e,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"nome",children:"Nome *"}),e.jsx(ee,{id:"nome",value:r.nome,onChange:s=>v({...r,nome:s.target.value}),placeholder:"Nome completo",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"email",children:"Email *"}),e.jsx(ee,{id:"email",type:"email",value:r.email,onChange:s=>v({...r,email:s.target.value}),placeholder:"email@exemplo.com",required:!0,disabled:!!c}),!c&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"O usuário precisará fazer cadastro com este email"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"user_type",children:"Tipo de Usuário *"}),e.jsxs(W,{value:r.user_type,onValueChange:s=>v({...r,user_type:s}),children:[e.jsx(Q,{children:e.jsx(Y,{})}),e.jsxs(Z,{children:[e.jsx(T,{value:"admin",children:"Admin (acesso total)"}),e.jsx(T,{value:"operacional",children:"Operacional"}),e.jsx(T,{value:"cliente",children:"Cliente"})]})]})]}),r.user_type==="cliente"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"cliente_id",children:"Cliente Vinculado *"}),e.jsxs(W,{value:r.cliente_id,onValueChange:s=>v({...r,cliente_id:s}),children:[e.jsx(Q,{children:e.jsx(Y,{placeholder:"Selecione o cliente"})}),e.jsx(Z,{children:g.map(s=>e.jsx(T,{value:s.id,children:s.nome},s.id))})]})]}),r.user_type!=="admin"&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs(B,{className:"flex items-center gap-2",children:[e.jsx(J,{className:"w-4 h-4"}),"Permissões de Acesso"]}),e.jsx("div",{className:"grid grid-cols-2 gap-3 p-3 border rounded-lg",children:C.map(s=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(be,{id:`hub-${s.code}`,checked:r.hub_permissions.includes(s.code),onCheckedChange:()=>ve(s.code)}),e.jsx("label",{htmlFor:`hub-${s.code}`,className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 cursor-pointer",children:s.name})]},s.id))}),r.hub_permissions.length===0&&e.jsx("p",{className:"text-xs text-amber-600",children:"Sem permissões, o usuário não terá acesso a nenhum hub"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(le,{id:"active",checked:r.active,onCheckedChange:s=>v({...r,active:s})}),e.jsx(B,{htmlFor:"active",children:"Usuário ativo"})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(q,{type:"submit",className:"flex-1",disabled:h,children:h?"Salvando...":c?"Salvar":"Criar Usuário"}),e.jsx(q,{type:"button",variant:"outline",onClick:()=>b(!1),children:"Cancelar"})]})]})]})})]}):e.jsx("div",{className:"space-y-6",children:e.jsx(de,{title:"Acesso negado",description:"Apenas administradores podem acessar esta página."})})}export{vs as default};
