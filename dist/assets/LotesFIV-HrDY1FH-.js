import{r as d,s as p,a as ba,j as e,B as oe,U as ua,h as Na,i as ka}from"./index-6OJhfjKP.js";import{C as Ue,a as Qe,b as Ze,d as Xe}from"./card-D-gf0lmS.js";import{T as aa,a as sa,b as Fe,c as Q,d as ta,e as Z}from"./table-B_Z-CztY.js";import{S as oa,a as ia,b as ra,c as na,d as da,C as Ha,e as Ra}from"./select-B7v4ZPbC.js";import{I as Te}from"./input-_UHZ9n1P.js";import{L as ne}from"./label-BTrzYRkl.js";import{B as Le}from"./badge-ChTtRB_d.js";import{P as Va}from"./PageHeader-P7sO2uqv.js";import{E as Fa}from"./EmptyState-CEfkJzHC.js";import{u as Me}from"./use-toast-DasFaehQ.js";import{h as ca}from"./error-handler-CXUXfXq4.js";import{e as Pe,t as wa,d as Da,f as ue,a as Ua,g as Qa}from"./dateUtils-eJ5e6apA.js";import{T as Za,a as Xa,b as za,c as Aa}from"./tabs-DFK_xrkO.js";import{D as ha,a as Ga,b as fa,c as _a,d as va,e as ja}from"./dialog-CFjhGf-B.js";import{T as La}from"./textarea-DMqLWH95.js";import{P as qa}from"./plus-Dnfaq_2C.js";import{A as Ya}from"./arrow-left-B6Z7dGLk.js";import{F as Ja}from"./file-text-BxNF5_jJ.js";import{P as ga}from"./package-Ci8DGI0W.js";import{D as ya}from"./DatePickerBR-CEQaSWUC.js";import{X as Ia}from"./x-kO07YPaG.js";import{S as Ka}from"./search-DHWddfjN.js";import{E as Wa}from"./eye-BPc5Q01W.js";import"./index-CtR1jODk.js";import"./check-CgmfRmMI.js";import"./index-ea8B15na.js";import"./chevron-right-BdMx8zjt.js";import"./popover-CUxnE3Xp.js";function xa(a){return{[-1]:"Aspira√ß√£o",0:"Fecunda√ß√£o",1:"Zigoto",2:"Clivagem",3:"Clivagem Avan√ßada",4:"Compacta√ß√£o",5:"M√≥rula / Blastocisto Inicial",6:"Blastocisto",7:"Blastocisto Expandido",8:"Resgate / Sa√≠da Tardia"}[a]||`Dia ${a}`}function es(a){return a===-1?"bg-blue-100 text-blue-800 border-blue-300":a===0?"bg-green-100 text-green-800 border-green-300":a>=1&&a<=3?"bg-yellow-100 text-yellow-800 border-yellow-300":a>=4&&a<=5||a===6?"bg-orange-100 text-orange-800 border-orange-300":a===7?"bg-purple-100 text-purple-800 border-purple-300":a===8?"bg-red-100 text-red-800 border-red-300":"bg-slate-100 text-slate-800 border-slate-300"}const Oa="lotes_fiv_filtros";function Ba(){try{const a=localStorage.getItem(Oa);return a?JSON.parse(a):{}}catch{return{}}}function as(a){try{localStorage.setItem(Oa,JSON.stringify(a))}catch{}}const Ca=8;function ss(a){return a===0?-1:a>9?8:a-1}function ts({lotes:a,pacotesParaFiltro:b,fazendasAspiracaoUnicas:t,lotesHistoricos:E}){const[r]=d.useState(()=>Ba()),[c,m]=d.useState(r.filtroFazendaAspiracao??""),[N,ee]=d.useState(r.filtroFazendaAspiracaoBusca??""),[j,X]=d.useState(r.filtroDiaCultivo??""),[S,G]=d.useState(!1),[Y,J]=d.useState(r.filtroHistoricoDataInicio??""),[K,R]=d.useState(r.filtroHistoricoDataFim??""),[ae,f]=d.useState(r.filtroHistoricoFazenda??""),[z,A]=d.useState(r.filtroHistoricoFazendaBusca??""),[L,q]=d.useState(!1),[h,x]=d.useState(r.abaAtiva??"ativos"),[V,B]=d.useState(r.historicoPage??1);d.useEffect(()=>{as({abaAtiva:h,filtroFazendaAspiracao:c,filtroFazendaAspiracaoBusca:N,filtroDiaCultivo:j,filtroHistoricoDataInicio:Y,filtroHistoricoDataFim:K,filtroHistoricoFazenda:ae,filtroHistoricoFazendaBusca:z,historicoPage:V})},[h,c,N,j,Y,K,ae,z,V]),d.useEffect(()=>{B(1)},[Y,K,ae]),d.useEffect(()=>{const i=Math.max(1,Math.ceil(E.length/Ca));V>i&&B(i)},[E.length,V]),d.useEffect(()=>{const i=n=>{const v=n.target;v.closest(".fazenda-busca-container")||G(!1),v.closest(".fazenda-busca-historico-container")||q(!1)};if(S||L)return document.addEventListener("mousedown",i),()=>{document.removeEventListener("mousedown",i)}},[S,L]);const _=d.useMemo(()=>{let i=[...a];if(i=i.filter(n=>n.status==="FECHADO"||n.dia_atual!==void 0&&n.dia_atual>9?!1:n.dia_atual!==void 0&&n.dia_atual<=9),c&&(i=i.filter(n=>{const v=b.find(O=>O.id===n.pacote_aspiracao_id);return(v==null?void 0:v.fazenda_id)===c})),j!==""){const n=parseInt(j);i=i.filter(v=>v.dia_atual===void 0||v.dia_atual===null?!1:(v.dia_atual===0?-1:v.dia_atual-1)===n)}return i},[a,c,j,b]),w=d.useMemo(()=>t.filter(i=>i.nome.toLowerCase().includes(N.toLowerCase())),[t,N]);return{filtroFazendaAspiracao:c,setFiltroFazendaAspiracao:m,filtroFazendaAspiracaoBusca:N,setFiltroFazendaAspiracaoBusca:ee,filtroDiaCultivo:j,setFiltroDiaCultivo:X,showFazendaBusca:S,setShowFazendaBusca:G,fazendasFiltradas:w,lotesFiltrados:_,limparFiltrosAtivos:()=>{m(""),ee(""),X(""),G(!1)},filtroHistoricoDataInicio:Y,setFiltroHistoricoDataInicio:J,filtroHistoricoDataFim:K,setFiltroHistoricoDataFim:R,filtroHistoricoFazenda:ae,setFiltroHistoricoFazenda:f,filtroHistoricoFazendaBusca:z,setFiltroHistoricoFazendaBusca:A,showFazendaBuscaHistorico:L,setShowFazendaBuscaHistorico:q,limparFiltrosHistorico:()=>{J(""),R(""),f(""),A(""),q(!1),B(1)},abaAtiva:h,setAbaAtiva:x,historicoPage:V,setHistoricoPage:B,HISTORICO_PAGE_SIZE:Ca}}function os(){const{toast:a}=Me(),[b,t]=d.useState([]),[E,r]=d.useState([]),[c,m]=d.useState([]),[N,ee]=d.useState([]),[j,X]=d.useState([]),[S,G]=d.useState(!0),[Y,J]=d.useState([]),[K,R]=d.useState([]),ae=d.useCallback(async()=>{try{G(!0);const{data:f,error:z}=await p.from("pacotes_aspiracao").select("*").eq("status","FINALIZADO").order("data_aspiracao",{ascending:!1});if(z)throw z;const{data:A,error:L}=await p.from("fazendas").select("id, nome").order("nome",{ascending:!0});if(L)throw L;m(A||[]);const{data:q,error:h}=await p.from("clientes").select("id, nome").order("nome",{ascending:!0});h||X(q||[]);const x=new Map(A==null?void 0:A.map(o=>[o.id,o.nome])),V=new Map,B=new Map,_=(f==null?void 0:f.map(o=>o.id))||[];if(_.length>0){const{data:o,error:M}=await p.from("pacotes_aspiracao_fazendas_destino").select("pacote_aspiracao_id, fazenda_destino_id").in("pacote_aspiracao_id",_);!M&&o&&o.forEach(U=>{const ce=x.get(U.fazenda_destino_id);if(ce){const ve=V.get(U.pacote_aspiracao_id)||[];ve.push(ce),V.set(U.pacote_aspiracao_id,ve)}});const{data:C,error:F}=await p.from("aspiracoes_doadoras").select("pacote_aspiracao_id").in("pacote_aspiracao_id",_);!F&&C&&C.forEach(U=>{U.pacote_aspiracao_id&&B.set(U.pacote_aspiracao_id,(B.get(U.pacote_aspiracao_id)||0)+1)})}const{data:w,error:D}=await p.from("lotes_fiv").select("*").order("data_abertura",{ascending:!1});if(D)throw D;const I=new Set((w==null?void 0:w.map(o=>o.pacote_aspiracao_id).filter(o=>!!o))||[]),n=(f||[]).filter(o=>o.usado_em_lote_fiv!==void 0?!o.usado_em_lote_fiv:!I.has(o.id)).map(o=>({...o,fazenda_nome:x.get(o.fazenda_id),fazendas_destino_nomes:V.get(o.id)||[],quantidade_doadoras:B.get(o.id)||0}));r(n);const v=(w==null?void 0:w.map(o=>o.id))||[],{data:O,error:y}=await p.from("lote_fiv_acasalamentos").select("lote_fiv_id").in("lote_fiv_id",v);if(y)throw y;const k=new Map;O==null||O.forEach(o=>{k.set(o.lote_fiv_id,(k.get(o.lote_fiv_id)||0)+1)});const{data:H,error:T}=await p.from("lote_fiv_fazendas_destino").select("lote_fiv_id, fazenda_id").in("lote_fiv_id",v);if(T)throw T;const s=new Map;H==null||H.forEach(o=>{const M=x.get(o.fazenda_id);if(M){const C=s.get(o.lote_fiv_id)||[];C.push(M),s.set(o.lote_fiv_id,C)}});const l=new Map(n.map(o=>[o.id,o]));(f||[]).forEach(o=>{l.has(o.id)||l.set(o.id,{...o,fazenda_nome:x.get(o.fazenda_id),fazendas_destino_nomes:V.get(o.id)||[],quantidade_doadoras:B.get(o.id)||0})});const P=(w||[]).map(o=>{const M=l.get(o.pacote_aspiracao_id);let C=Pe((M==null?void 0:M.data_aspiracao)||null);if(!C){const ce=Pe(o.data_abertura);if(ce){const[ve,he,De]=ce.split("-").map(Number),pe=new Date(ve,he-1,De);pe.setDate(pe.getDate()-1);const je=pe.getFullYear(),fe=String(pe.getMonth()+1).padStart(2,"0"),we=String(pe.getDate()).padStart(2,"0");C=`${je}-${fe}-${we}`}}const F=wa(),U=C?Math.max(0,Da(C,F)):0;return{...o,pacote_nome:M==null?void 0:M.fazenda_nome,pacote_data:M==null?void 0:M.data_aspiracao,fazendas_destino_nomes:s.get(o.id)||[],quantidade_acasalamentos:k.get(o.id)||0,dia_atual:U}}),W=P.filter(o=>o.status==="ABERTO"&&o.dia_atual!==void 0&&o.dia_atual>9);if(W.length>0){const o=W.map(C=>C.id),{error:M}=await p.from("lotes_fiv").update({status:"FECHADO"}).in("id",o);M&&a({title:"Aviso",description:"N√£o foi poss√≠vel fechar automaticamente alguns lotes expirados. Recarregue a p√°gina.",variant:"destructive"}),M||W.forEach(C=>{C.status="FECHADO"})}t(P);const te=new Set(P.map(o=>o.pacote_aspiracao_id).filter(o=>!!o)),de=[];(f||[]).forEach(o=>{te.has(o.id)&&de.push({...o,fazenda_nome:x.get(o.fazenda_id),fazendas_destino_nomes:V.get(o.id)||[],quantidade_doadoras:B.get(o.id)||0})}),J(de);const me=new Map;de.forEach(o=>{o.fazenda_id&&o.fazenda_nome&&me.set(o.fazenda_id,o.fazenda_nome)}),R(Array.from(me.entries()).map(([o,M])=>({id:o,nome:M})).sort((o,M)=>o.nome.localeCompare(M.nome)))}catch(f){ca(f,"Erro ao carregar dados")}finally{G(!1)}},[a]);return{lotes:b,pacotes:E,fazendas:c,setFazendas:m,doadoras:N,setDoadoras:ee,clientes:j,setClientes:X,loading:S,setLoading:G,pacotesParaFiltro:Y,fazendasAspiracaoUnicas:K,loadData:ae}}function is({setFazendas:a,setDoadoras:b,setClientes:t,setLoading:E}){const{toast:r}=Me(),[c,m]=d.useState(null),[N,ee]=d.useState(!1),[j,X]=d.useState([]),[S,G]=d.useState([]),[Y,J]=d.useState([]),[K,R]=d.useState([]),[ae,f]=d.useState([]),[z,A]=d.useState(""),[L,q]=d.useState([]),[h,x]=d.useState([]),[V,B]=d.useState(""),_=d.useCallback(async D=>{try{const{data:I,error:i}=await p.from("embrioes").select("id, lote_fiv_acasalamento_id, created_at").eq("lote_fiv_id",D).order("created_at",{ascending:!1});if(i){J([]);return}const n=new Map;I==null||I.forEach(y=>{if(y.created_at){const k=y.created_at.split("T")[0],H=n.get(k)||[];H.push(y),n.set(k,H)}});const v=[...new Set((I==null?void 0:I.map(y=>y.lote_fiv_acasalamento_id).filter(Boolean))||[])];if(v.length>0){const{data:y,error:k}=await p.from("lote_fiv_acasalamentos").select("id, aspiracao_doadora_id, dose_semen_id").in("id",v);if(!k&&y){const H=[...new Set(y.map(F=>F.aspiracao_doadora_id).filter(Boolean))],{data:T}=await p.from("aspiracoes_doadoras").select("id, doadora_id").in("id",H),s=[...new Set((T==null?void 0:T.map(F=>F.doadora_id).filter(Boolean))||[])],{data:l}=await p.from("doadoras").select("id, registro, nome").in("id",s),P=[...new Set(y.map(F=>F.dose_semen_id).filter(Boolean))],{data:W}=await p.from("doses_semen").select("id, touro_id, touro:touros(id, nome, registro, raca)").in("id",P),te=new Map((T==null?void 0:T.map(F=>[F.id,F]))||[]),de=new Map((l==null?void 0:l.map(F=>[F.id,F]))||[]),me=new Map((W==null?void 0:W.map(F=>[F.id,F]))||[]),o=new Map(y.map(F=>[F.id,F])),C=Array.from(n.keys()).sort((F,U)=>U.localeCompare(F)).map(F=>{const U=n.get(F)||[],ce=new Map;U.forEach(he=>{he.lote_fiv_acasalamento_id&&ce.set(he.lote_fiv_acasalamento_id,(ce.get(he.lote_fiv_acasalamento_id)||0)+1)});const ve=Array.from(ce.entries()).map(([he,De])=>{var Oe;const pe=o.get(he),je=pe?te.get(pe.aspiracao_doadora_id):void 0,fe=je?de.get(je.doadora_id):void 0,we=pe?me.get(pe.dose_semen_id):void 0;return{acasalamento_id:he,quantidade:De,doadora:(fe==null?void 0:fe.registro)||(fe==null?void 0:fe.nome)||"-",dose:we?((Oe=we.touro)==null?void 0:Oe.nome)||"Touro desconhecido":"-"}});return{id:`${D}-${F}`,data_despacho:F,acasalamentos:ve}});J(C);return}}const O=Array.from(n.keys()).map(y=>({id:`${D}-${y}`,data_despacho:y,acasalamentos:[]}));J(O)}catch{J([])}},[]),w=d.useCallback(async D=>{try{E(!0);const{data:I,error:i}=await p.from("lotes_fiv").select("*").eq("id",D).single();if(i)throw i;const{data:n,error:v}=await p.from("pacotes_aspiracao").select("*").eq("id",I.pacote_aspiracao_id).single();if(v){if(v.code==="PGRST116"){r({title:"Pacote n√£o encontrado",description:"O lote referencia um pacote de aspira√ß√£o inexistente. Verifique o v√≠nculo do lote.",variant:"destructive"}),E(!1);return}throw v}B(n.data_aspiracao);const{data:O,error:y}=await p.from("fazendas").select("nome").eq("id",n.fazenda_id).single();A(y?"":(O==null?void 0:O.nome)||"");const{data:k}=await p.from("pacotes_aspiracao_fazendas_destino").select("fazenda_destino_id").eq("pacote_aspiracao_id",n.id);let H=[];if(!k||k.length===0?n.fazenda_destino_id&&(H=[n.fazenda_destino_id]):H=k.map(g=>g.fazenda_destino_id),G(H),H.length>0){const{data:g,error:xe}=await p.from("fazendas").select("id, nome").in("id",H);xe?q([]):(q((g==null?void 0:g.map(ie=>ie.nome))||[]),g&&a(ie=>{const _e=[...ie];return g.forEach(se=>{_e.find(ge=>ge.id===se.id)||_e.push(se)}),_e}))}else q([]);const{data:T,error:s}=await p.from("lote_fiv_acasalamentos").select("*").eq("lote_fiv_id",D).order("created_at",{ascending:!0});if(s)throw s;const l=(T==null?void 0:T.map(g=>g.aspiracao_doadora_id))||[],{data:P,error:W}=await p.from("aspiracoes_doadoras").select("id, doadora_id, viaveis").in("id",l);if(W)throw W;const te=[...new Set((P==null?void 0:P.map(g=>g.doadora_id))||[])],{data:de,error:me}=await p.from("doadoras").select("id, nome, registro").in("id",te);if(me)throw me;const o=[...new Set((T==null?void 0:T.map(g=>g.dose_semen_id))||[])],{data:M,error:C}=await p.from("doses_semen").select("id, touro_id, touro:touros(id, nome, registro, raca)").in("id",o);if(C)throw C;const F=new Map(de==null?void 0:de.map(g=>[g.id,g])),U=new Map(M==null?void 0:M.map(g=>[g.id,g])),ce=new Map(P==null?void 0:P.map(g=>[g.id,g])),{data:ve,error:he}=await p.from("embrioes").select("lote_fiv_acasalamento_id").eq("lote_fiv_id",D),De=new Map;!he&&ve&&ve.forEach(g=>{g.lote_fiv_acasalamento_id&&De.set(g.lote_fiv_acasalamento_id,(De.get(g.lote_fiv_acasalamento_id)||0)+1)});const pe=(T||[]).map(g=>{const xe=ce.get(g.aspiracao_doadora_id),ie=xe?F.get(xe.doadora_id):void 0,_e=U.get(g.dose_semen_id),se=(_e==null?void 0:_e.touro)??null;return{...g,doadora_nome:(ie==null?void 0:ie.nome)||(ie==null?void 0:ie.registro),doadora_registro:ie==null?void 0:ie.registro,dose_nome:(se==null?void 0:se.nome)||"Touro desconhecido",viaveis:xe==null?void 0:xe.viaveis,total_embrioes_produzidos:De.get(g.id)||0}});X(pe),m({...I,pacote_nome:n.fazenda_id,pacote_data:n.data_aspiracao}),ee(!0);const{data:je,error:fe}=await p.from("aspiracoes_doadoras").select("id, doadora_id, viaveis").eq("pacote_aspiracao_id",I.pacote_aspiracao_id);if(!fe){const g=new Map;T==null||T.forEach(se=>{const ge=se.aspiracao_doadora_id,$e=se.quantidade_oocitos||0;g.set(ge,(g.get(ge)||0)+$e)});const ie=(je||[]).filter(se=>{const ge=se.viaveis??0,$e=g.get(se.id)||0,ma=ge-$e;return ge>0&&ma>0}).map(se=>({...se,oocitos_disponiveis:(se.viaveis??0)-(g.get(se.id)||0)}));R(ie);const _e=[...new Set((je==null?void 0:je.map(se=>se.doadora_id))||[])];if(_e.length>0){const{data:se,error:ge}=await p.from("doadoras").select("id, nome, registro").in("id",_e);!ge&&se&&b(se)}}const{data:we,error:Oe}=await p.from("doses_semen").select("id, touro_id, cliente_id, tipo_semen, quantidade, touro:touros(id, nome, registro, raca)").order("created_at",{ascending:!1});if(Oe)f([]);else try{const g=I==null?void 0:I.doses_selecionadas;g&&Array.isArray(g)&&g.length>0?f((we||[]).filter(xe=>g.includes(xe.id))):f(we||[])}catch{f(we||[])}const{data:Ge,error:la}=await p.from("clientes").select("id, nome").order("nome",{ascending:!0});la||t(Ge||[]),await _(D)}catch(I){ca(I,"Erro ao carregar detalhes do lote")}finally{E(!1)}},[r,_,a,b,t,E]);return{selectedLote:c,setSelectedLote:m,showLoteDetail:N,setShowLoteDetail:ee,acasalamentos:j,setAcasalamentos:X,fazendasDestinoIds:S,historicoDespachos:Y,setHistoricoDespachos:J,aspiracoesDisponiveis:K,dosesDisponiveis:ae,fazendaOrigemNome:z,fazendasDestinoNomes:L,dosesDisponiveisNoLote:h,dataAspiracao:V,loadLoteDetail:w,loadHistoricoDespachos:_}}function rs({filtroHistoricoDataInicio:a,filtroHistoricoDataFim:b,filtroHistoricoFazenda:t,setHistoricoPage:E}){const{toast:r}=Me(),[c,m]=d.useState([]),[N,ee]=d.useState(!1),[j,X]=d.useState(null),[S,G]=d.useState(null),[Y,J]=d.useState(!1),K=d.useCallback(async()=>{try{ee(!0),E(1);let f=p.from("lotes_fiv").select("*").eq("status","FECHADO");a&&(f=f.gte("data_abertura",a)),b&&(f=f.lte("data_abertura",b));const{data:z,error:A}=await f.order("data_abertura",{ascending:!1});if(A)throw A;if(!z||z.length===0){m([]),ee(!1);return}const L=z.map(s=>s.id),q=[...new Set(z.map(s=>s.pacote_aspiracao_id).filter(Boolean))],{data:h}=await p.from("pacotes_aspiracao").select("id, data_aspiracao, fazenda_id, total_oocitos").in("id",q),{data:x}=await p.from("fazendas").select("id, nome").order("nome",{ascending:!0}),V=new Map((x==null?void 0:x.map(s=>[s.id,s.nome]))||[]),B=(x==null?void 0:x.map(s=>({id:s.id,nome:s.nome})))||[],{data:_}=await p.from("lote_fiv_acasalamentos").select("id, lote_fiv_id, quantidade_embrioes, aspiracao_doadora_id").in("lote_fiv_id",L),{data:w,error:D}=await p.from("embrioes").select("id, lote_fiv_id, lote_fiv_acasalamento_id, classificacao, status_atual").in("lote_fiv_id",L);D&&r({title:"Erro ao buscar embri√µes",description:D.message,variant:"destructive"});const{data:I}=await p.from("lote_fiv_fazendas_destino").select("lote_fiv_id, fazenda_id").in("lote_fiv_id",L),i=[...new Set((_==null?void 0:_.map(s=>s.aspiracao_doadora_id).filter(Boolean))||[])],{data:n}=await p.from("aspiracoes_doadoras").select("id, viaveis").in("id",i),v=new Map((h==null?void 0:h.map(s=>[s.id,s]))||[]),O=new Map,y=new Map,k=new Map,H=new Map((n==null?void 0:n.map(s=>[s.id,s]))||[]);_==null||_.forEach(s=>{O.has(s.lote_fiv_id)||O.set(s.lote_fiv_id,[]),O.get(s.lote_fiv_id).push(s)}),w&&w.length>0&&w.forEach(s=>{s.lote_fiv_id&&(y.has(s.lote_fiv_id)||y.set(s.lote_fiv_id,[]),y.get(s.lote_fiv_id).push(s))}),I==null||I.forEach(s=>{k.has(s.lote_fiv_id)||k.set(s.lote_fiv_id,[]);const l=V.get(s.fazenda_id);l&&k.get(s.lote_fiv_id).push(l)});let T=z.map(s=>{const l=v.get(s.pacote_aspiracao_id),P=O.get(s.id)||[],W=y.get(s.id)||[],te=k.get(s.id)||[],de=W.length,me=W.filter(U=>U.status_atual==="TRANSFERIDO").length,o=W.filter(U=>U.status_atual==="CONGELADO").length,M=W.filter(U=>U.status_atual==="DESCARTADO").length,C={};W.forEach(U=>{U.classificacao?C[U.classificacao]=(C[U.classificacao]||0)+1:C.sem_classificacao=(C.sem_classificacao||0)+1});let F=0;return P.forEach(U=>{if(U.aspiracao_doadora_id){const ce=H.get(U.aspiracao_doadora_id);ce!=null&&ce.viaveis&&(F+=ce.viaveis)}}),{id:s.id,data_abertura:s.data_abertura,status:s.status,observacoes:s.observacoes,pacote_aspiracao_id:s.pacote_aspiracao_id,pacote_data:l==null?void 0:l.data_aspiracao,pacote_nome:V.get((l==null?void 0:l.fazenda_id)||""),fazenda_origem_nome:V.get((l==null?void 0:l.fazenda_id)||""),fazendas_destino_nomes:te,quantidade_acasalamentos:P.length,total_embrioes_produzidos:de,total_embrioes_transferidos:me,total_embrioes_congelados:o,total_embrioes_descartados:M,embrioes_por_classificacao:{BE:C.BE,BN:C.BN,BX:C.BX,BL:C.BL,BI:C.BI,sem_classificacao:C.sem_classificacao},total_oocitos:l==null?void 0:l.total_oocitos,total_viaveis:F>0?F:void 0}});if(t){const s=B.find(l=>l.id===t);s&&(T=T.filter(l=>l.fazenda_origem_nome===s.nome))}m(T)}catch(f){ca(f,"Erro ao carregar hist√≥rico")}finally{ee(!1)}},[a,b,t,E,r]),R=d.useCallback(async f=>{try{J(!0);const z=c.find(i=>i.id===f);if(!z){r({title:"Erro",description:"Lote n√£o encontrado",variant:"destructive"});return}const{data:A}=await p.from("pacotes_aspiracao").select("*").eq("id",z.pacote_aspiracao_id).single(),{data:L}=await p.from("lote_fiv_acasalamentos").select("*").eq("lote_fiv_id",f).order("created_at",{ascending:!0}),{data:q}=await p.from("embrioes").select("*").eq("lote_fiv_id",f).order("created_at",{ascending:!0}),h=[...new Set((L==null?void 0:L.map(i=>i.aspiracao_doadora_id).filter(Boolean))||[])],{data:x}=await p.from("aspiracoes_doadoras").select("*, doadora:doadoras(id, registro, nome)").in("id",h),V=[...new Set((L==null?void 0:L.map(i=>i.dose_semen_id).filter(Boolean))||[])],{data:B}=await p.from("doses_semen").select("*, cliente:clientes(nome), touro:touros(id, nome, registro, raca)").in("id",V),_=new Map((x==null?void 0:x.map(i=>[i.id,i]))||[]),w=new Map((B==null?void 0:B.map(i=>[i.id,i]))||[]),D=new Map;(q||[]).forEach(i=>{const n=i.lote_fiv_acasalamento_id||"sem_acasalamento";D.has(n)||D.set(n,{total:0,porStatus:{},porClassificacao:{}});const v=D.get(n);v.total++;const O=i.status_atual||"sem_status";v.porStatus[O]=(v.porStatus[O]||0)+1;const y=i.classificacao||"sem_classificacao";v.porClassificacao[y]=(v.porClassificacao[y]||0)+1});const I={lote:z,pacote:A?{id:A.id,data_aspiracao:A.data_aspiracao,horario_inicio:A.horario_inicio,horario_final:A.horario_final,veterinario_responsavel:A.veterinario_responsavel,tecnico_responsavel:A.tecnico_responsavel,total_oocitos:A.total_oocitos,observacoes:A.observacoes}:void 0,acasalamentos:(L||[]).map(i=>{var k,H,T,s;const n=i.aspiracao_doadora_id?_.get(i.aspiracao_doadora_id):null,v=i.dose_semen_id?w.get(i.dose_semen_id):null,O=n==null?void 0:n.doadora,y=D.get(i.id)||{total:0,porStatus:{},porClassificacao:{}};return{id:i.id,aspiracao_id:i.aspiracao_doadora_id,doadora:O?{registro:O.registro,nome:O.nome}:void 0,aspiracao:n?{data_aspiracao:n.data_aspiracao,horario_aspiracao:n.horario_aspiracao,viaveis:n.viaveis,expandidos:n.expandidos,total_oocitos:n.total_oocitos,atresicos:n.atresicos,degenerados:n.degenerados,desnudos:n.desnudos,veterinario_responsavel:n.veterinario_responsavel}:void 0,dose_semen:v?{nome:((k=v.touro)==null?void 0:k.nome)||"Touro desconhecido",registro:(H=v.touro)==null?void 0:H.registro,raca:((T=v.touro)==null?void 0:T.raca)||v.raca,tipo_semen:v.tipo_semen,cliente:(s=v.cliente)==null?void 0:s.nome}:void 0,quantidade_fracionada:i.quantidade_fracionada,quantidade_oocitos:i.quantidade_oocitos,quantidade_embrioes:i.quantidade_embrioes,observacoes:i.observacoes,resumo_embrioes:y}}),embrioes:(q||[]).map(i=>({id:i.id,identificacao:i.identificacao,classificacao:i.classificacao,tipo_embriao:i.tipo_embriao,status_atual:i.status_atual,acasalamento_id:i.lote_fiv_acasalamento_id}))};G(I)}catch(z){ca(z,"Erro ao carregar detalhes")}finally{J(!1)}},[c,r]),ae=d.useCallback(async f=>{j===f?(X(null),G(null)):(X(f),await R(f))},[j,R]);return{lotesHistoricos:c,loadingHistorico:N,loteExpandido:j,detalhesLoteExpandido:S,loadingDetalhes:Y,loadLotesHistoricos:K,handleExpandirLote:ae}}function ns({id:a,filtroHistoricoDataInicio:b,filtroHistoricoDataFim:t,filtroHistoricoFazenda:E,setHistoricoPage:r}){const c=os(),m=is({setFazendas:c.setFazendas,setDoadoras:c.setDoadoras,setClientes:c.setClientes,setLoading:c.setLoading}),N=rs({filtroHistoricoDataInicio:b,filtroHistoricoDataFim:t,filtroHistoricoFazenda:E,setHistoricoPage:r});return d.useEffect(()=>{a?m.loadLoteDetail(a):c.loadData()},[a,c.loadData,m.loadLoteDetail]),{lotes:c.lotes,pacotes:c.pacotes,fazendas:c.fazendas,setFazendas:c.setFazendas,doadoras:c.doadoras,clientes:c.clientes,loading:c.loading,selectedLote:m.selectedLote,setSelectedLote:m.setSelectedLote,showLoteDetail:m.showLoteDetail,setShowLoteDetail:m.setShowLoteDetail,acasalamentos:m.acasalamentos,setAcasalamentos:m.setAcasalamentos,fazendasDestinoIds:m.fazendasDestinoIds,historicoDespachos:m.historicoDespachos,setHistoricoDespachos:m.setHistoricoDespachos,aspiracoesDisponiveis:m.aspiracoesDisponiveis,dosesDisponiveis:m.dosesDisponiveis,fazendaOrigemNome:m.fazendaOrigemNome,fazendasDestinoNomes:m.fazendasDestinoNomes,dosesDisponiveisNoLote:m.dosesDisponiveisNoLote,dataAspiracao:m.dataAspiracao,pacotesParaFiltro:c.pacotesParaFiltro,fazendasAspiracaoUnicas:c.fazendasAspiracaoUnicas,lotesHistoricos:N.lotesHistoricos,loadingHistorico:N.loadingHistorico,loteExpandido:N.loteExpandido,detalhesLoteExpandido:N.detalhesLoteExpandido,loadingDetalhes:N.loadingDetalhes,loadData:c.loadData,loadLoteDetail:m.loadLoteDetail,loadLotesHistoricos:N.loadLotesHistoricos,handleExpandirLote:N.handleExpandirLote}}function ds({pacotes:a,clientes:b,fazendas:t}){var h;const E=ba(),{toast:r}=Me(),[c,m]=d.useState(!1),[N,ee]=d.useState(!1),[j,X]=d.useState({pacote_aspiracao_id:"",observacoes:"",doses_selecionadas:[]}),[S,G]=d.useState(null),[Y,J]=d.useState([]),[K,R]=d.useState([]),[ae,f]=d.useState([]),z=async x=>{X({...j,pacote_aspiracao_id:x});const V=a.find(B=>B.id===x);if(G(V||null),V){const{data:B,error:_}=await p.from("aspiracoes_doadoras").select("id, doadora_id, viaveis").eq("pacote_aspiracao_id",x);if(_)return;R(B||[]);const w=[...new Set((B==null?void 0:B.map(i=>i.doadora_id))||[])];if(w.length>0){const{data:i,error:n}=await p.from("doadoras").select("id, nome, registro").in("id",w);if(n)return;f(i||[])}const{data:D,error:I}=await p.from("doses_semen").select("id, cliente_id, touro_id, tipo_semen, quantidade, touro:touros(id, nome, registro, raca)").order("created_at",{ascending:!1});if(I)return;J(D||[])}},A=async x=>{var V,B;if(x.preventDefault(),!j.pacote_aspiracao_id){r({title:"Erro de valida√ß√£o",description:"Pacote de aspira√ß√£o √© obrigat√≥rio",variant:"destructive"});return}if(!S){r({title:"Erro de valida√ß√£o",description:"Pacote selecionado n√£o encontrado",variant:"destructive"});return}try{ee(!0);const{data:_,error:w}=await p.from("pacotes_aspiracao").select("id, status").eq("id",j.pacote_aspiracao_id).single();if(w||!_){r({title:"Erro de valida√ß√£o",description:"Pacote de aspira√ß√£o n√£o encontrado ou inv√°lido",variant:"destructive"});return}if(_.status!=="FINALIZADO"){r({title:"Erro de valida√ß√£o",description:"Apenas pacotes FINALIZADOS podem ser usados para criar lotes FIV",variant:"destructive"});return}const D=new Date(S.data_aspiracao);D.setDate(D.getDate()+1);const I=D.toISOString().split("T")[0],i={pacote_aspiracao_id:j.pacote_aspiracao_id,data_abertura:I,data_fecundacao:I,status:"ABERTO",observacoes:j.observacoes||null};if(j.doses_selecionadas&&j.doses_selecionadas.length>0)try{i.doses_selecionadas=j.doses_selecionadas}catch{}let n;const{data:v,error:O}=await p.from("lotes_fiv").insert([i]).select().single();if(O)if((V=O.message)!=null&&V.includes("doses_selecionadas")||O.code==="42703"){delete i.doses_selecionadas;const{data:k,error:H}=await p.from("lotes_fiv").insert([i]).select().single();if(H)throw H;n=k}else throw O;else n=v;const y=(B=S.fazendas_destino_nomes)==null?void 0:B.map(k=>{const H=t.find(T=>T.nome===k);return H==null?void 0:H.id}).filter(k=>!!k);if(y&&y.length>0){const{error:k}=await p.from("lote_fiv_fazendas_destino").insert(y.map(H=>({lote_fiv_id:n.id,fazenda_id:H})));if(k)throw k}try{await p.from("pacotes_aspiracao").update({usado_em_lote_fiv:!0}).eq("id",j.pacote_aspiracao_id)}catch{}r({title:"Lote FIV criado",description:"Lote FIV criado com sucesso. Agora voc√™ pode adicionar acasalamentos."}),m(!1),L(),E(`/lotes-fiv/${n.id}`)}catch(_){const w=_ instanceof Error?_.message:"Erro desconhecido";r({title:"Erro ao criar lote",description:w.includes("RLS")||w.includes("policy")?"RLS est√° bloqueando escrita. Configure pol√≠ticas anon no Supabase.":w,variant:"destructive"})}finally{ee(!1)}},L=()=>{X({pacote_aspiracao_id:"",observacoes:"",doses_selecionadas:[]}),G(null),R([]),f([]),J([])},q=()=>{m(!1),L()};return e.jsxs(ha,{open:c,onOpenChange:m,children:[e.jsx(Ga,{asChild:!0,children:e.jsxs(oe,{children:[e.jsx(qa,{className:"w-4 h-4 mr-2"}),"Novo Lote"]})}),e.jsxs(fa,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(_a,{children:[e.jsx(va,{children:"Criar Novo Lote FIV"}),e.jsx(ja,{children:"Selecione um pacote de aspira√ß√£o FINALIZADO para criar o lote"})]}),e.jsxs("form",{onSubmit:A,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ne,{htmlFor:"pacote_aspiracao_id",children:"Pacote de Aspira√ß√£o *"}),a.length===0?e.jsxs("div",{className:"border rounded-lg p-4 bg-yellow-50 border-yellow-200",children:[e.jsx("p",{className:"text-sm text-yellow-800 font-medium mb-2",children:"Nenhum pacote dispon√≠vel"}),e.jsxs("p",{className:"text-sm text-yellow-700",children:["Verifique se o pacote de aspira√ß√£o est√° com status ",e.jsx("strong",{children:"FINALIZADO"})," e ainda n√£o foi usado para criar um lote FIV."]})]}):e.jsxs(oa,{value:j.pacote_aspiracao_id,onValueChange:z,children:[e.jsx(ia,{children:e.jsx(ra,{placeholder:"Selecione o pacote"})}),e.jsx(na,{children:a.map(x=>e.jsxs(da,{value:x.id,children:[ue(x.data_aspiracao)," - ",x.fazenda_nome," (",x.quantidade_doadoras," doadoras)"]},x.id))})]}),S&&e.jsxs("div",{className:"text-sm text-slate-600 space-y-1 mt-2 p-3 bg-slate-50 rounded-lg",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Data do Pacote:"})," ",ue(S.data_aspiracao)]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Data de Fecunda√ß√£o do Lote:"})," ",(()=>{const x=new Date(S.data_aspiracao);return x.setDate(x.getDate()+1),ue(x.toISOString().split("T")[0])})()]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Fazendas Destino:"})," ",((h=S.fazendas_destino_nomes)==null?void 0:h.join(", "))||"Nenhuma"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Quantidade de Doadoras:"})," ",S.quantidade_doadoras||0]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ne,{children:"Doses de S√™men Dispon√≠veis no Lote *"}),e.jsx("div",{className:"border rounded-lg p-4 max-h-60 overflow-y-auto",children:Y.length===0?e.jsx("p",{className:"text-sm text-slate-500",children:S?"Carregando doses...":"Selecione um pacote primeiro"}):e.jsx("div",{className:"space-y-2",children:Y.map(x=>{var _,w;const V=b.find(D=>D.id===x.cliente_id),B=j.doses_selecionadas.includes(x.id);return e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:`dose-${x.id}`,checked:B,onChange:D=>{D.target.checked?X({...j,doses_selecionadas:[...j.doses_selecionadas,x.id]}):X({...j,doses_selecionadas:j.doses_selecionadas.filter(I=>I!==x.id)})},className:"rounded"}),e.jsxs("label",{htmlFor:`dose-${x.id}`,className:"text-sm cursor-pointer flex-1",children:[e.jsx("span",{className:"font-medium",children:((_=x.touro)==null?void 0:_.nome)||"Touro desconhecido"}),((w=x.touro)==null?void 0:w.registro)&&e.jsxs("span",{className:"text-slate-500 ml-2",children:["(",x.touro.registro,")"]}),V&&e.jsxs("span",{className:"text-slate-500 ml-2",children:["- ",V.nome]})]})]},x.id)})})}),e.jsx("p",{className:"text-xs text-slate-500",children:"Selecione as doses de s√™men que estar√£o dispon√≠veis para uso neste lote"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ne,{htmlFor:"observacoes",children:"Observa√ß√µes"}),e.jsx(La,{id:"observacoes",value:j.observacoes,onChange:x=>X({...j,observacoes:x.target.value}),placeholder:"Observa√ß√µes sobre o lote",rows:3})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(oe,{type:"submit",className:"flex-1",disabled:N,children:N?"Criando...":"Criar Lote"}),e.jsx(oe,{type:"button",variant:"outline",onClick:q,disabled:N,children:"Cancelar"})]})]})]})]})}function Be(a){return{[-1]:"Aspira√ß√£o",0:"Fecunda√ß√£o",1:"Zigoto",2:"2 C√©lulas",3:"4 C√©lulas",4:"8 C√©lulas",5:"M√≥rula",6:"Blastocisto",7:"Blastocisto Expandido",8:"Blastocisto Expandido"}[a]||`D${a}`}function cs({lote:a,acasalamentos:b,aspiracoesDisponiveis:t,dosesDisponiveis:E,dosesDisponiveisNoLote:r,doadoras:c,clientes:m,historicoDespachos:N,dataAspiracao:ee,fazendaOrigemNome:j,fazendasDestinoNomes:X,submitting:S,onBack:G,onAddAcasalamento:Y,onDespacharEmbrioes:J,onUpdateQuantidadeEmbrioes:K,editQuantidadeEmbrioes:R,onUpdateClivados:ae,editClivados:f={}}){var T;const z=ba(),{toast:A}=Me(),[L,q]=d.useState(!1),[h,x]=d.useState(!1),[V,B]=d.useState(""),[_,w]=d.useState({aspiracao_doadora_id:"",dose_semen_id:"",quantidade_fracionada:"1.0",quantidade_oocitos:"",observacoes:""});let D=Pe(ee||a.pacote_data||null);if(!D){const s=Pe(a.data_abertura);if(s){const[l,P,W]=s.split("-").map(Number),te=new Date(l,P-1,W);te.setDate(te.getDate()-1),D=`${te.getFullYear()}-${String(te.getMonth()+1).padStart(2,"0")}-${String(te.getDate()).padStart(2,"0")}`}}if(!D)return e.jsx("div",{children:"Erro: Data de aspira√ß√£o n√£o encontrada"});const I=wa(),i=Math.max(0,Da(D,I)),n=ss(i),v=Ua(D,8),O=ue(v),y=Qa(v),k=async s=>{if(s.preventDefault(),!_.aspiracao_doadora_id){A({title:"Erro de valida√ß√£o",description:"Doadora √© obrigat√≥ria",variant:"destructive"});return}if(!_.dose_semen_id){A({title:"Erro de valida√ß√£o",description:"Selecione uma dose de s√™men",variant:"destructive"});return}if((parseFloat(_.quantidade_fracionada)||0)<=0){A({title:"Erro de valida√ß√£o",description:"Quantidade fracionada deve ser maior que zero",variant:"destructive"});return}try{await Y(_),q(!1),w({aspiracao_doadora_id:"",dose_semen_id:"",quantidade_fracionada:"1.0",quantidade_oocitos:"",observacoes:""}),B("")}catch{}},H=()=>{G(),z("/lotes-fiv")};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(oe,{variant:"ghost",size:"sm",onClick:H,children:e.jsx(Ya,{className:"w-4 h-4"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-slate-900",children:"Detalhes do Lote FIV"}),e.jsxs("div",{className:"text-slate-600 mt-1 flex items-center gap-2",children:[e.jsxs("span",{children:["Data de fecunda√ß√£o (D0): ",ue(a.data_abertura)," |",D&&` Data aspira√ß√£o (D-1): ${ue(D)} |`,n===-1?` D-1 - ${Be(n)} |`:` D${n} - ${Be(n)} |`," ","Status:"]}),e.jsx(Le,{variant:a.status==="FECHADO"?"default":"secondary",children:a.status})]})]})]}),e.jsxs(Ue,{children:[e.jsx(Qe,{children:e.jsx(Ze,{children:"Informa√ß√µes do Lote"})}),e.jsxs(Xe,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(ne,{children:"Dia Atual"}),e.jsx("p",{className:"text-2xl font-bold",children:n===-1?e.jsxs(e.Fragment,{children:["D-1 ",e.jsxs("span",{className:"text-lg font-normal text-slate-600",children:["- ",Be(n)]})]}):e.jsxs(e.Fragment,{children:["D",n," ",e.jsxs("span",{className:"text-lg font-normal text-slate-600",children:["- ",Be(n)]})]})})]}),e.jsxs("div",{children:[e.jsx(ne,{children:"Data da TE"}),i<7?e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-orange-600",children:O}),e.jsx("p",{className:"text-sm text-slate-500",children:y})]}):e.jsx("p",{className:"text-2xl font-bold text-green-600",children:"Hoje ou passou"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(ne,{children:"Fazenda de Origem"}),e.jsx("p",{className:"font-medium",children:j||a.pacote_nome||"-"})]}),e.jsxs("div",{children:[e.jsx(ne,{children:"Fazendas de Destino"}),e.jsx("p",{className:"font-medium",children:X.length>0?X.join(", "):((T=a.fazendas_destino_nomes)==null?void 0:T.join(", "))||"-"})]})]}),a.observacoes&&e.jsxs("div",{children:[e.jsx(ne,{children:"Observa√ß√µes"}),e.jsx("p",{className:"text-slate-600",children:a.observacoes})]}),a.status==="ABERTO"&&i===7&&e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"text-blue-800 font-medium",children:["üìä Este lote est√° no D6 (",Be(6),"). Voc√™ pode preencher a quantidade de embri√µes (pr√©via) e gerar um relat√≥rio."]}),e.jsxs(oe,{variant:"outline",size:"sm",onClick:()=>x(!0),children:[e.jsx(Ja,{className:"w-4 h-4 mr-2"}),"Gerar Relat√≥rio de Pr√©via"]})]})}),(a.status==="ABERTO"&&(i===8||i===9)||a.status==="FECHADO"&&i===9)&&e.jsx("div",{className:"bg-orange-50 border border-orange-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"text-orange-800 font-medium",children:["‚ö†Ô∏è Este lote est√° no ",i===8?"D7":"D8"," (",Be(i===8?7:8),"). ",i===8?"Informe a quantidade de embri√µes para cada acasalamento e despache os embri√µes.":"Per√≠odo de emerg√™ncia (D8). Voc√™ pode adicionar novos acasalamentos e despachar os embri√µes imediatamente."]}),e.jsxs(oe,{variant:"default",size:"sm",onClick:J,disabled:S,children:[e.jsx(ga,{className:"w-4 h-4 mr-2"}),S?"Despachando...":"Despachar Todos os Embri√µes"]})]})})]})]}),e.jsxs(Ue,{children:[e.jsx(Qe,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Ze,{className:"flex items-center gap-2",children:[e.jsx(ua,{className:"w-5 h-5"}),"Acasalamentos (",b.length,")"]}),a.status==="ABERTO"&&e.jsxs(oe,{size:"sm",onClick:()=>q(!0),children:[e.jsx(qa,{className:"w-4 h-4 mr-2"}),"Adicionar Acasalamento"]})]})}),e.jsx(Xe,{children:b.length===0?e.jsxs("div",{className:"text-center py-8 text-slate-500",children:[e.jsx(ua,{className:"w-12 h-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"Nenhum acasalamento cadastrado"}),a.status==="ABERTO"&&e.jsx(oe,{variant:"outline",size:"sm",className:"mt-2",onClick:()=>q(!0),children:"Adicionar primeiro acasalamento"})]}):e.jsxs(aa,{children:[e.jsx(sa,{children:e.jsxs(Fe,{children:[e.jsx(Q,{children:"Doadora"}),e.jsx(Q,{children:"Touro"}),e.jsx(Q,{className:"text-center",children:"O√≥citos"}),e.jsx(Q,{className:"text-center",children:"D3 Clivados"}),e.jsx(Q,{className:"text-center",children:"Qtd. Embri√µes"}),e.jsx(Q,{className:"text-center",children:"%"}),e.jsx(Q,{children:"Observa√ß√µes"})]})}),e.jsx(ta,{children:b.map(s=>{const l=s.viaveis||0,P=f[s.id],W=s.embrioes_clivados_d3,te=P!==void 0?P:(W==null?void 0:W.toString())??"",de=parseInt(te)||0,me=de>0?de:l,o=R[s.id]!==void 0?parseInt(R[s.id])||0:s.total_embrioes_produzidos||0,M=l>0?(o/l*100).toFixed(1):"0.0";return e.jsxs(Fe,{children:[e.jsx(Z,{children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.doadora_registro||"-"}),s.doadora_nome&&e.jsx("p",{className:"text-sm text-slate-500",children:s.doadora_nome})]})}),e.jsx(Z,{children:s.dose_nome||"-"}),e.jsx(Z,{className:"text-center",children:l}),e.jsx(Z,{className:"text-center",children:a.status==="ABERTO"&&n>=3&&ae?e.jsx(Te,{type:"number",min:"0",max:l,className:"w-20 text-center",value:te,onChange:C=>ae(s.id,C.target.value),placeholder:"-"}):e.jsx("span",{children:de>0?de:"-"})}),e.jsx(Z,{className:"text-center",children:a.status==="ABERTO"&&i>=7?e.jsx(Te,{type:"number",min:"0",max:me,className:"w-20 text-center",value:R[s.id]??s.total_embrioes_produzidos??"",onChange:C=>K(s.id,C.target.value),placeholder:"0"}):e.jsx("span",{children:o})}),e.jsx(Z,{className:"text-center",children:e.jsxs(Le,{variant:parseFloat(M)>=30?"default":"secondary",children:[M,"%"]})}),e.jsx(Z,{className:"max-w-[200px] truncate",children:s.observacoes||"-"})]},s.id)})})]})})]}),N.length>0&&e.jsxs(Ue,{children:[e.jsx(Qe,{children:e.jsxs(Ze,{className:"flex items-center gap-2",children:[e.jsx(ga,{className:"w-5 h-5"}),"Hist√≥rico de Despachos"]})}),e.jsx(Xe,{children:e.jsx("div",{className:"space-y-4",children:N.map(s=>e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsxs("p",{className:"font-medium mb-2",children:["Despacho em ",ue(s.data_despacho)]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2",children:s.acasalamentos.map((l,P)=>e.jsxs("div",{className:"text-sm bg-slate-50 rounded p-2",children:[e.jsx("span",{className:"font-medium",children:l.doadora}),e.jsxs("span",{className:"text-slate-500",children:[" x ",l.dose]}),e.jsxs("span",{className:"ml-2 text-green-600 font-medium",children:["(",l.quantidade,")"]})]},P))})]},s.id))})})]}),e.jsx(ha,{open:L,onOpenChange:q,children:e.jsxs(fa,{className:"max-w-lg",children:[e.jsxs(_a,{children:[e.jsx(va,{children:"Adicionar Acasalamento"}),e.jsx(ja,{children:"Selecione a doadora e a dose de s√™men para o acasalamento"})]}),e.jsxs("form",{onSubmit:k,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ne,{children:"Doadora *"}),e.jsxs(oa,{value:_.aspiracao_doadora_id,onValueChange:s=>{w({..._,aspiracao_doadora_id:s});const l=t.find(P=>P.id===s);l&&w(P=>({...P,aspiracao_doadora_id:s,quantidade_oocitos:String(l.oocitos_disponiveis||l.viaveis||0)}))},children:[e.jsx(ia,{children:e.jsx(ra,{placeholder:"Selecione a doadora"})}),e.jsx(na,{children:t.map(s=>{const l=c.find(P=>P.id===s.doadora_id);return e.jsxs(da,{value:s.id,children:[(l==null?void 0:l.registro)||(l==null?void 0:l.nome)||"Doadora"," - ",s.oocitos_disponiveis??s.viaveis??0," o√≥citos dispon√≠veis"]},s.id)})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ne,{children:"Dose de S√™men *"}),e.jsxs(oa,{value:_.dose_semen_id,onValueChange:s=>w({..._,dose_semen_id:s}),children:[e.jsx(ia,{children:e.jsx(ra,{placeholder:"Selecione a dose"})}),e.jsx(na,{children:(r.length>0?r:E).map(s=>{var P,W;const l=m.find(te=>te.id===s.cliente_id);return e.jsxs(da,{value:s.id,children:[((P=s.touro)==null?void 0:P.nome)||"Touro desconhecido",((W=s.touro)==null?void 0:W.registro)&&` (${s.touro.registro})`,l&&` - ${l.nome}`]},s.id)})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ne,{children:"Qtd. Fracionada"}),e.jsx(Te,{type:"number",step:"0.1",min:"0",value:_.quantidade_fracionada,onChange:s=>w({..._,quantidade_fracionada:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ne,{children:"Qtd. O√≥citos"}),e.jsx(Te,{type:"number",min:"0",value:_.quantidade_oocitos,onChange:s=>w({..._,quantidade_oocitos:s.target.value}),placeholder:"Auto"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ne,{children:"Observa√ß√µes"}),e.jsx(La,{value:_.observacoes,onChange:s=>w({..._,observacoes:s.target.value}),placeholder:"Observa√ß√µes sobre o acasalamento",rows:2})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(oe,{type:"submit",className:"flex-1",disabled:S,children:S?"Adicionando...":"Adicionar"}),e.jsx(oe,{type:"button",variant:"outline",onClick:()=>{q(!1),w({aspiracao_doadora_id:"",dose_semen_id:"",quantidade_fracionada:"1.0",quantidade_oocitos:"",observacoes:""})},children:"Cancelar"})]})]})]})}),e.jsx(ha,{open:h,onOpenChange:x,children:e.jsxs(fa,{className:"max-w-2xl",children:[e.jsxs(_a,{children:[e.jsx(va,{children:"Relat√≥rio de Pr√©via - D6"}),e.jsx(ja,{children:"Resumo dos acasalamentos e embri√µes previstos"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"border rounded-lg p-4 bg-slate-50",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Informa√ß√µes do Lote"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-slate-500",children:"Fazenda Origem:"})," ",j||a.pacote_nome]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-slate-500",children:"Fazendas Destino:"})," ",X.join(", ")||"-"]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-slate-500",children:"Data TE prevista:"})," ",O]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-slate-500",children:"Total Acasalamentos:"})," ",b.length]})]})]}),e.jsxs(aa,{children:[e.jsx(sa,{children:e.jsxs(Fe,{children:[e.jsx(Q,{children:"Doadora"}),e.jsx(Q,{children:"Touro"}),e.jsx(Q,{className:"text-center",children:"O√≥citos"}),e.jsx(Q,{className:"text-center",children:"Embri√µes (prev.)"})]})}),e.jsx(ta,{children:b.map(s=>e.jsxs(Fe,{children:[e.jsx(Z,{children:s.doadora_registro||"-"}),e.jsx(Z,{children:s.dose_nome||"-"}),e.jsx(Z,{className:"text-center",children:s.viaveis||0}),e.jsx(Z,{className:"text-center",children:R[s.id]??s.total_embrioes_produzidos??"-"})]},s.id))})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(oe,{onClick:()=>x(!1),children:"Fechar"})})]})]})})]})}function ls({lotesHistoricos:a,fazendas:b,detalhesLoteExpandido:t,loteExpandido:E,loadingHistorico:r,loadingDetalhes:c,filtroHistoricoDataInicio:m,setFiltroHistoricoDataInicio:N,filtroHistoricoDataFim:ee,setFiltroHistoricoDataFim:j,filtroHistoricoFazenda:X,setFiltroHistoricoFazenda:S,filtroHistoricoFazendaBusca:G,setFiltroHistoricoFazendaBusca:Y,showFazendaBuscaHistorico:J,setShowFazendaBuscaHistorico:K,historicoPage:R,setHistoricoPage:ae,HISTORICO_PAGE_SIZE:f,onLoadHistorico:z,onExpandirLote:A}){const L=Math.max(1,Math.ceil(a.length/f)),q=()=>{N(""),j(""),S(""),Y(""),K(!1),z()};return e.jsxs("div",{className:"mt-0",children:[e.jsxs("div",{className:"flex gap-4 mb-6 flex-wrap items-end",children:[e.jsxs("div",{className:"flex-1 min-w-[280px]",children:[e.jsxs("div",{className:"mb-2",children:[e.jsx(ne,{className:"text-sm font-medium text-slate-700",children:"Per√≠odo de Busca"}),e.jsx("p",{className:"text-xs text-slate-500 mt-0.5",children:"Filtro pela data D0 (Fecunda√ß√£o) do lote"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(ne,{htmlFor:"filtro-historico-data-inicio",className:"text-xs text-slate-500 font-normal",children:"Data In√≠cio"}),e.jsx(ya,{value:m,onChange:h=>N(h||""),placeholder:"Data inicial"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx(ne,{htmlFor:"filtro-historico-data-fim",className:"text-xs text-slate-500 font-normal",children:"Data Fim"}),e.jsx(ya,{value:ee,onChange:h=>j(h||""),placeholder:"Data final"})]})]})]}),e.jsxs("div",{className:"flex-1 min-w-[250px] relative fazenda-busca-historico-container",children:[e.jsx(ne,{htmlFor:"filtro-historico-fazenda",children:"Fazenda de Origem"}),e.jsxs("div",{className:"relative",children:[e.jsx(Te,{id:"filtro-historico-fazenda",placeholder:"Digite para buscar fazenda...",value:G,onChange:h=>{Y(h.target.value),K(!0),h.target.value||S("")},onFocus:()=>K(!0)}),X&&e.jsx(oe,{variant:"ghost",size:"sm",className:"absolute right-1 top-1 h-7 w-7 p-0",onClick:()=>{S(""),Y(""),K(!1)},children:e.jsx(Ia,{className:"h-4 w-4"})}),J&&b.length>0&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-white border rounded-md shadow-lg max-h-60 overflow-auto",children:b.filter(h=>h.nome.toLowerCase().includes(G.toLowerCase())).map(h=>e.jsx("div",{className:"px-4 py-2 hover:bg-slate-100 cursor-pointer",onClick:()=>{S(h.id),Y(h.nome),K(!1)},children:h.nome},h.id))}),J&&G&&b.filter(h=>h.nome.toLowerCase().includes(G.toLowerCase())).length===0&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-white border rounded-md shadow-lg p-4 text-sm text-slate-500",children:"Nenhuma fazenda encontrada"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(oe,{onClick:z,disabled:r,children:[e.jsx(Ka,{className:"w-4 h-4 mr-2"}),"Buscar"]}),(m||ee||X)&&e.jsx(oe,{variant:"outline",onClick:q,children:"Limpar"})]})]}),r?e.jsx("div",{className:"py-8",children:e.jsx(Na,{})}):a.length===0?e.jsx(Fa,{title:"Nenhum lote hist√≥rico encontrado",description:"Ajuste os filtros ou tente outro per√≠odo."}):e.jsxs("div",{className:"space-y-4",children:[a.slice((R-1)*f,R*f).map(h=>e.jsx(ms,{lote:h,isExpanded:E===h.id,detalhes:E===h.id?t:null,loadingDetalhes:c&&E===h.id,onExpandir:()=>A(h.id)},h.id)),e.jsxs("div",{className:"flex items-center justify-between pt-2 text-sm text-slate-600",children:[e.jsxs("div",{children:[a.length," lotes no hist√≥rico"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(oe,{variant:"outline",size:"sm",onClick:()=>ae(Math.max(1,R-1)),disabled:R===1,children:"Anterior"}),e.jsxs("span",{children:["P√°gina ",Math.min(R,L)," de ",L]}),e.jsx(oe,{variant:"outline",size:"sm",onClick:()=>ae(Math.min(L,R+1)),disabled:R>=L,children:"Pr√≥xima"})]})]})]})]})}function ms({lote:a,isExpanded:b,detalhes:t,loadingDetalhes:E,onExpandir:r}){return e.jsxs(Ue,{className:"border-l-4 border-l-slate-400",children:[e.jsx(Qe,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Ze,{className:"text-lg",children:["Lote FIV - ",ue(a.data_abertura)]}),e.jsx(oe,{variant:"outline",size:"sm",onClick:r,disabled:E,children:b?e.jsxs(e.Fragment,{children:[e.jsx(Ha,{className:"w-4 h-4 mr-2"}),"Recolher"]}):e.jsxs(e.Fragment,{children:[e.jsx(Ra,{className:"w-4 h-4 mr-2"}),"Ver Detalhes Completos"]})})]})}),e.jsxs(Xe,{className:"pt-0",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Informa√ß√µes B√°sicas"}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Data da Aspira√ß√£o:"})," ",a.pacote_data?ue(a.pacote_data):"-"]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Fazenda Origem:"})," ",a.fazenda_origem_nome||"-"]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Data de Abertura:"})," ",ue(a.data_abertura)]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"font-medium",children:"Status:"})," ",e.jsx(Le,{variant:"outline",children:a.status})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Fazendas Destino"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:a.fazendas_destino_nomes&&a.fazendas_destino_nomes.length>0?a.fazendas_destino_nomes.map((c,m)=>e.jsx(Le,{variant:"outline",className:"text-xs",children:c},m)):e.jsx("span",{className:"text-slate-400 text-sm",children:"-"})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Estat√≠sticas"}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Acasalamentos:"})," ",a.quantidade_acasalamentos||0]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total de Embri√µes:"})," ",a.total_embrioes_produzidos||0]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total Transferidos:"})," ",e.jsx("span",{className:"text-green-700 font-semibold",children:a.total_embrioes_transferidos||0})]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total Congelados:"})," ",e.jsx("span",{className:"text-blue-700 font-semibold",children:a.total_embrioes_congelados||0})]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total Descartados:"})," ",e.jsx("span",{className:"text-red-700 font-semibold",children:a.total_embrioes_descartados||0})]}),a.total_oocitos&&e.jsxs("p",{className:"mt-2 pt-2 border-t border-slate-200",children:[e.jsx("span",{className:"font-medium",children:"Total de O√≥citos:"})," ",a.total_oocitos]}),a.total_viaveis&&e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"O√≥citos Vi√°veis:"})," ",a.total_viaveis]})]})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2 lg:col-span-3",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Embri√µes por Classifica√ß√£o"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-6 gap-2",children:[a.embrioes_por_classificacao.BE&&e.jsxs("div",{className:"bg-green-50 p-2 rounded border",children:[e.jsx("p",{className:"text-xs font-medium text-green-800",children:"BE"}),e.jsx("p",{className:"text-lg font-bold text-green-900",children:a.embrioes_por_classificacao.BE})]}),a.embrioes_por_classificacao.BN&&e.jsxs("div",{className:"bg-blue-50 p-2 rounded border",children:[e.jsx("p",{className:"text-xs font-medium text-blue-800",children:"BN"}),e.jsx("p",{className:"text-lg font-bold text-blue-900",children:a.embrioes_por_classificacao.BN})]}),a.embrioes_por_classificacao.BX&&e.jsxs("div",{className:"bg-yellow-50 p-2 rounded border",children:[e.jsx("p",{className:"text-xs font-medium text-yellow-800",children:"BX"}),e.jsx("p",{className:"text-lg font-bold text-yellow-900",children:a.embrioes_por_classificacao.BX})]}),a.embrioes_por_classificacao.BL&&e.jsxs("div",{className:"bg-orange-50 p-2 rounded border",children:[e.jsx("p",{className:"text-xs font-medium text-orange-800",children:"BL"}),e.jsx("p",{className:"text-lg font-bold text-orange-900",children:a.embrioes_por_classificacao.BL})]}),a.embrioes_por_classificacao.BI&&e.jsxs("div",{className:"bg-red-50 p-2 rounded border",children:[e.jsx("p",{className:"text-xs font-medium text-red-800",children:"BI"}),e.jsx("p",{className:"text-lg font-bold text-red-900",children:a.embrioes_por_classificacao.BI})]}),a.embrioes_por_classificacao.sem_classificacao&&e.jsxs("div",{className:"bg-slate-50 p-2 rounded border",children:[e.jsx("p",{className:"text-xs font-medium text-slate-800",children:"Sem Classifica√ß√£o"}),e.jsx("p",{className:"text-lg font-bold text-slate-900",children:a.embrioes_por_classificacao.sem_classificacao})]})]})]}),a.observacoes&&e.jsxs("div",{className:"space-y-2 md:col-span-2 lg:col-span-3",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Observa√ß√µes"}),e.jsx("p",{className:"text-sm text-slate-600 bg-slate-50 p-3 rounded border",children:a.observacoes})]})]}),b&&e.jsx(ps,{detalhes:t,loadingDetalhes:E})]})]})}function ps({detalhes:a,loadingDetalhes:b}){return b?e.jsx("div",{className:"mt-4 pt-4 border-t border-slate-200 py-4",children:e.jsx(Na,{})}):a?e.jsxs("div",{className:"mt-4 pt-4 border-t border-slate-200 space-y-4",children:[a.pacote&&e.jsxs("div",{className:"bg-slate-50 p-3 rounded border text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(ga,{className:"w-4 h-4 text-slate-600"}),e.jsx("span",{className:"font-semibold",children:"Pacote de Aspira√ß√£o"})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-x-4 gap-y-1",children:[a.pacote.data_aspiracao&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Data:"})," ",e.jsx("span",{className:"font-medium",children:ue(a.pacote.data_aspiracao)})]}),a.pacote.horario_inicio&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Hora In√≠cio:"})," ",e.jsx("span",{className:"font-medium",children:a.pacote.horario_inicio})]}),a.pacote.horario_final&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Hora Fim Aspira√ß√£o:"})," ",e.jsx("span",{className:"font-medium",children:a.pacote.horario_final})]}),a.pacote.veterinario_responsavel&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Vet:"})," ",e.jsx("span",{className:"font-medium",children:a.pacote.veterinario_responsavel})]}),a.pacote.tecnico_responsavel&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"T√©cnico:"})," ",e.jsx("span",{className:"font-medium",children:a.pacote.tecnico_responsavel})]}),a.pacote.total_oocitos&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"O√≥citos Totais:"})," ",e.jsx("span",{className:"font-medium",children:a.pacote.total_oocitos})]}),a.pacote.observacoes&&e.jsxs("div",{className:"col-span-full mt-1 pt-1 border-t border-slate-200",children:[e.jsx("span",{className:"text-slate-600",children:"Obs:"})," ",e.jsx("span",{className:"text-slate-700",children:a.pacote.observacoes})]})]})]}),a.acasalamentos.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(ua,{className:"w-4 h-4 text-slate-600"}),e.jsxs("span",{className:"font-semibold text-sm",children:["Acasalamentos e Embri√µes (",a.acasalamentos.length,")"]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(aa,{children:[e.jsx(sa,{children:e.jsxs(Fe,{className:"bg-slate-50",children:[e.jsx(Q,{className:"h-8 text-xs font-semibold",children:"#"}),e.jsx(Q,{className:"h-8 text-xs font-semibold",children:"Doadora"}),e.jsx(Q,{className:"h-8 text-xs font-semibold",children:"Aspira√ß√£o"}),e.jsx(Q,{className:"h-8 text-xs font-semibold",children:"O√≥citos"}),e.jsx(Q,{className:"h-8 text-xs font-semibold",children:"Vi√°veis"}),e.jsx(Q,{className:"h-8 text-xs font-semibold",children:"S√™men"}),e.jsx(Q,{className:"h-8 text-xs font-semibold",children:"Dose"}),e.jsx(Q,{className:"h-8 text-xs font-semibold",children:"Embri√µes Prod."}),e.jsx(Q,{className:"h-8 text-xs font-semibold",children:"Total Emb."}),e.jsx(Q,{className:"h-8 text-xs font-semibold",children:"Transf."}),e.jsx(Q,{className:"h-8 text-xs font-semibold",children:"Cong."}),e.jsx(Q,{className:"h-8 text-xs font-semibold",children:"Desc."}),e.jsx(Q,{className:"h-8 text-xs font-semibold",children:"Outros"}),e.jsx(Q,{className:"h-8 text-xs font-semibold",children:"Classifica√ß√£o"})]})}),e.jsx(ta,{children:a.acasalamentos.map((t,E)=>{var G,Y,J,K,R,ae,f,z,A,L;const r=t.resumo_embrioes,c=(r==null?void 0:r.porStatus.TRANSFERIDO)||0,m=(r==null?void 0:r.porStatus.CONGELADO)||0,N=(r==null?void 0:r.porStatus.DESCARTADO)||0,ee=r?r.total-c-m-N:0,j=r&&Object.entries(r.porClassificacao).filter(([q])=>q!=="sem_classificacao").sort((q,h)=>h[1]-q[1]).map(([q,h])=>`${q}(${h})`).join(", ")||"-",X=E>0?a.acasalamentos[E-1]:null,S=X&&t.aspiracao_id&&t.aspiracao_id===X.aspiracao_id;return e.jsxs(Fe,{className:`text-xs ${S?"bg-slate-50/50":""}`,children:[e.jsx(Z,{className:"py-2 font-medium",children:E+1}),e.jsx(Z,{className:"py-2",children:S?e.jsx("div",{className:"text-slate-400 italic text-[10px]",children:"‚Ü≥"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"font-medium",children:((G=t.doadora)==null?void 0:G.registro)||"-"}),((Y=t.doadora)==null?void 0:Y.nome)&&e.jsx("div",{className:"text-slate-500 text-[11px]",children:t.doadora.nome})]})}),e.jsx(Z,{className:"py-2",children:S?e.jsx("div",{className:"text-slate-400 italic text-[10px]",children:"‚Ü≥"}):e.jsxs(e.Fragment,{children:[((J=t.aspiracao)==null?void 0:J.data_aspiracao)&&e.jsx("div",{children:ue(t.aspiracao.data_aspiracao)}),((K=t.aspiracao)==null?void 0:K.horario_aspiracao)&&e.jsx("div",{className:"text-slate-500 text-[11px]",children:t.aspiracao.horario_aspiracao})]})}),e.jsx(Z,{className:"py-2",children:S?e.jsx("div",{className:"text-slate-400 italic text-[10px]",children:"‚Ü≥ (mesma aspira√ß√£o)"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"font-medium",children:((R=t.aspiracao)==null?void 0:R.total_oocitos)??"-"}),t.aspiracao&&e.jsxs("div",{className:"text-[10px] text-slate-500 space-x-1",children:[t.aspiracao.expandidos!==void 0&&e.jsxs("span",{children:["Exp:",t.aspiracao.expandidos]}),t.aspiracao.atresicos!==void 0&&e.jsxs("span",{children:["At:",t.aspiracao.atresicos]}),t.aspiracao.degenerados!==void 0&&e.jsxs("span",{children:["Deg:",t.aspiracao.degenerados]}),t.aspiracao.desnudos!==void 0&&e.jsxs("span",{children:["Des:",t.aspiracao.desnudos]})]})]})}),e.jsx(Z,{className:"py-2",children:S?e.jsx("div",{className:"text-slate-400 italic text-[10px]",children:"‚Ü≥"}):e.jsx("span",{className:"font-medium text-green-700",children:((ae=t.aspiracao)==null?void 0:ae.viaveis)??"-"})}),e.jsxs(Z,{className:"py-2",children:[e.jsx("div",{className:"font-medium",children:((f=t.dose_semen)==null?void 0:f.nome)||"-"}),e.jsxs("div",{className:"text-[10px] text-slate-500 space-x-1",children:[((z=t.dose_semen)==null?void 0:z.raca)&&e.jsx("span",{children:t.dose_semen.raca}),((A=t.dose_semen)==null?void 0:A.tipo_semen)&&e.jsxs("span",{children:["‚Ä¢ ",t.dose_semen.tipo_semen]})]}),((L=t.dose_semen)==null?void 0:L.cliente)&&e.jsx("div",{className:"text-[10px] text-slate-500",children:t.dose_semen.cliente})]}),e.jsx(Z,{className:"py-2 text-center",children:e.jsx("span",{className:"font-medium",children:t.quantidade_fracionada})}),e.jsxs(Z,{className:"py-2 text-center",children:[e.jsx("span",{className:"font-medium text-blue-700",children:t.quantidade_embrioes??"-"}),t.quantidade_oocitos!==void 0&&e.jsxs("div",{className:"text-[10px] text-slate-500",children:["Usados: ",t.quantidade_oocitos]})]}),e.jsx(Z,{className:"py-2 text-center",children:r&&r.total>0?e.jsx("span",{className:"font-semibold",children:r.total}):e.jsx("span",{className:"text-slate-400",children:"-"})}),e.jsx(Z,{className:"py-2 text-center",children:c>0?e.jsx("span",{className:"text-green-700 font-medium",children:c}):e.jsx("span",{className:"text-slate-400",children:"-"})}),e.jsx(Z,{className:"py-2 text-center",children:m>0?e.jsx("span",{className:"text-blue-700 font-medium",children:m}):e.jsx("span",{className:"text-slate-400",children:"-"})}),e.jsx(Z,{className:"py-2 text-center",children:N>0?e.jsx("span",{className:"text-red-700 font-medium",children:N}):e.jsx("span",{className:"text-slate-400",children:"-"})}),e.jsx(Z,{className:"py-2 text-center",children:ee>0?e.jsx("span",{className:"text-slate-600 font-medium",children:ee}):e.jsx("span",{className:"text-slate-400",children:"-"})}),e.jsx(Z,{className:"py-2 text-[11px] text-slate-700",children:r&&j!=="-"?e.jsxs("div",{className:"flex flex-wrap gap-1",children:[j.split(", ").map((q,h)=>e.jsx(Le,{variant:"outline",className:"text-[10px] px-1 py-0 border-slate-300",children:q},h)),r.porClassificacao.sem_classificacao&&e.jsxs(Le,{variant:"outline",className:"text-[10px] px-1 py-0 border-slate-300 text-slate-500",children:["Sem class.(",r.porClassificacao.sem_classificacao,")"]})]}):e.jsx("span",{className:"text-slate-400",children:"-"})})]},t.id)})})]})})]}),a.acasalamentos.some(t=>t.observacoes)&&e.jsxs("div",{className:"bg-amber-50 p-2 rounded border border-amber-200 text-xs",children:[e.jsx("div",{className:"font-semibold mb-1 text-amber-900",children:"Observa√ß√µes dos Acasalamentos:"}),a.acasalamentos.filter(t=>t.observacoes).map((t,E)=>{var r;return e.jsxs("div",{className:"mb-1",children:[e.jsxs("span",{className:"font-medium",children:["#",E+1," (",((r=t.doadora)==null?void 0:r.registro)||"N/A","):"]})," ",t.observacoes]},t.id)})]})]}):e.jsx("div",{className:"mt-4 pt-4 border-t border-slate-200 text-center text-slate-500 py-4 text-sm",children:"Erro ao carregar detalhes"})}function Rs(){const{id:a}=ka(),b=ba(),{toast:t}=Me(),[E,r]=d.useState(!1),[c,m]=d.useState({}),[N,ee]=d.useState({}),[j,X]=d.useState(()=>Ba().historicoPage??1),S=d.useCallback(u=>{X(u)},[]),{filtroFazendaAspiracao:G,setFiltroFazendaAspiracao:Y,filtroFazendaAspiracaoBusca:J,setFiltroFazendaAspiracaoBusca:K,filtroDiaCultivo:R,setFiltroDiaCultivo:ae,showFazendaBusca:f,setShowFazendaBusca:z,filtroHistoricoDataInicio:A,setFiltroHistoricoDataInicio:L,filtroHistoricoDataFim:q,setFiltroHistoricoDataFim:h,filtroHistoricoFazenda:x,setFiltroHistoricoFazenda:V,filtroHistoricoFazendaBusca:B,setFiltroHistoricoFazendaBusca:_,showFazendaBuscaHistorico:w,setShowFazendaBuscaHistorico:D,abaAtiva:I,setAbaAtiva:i,HISTORICO_PAGE_SIZE:n}=ts({lotes:[],pacotesParaFiltro:[],fazendasAspiracaoUnicas:[],lotesHistoricos:[]}),{lotes:v,pacotes:O,fazendas:y,doadoras:k,clientes:H,loading:T,selectedLote:s,setSelectedLote:l,showLoteDetail:P,setShowLoteDetail:W,acasalamentos:te,fazendasDestinoIds:de,historicoDespachos:me,setHistoricoDespachos:o,aspiracoesDisponiveis:M,dosesDisponiveis:C,fazendaOrigemNome:F,fazendasDestinoNomes:U,dosesDisponiveisNoLote:ce,dataAspiracao:ve,pacotesParaFiltro:he,fazendasAspiracaoUnicas:De,lotesHistoricos:pe,loadingHistorico:je,loteExpandido:fe,detalhesLoteExpandido:we,loadingDetalhes:Oe,loadLoteDetail:Ge,loadLotesHistoricos:la,handleExpandirLote:g}=ns({id:a,filtroHistoricoDataInicio:A,filtroHistoricoDataFim:q,filtroHistoricoFazenda:x,setHistoricoPage:S}),xe=xs(v,he,G,R),ie=us(De,J),_e=d.useCallback(()=>{Y(""),K(""),ae(""),z(!1)},[Y,K,ae,z]),se=j,ge=S,$e=async()=>{var u,re;if(s)try{r(!0);const le=O.find($=>$.id===s.pacote_aspiracao_id);let ye=Pe((le==null?void 0:le.data_aspiracao)||null);if(!ye){const $=Pe(s.data_abertura);if($){const[be,Ae,Re]=$.split("-").map(Number),Ne=new Date(be,Ae-1,Re);Ne.setDate(Ne.getDate()-1);const Ve=Ne.getFullYear(),ea=String(Ne.getMonth()+1).padStart(2,"0"),pa=String(Ne.getDate()).padStart(2,"0");ye=`${Ve}-${ea}-${pa}`}}const Se=wa();if((ye?Math.max(0,Da(ye,Se)):0)>9){t({title:"Prazo expirado",description:"D8 √© o √∫ltimo dia. N√£o √© poss√≠vel criar embri√µes ap√≥s o D8. O lote ser√° fechado e n√£o aparecer√° mais na lista.",variant:"destructive"}),r(!1);return}const ze=te.filter($=>{var Ae;return parseInt(c[$.id]||((Ae=$.quantidade_embrioes)==null?void 0:Ae.toString())||"0")>0});if(ze.length===0){t({title:"Nenhum embri√£o para despachar",description:"Preencha a quantidade de embri√µes em pelo menos um acasalamento antes de despachar.",variant:"destructive"});return}for(const $ of ze){const be=parseInt(c[$.id]||((u=$.quantidade_embrioes)==null?void 0:u.toString())||"0"),Ae=$.quantidade_oocitos??0,Re=N[$.id],Ne=$.embrioes_clivados_d3,Ve=parseInt(Re??(Ne==null?void 0:Ne.toString())??"")||0,ea=Ve>0?Ve:Ae;if(be>ea){const pa=$.doadora_nome||$.doadora_registro||"Doadora desconhecida",$a=Ve>0?"clivados (D3)":"o√≥citos";t({title:"Valida√ß√£o de quantidade",description:`O acasalamento da doadora "${pa}" possui ${be} embri√µes, mas o limite de ${$a} √© ${ea}. A quantidade de embri√µes n√£o pode exceder esse limite.`,variant:"destructive"});return}}const Ce=`${F} - ${U.join(", ")}`,ke=new Date().toISOString().split("T")[0];if(!de.length){t({title:"Erro ao despachar",description:"√â necess√°rio ter pelo menos uma fazenda destino configurada no lote.",variant:"destructive"});return}let qe="EMB";const Ye=ye||"",Ie=Ye.slice(8,10)+Ye.slice(5,7);if(le!=null&&le.fazenda_id){const{data:$,error:be}=await p.from("fazendas").select("sigla, nome").eq("id",le.fazenda_id).single();!be&&$&&($.sigla?qe=$.sigla:$.nome&&(qe=$.nome.replace(/[^a-zA-Z]/g,"").substring(0,3).toUpperCase()||"EMB"))}const Je=`${qe}-${Ie}`;let He=1;const{count:Ke,error:Ta}=await p.from("embrioes").select("*",{count:"exact",head:!0}).like("identificacao",`${Je}-%`);!Ta&&Ke!==null&&(He=Ke+1);const We=[],Sa=[];let Ea=0;for(const $ of ze){const be=parseInt(c[$.id]||((re=$.quantidade_embrioes)==null?void 0:re.toString())||"0");if(be>0){for(let Ae=0;Ae<be;Ae++){const Re=String(He+Ea).padStart(3,"0"),Ne={lote_fiv_id:s.id,lote_fiv_acasalamento_id:$.id,status_atual:"FRESCO",identificacao:`${Je}-${Re}`};We.push(Ne),Ea++}Sa.push({acasalamento_id:$.id,quantidade:be,doadora:$.doadora_registro||$.doadora_nome,dose:$.dose_nome})}}if(We.length>0){const{error:$}=await p.from("embrioes").insert(We);if($)throw $}const Pa={id:`${s.id}-${ke}`,data_despacho:ke,acasalamentos:Sa};o([Pa,...me]);const Ma=ze.map($=>p.from("lote_fiv_acasalamentos").update({quantidade_embrioes:null}).eq("id",$.id));await Promise.all(Ma),m({}),t({title:"Embri√µes despachados",description:`${We.length} embri√£o(√µes) foram despachados para ${Ce}.`}),Ge(s.id)}catch(le){t({title:"Erro ao despachar embri√µes",description:le instanceof Error?le.message:"Erro desconhecido",variant:"destructive"})}finally{r(!1)}},ma=async u=>{var le,ye;if(!s)return;const re=parseFloat(u.quantidade_fracionada)||0;try{r(!0);const Se=M.find(Ke=>Ke.id===u.aspiracao_doadora_id),Ee=(Se==null?void 0:Se.oocitos_disponiveis)??0,ze=parseInt(u.quantidade_oocitos)||0;if(ze>Ee)throw t({title:"Erro de valida√ß√£o",description:`A quantidade de o√≥citos (${ze}) n√£o pode ser maior que os o√≥citos dispon√≠veis (${Ee})`,variant:"destructive"}),new Error("Valida√ß√£o falhou");const{data:Ce,error:ke}=await p.from("doses_semen").select("id, quantidade").eq("id",u.dose_semen_id).single();if(ke)throw ke;const qe=(Ce==null?void 0:Ce.quantidade)??0;if(qe<re)throw t({title:"Estoque insuficiente",description:`Quantidade dispon√≠vel (${qe}) √© menor que a quantidade fracionada (${re}).`,variant:"destructive"}),new Error("Estoque insuficiente");const Ye={lote_fiv_id:s.id,aspiracao_doadora_id:u.aspiracao_doadora_id,dose_semen_id:u.dose_semen_id,quantidade_fracionada:re,quantidade_oocitos:ze>0?ze:null,observacoes:u.observacoes||null},{error:Ie}=await p.from("lote_fiv_acasalamentos").insert([Ye]);if(Ie){if(Ie.code==="23505"||(le=Ie.message)!=null&&le.includes("duplicate")||(ye=Ie.message)!=null&&ye.includes("unique")){t({title:"Acasalamento duplicado",description:"J√° existe um acasalamento com esta doadora e dose de s√™men neste lote. Edite o existente ou escolha outra combina√ß√£o.",variant:"destructive"});return}throw Ie}const Je=qe-re,{error:He}=await p.from("doses_semen").update({quantidade:Je}).eq("id",(Ce==null?void 0:Ce.id)||"");if(He)throw He;t({title:"Acasalamento adicionado",description:"Acasalamento adicionado com sucesso"}),await Ge(s.id)}catch(Se){const Ee=Se instanceof Error?Se.message:"Erro desconhecido";throw!Ee.includes("Valida√ß√£o")&&!Ee.includes("Estoque")&&t({title:"Erro ao adicionar acasalamento",description:Ee.includes("RLS")||Ee.includes("policy")?"RLS est√° bloqueando escrita. Configure pol√≠ticas anon no Supabase.":Ee,variant:"destructive"}),Se}finally{r(!1)}};return T&&!s?e.jsx(Na,{}):s&&P?e.jsx(cs,{lote:s,acasalamentos:te,aspiracoesDisponiveis:M,dosesDisponiveis:C,dosesDisponiveisNoLote:ce,doadoras:k,clientes:H,historicoDespachos:me,dataAspiracao:ve,fazendaOrigemNome:F,fazendasDestinoNomes:U,submitting:E,onBack:()=>{W(!1),l(null)},onAddAcasalamento:ma,onDespacharEmbrioes:$e,onUpdateQuantidadeEmbrioes:(u,re)=>{m({...c,[u]:re})},editQuantidadeEmbrioes:c,onUpdateClivados:async(u,re)=>{ee({...N,[u]:re});const le=parseInt(re)||null;await p.from("lote_fiv_acasalamentos").update({embrioes_clivados_d3:le}).eq("id",u)},editClivados:N}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(Va,{title:"Lotes FIV",description:"Gerenciar lotes de fecunda√ß√£o in vitro",actions:e.jsx(ds,{pacotes:O,clientes:H,fazendas:y})}),e.jsxs(Ue,{children:[e.jsx(Qe,{children:e.jsx(Ze,{children:"Lista de Lotes FIV"})}),e.jsx(Xe,{children:e.jsxs(Za,{value:I,onValueChange:u=>i(u),children:[e.jsxs(Xa,{className:"mb-6",children:[e.jsx(za,{value:"ativos",children:"Lotes Ativos"}),e.jsx(za,{value:"historico",children:"Hist√≥rico"})]}),e.jsxs(Aa,{value:"ativos",className:"mt-0",children:[e.jsxs("div",{className:"flex gap-4 mb-6 flex-wrap",children:[e.jsxs("div",{className:"flex-1 min-w-[250px] relative fazenda-busca-container",children:[e.jsx(ne,{htmlFor:"filtro-fazenda-aspira√ß√£o",children:"Filtrar por Fazenda da Aspira√ß√£o"}),e.jsxs("div",{className:"relative",children:[e.jsx(Te,{id:"filtro-fazenda-aspira√ß√£o",placeholder:"Digite para buscar fazenda...",value:J,onChange:u=>{K(u.target.value),z(!0),u.target.value||Y("")},onFocus:()=>z(!0)}),G&&e.jsx(oe,{variant:"ghost",size:"sm",className:"absolute right-1 top-1 h-7 w-7 p-0",onClick:()=>{Y(""),K(""),z(!1)},children:e.jsx(Ia,{className:"h-4 w-4"})}),f&&ie.length>0&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-white border rounded-md shadow-lg max-h-60 overflow-auto",children:ie.map(u=>e.jsx("div",{className:"px-4 py-2 hover:bg-muted cursor-pointer",onClick:()=>{Y(u.id),K(u.nome),z(!1)},children:u.nome},u.id))}),f&&J&&ie.length===0&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-white border rounded-md shadow-lg p-4 text-sm text-muted-foreground",children:"Nenhuma fazenda encontrada"})]})]}),e.jsxs("div",{className:"flex-1 min-w-[200px]",children:[e.jsx(ne,{htmlFor:"filtro-dia-cultivo",children:"Filtrar por Dia do Cultivo"}),e.jsxs(oa,{value:R||void 0,onValueChange:u=>ae(u||""),children:[e.jsx(ia,{id:"filtro-dia-cultivo",children:e.jsx(ra,{placeholder:"Todos os dias"})}),e.jsx(na,{children:[0,1,2,3,4,5,6,7,8].map(u=>e.jsxs(da,{value:u.toString(),children:["D",u," - ",xa(u)]},u))})]})]}),(G||R)&&e.jsx("div",{className:"flex items-end",children:e.jsx(oe,{variant:"outline",onClick:_e,children:"Limpar Filtros"})})]}),xe.length===0?e.jsx(Fa,{title:v.length===0?"Nenhum lote cadastrado":"Nenhum lote encontrado",description:v.length===0?"Crie um novo lote para come√ßar.":"Ajuste os filtros para encontrar outros lotes."}):e.jsxs(aa,{children:[e.jsx(sa,{children:e.jsxs(Fe,{children:[e.jsx(Q,{children:"Aspira√ß√£o"}),e.jsx(Q,{children:"Fazendas Destino"}),e.jsx(Q,{children:"Dia do Cultivo"}),e.jsx(Q,{children:"Acasalamentos"}),e.jsx(Q,{className:"text-right",children:"A√ß√µes"})]})}),e.jsx(ta,{children:xe.map(u=>e.jsxs(Fe,{children:[e.jsxs(Z,{children:[u.pacote_data&&ue(u.pacote_data)," - ",u.pacote_nome]}),e.jsx(Z,{children:e.jsx("div",{className:"flex flex-wrap gap-1",children:u.fazendas_destino_nomes&&u.fazendas_destino_nomes.length>0?u.fazendas_destino_nomes.map((re,le)=>e.jsx(Le,{variant:"outline",className:"text-xs",children:re},le)):e.jsx("span",{className:"text-muted-foreground",children:"-"})})}),e.jsx(Z,{children:u.dia_atual!==void 0?e.jsx(Le,{variant:"outline",className:`font-semibold ${es(u.dia_atual===0?-1:u.dia_atual>9?8:u.dia_atual-1)}`,children:(()=>{const re=u.dia_atual===0?-1:u.dia_atual>9?8:u.dia_atual-1;return re===-1?`D-1 - ${xa(re)}`:`D${re} - ${xa(re)}`})()}):e.jsx("span",{className:"text-muted-foreground",children:"-"})}),e.jsx(Z,{children:u.quantidade_acasalamentos??0}),e.jsx(Z,{className:"text-right",children:e.jsx(oe,{variant:"ghost",size:"sm",onClick:()=>b(`/lotes-fiv/${u.id}`),children:e.jsx(Wa,{className:"w-4 h-4"})})})]},u.id))})]})]}),e.jsx(Aa,{value:"historico",className:"mt-0",children:e.jsx(ls,{lotesHistoricos:pe,fazendas:y,detalhesLoteExpandido:we,loteExpandido:fe,loadingHistorico:je,loadingDetalhes:Oe,filtroHistoricoDataInicio:A,setFiltroHistoricoDataInicio:L,filtroHistoricoDataFim:q,setFiltroHistoricoDataFim:h,filtroHistoricoFazenda:x,setFiltroHistoricoFazenda:V,filtroHistoricoFazendaBusca:B,setFiltroHistoricoFazendaBusca:_,showFazendaBuscaHistorico:w,setShowFazendaBuscaHistorico:D,historicoPage:se,setHistoricoPage:ge,HISTORICO_PAGE_SIZE:n,onLoadHistorico:la,onExpandirLote:g})})]})})]})]})}function xs(a,b,t,E){return d.useMemo(()=>{let r=[...a];if(r=r.filter(c=>c.status==="FECHADO"||c.dia_atual!==void 0&&c.dia_atual>9?!1:c.dia_atual!==void 0&&c.dia_atual<=9),t&&(r=r.filter(c=>{const m=b.find(N=>N.id===c.pacote_aspiracao_id);return(m==null?void 0:m.fazenda_id)===t})),E!==""){const c=parseInt(E);r=r.filter(m=>m.dia_atual===void 0||m.dia_atual===null?!1:(m.dia_atual===0?-1:m.dia_atual-1)===c)}return r},[a,t,E,b])}function us(a,b){return d.useMemo(()=>a.filter(t=>t.nome.toLowerCase().includes(b.toLowerCase())),[a,b])}export{Rs as default};
