import{c as ye,r as n,s as x,j as e,h as L,a as Fe,k as Qe,i as Ke,g as ea,A as Le,D as aa,L as _e,l as sa}from"./index-CvlUDCD-.js";import{f as Ue,S as ta}from"./StatusBadge-Dl4aSm-D.js";import{N as ra,g as oa,a as ia}from"./coordinates-CkLvlMjh.js";import{u as Ne,C as Q,c as K,a as de,b as me}from"./use-toast-BhbfqK05.js";import{T as De,a as Ce,b as ie,c as I,d as Re,e as H}from"./table-BAfLAU-a.js";import{T as na,a as ca,b as be,c as we}from"./tabs-DVZOasbN.js";import{B as W}from"./badge-C6XBkHcG.js";import{P as la}from"./PageHeader-Don16aHL.js";import{E as Ee}from"./EmptyState-DFkj0E0i.js";import{D as fe,b as xe,c as ge,d as je,e as ve,f as da,a as Ve}from"./dialog-DSJKtNd7.js";import{S as ze,a as Me,b as Pe,c as Ae,d as oe}from"./select-CRV7QsOQ.js";import{I as re}from"./input-BiDTc9_9.js";import{L as ee}from"./label-BIMTC7_j.js";import{h as $e}from"./error-handler-CiAOpFaY.js";import{T as ma}from"./textarea-CWzGJoHk.js";import{m as Ge,a as Ze,D as ua,f as ha,p as pa,C as fa}from"./DatePickerBR-gAx3gAQT.js";import{S as Je}from"./search-B2NaMPhp.js";import{P as Ye}from"./plus-BqMf1Hqu.js";import{S as xa}from"./square-pen-Diq1C2ze.js";import{H as Xe,P as ga,D as ja,G as va,S as le}from"./DoadoraHistoricoAspiracoes-CmA2ei9_.js";import{B as Oe}from"./baby-OCGQJO6t.js";import{A as Na}from"./arrow-left-DavZAJTM.js";import{M as _a}from"./map-pin-CAPZ6-1g.js";import{U as ba}from"./user-BGYI8phH.js";import{B as qe}from"./beef-DT9RhrV1.js";import"./index-Mm2kbPk7.js";import"./index-BYe3zTS0.js";import"./x-DpiajgWI.js";import"./index-CDlvsNjp.js";import"./check-BbN618wW.js";import"./popover-D6dVxm31.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const wa=ye("ArrowRight",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Sa=ye("CircleAlert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ea=ye("ClipboardList",[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}],["path",{d:"M12 11h4",key:"1jrz19"}],["path",{d:"M12 16h4",key:"n85exb"}],["path",{d:"M8 11h.01",key:"1dfujw"}],["path",{d:"M8 16h.01",key:"18s6g9"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ya=ye("Phone",[["path",{d:"M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z",key:"foiqr5"}]]);function Da(t,r){const s=Ma(t);let u;if(s.date){const p=Pa(s.date,2);u=Aa(p.restDateString,p.year)}if(!u||isNaN(u.getTime()))return new Date(NaN);const d=u.getTime();let v=0,g;if(s.time&&(v=Ta(s.time),isNaN(v)))return new Date(NaN);if(s.timezone){if(g=ka(s.timezone),isNaN(g))return new Date(NaN)}else{const p=new Date(d+v),c=new Date(0);return c.setFullYear(p.getUTCFullYear(),p.getUTCMonth(),p.getUTCDate()),c.setHours(p.getUTCHours(),p.getUTCMinutes(),p.getUTCSeconds(),p.getUTCMilliseconds()),c}return new Date(d+v+g)}const Se={dateTimeDelimiter:/[T ]/,timeZoneDelimiter:/[Z ]/i,timezone:/([Z+-].*)$/},Ca=/^-?(?:(\d{3})|(\d{2})(?:-?(\d{2}))?|W(\d{2})(?:-?(\d{1}))?|)$/,Ra=/^(\d{2}(?:[.,]\d*)?)(?::?(\d{2}(?:[.,]\d*)?))?(?::?(\d{2}(?:[.,]\d*)?))?$/,za=/^([+-])(\d{2})(?::?(\d{2}))?$/;function Ma(t){const r={},a=t.split(Se.dateTimeDelimiter);let s;if(a.length>2)return r;if(/:/.test(a[0])?s=a[0]:(r.date=a[0],s=a[1],Se.timeZoneDelimiter.test(r.date)&&(r.date=t.split(Se.timeZoneDelimiter)[0],s=t.substr(r.date.length,t.length))),s){const u=Se.timezone.exec(s);u?(r.time=s.replace(u[1],""),r.timezone=u[1]):r.time=s}return r}function Pa(t,r){const a=new RegExp("^(?:(\\d{4}|[+-]\\d{"+(4+r)+"})|(\\d{2}|[+-]\\d{"+(2+r)+"})$)"),s=t.match(a);if(!s)return{year:NaN,restDateString:""};const u=s[1]?parseInt(s[1]):null,d=s[2]?parseInt(s[2]):null;return{year:d===null?u:d*100,restDateString:t.slice((s[1]||s[2]).length)}}function Aa(t,r){if(r===null)return new Date(NaN);const a=t.match(Ca);if(!a)return new Date(NaN);const s=!!a[4],u=pe(a[1]),d=pe(a[2])-1,v=pe(a[3]),g=pe(a[4]),p=pe(a[5])-1;if(s)return Ba(r,g,p)?Oa(r,g,p):new Date(NaN);{const c=new Date(0);return!Ia(r,d,v)||!Ha(r,u)?new Date(NaN):(c.setUTCFullYear(r,d,Math.max(u,v)),c)}}function pe(t){return t?parseInt(t):1}function Ta(t){const r=t.match(Ra);if(!r)return NaN;const a=ke(r[1]),s=ke(r[2]),u=ke(r[3]);return La(a,s,u)?a*Ge+s*Ze+u*1e3:NaN}function ke(t){return t&&parseFloat(t.replace(",","."))||0}function ka(t){if(t==="Z")return 0;const r=t.match(za);if(!r)return 0;const a=r[1]==="+"?-1:1,s=parseInt(r[2]),u=r[3]&&parseInt(r[3])||0;return $a(s,u)?a*(s*Ge+u*Ze):NaN}function Oa(t,r,a){const s=new Date(0);s.setUTCFullYear(t,0,4);const u=s.getUTCDay()||7,d=(r-1)*7+a+1-u;return s.setUTCDate(s.getUTCDate()+d),s}const Fa=[31,null,31,30,31,30,31,31,30,31,30,31];function We(t){return t%400===0||t%4===0&&t%100!==0}function Ia(t,r,a){return r>=0&&r<=11&&a>=1&&a<=(Fa[r]||(We(t)?29:28))}function Ha(t,r){return r>=1&&r<=(We(t)?366:365)}function Ba(t,r,a){return r>=1&&r<=53&&a>=0&&a<=6}function La(t,r,a){return t===24?r===0&&a===0:a>=0&&a<60&&r>=0&&r<60&&t>=0&&t<25}function $a(t,r){return r>=0&&r<=59}function qa({selectedFazendaId:t}){const[r,a]=n.useState([]),[s,u]=n.useState([]),[d,v]=n.useState([]),[g,p]=n.useState([]),[c,A]=n.useState(!0),[M,F]=n.useState(!1),[w,R]=n.useState(""),[C,T]=n.useState("all"),$=n.useCallback(()=>{let l=s;if(C!=="all"&&(l=l.filter(m=>m.status_calculado===C)),w.trim()){const m=w.toLowerCase();l=l.filter(y=>{var P;return y.identificacao.toLowerCase().includes(m)||((P=y.nome)==null?void 0:P.toLowerCase().includes(m))})}v(l)},[s,C,w]);n.useEffect(()=>{$()},[$]),n.useEffect(()=>{q()},[]),n.useEffect(()=>{t&&N()},[t]);const q=n.useCallback(async()=>{try{A(!0);const{data:l,error:m}=await x.from("fazendas").select("id, nome, cliente_id").order("nome",{ascending:!0});if(m)throw m;a(l||[])}catch(l){$e(l,"Erro ao carregar fazendas")}finally{A(!1)}},[]),N=n.useCallback(async()=>{if(!t){u([]),v([]),p([]);return}try{F(!0);const{data:l,error:m}=await x.from("vw_receptoras_fazenda_atual").select("receptora_id, fazenda_nome_atual").eq("fazenda_id_atual",t);if(m)throw m;const y=(l==null?void 0:l.map(D=>D.receptora_id))||[];if(y.length===0){u([]),v([]),p([]);return}const{data:P,error:o}=await x.from("receptoras").select("*").in("id",y).order("identificacao",{ascending:!0});if(o)throw o;const f=new Map((l==null?void 0:l.map(D=>[D.receptora_id,D.fazenda_nome_atual]))||[]),k=(P||[]).map(D=>({...D,fazenda_nome_atual:f.get(D.id)})).map(D=>({...D,status_calculado:D.status_reprodutivo||"VAZIA"})),O=["PRENHE","PRENHE_RETOQUE","PRENHE_FEMEA","PRENHE_MACHO","PRENHE_SEM_SEXO","PRENHE_2_SEXOS"],V=k.filter(D=>O.includes(D.status_calculado)||D.status_calculado.includes("PRENHE"));if(V.length>0){const D=V.map(Y=>Y.id),{data:Z,error:ae}=await x.from("diagnosticos_gestacao").select("receptora_id, numero_gestacoes").in("receptora_id",D).in("resultado",["PRENHE","PRENHE_FEMEA","PRENHE_MACHO","PRENHE_SEM_SEXO","PRENHE_2_SEXOS"]).not("numero_gestacoes","is",null);if(!ae&&Z){const Y=new Map;Z.forEach(U=>{if(U.numero_gestacoes&&U.numero_gestacoes>1){const j=Y.get(U.receptora_id)||0;U.numero_gestacoes>j&&Y.set(U.receptora_id,U.numero_gestacoes)}}),k.forEach(U=>{const j=Y.get(U.id);j&&j>1&&(U.numero_gestacoes=j)})}}const se=Array.from(new Set(k.map(D=>D.status_calculado))).filter(D=>D).sort();p(se),u(k),v(k),T("all")}catch(l){$e(l,"Erro ao carregar receptoras")}finally{F(!1)}},[t]),S=n.useCallback(async()=>{await N()},[N]),i=n.useCallback((l,m)=>{u(y=>y.map(P=>P.id===l?{...P,...m}:P))},[]),b=n.useCallback(l=>{u(m=>m.filter(y=>y.id!==l)),v(m=>m.filter(y=>y.id!==l))},[]);return{fazendas:r,receptoras:s,filteredReceptoras:d,statusDisponiveis:g,loadingFazendas:c,loadingReceptoras:M,searchTerm:w,setSearchTerm:R,filtroStatus:C,setFiltroStatus:T,loadFazendas:q,loadReceptoras:N,reloadReceptoras:S,updateReceptoraInList:i,removeReceptoraFromList:b}}function Ua({selectedFazendaId:t,onSuccess:r}){const{toast:a}=Ne(),[s,u]=n.useState({identificacao:"",nome:""}),[d,v]=n.useState(!1),[g,p]=n.useState({identificacao:"",nome:""}),[c,A]=n.useState(null),[M,F]=n.useState(!1),[w,R]=n.useState(!1),C=n.useCallback(()=>{u({identificacao:"",nome:""})},[]),T=n.useCallback(()=>{p({identificacao:"",nome:""}),A(null)},[]),$=n.useCallback(S=>{A(S),p({identificacao:S.identificacao,nome:S.nome||""}),F(!0)},[]),q=n.useCallback(async S=>{if(S.preventDefault(),!s.identificacao.trim()){a({title:"Erro de validação",description:"Identificação (brinco) é obrigatória",variant:"destructive"});return}if(!t){a({title:"Erro de validação",description:"Selecione uma fazenda primeiro",variant:"destructive"});return}try{R(!0);const{data:i,error:b}=await x.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",t);if(b)throw b;const l=(i==null?void 0:i.map(o=>o.receptora_id))||[];if(l.length>0){const{data:o,error:f}=await x.from("receptoras").select("id, identificacao, nome").in("id",l).ilike("identificacao",s.identificacao.trim());if(f)throw f;if(o&&o.length>0){const E=o[0].nome?`"${o[0].nome}"`:"sem nome";throw new Error(`Já existe uma receptora com o brinco "${s.identificacao.trim()}" nesta fazenda (Nome: ${E}).`)}if(s.nome.trim()){const{data:E,error:k}=await x.from("receptoras").select("id, identificacao").in("id",l).ilike("nome",s.nome.trim());if(k)throw k;if(E&&E.length>0)throw new Error(`Já existe uma receptora com o nome "${s.nome.trim()}" nesta fazenda (Brinco: ${E[0].identificacao}).`)}}const m={identificacao:s.identificacao};s.nome.trim()&&(m.nome=s.nome);const{data:y,error:P}=await x.from("receptoras").insert([m]).select().single();if(P)throw P.code==="23505"?new Error("Já existe uma receptora com esse brinco nesta fazenda."):P;await x.from("receptora_fazenda_historico").insert([{receptora_id:y.id,fazenda_id:t,data_inicio:new Date().toISOString().split("T")[0],data_fim:null}]),a({title:"Receptora criada",description:"Receptora criada com sucesso"}),v(!1),C(),r==null||r()}catch(i){a({title:"Erro ao criar receptora",description:i instanceof Error?i.message:"Erro desconhecido",variant:"destructive"})}finally{R(!1)}},[s,t,a,C,r]),N=n.useCallback(async S=>{if(S.preventDefault(),!!c){if(!g.identificacao.trim()){a({title:"Erro de validação",description:"Identificação (brinco) é obrigatória",variant:"destructive"});return}try{R(!0);const i=c.identificacao,b=g.identificacao.trim(),l=i!==b,m={identificacao:b,nome:g.nome.trim()||null},{error:y}=await x.from("receptoras").update(m).eq("id",c.id);if(y)throw y.code==="23505"?new Error("Já existe uma receptora com esse brinco nesta fazenda."):y;if(l)try{await x.from("receptora_renomeacoes_historico").insert([{receptora_id:c.id,brinco_anterior:i,brinco_novo:b,data_renomeacao:new Date().toISOString(),motivo:"EDICAO_MANUAL",observacoes:null}])}catch{}a({title:"Receptora atualizada",description:l?`Receptora atualizada. Brinco alterado de "${i}" para "${b}".`:"Receptora atualizada com sucesso"}),F(!1),T(),r==null||r()}catch(i){a({title:"Erro ao atualizar receptora",description:i instanceof Error?i.message:"Erro desconhecido",variant:"destructive"})}finally{R(!1)}}},[g,c,a,T,r]);return{formData:s,setFormData:u,showDialog:d,setShowDialog:v,editFormData:g,setEditFormData:p,editingReceptora:c,showEditDialog:M,setShowEditDialog:F,submitting:w,handleSubmit:q,handleEditSubmit:N,handleEdit:$,resetForm:C,resetEditForm:T}}function Va({fazendas:t,selectedFazendaId:r,editingReceptora:a,onSuccess:s,onClose:u}){const{toast:d}=Ne(),[v,g]=n.useState(!1),[p,c]=n.useState(""),[A,M]=n.useState(""),[F,w]=n.useState(!1),[R,C]=n.useState(!1),[T,$]=n.useState(!1),q=n.useCallback(()=>{c(""),M(""),w(!1),C(!1)},[]),N=t.filter(i=>i.id!==r);n.useEffect(()=>{(async()=>{if(!a||!p){w(!1),M(""),C(!1);return}try{const{data:b,error:l}=await x.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",p);if(l)return;const m=(b==null?void 0:b.map(o=>o.receptora_id))||[];if(m.length===0){w(!1),M(""),C(!1);return}if(a.nome&&a.nome.trim()){const{data:o,error:f}=await x.from("receptoras").select("id, nome, identificacao").in("id",m).ilike("nome",a.nome.trim());!f&&o&&o.length>0?C(!0):C(!1)}else C(!1);const{data:y,error:P}=await x.from("receptoras").select("id, identificacao").in("id",m).ilike("identificacao",a.identificacao);if(P)return;if(y&&y.length>0){w(!0);const o=async(f,E=0)=>{if(E>10)throw new Error("Não foi possível gerar um brinco disponível após várias tentativas");const k=new Date,O=String(k.getDate()).padStart(2,"0"),V=String(k.getMonth()+1).padStart(2,"0"),se=E===0?`-MOV${O}${V}`:`-MOV${O}${V}-${E}`,D=`${f}${se}`,{data:Z,error:ae}=await x.from("receptoras").select("id, identificacao").in("id",m).ilike("identificacao",D);return ae?D:Z&&Z.length>0?o(f,E+1):D};try{const f=await o(a.identificacao);M(f)}catch{const f=new Date,E=String(f.getDate()).padStart(2,"0"),k=String(f.getMonth()+1).padStart(2,"0");M(`${a.identificacao}-MOV${E}${k}`)}}else w(!1),M("")}catch{w(!1),M("")}})()},[a,p]);const S=n.useCallback(async()=>{if(!a||!p){d({title:"Erro de validação",description:"Selecione uma fazenda de destino",variant:"destructive"});return}if(R&&a.nome&&a.nome.trim()){d({title:"Conflito de nome",description:`Já existe uma receptora com o nome "${a.nome.trim()}" na fazenda destino. Não é possível mover esta receptora.`,variant:"destructive"});return}try{$(!0);const i=a.identificacao;let b=i;if(F&&A){b=A;const{error:m}=await x.from("receptoras").update({identificacao:b}).eq("id",a.id);if(m)throw new Error(`Erro ao atualizar brinco: ${m.message}`);try{await x.from("receptora_renomeacoes_historico").insert([{receptora_id:a.id,brinco_anterior:i,brinco_novo:b,data_renomeacao:new Date().toISOString(),motivo:"MUDANCA_FAZENDA",observacoes:"Renomeação automática devido a conflito de brinco na fazenda destino"}])}catch{}}const{error:l}=await x.rpc("mover_receptora_fazenda",{p_receptora_id:a.id,p_nova_fazenda_id:p,p_data_mudanca:new Date().toISOString().split("T")[0],p_observacoes:null});if(l){let m="Erro ao mover receptora";l.message?m=l.message:l.details&&(m=l.details),d({title:"Erro ao mover receptora",description:m,variant:"destructive"});return}d({title:"Receptora movida",description:F?`Receptora movida com sucesso. Brinco atualizado de "${i}" para "${b}" devido a conflito na fazenda destino.`:"Receptora movida para a nova fazenda com sucesso. Protocolos e histórico não foram afetados."}),g(!1),q(),u==null||u(),s==null||s()}catch(i){d({title:"Erro ao mover receptora",description:i instanceof Error?i.message:"Erro desconhecido ao mover receptora",variant:"destructive"})}finally{$(!1)}},[a,p,F,R,A,d,q,u,s]);return{showMoverFazendaDialog:v,setShowMoverFazendaDialog:g,novaFazendaId:p,setNovaFazendaId:c,novoBrincoProposto:A,temConflitoBrinco:F,temConflitoNome:R,submittingMover:T,fazendasDisponiveis:N,handleMoverFazenda:S,resetMoverState:q}}function Ga({selectedFazendaId:t,fazendas:r,onSuccess:a}){const{toast:s}=Ne(),u=new Date().toISOString().split("T")[0],[d,v]=n.useState(!1),[g,p]=n.useState({receptora_id:"",data_nascimento:u,sexo:"",observacoes:""}),[c,A]=n.useState([]),[M,F]=n.useState(!1),[w,R]=n.useState(!1),C=N=>N.includes("FEMEA")?"FEMEA":N.includes("MACHO")?"MACHO":"SEM_SEXO",T=async N=>{const{data:S,error:i}=await x.from("transferencias_embrioes").select("embriao_id, data_te").eq("receptora_id",N).eq("status_te","REALIZADA").order("data_te",{ascending:!1});if(i)throw i;if(!S||S.length===0)return[];const b=S[0].data_te,m=S.filter(j=>j.data_te===b).map(j=>j.embriao_id).filter(Boolean);if(m.length===0)return[];const{data:y}=await x.from("animais").select("embriao_id").in("embriao_id",m),P=new Set((y||[]).map(j=>j.embriao_id)),o=m.filter(j=>!P.has(j));if(o.length===0)return[];const{data:f,error:E}=await x.from("embrioes").select("id, lote_fiv_acasalamento_id").in("id",o);if(E)throw E;const k=[...new Set((f||[]).map(j=>j.lote_fiv_acasalamento_id).filter(Boolean))];let O=[],V=[],se=[],D=[];if(k.length>0){const{data:j}=await x.from("lote_fiv_acasalamentos").select("id, aspiracao_doadora_id, dose_semen_id").in("id",k);O=j||[];const J=[...new Set(O.map(B=>B.aspiracao_doadora_id).filter(Boolean))],te=[...new Set(O.map(B=>B.dose_semen_id).filter(Boolean))];if(J.length>0){const{data:B}=await x.from("aspiracoes_doadoras").select("id, doadora_id").in("id",J);V=B||[];const X=[...new Set(V.map(G=>G.doadora_id).filter(Boolean))];if(X.length>0){const{data:G}=await x.from("doadoras").select("id, registro, raca").in("id",X);se=G||[]}}if(te.length>0){const{data:B}=await x.from("doses_semen").select("id, touro:touros(id, nome, registro, raca)").in("id",te);D=B||[]}}const Z=new Map(O.map(j=>[j.id,j])),ae=new Map(V.map(j=>[j.id,j])),Y=new Map(se.map(j=>[j.id,j])),U=new Map(D.map(j=>[j.id,j]));return(f||[]).map(j=>{const J=j.lote_fiv_acasalamento_id?Z.get(j.lote_fiv_acasalamento_id):void 0,te=J?ae.get(J.aspiracao_doadora_id):void 0,B=te?Y.get(te.doadora_id):void 0,X=J?U.get(J.dose_semen_id):void 0,G=(X==null?void 0:X.touro)??null;return{embriao_id:j.id,doadora_registro:B==null?void 0:B.registro,touro_nome:G==null?void 0:G.nome,raca:(B==null?void 0:B.raca)||(G==null?void 0:G.raca)}})},$=n.useCallback(async N=>{var S;try{F(!0),A([]),p({receptora_id:N.id,data_nascimento:u,sexo:"",observacoes:""}),v(!0);const[i,b]=await Promise.all([T(N.id),x.from("diagnosticos_gestacao").select("sexagem").eq("receptora_id",N.id).eq("tipo_diagnostico","SEXAGEM").order("data_diagnostico",{ascending:!1}).limit(1).maybeSingle()]),l=((S=b==null?void 0:b.data)==null?void 0:S.sexagem)||C(N.status_calculado);p(m=>({...m,sexo:l||""})),A(i),i.length===0&&s({title:"Sem embriões disponíveis",description:"Nenhum embrião elegível para criar animal foi encontrado."})}catch(i){s({title:"Erro ao preparar nascimento",description:i instanceof Error?i.message:"Erro desconhecido",variant:"destructive"})}finally{F(!1)}},[u,s]),q=n.useCallback(async()=>{if(!t){s({title:"Fazenda não selecionada",description:"Selecione a fazenda antes de registrar o nascimento.",variant:"destructive"});return}if(!g.receptora_id){s({title:"Receptora não selecionada",description:"Selecione a receptora para registrar o nascimento.",variant:"destructive"});return}if(!g.data_nascimento){s({title:"Data de nascimento obrigatória",description:"Informe a data de nascimento.",variant:"destructive"});return}if(!g.sexo){s({title:"Sexo obrigatório",description:"Selecione o sexo da prenhez.",variant:"destructive"});return}if(c.length===0){s({title:"Sem embriões vinculados",description:"Nenhum embrião encontrado para a última transferência desta receptora.",variant:"destructive"});return}try{R(!0);const N=r.find(m=>m.id===t),S=(N==null?void 0:N.cliente_id)||null,i=c.map(m=>({embriao_id:m.embriao_id,receptora_id:g.receptora_id,fazenda_id:t,cliente_id:S,data_nascimento:g.data_nascimento,sexo:g.sexo,raca:m.raca||null,pai_nome:m.touro_nome||null,mae_nome:m.doadora_registro||null,observacoes:g.observacoes||null})),{error:b}=await x.from("animais").insert(i);if(b)throw b;const{error:l}=await x.from("receptoras").update({status_reprodutivo:"VAZIA",data_provavel_parto:null}).eq("id",g.receptora_id);if(l)throw l;s({title:"Nascimento registrado",description:`${i.length} animal(is) criado(s) com sucesso.`}),v(!1),A([]),p({receptora_id:"",data_nascimento:u,sexo:"",observacoes:""}),a==null||a()}catch(N){s({title:"Erro ao registrar nascimento",description:N instanceof Error?N.message:"Erro desconhecido",variant:"destructive"})}finally{R(!1)}},[g,c,t,r,u,s,a]);return{showNascimentoDialog:d,setShowNascimentoDialog:v,nascimentoForm:g,setNascimentoForm:p,nascimentoEmbrioes:c,nascimentoLoading:M,submitting:w,handleAbrirNascimento:$,handleRegistrarNascimento:q}}function Za({open:t,onOpenChange:r,receptora:a,fazendasDisponiveis:s,novaFazendaId:u,onFazendaChange:d,temConflitoBrinco:v,temConflitoNome:g,novoBrincoProposto:p,submitting:c,onConfirmar:A,onCancelar:M}){const F=R=>{r(R),R||M()},w=u&&!g&&!(v&&!p);return e.jsx(fe,{open:t,onOpenChange:F,children:e.jsxs(xe,{className:"max-w-md",children:[e.jsxs(ge,{children:[e.jsx(je,{children:"Mover Receptora"}),e.jsxs(ve,{children:["Mover ",a==null?void 0:a.identificacao," para outra fazenda. Protocolos e histórico reprodutivo não serão afetados."]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"nova_fazenda",children:"Nova Fazenda *"}),e.jsxs(ze,{value:u,onValueChange:d,children:[e.jsx(Me,{children:e.jsx(Pe,{placeholder:"Selecione a fazenda de destino"})}),e.jsx(Ae,{children:s.map(R=>e.jsx(oe,{value:R.id,children:R.nome},R.id))})]})]}),g&&(a==null?void 0:a.nome)&&e.jsxs("div",{className:"space-y-2 p-3 bg-red-50 border border-red-200 rounded-md",children:[e.jsx("div",{className:"flex items-start gap-2",children:e.jsx("div",{className:"text-red-800 text-sm font-medium",children:"Conflito de Nome Detectado"})}),e.jsxs("div",{className:"text-red-700 text-sm",children:['Já existe uma receptora com o nome "',a.nome.trim(),'" na fazenda destino.']}),e.jsx("div",{className:"text-red-600 text-xs",children:"Não é possível mover esta receptora. Edite o nome da receptora antes de movê-la."})]}),v&&p&&e.jsxs("div",{className:"space-y-2 p-3 bg-yellow-50 border border-yellow-200 rounded-md",children:[e.jsx("div",{className:"flex items-start gap-2",children:e.jsx("div",{className:"text-yellow-800 text-sm font-medium",children:"Conflito de Brinco Detectado"})}),e.jsxs("div",{className:"text-yellow-700 text-sm",children:['Já existe uma receptora com o brinco "',a==null?void 0:a.identificacao,'" na fazenda destino.']}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(ee,{className:"text-yellow-800 text-sm font-medium",children:"Novo Brinco Proposto:"}),e.jsx("div",{className:"p-2 bg-white border border-yellow-300 rounded text-sm font-mono text-yellow-900",children:p}),e.jsx("div",{className:"text-yellow-600 text-xs",children:"O brinco será automaticamente atualizado para permitir a movimentação."})]})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(L,{type:"button",className:"flex-1 bg-green-600 hover:bg-green-700",onClick:A,disabled:c||!w,children:c?"Movendo...":"Confirmar Movimentação"}),e.jsx(L,{type:"button",variant:"outline",onClick:M,disabled:c,children:"Cancelar"})]})]})]})})}function Ja({open:t,onOpenChange:r,nascimentoForm:a,onFormChange:s,nascimentoEmbrioes:u,nascimentoLoading:d,submitting:v,onRegistrar:g,onCancelar:p}){return e.jsx(fe,{open:t,onOpenChange:r,children:e.jsxs(xe,{className:"max-w-2xl",children:[e.jsxs(ge,{children:[e.jsx(je,{children:"Registrar nascimento"}),e.jsx(ve,{children:"Crie os animais a partir da prenhez desta receptora."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{children:"Data de nascimento *"}),e.jsx(ua,{value:a.data_nascimento,onChange:c=>s({...a,data_nascimento:c||""}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{children:"Sexo *"}),e.jsxs(ze,{value:a.sexo,onValueChange:c=>s({...a,sexo:c}),children:[e.jsx(Me,{children:e.jsx(Pe,{placeholder:"Selecione o sexo"})}),e.jsxs(Ae,{children:[e.jsx(oe,{value:"FEMEA",children:"Fêmea"}),e.jsx(oe,{value:"MACHO",children:"Macho"}),e.jsx(oe,{value:"SEM_SEXO",children:"Sem sexo"})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{children:"Observações"}),e.jsx(ma,{value:a.observacoes,onChange:c=>s({...a,observacoes:c.target.value}),placeholder:"Observações sobre o nascimento",rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{children:"Embriões vinculados"}),d&&e.jsx("div",{className:"text-sm text-slate-500",children:"Carregando dados..."}),!d&&u.length===0&&e.jsx("div",{className:"text-sm text-slate-500",children:"Nenhum embrião disponível para registro."}),!d&&u.length>0&&e.jsx("div",{className:"border rounded-lg p-3",children:e.jsxs(De,{children:[e.jsx(Ce,{children:e.jsxs(ie,{children:[e.jsx(I,{children:"Embrião"}),e.jsx(I,{children:"Doadora"}),e.jsx(I,{children:"Touro"}),e.jsx(I,{children:"Raça"})]})}),e.jsx(Re,{children:u.map(c=>e.jsxs(ie,{children:[e.jsx(H,{className:"font-medium",children:c.embriao_id.substring(0,8)}),e.jsx(H,{children:c.doadora_registro||"-"}),e.jsx(H,{children:c.touro_nome||"-"}),e.jsx(H,{children:c.raca||"-"})]},c.embriao_id))})]})})]})]}),e.jsxs(da,{children:[e.jsx(L,{type:"button",variant:"outline",onClick:p,children:"Cancelar"}),e.jsx(L,{type:"button",onClick:g,disabled:v,children:"Registrar nascimento"})]})]})})}function Ya({fazendaId:t,fazendaNome:r}){const a=Fe(),[s,u]=n.useState(null),{fazendas:d,filteredReceptoras:v,statusDisponiveis:g,loadingReceptoras:p,searchTerm:c,setSearchTerm:A,filtroStatus:M,setFiltroStatus:F,reloadReceptoras:w,removeReceptoraFromList:R}=qa({selectedFazendaId:t}),{formData:C,setFormData:T,showDialog:$,setShowDialog:q,editFormData:N,setEditFormData:S,editingReceptora:i,showEditDialog:b,setShowEditDialog:l,submitting:m,handleSubmit:y,handleEditSubmit:P,handleEdit:o}=Ua({selectedFazendaId:t,onSuccess:w}),[f,E]=n.useState(null),{showMoverFazendaDialog:k,setShowMoverFazendaDialog:O,novaFazendaId:V,setNovaFazendaId:se,novoBrincoProposto:D,temConflitoBrinco:Z,temConflitoNome:ae,submittingMover:Y,fazendasDisponiveis:U,handleMoverFazenda:j,resetMoverState:J}=Va({fazendas:d,selectedFazendaId:t,editingReceptora:f,onSuccess:()=>{f&&R(f.id),E(null)},onClose:()=>{E(null)}}),te=h=>{E(h),J(),O(!0)},{showNascimentoDialog:B,setShowNascimentoDialog:X,nascimentoForm:G,setNascimentoForm:Te,nascimentoEmbrioes:_,nascimentoLoading:z,submitting:ue,handleAbrirNascimento:ne,handleRegistrarNascimento:ce}=Ga({selectedFazendaId:t,fazendas:d,onSuccess:w}),he=h=>{if(!h)return"-";try{return ha(Da(h),"dd/MM/yyyy",{locale:pa})}catch{return"-"}};return p?e.jsx(Q,{children:e.jsx(K,{className:"py-8",children:e.jsx("div",{className:"flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"})})})}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsxs("div",{className:"relative flex-1 max-w-xs",children:[e.jsx(Je,{className:"absolute left-2 top-2.5 h-4 w-4 text-slate-400"}),e.jsx(re,{placeholder:"Buscar por brinco ou nome...",value:c,onChange:h=>A(h.target.value),className:"pl-8"})]}),e.jsxs(ze,{value:M,onValueChange:F,children:[e.jsx(Me,{className:"w-[180px]",children:e.jsx(Pe,{placeholder:"Filtrar status"})}),e.jsxs(Ae,{children:[e.jsx(oe,{value:"todos",children:"Todos os status"}),g.map(h=>e.jsx(oe,{value:h,children:Ue(h)},h))]})]})]}),e.jsxs(fe,{open:$,onOpenChange:q,children:[e.jsx(Ve,{asChild:!0,children:e.jsxs(L,{className:"bg-green-600 hover:bg-green-700",children:[e.jsx(Ye,{className:"w-4 h-4 mr-2"}),"Nova Receptora"]})}),e.jsxs(xe,{children:[e.jsxs(ge,{children:[e.jsx(je,{children:"Cadastrar Receptora"}),e.jsxs(ve,{children:["Adicionar receptora em ",r]})]}),e.jsxs("form",{onSubmit:y,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"identificacao",children:"Brinco/Identificação *"}),e.jsx(re,{id:"identificacao",value:C.identificacao,onChange:h=>T({...C,identificacao:h.target.value}),placeholder:"Ex: 001, A123",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"nome",children:"Nome (opcional)"}),e.jsx(re,{id:"nome",value:C.nome,onChange:h=>T({...C,nome:h.target.value}),placeholder:"Nome da receptora"})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(L,{type:"submit",className:"flex-1 bg-green-600 hover:bg-green-700",disabled:m,children:m?"Salvando...":"Cadastrar"}),e.jsx(L,{type:"button",variant:"outline",onClick:()=>q(!1),children:"Cancelar"})]})]})]})]})]}),e.jsxs(Q,{children:[e.jsx(de,{children:e.jsxs(me,{children:["Receptoras (",v.length,")"]})}),e.jsx(K,{children:v.length===0?e.jsx(Ee,{title:"Nenhuma receptora encontrada",description:c||M!=="todos"?"Tente ajustar os filtros":"Cadastre a primeira receptora desta fazenda"}):e.jsxs(De,{children:[e.jsx(Ce,{children:e.jsxs(ie,{children:[e.jsx(I,{children:"Brinco"}),e.jsx(I,{children:"Nome"}),e.jsx(I,{children:"Status"}),e.jsx(I,{children:"Data Provável Parto"}),e.jsx(I,{className:"text-right",children:"Ações"})]})}),e.jsx(Re,{children:v.map(h=>e.jsxs(ie,{children:[e.jsx(H,{className:"font-medium",children:h.identificacao}),e.jsx(H,{children:h.nome||"-"}),e.jsx(H,{children:e.jsx(ta,{status:h.status_calculado||h.status_reprodutivo||"DISPONIVEL"})}),e.jsx(H,{children:he(h.data_provavel_parto)}),e.jsx(H,{className:"text-right",children:e.jsxs("div",{className:"flex gap-1 justify-end",children:[e.jsx(L,{variant:"ghost",size:"sm",onClick:()=>o(h),title:"Editar",children:e.jsx(xa,{className:"w-4 h-4"})}),e.jsx(L,{variant:"ghost",size:"sm",onClick:()=>a(`/receptoras/${h.id}/historico`),title:"Histórico",children:e.jsx(Xe,{className:"w-4 h-4"})}),e.jsx(L,{variant:"ghost",size:"sm",onClick:()=>te(h),title:"Mover para outra fazenda",children:e.jsx(wa,{className:"w-4 h-4"})}),(h.status_calculado||"").includes("PRENHE")&&e.jsx(L,{variant:"ghost",size:"sm",onClick:()=>ne(h),title:"Registrar nascimento",children:e.jsx(Oe,{className:"w-4 h-4"})})]})})]},h.id))})]})})]}),e.jsx(fe,{open:b,onOpenChange:l,children:e.jsxs(xe,{children:[e.jsxs(ge,{children:[e.jsx(je,{children:"Editar Receptora"}),e.jsxs(ve,{children:["Editando ",i==null?void 0:i.identificacao]})]}),e.jsxs("form",{onSubmit:P,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"edit-identificacao",children:"Brinco/Identificação *"}),e.jsx(re,{id:"edit-identificacao",value:N.identificacao,onChange:h=>S({...N,identificacao:h.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"edit-nome",children:"Nome"}),e.jsx(re,{id:"edit-nome",value:N.nome,onChange:h=>S({...N,nome:h.target.value})})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(L,{type:"submit",className:"flex-1 bg-green-600 hover:bg-green-700",disabled:m,children:m?"Salvando...":"Salvar"}),e.jsx(L,{type:"button",variant:"outline",onClick:()=>l(!1),children:"Cancelar"})]})]})]})}),e.jsx(Za,{open:k,onOpenChange:O,receptora:f,fazendasDisponiveis:U,novaFazendaId:V,onFazendaChange:se,temConflitoBrinco:Z,temConflitoNome:ae,novoBrincoProposto:D,submitting:Y,onConfirmar:j,onCancelar:()=>{O(!1),E(null),J()}}),e.jsx(Ja,{open:B,onOpenChange:X,nascimentoForm:G,onFormChange:Te,nascimentoEmbrioes:_,nascimentoLoading:z,submitting:ue,onRegistrar:ce,onCancelar:()=>X(!1)})]})}const Xa=["Gir","Gir Leiteiro","Girolando","Nelore","Brahman","Senepol","Angus","Holandês","Jersey"];function Wa({fazendaId:t,fazendaNome:r}){var y,P;const a=Fe(),{toast:s}=Ne(),[u,d]=n.useState(!0),[v,g]=n.useState([]),[p,c]=n.useState(""),[A,M]=n.useState(null),[F,w]=n.useState(!1),[R,C]=n.useState(!1),[T,$]=n.useState({registro:"",raca:"",racaCustom:""}),[q,N]=n.useState(""),S=n.useCallback(async()=>{try{d(!0);const{data:o,error:f}=await x.from("doadoras").select("*").eq("fazenda_id",t).order("created_at",{ascending:!1});if(f)throw f;const E=await Promise.all((o||[]).map(async k=>{const{data:O}=await x.from("aspiracoes_doadoras").select("total_oocitos, data_aspiracao").eq("doadora_id",k.id).order("data_aspiracao",{ascending:!1}).limit(1).maybeSingle();return{...k,ultima_aspiracao_total_oocitos:O==null?void 0:O.total_oocitos,ultima_aspiracao_data:O==null?void 0:O.data_aspiracao}}));g(E)}catch(o){s({title:"Erro ao carregar doadoras",description:o instanceof Error?o.message:"Erro desconhecido",variant:"destructive"})}finally{d(!1)}},[t,s]);n.useEffect(()=>{S()},[S]);const i=v.filter(o=>{var E,k,O;if(!p.trim())return!0;const f=p.toLowerCase();return((E=o.nome)==null?void 0:E.toLowerCase().includes(f))||((k=o.registro)==null?void 0:k.toLowerCase().includes(f))||((O=o.raca)==null?void 0:O.toLowerCase().includes(f))}),b=o=>{N(o),$(o!=="Outra"?{...T,raca:o,racaCustom:""}:{...T,raca:"",racaCustom:""})},l=async o=>{if(o.preventDefault(),!!T.registro.trim())try{C(!0);const f=q==="Outra"?T.racaCustom:T.raca,{error:E}=await x.from("doadoras").insert({fazenda_id:t,registro:T.registro.trim(),raca:f});if(E)throw E;s({title:"Doadora criada",description:"Doadora cadastrada com sucesso."}),w(!1),$({registro:"",raca:"",racaCustom:""}),N(""),S()}catch(f){s({title:"Erro ao criar doadora",description:f instanceof Error?f.message:"Erro desconhecido",variant:"destructive"})}finally{C(!1)}},m=o=>{if(!o)return"-";switch(o){case"1_estrela":return e.jsx("div",{className:"flex items-center gap-1",children:e.jsx(le,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"})});case"2_estrelas":return e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(le,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"}),e.jsx(le,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"})]});case"3_estrelas":return e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(le,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"}),e.jsx(le,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"}),e.jsx(le,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"})]});case"diamante":return e.jsx("div",{className:"flex items-center gap-1",children:e.jsx(va,{className:"w-4 h-4 fill-blue-500 text-blue-500"})});default:return"-"}};return u?e.jsx(Q,{children:e.jsx(K,{className:"py-8",children:e.jsx("div",{className:"flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"})})})}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-2 flex-1",children:e.jsxs("div",{className:"relative flex-1 max-w-xs",children:[e.jsx(Je,{className:"absolute left-2 top-2.5 h-4 w-4 text-slate-400"}),e.jsx(re,{placeholder:"Buscar por nome ou registro...",value:p,onChange:o=>c(o.target.value),className:"pl-8"})]})}),e.jsxs(fe,{open:F,onOpenChange:w,children:[e.jsx(Ve,{asChild:!0,children:e.jsxs(L,{className:"bg-green-600 hover:bg-green-700",children:[e.jsx(Ye,{className:"w-4 h-4 mr-2"}),"Nova Doadora"]})}),e.jsxs(xe,{className:"max-w-md",children:[e.jsxs(ge,{children:[e.jsx(je,{children:"Cadastrar Doadora"}),e.jsxs(ve,{children:["Adicionar doadora em ",r]})]}),e.jsxs("form",{onSubmit:l,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"registro",children:"Registro *"}),e.jsx(re,{id:"registro",value:T.registro,onChange:o=>$({...T,registro:o.target.value}),placeholder:"Registro da doadora",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"raca",children:"Raca *"}),e.jsxs(ze,{value:q,onValueChange:b,children:[e.jsx(Me,{children:e.jsx(Pe,{placeholder:"Selecione a raca"})}),e.jsxs(Ae,{children:[Xa.map(o=>e.jsx(oe,{value:o,children:o},o)),e.jsx(oe,{value:"Outra",children:"Outra"})]})]}),q==="Outra"&&e.jsx(re,{id:"raca_custom",value:T.racaCustom,onChange:o=>$({...T,racaCustom:o.target.value,raca:o.target.value}),placeholder:"Digite a raca",className:"mt-2",required:!0})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(L,{type:"submit",className:"flex-1 bg-green-600 hover:bg-green-700",disabled:R,children:R?"Salvando...":"Criar Doadora"}),e.jsx(L,{type:"button",variant:"outline",onClick:()=>w(!1),disabled:R,children:"Cancelar"})]})]})]})]})]}),e.jsxs(Q,{children:[e.jsx(de,{children:e.jsxs(me,{children:["Doadoras (",i.length,")"]})}),e.jsx(K,{children:i.length===0?e.jsx(Ee,{title:"Nenhuma doadora encontrada",description:p?"Tente ajustar a busca":"Cadastre a primeira doadora desta fazenda"}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(De,{children:[e.jsx(Ce,{children:e.jsxs(ie,{children:[e.jsx(I,{children:"Registro"}),e.jsx(I,{children:"Nome"}),e.jsx(I,{children:"Raca"}),e.jsx(I,{children:"Classificacao"}),e.jsx(I,{children:"Ultima Aspiracao"}),e.jsx(I,{children:"Oocitos"}),e.jsx(I,{children:"Estado"}),e.jsx(I,{className:"text-right",children:"Acoes"})]})}),e.jsx(Re,{children:i.map(o=>e.jsxs(ie,{className:"cursor-pointer hover:bg-slate-50",onClick:()=>a(`/doadoras/${o.id}`),children:[e.jsx(H,{className:"font-medium",children:o.registro}),e.jsx(H,{children:o.nome||"-"}),e.jsx(H,{children:o.raca||"-"}),e.jsx(H,{children:m(o.classificacao_genetica)}),e.jsx(H,{children:o.ultima_aspiracao_data?Qe(o.ultima_aspiracao_data):"-"}),e.jsx(H,{children:o.ultima_aspiracao_total_oocitos??"-"}),e.jsx(H,{children:e.jsx(W,{variant:o.disponivel_aspiracao?"default":"secondary",children:o.disponivel_aspiracao?"Disponivel":"Indisponivel"})}),e.jsx(H,{className:"text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(L,{variant:"ghost",size:"sm",onClick:f=>{f.stopPropagation(),M(o.id)},title:"Ver historico de aspiracoes",children:e.jsx(Xe,{className:"w-4 h-4"})}),e.jsx(L,{variant:"ghost",size:"sm",onClick:f=>{f.stopPropagation(),a(`/doadoras/${o.id}`)},title:"Editar doadora",children:e.jsx(ga,{className:"w-4 h-4"})})]})})]},o.id))})]})})})]}),A&&e.jsx(ja,{doadoraId:A,doadoraNome:((y=v.find(o=>o.id===A))==null?void 0:y.nome)||((P=v.find(o=>o.id===A))==null?void 0:P.registro),open:!!A,onClose:()=>M(null)})]})}function Rs(){const{id:t}=Ke(),r=Fe(),{toast:a}=Ne(),[s,u]=n.useState(!0),[d,v]=n.useState(null),[g,p]=n.useState(""),[c,A]=n.useState({passo2Pendente:0,tePendente:0,dgPendente:0,sexagemPendente:0,prenhesTotal:0}),[M,F]=n.useState({total:0,porStatus:[]}),[w,R]=n.useState({total:0,porRaca:[],oocitos30d:0,aspiracoes30d:0}),[C,T]=n.useState([]);n.useEffect(()=>{t&&$()},[t]);const $=async()=>{var i,b;try{u(!0);const[l,m]=await Promise.all([x.from("fazendas").select("*, cliente:clientes(nome)").eq("id",t).single(),x.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",t)]);if(l.error)throw l.error;const y=l.data;v(y),p(((i=y.cliente)==null?void 0:i.nome)||"");const P=((b=m.data)==null?void 0:b.map(_=>_.receptora_id))||[],[o,f,E,k,O]=await Promise.all([x.from("protocolos_sincronizacao").select("id, status").eq("fazenda_id",t).in("status",["PASSO1_FECHADO","PRIMEIRO_PASSO_FECHADO","SINCRONIZADO"]),P.length>0?x.from("receptoras").select("id, status_reprodutivo, data_provavel_parto").in("id",P):Promise.resolve({data:[],error:null}),x.from("doadoras").select("id, raca").eq("fazenda_id",t),x.from("aspiracoes_doadoras").select("id, total_oocitos").eq("fazenda_id",t).gte("data_aspiracao",new Date(Date.now()-30*24*60*60*1e3).toISOString().split("T")[0]),x.from("animais").select(`
            id, data_nascimento, sexo, raca, pai_nome, mae_nome,
            receptora:receptoras(identificacao),
            embriao:embrioes(
              lote_fiv_acasalamento:lote_fiv_acasalamentos(
                aspiracao:aspiracoes_doadoras(doadora:doadoras(registro)),
                dose:doses_semen(touro:touros(nome))
              )
            )
          `).eq("fazenda_id",t).order("data_nascimento",{ascending:!1}).limit(50)]),V=o.data||[],se=V.filter(_=>_.status==="PASSO1_FECHADO"||_.status==="PRIMEIRO_PASSO_FECHADO").length,D=V.filter(_=>_.status==="SINCRONIZADO").length,Z=f.data||[],ae=new Map;let Y=0,U;Z.forEach(_=>{const z=_.status_reprodutivo||"VAZIA";ae.set(z,(ae.get(z)||0)+1),z.includes("PRENHE")&&(Y++,_.data_provavel_parto&&(!U||_.data_provavel_parto<U)&&(U=_.data_provavel_parto))}),F({total:Z.length,porStatus:Array.from(ae.entries()).map(([_,z])=>({status:_,total:z})).sort((_,z)=>z.total-_.total)});let j=0,J=0;if(P.length>0){const[_,z]=await Promise.all([x.from("transferencias_embrioes").select("receptora_id").in("receptora_id",P).eq("status_te","REALIZADA"),x.from("diagnosticos_gestacao").select("receptora_id, tipo_diagnostico").in("receptora_id",P)]),ue=new Set((_.data||[]).map(h=>h.receptora_id)),ne=new Set((z.data||[]).filter(h=>h.tipo_diagnostico==="DG").map(h=>h.receptora_id)),ce=new Set((z.data||[]).filter(h=>h.tipo_diagnostico==="SEXAGEM").map(h=>h.receptora_id));j=[...ue].filter(h=>!ne.has(h)).length,J=Z.filter(h=>(h.status_reprodutivo||"").includes("PRENHE")&&ne.has(h.id)).filter(h=>!ce.has(h.id)).length}A({passo2Pendente:se,tePendente:D,dgPendente:j,sexagemPendente:J,prenhesTotal:Y,prenhesProximoParto:U});const te=E.data||[],B=new Map;te.forEach(_=>{const z=_.raca||"Sem raça";B.set(z,(B.get(z)||0)+1)});const X=k.data||[],G=X.reduce((_,z)=>_+(z.total_oocitos||0),0);R({total:te.length,porRaca:Array.from(B.entries()).map(([_,z])=>({raca:_,total:z})).sort((_,z)=>z.total-_.total),oocitos30d:G,aspiracoes30d:X.length});const Te=(O.data||[]).map(_=>{var ce,he,h,Ie,He,Be;const z=(ce=_.embriao)==null?void 0:ce.lote_fiv_acasalamento,ue=(h=(he=z==null?void 0:z.aspiracao)==null?void 0:he.doadora)==null?void 0:h.registro,ne=(He=(Ie=z==null?void 0:z.dose)==null?void 0:Ie.touro)==null?void 0:He.nome;return{id:_.id,data_nascimento:_.data_nascimento,sexo:_.sexo,raca:_.raca,receptora_brinco:(Be=_.receptora)==null?void 0:Be.identificacao,doadora:ue||_.mae_nome||null,touro:ne||_.pai_nome||null}});T(Te)}catch(l){a({title:"Erro ao carregar dados",description:l instanceof Error?l.message:"Erro desconhecido",variant:"destructive"})}finally{u(!1)}},q=()=>{d&&(d.latitude&&d.longitude?window.open(oa(d.latitude,d.longitude),"_blank"):d.localizacao&&window.open(ia(d.localizacao),"_blank"))},N=i=>i?new Date(i).toLocaleDateString("pt-BR"):"-",S=c.passo2Pendente+c.tePendente+c.dgPendente+c.sexagemPendente;return s?e.jsx(ea,{}):d?e.jsxs("div",{className:"space-y-6",children:[e.jsx(la,{title:d.nome,description:`Cliente: ${g}`,actions:e.jsx(L,{variant:"outline",size:"icon",onClick:()=>r("/fazendas"),children:e.jsx(Na,{className:"w-4 h-4"})})}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[d.sigla&&e.jsx(Q,{children:e.jsxs(K,{className:"pt-4 flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-slate-100 rounded-lg",children:e.jsx(Ea,{className:"w-4 h-4 text-slate-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-slate-500",children:"Sigla"}),e.jsx("p",{className:"font-semibold",children:d.sigla})]})]})}),d.localizacao&&e.jsx(Q,{className:"cursor-pointer hover:bg-slate-50",onClick:q,children:e.jsxs(K,{className:"pt-4 flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-green-100 rounded-lg",children:e.jsx(_a,{className:"w-4 h-4 text-green-600"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs text-slate-500",children:"Localização"}),e.jsx("p",{className:"font-medium truncate",children:d.localizacao})]}),e.jsx(ra,{className:"w-4 h-4 text-slate-400"})]})}),d.responsavel&&e.jsx(Q,{children:e.jsxs(K,{className:"pt-4 flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:e.jsx(ba,{className:"w-4 h-4 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-slate-500",children:"Responsável"}),e.jsx("p",{className:"font-medium",children:d.responsavel})]})]})}),d.contato_responsavel&&e.jsx(Q,{children:e.jsxs(K,{className:"pt-4 flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-purple-100 rounded-lg",children:e.jsx(ya,{className:"w-4 h-4 text-purple-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-slate-500",children:"Contato"}),e.jsx("p",{className:"font-medium",children:d.contato_responsavel})]})]})})]}),e.jsxs(na,{defaultValue:"resumo",className:"space-y-4",children:[e.jsxs(ca,{className:"grid w-full grid-cols-4",children:[e.jsxs(be,{value:"resumo",className:"flex items-center gap-2",children:[e.jsx(Le,{className:"w-4 h-4"}),"Resumo",S>0&&e.jsx(W,{variant:"destructive",className:"ml-1 h-5 w-5 p-0 flex items-center justify-center text-xs",children:S})]}),e.jsxs(be,{value:"receptoras",className:"flex items-center gap-2",children:[e.jsx(qe,{className:"w-4 h-4"}),"Receptoras",e.jsx(W,{variant:"secondary",className:"ml-1",children:M.total})]}),e.jsxs(be,{value:"doadoras",className:"flex items-center gap-2",children:[e.jsx(aa,{className:"w-4 h-4"}),"Doadoras",e.jsx(W,{variant:"secondary",className:"ml-1",children:w.total})]}),e.jsxs(be,{value:"animais",className:"flex items-center gap-2",children:[e.jsx(Oe,{className:"w-4 h-4"}),"Nascimentos",e.jsx(W,{variant:"secondary",className:"ml-1",children:C.length})]})]}),e.jsxs(we,{value:"resumo",className:"space-y-4",children:[S>0&&e.jsxs(Q,{className:"border-amber-200 bg-amber-50",children:[e.jsx(de,{className:"pb-2",children:e.jsxs(me,{className:"text-base flex items-center gap-2 text-amber-800",children:[e.jsx(Sa,{className:"w-4 h-4"}),"Serviços Pendentes"]})}),e.jsx(K,{children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:[c.passo2Pendente>0&&e.jsxs(_e,{to:"/protocolos",className:"flex items-center justify-between p-3 bg-white rounded-lg border hover:border-green-300 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(fa,{className:"w-4 h-4 text-slate-500"}),e.jsx("span",{className:"text-sm",children:"2º Passo"})]}),e.jsx(W,{children:c.passo2Pendente})]}),c.tePendente>0&&e.jsxs(_e,{to:"/transferencia",className:"flex items-center justify-between p-3 bg-white rounded-lg border hover:border-green-300 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(sa,{className:"w-4 h-4 text-slate-500"}),e.jsx("span",{className:"text-sm",children:"TE"})]}),e.jsx(W,{children:c.tePendente})]}),c.dgPendente>0&&e.jsxs(_e,{to:"/dg",className:"flex items-center justify-between p-3 bg-white rounded-lg border hover:border-green-300 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Le,{className:"w-4 h-4 text-slate-500"}),e.jsx("span",{className:"text-sm",children:"DG"})]}),e.jsx(W,{children:c.dgPendente})]}),c.sexagemPendente>0&&e.jsxs(_e,{to:"/sexagem",className:"flex items-center justify-between p-3 bg-white rounded-lg border hover:border-green-300 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Oe,{className:"w-4 h-4 text-slate-500"}),e.jsx("span",{className:"text-sm",children:"Sexagem"})]}),e.jsx(W,{children:c.sexagemPendente})]})]})})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs(Q,{children:[e.jsx(de,{className:"pb-2",children:e.jsxs(me,{className:"text-base flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(qe,{className:"w-4 h-4"}),"Receptoras"]}),e.jsx("span",{className:"text-2xl font-bold",children:M.total})]})}),e.jsx(K,{children:M.porStatus.length===0?e.jsx("p",{className:"text-sm text-slate-500",children:"Nenhuma receptora"}):e.jsxs("div",{className:"space-y-2",children:[M.porStatus.slice(0,5).map(i=>e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-slate-600",children:Ue(i.status)}),e.jsx(W,{variant:"outline",children:i.total})]},i.status)),c.prenhesProximoParto&&e.jsxs("div",{className:"pt-2 mt-2 border-t text-sm",children:[e.jsx("span",{className:"text-slate-500",children:"Próximo parto: "}),e.jsx("span",{className:"font-medium",children:N(c.prenhesProximoParto)})]})]})})]}),e.jsxs(Q,{children:[e.jsx(de,{className:"pb-2",children:e.jsxs(me,{className:"text-base flex items-center justify-between",children:[e.jsx("span",{children:"Doadoras"}),e.jsx("span",{className:"text-2xl font-bold",children:w.total})]})}),e.jsx(K,{children:w.total===0?e.jsx("p",{className:"text-sm text-slate-500",children:"Nenhuma doadora"}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{className:"p-2 bg-slate-50 rounded",children:[e.jsx("p",{className:"text-slate-500",children:"Aspirações (30d)"}),e.jsx("p",{className:"font-semibold",children:w.aspiracoes30d})]}),e.jsxs("div",{className:"p-2 bg-slate-50 rounded",children:[e.jsx("p",{className:"text-slate-500",children:"Oócitos (30d)"}),e.jsx("p",{className:"font-semibold",children:w.oocitos30d})]})]}),w.porRaca.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1",children:w.porRaca.slice(0,4).map(i=>e.jsxs(W,{variant:"secondary",className:"text-xs",children:[i.raca,": ",i.total]},i.raca))})]})})]})]})]}),e.jsx(we,{value:"receptoras",children:e.jsx(Ya,{fazendaId:t,fazendaNome:d.nome})}),e.jsx(we,{value:"doadoras",children:e.jsx(Wa,{fazendaId:t,fazendaNome:d.nome})}),e.jsx(we,{value:"animais",children:e.jsxs(Q,{children:[e.jsx(de,{children:e.jsx(me,{className:"text-base",children:"Animais Nascidos"})}),e.jsx(K,{children:C.length===0?e.jsx(Ee,{title:"Nenhum animal registrado",description:"Os nascimentos registrados aparecerão aqui."}):e.jsxs(De,{children:[e.jsx(Ce,{children:e.jsxs(ie,{children:[e.jsx(I,{children:"Data"}),e.jsx(I,{children:"Sexo"}),e.jsx(I,{children:"Raça"}),e.jsx(I,{children:"Receptora"}),e.jsx(I,{children:"Doadora x Touro"})]})}),e.jsx(Re,{children:C.map(i=>e.jsxs(ie,{children:[e.jsx(H,{children:N(i.data_nascimento)}),e.jsx(H,{children:e.jsx(W,{variant:i.sexo==="FEMEA"?"default":"secondary",children:i.sexo==="FEMEA"?"F":i.sexo==="MACHO"?"M":"?"})}),e.jsx(H,{children:i.raca||"-"}),e.jsx(H,{children:i.receptora_brinco||"-"}),e.jsxs(H,{className:"text-sm",children:[i.doadora||"?"," x ",i.touro||"?"]})]},i.id))})]})})]})})]})]}):e.jsx(Ee,{title:"Fazenda não encontrada",description:"Volte para a lista e selecione outra fazenda.",action:e.jsx(L,{onClick:()=>r("/fazendas"),variant:"outline",children:"Voltar"})})}export{Rs as default};
