import{a as k,r as i,s as m,j as e,h as q,B as p}from"./index-TMaXuGT-.js";import{C as V,a as $,b as H,d as M}from"./card-DMaHdbj2.js";import{I as _}from"./input-CS01soKQ.js";import{L as n}from"./label-CDZKlFri.js";import{T as G}from"./textarea-4z0ihLXQ.js";import{S as X,a as J,b as K,c as Q,d as U}from"./select-mKWZhFeY.js";import{P as W,a as Y,b as Z}from"./popover-C4Z9du6z.js";import{C as ee,a as ae,b as se,c as F,d as re,e as ie}from"./command-Bm-DLBdy.js";import{B as oe}from"./badge-CUxYsHH9.js";import{u as te}from"./use-toast-BfiUt0Jw.js";import{D as ne}from"./DatePickerBR-CA4qskvz.js";import{A as de}from"./arrow-left-BZEOW66l.js";import{S as ce}from"./search-FTckgCkA.js";import{X as le}from"./x-_4GU21wu.js";import"./index-CbBZSCMq.js";import"./index-CleRECL4.js";import"./check-BrBvYO5V.js";import"./dialog-9Ry6kCpW.js";import"./chevron-right-BwBsAfCk.js";import"./dateUtils-eJ5e6apA.js";function Ae(){const u=k(),{toast:d}=te(),[E,j]=i.useState(!0),[f,g]=i.useState(!1),[z,w]=i.useState([]),h=i.useRef(0),[A,b]=i.useState([]),[B,v]=i.useState(!1),[T,N]=i.useState(!1),[s,o]=i.useState({fazenda_id:"",fazendas_destino_ids:[],data_aspiracao:new Date().toISOString().split("T")[0],horario_inicio:"",veterinario_responsavel:"",tecnico_responsavel:"",observacoes:""}),[c,C]=i.useState(""),D=c.trim(),I=D.length>=2,x=A.filter(a=>!s.fazendas_destino_ids.includes(a.id));i.useEffect(()=>{P()},[]),i.useEffect(()=>{const a=D;if(!a){b([]),v(!1);return}const r=++h.current;v(!0),m.from("fazendas").select("id, nome").ilike("nome",`%${a}%`).order("nome",{ascending:!0}).limit(50).then(({data:t,error:l})=>{r===h.current&&b(t||[])}).finally(()=>{r===h.current&&v(!1)})},[c]);const P=async()=>{try{j(!0);const{data:a,error:r}=await m.from("fazendas").select("id, nome").order("nome",{ascending:!0});if(r)throw r;w(a||[])}catch(a){d({title:"Erro ao carregar fazendas",description:a instanceof Error?a.message:"Erro desconhecido",variant:"destructive"})}finally{j(!1)}};i.useEffect(()=>{},[c,x.length]);const R=async a=>{if(a.preventDefault(),!s.fazenda_id||s.fazendas_destino_ids.length===0||!s.data_aspiracao){d({title:"Erro de validação",description:"Fazenda, pelo menos uma fazenda destino e data são obrigatórios",variant:"destructive"});return}if(!s.veterinario_responsavel.trim()){d({title:"Erro de validação",description:"Veterinário responsável é obrigatório",variant:"destructive"});return}if(!s.tecnico_responsavel.trim()){d({title:"Erro de validação",description:"Técnico responsável é obrigatório",variant:"destructive"});return}try{g(!0);const r=s.fazendas_destino_ids[0],t={fazenda_id:s.fazenda_id,fazenda_destino_id:r,data_aspiracao:s.data_aspiracao,horario_inicio:s.horario_inicio||null,veterinario_responsavel:s.veterinario_responsavel.trim(),tecnico_responsavel:s.tecnico_responsavel.trim(),observacoes:s.observacoes.trim()||null,status:"EM_ANDAMENTO"},{data:l,error:S}=await m.from("pacotes_aspiracao").insert([t]).select().single();if(S)throw S;const L=s.fazendas_destino_ids.map(O=>({pacote_aspiracao_id:l.id,fazenda_destino_id:O})),{error:y}=await m.from("pacotes_aspiracao_fazendas_destino").insert(L);if(y)throw y;d({title:"Aspiração criada",description:"Aspiração criada com sucesso"}),u(`/aspiracoes/${l.id}`)}catch(r){d({title:"Erro ao criar aspiração",description:r instanceof Error?r.message:"Erro desconhecido",variant:"destructive"})}finally{g(!1)}};return E?e.jsx(q,{}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(p,{onClick:()=>u("/aspiracoes"),variant:"outline",size:"icon",children:e.jsx(de,{className:"w-4 h-4"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Nova Aspiração"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Criar nova aspiração"})]})]}),e.jsxs(V,{children:[e.jsx($,{children:e.jsx(H,{children:"Informações da Aspiração"})}),e.jsx(M,{children:e.jsxs("form",{onSubmit:R,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"fazenda_id",children:"Fazenda da Aspiração *"}),e.jsxs(X,{value:s.fazenda_id,onValueChange:a=>o({...s,fazenda_id:a}),children:[e.jsx(J,{children:e.jsx(K,{placeholder:"Selecione a fazenda"})}),e.jsx(Q,{children:z.map(a=>e.jsx(U,{value:a.id,children:a.nome},a.id))})]})]}),e.jsxs("div",{className:"space-y-2 col-span-2",children:[e.jsx(n,{children:"Fazendas Destino *"}),e.jsx("div",{className:"space-y-2",children:e.jsxs(W,{open:T,onOpenChange:a=>{N(a)},children:[e.jsx(Y,{asChild:!0,children:e.jsxs(p,{variant:"outline",className:"w-full justify-between",children:[c.trim()===""?"Buscar/selecionar fazenda destino":`Busca: ${c}`,e.jsx(ce,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(Z,{className:"w-[400px] p-0",align:"start",children:e.jsxs(ee,{shouldFilter:!1,children:[e.jsx(ae,{placeholder:"Buscar fazenda destino...",value:c,onValueChange:C}),e.jsx(se,{children:I?B?e.jsx("div",{className:"p-2 text-sm text-muted-foreground",children:"Buscando..."}):x.length===0?e.jsx(F,{children:"Nenhuma fazenda encontrada"}):e.jsx(re,{children:x.map(a=>e.jsx(ie,{value:`${a.nome} ${a.id}`,onSelect:()=>{s.fazendas_destino_ids.includes(a.id)||o({...s,fazendas_destino_ids:[...s.fazendas_destino_ids,a.id]}),C(""),N(!1)},children:a.nome},a.id))}):e.jsx(F,{children:"Digite pelo menos 2 letras para buscar"})})]})})]})}),s.fazendas_destino_ids.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:s.fazendas_destino_ids.map(a=>{const r=z.find(t=>t.id===a);return r?e.jsxs(oe,{variant:"outline",className:"flex items-center gap-1 pr-1",children:[r.nome,e.jsx("button",{type:"button",onClick:t=>{t.preventDefault(),o({...s,fazendas_destino_ids:s.fazendas_destino_ids.filter(l=>l!==a)})},className:"ml-1 hover:bg-muted rounded-full p-0.5",children:e.jsx(le,{className:"w-3 h-3"})})]},a):null})}),s.fazendas_destino_ids.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Selecione pelo menos uma fazenda destino"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"data_aspiracao",children:"Data da Aspiração *"}),e.jsx(ne,{id:"data_aspiracao",value:s.data_aspiracao,onChange:a=>o({...s,data_aspiracao:a||""}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"horario_inicio",children:"Horário de Início"}),e.jsx(_,{id:"horario_inicio",type:"time",value:s.horario_inicio,onChange:a=>o({...s,horario_inicio:a.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"veterinario_responsavel",children:"Veterinário Responsável *"}),e.jsx(_,{id:"veterinario_responsavel",value:s.veterinario_responsavel,onChange:a=>o({...s,veterinario_responsavel:a.target.value}),placeholder:"Nome do veterinário",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"tecnico_responsavel",children:"Técnico Responsável *"}),e.jsx(_,{id:"tecnico_responsavel",value:s.tecnico_responsavel,onChange:a=>o({...s,tecnico_responsavel:a.target.value}),placeholder:"Nome do técnico",required:!0})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"observacoes",children:"Observações"}),e.jsx(G,{id:"observacoes",value:s.observacoes,onChange:a=>o({...s,observacoes:a.target.value}),placeholder:"Observações sobre a aspiração",rows:3})]}),e.jsxs("div",{className:"flex gap-4 pt-4",children:[e.jsx(p,{type:"submit",className:"flex-1",disabled:f,children:f?"Criando...":"Criar Aspiração"}),e.jsx(p,{type:"button",variant:"outline",onClick:()=>u("/aspiracoes"),disabled:f,children:"Cancelar"})]})]})})]})]})}export{Ae as default};
