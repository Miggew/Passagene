import{r as u,s as l,j as a,a as Oa,A as La,B as U,g as Ae,n as qa}from"./index-DmNymSE5.js";import{b as Fa}from"./dataEnrichment-DYYKz9BM.js";import{C as Ba,a as Va,b as Ga,d as ka}from"./card-SrkIpKk5.js";import{S as Te,a as Me,b as Pe,c as Oe,d as he}from"./select-yD1hylSL.js";import{I as Xe}from"./input-CUsCheD8.js";import{L as F}from"./label-u6KawL_e.js";import{T as $a}from"./textarea-BuM8ilf-.js";import{P as Za}from"./PageHeader-C6hPTib0.js";import{u as Qa}from"./use-toast-8Wh80yTN.js";import{v as Ha}from"./receptoraStatus-DOv_raBa.js";import{B as ve}from"./badge-BB9l9AxT.js";import{S as fa}from"./StatusBadge-UrqKsWCC.js";import{C as Ua,Q as Ja}from"./QualidadeSemaforo-DOiVLgyG.js";import{S as Ka}from"./switch-r5SGr40k.js";import{D as ua}from"./DatePickerBR-DL95UOFW.js";import{T as Le,a as qe,b as ce,c as j,d as Fe,e as b}from"./table-BEqiB4gi.js";import{D as Wa,b as Xa,c as Ya,d as et,e as at,f as tt}from"./dialog-j4QKUGZf.js";import{F as Ye}from"./file-text-ZSN0C1g0.js";import{T as rt}from"./trash-2-DPVvnTdd.js";import{P as ot}from"./package-Be7lPzXE.js";import{T as it}from"./triangle-alert-LWvbwqzk.js";import"./index-BoubMqWY.js";import"./index-C79PyqkA.js";import"./index-BMCBZPUE.js";import"./index-BMurdLVa.js";import"./check-D6LfuFSM.js";import"./statusLabels-IklKT8dE.js";import"./popover-BabFSUJ1.js";import"./x-BKw_NAIH.js";import"./calendar-u0e6cTgk.js";function Ot(){var ma;const[ea,De]=u.useState([]),[Be,aa]=u.useState([]),[Ve,Ge]=u.useState([]),[ta,ra]=u.useState([]),[re,le]=u.useState([]),[ke,oa]=u.useState(!1),[ge,oe]=u.useState([]),[ha,xe]=u.useState(!0),[ie,_e]=u.useState(!1),[Ce,pe]=u.useState([]),[I,me]=u.useState([]),[va,je]=u.useState(!1),[ia,sa]=u.useState([]),[ga,Se]=u.useState(!1),[P,ae]=u.useState(1),[S,$e]=u.useState("PACOTE"),[J,Ze]=u.useState(""),[te,Qe]=u.useState(""),[ee,He]=u.useState(""),[be,na]=u.useState(!1),[we,Re]=u.useState({}),[ca,Ie]=u.useState({}),{toast:g}=Qa(),xa=!0,T=20,[t,y]=u.useState({fazenda_id:"",pacote_id:"",protocolo_id:"",receptora_id:"",protocolo_receptora_id:"",embriao_id:"",data_te:new Date().toISOString().split("T")[0],veterinario_responsavel:"",tecnico_responsavel:"",observacoes:""}),[Ue,se]=u.useState({data_te:"",veterinario_responsavel:"",tecnico_responsavel:""}),ja=()=>{const e={fazenda_id:t.fazenda_id,pacote_id:t.pacote_id,data_passo2:ee,data_te:t.data_te,veterinario_responsavel:t.veterinario_responsavel,tecnico_responsavel:t.tecnico_responsavel,origem_embriao:S,filtro_cliente_id:J,filtro_raca:te,incluir_cio_livre:be,transferenciasSessao:Ce,transferenciasIdsSessao:I};ba(e)},ba=async e=>{var o,_;if(!e.fazenda_id||!((((o=e.transferenciasIdsSessao)==null?void 0:o.length)||0)>0||(((_=e.transferenciasSessao)==null?void 0:_.length)||0)>0))return;let s=null;if(e.pacote_id){const m=e.pacote_id.substring(0,36);/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(m)&&(s=m)}const n={fazenda_id:e.fazenda_id,pacote_id:s,data_passo2:e.data_passo2||null,data_te:e.data_te||null,veterinario_responsavel:e.veterinario_responsavel||null,tecnico_responsavel:e.tecnico_responsavel||null,origem_embriao:e.origem_embriao||null,filtro_cliente_id:e.filtro_cliente_id||null,filtro_raca:e.filtro_raca||null,incluir_cio_livre:!!e.incluir_cio_livre,transferencias_ids:e.transferenciasIdsSessao||[],protocolo_receptora_ids:e.transferenciasSessao||[],status:"ABERTA",updated_at:new Date().toISOString()},{error:d}=await l.from("transferencias_sessoes").upsert(n,{onConflict:"fazenda_id,status"})},wa=async e=>{if(!e)return;const{error:i}=await l.from("transferencias_sessoes").update({status:"ENCERRADA",updated_at:new Date().toISOString()}).eq("fazenda_id",e).eq("status","ABERTA")},da=e=>{const i=Array.isArray(e==null?void 0:e.transferencias_ids)?e.transferencias_ids:[],s=Array.isArray(e==null?void 0:e.protocolo_receptora_ids)?e.protocolo_receptora_ids:[],n=(e==null?void 0:e.origem_embriao)==="CONGELADO"?"CONGELADO":"PACOTE",d=(e==null?void 0:e.data_te)||new Date().toISOString().split("T")[0];me(i),pe(s),$e(n),Ze((e==null?void 0:e.filtro_cliente_id)||""),Qe((e==null?void 0:e.filtro_raca)||""),He((e==null?void 0:e.data_passo2)||new Date().toISOString().split("T")[0]),na(!!(e!=null&&e.incluir_cio_livre)),se({data_te:d,veterinario_responsavel:(e==null?void 0:e.veterinario_responsavel)||"",tecnico_responsavel:(e==null?void 0:e.tecnico_responsavel)||""}),y(o=>({...o,fazenda_id:(e==null?void 0:e.fazenda_id)||"",pacote_id:(e==null?void 0:e.pacote_id)||"",protocolo_id:(e==null?void 0:e.protocolo_id)||"",embriao_id:"",receptora_id:"",protocolo_receptora_id:"",data_te:d,veterinario_responsavel:(e==null?void 0:e.veterinario_responsavel)||"",tecnico_responsavel:(e==null?void 0:e.tecnico_responsavel)||"",observacoes:""}))},Ea=async()=>{try{const{data:e,error:i}=await l.from("transferencias_sessoes").select("*").eq("status","ABERTA").order("updated_at",{ascending:!1}).limit(1);if(e&&e.length>0){const s=e[0],n=Array.isArray(s==null?void 0:s.transferencias_ids)?s.transferencias_ids:[];let d=Array.isArray(s==null?void 0:s.protocolo_receptora_ids)?s.protocolo_receptora_ids:[];if(d.length===0&&n.length>0){const{data:_,error:m}=await l.from("transferencias_embrioes").select("protocolo_receptora_id").in("id",n);!m&&_&&(d=[...new Set(_.map(c=>c.protocolo_receptora_id).filter(c=>!!c))])}let o=!1;if(d.length>0){const{data:_,error:m}=await l.from("protocolo_receptoras").select("id, status").in("id",d);!m&&_&&(o=_.some(c=>c.status!=="UTILIZADA"))}return o?(da(s),!0):(await l.from("transferencias_sessoes").update({status:"ENCERRADA",updated_at:new Date().toISOString()}).eq("id",s.id),!1)}return!1}catch{return!1}};u.useEffect(()=>{(async()=>{await Promise.all([la(),ye(),Na()]),await Ea()})()},[]),u.useEffect(()=>{(t.fazenda_id||t.pacote_id||I.length>0)&&ja()},[t.fazenda_id,t.pacote_id,t.protocolo_id,t.data_te,t.veterinario_responsavel,t.tecnico_responsavel,S,J,te,ee,be,Ce.length,I.length,P]),u.useEffect(()=>{la()},[ee]),u.useEffect(()=>{if(t.fazenda_id){const e=Ve.filter(i=>i.fazendas_destino_ids.includes(t.fazenda_id));ra(e)}else ra([])},[t.fazenda_id,Ve]),u.useEffect(()=>{t.fazenda_id&&Ke(t.fazenda_id)},[t.fazenda_id,ee,be]),u.useEffect(()=>{(async()=>{if(I.length===0){Re({}),Ie({});return}const{data:i,error:s}=await l.from("transferencias_embrioes").select("id, receptora_id, protocolo_receptora_id, receptoras(id, identificacao, status_reprodutivo)").in("id",I);if(s)return;const n={},d={};(i||[]).forEach(o=>{if(!o.receptora_id)return;n[o.receptora_id]=(n[o.receptora_id]||0)+1;const _=Array.isArray(o.receptoras)?o.receptoras[0]:o.receptoras;d[o.receptora_id]={receptora_id:o.receptora_id,brinco:(_==null?void 0:_.identificacao)||"N/A",identificacao:(_==null?void 0:_.identificacao)||"",protocolo_id:void 0,protocolo_receptora_id:o.protocolo_receptora_id||"",quantidade_embrioes:n[o.receptora_id],origem:o.protocolo_receptora_id?"PROTOCOLO":"CIO_LIVRE",status_reprodutivo:(_==null?void 0:_.status_reprodutivo)||"SERVIDA"}}),Re(n),Ie(d)})()},[I]);const Na=async()=>{try{const{data:e,error:i}=await l.from("clientes").select("id, nome").order("nome",{ascending:!0});if(i)throw i;aa(e||[])}catch{aa([])}},la=async()=>{try{let e=l.from("protocolos_sincronizacao").select("id");ee&&(e=e.eq("passo2_data",ee));const{data:i,error:s}=await e;if(s)throw s;const n=[...new Set((i||[]).map(w=>w.id).filter(Boolean))];if(n.length===0){De([]),xe(!1);return}const{data:d,error:o}=await l.from("v_protocolo_receptoras_status").select("receptora_id").eq("fase_ciclo","SINCRONIZADA").in("protocolo_id",n);if(o)throw o;const _=[...new Set((d||[]).map(w=>w.receptora_id).filter(Boolean))];if(_.length===0){De([]),xe(!1);return}const{data:m,error:c}=await l.from("vw_receptoras_fazenda_atual").select("fazenda_id_atual").in("receptora_id",_);if(c)throw c;const h=[...new Set((m||[]).map(w=>w.fazenda_id_atual).filter(Boolean))];if(h.length===0){De([]),xe(!1);return}const{data:D,error:E}=await l.from("fazendas").select("id, nome").in("id",h).order("nome",{ascending:!0});if(E)throw E;De(D||[]),xe(!1)}catch(e){g({title:"Erro ao carregar fazendas",description:e instanceof Error?e.message:"Erro desconhecido",variant:"destructive"}),xe(!1)}},ye=async()=>{var e;try{const i=qa(),s=new Date().toISOString().slice(0,10);if(i===s){const{error:r}=await l.rpc("descartar_embrioes_d9")}const[d,o]=await Promise.all([l.from("transferencias_embrioes").select("embriao_id"),l.from("embrioes").select("*").eq("status_atual","FRESCO").order("created_at",{ascending:!1})]),_=((e=d.data)==null?void 0:e.map(r=>r.embriao_id))||[];if(o.error)throw o.error;const m=[...o.data||[]].filter(r=>!_.includes(r.id)&&r.status_atual!=="TRANSFERIDO").sort((r,v)=>{const z=new Date(r.created_at||0).getTime();return new Date(v.created_at||0).getTime()-z});if(!m||m.length===0){Ge([]);return}const c=m.map(r=>r.id),h=[...new Set(m.filter(r=>r.lote_fiv_id).map(r=>r.lote_fiv_id))];let D=new Map,E=new Map,w=new Map,O=new Map;const[$,L,Z]=await Promise.all([c.length>0?l.from("v_embrioes_disponiveis_te").select("embriao_id, d7_pronto, d8_limite").in("embriao_id",c):Promise.resolve({data:null,error:null}),l.from("fazendas").select("id, nome"),h.length>0?l.from("lotes_fiv").select("id, pacote_aspiracao_id").in("id",h):Promise.resolve({data:null,error:null})]),R=new Map(($.data||[]).map(r=>[r.embriao_id,{d7_pronto:r.d7_pronto,d8_limite:r.d8_limite}]));L.data&&(O=new Map(L.data.map(r=>[r.id,r.nome])));const q=Z.data;if(q&&q.length>0){q.forEach(v=>{v.pacote_aspiracao_id&&E.set(v.id,v.pacote_aspiracao_id)});const r=[...new Set(q.map(v=>v.pacote_aspiracao_id).filter(Boolean))];if(r.length>0){const[v,z]=await Promise.all([l.from("pacotes_aspiracao").select("*").in("id",r),l.from("pacotes_aspiracao_fazendas_destino").select("pacote_aspiracao_id, fazenda_destino_id").in("pacote_aspiracao_id",r)]),G=z.data;G&&G.forEach(A=>{const Q=w.get(A.pacote_aspiracao_id)||[];Q.includes(A.fazenda_destino_id)||Q.push(A.fazenda_destino_id),w.set(A.pacote_aspiracao_id,Q)});const Y=v.data;Y&&Y.forEach(A=>{if(A.fazenda_destino_id){const Q=w.get(A.id)||[];Q.includes(A.fazenda_destino_id)||Q.push(A.fazenda_destino_id),w.set(A.id,Q)}D.set(A.id,{id:A.id,data_aspiracao:A.data_aspiracao,fazenda_nome:O.get(A.fazenda_id),quantidade_doadoras:0,horario_inicio:A.horario_inicio,veterinario_responsavel:A.veterinario_responsavel,total_oocitos:A.total_oocitos})})}}const fe=m.map(r=>r.lote_fiv_acasalamento_id).filter(r=>!!r);let X=new Map,ne=new Map,ue=new Map;if(fe.length>0){const{data:r}=await l.from("lote_fiv_acasalamentos").select("id, aspiracao_doadora_id, dose_semen_id").in("id",fe);if(r){X=new Map(r.map(C=>[C.id,C]));const v=[...new Set(r.map(C=>C.aspiracao_doadora_id).filter(Boolean))],z=[...new Set(r.map(C=>C.dose_semen_id).filter(Boolean))],[G,Y]=await Promise.all([v.length>0?l.from("aspiracoes_doadoras").select("id, doadora_id").in("id",v):Promise.resolve({data:null}),z.length>0?l.from("doses_semen").select("id, touro_id, touro:touros(id, nome, registro, raca)").in("id",z):Promise.resolve({data:null})]),A=G.data,Q=Y.data;if(Q&&(ue=new Map(Q.map(C=>{const B=C.touro,k=Array.isArray(B)?B[0]:B;return[C.id,(k==null?void 0:k.nome)||"Touro desconhecido"]})),r.forEach(C=>{if(C.dose_semen_id){const B=ue.get(C.dose_semen_id);if(B){const k=X.get(C.id);X.set(C.id,{...k,touro_nome:B})}}})),A){const C=[...new Set(A.map(B=>B.doadora_id))];if(C.length>0){const{data:B}=await l.from("doadoras").select("id, registro").in("id",C);if(B){ne=new Map(B.map(H=>[H.id,H.registro]));const k=new Map(A.map(H=>[H.id,H.doadora_id]));r.forEach(H=>{if(H.aspiracao_doadora_id){const Ee=k.get(H.aspiracao_doadora_id);if(Ee){const ze=ne.get(Ee);if(ze){const Ne=X.get(H.id);X.set(H.id,{...Ne,doadora_registro:ze})}}}})}}}}}const f=new Map;m.forEach(r=>{var C,B;if(!r.lote_fiv_id||!r.created_at)return;const v=r.created_at.split("T")[0],z=`${r.lote_fiv_id}-${v}`;let G=f.get(z);if(!G){const k=E.get(r.lote_fiv_id),H=k?D.get(k):void 0,Ee=k?w.get(k)||[]:[],ze=Ee.map(Ne=>O.get(Ne)).filter(Ne=>!!Ne);G={id:z,lote_fiv_id:r.lote_fiv_id,data_despacho:v,fazendas_destino_ids:Ee,fazendas_destino_nomes:ze,pacote_info:H||{id:k||"",data_aspiracao:v,quantidade_doadoras:0},embrioes:[],total:0,frescos:0,congelados:0},f.set(z,G)}const Y=X.get(r.lote_fiv_acasalamento_id||""),A=Y==null?void 0:Y.doadora_registro,Q=Y==null?void 0:Y.touro_nome;G.embrioes.push({...r,doadora_registro:A,touro_nome:Q,d7_pronto:(C=R.get(r.id))==null?void 0:C.d7_pronto,d8_limite:(B=R.get(r.id))==null?void 0:B.d8_limite}),G.total++,r.status_atual==="FRESCO"&&G.frescos++,r.status_atual==="CONGELADO"&&G.congelados++});const x=[...new Set(Array.from(f.values()).map(r=>r.lote_fiv_id))],{data:M}=await l.from("lotes_fiv").select("id, disponivel_para_transferencia").in("id",x),V=new Map((M==null?void 0:M.map(r=>[r.id,r.disponivel_para_transferencia===!0]))||[]),N=Array.from(f.values()).map(r=>{const v=r.embrioes.filter(z=>!z.classificacao||z.classificacao.trim()==="").length;return{pacote:r,semClassificacao:v,total:r.total,disponivel:V.get(r.lote_fiv_id)}}).filter(r=>r.disponivel!==!1&&r.total>0&&r.semClassificacao===0).map(r=>r.pacote).sort((r,v)=>v.data_despacho.localeCompare(r.data_despacho));Ge(N)}catch(i){g({title:"Erro ao carregar pacotes de embriões",description:i instanceof Error?i.message:"Erro desconhecido",variant:"destructive"}),Ge([])}},Je=async()=>{const e=te.trim().toLowerCase();if(!J&&!e){le([]);return}try{oa(!0);let i=l.from("embrioes").select("*").eq("status_atual","CONGELADO").not("cliente_id","is",null);J&&(i=i.eq("cliente_id",J));const[s,n]=await Promise.all([l.from("transferencias_embrioes").select("embriao_id"),i.order("created_at",{ascending:!1})]);if(s.error)throw s.error;if(n.error)throw n.error;const d=s.data,o=n.data,_=(d==null?void 0:d.map(f=>f.embriao_id))||[],m=(o||[]).filter(f=>!_.includes(f.id)&&f.status_atual!=="TRANSFERIDO");if(m.length===0){le([]);return}const c=m.map(f=>f.lote_fiv_acasalamento_id).filter(f=>!!f),h=m.map(f=>f.acasalamento_media_id).filter(f=>!!f);let D=[...new Set(c)];const E=new Set;if(h.length>0){const{data:f,error:x}=await l.from("acasalamento_embrioes_media").select("id, lote_fiv_acasalamento_id").in("id",h);if(x)throw x;(f||[]).forEach(M=>{M.lote_fiv_acasalamento_id&&E.add(M.lote_fiv_acasalamento_id)})}D.length===0&&E.size>0&&(D=[...E]);let w=[],O=[],$=[],L=[];if(D.length>0){const{data:f,error:x}=await l.from("lote_fiv_acasalamentos").select("id, aspiracao_doadora_id, dose_semen_id").in("id",D);if(x)throw x;if(w=f||[],w.length===0&&E.size>0){const r=[...E],{data:v,error:z}=await l.from("lote_fiv_acasalamentos").select("id, aspiracao_doadora_id, dose_semen_id").in("id",r);!z&&v&&v.length>0&&(w=v)}const M=[...new Set(w.map(r=>r.aspiracao_doadora_id).filter(Boolean))],V=[...new Set(w.map(r=>r.dose_semen_id).filter(Boolean))],[p,N]=await Promise.all([M.length>0?l.from("aspiracoes_doadoras").select("id, doadora_id").in("id",M):Promise.resolve({data:null,error:null}),V.length>0?l.from("doses_semen").select("id, touro:touros(id, nome, registro, raca)").in("id",V):Promise.resolve({data:null,error:null})]);if(p.error)throw p.error;if(N.error)throw N.error;if(O=p.data||[],L=N.data||[],O.length>0){const r=[...new Set(O.map(v=>v.doadora_id).filter(Boolean))];if(r.length>0){const{data:v,error:z}=await l.from("doadoras").select("id, registro, raca").in("id",r);if(z)throw z;$=v||[]}}}if(w.length===0){const f=[...new Set(m.map(x=>x.lote_fiv_id).filter(Boolean))];if(f.length>0){const{data:x}=await l.from("lote_fiv_acasalamentos").select("id, lote_fiv_id").in("lote_fiv_id",f)}}const Z=new Map(w.map(f=>[f.id,f])),R=new Map(O.map(f=>[f.id,f])),q=new Map($.map(f=>[f.id,f])),fe=new Map(L.map(f=>[f.id,f])),X=new Map(Be.map(f=>[f.id,f.nome])),ne=m.map(f=>{const x=f.lote_fiv_acasalamento_id?Z.get(f.lote_fiv_acasalamento_id):void 0,M=x?R.get(x.aspiracao_doadora_id):void 0,V=M?q.get(M.doadora_id):void 0,p=x?fe.get(x.dose_semen_id):void 0,N=(p==null?void 0:p.touro)??null,r=Array.isArray(N)?N[0]:N,v=f.cliente_id?X.get(f.cliente_id):void 0;return{...f,doadora_registro:V==null?void 0:V.registro,doadora_raca:V==null?void 0:V.raca,touro_nome:(r==null?void 0:r.nome)||"Touro desconhecido",touro_raca:r==null?void 0:r.raca,cliente_nome:v}}),ue=e?ne.filter(f=>{const x=(f.doadora_raca||"").toLowerCase(),M=(f.touro_raca||"").toLowerCase();return x.includes(e)||M.includes(e)}):ne;le(ue)}catch{le([])}finally{oa(!1)}};u.useEffect(()=>{if(S!=="CONGELADO"){le([]);return}Je()},[S,J,te,Be.length]);const Aa=async e=>{try{const{data:i,error:s}=await l.from("receptoras_cio_livre").select("receptora_id, data_cio").eq("fazenda_id",e).eq("ativa",!0);if(s&&s.code!=="PGRST205")throw s;const n=(i||[]).map(c=>c.receptora_id).filter(c=>!!c);if(n.length===0)return oe([]),{receptorasDisponiveis:0};const{data:d,error:o}=await l.from("receptoras").select("id, identificacao, status_reprodutivo").in("id",n);if(o)throw o;const _=new Map((i||[]).map(c=>[c.receptora_id,c.data_cio])),m=(d||[]).map(c=>({receptora_id:c.id,brinco:c.identificacao||"N/A",identificacao:c.identificacao||"",protocolo_id:void 0,protocolo_receptora_id:void 0,data_te_prevista:void 0,data_limite_te:void 0,quantidade_embrioes:0,ciclando_classificacao:void 0,qualidade_semaforo:void 0,origem:"CIO_LIVRE",data_cio:_.get(c.id),status_reprodutivo:c.status_reprodutivo}));return{receptoras:m,receptorasDisponiveis:m.length}}catch(i){return g({title:"Erro ao carregar receptoras",description:i instanceof Error?i.message:"Erro desconhecido",variant:"destructive"}),oe([]),{receptoras:[],receptorasDisponiveis:0}}},Ke=async(e,i)=>{const s=(i==null?void 0:i.contagem)??we,n=(i==null?void 0:i.info)??ca;try{let d=l.from("protocolos_sincronizacao").select("id");ee&&(d=d.eq("passo2_data",ee));const{data:o,error:_}=await d;if(_)throw _;const m=[...new Set((o||[]).map(p=>p.id).filter(Boolean))];if(m.length===0)return oe([]),{receptorasDisponiveis:0};const{data:c,error:h}=await l.from("v_protocolo_receptoras_status").select("receptora_id, brinco, data_te_prevista, data_limite_te, protocolo_id").eq("fase_ciclo","SINCRONIZADA").in("protocolo_id",m);if(h&&h.code!=="PGRST205")throw h;const D=c||[],E=[...new Set(D.map(p=>p.receptora_id).filter(Boolean))];if(E.length===0)return oe([]),{receptorasDisponiveis:0};const{data:w,error:O}=await l.from("vw_receptoras_fazenda_atual").select("receptora_id").in("receptora_id",E).eq("fazenda_id_atual",e);if(O)throw O;const $=new Set((w||[]).map(p=>p.receptora_id).filter(Boolean)),L=D.filter(p=>$.has(p.receptora_id)),Z=[...new Set(L.map(p=>p.receptora_id).filter(Boolean))];if(Z.length===0)return oe([]),{receptorasDisponiveis:0};const{data:R,error:q}=await l.from("receptoras").select("id, identificacao, status_reprodutivo").in("id",Z);if(q)throw q;const fe=new Map((R||[]).map(p=>[p.id,p])),X=[...new Set(L.map(p=>p.protocolo_id).filter(Boolean))];let ne=[];if(X.length>0){const{data:p,error:N}=await l.from("protocolo_receptoras").select("id, receptora_id, protocolo_id, status, ciclando_classificacao, qualidade_semaforo").in("protocolo_id",X).neq("status","INAPTA").neq("status","UTILIZADA");if(N&&N.code!=="PGRST205")throw N;ne=p||[]}const ue=new Map(ne.map(p=>[p.receptora_id,p]));let x=L.map(p=>{const N=fe.get(p.receptora_id),r=ue.get(p.receptora_id),v=s[p.receptora_id]||0;return{receptora_id:p.receptora_id,brinco:p.brinco||(N==null?void 0:N.identificacao)||"N/A",identificacao:(N==null?void 0:N.identificacao)||"",protocolo_id:(r==null?void 0:r.protocolo_id)||p.protocolo_id,protocolo_receptora_id:(r==null?void 0:r.id)||"",data_te_prevista:p.data_te_prevista,data_limite_te:p.data_limite_te,quantidade_embrioes:v,ciclando_classificacao:(r==null?void 0:r.ciclando_classificacao)??null,qualidade_semaforo:(r==null?void 0:r.qualidade_semaforo)??null,origem:"PROTOCOLO",status_reprodutivo:N==null?void 0:N.status_reprodutivo}}).filter(p=>p.status_reprodutivo==="SINCRONIZADA"||s[p.receptora_id]>0);if(be){const{receptoras:p}=await Aa(e);x=[...x,...p]}const M=Object.values(n).filter(p=>(s[p.receptora_id]||0)>=1),V=new Set(x.map(p=>p.receptora_id));return M.forEach(p=>{V.has(p.receptora_id)||x.push({...p,quantidade_embrioes:s[p.receptora_id]||0})}),x=x.map(p=>({...p,quantidade_embrioes:s[p.receptora_id]||0})),oe(x),{receptorasDisponiveis:x.length}}catch(d){return g({title:"Erro ao carregar receptoras",description:d instanceof Error?d.message:"Erro desconhecido",variant:"destructive"}),oe([]),{receptorasDisponiveis:0}}},We=async(e,i)=>{await Ke(e,i)},Da=async e=>{if(performance.now(),!e){y({...t,fazenda_id:"",pacote_id:"",protocolo_id:"",embriao_id:"",receptora_id:"",protocolo_receptora_id:""}),se({data_te:"",veterinario_responsavel:"",tecnico_responsavel:""}),pe([]),me([]),oe([]);return}const i=await Ca(e);i||(pe([]),me([]),se({data_te:"",veterinario_responsavel:"",tecnico_responsavel:""})),await Ke(e),y({...t,fazenda_id:e,pacote_id:i?t.pacote_id:"",protocolo_id:i?t.protocolo_id:"",embriao_id:"",receptora_id:"",protocolo_receptora_id:""})},Ca=async e=>{try{const{data:i,error:s}=await l.from("transferencias_sessoes").select("*").eq("fazenda_id",e).eq("status","ABERTA").order("updated_at",{ascending:!1}).limit(1);if(i&&i.length>0){const n=i[0],d=Array.isArray(n==null?void 0:n.transferencias_ids)?n.transferencias_ids:[];let o=Array.isArray(n==null?void 0:n.protocolo_receptora_ids)?n.protocolo_receptora_ids:[];if(o.length===0&&d.length>0){const{data:m,error:c}=await l.from("transferencias_embrioes").select("protocolo_receptora_id").in("id",d);!c&&m&&(o=[...new Set(m.map(h=>h.protocolo_receptora_id).filter(h=>!!h))])}let _=!1;if(o.length>0){const{data:m,error:c}=await l.from("protocolo_receptoras").select("id, status").in("id",o);!c&&m&&(_=m.some(h=>h.status!=="UTILIZADA"))}return _?(da(n),!0):(await l.from("transferencias_sessoes").update({status:"ENCERRADA",updated_at:new Date().toISOString()}).eq("id",n.id),!1)}return!1}catch{return!1}},Sa=e=>{e!==t.pacote_id&&(pe([]),me([])),y({...t,pacote_id:e,embriao_id:"",receptora_id:"",protocolo_receptora_id:"",data_te:Ue.data_te||t.data_te,veterinario_responsavel:Ue.veterinario_responsavel||t.veterinario_responsavel,tecnico_responsavel:Ue.tecnico_responsavel||t.tecnico_responsavel})},Ra=e=>{$e(e),ae(1),y({...t,pacote_id:e==="PACOTE"?t.pacote_id:"",embriao_id:"",receptora_id:"",protocolo_receptora_id:""})},Ia=async()=>{if(!t.receptora_id){g({title:"Erro",description:"Nenhuma receptora selecionada para descartar",variant:"destructive"});return}const e=ge.find(d=>d.receptora_id===t.receptora_id),i=(e==null?void 0:e.brinco)||"Receptora",s=e==null?void 0:e.origem,n=s==="CIO_LIVRE"?`Tem certeza que deseja descartar a receptora ${i}? Ela não receberá embrião e sairá da lista de cio livre.`:`Tem certeza que deseja descartar a receptora ${i}? Ela não receberá embrião e não poderá ser selecionada novamente neste protocolo.`;if(confirm(n))try{if(_e(!0),s==="CIO_LIVRE"||!t.protocolo_receptora_id){const{error:d}=await l.from("receptoras_cio_livre").update({ativa:!1}).eq("receptora_id",t.receptora_id).eq("ativa",!0);if(d)throw d;const{error:o}=await l.from("receptoras").update({status_cio_livre:"REJEITADA",is_cio_livre:!1}).eq("id",t.receptora_id);if(o)throw o}else{const{error:d}=await l.from("protocolo_receptoras").update({status:"INAPTA",motivo_inapta:"Descartada no menu de TE - não recebeu embrião"}).eq("id",t.protocolo_receptora_id);if(d)throw d}if(t.receptora_id){const{error:d}=await l.from("receptoras").update({status_reprodutivo:"VAZIA"}).eq("id",t.receptora_id)}g({title:"Receptora descartada",description:s==="CIO_LIVRE"?`${i} foi descartada e saiu da lista de cio livre.`:`${i} foi descartada e não receberá embrião neste protocolo.`}),y({...t,receptora_id:"",protocolo_receptora_id:""}),t.fazenda_id&&await We(t.fazenda_id)}catch(d){g({title:"Erro ao descartar receptora",description:d instanceof Error?d.message:"Erro desconhecido",variant:"destructive"})}finally{_e(!1)}},ya=async e=>{var o,_,m,c;e.preventDefault();const i=S==="PACOTE";if(!t.embriao_id){g({title:"Embrião não selecionado",description:"Por favor, selecione um embrião para realizar a transferência.",variant:"destructive"});return}if(!t.fazenda_id||!t.receptora_id||!t.data_te||i&&!t.pacote_id){g({title:"Erro de validação",description:"Todos os campos obrigatórios devem ser preenchidos",variant:"destructive"});return}const s=ge.find(h=>h.receptora_id===t.receptora_id);if(!s){g({title:"Receptora não disponível",description:"A receptora selecionada não está disponível para transferência.",variant:"destructive"});return}const n=we[t.receptora_id]||0,d=n===1;if(n>=2){g({title:"Limite atingido",description:"Esta receptora já recebeu o máximo de 2 embriões permitidos.",variant:"destructive"});return}if(t.receptora_id&&!d){const h=s.status_reprodutivo||"VAZIA",D=s.origem==="CIO_LIVRE"?"SINCRONIZADA":h,E=Ha(D,"REALIZAR_TE");if(!E.valido){g({title:"Erro de validação",description:E.mensagem||"A receptora não pode receber embrião no estado atual",variant:"destructive"});return}}try{if(_e(!0),!t.embriao_id){g({title:"Erro de validação",description:"Embrião não selecionado",variant:"destructive"});return}if(!t.receptora_id){g({title:"Erro de validação",description:"Receptora não selecionada",variant:"destructive"});return}if(!t.data_te){g({title:"Erro de validação",description:"Data da TE não informada",variant:"destructive"});return}if(!t.veterinario_responsavel||t.veterinario_responsavel.trim()===""){g({title:"Erro de validação",description:"Veterinário responsável é obrigatório. Por favor, informe o nome do veterinário.",variant:"destructive"});return}const h={embriao_id:t.embriao_id,receptora_id:t.receptora_id,protocolo_receptora_id:t.protocolo_receptora_id||null,data_te:t.data_te,tipo_te:S==="CONGELADO"?"CONGELADO":"FRESCO",veterinario_responsavel:t.veterinario_responsavel.trim(),tecnico_responsavel:((o=t.tecnico_responsavel)==null?void 0:o.trim())||null,status_te:"REALIZADA",observacoes:((_=t.observacoes)==null?void 0:_.trim())||null},{data:D,error:E}=await l.from("transferencias_embrioes").insert([h]).select("id");if(E){if(E.code==="23505"&&((m=E.message)!=null&&m.includes("unq_embriao_te_realizada"))){S==="CONGELADO"?Je():ye();return}throw E}if(D&&((c=D[0])!=null&&c.id)&&me(R=>[...R,D[0].id]),t.receptora_id){const{data:R}=await l.from("receptoras").select("id, status_reprodutivo").eq("id",t.receptora_id).single()}const{error:w}=await l.from("embrioes").update({status_atual:"TRANSFERIDO"}).eq("id",t.embriao_id);if(w)throw w;const{error:O}=await l.from("receptoras").update({status_reprodutivo:"SERVIDA"}).eq("id",t.receptora_id);if(O)throw O;if((s==null?void 0:s.origem)==="CIO_LIVRE"){const{error:R}=await l.from("receptoras").update({status_cio_livre:"CONFIRMADA",is_cio_livre:!1}).eq("id",t.receptora_id);if(R)throw R;const{error:q}=await l.from("receptoras_cio_livre").update({ativa:!1}).eq("receptora_id",t.receptora_id).eq("ativa",!0);if(q)throw q}t.protocolo_receptora_id&&pe(R=>R.includes(t.protocolo_receptora_id)?R:[...R,t.protocolo_receptora_id]);const $=(we[t.receptora_id]||0)+1,L={...we,[t.receptora_id]:$},Z={...ca,[t.receptora_id]:{...s,quantidade_embrioes:$,status_reprodutivo:"SERVIDA"}};Re(L),Ie(Z),g({title:"Transferência realizada",description:"Transferência de embrião registrada com sucesso"}),se({data_te:t.data_te,veterinario_responsavel:t.veterinario_responsavel,tecnico_responsavel:t.tecnico_responsavel}),y({fazenda_id:t.fazenda_id,pacote_id:S==="PACOTE"?t.pacote_id:"",protocolo_id:t.protocolo_id,embriao_id:"",receptora_id:"",protocolo_receptora_id:"",data_te:t.data_te,veterinario_responsavel:t.veterinario_responsavel,tecnico_responsavel:t.tecnico_responsavel,observacoes:""}),S==="CONGELADO"?Je():ye(),t.fazenda_id&&await We(t.fazenda_id,{contagem:L,info:Z})}catch(h){g({title:"Erro ao realizar transferência",description:h instanceof Error?h.message:"Erro desconhecido",variant:"destructive"})}finally{_e(!1)}},za=async()=>{if(I.length===0){g({title:"Nenhuma transferência na sessão",description:"Não há transferências para visualizar.",variant:"destructive"});return}Se(!0),await Ta(!0)},Ta=async(e=!1)=>{if(!(I.length>0)){e||g({title:"Nenhuma transferência na sessão",description:"Não há transferências para gerar relatório.",variant:"destructive"});return}if(!e&&Ce.length===0){g({title:"Nenhuma transferência na sessão",description:"Não há transferências para gerar relatório.",variant:"destructive"});return}try{const{data:s,error:n}=await l.from("transferencias_embrioes").select(`
          *,
          embrioes (
            id,
            identificacao,
            classificacao,
            status_atual,
            lote_fiv_id,
            lote_fiv_acasalamento_id
          ),
          receptoras (
            id,
            identificacao,
            nome
          )
        `).in("id",I).eq("status_te","REALIZADA").order("created_at",{ascending:!0});if(n)throw n;if(!s||s.length===0){g({title:"Erro ao gerar relatório",description:"Não foi possível encontrar as transferências da sessão.",variant:"destructive"});return}const d=s.map(c=>{var h;return(h=c.embrioes)==null?void 0:h.lote_fiv_acasalamento_id}).filter(c=>!!c),{doadorasMap:o,tourosMap:_}=await Fa(d),m=s.map(c=>{var $,L,Z,R,q;const h=($=c.embrioes)==null?void 0:$.lote_fiv_acasalamento_id,D=h&&o.get(h)||"N/A",E=h&&_.get(h)||"N/A";return{numero_embriao:((L=c.embrioes)==null?void 0:L.identificacao)||(de&&de.get(c.embriao_id)?String(de.get(c.embriao_id)):null)||(c.embriao_id?c.embriao_id.substring(0,8):"N/A"),doadora:D,touro:E,classificacao:((Z=c.embrioes)==null?void 0:Z.classificacao)||"N/A",receptora_brinco:((R=c.receptoras)==null?void 0:R.identificacao)||"N/A",receptora_nome:((q=c.receptoras)==null?void 0:q.nome)||"N/A",data_te:c.data_te,veterinario:c.veterinario_responsavel||"N/A",tecnico:c.tecnico_responsavel||"N/A",observacoes:c.observacoes||""}});sa(m),je(!0)}catch(s){g({title:"Erro ao gerar relatório",description:s instanceof Error?s.message:"Erro desconhecido",variant:"destructive"}),Se(!1)}},_a=async()=>{if(I.length===0){g({title:"Nenhuma transferência na sessão",description:"Não há transferências para encerrar nesta sessão.",variant:"destructive"});return}try{_e(!0);let e=[...Ce];if(e.length===0){const{data:_,error:m}=await l.from("transferencias_embrioes").select("protocolo_receptora_id").in("id",I);if(m)throw m;e=[...new Set((_||[]).map(c=>c.protocolo_receptora_id).filter(c=>!!c))]}const{data:i,error:s}=await l.from("transferencias_embrioes").select("receptora_id").in("id",I).eq("status_te","REALIZADA");if(s)throw s;const n=[...new Set((i||[]).map(_=>_.receptora_id).filter(Boolean))];if(n.length===0)throw new Error("Nenhuma receptora encontrada para encerrar a sessão.");const{error:d}=await l.rpc("encerrar_sessao_te",{p_receptora_ids:n,p_protocolo_receptora_ids:e});if(d)throw(d==null?void 0:d.code)==="PGRST202"?new Error("Função encerrar_sessao_te não encontrada no banco. Aplique o SQL em docs/db/003_encerrar_sessao_te.sql e tente novamente."):d;await wa(t.fazenda_id),g({title:"Sessão encerrada",description:`${I.length} transferência(s) finalizada(s) com sucesso.`}),y({fazenda_id:"",pacote_id:"",protocolo_id:"",embriao_id:"",receptora_id:"",protocolo_receptora_id:"",data_te:new Date().toISOString().split("T")[0],veterinario_responsavel:"",tecnico_responsavel:"",observacoes:""}),$e("PACOTE"),Ze(""),Qe(""),se({data_te:"",veterinario_responsavel:"",tecnico_responsavel:""});const o=t.fazenda_id;pe([]),me([]),Re({}),Ie({}),je(!1),sa([]),ae(1),le([]),await ye(),o&&await We(o)}catch(e){g({title:"Erro ao encerrar sessão",description:e instanceof Error?e.message:"Erro desconhecido",variant:"destructive"})}finally{_e(!1)}},K=Ve.find(e=>e.id===t.pacote_id),pa=!!S,W=u.useMemo(()=>(K==null?void 0:K.embrioes.filter(e=>e.status_atual==="FRESCO"))||[],[K]),Ma=W.some(e=>e.d8_limite);u.useEffect(()=>{ae(1)},[t.pacote_id]),u.useEffect(()=>{S==="CONGELADO"&&ae(1)},[S,J,te]),u.useEffect(()=>{S==="CONGELADO"&&y(e=>({...e,embriao_id:""}))},[S,J,te]),u.useEffect(()=>{const e=Math.max(1,Math.ceil(W.length/T));P>e&&ae(e)},[W.length,P,T]);const Pa=u.useRef(0),de=u.useMemo(()=>{if(!t.pacote_id||!K)return new Map;const e=[...W].sort((s,n)=>{const d=s.doadora_registro||"",o=n.doadora_registro||"";if(d!==o)return d.localeCompare(o);const _=s.created_at?new Date(s.created_at).getTime():0,m=n.created_at?new Date(n.created_at).getTime():0;return _!==m?_-m:(s.id||"").localeCompare(n.id||"")}),i=new Map;return e.forEach((s,n)=>{i.set(s.id,n+1)}),i},[t.pacote_id,K,W]);return u.useEffect(()=>{!t.pacote_id||!K||(Pa.current+=1)},[t.pacote_id,K,de]),ha?a.jsx(Oa,{}):a.jsxs("div",{className:"space-y-6",children:[a.jsx(Za,{title:"Transferência de Embriões (TE)",description:"Destinar embriões para receptoras sincronizadas"}),a.jsxs(Ba,{children:[a.jsx(Va,{children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs(Ga,{className:"flex items-center gap-2",children:[a.jsx(La,{className:"w-5 h-5"}),"Nova Transferência"]}),t.fazenda_id&&I.length>0&&a.jsxs("div",{className:"flex gap-2",children:[a.jsxs(U,{type:"button",onClick:za,className:"bg-slate-600 hover:bg-slate-700",disabled:ie,variant:"default",title:"Visualizar relatório da sessão atual sem encerrar",children:[a.jsx(Ye,{className:"w-4 h-4 mr-2"}),"Visualizar Relatório (",I.length," transferência",I.length>1?"s":"",")"]}),a.jsxs(U,{type:"button",onClick:_a,className:"bg-blue-600 hover:bg-blue-700",disabled:ie,variant:"default",children:[a.jsx(Ye,{className:"w-4 h-4 mr-2"}),ie?"Gerando...":`Encerrar Sessão (${I.length} transferência${I.length>1?"s":""})`]})]})]})}),a.jsx(ka,{children:a.jsxs("form",{onSubmit:ya,className:"space-y-6",children:[a.jsxs("div",{className:"space-y-4 border-b pb-6",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(F,{htmlFor:"fazenda_id",children:"1. Fazenda onde estão as receptoras *"}),a.jsxs(Te,{value:t.fazenda_id,onValueChange:Da,children:[a.jsx(Me,{children:a.jsx(Pe,{placeholder:"Selecione a fazenda"})}),a.jsx(Oe,{children:ea.map(e=>a.jsx(he,{value:e.id,children:e.nome},e.id))})]})]}),t.fazenda_id&&a.jsxs("div",{className:"space-y-2",children:[a.jsx(F,{htmlFor:"data_passo2",children:"2. Data do 2º Passo (opcional)"}),a.jsx(ua,{id:"data_passo2",value:ee,onChange:e=>He(e||"")}),ee&&a.jsx("div",{className:"flex justify-end",children:a.jsx(U,{type:"button",variant:"ghost",size:"sm",onClick:()=>He(""),children:"Limpar data"})})]}),t.fazenda_id&&a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(Ka,{id:"incluir-cio-livre",checked:be,onCheckedChange:na}),a.jsx(F,{htmlFor:"incluir-cio-livre",className:"cursor-pointer text-sm",children:"Incluir CIO livre"})]}),t.fazenda_id&&a.jsxs("div",{className:"space-y-2",children:[a.jsx(F,{htmlFor:"origem_embriao",children:"4. Origem do Embrião *"}),a.jsxs(Te,{value:S,onValueChange:e=>Ra(e),children:[a.jsx(Me,{children:a.jsx(Pe,{placeholder:"Selecione a origem"})}),a.jsxs(Oe,{children:[a.jsx(he,{value:"PACOTE",children:"Pacote (Fresco)"}),a.jsx(he,{value:"CONGELADO",children:"Estoque Congelado"})]})]})]}),t.fazenda_id&&S==="PACOTE"&&a.jsxs("div",{className:"space-y-2",children:[a.jsx(F,{htmlFor:"pacote_id",children:"5. Pacote de Embriões (Frescos) *"}),a.jsxs(Te,{value:t.pacote_id,onValueChange:Sa,disabled:!t.fazenda_id,children:[a.jsx(Me,{children:a.jsx(Pe,{placeholder:"Selecione um pacote"})}),a.jsx(Oe,{children:ta.length===0?a.jsx("div",{className:"p-2 text-sm text-slate-500",children:"Nenhum pacote disponível para esta fazenda"}):ta.map(e=>a.jsxs(he,{value:e.id,children:[Ae(e.data_despacho)," - ",e.total," embrião(ões) -",e.frescos>0&&` ${e.frescos} fresco(s)`,e.congelados>0&&` ${e.congelados} congelado(s)`]},e.id))})]})]}),t.fazenda_id&&S==="CONGELADO"&&a.jsxs("div",{className:"space-y-2",children:[a.jsx(F,{children:"5. Filtros de Embriões Congelados *"}),a.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(F,{htmlFor:"filtro_cliente",children:"Cliente"}),a.jsxs(Te,{value:J||"__all__",onValueChange:e=>Ze(e==="__all__"?"":e),children:[a.jsx(Me,{children:a.jsx(Pe,{placeholder:"Selecione um cliente"})}),a.jsxs(Oe,{children:[a.jsx(he,{value:"__all__",children:"Todos os clientes"}),Be.map(e=>a.jsx(he,{value:e.id,children:e.nome},e.id))]})]})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(F,{htmlFor:"filtro_raca",children:"Raça"}),a.jsx(Xe,{id:"filtro_raca",value:te,onChange:e=>Qe(e.target.value),placeholder:"Ex.: Nelore, Holandesa"})]})]}),a.jsx("p",{className:"text-xs text-slate-500",children:"Selecione ao menos um filtro para buscar embriões congelados."})]}),t.fazenda_id&&pa&&a.jsxs("div",{className:"space-y-2",children:[a.jsx(F,{children:"6. Receptoras *"}),a.jsx("div",{className:"border rounded-lg p-4",children:ge.length===0?a.jsx("div",{className:"text-sm text-slate-500",children:"Nenhuma receptora disponível para esta fazenda com os filtros atuais."}):a.jsx("div",{className:"max-h-80 overflow-y-auto",children:a.jsxs(Le,{children:[a.jsx(qe,{children:a.jsxs(ce,{children:[a.jsx(j,{className:"w-40",children:"Ação"}),a.jsx(j,{children:"Receptora"}),a.jsx(j,{children:"Status"}),a.jsx(j,{children:"Origem"}),a.jsx(j,{children:"Sessão"})]})}),a.jsx(Fe,{children:ge.map(e=>{const i=we[e.receptora_id]||0,s=t.receptora_id===e.receptora_id,n=i===1,d=e.status_reprodutivo||(i>0?"SERVIDA":"SINCRONIZADA");return a.jsxs(ce,{className:s?"bg-green-50":"hover:bg-slate-50",children:[a.jsx(b,{children:a.jsx(U,{type:"button",size:"sm",variant:n?"default":"outline",disabled:i>=2,onClick:()=>{y(o=>({...o,receptora_id:e.receptora_id,protocolo_receptora_id:e.protocolo_receptora_id||"",embriao_id:""}))},children:i>=2?"Limite":n?"2º embrião":"Selecionar"})}),a.jsx(b,{children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{children:e.brinco}),e.origem==="CIO_LIVRE"&&a.jsx(ve,{variant:"outline",className:"bg-indigo-50 text-indigo-700 border-indigo-200 text-xs",children:"Cio livre"}),e.data_te_prevista&&a.jsxs("span",{className:"text-slate-500 text-xs",children:["(TE prevista: ",Ae(e.data_te_prevista),")"]})]})}),a.jsx(b,{children:a.jsx(ve,{variant:"outline",className:"text-xs",children:d})}),a.jsx(b,{children:e.origem==="CIO_LIVRE"?"CIO livre":"Protocolo"}),a.jsx(b,{children:i>0?`${i} TE`:"—"})]},e.receptora_id)})})]})})}),t.receptora_id&&a.jsxs(U,{type:"button",variant:"destructive",onClick:Ia,disabled:ie,title:"Descartar receptora (não receberá embrião)",children:[a.jsx(rt,{className:"w-4 h-4 mr-2"}),"Descartar receptora"]}),t.receptora_id&&(()=>{const e=ge.find(n=>n.receptora_id===t.receptora_id),i=(e==null?void 0:e.qualidade_semaforo)!==null&&(e==null?void 0:e.qualidade_semaforo)!==void 0,s=(e==null?void 0:e.ciclando_classificacao)!==null&&(e==null?void 0:e.ciclando_classificacao)!==void 0;return i||s?a.jsxs("div",{className:"mt-3 p-3 bg-slate-50 rounded-md border border-slate-200",children:[a.jsx("p",{className:"text-sm font-medium text-slate-700 mb-2",children:"Avaliação da Receptora:"}),a.jsxs("div",{className:"flex items-center gap-4",children:[s&&a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"text-xs text-slate-600",children:"Ciclando:"}),a.jsx(Ua,{value:e.ciclando_classificacao,variant:"display",disabled:!0})]}),i&&a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"text-xs text-slate-600",children:"Qualidade:"}),a.jsx(Ja,{value:e.qualidade_semaforo,variant:"single",disabled:!0})]})]})]}):null})()]}),pa&&a.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(F,{htmlFor:"data_te",children:"Data da TE *"}),a.jsx(ua,{id:"data_te",value:t.data_te,onChange:e=>{const i=e||"";y({...t,data_te:i}),se(s=>({...s,data_te:i}))},required:!0})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(F,{htmlFor:"veterinario_responsavel",children:"Veterinário Responsável *"}),a.jsx(Xe,{id:"veterinario_responsavel",value:t.veterinario_responsavel,onChange:e=>{const i=e.target.value;y({...t,veterinario_responsavel:i}),se(s=>({...s,veterinario_responsavel:i}))},placeholder:"Nome do veterinário",required:!0})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(F,{htmlFor:"tecnico_responsavel",children:"Técnico Responsável"}),a.jsx(Xe,{id:"tecnico_responsavel",value:t.tecnico_responsavel,onChange:e=>{const i=e.target.value;y({...t,tecnico_responsavel:i}),se(s=>({...s,tecnico_responsavel:i}))},placeholder:"Nome do técnico"})]})]}),t.embriao_id&&t.receptora_id&&a.jsx("div",{className:"flex gap-2 pt-2",children:a.jsxs(U,{type:"submit",className:"bg-green-600 hover:bg-green-700",disabled:ie,children:[a.jsx(ot,{className:"w-4 h-4 mr-2"}),ie?"Registrando...":"Registrar Transferência"]})})]}),S==="PACOTE"&&t.pacote_id&&K&&a.jsxs("div",{className:"space-y-4",children:[a.jsx(F,{children:"7. Selecionar Embrião do Pacote *"}),a.jsxs("div",{className:"border rounded-lg p-4",children:[a.jsxs("div",{className:"mb-4",children:[a.jsx("h3",{className:"font-semibold text-slate-900",children:"Pacote selecionado"}),a.jsxs("p",{className:"text-sm text-slate-600",children:["Data Despacho: ",Ae(K.data_despacho)," | Total: ",K.total," embrião(ões)"]}),Ma&&a.jsxs("div",{className:"mt-2 flex items-center gap-2 text-sm text-amber-700",children:[a.jsx(it,{className:"w-4 h-4"}),"Embriões em D8: transferir ou congelar hoje. No D9 serão descartados automaticamente."]})]}),a.jsxs("div",{className:"max-h-96 overflow-y-auto",children:[a.jsxs(Le,{children:[a.jsx(qe,{children:a.jsxs(ce,{children:[a.jsx(j,{className:"w-12"}),a.jsx(j,{className:"text-center w-28",children:"Código"}),a.jsx(j,{children:"Doadora"}),a.jsx(j,{children:"Touro"}),a.jsx(j,{children:"Classificação"}),a.jsx(j,{children:"Status"}),a.jsx(j,{children:"Dia"})]})}),a.jsx(Fe,{children:(()=>{const e=[...W].sort((o,_)=>{const m=o.identificacao||"",c=_.identificacao||"";if(m&&c)return m.localeCompare(c);if(m&&!c)return-1;if(!m&&c)return 1;const h=de.get(o.id)||9999,D=de.get(_.id)||9999;return h-D}),i=Math.max(1,Math.ceil(e.length/T)),n=(Math.min(P,i)-1)*T;return e.slice(n,n+T).map(o=>{const _=de.get(o.id)||0;return a.jsxs(ce,{className:t.embriao_id===o.id?"bg-green-50":"cursor-pointer hover:bg-slate-50",onClick:()=>y({...t,embriao_id:o.id}),children:[a.jsx(b,{children:a.jsx("input",{type:"radio",name:"embriao",value:o.id,checked:t.embriao_id===o.id,onChange:()=>y({...t,embriao_id:o.id}),className:"w-4 h-4"})}),a.jsx(b,{className:"text-center font-medium font-mono text-xs",children:o.identificacao||`#${_}`}),a.jsx(b,{children:o.doadora_registro||"-"}),a.jsx(b,{children:o.touro_nome||"-"}),a.jsx(b,{children:o.classificacao?a.jsx(ve,{variant:"outline",children:o.classificacao}):a.jsx("span",{className:"text-slate-400",children:"-"})}),a.jsx(b,{children:a.jsx(fa,{status:o.status_atual})}),a.jsx(b,{children:o.d8_limite?a.jsx(ve,{variant:"destructive",children:"D8"}):o.d7_pronto?a.jsx(ve,{variant:"outline",className:"bg-emerald-50 text-emerald-700 border-emerald-200",children:"D7"}):a.jsx("span",{className:"text-slate-400",children:"-"})})]},o.id)})})()})]}),a.jsxs("div",{className:"mt-4 flex items-center justify-between text-sm text-slate-600",children:[a.jsxs("div",{children:[W.length," embrião(ões) disponíveis"]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(U,{type:"button",variant:"outline",size:"sm",onClick:()=>{ae(Math.max(1,P-1))},disabled:P===1,children:"Anterior"}),a.jsxs("span",{children:["Página ",Math.min(P,Math.max(1,Math.ceil(W.length/T)))," de ",Math.max(1,Math.ceil(W.length/T))]}),a.jsx(U,{type:"button",variant:"outline",size:"sm",onClick:()=>{const e=Math.max(1,Math.ceil(W.length/T));ae(Math.min(e,P+1))},disabled:P>=Math.max(1,Math.ceil(W.length/T)),children:"Próxima"})]})]})]})]})]}),S==="CONGELADO"&&a.jsxs("div",{className:"space-y-4",children:[a.jsx(F,{children:"7. Selecionar Embrião Congelado *"}),a.jsxs("div",{className:"border rounded-lg p-4",children:[!J&&!te.trim()&&a.jsx("div",{className:"text-sm text-slate-500",children:"Selecione um cliente ou informe a raça para listar embriões congelados."}),ke&&a.jsx("div",{className:"text-sm text-slate-500",children:"Carregando embriões congelados..."}),!ke&&re.length===0&&(J||te.trim())&&a.jsx("div",{className:"text-sm text-slate-500",children:"Nenhum embrião congelado encontrado para os filtros aplicados."}),!ke&&re.length>0&&a.jsxs("div",{className:"max-h-96 overflow-y-auto",children:[a.jsxs(Le,{children:[a.jsx(qe,{children:a.jsxs(ce,{children:[a.jsx(j,{className:"w-12"}),a.jsx(j,{children:"Cliente"}),a.jsx(j,{children:"Doadora"}),a.jsx(j,{children:"Touro"}),a.jsx(j,{children:"Classificação"}),a.jsx(j,{children:"Status"})]})}),a.jsx(Fe,{children:(()=>{const e=[...re].sort((o,_)=>{const m=o.created_at?new Date(o.created_at).getTime():0;return(_.created_at?new Date(_.created_at).getTime():0)-m}),i=Math.max(1,Math.ceil(e.length/T)),n=(Math.min(P,i)-1)*T;return e.slice(n,n+T).map(o=>a.jsxs(ce,{className:t.embriao_id===o.id?"bg-green-50":"cursor-pointer hover:bg-slate-50",onClick:()=>y({...t,embriao_id:o.id}),children:[a.jsx(b,{children:a.jsx("input",{type:"radio",name:"embriao",value:o.id,checked:t.embriao_id===o.id,onChange:()=>y({...t,embriao_id:o.id}),className:"w-4 h-4"})}),a.jsx(b,{children:o.cliente_nome||"-"}),a.jsx(b,{children:o.doadora_registro?`${o.doadora_registro} - ${o.doadora_raca||"-"}`:"-"}),a.jsx(b,{children:o.touro_nome?`${o.touro_nome} - ${o.touro_raca||"-"}`:"-"}),a.jsx(b,{children:o.classificacao?a.jsx(ve,{variant:"outline",children:o.classificacao}):a.jsx("span",{className:"text-slate-400",children:"-"})}),a.jsx(b,{children:a.jsx(fa,{status:o.status_atual})})]},o.id))})()})]}),a.jsxs("div",{className:"mt-4 flex items-center justify-between text-sm text-slate-600",children:[a.jsxs("div",{children:[re.length," embrião(ões) disponíveis"]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(U,{type:"button",variant:"outline",size:"sm",onClick:()=>{ae(Math.max(1,P-1))},disabled:P===1,children:"Anterior"}),a.jsxs("span",{children:["Página ",Math.min(P,Math.max(1,Math.ceil(re.length/T)))," de ",Math.max(1,Math.ceil(re.length/T))]}),a.jsx(U,{type:"button",variant:"outline",size:"sm",onClick:()=>{const e=Math.max(1,Math.ceil(re.length/T));ae(Math.min(e,P+1))},disabled:P>=Math.max(1,Math.ceil(re.length/T)),children:"Próxima"})]})]})]})]})]}),t.embriao_id&&t.receptora_id&&a.jsx("div",{className:"space-y-4 border-t pt-4",children:a.jsxs("div",{className:"space-y-2",children:[a.jsx(F,{htmlFor:"observacoes",children:"Observações"}),a.jsx($a,{id:"observacoes",value:t.observacoes,onChange:e=>y({...t,observacoes:e.target.value}),placeholder:"Observações sobre a transferência",rows:3})]})})]})})]}),a.jsx(Wa,{open:va,onOpenChange:je,children:a.jsxs(Xa,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[a.jsxs(Ya,{children:[a.jsxs(et,{className:"flex items-center gap-2",children:[a.jsx(Ye,{className:"w-5 h-5"}),"Relatório da Sessão de Transferência de Embriões"]}),a.jsxs(at,{children:["Fazenda: ",((ma=ea.find(e=>e.id===t.fazenda_id))==null?void 0:ma.nome)||"N/A"," | Data da TE: ",t.data_te?Ae(t.data_te):"N/A"," | Total: ",ia.length," transferência(s)"]})]}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[a.jsxs("div",{children:[a.jsx("strong",{children:"Veterinário Responsável:"})," ",t.veterinario_responsavel||"N/A"]}),a.jsxs("div",{children:[a.jsx("strong",{children:"Técnico Responsável:"})," ",t.tecnico_responsavel||"N/A"]})]}),a.jsx("div",{className:"border rounded-lg overflow-hidden",children:a.jsxs(Le,{children:[a.jsx(qe,{children:a.jsxs(ce,{children:[a.jsx(j,{className:"text-center",children:"Código"}),a.jsx(j,{children:"Doadora"}),a.jsx(j,{children:"Touro"}),a.jsx(j,{children:"Classificação"}),a.jsx(j,{children:"Receptora (Brinco)"}),a.jsx(j,{children:"Receptora (Nome)"}),a.jsx(j,{children:"Data TE"}),a.jsx(j,{children:"Observações"})]})}),a.jsx(Fe,{children:ia.map((e,i)=>a.jsxs(ce,{children:[a.jsx(b,{className:"text-center font-semibold",children:e.numero_embriao}),a.jsx(b,{children:e.doadora}),a.jsx(b,{children:e.touro}),a.jsx(b,{children:e.classificacao}),a.jsx(b,{className:"font-semibold",children:e.receptora_brinco}),a.jsx(b,{children:e.receptora_nome}),a.jsx(b,{children:e.data_te?Ae(e.data_te):"N/A"}),a.jsx(b,{className:"text-sm text-slate-600",children:e.observacoes||"-"})]},i))})]})})]}),a.jsxs(tt,{children:[a.jsx(U,{type:"button",variant:"outline",onClick:()=>{je(!1),Se(!1)},children:"Fechar"}),!ga&&a.jsx(U,{type:"button",onClick:async()=>{je(!1),Se(!1),await _a()},className:"bg-blue-600 hover:bg-blue-700",disabled:ie,children:ie?"Encerrando...":"Confirmar e Encerrar Sessão"})]})]})})]})}export{Ot as default};
