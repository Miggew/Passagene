import{g as ae,b as te,r as f,s as m,j as e,f as se,B as O}from"./index-B-7HRnm0.js";import{C as B,d as L,a as re,b as oe}from"./card-DdhhEbXV.js";import{B as g}from"./badge-BCHVCiM7.js";import{f as E}from"./dateUtils-eJ5e6apA.js";import{u as ne}from"./use-toast-DDUqdzpY.js";import{Q as ce,C as ie}from"./QualidadeSemaforo-CErGLmdF.js";import{C as v,g as de}from"./CountBadge-BBpPT0CT.js";import{D as le}from"./index-C6kCM6Yd.js";import{A as me}from"./arrow-left-D9wDrV6g.js";import"./popover-i4alam_g.js";import"./check-C6h7QFZL.js";import"./input-D2h8r4MO.js";function ye(){const{id:j}=ae(),P=te(),{toast:$}=ne(),[V,I]=f.useState(!0),[c,Z]=f.useState(null),[H,Q]=f.useState(""),[C,U]=f.useState([]),[l,k]=f.useState(null),[u,K]=f.useState({totalIniciaram:0,totalSincronizadas:0,totalServidas:0,totalDescartadas:0}),G=async a=>{try{const{data:s}=await m.from("protocolo_receptoras").select("receptora_id").eq("protocolo_id",a.id).limit(1);if(!s||s.length===0)return a.observacoes||"";const n=s[0].receptora_id,{data:t}=await m.from("receptora_fazenda_historico").select(`
          fazenda_id,
          data_inicio
        `).eq("receptora_id",n).order("data_inicio",{ascending:!0});if(!t||t.length<2)return a.observacoes||"";const d=new Set;for(const o of t)o.fazenda_id&&d.add(o.fazenda_id);const{data:h}=await m.from("fazendas").select("id, nome").in("id",Array.from(d)),i=new Map;if(h)for(const o of h)i.set(o.id,o.nome);const N=a.data_inicio.split("T")[0],[r,b,z]=N.split("-").map(Number),y=new Date(r,b-1,z);let p=null,R=1/0;for(let o=1;o<t.length;o++){const x=t[o],D=t[o-1],w=x.data_inicio.split("T")[0],[A,S,T]=w.split("-").map(Number),_=new Date(A,S-1,T),M=Math.abs((_.getTime()-y.getTime())/(1e3*60*60*24));M<=1&&M<R&&(R=M,p={fazendaOrigem:i.get(D.fazenda_id)||"Fazenda desconhecida",fazendaDestino:i.get(x.fazenda_id)||"Fazenda desconhecida",dataMudanca:x.data_inicio})}if(!p&&t.length>1)for(let o=t.length-1;o>=1;o--){const x=t[o],D=t[o-1],w=x.data_inicio.split("T")[0],[A,S,T]=w.split("-").map(Number),_=new Date(A,S-1,T);if(_<=y&&(y.getTime()-_.getTime())/(1e3*60*60*24)<=2){p={fazendaOrigem:i.get(D.fazenda_id)||"Fazenda desconhecida",fazendaDestino:i.get(x.fazenda_id)||"Fazenda desconhecida",dataMudanca:x.data_inicio};break}}if(p){const o=new Date(p.dataMudanca).toLocaleDateString("pt-BR");return`${a.observacoes} (Mudança: ${p.fazendaOrigem} → ${p.fazendaDestino} em ${o})`}return a.observacoes||""}catch{return a.observacoes||""}};f.useEffect(()=>{j&&J()},[j]);const J=async()=>{try{I(!0);const{data:a,error:s}=await m.from("protocolos_sincronizacao").select("*").eq("id",j).single();if(s)throw s;let n=a.observacoes;a.observacoes&&a.observacoes.includes("Protocolo criado automaticamente")&&(n=await G(a)),Z({...a,observacoes:n});const{data:t,error:d}=await m.from("fazendas").select("nome").eq("id",a.fazenda_id).single();if(d)throw d;Q(t.nome),await W(a.id),await X({...a,observacoes:n})}catch{}finally{I(!1)}},W=async a=>{try{const{data:s,error:n}=await m.from("protocolo_receptoras").select("id").eq("protocolo_id",a);if(n||!s||s.length===0)return;const t=s.map(i=>i.id),{data:d,error:h}=await m.from("transferencias_embrioes").select("data_te, veterinario_responsavel, tecnico_responsavel").in("protocolo_receptora_id",t).eq("status_te","REALIZADA").order("data_te",{ascending:!1}).order("created_at",{ascending:!1}).limit(1);if(h)return;if(d&&d.length>0){const i=d[0];k({data_te:i.data_te,veterinario_responsavel:i.veterinario_responsavel||void 0,tecnico_responsavel:i.tecnico_responsavel||void 0})}}catch{k(null)}},X=async a=>{try{const{data:s,error:n}=await m.from("protocolo_receptoras").select("*").eq("protocolo_id",a.id).order("data_inclusao",{ascending:!0});if(n)throw n;const t=[];for(const r of s||[]){const{data:b,error:z}=await m.from("receptoras").select("*").eq("id",r.receptora_id).single();z||t.push({...b,pr_id:r.id,pr_status:r.status,pr_motivo_inapta:r.motivo_inapta,pr_data_inclusao:r.data_inclusao,pr_data_retirada:r.data_retirada,pr_ciclando_classificacao:r.ciclando_classificacao,pr_qualidade_semaforo:r.qualidade_semaforo})}U(t);const d=t.length,h=t.filter(r=>r.pr_status==="APTA"||r.pr_status==="UTILIZADA").length,i=t.filter(r=>r.pr_status==="UTILIZADA").length,N=t.filter(r=>r.pr_status==="INAPTA").length;K({totalIniciaram:d,totalSincronizadas:h,totalServidas:i,totalDescartadas:N})}catch{$({title:"Erro ao carregar receptoras",description:"Não foi possível carregar a lista de receptoras do protocolo.",variant:"destructive"})}},Y=a=>{if(!a)return{veterinario:null,tecnico:null};const s=a.match(/VET:\s*(.+?)(?:\s*\||$)/i),n=a.match(/TEC:\s*(.+?)(?:\s*\||$)/i);return{veterinario:s?s[1].trim():null,tecnico:n?n[1].trim():null}},ee=a=>{const n={INICIADA:{label:"Pendente",className:"bg-muted text-muted-foreground border-border"},APTA:{label:"Sincronizada",className:"bg-primary/15 text-primary border-primary/30"},INAPTA:{label:"Descartada",className:"bg-destructive/15 text-destructive border-destructive/30"},UTILIZADA:{label:"Servida",className:"bg-blue-500/15 text-blue-600 dark:text-blue-400 border-blue-500/30"}}[a]||{label:a,className:""};return e.jsx(g,{variant:"outline",className:n.className,children:n.label})};if(V)return e.jsx(se,{});if(!c)return e.jsxs("div",{className:"text-center py-12",children:[e.jsx("p",{className:"text-muted-foreground",children:"Protocolo não encontrado"}),e.jsx(O,{onClick:()=>P("/protocolos"),className:"mt-4",children:"Voltar para Protocolos"})]});const q=Y(c.responsavel_inicio),F=u.totalIniciaram>0?Math.round(u.totalSincronizadas/u.totalIniciaram*100):0;return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(O,{variant:"ghost",size:"sm",onClick:()=>P(-1),children:e.jsx(me,{className:"w-4 h-4"})}),e.jsx("h1",{className:"text-xl font-semibold text-foreground",children:"Relatório do Protocolo"})]}),e.jsx(B,{children:e.jsxs(L,{className:"pt-4 pb-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-xs font-medium text-muted-foreground",children:"Fazenda"}),e.jsx("p",{className:"text-base font-semibold text-foreground",children:H||"—"})]}),e.jsx("div",{className:"h-8 w-px bg-border"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xs font-medium text-muted-foreground",children:"Data Início"}),e.jsx("p",{className:"text-sm text-foreground",children:c.data_inicio?E(c.data_inicio):"—"})]}),e.jsx("div",{className:"h-8 w-px bg-border"}),e.jsxs("div",{children:[c.status==="SINCRONIZADO"&&e.jsx(g,{variant:"default",className:"bg-primary hover:bg-primary-dark",children:"Sincronizado"}),c.status==="FECHADO"&&e.jsx(g,{variant:"secondary",className:"bg-muted-foreground hover:bg-muted-foreground/90 text-white",children:"Fechado"}),c.status==="PASSO1_FECHADO"&&e.jsx(g,{variant:"outline",className:"border-emerald-500 bg-emerald-50 text-emerald-700 dark:bg-emerald-950 dark:text-emerald-400",children:"Aguardando 2º Passo"}),c.status==="EM_TE"&&e.jsx(g,{variant:"secondary",className:"bg-blue-600 hover:bg-blue-700 text-white",children:"Em TE"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Total:"}),e.jsx(v,{value:u.totalIniciaram,variant:"default"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Servidas:"}),e.jsx(v,{value:u.totalServidas,variant:"violet"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Sincronizadas:"}),e.jsx(v,{value:u.totalSincronizadas,variant:"primary"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Descartadas:"}),e.jsx(v,{value:u.totalDescartadas,variant:"danger"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Taxa:"}),e.jsx(v,{value:F,suffix:"%",variant:de(F)})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4 pt-3 border-t border-border",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h4",{className:"text-[10px] font-semibold text-muted-foreground uppercase tracking-wide",children:"1º Passo"}),e.jsxs("div",{className:"space-y-0.5",children:[e.jsxs("p",{className:"text-xs",children:[e.jsx("span",{className:"text-muted-foreground",children:"Vet:"})," ",e.jsx("span",{className:"text-foreground",children:q.veterinario||"—"})]}),e.jsxs("p",{className:"text-xs",children:[e.jsx("span",{className:"text-muted-foreground",children:"Téc:"})," ",e.jsx("span",{className:"text-foreground",children:q.tecnico||"—"})]})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("h4",{className:"text-[10px] font-semibold text-muted-foreground uppercase tracking-wide",children:"2º Passo"}),e.jsxs("div",{className:"space-y-0.5",children:[e.jsxs("p",{className:"text-xs",children:[e.jsx("span",{className:"text-muted-foreground",children:"Data:"})," ",e.jsx("span",{className:"text-foreground",children:c.passo2_data?E(c.passo2_data):"—"})]}),e.jsxs("p",{className:"text-xs",children:[e.jsx("span",{className:"text-muted-foreground",children:"Téc:"})," ",e.jsx("span",{className:"text-foreground",children:c.passo2_tecnico_responsavel||"—"})]})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("h4",{className:"text-[10px] font-semibold text-muted-foreground uppercase tracking-wide",children:"Transferência"}),e.jsxs("div",{className:"space-y-0.5",children:[e.jsxs("p",{className:"text-xs",children:[e.jsx("span",{className:"text-muted-foreground",children:"Data:"})," ",e.jsx("span",{className:"text-foreground",children:l!=null&&l.data_te?E(l.data_te):"—"})]}),e.jsxs("p",{className:"text-xs",children:[e.jsx("span",{className:"text-muted-foreground",children:"Vet:"})," ",e.jsx("span",{className:"text-foreground",children:(l==null?void 0:l.veterinario_responsavel)||"—"})]})]})]}),c.observacoes?e.jsxs("div",{className:"space-y-1",children:[e.jsx("h4",{className:"text-[10px] font-semibold text-muted-foreground uppercase tracking-wide",children:"Observações"}),e.jsx("p",{className:"text-xs text-muted-foreground line-clamp-2",children:c.observacoes})]}):e.jsxs("div",{className:"space-y-1",children:[e.jsx("h4",{className:"text-[10px] font-semibold text-muted-foreground uppercase tracking-wide",children:"TE (cont.)"}),e.jsxs("p",{className:"text-xs",children:[e.jsx("span",{className:"text-muted-foreground",children:"Téc:"})," ",e.jsx("span",{className:"text-foreground",children:(l==null?void 0:l.tecnico_responsavel)||"—"})]})]})]})]})}),e.jsxs(B,{children:[e.jsx(re,{className:"pb-2 pt-3",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs(oe,{className:"text-base",children:["Receptoras (",C.length,")"]})})}),e.jsx(L,{className:"pt-0 pb-2",children:e.jsx(le,{data:C,rowKey:"id",rowNumber:!0,emptyMessage:"Nenhuma receptora no protocolo",columns:[{key:"identificacao",label:"Identificação"},{key:"pr_ciclando_classificacao",label:"Ciclo",align:"center"},{key:"pr_qualidade_semaforo",label:"Qual.",align:"center"},{key:"pr_status",label:"Resultado",align:"center"},{key:"pr_motivo_inapta",label:"Motivo Descarte"}],renderCell:(a,s)=>{switch(s.key){case"identificacao":return e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-sm text-foreground",children:a.identificacao}),a.nome&&e.jsx("span",{className:"text-[10px] text-muted-foreground block",children:a.nome})]});case"pr_ciclando_classificacao":return e.jsx(ie,{value:a.pr_ciclando_classificacao,variant:"display",disabled:!0});case"pr_qualidade_semaforo":return e.jsx(ce,{value:a.pr_qualidade_semaforo,variant:"single",disabled:!0});case"pr_status":return ee(a.pr_status);case"pr_motivo_inapta":return e.jsx("span",{className:"text-xs text-muted-foreground",children:a.pr_motivo_inapta||"—"});default:return null}}})})]})]})}export{ye as default};
