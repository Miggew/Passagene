import{r as o,s as c,g as Q,b as U,j as e,f as W,B as k}from"./index-B-7HRnm0.js";import{C as F,a as O,b as $,d as V}from"./card-DdhhEbXV.js";import{T as J,a as H,b as q,c as I,d as Z,e as S}from"./table-fky3lpGR.js";import{D as X,a as Y,b as ee,c as te,d as oe}from"./dialog-CIXjHraQ.js";import"./alert-dialog-CSZ8uCy0.js";import"./input-D2h8r4MO.js";import"./label-vBcRjcSu.js";import"./textarea-RmDl789L.js";import"./command-C3-lNK43.js";import"./popover-i4alam_g.js";import"./tabs-ChsREKvA.js";import{B as L}from"./badge-BCHVCiM7.js";import{P as ae}from"./PageHeader-CT7CFo0W.js";import{E as re}from"./EmptyState-gn01eel2.js";import{u as B}from"./use-toast-DDUqdzpY.js";import{f as M}from"./dateUtils-eJ5e6apA.js";import{i as K,g as G}from"./receptoraStatus-D9dFVedA.js";import{A as se}from"./arrow-left-D9wDrV6g.js";import{C as ie}from"./circle-check-big-ybUp-L0y.js";import"./search-DcAWDjHO.js";import"./index-C7yzDtsu.js";import"./index-B4eR1KA_.js";function ce({protocoloId:a}){const{toast:r}=B(),[A,n]=o.useState(!0),[m,z]=o.useState(null),[_,C]=o.useState(""),[v,D]=o.useState([]),[P,E]=o.useState([]),j=o.useCallback(async()=>{if(!a)return[];const{data:t,error:p}=await c.from("protocolo_receptoras").select("*").eq("protocolo_id",a);if(p)throw p;if(!t||t.length===0)return[];const g=t.map(i=>i.receptora_id),{data:b,error:d}=await c.from("receptoras").select("*").in("id",g);if(d)throw d;const l=new Map((b==null?void 0:b.map(i=>[i.id,i]))||[]);return t.map(i=>{const x=l.get(i.receptora_id);return x?{...x,pr_id:i.id,pr_status:i.status,pr_motivo_inapta:i.motivo_inapta,pr_observacoes:i.observacoes}:null}).filter(i=>i!==null)},[a]),f=o.useCallback(async t=>{var w;const{data:p,error:g}=await c.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",t);if(g)throw g;const b=(p==null?void 0:p.map(N=>N.receptora_id))||[];if(b.length===0){E([]);return}const[d,l]=await Promise.all([c.from("receptoras").select("id, identificacao, nome, status_reprodutivo").in("id",b).order("identificacao",{ascending:!0}),c.from("protocolo_receptoras").select("receptora_id").eq("protocolo_id",a)]);if(d.error)throw d.error;const i=d.data||[],x=new Set(((w=l.data)==null?void 0:w.map(N=>N.receptora_id))||[]),u=i.map(N=>{const y=x.has(N.id),R=N.status_reprodutivo||"VAZIA";return{...N,disponivel:!y&&R==="VAZIA",jaNoProtocolo:y}});E(u)},[a]),s=o.useCallback(async()=>{if(a)try{n(!0);const{data:t,error:p}=await c.from("protocolos_sincronizacao").select("*").eq("id",a).single();if(p)throw p;z(t);const[g,b]=await Promise.all([c.from("fazendas").select("nome").eq("id",t.fazenda_id).single(),j()]);if(g.error)throw g.error;C(g.data.nome),D(b),await f(t.fazenda_id)}catch(t){r({title:"Erro ao carregar dados",description:t instanceof Error?t.message:"Erro desconhecido",variant:"destructive"})}finally{n(!1)}},[a,j,f,r]),h=o.useCallback(async()=>{m&&await f(m.fazenda_id)},[m,f]);return{loading:A,protocolo:m,setProtocolo:z,fazendaNome:_,receptoras:v,setReceptoras:D,receptorasDisponiveis:P,loadData:s,loadReceptoras:j,reloadReceptorasDisponiveis:h}}function ne({protocoloId:a,protocolo:r,receptoras:A,onSuccess:n}){const{toast:m}=B(),z=o.useRef(!1),[_,C]=o.useState(!1),[v,D]=o.useState({receptora_id:"",observacoes:""}),P=o.useCallback(()=>{D({receptora_id:"",observacoes:""})},[]),E=o.useCallback((f,s)=>{D(h=>({...h,[f]:s}))},[]),j=o.useCallback(async()=>{var f;if(!(_||z.current)){if(!v.receptora_id){m({title:"Erro",description:"Selecione uma receptora",variant:"destructive"});return}try{z.current=!0,C(!0);const{data:s,error:h}=await c.from("receptoras").select("id, identificacao, status_reprodutivo").eq("id",v.receptora_id).single();if(h)throw h;const{data:t}=await c.from("protocolo_receptoras").select("receptora_id").eq("protocolo_id",a);if(t&&t.length>0){const l=t.map(u=>u.receptora_id);if(l.includes(v.receptora_id)){m({title:"Receptora já está no protocolo",description:"Essa receptora já está adicionada a este protocolo.",variant:"destructive"});return}const{data:i}=await c.from("receptoras").select("id, identificacao").in("id",l);if(i==null?void 0:i.find(u=>u.identificacao===s.identificacao)){m({title:"Brinco já está no protocolo",description:`Já existe uma receptora com o brinco "${s.identificacao}" neste protocolo.`,variant:"destructive"});return}}const{data:p}=await c.from("protocolo_receptoras").select(`
          id,
          protocolo_id,
          status,
          motivo_inapta,
          protocolos_sincronizacao!inner (
            id,
            status,
            data_inicio
          )
        `).eq("receptora_id",v.receptora_id).neq("protocolos_sincronizacao.status","SINCRONIZADO");if(p&&p.length>0){const l=p.find(x=>x.protocolo_id===a);if(l){m({title:"Receptora já está no protocolo",description:`Esta receptora já foi adicionada (Status: ${l.status}).`,variant:"destructive"}),n();return}const i=p.filter(x=>{var N;const u=(N=x.protocolos_sincronizacao)==null?void 0:N.status,w=x.status;return w==="INAPTA"?!1:(w==="APTA"||w==="INICIADA")&&u!=="SINCRONIZADO"&&u!=="FECHADO"});if(i.length>0){const u=i[0].protocolos_sincronizacao;m({title:"Receptora em outro protocolo ativo",description:`Esta receptora está vinculada a outro protocolo ativo (ID: ${(f=u==null?void 0:u.id)==null?void 0:f.substring(0,8)}). Finalize o protocolo anterior antes de adicionar a um novo.`,variant:"destructive"});return}}const g=(s==null?void 0:s.status_reprodutivo)||"VAZIA";if(!K(g)){m({title:"Receptora não disponível",description:G(g),variant:"destructive"});return}const b={protocolo_id:a,receptora_id:v.receptora_id,evento_fazenda_id:r==null?void 0:r.fazenda_id,data_inclusao:r==null?void 0:r.data_inicio,status:"INICIADA",observacoes:v.observacoes||null},{error:d}=await c.from("protocolo_receptoras").insert([b]).select();if(d){if(d.code==="23505"){m({title:"Receptora já está no protocolo",description:"Esta receptora já foi adicionada a este protocolo.",variant:"destructive"}),n();return}throw d}m({title:"Receptora adicionada",description:"Receptora adicionada ao protocolo com sucesso"}),P(),n()}catch(s){m({title:"Erro ao adicionar receptora",description:s instanceof Error?s.message:"Erro desconhecido",variant:"destructive"})}finally{C(!1),z.current=!1}}},[_,v,a,r,n,P,m]);return{formData:v,setFormData:D,updateField:E,submitting:_,resetForm:P,handleAddReceptora:j}}function de({protocoloId:a,protocolo:r,onSuccess:A}){const{toast:n}=B(),[m,z]=o.useState(!1),[_,C]=o.useState({identificacao:"",nome:"",observacoes:""}),v=o.useCallback(()=>{C({identificacao:"",nome:"",observacoes:""})},[]),D=o.useCallback((E,j)=>{C(f=>({...f,[E]:j}))},[]),P=o.useCallback(async()=>{var E;if(!_.identificacao.trim()){n({title:"Erro de validação",description:"Identificação (brinco) é obrigatória",variant:"destructive"});return}if(!(!r||!a))try{z(!0);const j=_.identificacao.trim(),{data:f}=await c.from("receptoras").select("id, identificacao, status_reprodutivo").ilike("identificacao",j);if(f&&f.length>0){const{data:d}=await c.from("protocolo_receptoras").select("receptora_id, status").eq("protocolo_id",a);if(d&&d.length>0){const x=f.map(R=>R.id),u=d.find(R=>x.includes(R.receptora_id));if(u){n({title:"Receptora já está no protocolo",description:`Esta receptora já foi adicionada (Status: ${u.status}).`,variant:"destructive"});return}const w=d.map(R=>R.receptora_id),{data:N}=await c.from("receptoras").select("id, identificacao").in("id",w),y=N==null?void 0:N.find(R=>R.identificacao===j);if(y){const R=d.find(T=>T.receptora_id===y.id);n({title:"Brinco já está no protocolo",description:`Já existe uma receptora com o brinco "${j}" neste protocolo (Status: ${(R==null?void 0:R.status)||"N/A"}).`,variant:"destructive"});return}}for(const x of f){const u=x.status_reprodutivo||"VAZIA";if(!K(u)){n({title:"Receptora não disponível",description:`Já existe uma receptora com esse brinco que está ${G(u)}`,variant:"destructive"});return}}const l=f.map(x=>x.id),{data:i}=await c.from("receptora_fazenda_historico").select("receptora_id, fazenda_id").in("receptora_id",l).eq("fazenda_id",r.fazenda_id).is("data_fim",null);if(i&&i.length>0){const x=i[0].receptora_id,u=f.find(w=>w.id===x);if(u){const{error:w}=await c.from("protocolo_receptoras").insert([{protocolo_id:a,receptora_id:u.id,evento_fazenda_id:r.fazenda_id,data_inclusao:r.data_inicio,status:"INICIADA",observacoes:_.observacoes||null}]);if(w){if(w.code==="23505"){n({title:"Receptora já está no protocolo",description:"Esta receptora já foi adicionada.",variant:"destructive"}),A();return}throw w}n({title:"Receptora adicionada",description:"Receptora existente foi adicionada ao protocolo"}),v(),A();return}}}const s={identificacao:j};_.nome.trim()&&(s.nome=_.nome.trim());const{data:h,error:t}=await c.from("receptoras").insert([s]).select().single();if(t)throw t.code==="23505"?new Error("Já existe uma receptora com esse brinco."):t;const{data:p}=await c.from("receptora_fazenda_historico").select("id").eq("receptora_id",h.id).eq("fazenda_id",r.fazenda_id).is("data_fim",null).maybeSingle();if(!p){const{error:d}=await c.from("receptora_fazenda_historico").insert([{receptora_id:h.id,fazenda_id:r.fazenda_id,data_inicio:new Date().toISOString().split("T")[0],data_fim:null}]);if(d)throw(E=d.message)!=null&&E.includes("brinco")||d.code==="P0001"?(await c.from("receptoras").delete().eq("id",h.id),new Error("Já existe uma receptora com esse brinco nesta fazenda.")):d}const{data:g}=await c.from("receptora_fazenda_historico").select("id").eq("receptora_id",h.id).eq("fazenda_id",r.fazenda_id).is("data_fim",null).maybeSingle();if(!g){await c.from("receptoras").delete().eq("id",h.id),n({title:"Erro ao criar receptora",description:"Não foi possível vincular a receptora à fazenda.",variant:"destructive"});return}const{error:b}=await c.from("protocolo_receptoras").insert([{protocolo_id:a,receptora_id:h.id,evento_fazenda_id:r.fazenda_id,data_inclusao:r.data_inicio,status:"INICIADA",observacoes:_.observacoes||null}]);if(b){if(await c.from("receptoras").delete().eq("id",h.id),b.code==="23505"){n({title:"Receptora já está no protocolo",description:"Esta receptora já foi adicionada.",variant:"destructive"}),A();return}throw b}n({title:"Receptora criada e adicionada",description:"Receptora criada e adicionada ao protocolo com sucesso"}),v(),A()}catch(j){n({title:"Erro ao criar receptora",description:j instanceof Error?j.message:"Erro desconhecido",variant:"destructive"})}finally{z(!1)}},[_,a,r,A,v,n]);return{formData:_,setFormData:C,updateField:D,submitting:m,resetForm:v,handleCreateReceptora:P}}function Ie(){const{id:a}=Q(),r=U(),{toast:A}=B(),[n,m]=o.useState(!1),[z,_]=o.useState(!1),[C,v]=o.useState(!1),[D,P]=o.useState(!1),[E,j]=o.useState(""),{loading:f,protocolo:s,fazendaNome:h,receptoras:t,loadData:p,reloadReceptorasDisponiveis:g}=ce({protocoloId:a});ne({protocoloId:a,protocolo:s,receptoras:t,onSuccess:()=>{m(!1),p()}}),de({protocoloId:a,protocolo:s,onSuccess:()=>{m(!1),p()}}),o.useEffect(()=>{a&&p()},[a,p]),o.useEffect(()=>{n&&s&&g()},[n,s,g]);const b=()=>{_(!1),A({title:"1º passo concluído com sucesso",description:`${t.length} receptoras em sincronização`}),r("/protocolos")};return f?e.jsx(W,{}):s?e.jsxs("div",{className:"space-y-6",children:[e.jsx(ae,{title:`Protocolo - ${h}`,description:"Protocolo finalizado",actions:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(k,{variant:"outline",size:"icon",onClick:()=>r("/protocolos"),children:e.jsx(se,{className:"w-4 h-4"})}),!1]})}),e.jsxs(F,{children:[e.jsx(O,{children:e.jsx($,{children:"Informações do Protocolo"})}),e.jsxs(V,{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Fazenda"}),e.jsx("p",{className:"text-base text-foreground",children:h})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Data Início"}),e.jsx("p",{className:"text-base text-foreground",children:M(s.data_inicio)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Responsável"}),e.jsx("p",{className:"text-base text-foreground",children:s.responsavel_inicio})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Status"}),e.jsx("div",{className:"text-base text-foreground",children:e.jsx(L,{variant:"secondary",children:"1º Passo Concluído"})})]})]})]}),e.jsxs(F,{children:[e.jsx(O,{children:e.jsxs($,{children:["Receptoras do Protocolo (",t.length,")"]})}),e.jsx(V,{children:e.jsxs(J,{children:[e.jsx(H,{children:e.jsxs(q,{children:[e.jsx(I,{children:"Brinco"}),e.jsx(I,{children:"Nome"}),e.jsx(I,{children:"Status"}),e.jsx(I,{children:"Observações"})]})}),e.jsx(Z,{children:t.length===0?e.jsx(q,{children:e.jsx(S,{colSpan:4,className:"text-center text-muted-foreground",children:"Nenhuma receptora adicionada ao protocolo"})}):t.map(l=>e.jsxs(q,{children:[e.jsx(S,{className:"font-medium",children:l.identificacao}),e.jsx(S,{children:l.nome||"-"}),e.jsx(S,{children:e.jsx(L,{variant:"secondary",children:l.pr_status==="INICIADA"?"Em Sincronização":l.pr_status})}),e.jsx(S,{className:"max-w-xs truncate",children:l.pr_observacoes||"-"})]},l.id))})]})})]}),e.jsx(X,{open:z,onOpenChange:_,children:e.jsxs(Y,{className:"max-w-2xl",children:[e.jsxs(ee,{children:[e.jsxs(te,{className:"flex items-center gap-2",children:[e.jsx(ie,{className:"w-6 h-6 text-primary"}),"Resumo do 1º Passo"]}),e.jsx(oe,{children:"1º passo concluído com sucesso"})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 p-4 bg-secondary rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Fazenda"}),e.jsx("p",{className:"text-base text-foreground",children:h})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Data do 1º Passo"}),e.jsx("p",{className:"text-base text-foreground",children:M(s.data_inicio)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Responsável"}),e.jsx("p",{className:"text-base text-foreground",children:s.responsavel_inicio})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Total de Receptoras"}),e.jsx("p",{className:"text-base text-foreground font-bold",children:t.length})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-foreground mb-2",children:"Receptoras em Sincronização:"}),e.jsx("div",{className:"max-h-60 overflow-y-auto border rounded-lg",children:e.jsxs(J,{children:[e.jsx(H,{children:e.jsxs(q,{children:[e.jsx(I,{children:"Brinco"}),e.jsx(I,{children:"Nome"})]})}),e.jsx(Z,{children:t.map(l=>e.jsxs(q,{children:[e.jsx(S,{className:"font-medium",children:l.identificacao}),e.jsx(S,{children:l.nome||"-"})]},l.id))})]})})]}),e.jsx("div",{className:"p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("strong",{children:"Próximo passo:"}),' Acesse a aba "2º Passo (para confirmar)" na tela de Protocolos e clique em "INICIAR 2º PASSO" para revisar e confirmar as receptoras.']})}),e.jsx(k,{onClick:b,className:"w-full",children:"OK - Voltar para Protocolos"})]})]})})]}):e.jsx(re,{title:"Protocolo não encontrado",description:"Volte para a lista e selecione outro protocolo.",action:e.jsx(k,{onClick:()=>r("/protocolos"),variant:"outline",children:"Voltar para Protocolos"})})}export{Ie as default};
