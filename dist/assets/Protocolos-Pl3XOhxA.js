import{c as ga,f as fa,r as i,s as z,j as a,a as M,B as r,g as B}from"./index-DmNymSE5.js";import{C as V,a as Z,b as q,d as G}from"./card-SrkIpKk5.js";import{T as Sa,a as va,b as J,c as u,d as Ca,e as x}from"./table-BEqiB4gi.js";import{S as $,a as K,b as Y,c as Q,d as p}from"./select-yD1hylSL.js";import{B as I}from"./badge-BB9l9AxT.js";import{L as _}from"./label-u6KawL_e.js";import{P as Pa}from"./PageHeader-C6hPTib0.js";import{E as Na}from"./EmptyState-8CewmVht.js";import{h as U}from"./error-handler-CVxXqVfW.js";import{D as W,C as _a,b as Da}from"./DatePickerBR-DL95UOFW.js";import{P as X}from"./plus-BZvL1qCK.js";import{S as Fa}from"./search-52vUzEUy.js";import{F as ya}from"./file-text-ZSN0C1g0.js";import"./index-BoubMqWY.js";import"./index-C79PyqkA.js";import"./index-BMCBZPUE.js";import"./index-BMurdLVa.js";import"./check-D6LfuFSM.js";import"./use-toast-8Wh80yTN.js";import"./popover-BabFSUJ1.js";import"./calendar-u0e6cTgk.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const za=ga("CirclePlay",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polygon",{points:"10 8 16 12 10 16 10 8",key:"1cimsy"}]]),aa="protocolos_filtros",Ia=()=>{try{const d=localStorage.getItem(aa);return d?JSON.parse(d):{}}catch{return{}}};function ss(){const d=fa(),[sa,b]=i.useState(!0),[j,A]=i.useState([]),[ea,ta]=i.useState([]),m=Ia(),[g,E]=i.useState(m.fazendaFilter??""),[f,S]=i.useState(m.filtroDataInicio??""),[v,C]=i.useState(m.filtroDataFim??""),oa=m.filtroStatus&&m.filtroStatus!=="all"?m.filtroStatus:"aguardando_2_passo",[P,T]=i.useState(oa),[D,R]=i.useState(!1),[h,F]=i.useState(m.protocolosPage??1),[wa,na]=i.useState(0),y=50;i.useEffect(()=>{ia()},[]),i.useEffect(()=>{const s={filtroStatus:P,fazendaFilter:g,filtroDataInicio:f,filtroDataFim:v,protocolosPage:h};localStorage.setItem(aa,JSON.stringify(s))},[P,g,f,v,h]);const ia=async()=>{try{b(!0),await ra(),await N()}catch(s){U(s,"Erro ao carregar dados")}finally{b(!1)}},ra=async()=>{const{data:s,error:e}=await z.from("fazendas").select("*").order("nome",{ascending:!0});if(e)throw e;ta(s||[])},N=async(s,e)=>{try{R(!0);const n=(e==null?void 0:e.fazenda)!==void 0?e.fazenda:g,c=(e==null?void 0:e.dataInicio)!==void 0?e.dataInicio:f,k=(e==null?void 0:e.dataFim)!==void 0?e.dataFim:v,w=(e==null?void 0:e.status)!==void 0?e.status:P,H=((s!==void 0?s:h)-1)*y,ca=H+y*2-1;let o=z.from("protocolos_sincronizacao").select("*",{count:"exact"});n&&n!=="all"&&(o=o.eq("fazenda_id",n)),c&&(o=o.gte("data_inicio",c)),k&&(o=o.lte("data_inicio",k)),w==="aguardando_2_passo"?o=o.in("status",["PASSO1_FECHADO","PRIMEIRO_PASSO_FECHADO"]):w==="sincronizado"?o=o.in("status",["SINCRONIZADO","PASSO2_FECHADO"]):w==="fechado"&&(o=o.in("status",["FECHADO","EM_TE"])),o=o.order("data_inicio",{ascending:!1}).range(H,ca);const{data:O,error:L,count:la}=await o;if(L)throw L;const da=(O||[]).map(t=>t.id),ma=[...new Set((O||[]).map(t=>t.fazenda_id))],{data:ha,error:ba}=await z.from("protocolo_receptoras").select("protocolo_id").in("protocolo_id",da),ua=(ha||[]).reduce((t,l)=>(t[l.protocolo_id]=(t[l.protocolo_id]||0)+1,t),{}),{data:xa}=await z.from("fazendas").select("id, nome").in("id",ma),ja=(xa||[]).reduce((t,l)=>(t[l.id]=l.nome,t),{}),pa=(O||[]).map(t=>{const l=ua[t.id]||0;return l===0?null:{...t,fazenda_nome:ja[t.fazenda_id]||"N/A",receptoras_count:l}}).filter(t=>t!==null).slice(0,y);A(pa),na(la||0)}catch(n){U(n,"Erro ao carregar protocolos"),A([])}finally{R(!1)}};return sa?a.jsx(M,{}):a.jsxs("div",{className:"space-y-6",children:[a.jsx(Pa,{title:"Protocolos de Sincronização",description:"Gerenciar protocolos em 2 passos",actions:a.jsxs(r,{onClick:()=>d("/protocolos/novo"),className:"bg-green-600 hover:bg-green-700",children:[a.jsx(X,{className:"w-4 h-4 mr-2"}),"Novo Protocolo (1º Passo)"]})}),a.jsxs(V,{children:[a.jsx(Z,{children:a.jsx(q,{children:"Filtros"})}),a.jsxs(G,{className:"space-y-4",children:[a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(_,{children:"Filtro Rápido"}),a.jsxs($,{value:P,onValueChange:T,children:[a.jsx(K,{children:a.jsx(Y,{placeholder:"Todos os protocolos"})}),a.jsxs(Q,{children:[a.jsx(p,{value:"all",children:"Todos os protocolos"}),a.jsx(p,{value:"aguardando_2_passo",children:"Aguardando 2º Passo"}),a.jsx(p,{value:"sincronizado",children:"Sincronizados"}),a.jsx(p,{value:"fechado",children:"Fechados"})]})]})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(_,{children:"Fazenda"}),a.jsxs($,{value:g||"all",onValueChange:s=>{E(s==="all"?"":s)},children:[a.jsx(K,{children:a.jsx(Y,{placeholder:"Todas as fazendas"})}),a.jsxs(Q,{children:[a.jsx(p,{value:"all",children:"Todas as fazendas"}),ea.map(s=>a.jsx(p,{value:s.id,children:s.nome},s.id))]})]})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(_,{children:"Data Início (de)"}),a.jsx(W,{value:f,onChange:S})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(_,{children:"Data Início (até)"}),a.jsx(W,{value:v,onChange:C})]})]}),a.jsxs("div",{className:"flex flex-wrap items-end gap-4",children:[a.jsxs("div",{className:"flex flex-wrap gap-2 flex-1",children:[a.jsx(_,{className:"w-full text-sm font-medium text-slate-700",children:"Atalhos rápidos:"}),a.jsx(r,{type:"button",variant:"outline",size:"sm",onClick:()=>{const s=new Date,e=new Date(s);e.setDate(s.getDate()-7);const n=e.toISOString().split("T")[0],c=s.toISOString().split("T")[0];S(n),C(c)},children:"Últimos 7 dias"}),a.jsx(r,{type:"button",variant:"outline",size:"sm",onClick:()=>{const s=new Date,e=new Date(s);e.setDate(s.getDate()-30);const n=e.toISOString().split("T")[0],c=s.toISOString().split("T")[0];S(n),C(c)},children:"Últimos 30 dias"}),a.jsx(r,{type:"button",variant:"outline",size:"sm",onClick:()=>{const s=new Date,e=new Date(s);e.setDate(s.getDate()-90);const n=e.toISOString().split("T")[0],c=s.toISOString().split("T")[0];S(n),C(c)},children:"Últimos 90 dias"})]}),a.jsxs(r,{type:"button",onClick:()=>{F(1),N(1,{fazenda:g,dataInicio:f,dataFim:v,status:P})},disabled:D,className:"bg-blue-600 hover:bg-blue-700",children:[a.jsx(Fa,{className:"w-4 h-4 mr-2"}),"Buscar"]})]})]})]}),a.jsxs(V,{children:[a.jsx(Z,{children:a.jsxs(q,{children:["Protocolos de Sincronização (",j.length,")"]})}),a.jsx(G,{children:D?a.jsx("div",{className:"py-8",children:a.jsx(M,{})}):j.length===0?a.jsx(Na,{title:"Nenhum protocolo encontrado",description:"Ajuste os filtros ou adicione um novo protocolo.",action:a.jsxs("div",{className:"flex gap-2",children:[a.jsx(r,{variant:"outline",onClick:()=>{E(""),S(""),C(""),T("all"),F(1),N(1,{fazenda:"",dataInicio:"",dataFim:"",status:"all"})},children:"Limpar filtros"}),a.jsxs(r,{onClick:()=>d("/protocolos/novo"),className:"bg-green-600 hover:bg-green-700",children:[a.jsx(X,{className:"w-4 h-4 mr-2"}),"Novo Protocolo"]})]})}):a.jsxs(a.Fragment,{children:[a.jsxs(Sa,{children:[a.jsx(va,{children:a.jsxs(J,{children:[a.jsx(u,{children:"Fazenda"}),a.jsx(u,{children:"Data Início"}),a.jsx(u,{children:"Data 2º Passo"}),a.jsx(u,{children:"Técnico 2º Passo"}),a.jsx(u,{children:"Receptoras"}),a.jsx(u,{children:"Status"}),a.jsx(u,{className:"text-right",children:"Ações"})]})}),a.jsx(Ca,{children:j.map(s=>{const e=s.status==="PASSO1_FECHADO"||s.status==="PRIMEIRO_PASSO_FECHADO",n=s.status==="FECHADO"||s.status==="EM_TE";return a.jsxs(J,{children:[a.jsx(x,{className:"font-medium",children:s.fazenda_nome}),a.jsx(x,{children:B(s.data_inicio)}),a.jsx(x,{children:s.passo2_data?B(s.passo2_data):"-"}),a.jsx(x,{children:s.passo2_tecnico_responsavel||"-"}),a.jsx(x,{children:s.receptoras_count}),a.jsx(x,{children:n||s.status==="FECHADO"||s.status==="EM_TE"?a.jsx(I,{variant:"secondary",className:"bg-slate-500 hover:bg-slate-600 text-white",children:"Fechado"}):s.status==="SINCRONIZADO"||s.status==="PASSO2_FECHADO"?a.jsx(I,{variant:"default",className:"bg-green-500 hover:bg-green-600 text-white",children:"Sincronizado"}):e?a.jsx(I,{variant:"secondary",className:"bg-yellow-500 hover:bg-yellow-600 text-white",children:"Aguardando 2º Passo"}):a.jsx(I,{variant:"default",children:s.status||"N/A"})}),a.jsx(x,{children:a.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e&&a.jsxs(r,{variant:"default",size:"sm",onClick:()=>d(`/protocolos/${s.id}/passo2`),children:[a.jsx(za,{className:"w-4 h-4 mr-2"}),"Iniciar 2º Passo"]}),a.jsxs(r,{variant:"outline",size:"sm",onClick:()=>d(`/protocolos/${s.id}/relatorio`),children:[a.jsx(ya,{className:"w-4 h-4 mr-2"}),"Ver Relatório"]})]})})]},s.id)})})]}),j.length>0&&a.jsxs("div",{className:"flex items-center justify-between pt-4 border-t",children:[a.jsxs("div",{className:"text-sm text-slate-600",children:["Página ",h," - Mostrando ",j.length," protocolos"]}),a.jsxs("div",{className:"flex gap-2",children:[a.jsxs(r,{variant:"outline",size:"sm",onClick:async()=>{const s=Math.max(1,h-1);F(s),await N(s)},disabled:h===1||D,children:[a.jsx(_a,{className:"w-4 h-4"}),"Anterior"]}),a.jsxs(r,{variant:"outline",size:"sm",onClick:async()=>{const s=h+1;F(s),await N(s)},disabled:j.length<y||D,children:["Próxima",a.jsx(Da,{className:"w-4 h-4"})]})]})]})]})})]})]})}export{ss as default};
