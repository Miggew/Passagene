import{c as Sa,r as e,s as k,a as Pa,j as a,g as $,h as c}from"./index-CWtHucPz.js";import{C as K,a as Y,b as Q,c as U}from"./use-toast-C_ednEV-.js";import{T as va,a as Ca,b as ra,c as C,d as Fa,e as F}from"./table-2v-HqcxP.js";import{S as W,a as X,b as aa,c as sa,d as N}from"./select-BUr2m4f3.js";import{B as R}from"./badge-DewFfdNp.js";import{L as z}from"./label-CDN-yMr6.js";import{P as Da}from"./PageHeader-DqMTzrbX.js";import{E as Na}from"./EmptyState-B00kV8BS.js";import{f as oa}from"./dateUtils-eJ5e6apA.js";import{D as ea,C as _a}from"./DatePickerBR-D4MNcuwK.js";import{h as ta}from"./error-handler-DHghZuf4.js";import{P as ia}from"./plus-CgYPqLq7.js";import{S as za}from"./search-B6nVOFfl.js";import{a as ba}from"./chevron-right-CY2M1G_-.js";import{F as ya}from"./file-text-D2kMcbSG.js";import"./index-RvRMy3My.js";import"./index-H2w26JuE.js";import"./check-D_BDiPDp.js";import"./popover-hCBfJPXC.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const wa=Sa("CirclePlay",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polygon",{points:"10 8 16 12 10 16 10 8",key:"1cimsy"}]]),na="protocolos_filtros",H=50,Ia=()=>{try{const s=localStorage.getItem(na);return s?JSON.parse(s):{}}catch{return{}}};function Oa(){const s=Ia(),[d,i]=e.useState(!0),[l,D]=e.useState(!1),[b,y]=e.useState([]),[w,L]=e.useState([]),[I,B]=e.useState(0),O=s.filtroStatus&&s.filtroStatus!=="all"?s.filtroStatus:"aguardando_2_passo",[f,g]=e.useState(O),[u,A]=e.useState(s.fazendaFilter??""),[h,x]=e.useState(s.filtroDataInicio??""),[S,P]=e.useState(s.filtroDataFim??""),[v,E]=e.useState(s.protocolosPage??1);e.useEffect(()=>{const m={filtroStatus:f,fazendaFilter:u,filtroDataInicio:h,filtroDataFim:S,protocolosPage:v};localStorage.setItem(na,JSON.stringify(m))},[f,u,h,S,v]);const T=e.useCallback(async()=>{const{data:m,error:o}=await k.from("fazendas").select("*").order("nome",{ascending:!0});if(o)throw o;L(m||[])},[]),_=e.useCallback(async(m,o)=>{try{D(!0);const j=(o==null?void 0:o.fazendaFilter)!==void 0?o.fazendaFilter:u,Z=(o==null?void 0:o.filtroDataInicio)!==void 0?o.filtroDataInicio:h,q=(o==null?void 0:o.filtroDataFim)!==void 0?o.filtroDataFim:S,M=(o==null?void 0:o.filtroStatus)!==void 0?o.filtroStatus:f,G=((m!==void 0?m:v)-1)*H,da=G+H*2-1;let r=k.from("protocolos_sincronizacao").select("*",{count:"exact"});j&&j!=="all"&&(r=r.eq("fazenda_id",j)),Z&&(r=r.gte("data_inicio",Z)),q&&(r=r.lte("data_inicio",q)),M==="aguardando_2_passo"?r=r.in("status",["PASSO1_FECHADO","PRIMEIRO_PASSO_FECHADO"]):M==="sincronizado"?r=r.in("status",["SINCRONIZADO","PASSO2_FECHADO"]):M==="fechado"&&(r=r.in("status",["FECHADO","EM_TE"])),r=r.order("data_inicio",{ascending:!1}).range(G,da);const{data:V,error:J,count:ma}=await r;if(J)throw J;const ua=(V||[]).map(t=>t.id),ha=[...new Set((V||[]).map(t=>t.fazenda_id))],{data:xa}=await k.from("protocolo_receptoras").select("protocolo_id").in("protocolo_id",ua),ja=(xa||[]).reduce((t,p)=>(t[p.protocolo_id]=(t[p.protocolo_id]||0)+1,t),{}),{data:pa}=await k.from("fazendas").select("id, nome").in("id",ha),fa=(pa||[]).reduce((t,p)=>(t[p.id]=p.nome,t),{}),ga=(V||[]).map(t=>{const p=ja[t.id]||0;return p===0?null:{...t,fazenda_nome:fa[t.fazenda_id]||"N/A",receptoras_count:p}}).filter(t=>t!==null).slice(0,H);y(ga),B(ma||0)}catch(j){ta(j,"Erro ao carregar protocolos"),y([])}finally{D(!1)}},[u,h,S,f,v]),n=e.useCallback(async()=>{try{i(!0),await T(),await _()}catch(m){ta(m,"Erro ao carregar dados")}finally{i(!1)}},[T,_]),la=e.useCallback(()=>{A(""),x(""),P(""),g("all"),E(1)},[]),ca=e.useCallback(m=>{const o=new Date,j=new Date(o);j.setDate(o.getDate()-m),x(j.toISOString().split("T")[0]),P(o.toISOString().split("T")[0])},[]);return{loading:d,loadingProtocolos:l,protocolos:b,fazendas:w,protocolosTotalCount:I,filtroStatus:f,setFiltroStatus:g,fazendaFilter:u,setFazendaFilter:A,filtroDataInicio:h,setFiltroDataInicio:x,filtroDataFim:S,setFiltroDataFim:P,protocolosPage:v,setProtocolosPage:E,pageSize:H,loadData:n,loadProtocolos:_,limparFiltros:la,aplicarAtalhoData:ca}}function es(){const s=Pa(),{loading:d,loadingProtocolos:i,protocolos:l,fazendas:D,filtroStatus:b,setFiltroStatus:y,fazendaFilter:w,setFazendaFilter:L,filtroDataInicio:I,setFiltroDataInicio:B,filtroDataFim:O,setFiltroDataFim:f,protocolosPage:g,setProtocolosPage:u,pageSize:A,loadData:h,loadProtocolos:x,limparFiltros:S,aplicarAtalhoData:P}=Oa();e.useEffect(()=>{h()},[h]);const v=()=>{u(1),x(1,{fazendaFilter:w,filtroDataInicio:I,filtroDataFim:O,filtroStatus:b})},E=()=>{S(),x(1,{fazendaFilter:"",filtroDataInicio:"",filtroDataFim:"",filtroStatus:"all"})},T=async()=>{const n=Math.max(1,g-1);u(n),await x(n)},_=async()=>{const n=g+1;u(n),await x(n)};return d?a.jsx($,{}):a.jsxs("div",{className:"space-y-6",children:[a.jsx(Da,{title:"Protocolos de Sincronização",description:"Gerenciar protocolos em 2 passos",actions:a.jsxs(c,{onClick:()=>s("/protocolos/novo"),className:"bg-green-600 hover:bg-green-700",children:[a.jsx(ia,{className:"w-4 h-4 mr-2"}),"Novo Protocolo (1º Passo)"]})}),a.jsxs(K,{children:[a.jsx(Y,{children:a.jsx(Q,{children:"Filtros"})}),a.jsxs(U,{className:"space-y-4",children:[a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(z,{children:"Filtro Rápido"}),a.jsxs(W,{value:b,onValueChange:y,children:[a.jsx(X,{children:a.jsx(aa,{placeholder:"Todos os protocolos"})}),a.jsxs(sa,{children:[a.jsx(N,{value:"all",children:"Todos os protocolos"}),a.jsx(N,{value:"aguardando_2_passo",children:"Aguardando 2º Passo"}),a.jsx(N,{value:"sincronizado",children:"Sincronizados"}),a.jsx(N,{value:"fechado",children:"Fechados"})]})]})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(z,{children:"Fazenda"}),a.jsxs(W,{value:w||"all",onValueChange:n=>L(n==="all"?"":n),children:[a.jsx(X,{children:a.jsx(aa,{placeholder:"Todas as fazendas"})}),a.jsxs(sa,{children:[a.jsx(N,{value:"all",children:"Todas as fazendas"}),D.map(n=>a.jsx(N,{value:n.id,children:n.nome},n.id))]})]})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(z,{children:"Data Início (de)"}),a.jsx(ea,{value:I,onChange:B})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(z,{children:"Data Início (até)"}),a.jsx(ea,{value:O,onChange:f})]})]}),a.jsxs("div",{className:"flex flex-wrap items-end gap-4",children:[a.jsxs("div",{className:"flex flex-wrap gap-2 flex-1",children:[a.jsx(z,{className:"w-full text-sm font-medium text-slate-700",children:"Atalhos rápidos:"}),a.jsx(c,{type:"button",variant:"outline",size:"sm",onClick:()=>P(7),children:"Últimos 7 dias"}),a.jsx(c,{type:"button",variant:"outline",size:"sm",onClick:()=>P(30),children:"Últimos 30 dias"}),a.jsx(c,{type:"button",variant:"outline",size:"sm",onClick:()=>P(90),children:"Últimos 90 dias"})]}),a.jsxs(c,{type:"button",onClick:v,disabled:i,className:"bg-blue-600 hover:bg-blue-700",children:[a.jsx(za,{className:"w-4 h-4 mr-2"}),"Buscar"]})]})]})]}),a.jsxs(K,{children:[a.jsx(Y,{children:a.jsxs(Q,{children:["Protocolos de Sincronização (",l.length,")"]})}),a.jsx(U,{children:i?a.jsx("div",{className:"py-8",children:a.jsx($,{})}):l.length===0?a.jsx(Na,{title:"Nenhum protocolo encontrado",description:"Ajuste os filtros ou adicione um novo protocolo.",action:a.jsxs("div",{className:"flex gap-2",children:[a.jsx(c,{variant:"outline",onClick:E,children:"Limpar filtros"}),a.jsxs(c,{onClick:()=>s("/protocolos/novo"),className:"bg-green-600 hover:bg-green-700",children:[a.jsx(ia,{className:"w-4 h-4 mr-2"}),"Novo Protocolo"]})]})}):a.jsxs(a.Fragment,{children:[a.jsx(Aa,{protocolos:l,navigate:s}),a.jsxs("div",{className:"flex items-center justify-between pt-4 border-t",children:[a.jsxs("div",{className:"text-sm text-slate-600",children:["Página ",g," - Mostrando ",l.length," protocolos"]}),a.jsxs("div",{className:"flex gap-2",children:[a.jsxs(c,{variant:"outline",size:"sm",onClick:T,disabled:g===1||i,children:[a.jsx(_a,{className:"w-4 h-4"}),"Anterior"]}),a.jsxs(c,{variant:"outline",size:"sm",onClick:_,disabled:l.length<A||i,children:["Próxima",a.jsx(ba,{className:"w-4 h-4"})]})]})]})]})})]})]})}function Aa({protocolos:s,navigate:d}){return a.jsxs(va,{children:[a.jsx(Ca,{children:a.jsxs(ra,{children:[a.jsx(C,{children:"Fazenda"}),a.jsx(C,{children:"Data Início"}),a.jsx(C,{children:"Data 2º Passo"}),a.jsx(C,{children:"Técnico 2º Passo"}),a.jsx(C,{children:"Receptoras"}),a.jsx(C,{children:"Status"}),a.jsx(C,{className:"text-right",children:"Ações"})]})}),a.jsx(Fa,{children:s.map(i=>a.jsx(Ea,{protocolo:i,navigate:d},i.id))})]})}function Ea({protocolo:s,navigate:d}){const i=s.status==="PASSO1_FECHADO"||s.status==="PRIMEIRO_PASSO_FECHADO",l=s.status==="FECHADO"||s.status==="EM_TE",D=s.status==="SINCRONIZADO"||s.status==="PASSO2_FECHADO";return a.jsxs(ra,{children:[a.jsx(F,{className:"font-medium",children:s.fazenda_nome}),a.jsx(F,{children:oa(s.data_inicio)}),a.jsx(F,{children:s.passo2_data?oa(s.passo2_data):"-"}),a.jsx(F,{children:s.passo2_tecnico_responsavel||"-"}),a.jsx(F,{children:s.receptoras_count}),a.jsx(F,{children:a.jsx(Ta,{isFechado:l,isSincronizado:D,isAguardando2Passo:i,status:s.status})}),a.jsx(F,{children:a.jsxs("div",{className:"flex items-center justify-end gap-2",children:[i&&a.jsxs(c,{variant:"default",size:"sm",onClick:()=>d(`/protocolos/${s.id}/passo2`),children:[a.jsx(wa,{className:"w-4 h-4 mr-2"}),"Iniciar 2º Passo"]}),a.jsxs(c,{variant:"outline",size:"sm",onClick:()=>d(`/protocolos/${s.id}/relatorio`),children:[a.jsx(ya,{className:"w-4 h-4 mr-2"}),"Ver Relatório"]})]})})]})}function Ta({isFechado:s,isSincronizado:d,isAguardando2Passo:i,status:l}){return s?a.jsx(R,{variant:"secondary",className:"bg-slate-500 hover:bg-slate-600 text-white",children:"Fechado"}):d?a.jsx(R,{variant:"default",className:"bg-green-500 hover:bg-green-600 text-white",children:"Sincronizado"}):i?a.jsx(R,{variant:"secondary",className:"bg-yellow-500 hover:bg-yellow-600 text-white",children:"Aguardando 2º Passo"}):a.jsx(R,{variant:"default",children:l||"N/A"})}export{es as default};
