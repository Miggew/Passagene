import{r as g,s as v,j as e,g as je}from"./index-CWtHucPz.js";import{e as Re,b as De}from"./dataEnrichment-C6Uyclml.js";import{u as we,C as Ae,a as Se,c as Te}from"./use-toast-C_ednEV-.js";import{T as Ne,a as Ce,b as se,c as A,d as Fe,e as S}from"./table-2v-HqcxP.js";import{S as Pe,a as Ge,b as He,c as Ie,d as W}from"./select-BUr2m4f3.js";import{I as Le}from"./input-bF23Jkur.js";import{T as ye}from"./textarea-EUsZECCO.js";import{P as ze}from"./PageHeader-DqMTzrbX.js";import{S as Oe}from"./StatusBadge-B_pnPC6h.js";import{v as $e}from"./receptoraStatus-DfJ2QNI_.js";import{D as Ve}from"./DatePickerBR-D4MNcuwK.js";import{g as qe,u as Me,a as Qe,c as Ue,F as Ze,L as Be,A as ke,b as Je,v as re,d as ie}from"./LoteHeader-CIdybpiz.js";import"./index-RvRMy3My.js";import"./index-H2w26JuE.js";import"./check-D_BDiPDp.js";import"./badge-DewFfdNp.js";import"./statusLabels-IklKT8dE.js";import"./chevron-right-CY2M1G_-.js";import"./popover-hCBfJPXC.js";import"./dateUtils-eJ5e6apA.js";import"./label-CDN-yMr6.js";import"./EmptyState-B00kV8BS.js";import"./circle-check-big-WLdPQf4E.js";import"./lock-BwRoEkXK.js";function xa(){const{toast:T}=we(),X=qe(),[R,ne]=g.useState(""),[c,I]=g.useState(null),[b,N]=g.useState([]),[ce,Y]=g.useState(!1),[de,ee]=g.useState(!1),[ae,C]=g.useState(!1),[L,F]=g.useState({}),[f,y]=g.useState({veterinario_responsavel:"",tecnico_responsavel:""}),{fazendas:Q,loadFazendas:te}=Me({statusReceptoraFiltro:"SERVIDA",tipoDiagnosticoFiltro:"DG"}),le=g.useCallback((a,s)=>({...a,veterinario_dg:s==null?void 0:s.veterinario_responsavel,tecnico_dg:s==null?void 0:s.tecnico_responsavel}),[]),{lotesTE:_e,loading:ue,loadLotesTE:oe}=Qe({statusReceptoraFiltro:"SERVIDA",tipoDiagnosticoFiltro:"DG",transformLote:le});g.useEffect(()=>{te()},[te]),g.useEffect(()=>{var a;if(R){const s=(a=Q.find(u=>u.id===R))==null?void 0:a.nome;oe(R,s)}else I(null),N([]),F({})},[R]),g.useEffect(()=>{c?c.status==="FECHADO"?(y({veterinario_responsavel:c.veterinario_dg||"",tecnico_responsavel:c.tecnico_dg||""}),C(!1),O(c)):c.veterinario_dg&&c.tecnico_dg?(y({veterinario_responsavel:c.veterinario_dg,tecnico_responsavel:c.tecnico_dg}),C(!1),O(c)):(y({veterinario_responsavel:"",tecnico_responsavel:""}),C(!0),N([]),F({})):(N([]),F({}),C(!1))},[c]);const me=async()=>{if(!re(f)){T({title:"Erro de validação",description:"Veterinário e técnico responsáveis são obrigatórios",variant:"destructive"});return}if(!c)return;const a={...c,veterinario_dg:f.veterinario_responsavel.trim(),tecnico_dg:f.tecnico_responsavel.trim(),status:"ABERTO"};I(a),C(!1),await O(a)},O=async a=>{var s,u;try{Y(!0);const{data:l,error:t}=await v.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",a.fazenda_id);if(t)throw t;const m=(l==null?void 0:l.map(o=>o.receptora_id))||[];if(m.length===0){N([]);return}const[P,G]=await Promise.all([v.from("receptoras").select("id, identificacao, nome, status_reprodutivo").in("id",m).eq("status_reprodutivo","SERVIDA"),v.from("transferencias_embrioes").select("id, receptora_id, embriao_id, data_te").in("receptora_id",m).eq("data_te",a.data_te).eq("status_te","REALIZADA")]);if(P.error)throw P.error;if(G.error)throw G.error;const D=P.data,i=G.data;if(!i||i.length===0){N([]);return}const n=(D==null?void 0:D.map(o=>o.id))||[],d=i.map(o=>o.embriao_id).filter(Boolean);let r=new Map;if(d.length>0){const{data:o,error:_}=await v.from("embrioes").select("id, identificacao, classificacao, lote_fiv_id, lote_fiv_acasalamento_id").in("id",d);if(_)throw _;r=new Map((o==null?void 0:o.map(E=>[E.id,E]))||[])}const p=[...new Set(Array.from(r.values()).map(o=>o.lote_fiv_id).filter(Boolean))],h=Re(Array.from(r.values())),[j,w,Z]=await Promise.all([p.length>0?v.from("lotes_fiv").select("id, data_abertura").in("id",p):Promise.resolve({data:[],error:null}),De(h),v.from("diagnosticos_gestacao").select("*").in("receptora_id",n).eq("tipo_diagnostico","DG").eq("data_te",a.data_te).order("data_diagnostico",{ascending:!1})]);if(j.error)throw j.error;const ve=new Map(((s=j.data)==null?void 0:s.map(o=>[o.id,o]))||[]),{doadorasMap:he,tourosMap:Ee}=w,B=new Map;(u=Z.data)==null||u.forEach(o=>{B.has(o.receptora_id)||B.set(o.receptora_id,o)});const $=new Map;i.forEach(o=>{const _=`${o.receptora_id}-${o.data_te}`;$.has(_)||$.set(_,[]),$.get(_).push(o)});const V=[];$.forEach(o=>{const _=o[0],E=D==null?void 0:D.find(M=>M.id===_.receptora_id);if(!E)return;const z=[];let q=null,J=null;if(o.forEach(M=>{const x=r.get(M.embriao_id);if(!x)return;const K=ve.get(x.lote_fiv_id);if(!K)return;q||(q=K.data_abertura,J=Ue(K.data_abertura));const xe=x.lote_fiv_acasalamento_id?he.get(x.lote_fiv_acasalamento_id):void 0,be=x.lote_fiv_acasalamento_id?Ee.get(x.lote_fiv_acasalamento_id):void 0;z.push({te_id:M.id,embriao_id:x.id,embriao_identificacao:x.identificacao,embriao_classificacao:x.classificacao,lote_fiv_id:x.lote_fiv_id,lote_fiv_acasalamento_id:x.lote_fiv_acasalamento_id,doadora_registro:xe,touro_nome:be})}),z.length===0||!q||J===null)return;const H=B.get(_.receptora_id);V.push({receptora_id:_.receptora_id,brinco:E.identificacao,nome:E.nome,status_reprodutivo:E.status_reprodutivo,data_te:_.data_te,embrioes:z,data_abertura_lote:q,dias_gestacao:J,diagnostico_existente:H?{id:H.id,data_diagnostico:H.data_diagnostico,resultado:H.resultado,numero_gestacoes:H.numero_gestacoes||void 0,observacoes:H.observacoes||void 0}:void 0})}),V.sort((o,_)=>o.brinco.localeCompare(_.brinco)),N(V);const k={};V.forEach(o=>{var _;if(o.diagnostico_existente){const E=o.diagnostico_existente.resultado,z=((_=o.diagnostico_existente.numero_gestacoes)==null?void 0:_.toString())||(E==="PRENHE"||E==="RETOQUE"?"1":"");k[o.receptora_id]={resultado:E,numero_gestacoes:z,observacoes:o.diagnostico_existente.observacoes||"",data_diagnostico:o.diagnostico_existente.data_diagnostico}}else k[o.receptora_id]={resultado:"",numero_gestacoes:"",observacoes:"",data_diagnostico:X}}),F(k)}catch(l){T({title:"Erro ao carregar receptoras",description:l instanceof Error?l.message:"Erro desconhecido",variant:"destructive"}),N([])}finally{Y(!1)}},pe=(a,s)=>{F(u=>{const l=u[a]||{};let t=l.numero_gestacoes||"";return(s==="PRENHE"||s==="RETOQUE")&&!t?t="1":(s==="VAZIA"||s==="")&&(t=""),{...u,[a]:{...l,resultado:s,numero_gestacoes:t}}})},U=(a,s,u)=>{F(l=>({...l,[a]:{...l[a],[s]:u}}))},fe=async()=>{var s,u,l;if(!c)return;if(!re(f)){T({title:"Erro de validação",description:"Veterinário e técnico responsáveis são obrigatórios",variant:"destructive"});return}const a=b.filter(t=>{const m=L[t.receptora_id];return!m||!m.resultado||!m.data_diagnostico});if(a.length>0){T({title:"Erro de validação",description:`Há ${a.length} receptora(s) sem resultado definido`,variant:"destructive"});return}try{ee(!0);for(const i of b){const n=i.status_reprodutivo||"VAZIA",d=$e(n,"REALIZAR_DG");if(!d.valido){T({title:"Erro de validação",description:`Receptora ${i.brinco}: ${d.mensagem}`,variant:"destructive"});return}}const t=[],m=[],P=[];if(b.forEach(i=>{var h,j,w;const n=L[i.receptora_id];if(!n||!n.resultado||!n.data_diagnostico)return;const d={receptora_id:i.receptora_id,data_te:i.data_te,tipo_diagnostico:"DG",data_diagnostico:n.data_diagnostico,resultado:n.resultado,observacoes:((h=n.observacoes)==null?void 0:h.trim())||void 0};n.resultado==="PRENHE"||n.resultado==="RETOQUE"?d.numero_gestacoes=n.numero_gestacoes?parseInt(n.numero_gestacoes):1:d.numero_gestacoes=0,(j=f.veterinario_responsavel)!=null&&j.trim()&&(d.veterinario_responsavel=f.veterinario_responsavel.trim()),(w=f.tecnico_responsavel)!=null&&w.trim()&&(d.tecnico_responsavel=f.tecnico_responsavel.trim()),i.diagnostico_existente?m.push({id:i.diagnostico_existente.id,...d}):t.push(d);let r,p=null;n.resultado==="PRENHE"?(r="PRENHE",p=ie(i.data_abertura_lote)):n.resultado==="RETOQUE"?(r="PRENHE_RETOQUE",p=ie(i.data_abertura_lote)):r="VAZIA",P.push({receptora_id:i.receptora_id,status:r,dataParto:p})}),t.length>0){const{data:i}=await v.from("diagnosticos_gestacao").select("id, receptora_id, data_te, tipo_diagnostico").in("receptora_id",[...new Set(t.map(r=>r.receptora_id))]).eq("tipo_diagnostico","DG"),n=new Map;i==null||i.forEach(r=>{const p=`${r.receptora_id}-${r.data_te}-${r.tipo_diagnostico}`;n.set(p,r.id)});const d=[];if(t.forEach(r=>{const p=`${r.receptora_id}-${r.data_te}-${r.tipo_diagnostico}`,h=n.get(p);h?m.push({id:h,...r}):d.push(r)}),d.length>0){const{error:r}=await v.from("diagnosticos_gestacao").insert(d);if(r)if((s=r.message)!=null&&s.includes("column")||r.code==="42703"){const p=d.map(({veterinario_responsavel:j,tecnico_responsavel:w,...Z})=>Z),{error:h}=await v.from("diagnosticos_gestacao").insert(p);if(h)throw new Error(`Erro ao inserir diagnósticos: ${h.message}`)}else throw new Error(`Erro ao inserir diagnósticos: ${r.message}`)}}for(const i of m){const{id:n,...d}=i;let{error:r}=await v.from("diagnosticos_gestacao").update(d).eq("id",n);if(r&&((u=r.message)!=null&&u.includes("column")||r.code==="42703")){const{veterinario_responsavel:p,tecnico_responsavel:h,...j}=d,{error:w}=await v.from("diagnosticos_gestacao").update(j).eq("id",n);if(w)throw new Error(`Erro ao atualizar diagnóstico: ${w.message}`)}else if(r)throw new Error(`Erro ao atualizar diagnóstico: ${r.message}`)}for(const i of P){const n={status_reprodutivo:i.status};i.dataParto?n.data_provavel_parto=i.dataParto:i.status==="VAZIA"&&(n.data_provavel_parto=null);const{error:d}=await v.from("receptoras").update(n).eq("id",i.receptora_id);if(d)throw new Error("Erro ao atualizar status da receptora")}const G=b.every(i=>{const n=L[i.receptora_id];return n&&n.resultado&&n.data_diagnostico});I({...c,veterinario_dg:f.veterinario_responsavel.trim(),tecnico_dg:f.tecnico_responsavel.trim(),status:G?"FECHADO":"ABERTO"}),T({title:"Lote salvo com sucesso",description:G?`${b.length} diagnóstico(s) registrado(s). Lote fechado.`:`${b.length} diagnóstico(s) registrado(s)`});const D=(l=Q.find(i=>i.id===R))==null?void 0:l.nome;await oe(R,D),c&&await O(c)}catch(t){T({title:"Erro ao salvar lote",description:t instanceof Error?t.message:"Erro desconhecido",variant:"destructive"})}finally{ee(!1)}},ge=b.every(a=>{const s=L[a.receptora_id];return s&&s.resultado&&s.data_diagnostico});return e.jsxs("div",{className:"space-y-6",children:[e.jsx(ze,{title:"Diagnóstico de Gestação (DG)",description:"Registrar diagnósticos de gestação por lote de TE"}),e.jsx(Ze,{fazendas:Q,fazendaSelecionada:R,onFazendaChange:ne}),R&&e.jsx(Be,{title:"Lotes de Transferência de Embriões",emptyTitle:"Nenhum lote de TE encontrado",emptyDescription:"Selecione outra fazenda ou verifique se há transferências registradas.",lotesTE:_e,loteSelecionado:c,loading:ue,veterinarioLabel:"Vet. DG",tecnicoLabel:"Téc. DG",getVeterinario:a=>a.veterinario_dg,getTecnico:a=>a.tecnico_dg,onSelectLote:I}),c&&ae&&e.jsx(ke,{title:"Abrir Lote de DG",loteSelecionado:c,loteFormData:f,onFormChange:y,onAbrirLote:me,onCancelar:()=>{C(!1),I(null)}}),c&&!ae&&b.length>0&&e.jsxs(Ae,{children:[e.jsx(Se,{children:e.jsx(Je,{loteSelecionado:c,receptorasCount:b.length,loteFormData:f,onFormChange:y,veterinarioLabel:"Veterinário Responsável (DG)",tecnicoLabel:"Técnico Responsável (DG)",onSalvarLote:fe,submitting:de,canSave:ge})}),e.jsx(Te,{children:ce?e.jsx(je,{}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(Ne,{children:[e.jsx(Ce,{children:e.jsxs(se,{children:[e.jsx(A,{children:"Receptora"}),e.jsx(A,{children:"Dias Gestação"}),e.jsx(A,{children:"Embrião(ões)"}),e.jsx(A,{children:"Doadora / Touro"}),e.jsx(A,{children:"Data DG"}),e.jsx(A,{children:"Resultado"}),e.jsx(A,{children:"Nº Gest."}),e.jsx(A,{children:"Observações"})]})}),e.jsx(Fe,{children:b.map(a=>{var l;const s=L[a.receptora_id]||{resultado:"",numero_gestacoes:"",observacoes:"",data_diagnostico:X},u=!!a.diagnostico_existente;return e.jsxs(se,{children:[e.jsxs(S,{className:"font-medium",children:[a.brinco,a.nome&&e.jsxs("span",{className:"text-slate-500 text-sm ml-2",children:["(",a.nome,")"]}),u&&e.jsx(Oe,{status:((l=a.diagnostico_existente)==null?void 0:l.resultado)||"",className:"ml-2"})]}),e.jsxs(S,{children:[e.jsx("span",{className:"font-semibold",children:a.dias_gestacao})," dias"]}),e.jsx(S,{children:e.jsx("div",{className:"space-y-1",children:a.embrioes.map((t,m)=>e.jsx("div",{className:"text-sm",children:e.jsxs("div",{className:"font-medium",children:[t.embriao_identificacao||`Embrião ${m+1}`,t.embriao_classificacao&&e.jsxs("span",{className:"text-slate-500 ml-2",children:["(",t.embriao_classificacao,")"]})]})},t.te_id))})}),e.jsx(S,{children:e.jsx("div",{className:"space-y-1",children:a.embrioes.map(t=>e.jsx("div",{className:"text-sm",children:e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:t.doadora_registro||"-"}),t.doadora_registro&&t.touro_nome&&" × ",e.jsx("span",{className:"font-medium",children:t.touro_nome||""})]})},t.te_id))})}),e.jsx(S,{children:e.jsx(Ve,{value:s.data_diagnostico,onChange:t=>U(a.receptora_id,"data_diagnostico",t||""),className:"w-36",disabled:c.status==="FECHADO"})}),e.jsx(S,{children:e.jsxs(Pe,{value:s.resultado,onValueChange:t=>pe(a.receptora_id,t),disabled:c.status==="FECHADO",children:[e.jsx(Ge,{className:"w-32",children:e.jsx(He,{placeholder:"Resultado"})}),e.jsxs(Ie,{children:[e.jsx(W,{value:"PRENHE",children:"PRENHE"}),e.jsx(W,{value:"VAZIA",children:"VAZIA"}),e.jsx(W,{value:"RETOQUE",children:"RETOQUE"})]})]})}),e.jsx(S,{children:s.resultado==="PRENHE"||s.resultado==="RETOQUE"?e.jsx(Le,{type:"number",min:"1",max:"3",value:s.numero_gestacoes,onChange:t=>U(a.receptora_id,"numero_gestacoes",t.target.value),placeholder:"1-3",className:"w-20",disabled:c.status==="FECHADO"}):e.jsx("span",{className:"text-slate-400",children:"-"})}),e.jsx(S,{children:e.jsx(ye,{value:s.observacoes,onChange:t=>U(a.receptora_id,"observacoes",t.target.value),placeholder:"Observações",rows:2,className:"w-48",disabled:c.status==="FECHADO"})})]},a.receptora_id)})})]})})})]})]})}export{xa as default};
