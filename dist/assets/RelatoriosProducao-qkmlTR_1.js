import{c as fe,a as he,r as o,s as c,j as e,ai as X,B as z}from"./index-BPMeM9-O.js";import{C as v,d as _,a as ge,b as je,c as Ne}from"./card-8azKTSNJ.js";import{I as ve}from"./input-tqcTRdPv.js";import{B}from"./badge-CeJDYfYs.js";import{S as J,a as K,b as W,c as Y,d as A}from"./select-La4nrp5K.js";import{u as _e}from"./useClienteFilter-CwSUSM41.js";import{P as be}from"./PageHeader-DQ4rM2jO.js";import{D as ee}from"./DatePickerBR-CHtWVvxh.js";import{e as ye}from"./exportPdf--R_Q0DDd.js";import{A as O}from"./activity-CIWhM6rb.js";import{S as we}from"./search-SyV5imYB.js";import{C as ze}from"./calendar-CuUQg-xw.js";import{X as Fe}from"./x-BxiwAMrM.js";import{F as Se}from"./file-text-CtxiCcm9.js";import{E as Me}from"./eye-CZithoXn.js";import{f as te,p as Ce}from"./pt-BR-CyDikW87.js";import"./index-C5PY5DOm.js";import"./check-Bdb-Yd05.js";import"./chevron-right-BkIAhNYS.js";import"./popover-D1vF_0kq.js";import"./dateUtils-eJ5e6apA.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ae=fe("Percent",[["line",{x1:"19",x2:"5",y1:"5",y2:"19",key:"1x9vlm"}],["circle",{cx:"6.5",cy:"6.5",r:"2.5",key:"4mh3h7"}],["circle",{cx:"17.5",cy:"17.5",r:"2.5",key:"1mdrzq"}]]),P=15;function We(){const se=he(),{clienteIdFilter:x}=_e(),[R,ae]=o.useState([]),[b,q]=o.useState("all"),[E,V]=o.useState("all"),[L,$]=o.useState(""),[f,H]=o.useState(""),[h,Z]=o.useState(""),[D,G]=o.useState([]),[y,re]=o.useState({totalLotes:0,totalOocitos:0,totalEmbrioes:0,taxaMediaSucesso:0,totalAspiracoes:0,totalProtocolos:0}),[l,F]=o.useState(1),[g,Q]=o.useState(!0);o.useEffect(()=>{ie()},[x]),o.useEffect(()=>{oe(),F(1)},[b,E,f,h,x]);const ie=async()=>{let t=c.from("fazendas").select("*").order("nome");x&&(t=t.eq("cliente_id",x));const{data:s}=await t;ae(s??[])},oe=async()=>{Q(!0);try{let t=[];if(x){const{data:s}=await c.from("fazendas").select("id").eq("cliente_id",x);t=(s==null?void 0:s.map(a=>a.id))??[]}await Promise.all([ce(t),le(t)])}catch(t){console.error("Erro ao carregar dados:",t)}finally{Q(!1)}},ce=async t=>{let s=c.from("pacotes_aspiracao").select("id, fazenda_id, fazendas(nome)");x&&t.length>0&&(s=s.in("fazenda_id",t)),b!=="all"&&(s=s.eq("fazenda_id",b));const{data:a}=await s,d=new Map((a==null?void 0:a.map(r=>[r.id,r]))??[]),S=Array.from(d.keys());if(S.length===0){G([]);return}let m=c.from("lotes_fiv").select(`
        id,
        codigo,
        data_fiv,
        pacote_aspiracao_id,
        status
      `).in("pacote_aspiracao_id",S).order("data_fiv",{ascending:!1});E!=="all"&&(m=m.eq("status",E)),f&&(m=m.gte("data_fiv",f)),h&&(m=m.lte("data_fiv",h));const{data:p}=await m,k=(p==null?void 0:p.map(r=>r.id))??[],{data:u}=await c.from("aspiracoes_doadoras").select("pacote_id, total_oocitos").in("pacote_id",S),N=new Map;u==null||u.forEach(r=>{const i=N.get(r.pacote_id)??0;N.set(r.pacote_id,i+(r.total_oocitos??0))});const{data:M}=await c.from("embrioes").select("lote_fiv_id").in("lote_fiv_id",k),w=new Map;M==null||M.forEach(r=>{w.set(r.lote_fiv_id,(w.get(r.lote_fiv_id)??0)+1)}),G((p==null?void 0:p.map(r=>{var U;const i=d.get(r.pacote_aspiracao_id),C=N.get(r.pacote_aspiracao_id)??0,I=w.get(r.id)??0,ue=C>0?Math.round(I/C*100):0;return{id:r.id,codigo:r.codigo,data_fiv:r.data_fiv,fazenda_nome:((U=i==null?void 0:i.fazendas)==null?void 0:U.nome)??"N/A",total_oocitos:C,total_embrioes:I,taxa_sucesso:ue,status:r.status}}))??[])},le=async t=>{var w,r;const s=new Date;s.setDate(s.getDate()-90);const a=te(s,"yyyy-MM-dd"),[d,S,m]=await Promise.all([c.from("lotes_fiv").select("id, pacote_aspiracao_id",{count:"exact"}).gte("data_fiv",a),x&&t.length>0?c.from("pacotes_aspiracao").select("id",{count:"exact"}).in("fazenda_id",t).gte("data_aspiracao",a):c.from("pacotes_aspiracao").select("id",{count:"exact"}).gte("data_aspiracao",a),x&&t.length>0?c.from("protocolos_sincronizacao").select("id",{count:"exact"}).in("fazenda_id",t).gte("data_inicio",a):c.from("protocolos_sincronizacao").select("id",{count:"exact"}).gte("data_inicio",a)]),p=((w=d.data)==null?void 0:w.map(i=>i.pacote_aspiracao_id))??[],k=((r=d.data)==null?void 0:r.map(i=>i.id))??[];let u=0,N=0;if(p.length>0){const{data:i}=await c.from("aspiracoes_doadoras").select("total_oocitos").in("pacote_id",p);u=(i==null?void 0:i.reduce((C,I)=>C+(I.total_oocitos??0),0))??0}if(k.length>0){const{count:i}=await c.from("embrioes").select("id",{count:"exact",head:!0}).in("lote_fiv_id",k);N=i??0}const M=u>0?Math.round(N/u*100):0;re({totalLotes:d.count??0,totalOocitos:u,totalEmbrioes:N,taxaMediaSucesso:M,totalAspiracoes:S.count??0,totalProtocolos:m.count??0})},n=o.useMemo(()=>{if(!L.trim())return D;const t=L.toLowerCase();return D.filter(s=>{var a,d;return((a=s.codigo)==null?void 0:a.toLowerCase().includes(t))||((d=s.fazenda_nome)==null?void 0:d.toLowerCase().includes(t))})},[D,L]),j=Math.ceil(n.length/P),de=o.useMemo(()=>{const t=(l-1)*P;return n.slice(t,t+P)},[n,l]),ne=()=>{q("all"),V("all"),$(""),H(""),Z(""),F(1)},T=t=>{try{return te(new Date(t+"T12:00:00"),"dd/MM/yyyy",{locale:Ce})}catch{return t}},xe=t=>{switch(t){case"FINALIZADO":return e.jsx(B,{className:"bg-primary hover:bg-primary-dark",children:"Finalizado"});case"EM_ANDAMENTO":return e.jsx(B,{variant:"secondary",children:"Em Andamento"});default:return e.jsx(B,{variant:"outline",children:t})}},me=t=>{let s="bg-red-500/15 text-red-600 dark:text-red-400";return t>=40?s="bg-primary/15 text-primary":t>=25&&(s="bg-amber-500/15 text-amber-600 dark:text-amber-400"),e.jsxs("span",{className:`inline-flex items-center justify-center min-w-10 h-6 px-2 text-xs font-semibold rounded ${s}`,children:[t,"%"]})},pe=()=>{var a;if(n.length===0)return;const t=b!=="all"?(a=R.find(d=>d.id===b))==null?void 0:a.nome:void 0,s=f||h?`${f?T(f):"..."} a ${h?T(h):"..."}`:void 0;ye("lotesFiv",n,{fazenda:t,periodo:s})};return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsx(be,{title:"Produção",description:"Métricas de produção e lotes de FIV"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4",children:[e.jsx(v,{children:e.jsx(_,{className:"pt-4 pb-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-primary/10",children:e.jsx(O,{className:"w-5 h-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-foreground",children:g?"...":y.totalLotes}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Lotes FIV (90d)"})]})]})})}),e.jsx(v,{children:e.jsx(_,{className:"pt-4 pb-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-blue-500/10",children:e.jsx(X,{className:"w-5 h-5 text-blue-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-foreground",children:g?"...":y.totalOocitos.toLocaleString()}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Oócitos (90d)"})]})]})})}),e.jsx(v,{children:e.jsx(_,{className:"pt-4 pb-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-cyan-500/10",children:e.jsx(X,{className:"w-5 h-5 text-cyan-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-foreground",children:g?"...":y.totalEmbrioes.toLocaleString()}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Embriões (90d)"})]})]})})}),e.jsx(v,{children:e.jsx(_,{className:"pt-4 pb-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-amber-500/10",children:e.jsx(Ae,{className:"w-5 h-5 text-amber-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-foreground",children:g?"...":`${y.taxaMediaSucesso}%`}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Taxa Média"})]})]})})}),e.jsx(v,{children:e.jsx(_,{className:"pt-4 pb-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-purple-500/10",children:e.jsx(O,{className:"w-5 h-5 text-purple-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-foreground",children:g?"...":y.totalAspiracoes}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Aspirações (90d)"})]})]})})}),e.jsx(v,{children:e.jsx(_,{className:"pt-4 pb-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-rose-500/10",children:e.jsx(O,{className:"w-5 h-5 text-rose-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-foreground",children:g?"...":y.totalProtocolos}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Protocolos (90d)"})]})]})})})]}),e.jsx("div",{className:"rounded-xl border border-border bg-card p-4",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("div",{className:"relative flex-1 min-w-[200px] max-w-[280px]",children:[e.jsx(we,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(ve,{placeholder:"Buscar por código ou fazenda...",value:L,onChange:t=>$(t.target.value),className:"pl-9 h-9"})]}),e.jsx("div",{className:"h-6 w-px bg-border hidden sm:block"}),e.jsxs(J,{value:b,onValueChange:q,children:[e.jsx(K,{className:"w-[180px] h-9",children:e.jsx(W,{placeholder:"Fazenda"})}),e.jsxs(Y,{children:[e.jsx(A,{value:"all",children:"Todas as fazendas"}),R.map(t=>e.jsx(A,{value:t.id,children:t.nome},t.id))]})]}),e.jsxs(J,{value:E,onValueChange:V,children:[e.jsx(K,{className:"w-[150px] h-9",children:e.jsx(W,{placeholder:"Status"})}),e.jsxs(Y,{children:[e.jsx(A,{value:"all",children:"Todos"}),e.jsx(A,{value:"FINALIZADO",children:"Finalizado"}),e.jsx(A,{value:"EM_ANDAMENTO",children:"Em Andamento"})]})]}),e.jsx("div",{className:"h-6 w-px bg-border hidden sm:block"}),e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 rounded-lg bg-muted/50",children:[e.jsx(ze,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"text-muted-foreground text-xs",children:"de"}),e.jsx(ee,{value:f,onChange:H,className:"h-8 w-[120px] text-xs"}),e.jsx("span",{className:"text-muted-foreground text-xs",children:"até"}),e.jsx(ee,{value:h,onChange:Z,className:"h-8 w-[120px] text-xs"})]}),e.jsxs("div",{className:"flex items-center gap-2 ml-auto",children:[e.jsx(z,{variant:"outline",size:"sm",onClick:ne,className:"h-9",children:e.jsx(Fe,{className:"w-4 h-4"})}),n.length>0&&e.jsxs(z,{variant:"outline",size:"sm",onClick:pe,className:"h-9 border-primary/30 text-primary hover:bg-primary/10 hover:border-primary/50",children:[e.jsx(Se,{className:"w-4 h-4 mr-1"}),"PDF"]})]})]})}),e.jsxs(v,{children:[e.jsxs(ge,{className:"pb-3",children:[e.jsxs(je,{className:"text-base",children:["Lotes FIV (",n.length,")"]}),e.jsx(Ne,{children:"Histórico de lotes de fertilização in vitro"})]}),e.jsx(_,{className:"pt-0",children:g?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Carregando..."}):n.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Nenhum lote encontrado"}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"rounded-lg border border-border overflow-hidden",children:[e.jsxs("div",{className:"grid grid-cols-[1fr_1.5fr_1fr_0.8fr_0.8fr_0.8fr_1fr_0.6fr] gap-0 bg-muted text-xs font-semibold text-muted-foreground uppercase tracking-wide",children:[e.jsx("div",{className:"px-4 py-3",children:"Código"}),e.jsx("div",{className:"px-3 py-3",children:"Fazenda"}),e.jsx("div",{className:"px-3 py-3 text-center",children:"Data FIV"}),e.jsx("div",{className:"px-3 py-3 text-center",children:"Oócitos"}),e.jsx("div",{className:"px-3 py-3 text-center",children:"Embriões"}),e.jsx("div",{className:"px-3 py-3 text-center",children:"Taxa"}),e.jsx("div",{className:"px-3 py-3 text-center",children:"Status"}),e.jsx("div",{className:"px-2 py-3"})]}),de.map(t=>e.jsxs("div",{className:"grid grid-cols-[1fr_1.5fr_1fr_0.8fr_0.8fr_0.8fr_1fr_0.6fr] gap-0 items-center border-t border-border hover:bg-muted/30 cursor-pointer",onClick:()=>se(`/lotes-fiv/${t.id}`),children:[e.jsx("div",{className:"px-4 py-3 font-medium text-sm",children:t.codigo}),e.jsx("div",{className:"px-3 py-3 text-sm text-muted-foreground truncate",children:t.fazenda_nome}),e.jsx("div",{className:"px-3 py-3 text-sm text-center",children:T(t.data_fiv)}),e.jsx("div",{className:"px-3 py-3 flex justify-center",children:e.jsx("span",{className:"inline-flex items-center justify-center min-w-6 h-6 px-2 text-xs font-medium bg-muted text-foreground rounded",children:t.total_oocitos})}),e.jsx("div",{className:"px-3 py-3 flex justify-center",children:e.jsx("span",{className:"inline-flex items-center justify-center min-w-6 h-6 px-2 text-xs font-medium bg-primary/15 text-primary rounded",children:t.total_embrioes})}),e.jsx("div",{className:"px-3 py-3 flex justify-center",children:me(t.taxa_sucesso)}),e.jsx("div",{className:"px-3 py-3 flex justify-center",children:xe(t.status)}),e.jsx("div",{className:"px-2 py-3 flex justify-center",children:e.jsx(z,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0",children:e.jsx(Me,{className:"w-4 h-4"})})})]},t.id))]}),j>1&&e.jsxs("div",{className:"flex items-center justify-between mt-4 pt-4 border-t border-border",children:[e.jsxs("span",{className:"text-sm text-muted-foreground",children:["Mostrando ",(l-1)*P+1," a ",Math.min(l*P,n.length)," de ",n.length]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{variant:"outline",size:"sm",onClick:()=>F(t=>Math.max(1,t-1)),disabled:l===1,children:"Anterior"}),e.jsx("div",{className:"flex items-center gap-1",children:Array.from({length:Math.min(5,j)},(t,s)=>{let a;return j<=5||l<=3?a=s+1:l>=j-2?a=j-4+s:a=l-2+s,e.jsx(z,{variant:l===a?"default":"outline",size:"sm",className:`w-9 h-9 p-0 ${l===a?"bg-primary hover:bg-primary-dark":""}`,onClick:()=>F(a),children:a},a)})}),e.jsx(z,{variant:"outline",size:"sm",onClick:()=>F(t=>Math.min(j,t+1)),disabled:l===j,children:"Próximo"})]})]})]})})]})]})}export{We as default};
