import{c as ve,r as m,j as e,B as v,s as T,l as Ne,k as ye,a as De,i as be,L as fe,H as Ee,D as Le}from"./index-BPMeM9-O.js";import{N as Te,g as ze,a as ke,i as Fe,e as qe,b as Ae}from"./coordinates-Dyv_hfeN.js";import{C as z,d as k,a as te,b as ie}from"./card-8azKTSNJ.js";import{T as re,a as ce,b as H,c as N,d as de,e as g}from"./table-l_s8S0JA.js";import{D as me,a as Ce,b as xe,c as he,d as ue,e as pe}from"./dialog-CLDnxY7R.js";import{I as b}from"./input-tqcTRdPv.js";import{L}from"./label-fluRYl3j.js";import{T as Oe,a as Me,b as le,c as ne}from"./tabs-siaSXH49.js";import{P as Ie}from"./PageHeader-DQ4rM2jO.js";import{E as je}from"./EmptyState-yqSFIU3C.js";import{u as we}from"./use-toast-BGNwDi9e.js";import{S as $,a as X,b as Z,c as J,d as E}from"./select-La4nrp5K.js";import{B as ae}from"./badge-CeJDYfYs.js";import{S as Se}from"./search-SyV5imYB.js";import{P as _e}from"./plus-Ah0p7ggz.js";import{S as oe}from"./square-pen-qjgDjx3q.js";import{E as Ve}from"./eye-CZithoXn.js";import{A as Re}from"./arrow-left-CjWJp082.js";import"./index-C5PY5DOm.js";import"./x-BxiwAMrM.js";import"./index-DWxJzuQO.js";import"./check-Bdb-Yd05.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ue=ve("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Be=ve("Minus",[["path",{d:"M5 12h14",key:"1ays0h"}]]);function Qe({clienteId:S,clienteNome:K,doses:p,onReload:w}){const{toast:_}=we(),[h,W]=m.useState(""),[y,Y]=m.useState("todos"),[F,V]=m.useState(!1),[q,B]=m.useState(!1),[ee,R]=m.useState([]),[Q,A]=m.useState(!1),[i,u]=m.useState({touro_id:"",tipo_semen:"CONVENCIONAL",quantidade:1}),[O,t]=m.useState(null),[n,r]=m.useState(0),o=p.filter(s=>{var D,se,ge;const l=s.touro,j=!h||((D=l==null?void 0:l.nome)==null?void 0:D.toLowerCase().includes(h.toLowerCase()))||((se=l==null?void 0:l.registro)==null?void 0:se.toLowerCase().includes(h.toLowerCase()))||((ge=l==null?void 0:l.raca)==null?void 0:ge.toLowerCase().includes(h.toLowerCase())),U=y==="todos"||s.tipo_semen===y;return j&&U}),c=async()=>{A(!0);try{const{data:s,error:l}=await T.from("touros").select("id, nome, registro, raca").eq("disponivel",!0).order("nome");if(l)throw l;R(s||[])}catch(s){_({title:"Erro ao carregar touros",description:s instanceof Error?s.message:"Erro desconhecido",variant:"destructive"})}finally{A(!1)}},x=()=>{c(),u({touro_id:"",tipo_semen:"CONVENCIONAL",quantidade:1}),V(!0)},f=async s=>{if(s.preventDefault(),!i.touro_id){_({title:"Erro",description:"Selecione um touro",variant:"destructive"});return}try{B(!0);const l=p.find(j=>j.touro_id===i.touro_id&&j.tipo_semen===i.tipo_semen);if(l){const{error:j}=await T.from("doses_semen").update({quantidade:(l.quantidade||0)+i.quantidade}).eq("id",l.id);if(j)throw j;_({title:"Doses adicionadas",description:`Adicionadas ${i.quantidade} doses ao estoque existente`})}else{const{error:j}=await T.from("doses_semen").insert([{cliente_id:S,touro_id:i.touro_id,tipo_semen:i.tipo_semen,quantidade:i.quantidade}]);if(j)throw j;_({title:"Doses cadastradas",description:"Doses de sêmen cadastradas com sucesso"})}V(!1),w()}catch(l){_({title:"Erro ao salvar",description:l instanceof Error?l.message:"Erro desconhecido",variant:"destructive"})}finally{B(!1)}},M=s=>{t(s.id),r(s.quantidade||0)},C=async()=>{if(O)try{const{error:s}=await T.from("doses_semen").update({quantidade:n}).eq("id",O);if(s)throw s;_({title:"Quantidade atualizada",description:"Quantidade de doses atualizada com sucesso"}),t(null),w()}catch(s){_({title:"Erro ao atualizar",description:s instanceof Error?s.message:"Erro desconhecido",variant:"destructive"})}},I=async(s,l)=>{const j=p.find(D=>D.id===s);if(!j)return;const U=Math.max(0,(j.quantidade||0)+l);try{const{error:D}=await T.from("doses_semen").update({quantidade:U}).eq("id",s);if(D)throw D;w()}catch(D){_({title:"Erro ao atualizar",description:D instanceof Error?D.message:"Erro desconhecido",variant:"destructive"})}},P=p.reduce((s,l)=>s+(l.quantidade||0),0),G=p.filter(s=>s.tipo_semen==="CONVENCIONAL").reduce((s,l)=>s+(l.quantidade||0),0),a=p.filter(s=>s.tipo_semen==="SEXADO").reduce((s,l)=>s+(l.quantidade||0),0),d=new Set(p.map(s=>s.touro_id)).size;return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(z,{children:e.jsxs(k,{className:"pt-4",children:[e.jsx("p",{className:"text-sm text-slate-500",children:"Total de Doses"}),e.jsx("p",{className:"text-2xl font-bold",children:P})]})}),e.jsx(z,{children:e.jsxs(k,{className:"pt-4",children:[e.jsx("p",{className:"text-sm text-slate-500",children:"Convencionais"}),e.jsx("p",{className:"text-2xl font-bold",children:G})]})}),e.jsx(z,{children:e.jsxs(k,{className:"pt-4",children:[e.jsx("p",{className:"text-sm text-slate-500",children:"Sexadas"}),e.jsx("p",{className:"text-2xl font-bold",children:a})]})}),e.jsx(z,{children:e.jsxs(k,{className:"pt-4",children:[e.jsx("p",{className:"text-sm text-slate-500",children:"Touros"}),e.jsx("p",{className:"text-2xl font-bold",children:d})]})})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsxs("div",{className:"relative flex-1 max-w-xs",children:[e.jsx(Se,{className:"absolute left-2 top-2.5 h-4 w-4 text-slate-400"}),e.jsx(b,{placeholder:"Buscar touro...",value:h,onChange:s=>W(s.target.value),className:"pl-8"})]}),e.jsxs($,{value:y,onValueChange:Y,children:[e.jsx(X,{className:"w-[150px]",children:e.jsx(Z,{placeholder:"Tipo"})}),e.jsxs(J,{children:[e.jsx(E,{value:"todos",children:"Todos"}),e.jsx(E,{value:"CONVENCIONAL",children:"Convencional"}),e.jsx(E,{value:"SEXADO",children:"Sexado"})]})]})]}),e.jsxs(me,{open:F,onOpenChange:V,children:[e.jsx(Ce,{asChild:!0,children:e.jsxs(v,{onClick:x,children:[e.jsx(_e,{className:"w-4 h-4 mr-2"}),"Adicionar Doses"]})}),e.jsxs(xe,{children:[e.jsxs(he,{children:[e.jsx(ue,{children:"Adicionar Doses de Sêmen"}),e.jsxs(pe,{children:["Adicionar doses para ",K]})]}),e.jsxs("form",{onSubmit:f,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(L,{children:"Touro *"}),e.jsxs($,{value:i.touro_id,onValueChange:s=>u({...i,touro_id:s}),children:[e.jsx(X,{children:e.jsx(Z,{placeholder:Q?"Carregando...":"Selecione o touro"})}),e.jsx(J,{children:ee.map(s=>e.jsxs(E,{value:s.id,children:[s.nome," ",s.registro&&`(${s.registro})`," - ",s.raca||"S/R"]},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(L,{children:"Tipo de Sêmen"}),e.jsxs($,{value:i.tipo_semen,onValueChange:s=>u({...i,tipo_semen:s}),children:[e.jsx(X,{children:e.jsx(Z,{})}),e.jsxs(J,{children:[e.jsx(E,{value:"CONVENCIONAL",children:"Convencional"}),e.jsx(E,{value:"SEXADO",children:"Sexado"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(L,{children:"Quantidade"}),e.jsx(b,{type:"number",min:1,value:i.quantidade,onChange:s=>u({...i,quantidade:parseInt(s.target.value)||1})})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(v,{type:"submit",className:"flex-1",disabled:q,children:q?"Salvando...":"Adicionar"}),e.jsx(v,{type:"button",variant:"outline",onClick:()=>V(!1),children:"Cancelar"})]})]})]})]})]}),e.jsxs(z,{children:[e.jsx(te,{children:e.jsxs(ie,{children:["Doses de Sêmen (",o.length,")"]})}),e.jsx(k,{children:o.length===0?e.jsx(je,{title:"Nenhuma dose encontrada",description:h||y!=="todos"?"Tente ajustar os filtros":"Cadastre a primeira dose de sêmen"}):e.jsxs(re,{children:[e.jsx(ce,{children:e.jsxs(H,{children:[e.jsx(N,{children:"Touro"}),e.jsx(N,{children:"Raça"}),e.jsx(N,{children:"Tipo"}),e.jsx(N,{className:"text-center",children:"Quantidade"}),e.jsx(N,{className:"text-right",children:"Ações"})]})}),e.jsx(de,{children:o.map(s=>{const l=s.touro,j=O===s.id;return e.jsxs(H,{children:[e.jsxs(g,{className:"font-medium",children:[(l==null?void 0:l.nome)||"Touro desconhecido",(l==null?void 0:l.registro)&&e.jsxs("span",{className:"text-slate-500 ml-2",children:["(",l.registro,")"]})]}),e.jsx(g,{children:(l==null?void 0:l.raca)||"-"}),e.jsx(g,{children:e.jsx(ae,{variant:s.tipo_semen==="SEXADO"?"default":"secondary",children:s.tipo_semen||"CONVENCIONAL"})}),e.jsx(g,{className:"text-center",children:j?e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(b,{type:"number",min:0,value:n,onChange:U=>r(parseInt(U.target.value)||0),className:"w-20 text-center"}),e.jsx(v,{size:"sm",onClick:C,children:"Salvar"}),e.jsx(v,{size:"sm",variant:"ghost",onClick:()=>t(null),children:"Cancelar"})]}):e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(v,{variant:"ghost",size:"sm",onClick:()=>I(s.id,-1),disabled:(s.quantidade||0)<=0,children:e.jsx(Be,{className:"w-4 h-4"})}),e.jsx("span",{className:"font-medium min-w-[3ch] text-center",children:s.quantidade??0}),e.jsx(v,{variant:"ghost",size:"sm",onClick:()=>I(s.id,1),children:e.jsx(Ue,{className:"w-4 h-4"})})]})}),e.jsx(g,{className:"text-right",children:e.jsx(v,{variant:"ghost",size:"sm",onClick:()=>M(s),children:e.jsx(oe,{className:"w-4 h-4"})})})]},s.id)})})]})})]})]})}function He({clienteId:S,clienteNome:K,embrioes:p}){const[w,_]=m.useState(""),[h,W]=m.useState("todos"),[y,Y]=m.useState("todos"),[F,V]=m.useState("todos"),[q,B]=m.useState(null),{classificacoes:ee,doadoras:R,touros:Q}=m.useMemo(()=>{const t=new Set,n=new Map,r=new Map;return p.forEach(o=>{var M,C;o.classificacao&&t.add(o.classificacao);const c=o.acasalamento,x=(M=c==null?void 0:c.aspiracao)==null?void 0:M.doadora;x!=null&&x.id&&n.set(x.id,x.registro||x.nome||x.id);const f=(C=c==null?void 0:c.dose_semen)==null?void 0:C.touro;f!=null&&f.id&&r.set(f.id,f.nome||f.registro||f.id)}),{classificacoes:Array.from(t).sort(),doadoras:Array.from(n.entries()).sort((o,c)=>o[1].localeCompare(c[1])),touros:Array.from(r.entries()).sort((o,c)=>o[1].localeCompare(c[1]))}},[p]),A=p.filter(t=>{var C,I,P,G,a,d,s;const n=t.acasalamento,r=(C=n==null?void 0:n.aspiracao)==null?void 0:C.doadora,o=(I=n==null?void 0:n.dose_semen)==null?void 0:I.touro,c=!w||((P=t.identificacao)==null?void 0:P.toLowerCase().includes(w.toLowerCase()))||((G=t.localizacao_atual)==null?void 0:G.toLowerCase().includes(w.toLowerCase()))||((a=r==null?void 0:r.registro)==null?void 0:a.toLowerCase().includes(w.toLowerCase()))||((d=r==null?void 0:r.nome)==null?void 0:d.toLowerCase().includes(w.toLowerCase()))||((s=o==null?void 0:o.nome)==null?void 0:s.toLowerCase().includes(w.toLowerCase())),x=h==="todos"||t.classificacao===h,f=y==="todos"||(r==null?void 0:r.id)===y,M=F==="todos"||(o==null?void 0:o.id)===F;return c&&x&&f&&M}),i=m.useMemo(()=>{const t=new Map;return p.forEach(n=>{const r=n.classificacao||"Sem classificação";t.set(r,(t.get(r)||0)+1)}),{total:p.length,porClassificacao:Array.from(t.entries()).sort((n,r)=>r[1]-n[1])}},[p]),u=t=>t?new Date(t).toLocaleDateString("pt-BR"):"-",O=({embriao:t})=>{const n=t.acasalamento,r=n==null?void 0:n.dose_semen,o=r==null?void 0:r.touro,c=n==null?void 0:n.aspiracao,x=c==null?void 0:c.doadora,f=t.lote_fiv;return e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-500",children:"Identificação"}),e.jsx("p",{className:"font-medium",children:t.identificacao||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-500",children:"Classificação"}),e.jsx("p",{className:"font-medium",children:t.classificacao?e.jsx(ae,{variant:"secondary",children:t.classificacao}):"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-500",children:"Status"}),e.jsx("p",{className:"font-medium",children:e.jsxs(ae,{className:"bg-cyan-100 text-cyan-800",children:[e.jsx(Ne,{className:"w-3 h-3 mr-1"}),t.status_atual||"CONGELADO"]})})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-500",children:"Data de Congelamento"}),e.jsx("p",{className:"font-medium",children:u(t.data_congelamento)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-500",children:"Localização"}),e.jsx("p",{className:"font-medium",children:t.localizacao_atual||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-500",children:"Tipo"}),e.jsx("p",{className:"font-medium",children:t.tipo_embriao||"-"})]}),e.jsx("div",{className:"col-span-2 border-t pt-4 mt-2",children:e.jsx("p",{className:"text-slate-500 font-medium mb-2",children:"Origem"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-500",children:"Doadora"}),e.jsx("p",{className:"font-medium",children:(x==null?void 0:x.registro)||(x==null?void 0:x.nome)||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-500",children:"Touro"}),e.jsxs("p",{className:"font-medium",children:[(o==null?void 0:o.nome)||"-",(o==null?void 0:o.registro)&&e.jsxs("span",{className:"text-slate-500 ml-1",children:["(",o.registro,")"]})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-500",children:"Raça do Touro"}),e.jsx("p",{className:"font-medium",children:(o==null?void 0:o.raca)||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-500",children:"Data D0 (Lote FIV)"}),e.jsx("p",{className:"font-medium",children:u(f==null?void 0:f.data_abertura)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-500",children:"Data de Aspiração"}),e.jsx("p",{className:"font-medium",children:u(c==null?void 0:c.data_aspiracao)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-500",children:"Hora de Aspiração"}),e.jsx("p",{className:"font-medium",children:(c==null?void 0:c.horario_aspiracao)||"-"})]}),t.observacoes&&e.jsxs("div",{className:"col-span-2 border-t pt-4 mt-2",children:[e.jsx("p",{className:"text-slate-500",children:"Observações"}),e.jsx("p",{className:"font-medium",children:t.observacoes})]})]})};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(z,{children:e.jsxs(k,{className:"pt-4",children:[e.jsx("p",{className:"text-sm text-slate-500",children:"Total Congelados"}),e.jsx("p",{className:"text-2xl font-bold",children:i.total})]})}),i.porClassificacao.slice(0,3).map(([t,n])=>e.jsx(z,{children:e.jsxs(k,{className:"pt-4",children:[e.jsx("p",{className:"text-sm text-slate-500",children:t}),e.jsx("p",{className:"text-2xl font-bold",children:n})]})},t))]}),e.jsxs("div",{className:"flex flex-wrap gap-4 items-center",children:[e.jsxs("div",{className:"relative flex-1 min-w-[200px] max-w-xs",children:[e.jsx(Se,{className:"absolute left-2 top-2.5 h-4 w-4 text-slate-400"}),e.jsx(b,{placeholder:"Buscar...",value:w,onChange:t=>_(t.target.value),className:"pl-8"})]}),e.jsxs($,{value:h,onValueChange:W,children:[e.jsx(X,{className:"w-[150px]",children:e.jsx(Z,{placeholder:"Classificação"})}),e.jsxs(J,{children:[e.jsx(E,{value:"todos",children:"Todas"}),ee.map(t=>e.jsx(E,{value:t,children:t},t))]})]}),e.jsxs($,{value:y,onValueChange:Y,children:[e.jsx(X,{className:"w-[180px]",children:e.jsx(Z,{placeholder:"Doadora"})}),e.jsxs(J,{children:[e.jsx(E,{value:"todos",children:"Todas"}),R.map(([t,n])=>e.jsx(E,{value:t,children:n},t))]})]}),e.jsxs($,{value:F,onValueChange:V,children:[e.jsx(X,{className:"w-[180px]",children:e.jsx(Z,{placeholder:"Touro"})}),e.jsxs(J,{children:[e.jsx(E,{value:"todos",children:"Todos"}),Q.map(([t,n])=>e.jsx(E,{value:t,children:n},t))]})]})]}),e.jsxs(z,{children:[e.jsx(te,{children:e.jsxs(ie,{children:["Embriões Congelados (",A.length,")"]})}),e.jsx(k,{children:A.length===0?e.jsx(je,{title:"Nenhum embrião encontrado",description:w||h!=="todos"||y!=="todos"||F!=="todos"?"Tente ajustar os filtros":"Nenhum embrião congelado no estoque"}):e.jsxs(re,{children:[e.jsx(ce,{children:e.jsxs(H,{children:[e.jsx(N,{children:"Identificação"}),e.jsx(N,{children:"Classificação"}),e.jsx(N,{children:"Doadora"}),e.jsx(N,{children:"Touro"}),e.jsx(N,{children:"Data Cong."}),e.jsx(N,{children:"Localização"}),e.jsx(N,{className:"text-right",children:"Ações"})]})}),e.jsx(de,{children:A.map(t=>{var c,x;const n=t.acasalamento,r=(c=n==null?void 0:n.aspiracao)==null?void 0:c.doadora,o=(x=n==null?void 0:n.dose_semen)==null?void 0:x.touro;return e.jsxs(H,{children:[e.jsx(g,{className:"font-medium font-mono text-sm",children:t.identificacao||"-"}),e.jsx(g,{children:t.classificacao?e.jsx(ae,{variant:"secondary",children:t.classificacao}):"-"}),e.jsx(g,{children:(r==null?void 0:r.registro)||(r==null?void 0:r.nome)||"-"}),e.jsxs(g,{children:[(o==null?void 0:o.nome)||"-",(o==null?void 0:o.registro)&&e.jsxs("span",{className:"text-slate-500 text-xs ml-1",children:["(",o.registro,")"]})]}),e.jsx(g,{children:u(t.data_congelamento)}),e.jsx(g,{children:t.localizacao_atual||"-"}),e.jsx(g,{className:"text-right",children:e.jsxs(v,{variant:"ghost",size:"sm",onClick:()=>B(t),children:[e.jsx(Ve,{className:"w-4 h-4 mr-1"}),"Detalhar"]})})]},t.id)})})]})})]}),e.jsx(me,{open:!!q,onOpenChange:t=>!t&&B(null),children:e.jsxs(xe,{className:"max-w-2xl",children:[e.jsxs(he,{children:[e.jsx(ue,{children:"Detalhes do Embrião"}),e.jsx(pe,{children:"Informações completas do embrião congelado"})]}),q&&e.jsx(O,{embriao:q})]})})]})}function hs(){const{id:S}=ye(),K=De(),{toast:p}=we(),[w,_]=m.useState(!0),[h,W]=m.useState(null),[y,Y]=m.useState([]),[F,V]=m.useState([]),[q,B]=m.useState([]),[ee,R]=m.useState(!1),[Q,A]=m.useState(!1),[i,u]=m.useState({nome:"",sigla:"",localizacao:"",latitude:"",longitude:"",mapsLink:"",responsavel:"",contato_responsavel:""}),[O,t]=m.useState(null),[n,r]=m.useState(null);m.useEffect(()=>{S&&o()},[S]);const o=async()=>{try{_(!0);const{data:a,error:d}=await T.from("clientes").select("*").eq("id",S).single();if(d)throw d;W(a);const{data:s,error:l}=await T.from("fazendas").select("*").eq("cliente_id",S).order("nome",{ascending:!0});if(l)throw l;Y(s||[]);const{data:j,error:U}=await T.from("doses_semen").select(`
          *,
          touro:touros(id, nome, registro, raca)
        `).eq("cliente_id",S).order("created_at",{ascending:!1});if(U)throw U;V(j||[]);const{data:D,error:se}=await T.from("embrioes").select(`
          *,
          lote_fiv:lotes_fiv(id, data_abertura),
          acasalamento:lote_fiv_acasalamentos(
            id,
            dose_semen:doses_semen(
              id,
              touro:touros(id, nome, registro, raca)
            ),
            aspiracao:aspiracoes_doadoras(
              id,
              data_aspiracao,
              horario_aspiracao,
              doadora:doadoras(id, registro, nome)
            )
          )
        `).eq("cliente_id",S).eq("status_atual","CONGELADO").order("data_congelamento",{ascending:!1});if(se)throw se;B(D||[])}catch(a){p({title:"Erro ao carregar dados",description:a instanceof Error?a.message:"Erro desconhecido",variant:"destructive"})}finally{_(!1)}},c=a=>{if(a.latitude&&a.longitude){const d=ze(a.latitude,a.longitude);window.open(d,"_blank")}else if(a.localizacao){const d=ke(a.localizacao);window.open(d,"_blank")}},x=a=>a.latitude&&a.longitude||a.localizacao,f=a=>{if(u({...i,mapsLink:a}),t(null),!a.trim())return;if(Fe(a)){t("Links curtos (goo.gl) nao sao suportados. Abra o link no navegador e copie a URL completa.");return}const d=qe(a);d&&u(s=>({...s,mapsLink:a,latitude:d.lat,longitude:d.lng}))},M=(a,d)=>{const s={...i,[a]:d};if(u(s),s.latitude&&s.longitude){const l=parseFloat(s.latitude),j=parseFloat(s.longitude);r(Ae(l,j))}else r(null)},[C,I]=m.useState(null),P=a=>{var d,s;u({nome:a.nome||"",sigla:a.sigla||"",localizacao:a.localizacao||"",latitude:((d=a.latitude)==null?void 0:d.toString())||"",longitude:((s=a.longitude)==null?void 0:s.toString())||"",mapsLink:"",responsavel:a.responsavel||"",contato_responsavel:a.contato_responsavel||""}),t(null),r(null),I(a),R(!0)},G=async a=>{if(a.preventDefault(),!i.nome.trim()){p({title:"Erro de validação",description:"Nome da fazenda é obrigatório",variant:"destructive"});return}try{A(!0);const d={nome:i.nome,sigla:i.sigla.trim().toUpperCase()||null,localizacao:i.localizacao.trim()||null,latitude:i.latitude?parseFloat(i.latitude):null,longitude:i.longitude?parseFloat(i.longitude):null,responsavel:i.responsavel.trim()||null,contato_responsavel:i.contato_responsavel.trim()||null};if(C){const{error:s}=await T.from("fazendas").update(d).eq("id",C.id);if(s)throw s;p({title:"Fazenda atualizada",description:"Fazenda atualizada com sucesso"})}else{const{error:s}=await T.from("fazendas").insert([{...d,cliente_id:S}]);if(s)throw s;p({title:"Fazenda criada",description:"Fazenda criada com sucesso"})}R(!1),I(null),u({nome:"",sigla:"",localizacao:"",latitude:"",longitude:"",mapsLink:"",responsavel:"",contato_responsavel:""}),t(null),r(null),o()}catch(d){const s=d instanceof Error?d.message:"Erro desconhecido";p({title:C?"Erro ao atualizar fazenda":"Erro ao criar fazenda",description:s.includes("RLS")||s.includes("policy")?"RLS está bloqueando escrita. Configure políticas anon no Supabase.":s,variant:"destructive"})}finally{A(!1)}};return w?e.jsx(be,{}):h?e.jsxs("div",{className:"space-y-6",children:[e.jsx(Ie,{title:h.nome,description:"Detalhes do cliente",actions:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{variant:"outline",size:"icon",onClick:()=>K("/clientes"),children:e.jsx(Re,{className:"w-4 h-4"})}),e.jsx(fe,{to:`/clientes/${S}/editar`,children:e.jsxs(v,{variant:"outline",children:[e.jsx(oe,{className:"w-4 h-4 mr-2"}),"Editar"]})})]})}),e.jsxs(z,{children:[e.jsx(te,{children:e.jsx(ie,{children:"Informações do Cliente"})}),e.jsxs(k,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Nome"}),e.jsx("p",{className:"text-base text-foreground",children:h.nome})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Telefone"}),e.jsx("p",{className:"text-base text-foreground",children:h.telefone||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Endereço"}),e.jsx("p",{className:"text-base text-foreground",children:h.endereco||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Cadastrado em"}),e.jsx("p",{className:"text-base text-foreground",children:h.created_at?new Date(h.created_at).toLocaleDateString("pt-BR"):"-"})]})]})]}),e.jsxs(Oe,{defaultValue:"fazendas",className:"w-full",children:[e.jsxs(Me,{children:[e.jsxs(le,{value:"fazendas",children:[e.jsx(Ee,{className:"w-4 h-4 mr-2"}),"Fazendas (",y.length,")"]}),e.jsxs(le,{value:"doses",children:[e.jsx(Le,{className:"w-4 h-4 mr-2"}),"Doses de Sêmen (",F.length,")"]}),e.jsxs(le,{value:"embrioes",children:[e.jsx(Ne,{className:"w-4 h-4 mr-2"}),"Embriões Congelados (",q.length,")"]})]}),e.jsx(ne,{value:"fazendas",children:e.jsxs(z,{children:[e.jsx(te,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(ie,{children:"Fazendas do Cliente"}),e.jsxs(me,{open:ee,onOpenChange:a=>{R(a),a||(I(null),u({nome:"",sigla:"",localizacao:"",latitude:"",longitude:"",mapsLink:"",responsavel:"",contato_responsavel:""}),t(null),r(null))},children:[e.jsx(Ce,{asChild:!0,children:e.jsxs(v,{children:[e.jsx(_e,{className:"w-4 h-4 mr-2"}),"Nova Fazenda"]})}),e.jsxs(xe,{className:"max-w-md",children:[e.jsxs(he,{children:[e.jsx(ue,{children:C?"Editar Fazenda":"Criar Nova Fazenda"}),e.jsx(pe,{children:C?`Editando ${C.nome}`:`Criar fazenda para ${h.nome}`})]}),e.jsxs("form",{onSubmit:G,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(L,{htmlFor:"nome",children:"Nome da Fazenda *"}),e.jsx(b,{id:"nome",value:i.nome,onChange:a=>u({...i,nome:a.target.value}),placeholder:"Nome da fazenda",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(L,{htmlFor:"sigla",children:"Sigla (2-3 caracteres)"}),e.jsx(b,{id:"sigla",value:i.sigla,onChange:a=>{const d=a.target.value.toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,3);u({...i,sigla:d})},placeholder:"Ex: SC, BV",maxLength:3,className:"w-24 uppercase"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Usada para identificar embriões (ex: SC-2401-001)"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(L,{htmlFor:"localizacao",children:"Localização"}),e.jsx(b,{id:"localizacao",value:i.localizacao,onChange:a=>u({...i,localizacao:a.target.value}),placeholder:"Cidade, Estado"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(L,{htmlFor:"mapsLink",children:"Link do Google Maps"}),e.jsx(b,{id:"mapsLink",value:i.mapsLink,onChange:a=>f(a.target.value),placeholder:"Cole aqui o link compartilhado do Maps",className:O?"border-red-500":""}),O&&e.jsx("p",{className:"text-xs text-red-500",children:O}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Cole um link do Google Maps para preencher as coordenadas automaticamente"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(L,{htmlFor:"latitude",children:"Latitude"}),e.jsx(b,{id:"latitude",type:"number",step:"any",value:i.latitude,onChange:a=>M("latitude",a.target.value),placeholder:"-23.550520",className:n===!1?"border-red-500":n===!0?"border-green-500":""})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(L,{htmlFor:"longitude",children:"Longitude"}),e.jsx(b,{id:"longitude",type:"number",step:"any",value:i.longitude,onChange:a=>M("longitude",a.target.value),placeholder:"-46.633308",className:n===!1?"border-red-500":n===!0?"border-green-500":""})]})]}),n===!1&&e.jsx("p",{className:"text-xs text-red-500",children:"Coordenadas fora do range valido (lat: -90 a 90, lng: -180 a 180)"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(L,{htmlFor:"responsavel",children:"Responsável"}),e.jsx(b,{id:"responsavel",value:i.responsavel,onChange:a=>u({...i,responsavel:a.target.value}),placeholder:"Nome do responsável"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(L,{htmlFor:"contato_responsavel",children:"Contato do Responsável"}),e.jsx(b,{id:"contato_responsavel",value:i.contato_responsavel,onChange:a=>u({...i,contato_responsavel:a.target.value}),placeholder:"Telefone ou email"})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(v,{type:"submit",className:"flex-1",disabled:Q,children:Q?"Salvando...":C?"Salvar":"Criar Fazenda"}),e.jsx(v,{type:"button",variant:"outline",onClick:()=>R(!1),disabled:Q,children:"Cancelar"})]})]})]})]})]})}),e.jsx(k,{children:e.jsxs(re,{children:[e.jsx(ce,{children:e.jsxs(H,{children:[e.jsx(N,{children:"Nome"}),e.jsx(N,{children:"Sigla"}),e.jsx(N,{children:"Localização"}),e.jsx(N,{children:"Responsável"}),e.jsx(N,{className:"text-right",children:"Ações"})]})}),e.jsx(de,{children:y.length===0?e.jsx(H,{children:e.jsx(g,{colSpan:5,className:"text-center text-muted-foreground",children:"Nenhuma fazenda cadastrada"})}):y.map(a=>e.jsxs(H,{children:[e.jsx(g,{className:"font-medium",children:e.jsx(fe,{to:`/fazendas/${a.id}`,className:"text-primary hover:text-primary/80 hover:underline",children:a.nome})}),e.jsx(g,{children:a.sigla||"-"}),e.jsx(g,{children:a.localizacao||"-"}),e.jsx(g,{children:a.responsavel||"-"}),e.jsx(g,{className:"text-right",children:e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(v,{variant:"ghost",size:"sm",onClick:()=>P(a),children:e.jsx(oe,{className:"w-4 h-4"})}),x(a)&&e.jsxs(v,{variant:"outline",size:"sm",onClick:()=>c(a),children:[e.jsx(Te,{className:"w-4 h-4 mr-1"}),"Navegar"]})]})})]},a.id))})]})})]})}),e.jsx(ne,{value:"doses",children:e.jsx(Qe,{clienteId:S,clienteNome:h.nome,doses:F,onReload:o})}),e.jsx(ne,{value:"embrioes",children:e.jsx(He,{clienteId:S,clienteNome:h.nome,embrioes:q})})]})]}):e.jsx("div",{className:"space-y-6",children:e.jsx(je,{title:"Cliente não encontrado",description:"Volte para a lista e selecione outro cliente.",action:e.jsx(v,{onClick:()=>K("/clientes"),variant:"outline",children:"Voltar para Clientes"})})})}export{hs as default};
