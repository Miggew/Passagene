import{c as Qe,r as d,s as p,j as e,B as I,a as Ie,k as Ke,i as ea,m as aa,D as sa,L as we,n as ta}from"./index-BPMeM9-O.js";import{f as qe}from"./statusLabels-DUX_NUYv.js";import{N as ra,g as oa,a as ia}from"./coordinates-Dyv_hfeN.js";import{C as Z,d as J,a as de,b as me}from"./card-8azKTSNJ.js";import{T as ye,a as Ce,b as oe,c as k,d as Ee,e as O}from"./table-l_s8S0JA.js";import{T as na,a as ca,b as be,c as _e}from"./tabs-siaSXH49.js";import{B as G}from"./badge-CeJDYfYs.js";import{P as la}from"./PageHeader-DQ4rM2jO.js";import{E as De}from"./EmptyState-yqSFIU3C.js";import{u as Ne}from"./use-toast-BGNwDi9e.js";import{D as fe,b as pe,c as ge,d as je,e as ve,f as da,a as He}from"./dialog-CLDnxY7R.js";import{S as ze,a as Re,b as Me,c as Te,d as re}from"./select-La4nrp5K.js";import{I as te}from"./input-tqcTRdPv.js";import{L as Y}from"./label-fluRYl3j.js";import{S as ma}from"./StatusBadge-DMctmijA.js";import{u as ua,a as xa,b as ha}from"./hooks-BRtq68sJ.js";import{u as fa}from"./index-D8U2jNcs.js";import{T as pa}from"./textarea-B1aXpqcj.js";import{D as ga}from"./DatePickerBR-CHtWVvxh.js";import{F as Ue}from"./filter-DouKIrIu.js";import{S as Ve}from"./search-SyV5imYB.js";import{X as Ge}from"./x-BxiwAMrM.js";import{P as Ze}from"./plus-Ah0p7ggz.js";import{S as ja}from"./square-pen-qjgDjx3q.js";import{H as Je}from"./history-TsBvJqZq.js";import{A as va}from"./arrow-right-CoqNrwoH.js";import{B as Fe}from"./baby-DhvJkWKV.js";import{m as Ye,a as We,f as Na,p as wa}from"./pt-BR-CyDikW87.js";import{P as ba,D as _a,G as Sa}from"./DoadoraHistoricoAspiracoes-CMFzW4_-.js";import{f as Da}from"./dateUtils-eJ5e6apA.js";import{S as le}from"./star--IBMHPCH.js";import{A as ya}from"./arrow-left-CjWJp082.js";import{M as Ca}from"./map-pin-B27L4YNJ.js";import{U as Ea}from"./user-BTDnQyTa.js";import{P as za}from"./phone-iLMcbN-s.js";import{A as Le}from"./activity-CIWhM6rb.js";import{B as $e}from"./beef-D8zqplAU.js";import{C as Ra}from"./calendar-CuUQg-xw.js";import"./index-DWxJzuQO.js";import"./index-C5PY5DOm.js";import"./check-Bdb-Yd05.js";import"./chevron-right-BkIAhNYS.js";import"./popover-D1vF_0kq.js";import"./index-BkgnAyi6.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ma=Qe("CircleAlert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]);function Ta(r,t){const s=Ia(r);let m;if(s.date){const x=ka(s.date,2);m=Oa(x.restDateString,x.year)}if(!m||isNaN(m.getTime()))return new Date(NaN);const l=m.getTime();let j=0,h;if(s.time&&(j=Ba(s.time),isNaN(j)))return new Date(NaN);if(s.timezone){if(h=La(s.timezone),isNaN(h))return new Date(NaN)}else{const x=new Date(l+j),n=new Date(0);return n.setFullYear(x.getUTCFullYear(),x.getUTCMonth(),x.getUTCDate()),n.setHours(x.getUTCHours(),x.getUTCMinutes(),x.getUTCSeconds(),x.getUTCMilliseconds()),n}return new Date(l+j+h)}const Se={dateTimeDelimiter:/[T ]/,timeZoneDelimiter:/[Z ]/i,timezone:/([Z+-].*)$/},Pa=/^-?(?:(\d{3})|(\d{2})(?:-?(\d{2}))?|W(\d{2})(?:-?(\d{1}))?|)$/,Aa=/^(\d{2}(?:[.,]\d*)?)(?::?(\d{2}(?:[.,]\d*)?))?(?::?(\d{2}(?:[.,]\d*)?))?$/,Fa=/^([+-])(\d{2})(?::?(\d{2}))?$/;function Ia(r){const t={},a=r.split(Se.dateTimeDelimiter);let s;if(a.length>2)return t;if(/:/.test(a[0])?s=a[0]:(t.date=a[0],s=a[1],Se.timeZoneDelimiter.test(t.date)&&(t.date=r.split(Se.timeZoneDelimiter)[0],s=r.substr(t.date.length,r.length))),s){const m=Se.timezone.exec(s);m?(t.time=s.replace(m[1],""),t.timezone=m[1]):t.time=s}return t}function ka(r,t){const a=new RegExp("^(?:(\\d{4}|[+-]\\d{"+(4+t)+"})|(\\d{2}|[+-]\\d{"+(2+t)+"})$)"),s=r.match(a);if(!s)return{year:NaN,restDateString:""};const m=s[1]?parseInt(s[1]):null,l=s[2]?parseInt(s[2]):null;return{year:l===null?m:l*100,restDateString:r.slice((s[1]||s[2]).length)}}function Oa(r,t){if(t===null)return new Date(NaN);const a=r.match(Pa);if(!a)return new Date(NaN);const s=!!a[4],m=he(a[1]),l=he(a[2])-1,j=he(a[3]),h=he(a[4]),x=he(a[5])-1;if(s)return Va(t,h,x)?$a(t,h,x):new Date(NaN);{const n=new Date(0);return!Ha(t,l,j)||!Ua(t,m)?new Date(NaN):(n.setUTCFullYear(t,l,Math.max(m,j)),n)}}function he(r){return r?parseInt(r):1}function Ba(r){const t=r.match(Aa);if(!t)return NaN;const a=Ae(t[1]),s=Ae(t[2]),m=Ae(t[3]);return Ga(a,s,m)?a*Ye+s*We+m*1e3:NaN}function Ae(r){return r&&parseFloat(r.replace(",","."))||0}function La(r){if(r==="Z")return 0;const t=r.match(Fa);if(!t)return 0;const a=t[1]==="+"?-1:1,s=parseInt(t[2]),m=t[3]&&parseInt(t[3])||0;return Za(s,m)?a*(s*Ye+m*We):NaN}function $a(r,t,a){const s=new Date(0);s.setUTCFullYear(r,0,4);const m=s.getUTCDay()||7,l=(t-1)*7+a+1-m;return s.setUTCDate(s.getUTCDate()+l),s}const qa=[31,null,31,30,31,30,31,31,30,31,30,31];function Xe(r){return r%400===0||r%4===0&&r%100!==0}function Ha(r,t,a){return t>=0&&t<=11&&a>=1&&a<=(qa[t]||(Xe(r)?29:28))}function Ua(r,t){return t>=1&&t<=(Xe(r)?366:365)}function Va(r,t,a){return t>=1&&t<=53&&a>=0&&a<=6}function Ga(r,t,a){return r===24?t===0&&a===0:a>=0&&a<60&&t>=0&&t<60&&r>=0&&r<25}function Za(r,t){return t>=0&&t<=59}function Ja({selectedFazendaId:r}){const[t,a]=d.useState(""),[s,m]=d.useState("all"),l=fa(t,300),[j,h]=d.useState(new Map),[x,n]=d.useState(new Set),{data:M=[],isLoading:E,refetch:F}=ua(),{data:S=[],isLoading:z,refetch:T}=xa(r||void 0);ha();const C=d.useMemo(()=>S.filter(c=>!x.has(c.id)).map(c=>{const D=j.get(c.id);return D?{...c,...D}:c}),[S,j,x]),$=d.useMemo(()=>Array.from(new Set(C.map(c=>c.status_calculado))).filter(c=>c).sort(),[C]),q=d.useMemo(()=>{let c=C;if(s!=="all"&&(c=c.filter(D=>D.status_calculado===s)),l.trim()){const D=l.toLowerCase();c=c.filter(P=>{var o;return P.identificacao.toLowerCase().includes(D)||((o=P.nome)==null?void 0:o.toLowerCase().includes(D))})}return c},[C,s,l]),w=async()=>{await F()},b=async()=>{r&&(h(new Map),n(new Set),await T())},i=async()=>{await b()},v=d.useCallback((c,D)=>{h(P=>{const o=new Map(P),f=o.get(c)||{};return o.set(c,{...f,...D}),o})},[]),N=d.useCallback(c=>{n(D=>new Set(D).add(c))},[]);return{fazendas:M,receptoras:C,filteredReceptoras:q,statusDisponiveis:$,loadingFazendas:E,loadingReceptoras:z,searchTerm:t,setSearchTerm:a,filtroStatus:s,setFiltroStatus:m,loadFazendas:w,loadReceptoras:b,reloadReceptoras:i,updateReceptoraInList:v,removeReceptoraFromList:N}}function Ya({selectedFazendaId:r,onSuccess:t}){const{toast:a}=Ne(),[s,m]=d.useState({identificacao:"",nome:""}),[l,j]=d.useState(!1),[h,x]=d.useState({identificacao:"",nome:""}),[n,M]=d.useState(null),[E,F]=d.useState(!1),[S,z]=d.useState(!1),T=d.useCallback(()=>{m({identificacao:"",nome:""})},[]),C=d.useCallback(()=>{x({identificacao:"",nome:""}),M(null)},[]),$=d.useCallback(b=>{M(b),x({identificacao:b.identificacao,nome:b.nome||""}),F(!0)},[]),q=d.useCallback(async b=>{if(b.preventDefault(),!s.identificacao.trim()){a({title:"Erro de validação",description:"Identificação (brinco) é obrigatória",variant:"destructive"});return}if(!r){a({title:"Erro de validação",description:"Selecione uma fazenda primeiro",variant:"destructive"});return}try{z(!0);const{data:i,error:v}=await p.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",r);if(v)throw v;const N=(i==null?void 0:i.map(o=>o.receptora_id))||[];if(N.length>0){const{data:o,error:f}=await p.from("receptoras").select("id, identificacao, nome").in("id",N).ilike("identificacao",s.identificacao.trim());if(f)throw f;if(o&&o.length>0){const y=o[0].nome?`"${o[0].nome}"`:"sem nome";throw new Error(`Já existe uma receptora com o brinco "${s.identificacao.trim()}" nesta fazenda (Nome: ${y}).`)}if(s.nome.trim()){const{data:y,error:B}=await p.from("receptoras").select("id, identificacao").in("id",N).ilike("nome",s.nome.trim());if(B)throw B;if(y&&y.length>0)throw new Error(`Já existe uma receptora com o nome "${s.nome.trim()}" nesta fazenda (Brinco: ${y[0].identificacao}).`)}}const c={identificacao:s.identificacao};s.nome.trim()&&(c.nome=s.nome);const{data:D,error:P}=await p.from("receptoras").insert([c]).select().single();if(P)throw P.code==="23505"?new Error("Já existe uma receptora com esse brinco nesta fazenda."):P;await p.from("receptora_fazenda_historico").insert([{receptora_id:D.id,fazenda_id:r,data_inicio:new Date().toISOString().split("T")[0],data_fim:null}]),a({title:"Receptora criada",description:"Receptora criada com sucesso"}),j(!1),T(),t==null||t()}catch(i){a({title:"Erro ao criar receptora",description:i instanceof Error?i.message:"Erro desconhecido",variant:"destructive"})}finally{z(!1)}},[s,r,a,T,t]),w=d.useCallback(async b=>{if(b.preventDefault(),!!n){if(!h.identificacao.trim()){a({title:"Erro de validação",description:"Identificação (brinco) é obrigatória",variant:"destructive"});return}try{z(!0);const i=n.identificacao,v=h.identificacao.trim(),N=i!==v,c={identificacao:v,nome:h.nome.trim()||null},{error:D}=await p.from("receptoras").update(c).eq("id",n.id);if(D)throw D.code==="23505"?new Error("Já existe uma receptora com esse brinco nesta fazenda."):D;if(N)try{await p.from("receptora_renomeacoes_historico").insert([{receptora_id:n.id,brinco_anterior:i,brinco_novo:v,data_renomeacao:new Date().toISOString(),motivo:"EDICAO_MANUAL",observacoes:null}])}catch{}a({title:"Receptora atualizada",description:N?`Receptora atualizada. Brinco alterado de "${i}" para "${v}".`:"Receptora atualizada com sucesso"}),F(!1),C(),t==null||t()}catch(i){a({title:"Erro ao atualizar receptora",description:i instanceof Error?i.message:"Erro desconhecido",variant:"destructive"})}finally{z(!1)}}},[h,n,a,C,t]);return{formData:s,setFormData:m,showDialog:l,setShowDialog:j,editFormData:h,setEditFormData:x,editingReceptora:n,showEditDialog:E,setShowEditDialog:F,submitting:S,handleSubmit:q,handleEditSubmit:w,handleEdit:$,resetForm:T,resetEditForm:C}}function Wa({fazendas:r,selectedFazendaId:t,editingReceptora:a,onSuccess:s,onClose:m}){const{toast:l}=Ne(),[j,h]=d.useState(!1),[x,n]=d.useState(""),[M,E]=d.useState(""),[F,S]=d.useState(!1),[z,T]=d.useState(!1),[C,$]=d.useState(!1),q=d.useCallback(()=>{n(""),E(""),S(!1),T(!1)},[]),w=r.filter(i=>i.id!==t);d.useEffect(()=>{(async()=>{if(!a||!x){S(!1),E(""),T(!1);return}try{const{data:v,error:N}=await p.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",x);if(N)return;const c=(v==null?void 0:v.map(o=>o.receptora_id))||[];if(c.length===0){S(!1),E(""),T(!1);return}if(a.nome&&a.nome.trim()){const{data:o,error:f}=await p.from("receptoras").select("id, nome, identificacao").in("id",c).ilike("nome",a.nome.trim());!f&&o&&o.length>0?T(!0):T(!1)}else T(!1);const{data:D,error:P}=await p.from("receptoras").select("id, identificacao").in("id",c).ilike("identificacao",a.identificacao);if(P)return;if(D&&D.length>0){S(!0);const o=async(f,y=0)=>{if(y>10)throw new Error("Não foi possível gerar um brinco disponível após várias tentativas");const B=new Date,A=String(B.getDate()).padStart(2,"0"),W=String(B.getMonth()+1).padStart(2,"0"),ae=y===0?`-MOV${A}${W}`:`-MOV${A}${W}-${y}`,X=`${f}${ae}`,{data:Q,error:ee}=await p.from("receptoras").select("id, identificacao").in("id",c).ilike("identificacao",X);return ee?X:Q&&Q.length>0?o(f,y+1):X};try{const f=await o(a.identificacao);E(f)}catch{const f=new Date,y=String(f.getDate()).padStart(2,"0"),B=String(f.getMonth()+1).padStart(2,"0");E(`${a.identificacao}-MOV${y}${B}`)}}else S(!1),E("")}catch{S(!1),E("")}})()},[a,x]);const b=d.useCallback(async()=>{if(!a||!x){l({title:"Erro de validação",description:"Selecione uma fazenda de destino",variant:"destructive"});return}if(z&&a.nome&&a.nome.trim()){l({title:"Conflito de nome",description:`Já existe uma receptora com o nome "${a.nome.trim()}" na fazenda destino. Não é possível mover esta receptora.`,variant:"destructive"});return}try{$(!0);const i=a.identificacao;let v=i;if(F&&M){v=M;const{error:c}=await p.from("receptoras").update({identificacao:v}).eq("id",a.id);if(c)throw new Error(`Erro ao atualizar brinco: ${c.message}`);try{await p.from("receptora_renomeacoes_historico").insert([{receptora_id:a.id,brinco_anterior:i,brinco_novo:v,data_renomeacao:new Date().toISOString(),motivo:"MUDANCA_FAZENDA",observacoes:"Renomeação automática devido a conflito de brinco na fazenda destino"}])}catch{}}const{error:N}=await p.rpc("mover_receptora_fazenda",{p_receptora_id:a.id,p_nova_fazenda_id:x,p_data_mudanca:new Date().toISOString().split("T")[0],p_observacoes:null});if(N){let c="Erro ao mover receptora";N.message?c=N.message:N.details&&(c=N.details),l({title:"Erro ao mover receptora",description:c,variant:"destructive"});return}l({title:"Receptora movida",description:F?`Receptora movida com sucesso. Brinco atualizado de "${i}" para "${v}" devido a conflito na fazenda destino.`:"Receptora movida para a nova fazenda com sucesso. Protocolos e histórico não foram afetados."}),h(!1),q(),m==null||m(),s==null||s()}catch(i){l({title:"Erro ao mover receptora",description:i instanceof Error?i.message:"Erro desconhecido ao mover receptora",variant:"destructive"})}finally{$(!1)}},[a,x,F,z,M,l,q,m,s]);return{showMoverFazendaDialog:j,setShowMoverFazendaDialog:h,novaFazendaId:x,setNovaFazendaId:n,novoBrincoProposto:M,temConflitoBrinco:F,temConflitoNome:z,submittingMover:C,fazendasDisponiveis:w,handleMoverFazenda:b,resetMoverState:q}}function Xa({selectedFazendaId:r,fazendas:t,onSuccess:a}){const{toast:s}=Ne(),m=new Date().toISOString().split("T")[0],[l,j]=d.useState(!1),[h,x]=d.useState({receptora_id:"",data_nascimento:m,sexo:"",observacoes:""}),[n,M]=d.useState([]),[E,F]=d.useState(!1),[S,z]=d.useState(!1),T=w=>w.includes("FEMEA")?"FEMEA":w.includes("MACHO")?"MACHO":"SEM_SEXO",C=async w=>{const{data:b,error:i}=await p.from("transferencias_embrioes").select("embriao_id, data_te").eq("receptora_id",w).eq("status_te","REALIZADA").order("data_te",{ascending:!1});if(i)throw i;if(!b||b.length===0)return[];const v=b[0].data_te,c=b.filter(_=>_.data_te===v).map(_=>_.embriao_id).filter(Boolean);if(c.length===0)return[];const{data:D}=await p.from("animais").select("embriao_id").in("embriao_id",c),P=new Set((D||[]).map(_=>_.embriao_id)),o=c.filter(_=>!P.has(_));if(o.length===0)return[];const{data:f,error:y}=await p.from("embrioes").select("id, lote_fiv_acasalamento_id").in("id",o);if(y)throw y;const B=[...new Set((f||[]).map(_=>_.lote_fiv_acasalamento_id).filter(Boolean))];let A=[],W=[],ae=[],X=[];if(B.length>0){const{data:_}=await p.from("lote_fiv_acasalamentos").select("id, aspiracao_doadora_id, dose_semen_id").in("id",B);A=_||[];const U=[...new Set(A.map(L=>L.aspiracao_doadora_id).filter(Boolean))],K=[...new Set(A.map(L=>L.dose_semen_id).filter(Boolean))];if(U.length>0){const{data:L}=await p.from("aspiracoes_doadoras").select("id, doadora_id").in("id",U);W=L||[];const V=[...new Set(W.map(H=>H.doadora_id).filter(Boolean))];if(V.length>0){const{data:H}=await p.from("doadoras").select("id, registro, raca").in("id",V);ae=H||[]}}if(K.length>0){const{data:L}=await p.from("doses_semen").select("id, touro:touros(id, nome, registro, raca)").in("id",K);X=L||[]}}const Q=new Map(A.map(_=>[_.id,_])),ee=new Map(W.map(_=>[_.id,_])),ie=new Map(ae.map(_=>[_.id,_])),se=new Map(X.map(_=>[_.id,_]));return(f||[]).map(_=>{const U=_.lote_fiv_acasalamento_id?Q.get(_.lote_fiv_acasalamento_id):void 0,K=U?ee.get(U.aspiracao_doadora_id):void 0,L=K?ie.get(K.doadora_id):void 0,V=U?se.get(U.dose_semen_id):void 0,H=(V==null?void 0:V.touro)??null;return{embriao_id:_.id,doadora_registro:L==null?void 0:L.registro,touro_nome:H==null?void 0:H.nome,raca:(L==null?void 0:L.raca)||(H==null?void 0:H.raca)}})},$=d.useCallback(async w=>{var b;try{F(!0),M([]),x({receptora_id:w.id,data_nascimento:m,sexo:"",observacoes:""}),j(!0);const[i,v]=await Promise.all([C(w.id),p.from("diagnosticos_gestacao").select("sexagem").eq("receptora_id",w.id).eq("tipo_diagnostico","SEXAGEM").order("data_diagnostico",{ascending:!1}).limit(1).maybeSingle()]),N=((b=v==null?void 0:v.data)==null?void 0:b.sexagem)||T(w.status_calculado);x(c=>({...c,sexo:N||""})),M(i),i.length===0&&s({title:"Sem embriões disponíveis",description:"Nenhum embrião elegível para criar animal foi encontrado."})}catch(i){s({title:"Erro ao preparar nascimento",description:i instanceof Error?i.message:"Erro desconhecido",variant:"destructive"})}finally{F(!1)}},[m,s]),q=d.useCallback(async()=>{if(!r){s({title:"Fazenda não selecionada",description:"Selecione a fazenda antes de registrar o nascimento.",variant:"destructive"});return}if(!h.receptora_id){s({title:"Receptora não selecionada",description:"Selecione a receptora para registrar o nascimento.",variant:"destructive"});return}if(!h.data_nascimento){s({title:"Data de nascimento obrigatória",description:"Informe a data de nascimento.",variant:"destructive"});return}if(!h.sexo){s({title:"Sexo obrigatório",description:"Selecione o sexo da prenhez.",variant:"destructive"});return}if(n.length===0){s({title:"Sem embriões vinculados",description:"Nenhum embrião encontrado para a última transferência desta receptora.",variant:"destructive"});return}try{z(!0);const w=t.find(c=>c.id===r),b=(w==null?void 0:w.cliente_id)||null,i=n.map(c=>({embriao_id:c.embriao_id,receptora_id:h.receptora_id,fazenda_id:r,cliente_id:b,data_nascimento:h.data_nascimento,sexo:h.sexo,raca:c.raca||null,pai_nome:c.touro_nome||null,mae_nome:c.doadora_registro||null,observacoes:h.observacoes||null})),{error:v}=await p.from("animais").insert(i);if(v)throw v;const{error:N}=await p.from("receptoras").update({status_reprodutivo:"VAZIA",data_provavel_parto:null}).eq("id",h.receptora_id);if(N)throw N;s({title:"Nascimento registrado",description:`${i.length} animal(is) criado(s) com sucesso.`}),j(!1),M([]),x({receptora_id:"",data_nascimento:m,sexo:"",observacoes:""}),a==null||a()}catch(w){s({title:"Erro ao registrar nascimento",description:w instanceof Error?w.message:"Erro desconhecido",variant:"destructive"})}finally{z(!1)}},[h,n,r,t,m,s,a]);return{showNascimentoDialog:l,setShowNascimentoDialog:j,nascimentoForm:h,setNascimentoForm:x,nascimentoEmbrioes:n,nascimentoLoading:E,submitting:S,handleAbrirNascimento:$,handleRegistrarNascimento:q}}function Qa({open:r,onOpenChange:t,receptora:a,fazendasDisponiveis:s,novaFazendaId:m,onFazendaChange:l,temConflitoBrinco:j,temConflitoNome:h,novoBrincoProposto:x,submitting:n,onConfirmar:M,onCancelar:E}){const F=z=>{t(z),z||E()},S=m&&!h&&!(j&&!x);return e.jsx(fe,{open:r,onOpenChange:F,children:e.jsxs(pe,{className:"max-w-md",children:[e.jsxs(ge,{children:[e.jsx(je,{children:"Mover Receptora"}),e.jsxs(ve,{children:["Mover ",a==null?void 0:a.identificacao," para outra fazenda. Protocolos e histórico reprodutivo não serão afetados."]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{htmlFor:"nova_fazenda",children:"Nova Fazenda *"}),e.jsxs(ze,{value:m,onValueChange:l,children:[e.jsx(Re,{children:e.jsx(Me,{placeholder:"Selecione a fazenda de destino"})}),e.jsx(Te,{children:s.map(z=>e.jsx(re,{value:z.id,children:z.nome},z.id))})]})]}),h&&(a==null?void 0:a.nome)&&e.jsxs("div",{className:"space-y-2 p-3 bg-red-50 border border-red-200 rounded-md",children:[e.jsx("div",{className:"flex items-start gap-2",children:e.jsx("div",{className:"text-red-800 text-sm font-medium",children:"Conflito de Nome Detectado"})}),e.jsxs("div",{className:"text-red-700 text-sm",children:['Já existe uma receptora com o nome "',a.nome.trim(),'" na fazenda destino.']}),e.jsx("div",{className:"text-red-600 text-xs",children:"Não é possível mover esta receptora. Edite o nome da receptora antes de movê-la."})]}),j&&x&&e.jsxs("div",{className:"space-y-2 p-3 bg-yellow-50 border border-yellow-200 rounded-md",children:[e.jsx("div",{className:"flex items-start gap-2",children:e.jsx("div",{className:"text-yellow-800 text-sm font-medium",children:"Conflito de Brinco Detectado"})}),e.jsxs("div",{className:"text-yellow-700 text-sm",children:['Já existe uma receptora com o brinco "',a==null?void 0:a.identificacao,'" na fazenda destino.']}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(Y,{className:"text-yellow-800 text-sm font-medium",children:"Novo Brinco Proposto:"}),e.jsx("div",{className:"p-2 bg-white border border-yellow-300 rounded text-sm font-mono text-yellow-900",children:x}),e.jsx("div",{className:"text-yellow-600 text-xs",children:"O brinco será automaticamente atualizado para permitir a movimentação."})]})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(I,{type:"button",className:"flex-1",onClick:M,disabled:n||!S,children:n?"Movendo...":"Confirmar Movimentação"}),e.jsx(I,{type:"button",variant:"outline",onClick:E,disabled:n,children:"Cancelar"})]})]})]})})}function Ka({open:r,onOpenChange:t,nascimentoForm:a,onFormChange:s,nascimentoEmbrioes:m,nascimentoLoading:l,submitting:j,onRegistrar:h,onCancelar:x}){return e.jsx(fe,{open:r,onOpenChange:t,children:e.jsxs(pe,{className:"max-w-2xl",children:[e.jsxs(ge,{children:[e.jsx(je,{children:"Registrar nascimento"}),e.jsx(ve,{children:"Crie os animais a partir da prenhez desta receptora."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{children:"Data de nascimento *"}),e.jsx(ga,{value:a.data_nascimento,onChange:n=>s({...a,data_nascimento:n||""}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{children:"Sexo *"}),e.jsxs(ze,{value:a.sexo,onValueChange:n=>s({...a,sexo:n}),children:[e.jsx(Re,{children:e.jsx(Me,{placeholder:"Selecione o sexo"})}),e.jsxs(Te,{children:[e.jsx(re,{value:"FEMEA",children:"Fêmea"}),e.jsx(re,{value:"MACHO",children:"Macho"}),e.jsx(re,{value:"SEM_SEXO",children:"Sem sexo"})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{children:"Observações"}),e.jsx(pa,{value:a.observacoes,onChange:n=>s({...a,observacoes:n.target.value}),placeholder:"Observações sobre o nascimento",rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{children:"Embriões vinculados"}),l&&e.jsx("div",{className:"text-sm text-slate-500",children:"Carregando dados..."}),!l&&m.length===0&&e.jsx("div",{className:"text-sm text-slate-500",children:"Nenhum embrião disponível para registro."}),!l&&m.length>0&&e.jsx("div",{className:"border rounded-lg p-3",children:e.jsxs(ye,{children:[e.jsx(Ce,{children:e.jsxs(oe,{children:[e.jsx(k,{children:"Embrião"}),e.jsx(k,{children:"Doadora"}),e.jsx(k,{children:"Touro"}),e.jsx(k,{children:"Raça"})]})}),e.jsx(Ee,{children:m.map(n=>e.jsxs(oe,{children:[e.jsx(O,{className:"font-medium",children:n.embriao_id.substring(0,8)}),e.jsx(O,{children:n.doadora_registro||"-"}),e.jsx(O,{children:n.touro_nome||"-"}),e.jsx(O,{children:n.raca||"-"})]},n.embriao_id))})]})})]})]}),e.jsxs(da,{children:[e.jsx(I,{type:"button",variant:"outline",onClick:x,children:"Cancelar"}),e.jsx(I,{type:"button",onClick:h,disabled:j,children:"Registrar nascimento"})]})]})})}function es({fazendaId:r,fazendaNome:t}){const a=Ie(),[s,m]=d.useState(null),{fazendas:l,filteredReceptoras:j,statusDisponiveis:h,loadingReceptoras:x,searchTerm:n,setSearchTerm:M,filtroStatus:E,setFiltroStatus:F,reloadReceptoras:S,removeReceptoraFromList:z}=Ja({selectedFazendaId:r}),{formData:T,setFormData:C,showDialog:$,setShowDialog:q,editFormData:w,setEditFormData:b,editingReceptora:i,showEditDialog:v,setShowEditDialog:N,submitting:c,handleSubmit:D,handleEditSubmit:P,handleEdit:o}=Ya({selectedFazendaId:r,onSuccess:S}),[f,y]=d.useState(null),{showMoverFazendaDialog:B,setShowMoverFazendaDialog:A,novaFazendaId:W,setNovaFazendaId:ae,novoBrincoProposto:X,temConflitoBrinco:Q,temConflitoNome:ee,submittingMover:ie,fazendasDisponiveis:se,handleMoverFazenda:_,resetMoverState:U}=Wa({fazendas:l,selectedFazendaId:r,editingReceptora:f,onSuccess:()=>{f&&z(f.id),y(null)},onClose:()=>{y(null)}}),K=u=>{y(u),U(),A(!0)},{showNascimentoDialog:L,setShowNascimentoDialog:V,nascimentoForm:H,setNascimentoForm:Pe,nascimentoEmbrioes:g,nascimentoLoading:R,submitting:ue,handleAbrirNascimento:ne,handleRegistrarNascimento:ce}=Xa({selectedFazendaId:r,fazendas:l,onSuccess:S}),xe=u=>{if(!u)return"-";try{return Na(Ta(u),"dd/MM/yyyy",{locale:wa})}catch{return"-"}};return x?e.jsx(Z,{children:e.jsx(J,{className:"py-8",children:e.jsx("div",{className:"flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"})})})}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"rounded-xl border border-border bg-gradient-to-r from-card via-card to-muted/30 p-4",children:e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex flex-wrap items-end gap-6",children:[e.jsxs("div",{className:"flex items-end gap-3",children:[e.jsx("div",{className:"w-1 h-6 rounded-full bg-primary/40 self-center"}),e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground self-center",children:[e.jsx(Ue,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:"Busca"})]}),e.jsxs("div",{className:"relative flex-1 min-w-[200px]",children:[e.jsx(Ve,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(te,{placeholder:"Buscar por brinco ou nome...",value:n,onChange:u=>M(u.target.value),className:"pl-9 h-9"})]})]}),e.jsx("div",{className:"h-10 w-px bg-border hidden lg:block"}),e.jsxs("div",{className:"flex items-end gap-3",children:[e.jsx("div",{className:"w-1 h-6 rounded-full bg-emerald-500/40 self-center"}),e.jsx("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground self-center",children:e.jsx("span",{children:"Status"})}),e.jsx("div",{className:"w-[180px]",children:e.jsxs(ze,{value:E,onValueChange:F,children:[e.jsx(Re,{className:"h-9",children:e.jsx(Me,{placeholder:"Filtrar status"})}),e.jsxs(Te,{children:[e.jsx(re,{value:"todos",children:"Todos os status"}),h.map(u=>e.jsx(re,{value:u,children:qe(u)},u))]})]})})]}),(n||E!=="todos")&&e.jsxs(I,{variant:"outline",size:"sm",onClick:()=>{M(""),F("todos")},className:"h-9",children:[e.jsx(Ge,{className:"w-4 h-4 mr-2"}),"Limpar"]})]}),e.jsxs(fe,{open:$,onOpenChange:q,children:[e.jsx(He,{asChild:!0,children:e.jsxs(I,{children:[e.jsx(Ze,{className:"w-4 h-4 mr-2"}),"Nova Receptora"]})}),e.jsxs(pe,{children:[e.jsxs(ge,{children:[e.jsx(je,{children:"Cadastrar Receptora"}),e.jsxs(ve,{children:["Adicionar receptora em ",t]})]}),e.jsxs("form",{onSubmit:D,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{htmlFor:"identificacao",children:"Brinco/Identificação *"}),e.jsx(te,{id:"identificacao",value:T.identificacao,onChange:u=>C({...T,identificacao:u.target.value}),placeholder:"Ex: 001, A123",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{htmlFor:"nome",children:"Nome (opcional)"}),e.jsx(te,{id:"nome",value:T.nome,onChange:u=>C({...T,nome:u.target.value}),placeholder:"Nome da receptora"})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(I,{type:"submit",className:"flex-1",disabled:c,children:c?"Salvando...":"Cadastrar"}),e.jsx(I,{type:"button",variant:"outline",onClick:()=>q(!1),children:"Cancelar"})]})]})]})]})]})}),e.jsxs(Z,{children:[e.jsx(de,{children:e.jsxs(me,{children:["Receptoras (",j.length,")"]})}),e.jsx(J,{children:j.length===0?e.jsx(De,{title:"Nenhuma receptora encontrada",description:n||E!=="todos"?"Tente ajustar os filtros":"Cadastre a primeira receptora desta fazenda"}):e.jsxs(ye,{children:[e.jsx(Ce,{children:e.jsxs(oe,{children:[e.jsx(k,{children:"Brinco"}),e.jsx(k,{children:"Nome"}),e.jsx(k,{children:"Status"}),e.jsx(k,{children:"Data Provável Parto"}),e.jsx(k,{className:"text-right",children:"Ações"})]})}),e.jsx(Ee,{children:j.map(u=>e.jsxs(oe,{children:[e.jsx(O,{className:"font-medium",children:u.identificacao}),e.jsx(O,{children:u.nome||"-"}),e.jsx(O,{children:e.jsx(ma,{status:u.status_calculado||u.status_reprodutivo||"DISPONIVEL"})}),e.jsx(O,{children:xe(u.data_provavel_parto)}),e.jsx(O,{className:"text-right",children:e.jsxs("div",{className:"flex gap-1 justify-end",children:[e.jsx(I,{variant:"ghost",size:"sm",onClick:()=>o(u),title:"Editar",children:e.jsx(ja,{className:"w-4 h-4"})}),e.jsx(I,{variant:"ghost",size:"sm",onClick:()=>a(`/receptoras/${u.id}/historico`),title:"Histórico",children:e.jsx(Je,{className:"w-4 h-4"})}),e.jsx(I,{variant:"ghost",size:"sm",onClick:()=>K(u),title:"Mover para outra fazenda",children:e.jsx(va,{className:"w-4 h-4"})}),(u.status_calculado||"").includes("PRENHE")&&e.jsx(I,{variant:"ghost",size:"sm",onClick:()=>ne(u),title:"Registrar nascimento",children:e.jsx(Fe,{className:"w-4 h-4"})})]})})]},u.id))})]})})]}),e.jsx(fe,{open:v,onOpenChange:N,children:e.jsxs(pe,{children:[e.jsxs(ge,{children:[e.jsx(je,{children:"Editar Receptora"}),e.jsxs(ve,{children:["Editando ",i==null?void 0:i.identificacao]})]}),e.jsxs("form",{onSubmit:P,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{htmlFor:"edit-identificacao",children:"Brinco/Identificação *"}),e.jsx(te,{id:"edit-identificacao",value:w.identificacao,onChange:u=>b({...w,identificacao:u.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{htmlFor:"edit-nome",children:"Nome"}),e.jsx(te,{id:"edit-nome",value:w.nome,onChange:u=>b({...w,nome:u.target.value})})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(I,{type:"submit",className:"flex-1",disabled:c,children:c?"Salvando...":"Salvar"}),e.jsx(I,{type:"button",variant:"outline",onClick:()=>N(!1),children:"Cancelar"})]})]})]})}),e.jsx(Qa,{open:B,onOpenChange:A,receptora:f,fazendasDisponiveis:se,novaFazendaId:W,onFazendaChange:ae,temConflitoBrinco:Q,temConflitoNome:ee,novoBrincoProposto:X,submitting:ie,onConfirmar:_,onCancelar:()=>{A(!1),y(null),U()}}),e.jsx(Ka,{open:L,onOpenChange:V,nascimentoForm:H,onFormChange:Pe,nascimentoEmbrioes:g,nascimentoLoading:R,submitting:ue,onRegistrar:ce,onCancelar:()=>V(!1)})]})}const as=["Gir","Gir Leiteiro","Girolando","Nelore","Brahman","Senepol","Angus","Holandês","Jersey"];function ss({fazendaId:r,fazendaNome:t}){var D,P;const a=Ie(),{toast:s}=Ne(),[m,l]=d.useState(!0),[j,h]=d.useState([]),[x,n]=d.useState(""),[M,E]=d.useState(null),[F,S]=d.useState(!1),[z,T]=d.useState(!1),[C,$]=d.useState({registro:"",raca:"",racaCustom:""}),[q,w]=d.useState(""),b=d.useCallback(async()=>{try{l(!0);const{data:o,error:f}=await p.from("doadoras").select("*").eq("fazenda_id",r).order("created_at",{ascending:!1});if(f)throw f;const y=await Promise.all((o||[]).map(async B=>{const{data:A}=await p.from("aspiracoes_doadoras").select("total_oocitos, data_aspiracao").eq("doadora_id",B.id).order("data_aspiracao",{ascending:!1}).limit(1).maybeSingle();return{...B,ultima_aspiracao_total_oocitos:A==null?void 0:A.total_oocitos,ultima_aspiracao_data:A==null?void 0:A.data_aspiracao}}));h(y)}catch(o){s({title:"Erro ao carregar doadoras",description:o instanceof Error?o.message:"Erro desconhecido",variant:"destructive"})}finally{l(!1)}},[r,s]);d.useEffect(()=>{b()},[b]);const i=j.filter(o=>{var y,B,A;if(!x.trim())return!0;const f=x.toLowerCase();return((y=o.nome)==null?void 0:y.toLowerCase().includes(f))||((B=o.registro)==null?void 0:B.toLowerCase().includes(f))||((A=o.raca)==null?void 0:A.toLowerCase().includes(f))}),v=o=>{w(o),$(o!=="Outra"?{...C,raca:o,racaCustom:""}:{...C,raca:"",racaCustom:""})},N=async o=>{if(o.preventDefault(),!!C.registro.trim())try{T(!0);const f=q==="Outra"?C.racaCustom:C.raca,{error:y}=await p.from("doadoras").insert({fazenda_id:r,registro:C.registro.trim(),raca:f});if(y)throw y;s({title:"Doadora criada",description:"Doadora cadastrada com sucesso."}),S(!1),$({registro:"",raca:"",racaCustom:""}),w(""),b()}catch(f){s({title:"Erro ao criar doadora",description:f instanceof Error?f.message:"Erro desconhecido",variant:"destructive"})}finally{T(!1)}},c=o=>{if(!o)return"-";switch(o){case"1_estrela":return e.jsx("div",{className:"flex items-center gap-1",children:e.jsx(le,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"})});case"2_estrelas":return e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(le,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"}),e.jsx(le,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"})]});case"3_estrelas":return e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(le,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"}),e.jsx(le,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"}),e.jsx(le,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"})]});case"diamante":return e.jsx("div",{className:"flex items-center gap-1",children:e.jsx(Sa,{className:"w-4 h-4 fill-blue-500 text-blue-500"})});default:return"-"}};return m?e.jsx(Z,{children:e.jsx(J,{className:"py-8",children:e.jsx("div",{className:"flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"})})})}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"rounded-xl border border-border bg-gradient-to-r from-card via-card to-muted/30 p-4",children:e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-end gap-3",children:[e.jsx("div",{className:"w-1 h-6 rounded-full bg-primary/40 self-center"}),e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground self-center",children:[e.jsx(Ue,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:"Busca"})]}),e.jsxs("div",{className:"relative flex-1 min-w-[250px]",children:[e.jsx(Ve,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(te,{placeholder:"Buscar por nome ou registro...",value:x,onChange:o=>n(o.target.value),className:"pl-9 h-9"})]}),x&&e.jsx(I,{variant:"outline",size:"sm",onClick:()=>n(""),className:"h-9",children:e.jsx(Ge,{className:"w-4 h-4"})})]}),e.jsxs(fe,{open:F,onOpenChange:S,children:[e.jsx(He,{asChild:!0,children:e.jsxs(I,{children:[e.jsx(Ze,{className:"w-4 h-4 mr-2"}),"Nova Doadora"]})}),e.jsxs(pe,{className:"max-w-md",children:[e.jsxs(ge,{children:[e.jsx(je,{children:"Cadastrar Doadora"}),e.jsxs(ve,{children:["Adicionar doadora em ",t]})]}),e.jsxs("form",{onSubmit:N,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{htmlFor:"registro",children:"Registro *"}),e.jsx(te,{id:"registro",value:C.registro,onChange:o=>$({...C,registro:o.target.value}),placeholder:"Registro da doadora",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{htmlFor:"raca",children:"Raca *"}),e.jsxs(ze,{value:q,onValueChange:v,children:[e.jsx(Re,{children:e.jsx(Me,{placeholder:"Selecione a raca"})}),e.jsxs(Te,{children:[as.map(o=>e.jsx(re,{value:o,children:o},o)),e.jsx(re,{value:"Outra",children:"Outra"})]})]}),q==="Outra"&&e.jsx(te,{id:"raca_custom",value:C.racaCustom,onChange:o=>$({...C,racaCustom:o.target.value,raca:o.target.value}),placeholder:"Digite a raca",className:"mt-2",required:!0})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(I,{type:"submit",className:"flex-1",disabled:z,children:z?"Salvando...":"Criar Doadora"}),e.jsx(I,{type:"button",variant:"outline",onClick:()=>S(!1),disabled:z,children:"Cancelar"})]})]})]})]})]})}),e.jsxs(Z,{children:[e.jsx(de,{children:e.jsxs(me,{children:["Doadoras (",i.length,")"]})}),e.jsx(J,{children:i.length===0?e.jsx(De,{title:"Nenhuma doadora encontrada",description:x?"Tente ajustar a busca":"Cadastre a primeira doadora desta fazenda"}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(ye,{children:[e.jsx(Ce,{children:e.jsxs(oe,{children:[e.jsx(k,{children:"Registro"}),e.jsx(k,{children:"Nome"}),e.jsx(k,{children:"Raca"}),e.jsx(k,{children:"Classificacao"}),e.jsx(k,{children:"Ultima Aspiracao"}),e.jsx(k,{children:"Oocitos"}),e.jsx(k,{children:"Estado"}),e.jsx(k,{className:"text-right",children:"Acoes"})]})}),e.jsx(Ee,{children:i.map(o=>e.jsxs(oe,{className:"cursor-pointer hover:bg-slate-50",onClick:()=>a(`/doadoras/${o.id}`),children:[e.jsx(O,{className:"font-medium",children:o.registro}),e.jsx(O,{children:o.nome||"-"}),e.jsx(O,{children:o.raca||"-"}),e.jsx(O,{children:c(o.classificacao_genetica)}),e.jsx(O,{children:o.ultima_aspiracao_data?Da(o.ultima_aspiracao_data):"-"}),e.jsx(O,{children:o.ultima_aspiracao_total_oocitos??"-"}),e.jsx(O,{children:e.jsx(G,{variant:o.disponivel_aspiracao?"default":"secondary",children:o.disponivel_aspiracao?"Disponivel":"Indisponivel"})}),e.jsx(O,{className:"text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(I,{variant:"ghost",size:"sm",onClick:f=>{f.stopPropagation(),E(o.id)},title:"Ver historico de aspiracoes",children:e.jsx(Je,{className:"w-4 h-4"})}),e.jsx(I,{variant:"ghost",size:"sm",onClick:f=>{f.stopPropagation(),a(`/doadoras/${o.id}`)},title:"Editar doadora",children:e.jsx(ba,{className:"w-4 h-4"})})]})})]},o.id))})]})})})]}),M&&e.jsx(_a,{doadoraId:M,doadoraNome:((D=j.find(o=>o.id===M))==null?void 0:D.nome)||((P=j.find(o=>o.id===M))==null?void 0:P.registro),open:!!M,onClose:()=>E(null)})]})}function Zs(){const{id:r}=Ke(),t=Ie(),{toast:a}=Ne(),[s,m]=d.useState(!0),[l,j]=d.useState(null),[h,x]=d.useState(""),[n,M]=d.useState({passo2Pendente:0,tePendente:0,dgPendente:0,sexagemPendente:0,prenhesTotal:0}),[E,F]=d.useState({total:0,porStatus:[]}),[S,z]=d.useState({total:0,porRaca:[],oocitos30d:0,aspiracoes30d:0}),[T,C]=d.useState([]);d.useEffect(()=>{r&&$()},[r]);const $=async()=>{var i,v;try{m(!0);const[N,c]=await Promise.all([p.from("fazendas").select("*, cliente:clientes(nome)").eq("id",r).single(),p.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",r)]);if(N.error)throw N.error;const D=N.data;j(D),x(((i=D.cliente)==null?void 0:i.nome)||"");const P=((v=c.data)==null?void 0:v.map(g=>g.receptora_id))||[],[o,f,y,B,A]=await Promise.all([p.from("protocolos_sincronizacao").select("id, status").eq("fazenda_id",r).in("status",["PASSO1_FECHADO","SINCRONIZADO"]),P.length>0?p.from("receptoras").select("id, status_reprodutivo, data_provavel_parto").in("id",P):Promise.resolve({data:[],error:null}),p.from("doadoras").select("id, raca").eq("fazenda_id",r),p.from("aspiracoes_doadoras").select("id, total_oocitos").eq("fazenda_id",r).gte("data_aspiracao",new Date(Date.now()-30*24*60*60*1e3).toISOString().split("T")[0]),p.from("animais").select(`
            id, data_nascimento, sexo, raca, pai_nome, mae_nome,
            receptora:receptoras(identificacao),
            embriao:embrioes(
              lote_fiv_acasalamento:lote_fiv_acasalamentos(
                aspiracao:aspiracoes_doadoras(doadora:doadoras(registro)),
                dose:doses_semen(touro:touros(nome))
              )
            )
          `).eq("fazenda_id",r).order("data_nascimento",{ascending:!1}).limit(50)]),W=o.data||[],ae=W.filter(g=>g.status==="PASSO1_FECHADO").length,X=W.filter(g=>g.status==="SINCRONIZADO").length,Q=f.data||[],ee=new Map;let ie=0,se;Q.forEach(g=>{const R=g.status_reprodutivo||"VAZIA";ee.set(R,(ee.get(R)||0)+1),R.includes("PRENHE")&&(ie++,g.data_provavel_parto&&(!se||g.data_provavel_parto<se)&&(se=g.data_provavel_parto))}),F({total:Q.length,porStatus:Array.from(ee.entries()).map(([g,R])=>({status:g,total:R})).sort((g,R)=>R.total-g.total)});let _=0,U=0;if(P.length>0){const[g,R]=await Promise.all([p.from("transferencias_embrioes").select("receptora_id").in("receptora_id",P).eq("status_te","REALIZADA"),p.from("diagnosticos_gestacao").select("receptora_id, tipo_diagnostico").in("receptora_id",P)]),ue=new Set((g.data||[]).map(u=>u.receptora_id)),ne=new Set((R.data||[]).filter(u=>u.tipo_diagnostico==="DG").map(u=>u.receptora_id)),ce=new Set((R.data||[]).filter(u=>u.tipo_diagnostico==="SEXAGEM").map(u=>u.receptora_id));_=[...ue].filter(u=>!ne.has(u)).length,U=Q.filter(u=>(u.status_reprodutivo||"").includes("PRENHE")&&ne.has(u.id)).filter(u=>!ce.has(u.id)).length}M({passo2Pendente:ae,tePendente:X,dgPendente:_,sexagemPendente:U,prenhesTotal:ie,prenhesProximoParto:se});const K=y.data||[],L=new Map;K.forEach(g=>{const R=g.raca||"Sem raça";L.set(R,(L.get(R)||0)+1)});const V=B.data||[],H=V.reduce((g,R)=>g+(R.total_oocitos||0),0);z({total:K.length,porRaca:Array.from(L.entries()).map(([g,R])=>({raca:g,total:R})).sort((g,R)=>R.total-g.total),oocitos30d:H,aspiracoes30d:V.length});const Pe=(A.data||[]).map(g=>{var ce,xe,u,ke,Oe,Be;const R=(ce=g.embriao)==null?void 0:ce.lote_fiv_acasalamento,ue=(u=(xe=R==null?void 0:R.aspiracao)==null?void 0:xe.doadora)==null?void 0:u.registro,ne=(Oe=(ke=R==null?void 0:R.dose)==null?void 0:ke.touro)==null?void 0:Oe.nome;return{id:g.id,data_nascimento:g.data_nascimento,sexo:g.sexo,raca:g.raca,receptora_brinco:(Be=g.receptora)==null?void 0:Be.identificacao,doadora:ue||g.mae_nome||null,touro:ne||g.pai_nome||null}});C(Pe)}catch(N){a({title:"Erro ao carregar dados",description:N instanceof Error?N.message:"Erro desconhecido",variant:"destructive"})}finally{m(!1)}},q=()=>{l&&(l.latitude&&l.longitude?window.open(oa(l.latitude,l.longitude),"_blank"):l.localizacao&&window.open(ia(l.localizacao),"_blank"))},w=i=>i?new Date(i).toLocaleDateString("pt-BR"):"-",b=n.passo2Pendente+n.tePendente+n.dgPendente+n.sexagemPendente;return s?e.jsx(ea,{}):l?e.jsxs("div",{className:"space-y-6",children:[e.jsx(la,{title:l.nome,description:`Cliente: ${h}`,actions:e.jsx(I,{variant:"outline",size:"icon",onClick:()=>t("/fazendas"),children:e.jsx(ya,{className:"w-4 h-4"})})}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[l.sigla&&e.jsx(Z,{children:e.jsxs(J,{className:"pt-4 flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-muted rounded-lg",children:e.jsx(aa,{className:"w-4 h-4 text-muted-foreground"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Sigla"}),e.jsx("p",{className:"font-semibold",children:l.sigla})]})]})}),l.localizacao&&e.jsx(Z,{className:"cursor-pointer hover:bg-secondary",onClick:q,children:e.jsxs(J,{className:"pt-4 flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-green-100 rounded-lg",children:e.jsx(Ca,{className:"w-4 h-4 text-primary"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Localização"}),e.jsx("p",{className:"font-medium truncate",children:l.localizacao})]}),e.jsx(ra,{className:"w-4 h-4 text-muted-foreground"})]})}),l.responsavel&&e.jsx(Z,{children:e.jsxs(J,{className:"pt-4 flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:e.jsx(Ea,{className:"w-4 h-4 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Responsável"}),e.jsx("p",{className:"font-medium",children:l.responsavel})]})]})}),l.contato_responsavel&&e.jsx(Z,{children:e.jsxs(J,{className:"pt-4 flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-purple-100 rounded-lg",children:e.jsx(za,{className:"w-4 h-4 text-purple-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Contato"}),e.jsx("p",{className:"font-medium",children:l.contato_responsavel})]})]})})]}),e.jsxs(na,{defaultValue:"resumo",className:"space-y-4",children:[e.jsxs(ca,{className:"grid w-full grid-cols-4",children:[e.jsxs(be,{value:"resumo",className:"flex items-center gap-2",children:[e.jsx(Le,{className:"w-4 h-4"}),"Resumo",b>0&&e.jsx(G,{variant:"destructive",className:"ml-1 h-5 w-5 p-0 flex items-center justify-center text-xs",children:b})]}),e.jsxs(be,{value:"receptoras",className:"flex items-center gap-2",children:[e.jsx($e,{className:"w-4 h-4"}),"Receptoras",e.jsx(G,{variant:"secondary",className:"ml-1",children:E.total})]}),e.jsxs(be,{value:"doadoras",className:"flex items-center gap-2",children:[e.jsx(sa,{className:"w-4 h-4"}),"Doadoras",e.jsx(G,{variant:"secondary",className:"ml-1",children:S.total})]}),e.jsxs(be,{value:"animais",className:"flex items-center gap-2",children:[e.jsx(Fe,{className:"w-4 h-4"}),"Nascimentos",e.jsx(G,{variant:"secondary",className:"ml-1",children:T.length})]})]}),e.jsxs(_e,{value:"resumo",className:"space-y-4",children:[b>0&&e.jsxs(Z,{className:"border-amber-200 bg-amber-50",children:[e.jsx(de,{className:"pb-2",children:e.jsxs(me,{className:"text-base flex items-center gap-2 text-amber-800",children:[e.jsx(Ma,{className:"w-4 h-4"}),"Serviços Pendentes"]})}),e.jsx(J,{children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:[n.passo2Pendente>0&&e.jsxs(we,{to:"/protocolos",className:"flex items-center justify-between p-3 bg-white rounded-lg border hover:border-green-300 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ra,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm",children:"2º Passo"})]}),e.jsx(G,{children:n.passo2Pendente})]}),n.tePendente>0&&e.jsxs(we,{to:"/transferencia",className:"flex items-center justify-between p-3 bg-white rounded-lg border hover:border-green-300 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ta,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm",children:"TE"})]}),e.jsx(G,{children:n.tePendente})]}),n.dgPendente>0&&e.jsxs(we,{to:"/dg",className:"flex items-center justify-between p-3 bg-white rounded-lg border hover:border-green-300 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Le,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm",children:"DG"})]}),e.jsx(G,{children:n.dgPendente})]}),n.sexagemPendente>0&&e.jsxs(we,{to:"/sexagem",className:"flex items-center justify-between p-3 bg-white rounded-lg border hover:border-green-300 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Fe,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm",children:"Sexagem"})]}),e.jsx(G,{children:n.sexagemPendente})]})]})})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs(Z,{children:[e.jsx(de,{className:"pb-2",children:e.jsxs(me,{className:"text-base flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx($e,{className:"w-4 h-4"}),"Receptoras"]}),e.jsx("span",{className:"text-2xl font-bold",children:E.total})]})}),e.jsx(J,{children:E.porStatus.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Nenhuma receptora"}):e.jsxs("div",{className:"space-y-2",children:[E.porStatus.slice(0,5).map(i=>e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:qe(i.status)}),e.jsx(G,{variant:"outline",children:i.total})]},i.status)),n.prenhesProximoParto&&e.jsxs("div",{className:"pt-2 mt-2 border-t text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Próximo parto: "}),e.jsx("span",{className:"font-medium",children:w(n.prenhesProximoParto)})]})]})})]}),e.jsxs(Z,{children:[e.jsx(de,{className:"pb-2",children:e.jsxs(me,{className:"text-base flex items-center justify-between",children:[e.jsx("span",{children:"Doadoras"}),e.jsx("span",{className:"text-2xl font-bold",children:S.total})]})}),e.jsx(J,{children:S.total===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Nenhuma doadora"}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{className:"p-2 bg-secondary rounded",children:[e.jsx("p",{className:"text-muted-foreground",children:"Aspirações (30d)"}),e.jsx("p",{className:"font-semibold",children:S.aspiracoes30d})]}),e.jsxs("div",{className:"p-2 bg-secondary rounded",children:[e.jsx("p",{className:"text-muted-foreground",children:"Oócitos (30d)"}),e.jsx("p",{className:"font-semibold",children:S.oocitos30d})]})]}),S.porRaca.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1",children:S.porRaca.slice(0,4).map(i=>e.jsxs(G,{variant:"secondary",className:"text-xs",children:[i.raca,": ",i.total]},i.raca))})]})})]})]})]}),e.jsx(_e,{value:"receptoras",children:e.jsx(es,{fazendaId:r,fazendaNome:l.nome})}),e.jsx(_e,{value:"doadoras",children:e.jsx(ss,{fazendaId:r,fazendaNome:l.nome})}),e.jsx(_e,{value:"animais",children:e.jsxs(Z,{children:[e.jsx(de,{children:e.jsx(me,{className:"text-base",children:"Animais Nascidos"})}),e.jsx(J,{children:T.length===0?e.jsx(De,{title:"Nenhum animal registrado",description:"Os nascimentos registrados aparecerão aqui."}):e.jsxs(ye,{children:[e.jsx(Ce,{children:e.jsxs(oe,{children:[e.jsx(k,{children:"Data"}),e.jsx(k,{children:"Sexo"}),e.jsx(k,{children:"Raça"}),e.jsx(k,{children:"Receptora"}),e.jsx(k,{children:"Doadora x Touro"})]})}),e.jsx(Ee,{children:T.map(i=>e.jsxs(oe,{children:[e.jsx(O,{children:w(i.data_nascimento)}),e.jsx(O,{children:e.jsx(G,{variant:i.sexo==="FEMEA"?"default":"secondary",children:i.sexo==="FEMEA"?"F":i.sexo==="MACHO"?"M":"?"})}),e.jsx(O,{children:i.raca||"-"}),e.jsx(O,{children:i.receptora_brinco||"-"}),e.jsxs(O,{className:"text-sm",children:[i.doadora||"?"," x ",i.touro||"?"]})]},i.id))})]})})]})})]})]}):e.jsx(De,{title:"Fazenda não encontrada",description:"Volte para a lista e selecione outra fazenda.",action:e.jsx(I,{onClick:()=>t("/fazendas"),variant:"outline",children:"Voltar"})})}export{Zs as default};
