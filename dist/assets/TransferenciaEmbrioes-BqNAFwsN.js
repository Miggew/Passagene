import{r as s,s as c,j as e,B as de,h as aa,a5 as ta}from"./index-6OJhfjKP.js";import{C as ra,a as oa,b as ia,d as sa}from"./card-D-gf0lmS.js";import{S as qe,a as Fe,b as ke,c as Me,d as Be}from"./select-B7v4ZPbC.js";import{I as Ve}from"./input-_UHZ9n1P.js";import{L as te}from"./label-BTrzYRkl.js";import{T as na}from"./textarea-DMqLWH95.js";import{P as ca}from"./PageHeader-P7sO2uqv.js";import{u as Xe}from"./use-toast-DasFaehQ.js";import{b as da}from"./dataEnrichment-CmjlCNan.js";import{v as la}from"./receptoraStatus-Bay2bJct.js";import{D as pa,b as _a,c as fa,d as ua,e as ma,f as ha}from"./dialog-CFjhGf-B.js";import{T as He,a as Qe,b as Ie,c as H,d as Ue,e as Q}from"./table-B_Z-CztY.js";import{f as Pe}from"./dateUtils-eJ5e6apA.js";import{F as $e}from"./file-text-BxNF5_jJ.js";import{B as ye}from"./badge-ChTtRB_d.js";import{C as va,Q as ga}from"./QualidadeSemaforo-3E-fl4SO.js";import{T as xa}from"./trash-2-C555fPdQ.js";import{S as Ye}from"./StatusBadge-BqOiwe1r.js";import{T as ba}from"./triangle-alert-pkIeF1ja.js";import{S as ja}from"./switch-BFbS250T.js";import{D as We}from"./DatePickerBR-CEQaSWUC.js";import"./index-CtR1jODk.js";import"./check-CgmfRmMI.js";import"./x-kO07YPaG.js";import"./popover-CUxnE3Xp.js";import"./statusLabels-IklKT8dE.js";import"./chevron-right-BdMx8zjt.js";const Ea=!0;function wa({dataPasso2:a,incluirCioLivre:f,filtroClienteId:N,filtroRaca:O,formData:b}){const{toast:z}=Xe(),[d,I]=s.useState([]),[E,T]=s.useState([]),[p,C]=s.useState([]),[k,l]=s.useState([]),[v,B]=s.useState([]),[V,q]=s.useState([]),[ae,X]=s.useState(!0),[le,ge]=s.useState(!1),[D,xe]=s.useState([]),[fe,je]=s.useState([]),[Z,Ee]=s.useState({}),[Ne,P]=s.useState({}),U=s.useCallback(async t=>{var u,h;if(!t.fazenda_id||!((((u=t.transferenciasIdsSessao)==null?void 0:u.length)||0)>0||(((h=t.transferenciasSessao)==null?void 0:h.length)||0)>0))return;let _=null;if(t.pacote_id){const m=t.pacote_id.substring(0,36);/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(m)&&(_=m)}const g={pacote_id:_,data_passo2:t.data_passo2||null,data_te:t.data_te||null,veterinario_responsavel:t.veterinario_responsavel||null,tecnico_responsavel:t.tecnico_responsavel||null,origem_embriao:t.origem_embriao||null,filtro_cliente_id:t.filtro_cliente_id||null,filtro_raca:t.filtro_raca||null,incluir_cio_livre:!!t.incluir_cio_livre,transferencias_ids:t.transferenciasIdsSessao||[],protocolo_receptora_ids:t.transferenciasSessao||[],updated_at:new Date().toISOString()};try{const{data:m}=await c.from("transferencias_sessoes").select("id").eq("fazenda_id",t.fazenda_id).eq("status","ABERTA").maybeSingle();m?await c.from("transferencias_sessoes").update(g).eq("id",m.id):await c.from("transferencias_sessoes").insert({...g,fazenda_id:t.fazenda_id,status:"ABERTA"})}catch{}},[]),L=s.useCallback(async t=>{t&&await c.from("transferencias_sessoes").update({status:"ENCERRADA",updated_at:new Date().toISOString()}).eq("fazenda_id",t).eq("status","ABERTA")},[]),$=s.useCallback(t=>{const n=Array.isArray(t==null?void 0:t.transferencias_ids)?t.transferencias_ids:[],_=Array.isArray(t==null?void 0:t.protocolo_receptora_ids)?t.protocolo_receptora_ids:[],g=(t==null?void 0:t.origem_embriao)==="CONGELADO"?"CONGELADO":"PACOTE",u=(t==null?void 0:t.data_te)||new Date().toISOString().split("T")[0];return{transferenciasIds:n,protocoloReceptoraIds:_,filtros:{origem_embriao:g,filtro_cliente_id:(t==null?void 0:t.filtro_cliente_id)||"",filtro_raca:(t==null?void 0:t.filtro_raca)||"",data_passo2:(t==null?void 0:t.data_passo2)||new Date().toISOString().split("T")[0],incluir_cio_livre:!!(t!=null&&t.incluir_cio_livre)},camposPacote:{data_te:u,veterinario_responsavel:(t==null?void 0:t.veterinario_responsavel)||"",tecnico_responsavel:(t==null?void 0:t.tecnico_responsavel)||""},formData:{fazenda_id:(t==null?void 0:t.fazenda_id)||"",pacote_id:(t==null?void 0:t.pacote_id)||"",protocolo_id:(t==null?void 0:t.protocolo_id)||"",data_te:u,veterinario_responsavel:(t==null?void 0:t.veterinario_responsavel)||"",tecnico_responsavel:(t==null?void 0:t.tecnico_responsavel)||""}}},[]),w=s.useCallback(t=>{je(t.transferenciasIds),xe(t.protocoloReceptoraIds)},[]),se=s.useCallback(async()=>{try{const{data:t}=await c.from("transferencias_sessoes").select("*").eq("status","ABERTA").order("updated_at",{ascending:!1}).limit(1);if(t&&t.length>0){const n=t[0],_=Array.isArray(n==null?void 0:n.transferencias_ids)?n.transferencias_ids:[];let g=Array.isArray(n==null?void 0:n.protocolo_receptora_ids)?n.protocolo_receptora_ids:[];if(g.length===0&&_.length>0){const{data:m}=await c.from("transferencias_embrioes").select("protocolo_receptora_id").in("id",_);m&&(g=[...new Set(m.map(F=>F.protocolo_receptora_id).filter(F=>!!F))])}let u=!1;if(g.length>0){const{data:m}=await c.from("protocolo_receptoras").select("id, status").in("id",g);m&&(u=m.some(F=>F.status!=="UTILIZADA"))}if(!u)return await c.from("transferencias_sessoes").update({status:"ENCERRADA",updated_at:new Date().toISOString()}).eq("id",n.id),null;const h=$(n);return w({transferenciasIds:h.transferenciasIds,protocoloReceptoraIds:h.protocoloReceptoraIds}),h}return null}catch{return null}},[$,w]),ne=s.useCallback(async()=>{try{const{data:t,error:n}=await c.from("clientes").select("id, nome").order("nome",{ascending:!0});if(n)throw n;T(t||[])}catch{T([])}},[]),K=s.useCallback(async()=>{try{let t=c.from("protocolos_sincronizacao").select("id");a&&(t=t.eq("passo2_data",a));const{data:n,error:_}=await t;if(_)throw _;const g=[...new Set((n||[]).map(W=>W.id).filter(Boolean))];if(g.length===0){I([]),X(!1);return}const{data:u,error:h}=await c.from("v_protocolo_receptoras_status").select("receptora_id").eq("fase_ciclo","SINCRONIZADA").in("protocolo_id",g);if(h)throw h;const m=[...new Set((u||[]).map(W=>W.receptora_id).filter(Boolean))];if(m.length===0){I([]),X(!1);return}const{data:F,error:G}=await c.from("vw_receptoras_fazenda_atual").select("fazenda_id_atual").in("receptora_id",m);if(G)throw G;const oe=[...new Set((F||[]).map(W=>W.fazenda_id_atual).filter(Boolean))];if(oe.length===0){I([]),X(!1);return}const{data:me,error:J}=await c.from("fazendas").select("id, nome").in("id",oe).order("nome",{ascending:!0});if(J)throw J;I(me||[]),X(!1)}catch(t){z({title:"Erro ao carregar fazendas",description:t instanceof Error?t.message:"Erro desconhecido",variant:"destructive"}),X(!1)}},[a,z]),j=s.useCallback(async()=>{var t;try{const[n,_]=await Promise.all([c.from("transferencias_embrioes").select("embriao_id"),c.from("embrioes").select("*").eq("status_atual","FRESCO").order("created_at",{ascending:!1})]),g=((t=n.data)==null?void 0:t.map(r=>r.embriao_id))||[];if(_.error)throw _.error;const u=[..._.data||[]].filter(r=>!g.includes(r.id)&&r.status_atual!=="TRANSFERIDO").sort((r,x)=>{const o=new Date(r.created_at||0).getTime();return new Date(x.created_at||0).getTime()-o});if(!u||u.length===0){C([]);return}const h=u.map(r=>r.id),m=[...new Set(u.filter(r=>r.lote_fiv_id).map(r=>r.lote_fiv_id))];let F=new Map,G=new Map,oe=new Map,me=new Map;const[J,W,Re]=await Promise.all([h.length>0?c.from("v_embrioes_disponiveis_te").select("embriao_id, d7_pronto, d8_limite").in("embriao_id",h):Promise.resolve({data:null,error:null}),c.from("fazendas").select("id, nome"),m.length>0?c.from("lotes_fiv").select("id, pacote_aspiracao_id").in("id",m):Promise.resolve({data:null,error:null})]),Se=new Map((J.data||[]).map(r=>[r.embriao_id,{d7_pronto:r.d7_pronto,d8_limite:r.d8_limite}]));W.data&&(me=new Map(W.data.map(r=>[r.id,r.nome])));const pe=Re.data;if(pe&&pe.length>0){pe.forEach(x=>{x.pacote_aspiracao_id&&G.set(x.id,x.pacote_aspiracao_id)});const r=[...new Set(pe.map(x=>x.pacote_aspiracao_id).filter(Boolean))];if(r.length>0){const[x,o]=await Promise.all([c.from("pacotes_aspiracao").select("*").in("id",r),c.from("pacotes_aspiracao_fazendas_destino").select("pacote_aspiracao_id, fazenda_destino_id").in("pacote_aspiracao_id",r)]),R=o.data;R&&R.forEach(y=>{const ee=oe.get(y.pacote_aspiracao_id)||[];ee.includes(y.fazenda_destino_id)||ee.push(y.fazenda_destino_id),oe.set(y.pacote_aspiracao_id,ee)});const S=x.data;S&&S.forEach(y=>{if(y.fazenda_destino_id){const ee=oe.get(y.id)||[];ee.includes(y.fazenda_destino_id)||ee.push(y.fazenda_destino_id),oe.set(y.id,ee)}F.set(y.id,{id:y.id,data_aspiracao:y.data_aspiracao,fazenda_nome:me.get(y.fazenda_id),quantidade_doadoras:0,horario_inicio:y.horario_inicio,veterinario_responsavel:y.veterinario_responsavel,total_oocitos:y.total_oocitos})})}}const Ce=u.map(r=>r.lote_fiv_acasalamento_id).filter(r=>!!r);let he=new Map,Ae=new Map;if(Ce.length>0){const{data:r}=await c.from("lote_fiv_acasalamentos").select("id, aspiracao_doadora_id, dose_semen_id").in("id",Ce);if(r){he=new Map(r.map(M=>[M.id,M]));const x=[...new Set(r.map(M=>M.aspiracao_doadora_id).filter(Boolean))],o=[...new Set(r.map(M=>M.dose_semen_id).filter(Boolean))],[R,S]=await Promise.all([x.length>0?c.from("aspiracoes_doadoras").select("id, doadora_id").in("id",x):Promise.resolve({data:null}),o.length>0?c.from("doses_semen").select("id, touro_id, touro:touros(id, nome, registro, raca)").in("id",o):Promise.resolve({data:null})]),y=R.data,ee=S.data;if(ee&&(Ae=new Map(ee.map(M=>{const ce=M.touro,ve=Array.isArray(ce)?ce[0]:ce;return[M.id,(ve==null?void 0:ve.nome)||"Touro desconhecido"]})),r.forEach(M=>{if(M.dose_semen_id){const ce=Ae.get(M.dose_semen_id);if(ce){const ve=he.get(M.id);he.set(M.id,{...ve,touro_nome:ce})}}})),y){const M=[...new Set(y.map(ce=>ce.doadora_id))];if(M.length>0){const{data:ce}=await c.from("doadoras").select("id, registro").in("id",M);if(ce){const ve=new Map(ce.map(ie=>[ie.id,ie.registro])),Le=new Map(y.map(ie=>[ie.id,ie.doadora_id]));r.forEach(ie=>{if(ie.aspiracao_doadora_id){const Je=Le.get(ie.aspiracao_doadora_id);if(Je){const Ke=ve.get(Je);if(Ke){const ea=he.get(ie.id);he.set(ie.id,{...ea,doadora_registro:Ke})}}}})}}}}}const be=new Map;u.forEach(r=>{var y,ee;if(!r.lote_fiv_id||!r.created_at)return;const x=r.created_at.split("T")[0],o=`${r.lote_fiv_id}-${x}`;let R=be.get(o);if(!R){const M=G.get(r.lote_fiv_id),ce=M?F.get(M):void 0,ve=M?oe.get(M)||[]:[],Le=ve.map(ie=>me.get(ie)).filter(ie=>!!ie);R={id:o,lote_fiv_id:r.lote_fiv_id,data_despacho:x,fazendas_destino_ids:ve,fazendas_destino_nomes:Le,pacote_info:ce||{id:M||"",data_aspiracao:x,quantidade_doadoras:0},embrioes:[],total:0,frescos:0,congelados:0},be.set(o,R)}const S=he.get(r.lote_fiv_acasalamento_id||"");R.embrioes.push({...r,doadora_registro:S==null?void 0:S.doadora_registro,touro_nome:S==null?void 0:S.touro_nome,d7_pronto:(y=Se.get(r.id))==null?void 0:y.d7_pronto,d8_limite:(ee=Se.get(r.id))==null?void 0:ee.d8_limite}),R.total++,r.status_atual==="FRESCO"&&R.frescos++,r.status_atual==="CONGELADO"&&R.congelados++});const ze=[...new Set(Array.from(be.values()).map(r=>r.lote_fiv_id))],{data:we}=await c.from("lotes_fiv").select("id, disponivel_para_transferencia").in("id",ze),Te=new Map((we==null?void 0:we.map(r=>[r.id,r.disponivel_para_transferencia===!0]))||[]),i=Array.from(be.values()).map(r=>{const x=r.embrioes.filter(o=>!o.classificacao||o.classificacao.trim()==="").length;return{pacote:r,semClassificacao:x,total:r.total,disponivel:Te.get(r.lote_fiv_id)}}).filter(r=>r.disponivel!==!1&&r.total>0&&r.semClassificacao===0).map(r=>r.pacote).sort((r,x)=>x.data_despacho.localeCompare(r.data_despacho));C(i)}catch(n){z({title:"Erro ao carregar pacotes de embriões",description:n instanceof Error?n.message:"Erro desconhecido",variant:"destructive"}),C([])}},[z]),A=s.useCallback(async()=>{var n;const t=O.trim().toLowerCase();if(!N&&!t){B([]);return}try{ge(!0);let _=c.from("embrioes").select("*").eq("status_atual","CONGELADO").not("cliente_id","is",null);N&&(_=_.eq("cliente_id",N));const[g,u]=await Promise.all([c.from("transferencias_embrioes").select("embriao_id"),_.order("created_at",{ascending:!1})]);if(g.error)throw g.error;if(u.error)throw u.error;const h=((n=g.data)==null?void 0:n.map(F=>F.embriao_id))||[],m=(u.data||[]).filter(F=>!h.includes(F.id)&&F.status_atual!=="TRANSFERIDO");if(m.length===0){B([]);return}B(m)}catch(_){z({title:"Erro ao carregar embriões congelados",description:_ instanceof Error?_.message:"Erro desconhecido",variant:"destructive"}),B([])}finally{ge(!1)}},[N,O,z]),re=s.useCallback(async t=>{try{const{data:n,error:_}=await c.from("receptoras_cio_livre").select("receptora_id, data_cio").eq("status","DISPONIVEL").eq("fazenda_id",t);if(_&&_.code!=="PGRST205")throw _;const g=(n||[]).map(G=>G.receptora_id).filter(G=>!!G);if(g.length===0)return{receptoras:[],receptorasDisponiveis:0};const{data:u,error:h}=await c.from("receptoras").select("id, identificacao, status_reprodutivo").in("id",g);if(h)throw h;const m=new Map((n||[]).map(G=>[G.receptora_id,G.data_cio])),F=(u||[]).map(G=>({receptora_id:G.id,brinco:G.identificacao||"N/A",identificacao:G.identificacao||"",protocolo_id:void 0,protocolo_receptora_id:void 0,data_te_prevista:void 0,data_limite_te:void 0,quantidade_embrioes:0,ciclando_classificacao:void 0,qualidade_semaforo:void 0,origem:"CIO_LIVRE",data_cio:m.get(G.id),status_reprodutivo:G.status_reprodutivo}));return{receptoras:F,receptorasDisponiveis:F.length}}catch(n){return z({title:"Erro ao carregar receptoras",description:n instanceof Error?n.message:"Erro desconhecido",variant:"destructive"}),{receptoras:[],receptorasDisponiveis:0}}},[z]),Y=s.useCallback(async(t,n)=>{const _=(n==null?void 0:n.contagem)??Z,g=(n==null?void 0:n.info)??Ne;try{let u=c.from("protocolos_sincronizacao").select("id");a&&(u=u.eq("passo2_data",a));const{data:h,error:m}=await u;if(m)throw m;const F=[...new Set((h||[]).map(o=>o.id).filter(Boolean))];if(F.length===0)return q([]),{receptorasDisponiveis:0};const{data:G,error:oe}=await c.from("v_protocolo_receptoras_status").select("receptora_id, brinco, data_te_prevista, data_limite_te, protocolo_id").eq("fase_ciclo","SINCRONIZADA").in("protocolo_id",F);if(oe&&oe.code!=="PGRST205")throw oe;const me=G||[],J=[...new Set(me.map(o=>o.receptora_id).filter(Boolean))];if(J.length===0)return q([]),{receptorasDisponiveis:0};const{data:W,error:Re}=await c.from("vw_receptoras_fazenda_atual").select("receptora_id").in("receptora_id",J).eq("fazenda_id_atual",t);if(Re)throw Re;const Se=new Set((W||[]).map(o=>o.receptora_id).filter(Boolean)),pe=me.filter(o=>Se.has(o.receptora_id)),Ce=[...new Set(pe.map(o=>o.receptora_id).filter(Boolean))];if(Ce.length===0)return q([]),{receptorasDisponiveis:0};const{data:he,error:Ae}=await c.from("receptoras").select("id, identificacao, status_reprodutivo").in("id",Ce);if(Ae)throw Ae;const be=new Map((he||[]).map(o=>[o.id,o])),ze=[...new Set(pe.map(o=>o.protocolo_id).filter(Boolean))];let we=[];if(ze.length>0){const{data:o,error:R}=await c.from("protocolo_receptoras").select("id, receptora_id, protocolo_id, status, ciclando_classificacao, qualidade_semaforo, observacoes").in("protocolo_id",ze).neq("status","INAPTA").neq("status","UTILIZADA");if(R&&R.code!=="PGRST205")throw R;we=o||[]}const Te=new Map(we.map(o=>[o.receptora_id,o]));let i=pe.map(o=>{const R=be.get(o.receptora_id),S=Te.get(o.receptora_id),y=_[o.receptora_id]||0;return{receptora_id:o.receptora_id,brinco:o.brinco||(R==null?void 0:R.identificacao)||"N/A",identificacao:(R==null?void 0:R.identificacao)||"",protocolo_id:(S==null?void 0:S.protocolo_id)||o.protocolo_id,protocolo_receptora_id:(S==null?void 0:S.id)||"",data_te_prevista:o.data_te_prevista,data_limite_te:o.data_limite_te,quantidade_embrioes:y,ciclando_classificacao:(S==null?void 0:S.ciclando_classificacao)??null,qualidade_semaforo:(S==null?void 0:S.qualidade_semaforo)??null,observacoes:(S==null?void 0:S.observacoes)??null,origem:"PROTOCOLO",status_reprodutivo:R==null?void 0:R.status_reprodutivo}}).filter(o=>o.status_reprodutivo==="SINCRONIZADA"||_[o.receptora_id]>0);if(f){const{receptoras:o}=await re(t);i=[...i,...o]}const r=Object.values(g).filter(o=>(_[o.receptora_id]||0)>=1),x=new Set(i.map(o=>o.receptora_id));return r.forEach(o=>{x.has(o.receptora_id)||i.push({...o,quantidade_embrioes:_[o.receptora_id]||0})}),i=i.map(o=>({...o,quantidade_embrioes:_[o.receptora_id]||0})),q(i),{receptorasDisponiveis:i.length}}catch(u){return z({title:"Erro ao carregar receptoras",description:u instanceof Error?u.message:"Erro desconhecido",variant:"destructive"}),q([]),{receptorasDisponiveis:0}}},[a,f,Z,Ne,re,z]),ue=s.useCallback(async(t,n)=>{await Y(t,n)},[Y]);return s.useEffect(()=>{if(b.fazenda_id){const t=p.filter(n=>n.fazendas_destino_ids.includes(b.fazenda_id));l(t)}else l([])},[b.fazenda_id,p]),s.useEffect(()=>{(async()=>{if(fe.length===0){Ee({}),P({});return}const{data:n,error:_}=await c.from("transferencias_embrioes").select("id, receptora_id, protocolo_receptora_id, receptoras(id, identificacao, status_reprodutivo)").in("id",fe);if(_)return;const g={},u={};(n||[]).forEach(h=>{if(!h.receptora_id)return;g[h.receptora_id]=(g[h.receptora_id]||0)+1;const m=Array.isArray(h.receptoras)?h.receptoras[0]:h.receptoras;u[h.receptora_id]={receptora_id:h.receptora_id,brinco:(m==null?void 0:m.identificacao)||"N/A",identificacao:(m==null?void 0:m.identificacao)||"",protocolo_id:void 0,protocolo_receptora_id:h.protocolo_receptora_id||"",quantidade_embrioes:g[h.receptora_id],origem:h.protocolo_receptora_id?"PROTOCOLO":"CIO_LIVRE",status_reprodutivo:(m==null?void 0:m.status_reprodutivo)||"SERVIDA"}}),Ee(g),P(u)})()},[fe]),{fazendas:d,clientes:E,pacotes:p,pacotesFiltrados:k,embrioesCongelados:v,receptoras:V,setReceptoras:q,loading:ae,loadingCongelados:le,transferenciasSessao:D,setTransferenciasSessao:xe,transferenciasIdsSessao:fe,setTransferenciasIdsSessao:je,contagemSessaoPorReceptora:Z,setContagemSessaoPorReceptora:Ee,receptorasSessaoInfo:Ne,setReceptorasSessaoInfo:P,loadFazendas:K,loadPacotes:j,loadClientes:ne,loadEmbrioesCongelados:A,carregarReceptorasDaFazenda:Y,recarregarReceptoras:ue,salvarSessaoNoBanco:U,encerrarSessaoNoBanco:L,restaurarSessaoEmAndamento:se}}const _e={origemEmbriao:"PACOTE",filtroClienteId:"",filtroRaca:"",dataPasso2:"",incluirCioLivre:!1,embrioesPage:1},De={showRelatorioDialog:!1,relatorioData:[],isVisualizacaoApenas:!1};function Na(){const[a,f]=s.useState(_e.origemEmbriao),[N,O]=s.useState(_e.filtroClienteId),[b,z]=s.useState(_e.filtroRaca),[d,I]=s.useState(_e.dataPasso2),[E,T]=s.useState(_e.incluirCioLivre),[p,C]=s.useState(_e.embrioesPage),[k,l]=s.useState(De.showRelatorioDialog),[v,B]=s.useState(De.relatorioData),[V,q]=s.useState(De.isVisualizacaoApenas),ae=s.useCallback(()=>{f(_e.origemEmbriao),O(_e.filtroClienteId),z(_e.filtroRaca),I(_e.dataPasso2),T(_e.incluirCioLivre),C(_e.embrioesPage)},[]),X=s.useCallback(()=>{l(De.showRelatorioDialog),B(De.relatorioData),q(De.isVisualizacaoApenas)},[]),le=s.useCallback(()=>{ae(),X()},[ae,X]),ge=s.useCallback(Z=>{B(Z),q(!0),l(!0)},[]),D=s.useCallback(Z=>{B(Z),q(!1),l(!0)},[]),xe=s.useCallback(()=>{l(!1),q(!1)},[]),fe=s.useCallback(Z=>{f(Z.origem_embriao==="CONGELADO"?"CONGELADO":"PACOTE"),O(Z.filtro_cliente_id||""),z(Z.filtro_raca||""),I(Z.data_passo2||new Date().toISOString().split("T")[0]),T(!!Z.incluir_cio_livre),Z.embrioes_page&&C(Z.embrioes_page)},[]),je=s.useCallback(()=>({origemEmbriao:a,filtroClienteId:N,filtroRaca:b,dataPasso2:d,incluirCioLivre:E,embrioesPage:p}),[a,N,b,d,E,p]);return{origemEmbriao:a,setOrigemEmbriao:f,filtroClienteId:N,setFiltroClienteId:O,filtroRaca:b,setFiltroRaca:z,dataPasso2:d,setDataPasso2:I,incluirCioLivre:E,setIncluirCioLivre:T,embrioesPage:p,setEmbrioesPage:C,showRelatorioDialog:k,setShowRelatorioDialog:l,relatorioData:v,setRelatorioData:B,isVisualizacaoApenas:V,setIsVisualizacaoApenas:q,resetFilters:ae,resetRelatorio:X,resetAll:le,abrirRelatorioVisualizacao:ge,abrirRelatorioEncerramento:D,fecharRelatorio:xe,aplicarFiltrosSessao:fe,getFiltersState:je}}function Ca({formData:a,setFormData:f,origemEmbriao:N,receptoras:O,contagemSessaoPorReceptora:b,setContagemSessaoPorReceptora:z,receptorasSessaoInfo:d,setReceptorasSessaoInfo:I,transferenciasSessao:E,setTransferenciasSessao:T,transferenciasIdsSessao:p,setTransferenciasIdsSessao:C,numerosFixosMap:k,setSubmitting:l,setRelatorioData:v,setShowRelatorioDialog:B,setIsVisualizacaoApenas:V,resetFiltros:q,loadPacotes:ae,loadEmbrioesCongelados:X,recarregarReceptoras:le,encerrarSessaoNoBanco:ge}){const{toast:D}=Xe(),xe=s.useCallback(async P=>{try{const{data:U,error:L}=await c.from("protocolo_receptoras").select("protocolo_id").eq("id",P).single();if(L||!(U!=null&&U.protocolo_id))return;const $=U.protocolo_id,{data:w,error:se}=await c.from("protocolo_receptoras").select("status").eq("protocolo_id",$);if(se||!w)return;if(w.filter(K=>K.status==="APTA"||K.status==="INICIADA").length===0){const j=w.filter(A=>A.status==="UTILIZADA").length>0?"EM_TE":"FECHADO";await c.from("protocolos_sincronizacao").update({status:j}).eq("id",$)}}catch(U){console.error("Erro ao verificar status do protocolo:",U)}},[]),fe=s.useCallback(async()=>{if(!a.receptora_id){D({title:"Nenhuma receptora selecionada",description:"Selecione uma receptora para descartar.",variant:"destructive"});return}const P=O.find(w=>w.receptora_id===a.receptora_id),U=(P==null?void 0:P.brinco)||a.receptora_id,L=(P==null?void 0:P.origem)||"PROTOCOLO",$=a.protocolo_receptora_id;try{if(l(!0),L==="CIO_LIVRE"){const{error:w}=await c.from("receptoras_cio_livre").update({status:"DESCARTADA"}).eq("receptora_id",a.receptora_id).eq("status","DISPONIVEL");if(w)throw w}else if($){const{error:w}=await c.from("protocolo_receptoras").update({status:"INAPTA",motivo_inapta:"Descartada no menu de TE - não recebeu embrião"}).eq("id",$);if(w)throw w;await xe($)}a.receptora_id&&await c.from("receptoras").update({status_reprodutivo:"VAZIA"}).eq("id",a.receptora_id),D({title:"Receptora descartada",description:L==="CIO_LIVRE"?`${U} foi descartada e saiu da lista de cio livre.`:`${U} foi descartada e não receberá embrião neste protocolo.`}),f(w=>({...w,receptora_id:"",protocolo_receptora_id:""})),a.fazenda_id&&await le(a.fazenda_id)}catch(w){D({title:"Erro ao descartar receptora",description:w instanceof Error?w.message:"Erro desconhecido",variant:"destructive"})}finally{l(!1)}},[a,O,f,l,le,xe,D]),je=s.useCallback(async P=>{var se,ne,K,j;P.preventDefault();const U=N==="PACOTE";if(!a.embriao_id){D({title:"Embrião não selecionado",description:"Por favor, selecione um embrião para realizar a transferência.",variant:"destructive"});return}if(!a.fazenda_id||!a.receptora_id||!a.data_te||U&&!a.pacote_id){D({title:"Erro de validação",description:"Todos os campos obrigatórios devem ser preenchidos",variant:"destructive"});return}const L=O.find(A=>A.receptora_id===a.receptora_id);if(!L){D({title:"Receptora não disponível",description:"A receptora selecionada não está disponível para transferência.",variant:"destructive"});return}const $=b[a.receptora_id]||0,w=$===1;if($>=2){D({title:"Limite atingido",description:"Esta receptora já recebeu o máximo de 2 embriões permitidos.",variant:"destructive"});return}if(a.receptora_id&&!w){const A=L.status_reprodutivo||"VAZIA",re=L.origem==="CIO_LIVRE"?"SINCRONIZADA":A,Y=la(re,"REALIZAR_TE");if(!Y.valido){D({title:"Erro de validação",description:Y.mensagem||"A receptora não pode receber embrião no estado atual",variant:"destructive"});return}}if(!a.veterinario_responsavel||a.veterinario_responsavel.trim()===""){D({title:"Erro de validação",description:"Veterinário responsável é obrigatório. Por favor, informe o nome do veterinário.",variant:"destructive"});return}try{l(!0);const A={embriao_id:a.embriao_id,receptora_id:a.receptora_id,protocolo_receptora_id:a.protocolo_receptora_id||null,data_te:a.data_te,tipo_te:N==="CONGELADO"?"CONGELADO":"FRESCO",veterinario_responsavel:a.veterinario_responsavel.trim(),tecnico_responsavel:((se=a.tecnico_responsavel)==null?void 0:se.trim())||null,status_te:"REALIZADA",observacoes:((ne=a.observacoes)==null?void 0:ne.trim())||null},{data:re,error:Y}=await c.from("transferencias_embrioes").insert([A]).select("id");if(Y){if(Y.code==="23505"&&((K=Y.message)!=null&&K.includes("unq_embriao_te_realizada"))){N==="CONGELADO"?X():ae();return}throw Y}re&&((j=re[0])!=null&&j.id)&&C(n=>[...n,re[0].id]),await c.from("embrioes").update({status_atual:"TRANSFERIDO"}).eq("id",a.embriao_id),a.protocolo_receptora_id&&T(n=>n.includes(a.protocolo_receptora_id)?n:[...n,a.protocolo_receptora_id]);const ue={...b};ue[a.receptora_id]=(ue[a.receptora_id]||0)+1,z(ue);const t={...d};t[a.receptora_id]={...L,quantidade_embrioes:ue[a.receptora_id]},I(t),D({title:"Transferência registrada",description:`Embrião transferido para ${L.brinco} com sucesso.`}),f(n=>({...n,embriao_id:"",receptora_id:"",protocolo_receptora_id:"",observacoes:""})),N==="CONGELADO"?X():ae(),a.fazenda_id&&await le(a.fazenda_id,{contagem:ue,info:t})}catch(A){D({title:"Erro ao registrar transferência",description:A instanceof Error?A.message:"Erro desconhecido",variant:"destructive"})}finally{l(!1)}},[a,N,O,b,d,f,l,C,T,z,I,ae,X,le,D]),Z=s.useCallback(async(P=!1)=>{if(!(p.length>0)){P||D({title:"Nenhuma transferência na sessão",description:"Não há transferências para gerar relatório.",variant:"destructive"});return}try{const{data:L,error:$}=await c.from("transferencias_embrioes").select(`
          *,
          embrioes (id, identificacao, classificacao, status_atual, lote_fiv_id, lote_fiv_acasalamento_id),
          receptoras (id, identificacao, nome)
        `).in("id",p).eq("status_te","REALIZADA").order("created_at",{ascending:!0});if($)throw $;if(!L||L.length===0){D({title:"Erro ao gerar relatório",description:"Não foi possível encontrar as transferências da sessão.",variant:"destructive"});return}const w=L.map(j=>{var A;return(A=j.embrioes)==null?void 0:A.lote_fiv_acasalamento_id}).filter(j=>!!j),{doadorasMap:se,tourosMap:ne}=await da(w),K=L.map(j=>{var n,_,g,u,h;const A=(n=j.embrioes)==null?void 0:n.lote_fiv_acasalamento_id,re=A&&se.get(A)||"N/A",Y=A&&ne.get(A)||"N/A";return{numero_embriao:((_=j.embrioes)==null?void 0:_.identificacao)||(k&&k.get(j.embriao_id||"")?String(k.get(j.embriao_id||"")):null)||(j.embriao_id?j.embriao_id.substring(0,8):"N/A"),doadora:re,touro:Y,classificacao:((g=j.embrioes)==null?void 0:g.classificacao)||"N/A",receptora_brinco:((u=j.receptoras)==null?void 0:u.identificacao)||"N/A",receptora_nome:((h=j.receptoras)==null?void 0:h.nome)||"N/A",data_te:j.data_te,veterinario:j.veterinario_responsavel||"N/A",tecnico:j.tecnico_responsavel||"N/A",observacoes:j.observacoes||""}});v(K),B(!0)}catch(L){D({title:"Erro ao gerar relatório",description:L instanceof Error?L.message:"Erro desconhecido",variant:"destructive"}),V(!1)}},[p,k,v,B,V,D]),Ee=s.useCallback(async()=>{if(p.length===0){D({title:"Nenhuma transferência na sessão",description:"Não há transferências para visualizar.",variant:"destructive"});return}V(!0),await Z(!0)},[p,V,Z,D]),Ne=s.useCallback(async()=>{if(p.length===0){D({title:"Nenhuma transferência na sessão",description:"Não há transferências para encerrar nesta sessão.",variant:"destructive"});return}try{l(!0);let P=[...E];if(P.length===0){const{data:ne,error:K}=await c.from("transferencias_embrioes").select("protocolo_receptora_id").in("id",p);if(K)throw K;P=[...new Set((ne||[]).map(j=>j.protocolo_receptora_id).filter(j=>!!j))]}const{data:U,error:L}=await c.from("transferencias_embrioes").select("receptora_id").in("id",p).eq("status_te","REALIZADA");if(L)throw L;const $=[...new Set((U||[]).map(ne=>ne.receptora_id).filter(Boolean))];if($.length===0)throw new Error("Nenhuma receptora encontrada para encerrar a sessão.");const{error:w}=await c.rpc("encerrar_sessao_te",{p_receptora_ids:$,p_protocolo_receptora_ids:P});if(w)throw(w==null?void 0:w.code)==="PGRST202"?new Error("Função encerrar_sessao_te não encontrada no banco. Aplique o SQL em docs/db/003_encerrar_sessao_te.sql e tente novamente."):w;await ge(a.fazenda_id),D({title:"Sessão encerrada",description:`${p.length} transferência(s) finalizada(s) com sucesso.`});const se=a.fazenda_id;f({fazenda_id:"",pacote_id:"",protocolo_id:"",embriao_id:"",receptora_id:"",protocolo_receptora_id:"",data_te:new Date().toISOString().split("T")[0],veterinario_responsavel:"",tecnico_responsavel:"",observacoes:""}),T([]),C([]),z({}),I({}),q(),await ae(),se&&await le(se)}catch(P){D({title:"Erro ao encerrar sessão",description:P instanceof Error?P.message:"Erro desconhecido",variant:"destructive"})}finally{l(!1)}},[a,E,p,f,l,T,C,z,I,q,ae,le,ge,D]);return{handleDescartarReceptora:fe,handleSubmit:je,visualizarRelatorioSessao:Ee,gerarRelatorioSessao:Z,handleEncerrarSessao:Ne}}function Aa({open:a,onOpenChange:f,relatorioData:N,fazendaNome:O,dataTe:b,veterinarioResponsavel:z,tecnicoResponsavel:d,isVisualizacaoApenas:I,submitting:E,onFechar:T,onConfirmarEncerrar:p}){return e.jsx(pa,{open:a,onOpenChange:f,children:e.jsxs(_a,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(fa,{children:[e.jsxs(ua,{className:"flex items-center gap-2",children:[e.jsx($e,{className:"w-5 h-5"}),"Relatório da Sessão de Transferência de Embriões"]}),e.jsxs(ma,{children:["Fazenda: ",O||"N/A"," | Data da TE: ",b?Pe(b):"N/A"," | Total: ",N.length," transferência(s)"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Veterinário Responsável:"})," ",z||"N/A"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Técnico Responsável:"})," ",d||"N/A"]})]}),e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsxs(He,{children:[e.jsx(Qe,{children:e.jsxs(Ie,{children:[e.jsx(H,{className:"text-center",children:"Código"}),e.jsx(H,{children:"Doadora"}),e.jsx(H,{children:"Touro"}),e.jsx(H,{children:"Classificação"}),e.jsx(H,{children:"Receptora (Brinco)"}),e.jsx(H,{children:"Receptora (Nome)"}),e.jsx(H,{children:"Data TE"}),e.jsx(H,{children:"Observações"})]})}),e.jsx(Ue,{children:N.map((C,k)=>e.jsxs(Ie,{children:[e.jsx(Q,{className:"text-center font-semibold",children:C.numero_embriao}),e.jsx(Q,{children:C.doadora}),e.jsx(Q,{children:C.touro}),e.jsx(Q,{children:C.classificacao}),e.jsx(Q,{className:"font-semibold",children:C.receptora_brinco}),e.jsx(Q,{children:C.receptora_nome}),e.jsx(Q,{children:C.data_te?Pe(C.data_te):"N/A"}),e.jsx(Q,{className:"text-sm text-slate-600",children:C.observacoes||"-"})]},k))})]})})]}),e.jsxs(ha,{children:[e.jsx(de,{type:"button",variant:"outline",onClick:T,children:"Fechar"}),!I&&e.jsx(de,{type:"button",onClick:async()=>{T(),await p()},disabled:E,children:E?"Encerrando...":"Confirmar e Encerrar Sessão"})]})]})})}function Ra({receptoras:a,selectedReceptoraId:f,contagemSessaoPorReceptora:N,submitting:O,onSelectReceptora:b,onDescartarReceptora:z}){return e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{children:"6. Selecionar Receptora *"}),e.jsx("div",{className:"border rounded-lg p-4 max-h-60 overflow-y-auto",children:a.length===0?e.jsx("p",{className:"text-sm text-slate-500",children:"Nenhuma receptora sincronizada encontrada para esta fazenda."}):e.jsx("div",{className:"space-y-2",children:a.map(d=>{const I=N[d.receptora_id]||0,E=I<2,T=f===d.receptora_id;return e.jsxs("div",{className:`flex items-center justify-between p-2 rounded cursor-pointer ${T?"bg-green-100 border-green-500 border":E?"hover:bg-slate-50":"opacity-50 cursor-not-allowed"}`,onClick:()=>{E&&b(d.receptora_id,d.protocolo_receptora_id||"")},children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("input",{type:"radio",name:"receptora",checked:T,onChange:()=>{},disabled:!E,className:"w-4 h-4"}),e.jsx("span",{className:"font-medium",children:d.brinco}),d.origem==="CIO_LIVRE"&&e.jsx(ye,{variant:"outline",className:"text-xs bg-emerald-50 text-emerald-700 border-emerald-200",children:"CIO LIVRE"}),e.jsx(va,{value:d.ciclando_classificacao}),e.jsx(ga,{value:d.qualidade_semaforo}),d.observacoes&&e.jsx("span",{className:"text-xs text-slate-500 italic truncate max-w-[150px]",title:d.observacoes,children:d.observacoes})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[I>0&&e.jsxs(ye,{variant:"secondary",children:[I,"/2 embriões"]}),T&&e.jsx(de,{type:"button",variant:"ghost",size:"sm",onClick:p=>{p.stopPropagation(),z()},className:"text-red-600 hover:text-red-700 hover:bg-red-50",disabled:O,children:e.jsx(xa,{className:"w-4 h-4"})})]})]},d.receptora_id)})})})]})}const Ge=20;function Sa({pacote:a,embrioes:f,numerosFixosMap:N,selectedEmbriaoId:O,embrioesPage:b,hasD8Limite:z,onSelectEmbriao:d,onPageChange:I}){const E=[...f].sort((l,v)=>{const B=l.identificacao||"",V=v.identificacao||"";if(B&&V)return B.localeCompare(V);if(B&&!V)return-1;if(!B&&V)return 1;const q=N.get(l.id)||9999,ae=N.get(v.id)||9999;return q-ae}),T=Math.max(1,Math.ceil(E.length/Ge)),p=Math.min(b,T),C=(p-1)*Ge,k=E.slice(C,C+Ge);return e.jsxs("div",{className:"space-y-4",children:[e.jsx(te,{children:"7. Selecionar Embrião do Pacote *"}),e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"font-semibold text-slate-900",children:"Pacote selecionado"}),e.jsxs("p",{className:"text-sm text-slate-600",children:["Data Despacho: ",Pe(a.data_despacho)," | Total: ",a.total," embrião(ões)"]}),z&&e.jsxs("div",{className:"mt-2 flex items-center gap-2 text-sm text-amber-700",children:[e.jsx(ba,{className:"w-4 h-4"}),"Embriões em D8: transferir ou congelar hoje. No D9 serão descartados automaticamente."]})]}),e.jsxs("div",{className:"max-h-96 overflow-y-auto",children:[e.jsxs(He,{children:[e.jsx(Qe,{children:e.jsxs(Ie,{children:[e.jsx(H,{className:"w-12"}),e.jsx(H,{className:"text-center w-28",children:"Código"}),e.jsx(H,{children:"Doadora"}),e.jsx(H,{children:"Touro"}),e.jsx(H,{children:"Classificação"}),e.jsx(H,{children:"Status"}),e.jsx(H,{children:"Dia"})]})}),e.jsx(Ue,{children:k.map(l=>{const v=N.get(l.id)||0;return e.jsxs(Ie,{className:O===l.id?"bg-green-50":"cursor-pointer hover:bg-slate-50",onClick:()=>d(l.id),children:[e.jsx(Q,{children:e.jsx("input",{type:"radio",name:"embriao",value:l.id,checked:O===l.id,onChange:()=>d(l.id),className:"w-4 h-4"})}),e.jsx(Q,{className:"text-center font-medium font-mono text-xs",children:l.identificacao||`#${v}`}),e.jsx(Q,{children:l.doadora_registro||"-"}),e.jsx(Q,{children:l.touro_nome||"-"}),e.jsx(Q,{children:l.classificacao?e.jsx(ye,{variant:"outline",children:l.classificacao}):e.jsx("span",{className:"text-slate-400",children:"-"})}),e.jsx(Q,{children:e.jsx(Ye,{status:l.status_atual})}),e.jsx(Q,{children:l.d8_limite?e.jsx(ye,{variant:"destructive",children:"D8"}):l.d7_pronto?e.jsx(ye,{variant:"outline",className:"bg-emerald-50 text-emerald-700 border-emerald-200",children:"D7"}):e.jsx("span",{className:"text-slate-400",children:"-"})})]},l.id)})})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-between text-sm text-slate-600",children:[e.jsxs("div",{children:[f.length," embrião(ões) disponíveis"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(de,{type:"button",variant:"outline",size:"sm",onClick:()=>I(Math.max(1,b-1)),disabled:b===1,children:"Anterior"}),e.jsxs("span",{children:["Página ",p," de ",T]}),e.jsx(de,{type:"button",variant:"outline",size:"sm",onClick:()=>I(Math.min(T,b+1)),disabled:b>=T,children:"Próxima"})]})]})]})]})]})}const Ze=20;function za({embrioes:a,selectedEmbriaoId:f,embrioesPage:N,loadingCongelados:O,filtroClienteId:b,filtroRaca:z,onSelectEmbriao:d,onPageChange:I}){const E=b||z.trim(),T=[...a].sort((v,B)=>{const V=v.created_at?new Date(v.created_at).getTime():0;return(B.created_at?new Date(B.created_at).getTime():0)-V}),p=Math.max(1,Math.ceil(T.length/Ze)),C=Math.min(N,p),k=(C-1)*Ze,l=T.slice(k,k+Ze);return e.jsxs("div",{className:"space-y-4",children:[e.jsx(te,{children:"7. Selecionar Embrião Congelado *"}),e.jsxs("div",{className:"border rounded-lg p-4",children:[!E&&e.jsx("div",{className:"text-sm text-slate-500",children:"Selecione um cliente ou informe a raça para listar embriões congelados."}),O&&e.jsx("div",{className:"text-sm text-slate-500",children:"Carregando embriões congelados..."}),!O&&a.length===0&&E&&e.jsx("div",{className:"text-sm text-slate-500",children:"Nenhum embrião congelado encontrado para os filtros aplicados."}),!O&&a.length>0&&e.jsxs("div",{className:"max-h-96 overflow-y-auto",children:[e.jsxs(He,{children:[e.jsx(Qe,{children:e.jsxs(Ie,{children:[e.jsx(H,{className:"w-12"}),e.jsx(H,{children:"Código"}),e.jsx(H,{children:"Doadora"}),e.jsx(H,{children:"Touro"}),e.jsx(H,{children:"Classificação"}),e.jsx(H,{children:"Status"})]})}),e.jsx(Ue,{children:l.map(v=>e.jsxs(Ie,{className:f===v.id?"bg-green-50":"cursor-pointer hover:bg-slate-50",onClick:()=>d(v.id),children:[e.jsx(Q,{children:e.jsx("input",{type:"radio",name:"embriao",value:v.id,checked:f===v.id,onChange:()=>d(v.id),className:"w-4 h-4"})}),e.jsx(Q,{className:"font-mono text-xs",children:v.identificacao||v.id.substring(0,8)}),e.jsx(Q,{children:v.doadora_registro||"-"}),e.jsx(Q,{children:v.touro_nome||"-"}),e.jsx(Q,{children:v.classificacao?e.jsx(ye,{variant:"outline",children:v.classificacao}):e.jsx("span",{className:"text-slate-400",children:"-"})}),e.jsx(Q,{children:e.jsx(Ye,{status:v.status_atual})})]},v.id))})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-between text-sm text-slate-600",children:[e.jsxs("div",{children:[a.length," embrião(ões) disponíveis"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(de,{type:"button",variant:"outline",size:"sm",onClick:()=>I(Math.max(1,N-1)),disabled:N===1,children:"Anterior"}),e.jsxs("span",{children:["Página ",C," de ",p]}),e.jsx(de,{type:"button",variant:"outline",size:"sm",onClick:()=>I(Math.min(p,N+1)),disabled:N>=p,children:"Próxima"})]})]})]})]})]})}const Da=20;function ot(){var Oe;const[a,f]=s.useState({fazenda_id:"",pacote_id:"",protocolo_id:"",receptora_id:"",protocolo_receptora_id:"",embriao_id:"",data_te:new Date().toISOString().split("T")[0],veterinario_responsavel:"",tecnico_responsavel:"",observacoes:""}),[N,O]=s.useState({data_te:"",veterinario_responsavel:"",tecnico_responsavel:""}),[b,z]=s.useState(!1),{origemEmbriao:d,setOrigemEmbriao:I,filtroClienteId:E,setFiltroClienteId:T,filtroRaca:p,setFiltroRaca:C,dataPasso2:k,setDataPasso2:l,incluirCioLivre:v,setIncluirCioLivre:B,embrioesPage:V,setEmbrioesPage:q,showRelatorioDialog:ae,setShowRelatorioDialog:X,relatorioData:le,setRelatorioData:ge,isVisualizacaoApenas:D,setIsVisualizacaoApenas:xe,resetAll:fe,aplicarFiltrosSessao:je,fecharRelatorio:Z}=Na(),{fazendas:Ee,clientes:Ne,pacotes:P,pacotesFiltrados:U,embrioesCongelados:L,receptoras:$,setReceptoras:w,loading:se,loadingCongelados:ne,transferenciasSessao:K,setTransferenciasSessao:j,transferenciasIdsSessao:A,setTransferenciasIdsSessao:re,contagemSessaoPorReceptora:Y,setContagemSessaoPorReceptora:ue,receptorasSessaoInfo:t,setReceptorasSessaoInfo:n,loadFazendas:_,loadPacotes:g,loadClientes:u,loadEmbrioesCongelados:h,carregarReceptorasDaFazenda:m,recarregarReceptoras:F,salvarSessaoNoBanco:G,encerrarSessaoNoBanco:oe,restaurarSessaoEmAndamento:me}=wa({dataPasso2:k,incluirCioLivre:v,filtroClienteId:E,filtroRaca:p,formData:a}),J=P.find(i=>i.id===a.pacote_id),W=s.useMemo(()=>(J==null?void 0:J.embrioes.filter(i=>i.status_atual==="FRESCO"))||[],[J]),Re=W.some(i=>i.d8_limite),Se=s.useRef(0),pe=s.useMemo(()=>{if(!a.pacote_id||!J)return new Map;const i=[...W].sort((x,o)=>{const R=x.doadora_registro||"",S=o.doadora_registro||"";if(R!==S)return R.localeCompare(S);const y=x.created_at?new Date(x.created_at).getTime():0,ee=o.created_at?new Date(o.created_at).getTime():0;return y!==ee?y-ee:(x.id||"").localeCompare(o.id||"")}),r=new Map;return i.forEach((x,o)=>{r.set(x.id,o+1)}),r},[a.pacote_id,J,W]),{handleDescartarReceptora:Ce,handleSubmit:he,visualizarRelatorioSessao:Ae,handleEncerrarSessao:be}=Ca({formData:a,setFormData:f,origemEmbriao:d,receptoras:$,contagemSessaoPorReceptora:Y,setContagemSessaoPorReceptora:ue,receptorasSessaoInfo:t,setReceptorasSessaoInfo:n,transferenciasSessao:K,setTransferenciasSessao:j,transferenciasIdsSessao:A,setTransferenciasIdsSessao:re,numerosFixosMap:pe,setSubmitting:z,setRelatorioData:ge,setShowRelatorioDialog:X,setIsVisualizacaoApenas:xe,resetFiltros:fe,loadPacotes:g,loadEmbrioesCongelados:h,recarregarReceptoras:F,encerrarSessaoNoBanco:oe}),ze=()=>{const i={fazenda_id:a.fazenda_id,pacote_id:a.pacote_id,data_passo2:k,data_te:a.data_te,veterinario_responsavel:a.veterinario_responsavel,tecnico_responsavel:a.tecnico_responsavel,origem_embriao:d,filtro_cliente_id:E,filtro_raca:p,incluir_cio_livre:v,transferenciasSessao:K,transferenciasIdsSessao:A,embrioes_page:V};G(i)},we=async i=>{if(!i){f({...a,fazenda_id:"",pacote_id:"",protocolo_id:"",embriao_id:"",receptora_id:"",protocolo_receptora_id:""}),O({data_te:"",veterinario_responsavel:"",tecnico_responsavel:""}),j([]),re([]),w([]);return}j([]),re([]),O({data_te:"",veterinario_responsavel:"",tecnico_responsavel:""}),await m(i),f({...a,fazenda_id:i,pacote_id:"",protocolo_id:"",embriao_id:"",receptora_id:"",protocolo_receptora_id:""})},Te=i=>{var x;const r=P.find(o=>o.id===i);(x=r==null?void 0:r.pacote_info)!=null&&x.veterinario_responsavel&&!a.veterinario_responsavel?(f(o=>({...o,pacote_id:i,veterinario_responsavel:r.pacote_info.veterinario_responsavel||""})),O(o=>({...o,veterinario_responsavel:r.pacote_info.veterinario_responsavel||""}))):f(o=>({...o,pacote_id:i}))};return s.useEffect(()=>{(async()=>{await Promise.all([_(),g(),u()]);const r=await me();r&&(je(r.filtros),O(r.camposPacote),f(x=>({...x,...r.formData,embriao_id:"",receptora_id:"",protocolo_receptora_id:"",observacoes:""})))})()},[]),s.useEffect(()=>{(a.fazenda_id||a.pacote_id||A.length>0)&&ze()},[a.fazenda_id,a.pacote_id,a.protocolo_id,a.data_te,a.veterinario_responsavel,a.tecnico_responsavel,d,E,p,k,v,K.length,A.length,V]),s.useEffect(()=>{_()},[k]),s.useEffect(()=>{a.fazenda_id&&m(a.fazenda_id)},[a.fazenda_id,k,v]),s.useEffect(()=>{d==="CONGELADO"&&(E||p.trim())&&h()},[d,E,p]),s.useEffect(()=>{q(1)},[a.pacote_id]),s.useEffect(()=>{d==="CONGELADO"&&(q(1),f(i=>({...i,embriao_id:""})))},[d,E,p]),s.useEffect(()=>{!a.pacote_id||!J||(Se.current+=1)},[a.pacote_id,J,pe]),s.useEffect(()=>{const i=Math.max(1,Math.ceil(W.length/Da));V>i&&q(i)},[W.length,V]),se?e.jsx(aa,{}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(ca,{title:"Transferência de Embriões (TE)",description:"Destinar embriões para receptoras sincronizadas"}),e.jsxs(ra,{children:[e.jsx(oa,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(ia,{className:"flex items-center gap-2",children:[e.jsx(ta,{className:"w-5 h-5"}),"Nova Transferência"]}),a.fazenda_id&&A.length>0&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(de,{type:"button",onClick:Ae,className:"bg-muted-foreground hover:bg-muted-foreground/90",disabled:b,variant:"default",title:"Visualizar relatório da sessão atual sem encerrar",children:[e.jsx($e,{className:"w-4 h-4 mr-2"}),"Visualizar Relatório (",A.length," transferência",A.length>1?"s":"",")"]}),e.jsxs(de,{type:"button",onClick:be,disabled:b,variant:"default",children:[e.jsx($e,{className:"w-4 h-4 mr-2"}),b?"Gerando...":`Encerrar Sessão (${A.length} transferência${A.length>1?"s":""})`]})]})]})}),e.jsx(sa,{children:e.jsxs("form",{onSubmit:he,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4 border-b pb-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"fazenda_id",children:"1. Fazenda onde estão as receptoras *"}),e.jsxs(qe,{value:a.fazenda_id,onValueChange:we,children:[e.jsx(Fe,{children:e.jsx(ke,{placeholder:"Selecione a fazenda"})}),e.jsx(Me,{children:Ee.map(i=>e.jsx(Be,{value:i.id,children:i.nome},i.id))})]})]}),a.fazenda_id&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"data_passo2",children:"2. Data do 2º Passo (opcional)"}),e.jsx(We,{id:"data_passo2",value:k,onChange:i=>l(i||"")}),k&&e.jsx("div",{className:"flex justify-end",children:e.jsx(de,{type:"button",variant:"ghost",size:"sm",onClick:()=>l(""),children:"Limpar data"})})]}),a.fazenda_id&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ja,{id:"incluir-cio-livre",checked:v,onCheckedChange:B}),e.jsx(te,{htmlFor:"incluir-cio-livre",className:"cursor-pointer text-sm",children:"Incluir receptoras de CIO livre"})]}),a.fazenda_id&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{children:"3. Origem do Embrião *"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx(de,{type:"button",variant:d==="PACOTE"?"default":"outline",onClick:()=>I("PACOTE"),className:"",children:"Pacote (Frescos)"}),e.jsx(de,{type:"button",variant:d==="CONGELADO"?"default":"outline",onClick:()=>I("CONGELADO"),className:"",children:"Congelados"})]})]}),a.fazenda_id&&d==="PACOTE"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"pacote_id",children:"4. Pacote de Embriões *"}),e.jsxs(qe,{value:a.pacote_id,onValueChange:Te,children:[e.jsx(Fe,{children:e.jsx(ke,{placeholder:"Selecione o pacote"})}),e.jsx(Me,{children:U.map(i=>{var r;return e.jsxs(Be,{value:i.id,children:[((r=i.pacote_info)==null?void 0:r.fazenda_nome)||"N/A"," - ",Pe(i.data_despacho)," (",i.frescos," frescos)"]},i.id)})})]})]}),a.fazenda_id&&d==="CONGELADO"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx(te,{children:"4. Filtros para Embriões Congelados"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"filtro_cliente",children:"Cliente"}),e.jsxs(qe,{value:E,onValueChange:T,children:[e.jsx(Fe,{children:e.jsx(ke,{placeholder:"Selecione o cliente"})}),e.jsx(Me,{children:Ne.map(i=>e.jsx(Be,{value:i.id,children:i.nome},i.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"filtro_raca",children:"Raça"}),e.jsx(Ve,{id:"filtro_raca",value:p,onChange:i=>C(i.target.value),placeholder:"Digite a raça"})]})]})]}),(a.pacote_id||d==="CONGELADO")&&a.fazenda_id&&e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"data_te",children:"5. Data da TE *"}),e.jsx(We,{id:"data_te",value:a.data_te,onChange:i=>f({...a,data_te:i||""})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"veterinario_responsavel",children:"Veterinário Responsável *"}),e.jsx(Ve,{id:"veterinario_responsavel",value:a.veterinario_responsavel,onChange:i=>f({...a,veterinario_responsavel:i.target.value}),placeholder:"Nome do veterinário"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"tecnico_responsavel",children:"Técnico Responsável"}),e.jsx(Ve,{id:"tecnico_responsavel",value:a.tecnico_responsavel,onChange:i=>f({...a,tecnico_responsavel:i.target.value}),placeholder:"Nome do técnico"})]})]}),(a.pacote_id||d==="CONGELADO"&&(E||p.trim()))&&a.fazenda_id&&e.jsx(Ra,{receptoras:$,selectedReceptoraId:a.receptora_id,contagemSessaoPorReceptora:Y,submitting:b,onSelectReceptora:(i,r)=>{f({...a,receptora_id:i,protocolo_receptora_id:r})},onDescartarReceptora:Ce}),a.pacote_id&&J&&e.jsx(Sa,{pacote:J,embrioes:W,numerosFixosMap:pe,selectedEmbriaoId:a.embriao_id,embrioesPage:V,hasD8Limite:Re,onSelectEmbriao:i=>f({...a,embriao_id:i}),onPageChange:q}),d==="CONGELADO"&&e.jsx(za,{embrioes:L,selectedEmbriaoId:a.embriao_id,embrioesPage:V,loadingCongelados:ne,filtroClienteId:E,filtroRaca:p,onSelectEmbriao:i=>f({...a,embriao_id:i}),onPageChange:q}),a.embriao_id&&a.receptora_id&&e.jsx("div",{className:"space-y-4 border-t pt-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{htmlFor:"observacoes",children:"Observações"}),e.jsx(na,{id:"observacoes",value:a.observacoes,onChange:i=>f({...a,observacoes:i.target.value}),placeholder:"Observações sobre a transferência",rows:3})]})})]}),a.embriao_id&&a.receptora_id&&e.jsx("div",{className:"flex justify-end",children:e.jsx(de,{type:"submit",disabled:b,children:b?"Registrando...":"Registrar Transferência"})})]})})]}),e.jsx(Aa,{open:ae,onOpenChange:X,relatorioData:le,fazendaNome:((Oe=Ee.find(i=>i.id===a.fazenda_id))==null?void 0:Oe.nome)||"N/A",dataTe:a.data_te,veterinarioResponsavel:a.veterinario_responsavel,tecnicoResponsavel:a.tecnico_responsavel,isVisualizacaoApenas:D,submitting:b,onFechar:Z,onConfirmarEncerrar:be})]})}export{ot as default};
