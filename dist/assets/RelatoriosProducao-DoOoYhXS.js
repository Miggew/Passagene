import{c as ue,b as fe,r as c,s as l,j as e,aw as J,B as z,X as he}from"./index-B-7HRnm0.js";import{C as _,d as v,a as ge,b as je,c as Ne}from"./card-DdhhEbXV.js";import{I as _e}from"./input-D2h8r4MO.js";import{B as O}from"./badge-BCHVCiM7.js";import{S as K,a as Q,b as W,c as Y,d as C}from"./select-B0M3FCy4.js";import{u as ve}from"./useClienteFilter-Df1PgEKu.js";import{P as be}from"./PageHeader-CT7CFo0W.js";import{D as ee}from"./DatePickerBR-XHkKTcYs.js";import{e as ye}from"./exportPdf-0A6g_7-d.js";import{A as R}from"./activity-BuPU1g6A.js";import{S as we}from"./search-DcAWDjHO.js";import{C as ze}from"./calendar-D8momPux.js";import{F as Fe}from"./file-text-ElQw19Mr.js";import{E as Se}from"./eye-C2rdP5in.js";import{f as te,p as Me}from"./pt-BR-DS62bWKG.js";import"./index-B4eR1KA_.js";import"./check-C6h7QFZL.js";import"./chevron-right-DntnbvYp.js";import"./popover-i4alam_g.js";import"./dateUtils-eJ5e6apA.js";import"./differenceInCalendarDays-CrzntjZV.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ce=ue("Percent",[["line",{x1:"19",x2:"5",y1:"5",y2:"19",key:"1x9vlm"}],["circle",{cx:"6.5",cy:"6.5",r:"2.5",key:"4mh3h7"}],["circle",{cx:"17.5",cy:"17.5",r:"2.5",key:"1mdrzq"}]]),E=15;function Qe(){const ae=fe(),{clienteIdFilter:m}=ve(),[V,se]=c.useState([]),[b,q]=c.useState("all"),[P,$]=c.useState("all"),[A,H]=c.useState(""),[u,Z]=c.useState(""),[f,G]=c.useState(""),[k,D]=c.useState([]),[y,re]=c.useState({totalLotes:0,totalOocitos:0,totalEmbrioes:0,taxaMediaSucesso:0,totalAspiracoes:0,totalProtocolos:0}),[d,F]=c.useState(1),[h,U]=c.useState(!0);c.useEffect(()=>{oe()},[m]),c.useEffect(()=>{ie(),F(1)},[b,P,u,f,m]);const oe=async()=>{let t=l.from("fazendas").select("*").order("nome");m&&(t=t.eq("cliente_id",m));const{data:s}=await t;se(s??[])},ie=async()=>{U(!0);try{let t=[];if(m){const{data:s}=await l.from("fazendas").select("id").eq("cliente_id",m);t=(s==null?void 0:s.map(r=>r.id))??[]}await Promise.all([ce(t),le(t)])}catch(t){console.error("Erro ao carregar dados:",t)}finally{U(!1)}},ce=async t=>{let s=l.from("lotes_fiv").select("*").order("data_abertura",{ascending:!1});P!=="all"&&(s=s.eq("status",P)),u&&(s=s.gte("data_abertura",u)),f&&(s=s.lte("data_abertura",f));const{data:r,error:n}=await s;if(n){console.error("Erro ao carregar lotes:",n),D([]);return}if(!r||r.length===0){D([]);return}const L=[...new Set(r.map(a=>a.pacote_aspiracao_id).filter(Boolean))];let w=new Map;if(L.length>0){const{data:a}=await l.from("pacotes_aspiracao").select("id, fazenda_id, fazendas(nome)").in("id",L);a==null||a.forEach(o=>w.set(o.id,o))}let p=r;b!=="all"?p=r.filter(a=>{const o=w.get(a.pacote_aspiracao_id);return(o==null?void 0:o.fazenda_id)===b}):m&&t.length>0&&(p=r.filter(a=>{const o=w.get(a.pacote_aspiracao_id);return(o==null?void 0:o.fazenda_id)&&t.includes(o.fazenda_id)}));const S=p.map(a=>a.id),j=[...new Set(p.map(a=>a.pacote_aspiracao_id).filter(Boolean))],N=new Map;if(j.length>0){const{data:a}=await l.from("aspiracoes_doadoras").select("pacote_aspiracao_id, total_oocitos").in("pacote_aspiracao_id",j);a==null||a.forEach(o=>{const i=N.get(o.pacote_aspiracao_id)??0;N.set(o.pacote_aspiracao_id,i+(o.total_oocitos??0))})}const M=new Map;if(S.length>0){const{data:a}=await l.from("embrioes").select("lote_fiv_id").in("lote_fiv_id",S);a==null||a.forEach(o=>{M.set(o.lote_fiv_id,(M.get(o.lote_fiv_id)??0)+1)})}D(p.map(a=>{var X;const o=w.get(a.pacote_aspiracao_id),i=N.get(a.pacote_aspiracao_id)??0,I=M.get(a.id)??0,T=i>0?Math.round(I/i*100):0;return{id:a.id,codigo:a.codigo,data_abertura:a.data_abertura,fazenda_nome:((X=o==null?void 0:o.fazendas)==null?void 0:X.nome)??"N/A",total_oocitos:i,total_embrioes:I,taxa_sucesso:T,status:a.status}}))},le=async t=>{var a,o;const s=new Date;s.setDate(s.getDate()-90);const r=te(s,"yyyy-MM-dd"),[n,L,w]=await Promise.all([l.from("lotes_fiv").select("id, pacote_aspiracao_id",{count:"exact"}).gte("data_abertura",r),m&&t.length>0?l.from("pacotes_aspiracao").select("id",{count:"exact"}).in("fazenda_id",t).gte("data_aspiracao",r):l.from("pacotes_aspiracao").select("id",{count:"exact"}).gte("data_aspiracao",r),m&&t.length>0?l.from("protocolos_sincronizacao").select("id",{count:"exact"}).in("fazenda_id",t).gte("data_inicio",r):l.from("protocolos_sincronizacao").select("id",{count:"exact"}).gte("data_inicio",r)]),p=((a=n.data)==null?void 0:a.map(i=>i.pacote_aspiracao_id))??[],S=((o=n.data)==null?void 0:o.map(i=>i.id))??[];let j=0,N=0;if(p.length>0){const{data:i}=await l.from("aspiracoes_doadoras").select("total_oocitos").in("pacote_aspiracao_id",p);j=(i==null?void 0:i.reduce((I,T)=>I+(T.total_oocitos??0),0))??0}if(S.length>0){const{count:i}=await l.from("embrioes").select("id",{count:"exact",head:!0}).in("lote_fiv_id",S);N=i??0}const M=j>0?Math.round(N/j*100):0;re({totalLotes:n.count??0,totalOocitos:j,totalEmbrioes:N,taxaMediaSucesso:M,totalAspiracoes:L.count??0,totalProtocolos:w.count??0})},x=c.useMemo(()=>{if(!A.trim())return k;const t=A.toLowerCase();return k.filter(s=>{var r,n;return((r=s.codigo)==null?void 0:r.toLowerCase().includes(t))||((n=s.fazenda_nome)==null?void 0:n.toLowerCase().includes(t))})},[k,A]),g=Math.ceil(x.length/E),de=c.useMemo(()=>{const t=(d-1)*E;return x.slice(t,t+E)},[x,d]),ne=()=>{q("all"),$("all"),H(""),Z(""),G(""),F(1)},B=t=>{try{return te(new Date(t+"T12:00:00"),"dd/MM/yyyy",{locale:Me})}catch{return t}},xe=t=>{switch(t){case"FINALIZADO":return e.jsx(O,{className:"bg-primary hover:bg-primary-dark",children:"Finalizado"});case"EM_ANDAMENTO":return e.jsx(O,{variant:"secondary",children:"Em Andamento"});default:return e.jsx(O,{variant:"outline",children:t})}},me=t=>{let s="bg-red-500/15 text-red-600 dark:text-red-400";return t>=40?s="bg-primary/15 text-primary":t>=25&&(s="bg-amber-500/15 text-amber-600 dark:text-amber-400"),e.jsxs("span",{className:`inline-flex items-center justify-center min-w-10 h-6 px-2 text-xs font-semibold rounded ${s}`,children:[t,"%"]})},pe=()=>{var r;if(x.length===0)return;const t=b!=="all"?(r=V.find(n=>n.id===b))==null?void 0:r.nome:void 0,s=u||f?`${u?B(u):"..."} a ${f?B(f):"..."}`:void 0;ye("lotesFiv",x,{fazenda:t,periodo:s})};return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsx(be,{title:"Produção",description:"Métricas de produção e lotes de FIV"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4",children:[e.jsx(_,{children:e.jsx(v,{className:"pt-4 pb-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-primary/10",children:e.jsx(R,{className:"w-5 h-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-foreground",children:h?"...":y.totalLotes}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Lotes FIV (90d)"})]})]})})}),e.jsx(_,{children:e.jsx(v,{className:"pt-4 pb-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-blue-500/10",children:e.jsx(J,{className:"w-5 h-5 text-blue-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-foreground",children:h?"...":y.totalOocitos.toLocaleString()}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Oócitos (90d)"})]})]})})}),e.jsx(_,{children:e.jsx(v,{className:"pt-4 pb-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-cyan-500/10",children:e.jsx(J,{className:"w-5 h-5 text-cyan-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-foreground",children:h?"...":y.totalEmbrioes.toLocaleString()}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Embriões (90d)"})]})]})})}),e.jsx(_,{children:e.jsx(v,{className:"pt-4 pb-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-amber-500/10",children:e.jsx(Ce,{className:"w-5 h-5 text-amber-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-foreground",children:h?"...":`${y.taxaMediaSucesso}%`}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Taxa Média"})]})]})})}),e.jsx(_,{children:e.jsx(v,{className:"pt-4 pb-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-purple-500/10",children:e.jsx(R,{className:"w-5 h-5 text-purple-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-foreground",children:h?"...":y.totalAspiracoes}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Aspirações (90d)"})]})]})})}),e.jsx(_,{children:e.jsx(v,{className:"pt-4 pb-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-rose-500/10",children:e.jsx(R,{className:"w-5 h-5 text-rose-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-foreground",children:h?"...":y.totalProtocolos}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Protocolos (90d)"})]})]})})})]}),e.jsx("div",{className:"rounded-xl border border-border bg-card p-4",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("div",{className:"relative flex-1 min-w-[200px] max-w-[280px]",children:[e.jsx(we,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(_e,{placeholder:"Buscar por código ou fazenda...",value:A,onChange:t=>H(t.target.value),className:"pl-9 h-9"})]}),e.jsx("div",{className:"h-6 w-px bg-border hidden sm:block"}),e.jsxs(K,{value:b,onValueChange:q,children:[e.jsx(Q,{className:"w-[180px] h-9",children:e.jsx(W,{placeholder:"Fazenda"})}),e.jsxs(Y,{children:[e.jsx(C,{value:"all",children:"Todas as fazendas"}),V.map(t=>e.jsx(C,{value:t.id,children:t.nome},t.id))]})]}),e.jsxs(K,{value:P,onValueChange:$,children:[e.jsx(Q,{className:"w-[150px] h-9",children:e.jsx(W,{placeholder:"Status"})}),e.jsxs(Y,{children:[e.jsx(C,{value:"all",children:"Todos"}),e.jsx(C,{value:"FINALIZADO",children:"Finalizado"}),e.jsx(C,{value:"EM_ANDAMENTO",children:"Em Andamento"})]})]}),e.jsx("div",{className:"h-6 w-px bg-border hidden sm:block"}),e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 rounded-lg bg-muted/50",children:[e.jsx(ze,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"text-muted-foreground text-xs",children:"de"}),e.jsx(ee,{value:u,onChange:Z,className:"h-8 w-[120px] text-xs"}),e.jsx("span",{className:"text-muted-foreground text-xs",children:"até"}),e.jsx(ee,{value:f,onChange:G,className:"h-8 w-[120px] text-xs"})]}),e.jsxs("div",{className:"flex items-center gap-2 ml-auto",children:[e.jsx(z,{variant:"outline",size:"sm",onClick:ne,className:"h-9",children:e.jsx(he,{className:"w-4 h-4"})}),x.length>0&&e.jsxs(z,{variant:"outline",size:"sm",onClick:pe,className:"h-9 border-primary/30 text-primary hover:bg-primary/10 hover:border-primary/50",children:[e.jsx(Fe,{className:"w-4 h-4 mr-1"}),"PDF"]})]})]})}),e.jsxs(_,{children:[e.jsxs(ge,{className:"pb-3",children:[e.jsxs(je,{className:"text-base",children:["Lotes FIV (",x.length,")"]}),e.jsx(Ne,{children:"Histórico de lotes de fertilização in vitro"})]}),e.jsx(v,{className:"pt-0",children:h?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Carregando..."}):x.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Nenhum lote encontrado"}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"rounded-lg border border-border overflow-hidden",children:[e.jsxs("div",{className:"grid grid-cols-[1fr_1.5fr_1fr_0.8fr_0.8fr_0.8fr_1fr_0.6fr] gap-0 bg-muted text-xs font-semibold text-muted-foreground uppercase tracking-wide",children:[e.jsx("div",{className:"px-4 py-3",children:"Código"}),e.jsx("div",{className:"px-3 py-3",children:"Fazenda"}),e.jsx("div",{className:"px-3 py-3 text-center",children:"Data FIV"}),e.jsx("div",{className:"px-3 py-3 text-center",children:"Oócitos"}),e.jsx("div",{className:"px-3 py-3 text-center",children:"Embriões"}),e.jsx("div",{className:"px-3 py-3 text-center",children:"Taxa"}),e.jsx("div",{className:"px-3 py-3 text-center",children:"Status"}),e.jsx("div",{className:"px-2 py-3"})]}),de.map(t=>e.jsxs("div",{className:"grid grid-cols-[1fr_1.5fr_1fr_0.8fr_0.8fr_0.8fr_1fr_0.6fr] gap-0 items-center border-t border-border hover:bg-muted/30 cursor-pointer",onClick:()=>ae(`/lotes-fiv/${t.id}`),children:[e.jsx("div",{className:"px-4 py-3 font-medium text-sm",children:t.codigo}),e.jsx("div",{className:"px-3 py-3 text-sm text-muted-foreground truncate",children:t.fazenda_nome}),e.jsx("div",{className:"px-3 py-3 text-sm text-center",children:B(t.data_abertura)}),e.jsx("div",{className:"px-3 py-3 flex justify-center",children:e.jsx("span",{className:"inline-flex items-center justify-center min-w-6 h-6 px-2 text-xs font-medium bg-muted text-foreground rounded",children:t.total_oocitos})}),e.jsx("div",{className:"px-3 py-3 flex justify-center",children:e.jsx("span",{className:"inline-flex items-center justify-center min-w-6 h-6 px-2 text-xs font-medium bg-primary/15 text-primary rounded",children:t.total_embrioes})}),e.jsx("div",{className:"px-3 py-3 flex justify-center",children:me(t.taxa_sucesso)}),e.jsx("div",{className:"px-3 py-3 flex justify-center",children:xe(t.status)}),e.jsx("div",{className:"px-2 py-3 flex justify-center",children:e.jsx(z,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0",children:e.jsx(Se,{className:"w-4 h-4"})})})]},t.id))]}),g>1&&e.jsxs("div",{className:"flex items-center justify-between mt-4 pt-4 border-t border-border",children:[e.jsxs("span",{className:"text-sm text-muted-foreground",children:["Mostrando ",(d-1)*E+1," a ",Math.min(d*E,x.length)," de ",x.length]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{variant:"outline",size:"sm",onClick:()=>F(t=>Math.max(1,t-1)),disabled:d===1,children:"Anterior"}),e.jsx("div",{className:"flex items-center gap-1",children:Array.from({length:Math.min(5,g)},(t,s)=>{let r;return g<=5||d<=3?r=s+1:d>=g-2?r=g-4+s:r=d-2+s,e.jsx(z,{variant:d===r?"default":"outline",size:"sm",className:`w-9 h-9 p-0 ${d===r?"bg-primary hover:bg-primary-dark":""}`,onClick:()=>F(r),children:r},r)})}),e.jsx(z,{variant:"outline",size:"sm",onClick:()=>F(t=>Math.min(g,t+1)),disabled:d===g,children:"Próximo"})]})]})]})})]})]})}export{Qe as default};
