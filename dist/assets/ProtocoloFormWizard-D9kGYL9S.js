import{r as l,h as ze,s as D,f as Ie,j as e,P as re,i as Je,R as q,k as Ke,l as Xe,m as $,B as I,n as Ye}from"./index-DM5u2d-F.js";import{C as ae,a as se,b as oe,d as te}from"./card-B_EQ6x91.js";import{I as K}from"./input-CtUEWea1.js";import{L as V}from"./label-Bhhf9ayq.js";import{T as ne}from"./textarea-Kj1o8r55.js";import{S as ea,a as aa,b as sa,c as oa,d as ta}from"./select-B_NoJ61H.js";import{P as ra,a as ia,b as na}from"./popover-CNdtTvFz.js";import{C as ca,a as la,b as da,c as ua,d as ma,e as pa}from"./command-OprQ0I7S.js";import{D as he,a as xe,b as ve,c as ge,d as je,e as be}from"./dialog-2y4jBKyr.js";import{A as fa,a as ha,b as xa,c as va,d as ga,e as ja,f as ba,g as Ca}from"./alert-dialog-DtLfiadJ.js";import{T as _a,a as Na,b as Ce,c as U,d as wa,e as H}from"./table-CEKyj1ed.js";import{B as _e}from"./badge-D_AVhbx8.js";import{P as Ne}from"./PageHeader-JgO8x5IE.js";import{C as Sa,Q as ya}from"./QualidadeSemaforo-CtCykpmc.js";import{c as Re,I as za,R as Ia}from"./index-C0gH1jj7.js";import{u as ce}from"./index-CWb7Yp_3.js";import{u as Ra}from"./index-ClZPXJQX.js";import{X}from"./x-DsJYRTDR.js";import{D as Ea}from"./DatePickerBR-BEWFLeoy.js";import{v as Ee,a as Pa}from"./receptoraStatus-Bbt-P6Vj.js";import{u as le}from"./use-toast-BOUGyrIz.js";import{A as we}from"./arrow-left-CH9vqVt5.js";import{P as Aa}from"./plus-DJrruxx9.js";import{U as Pe}from"./user-plus-B-iQ8mQq.js";import{L as Ta}from"./lock-C7PcKBaO.js";import{S as ka}from"./search-QDhw42Qv.js";import"./index-sCsFC1oc.js";import"./index-BEVMOrkK.js";import"./check-Y5eEMkO8.js";import"./calendar-B_KmJ-VL.js";function Ga(){const{toast:a}=le(),[o,n]=l.useState(!1),[r,s]=l.useState(!1),[i,m]=l.useState([]),[d,t]=l.useState([]),[j,c]=l.useState([]),[g,A]=l.useState({fazenda_id:"",data_inicio:ze(),veterinario:"",tecnico:"",observacoes:""}),w=l.useCallback(async()=>{try{n(!0);const{data:x,error:f}=await D.from("fazendas").select("*").order("nome",{ascending:!0});if(f)throw f;m(x||[])}catch(x){a({title:"Erro ao carregar fazendas",description:x instanceof Error?x.message:"Erro desconhecido",variant:"destructive"})}finally{n(!1)}},[a]),R=l.useCallback(async x=>{try{s(!0);const{data:f,error:C}=await D.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",x);if(C)throw C;const v=(f==null?void 0:f.map(p=>p.receptora_id))||[];if(v.length===0){t([]),c([]);return}const{data:E,error:F}=await D.from("receptoras").select("id, identificacao, nome, status_reprodutivo").in("id",v).order("identificacao",{ascending:!0});if(F)throw F;const O=(E||[]).filter(p=>(p.id?String(p.id).trim():"")!=="").map(async p=>{if(!(p.id?String(p.id).trim():""))return null;const b=p.status_reprodutivo||"VAZIA",_=Ee(b,"ENTRAR_PASSO1");return{...p,status:b,motivoIndisponivel:_.valido?void 0:_.mensagem}}),B=(await Promise.all(O)).filter(p=>p!==null),h=B.filter(p=>p.status==="VAZIA");t(h),c(B)}catch(f){a({title:"Erro ao carregar receptoras",description:f instanceof Error?f.message:"Erro desconhecido",variant:"destructive"})}finally{s(!1)}},[a]),S=l.useCallback(x=>new Set(x.filter(f=>f.id&&f.id.trim()!==""&&f.id!==null&&f.id!==void 0).map(f=>String(f.id).trim())),[]),T=l.useCallback(x=>d.filter(f=>{const C=f.id?String(f.id).trim():"";return C!==""&&!x.has(C)}),[d]),L=l.useCallback((x,f)=>{if(!x.trim())return j.filter(v=>{const E=v.id?String(v.id).trim():"";return E!==""&&!f.has(E)&&v.status==="VAZIA"}).map(v=>({...v,disponivel:!0}));const C=x.toLowerCase().trim();return j.filter(v=>{const E=v.id?String(v.id).trim():"";if(E===""||f.has(E))return!1;const F=(v.identificacao||"").toLowerCase(),P=(v.nome||"").toLowerCase();return F.includes(C)||P.includes(C)}).map(v=>({...v,disponivel:v.status==="VAZIA"}))},[j]),u=l.useCallback(x=>{var f;return((f=i.find(C=>C.id===x))==null?void 0:f.nome)||"-"},[i]);return{loading:o,loadingReceptoras:r,fazendas:i,allReceptoras:d,receptorasComStatus:j,protocoloData:g,setProtocoloData:A,loadFazendas:w,loadAllReceptoras:R,getSelectedIds:S,getAvailableReceptoras:T,getReceptorasFiltradas:L,getFazendaNome:u}}function Da({fazendaId:a,allReceptoras:o,receptorasComStatus:n,selectedIds:r,onReceptorasReload:s}){const{toast:i}=le(),[m,d]=l.useState([]),[t,j]=l.useState(!1),[c,g]=l.useState(!1),[A,w]=l.useState(""),[R,S]=l.useState(!1),[T,L]=l.useState({receptora_id:"",observacoes:"",ciclando_classificacao:null,qualidade_semaforo:null}),[u,x]=l.useState({identificacao:"",nome:"",observacoes:"",ciclando_classificacao:null,qualidade_semaforo:null}),[f,C]=l.useState(!1),v=l.useCallback(()=>{L({receptora_id:"",observacoes:"",ciclando_classificacao:null,qualidade_semaforo:null}),w(""),S(!1)},[]),E=l.useCallback(()=>{x({identificacao:"",nome:"",observacoes:"",ciclando_classificacao:null,qualidade_semaforo:null})},[]),F=l.useCallback(async()=>{var _;const h=((_=T.receptora_id)==null?void 0:_.trim())||"";if(!h){i({title:"Erro",description:"Selecione uma receptora",variant:"destructive"});return}const p=o.find(k=>(k.id?String(k.id).trim():"")===h);if(!p||!p.id){i({title:"Erro",description:"Receptora não encontrada ou inválida",variant:"destructive"});return}const y=p.status_reprodutivo||"VAZIA",b=Ee(y,"ENTRAR_PASSO1");if(!b.valido){i({title:"Erro de validação",description:b.mensagem||"A receptora não pode entrar no protocolo no estado atual",variant:"destructive"});return}if(r.has(h)){i({title:"Receptora já adicionada",description:"Esta receptora já está na lista de selecionadas",variant:"destructive"});return}d(k=>{var z;return k.some(G=>(G.id?String(G.id).trim():"")===h)?k:[...k,{id:p.id,identificacao:p.identificacao,nome:p.nome,observacoes:((z=T.observacoes)==null?void 0:z.trim())||void 0,ciclando_classificacao:T.ciclando_classificacao||null,qualidade_semaforo:T.qualidade_semaforo||null}]}),v(),j(!1)},[T,o,r,i,v]),P=l.useCallback(async()=>{if(!u.identificacao.trim()){i({title:"Erro de validação",description:"Identificação (brinco) é obrigatória",variant:"destructive"});return}try{C(!0);const{data:h,error:p}=await D.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",a);if(p)throw p;const y=(h==null?void 0:h.map(z=>z.receptora_id))||[];if(y.length>0){const{data:z,error:G}=await D.from("receptoras").select("id, identificacao, nome").in("id",y).ilike("identificacao",u.identificacao.trim());if(G)throw G;if(z&&z.length>0){const Q=z[0].nome?`"${z[0].nome}"`:"sem nome";throw new Error(`Já existe uma receptora com o brinco "${u.identificacao.trim()}" nesta fazenda (Nome: ${Q}).`)}}if(u.nome.trim()&&y.length>0){const{data:z,error:G}=await D.from("receptoras").select("id, identificacao").in("id",y).ilike("nome",u.nome.trim());if(G)throw G;if(z&&z.length>0)throw new Error(`Já existe uma receptora com o nome "${u.nome.trim()}" nesta fazenda (Brinco: ${z[0].identificacao}).`)}const b={identificacao:u.identificacao};u.nome.trim()&&(b.nome=u.nome);const{data:_,error:k}=await D.from("receptoras").insert([b]).select().single();if(k)throw k.code==="23505"?new Error("Já existe uma receptora com esse brinco nesta fazenda."):k;const{error:W}=await D.from("receptora_fazenda_historico").insert([{receptora_id:_.id,fazenda_id:a,data_inicio:ze(),data_fim:null}]);d(z=>[...z,{id:_.id,identificacao:_.identificacao,nome:_.nome,observacoes:u.observacoes||void 0,ciclando_classificacao:u.ciclando_classificacao||null,qualidade_semaforo:u.qualidade_semaforo||null,isNew:!0}]),E(),g(!1),await s()}catch(h){i({title:"Erro ao criar receptora",description:h instanceof Error?h.message:"Erro desconhecido",variant:"destructive"})}finally{C(!1)}},[u,a,i,E,s]),O=l.useCallback(h=>{d(p=>p.filter((y,b)=>b!==h))},[]),Z=l.useCallback((h,p)=>{d(y=>y.map((b,_)=>_===h?{...b,ciclando_classificacao:p}:b))},[]),B=l.useCallback((h,p)=>{d(y=>y.map((b,_)=>_===h?{...b,qualidade_semaforo:p}:b))},[]);return{receptorasLocais:m,setReceptorasLocais:d,showAddReceptora:t,setShowAddReceptora:j,showCreateReceptora:c,setShowCreateReceptora:g,buscaReceptora:A,setBuscaReceptora:w,popoverAberto:R,setPopoverAberto:S,addReceptoraForm:T,setAddReceptoraForm:L,createReceptoraForm:u,setCreateReceptoraForm:x,submitting:f,handleAddReceptora:F,handleCreateReceptora:P,handleRemoveReceptora:O,handleUpdateCiclando:Z,handleUpdateQualidade:B,resetAddForm:v,resetCreateForm:E}}function qa({protocoloData:a,receptorasLocais:o}){const n=Ie(),{toast:r}=le(),[s,i]=l.useState(!1),[m,d]=l.useState(!1),t=l.useRef(!1),j=l.useCallback(()=>!a.fazenda_id||!a.data_inicio||!a.veterinario.trim()||!a.tecnico.trim()?(r({title:"Erro de validação",description:"Fazenda, data de início, veterinário e técnico são obrigatórios",variant:"destructive"}),!1):!0,[a,r]),c=l.useCallback(async()=>{if(t.current||s)return;if(o.length===0){r({title:"Erro de validação",description:"Adicione pelo menos 1 receptora antes de finalizar o 1º passo",variant:"destructive"});return}if(o.filter(u=>!u.id||u.id===""||u.id===null||u.id===void 0).length>0){r({title:"Erro de validação",description:"Seleção de receptora inválida. Refaça a seleção.",variant:"destructive"});return}const w=o.filter(u=>u.id&&u.id!==""&&u.id!==null&&u.id!==void 0);if(w.length!==o.length||w.length===0){r({title:"Erro de validação",description:"Seleção de receptora inválida. Refaça a seleção.",variant:"destructive"});return}const R=w.map(u=>u.id),S=w.map(u=>u.observacoes||null),T=w.map(u=>u.ciclando_classificacao||null),L=w.map(u=>u.qualidade_semaforo||null);try{t.current=!0,i(!0);const u=`VET: ${a.veterinario.trim()} | TEC: ${a.tecnico.trim()}`,{data:x,error:f}=await D.rpc("criar_protocolo_passo1_atomico",{p_fazenda_id:a.fazenda_id,p_data_inicio:a.data_inicio,p_responsavel_inicio:u,p_receptoras_ids:R,p_data_inclusao:a.data_inicio,p_observacoes:a.observacoes.trim()||null,p_receptoras_observacoes:S});if(f)throw f;if(!x)throw new Error("Protocolo criado mas ID não retornado");const{data:C,error:v}=await D.from("protocolo_receptoras").select("id, receptora_id").eq("protocolo_id",x).in("receptora_id",R);if(!v&&C&&C.length>0){const P=new Map(R.map((h,p)=>[h,p])),O=C.map(async h=>{const p=P.get(h.receptora_id);if(p===void 0)return{success:!0};const y=T[p],b=L[p],{error:_}=await D.from("protocolo_receptoras").update({ciclando_classificacao:y,qualidade_semaforo:b}).eq("id",h.id);return{success:!_,error:_}}),B=(await Promise.allSettled(O)).filter(h=>h.status==="rejected"||h.status==="fulfilled"&&h.value&&!h.value.success);B.length>0&&r({title:"Aviso",description:`Protocolo criado, mas ${B.length} classificação(ões) não foram salvas. Edite o protocolo para corrigir.`,variant:"destructive"})}if((await Promise.all(R.map(P=>Pa(P,"EM_SINCRONIZACAO")))).map((P,O)=>({result:P,receptoraId:R[O]})).filter(({result:P})=>P.error).length>0)throw new Error("Erro ao atualizar status das receptoras. Tente novamente.");r({title:"Protocolo criado com sucesso",description:`${o.length} receptoras adicionadas ao protocolo`}),n("/protocolos")}catch(u){const x=u instanceof Error?u.message:"Erro desconhecido ao finalizar protocolo";r({title:"Erro ao finalizar protocolo",description:x,variant:"destructive"})}finally{i(!1),t.current=!1}},[a,o,r,n,s]),g=l.useCallback(()=>{d(!1),n("/protocolos")},[n]);return{submitting:s,showConfirmExit:m,setShowConfirmExit:d,handleFinalizarPasso1:c,handleConfirmExit:g,validateProtocoloForm:j}}var Ae="Toggle",de=l.forwardRef((a,o)=>{const{pressed:n,defaultPressed:r,onPressedChange:s,...i}=a,[m,d]=ce({prop:n,onChange:s,defaultProp:r??!1,caller:Ae});return e.jsx(re.button,{type:"button","aria-pressed":m,"data-state":m?"on":"off","data-disabled":a.disabled?"":void 0,...i,ref:o,onClick:Je(a.onClick,()=>{a.disabled||d(!m)})})});de.displayName=Ae;var Te=de,M="ToggleGroup",[ke,_s]=Ke(M,[Re]),Ge=Re(),ue=q.forwardRef((a,o)=>{const{type:n,...r}=a;if(n==="single"){const s=r;return e.jsx($a,{...s,ref:o})}if(n==="multiple"){const s=r;return e.jsx(Va,{...s,ref:o})}throw new Error(`Missing prop \`type\` expected on \`${M}\``)});ue.displayName=M;var[De,qe]=ke(M),$a=q.forwardRef((a,o)=>{const{value:n,defaultValue:r,onValueChange:s=()=>{},...i}=a,[m,d]=ce({prop:n,defaultProp:r??"",onChange:s,caller:M});return e.jsx(De,{scope:a.__scopeToggleGroup,type:"single",value:q.useMemo(()=>m?[m]:[],[m]),onItemActivate:d,onItemDeactivate:q.useCallback(()=>d(""),[d]),children:e.jsx($e,{...i,ref:o})})}),Va=q.forwardRef((a,o)=>{const{value:n,defaultValue:r,onValueChange:s=()=>{},...i}=a,[m,d]=ce({prop:n,defaultProp:r??[],onChange:s,caller:M}),t=q.useCallback(c=>d((g=[])=>[...g,c]),[d]),j=q.useCallback(c=>d((g=[])=>g.filter(A=>A!==c)),[d]);return e.jsx(De,{scope:a.__scopeToggleGroup,type:"multiple",value:m,onItemActivate:t,onItemDeactivate:j,children:e.jsx($e,{...i,ref:o})})});ue.displayName=M;var[Fa,Oa]=ke(M),$e=q.forwardRef((a,o)=>{const{__scopeToggleGroup:n,disabled:r=!1,rovingFocus:s=!0,orientation:i,dir:m,loop:d=!0,...t}=a,j=Ge(n),c=Ra(m),g={role:"group",dir:c,...t};return e.jsx(Fa,{scope:n,rovingFocus:s,disabled:r,children:s?e.jsx(Ia,{asChild:!0,...j,orientation:i,dir:c,loop:d,children:e.jsx(re.div,{...g,ref:o})}):e.jsx(re.div,{...g,ref:o})})}),Y="ToggleGroupItem",Ve=q.forwardRef((a,o)=>{const n=qe(Y,a.__scopeToggleGroup),r=Oa(Y,a.__scopeToggleGroup),s=Ge(a.__scopeToggleGroup),i=n.value.includes(a.value),m=r.disabled||a.disabled,d={...a,pressed:i,disabled:m},t=q.useRef(null);return r.rovingFocus?e.jsx(za,{asChild:!0,...s,focusable:!m,active:i,ref:t,children:e.jsx(Se,{...d,ref:o})}):e.jsx(Se,{...d,ref:o})});Ve.displayName=Y;var Se=q.forwardRef((a,o)=>{const{__scopeToggleGroup:n,value:r,...s}=a,i=qe(Y,n),m={role:"radio","aria-checked":a.pressed,"aria-pressed":void 0},d=i.type==="single"?m:void 0;return e.jsx(de,{...d,...s,ref:o,onPressedChange:t=>{t?i.onItemActivate(r):i.onItemDeactivate(r)}})}),Fe=ue,Oe=Ve;const Be=Xe("inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground",{variants:{variant:{default:"bg-transparent",outline:"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground"},size:{default:"h-10 px-3",sm:"h-9 px-2.5",lg:"h-11 px-5"}},defaultVariants:{variant:"default",size:"default"}}),Ba=l.forwardRef(({className:a,variant:o,size:n,...r},s)=>e.jsx(Te,{ref:s,className:$(Be({variant:o,size:n,className:a})),...r}));Ba.displayName=Te.displayName;const Le=l.createContext({size:"default",variant:"default"}),Me=l.forwardRef(({className:a,variant:o,size:n,children:r,...s},i)=>e.jsx(Fe,{ref:i,className:$("flex items-center justify-center gap-1",a),...s,children:e.jsx(Le.Provider,{value:{variant:o,size:n},children:r})}));Me.displayName=Fe.displayName;const ie=l.forwardRef(({className:a,children:o,variant:n,size:r,...s},i)=>{const m=l.useContext(Le);return e.jsx(Oe,{ref:i,className:$(Be({variant:m.variant||n,size:m.size||r}),a),...s,children:o})});ie.displayName=Oe.displayName;function Qe({ciclandoValue:a,qualidadeValue:o,onChangeCiclando:n,onChangeQualidade:r,disabled:s=!1,size:i="sm"}){const m=i==="sm"?"text-xs":"text-sm",d=i==="sm"?"w-4 h-4":"w-5 h-5";return e.jsxs("div",{className:"flex flex-wrap items-center gap-3 text-slate-600",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:$("text-slate-500 font-medium",m),children:"Ciclo:"}),e.jsxs(Me,{type:"single",value:a||void 0,onValueChange:t=>{s||n(t==="CL"||t==="N"?t:null)},disabled:s,className:"gap-1",children:[e.jsx(ie,{value:"CL","aria-label":"CL",size:"sm",variant:"outline",className:$("h-7 px-2 text-xs",a==="CL"&&"bg-blue-100 text-blue-700 border-blue-300 data-[state=on]:bg-blue-100",s&&"opacity-60"),children:"CL"}),e.jsx(ie,{value:"N","aria-label":"N",size:"sm",variant:"outline",className:$("h-7 px-2 text-xs",a==="N"&&"bg-slate-100 text-slate-700 border-slate-300 data-[state=on]:bg-slate-100",s&&"opacity-60"),children:"N"})]}),a&&!s&&e.jsx(I,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 text-slate-400 hover:text-slate-600",onClick:()=>n(null),type:"button",children:e.jsx(X,{className:"w-3 h-3"})}),!a&&e.jsx("span",{className:$("text-slate-300",m),children:"—"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:$("text-slate-500 font-medium",m),children:"Qualidade:"}),e.jsx("div",{className:"flex items-center gap-1.5",children:[1,2,3].map(t=>e.jsx("button",{type:"button",disabled:s,onClick:()=>{s||r(o===t?null:t)},className:$(d,"rounded-full border-2 transition-all",Ye(t),o===t?"border-slate-900 scale-110 ring-2 ring-slate-300":"border-slate-300 opacity-50 hover:opacity-75 hover:scale-105",s&&"opacity-40 cursor-not-allowed",!s&&"cursor-pointer"),title:`Qualidade ${t}`},t))}),o&&!s&&e.jsx(I,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 text-slate-400 hover:text-slate-600",onClick:()=>r(null),type:"button",children:e.jsx(X,{className:"w-3 h-3"})}),!o&&e.jsx("span",{className:$("text-slate-300",m),children:"—"})]})]})}function Ns(){const a=Ie(),[o,n]=l.useState("form"),{loading:r,loadingReceptoras:s,fazendas:i,allReceptoras:m,receptorasComStatus:d,protocoloData:t,setProtocoloData:j,loadFazendas:c,loadAllReceptoras:g,getSelectedIds:A,getReceptorasFiltradas:w,getFazendaNome:R}=Ga();l.useMemo(()=>A(S),[S]);const{receptorasLocais:S,showAddReceptora:T,setShowAddReceptora:L,showCreateReceptora:u,setShowCreateReceptora:x,buscaReceptora:f,setBuscaReceptora:C,popoverAberto:v,setPopoverAberto:E,addReceptoraForm:F,setAddReceptoraForm:P,createReceptoraForm:O,setCreateReceptoraForm:Z,submitting:B,handleAddReceptora:h,handleCreateReceptora:p,handleRemoveReceptora:y,handleUpdateCiclando:b,handleUpdateQualidade:_,resetAddForm:k,resetCreateForm:W}=Da({fazendaId:t.fazenda_id,allReceptoras:m,receptorasComStatus:d,selectedIds:A([]),onReceptorasReload:()=>g(t.fazenda_id)}),{submitting:z,showConfirmExit:G,setShowConfirmExit:Q,handleFinalizarPasso1:Ue,handleConfirmExit:me,validateProtocoloForm:He}=qa({protocoloData:t,receptorasLocais:S}),J=B||z,pe=l.useMemo(()=>A(S),[A,S]),Ze=l.useMemo(()=>w(f,pe),[w,f,pe]);l.useEffect(()=>{c()},[c]),l.useEffect(()=>{o==="receptoras"&&t.fazenda_id&&g(t.fazenda_id)},[o,t.fazenda_id,g]);const We=()=>{He()&&n("receptoras")},fe=()=>{o==="form"?a("/protocolos"):n("form")},ee=()=>{t.fazenda_id||S.length>0?Q(!0):a("/protocolos")};return o==="form"?e.jsxs("div",{className:"space-y-6",children:[e.jsx(Ne,{title:"Novo Protocolo",description:"Primeira visita - Cadastrar novo protocolo de sincronização",actions:e.jsx(I,{variant:"outline",size:"icon",onClick:ee,children:e.jsx(we,{className:"w-4 h-4"})})}),e.jsxs(ae,{children:[e.jsx(se,{children:e.jsx(oe,{children:"Informações do Protocolo"})}),e.jsx(te,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"fazenda_id",children:"Fazenda *"}),e.jsxs(ea,{value:t.fazenda_id,onValueChange:N=>j({...t,fazenda_id:N}),children:[e.jsx(aa,{children:e.jsx(sa,{placeholder:"Selecione a fazenda"})}),e.jsx(oa,{children:i.map(N=>e.jsx(ta,{value:N.id,children:N.nome},N.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"data_inicio",children:"Data de Início *"}),e.jsx(Ea,{id:"data_inicio",value:t.data_inicio,onChange:N=>j({...t,data_inicio:N||""}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"veterinario",children:"Veterinário Responsável *"}),e.jsx(K,{id:"veterinario",value:t.veterinario,onChange:N=>j({...t,veterinario:N.target.value}),placeholder:"Nome do veterinário",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"tecnico",children:"Técnico Responsável *"}),e.jsx(K,{id:"tecnico",value:t.tecnico,onChange:N=>j({...t,tecnico:N.target.value}),placeholder:"Nome do técnico/funcionário",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"observacoes",children:"Observações"}),e.jsx(ne,{id:"observacoes",value:t.observacoes,onChange:N=>j({...t,observacoes:N.target.value}),placeholder:"Observações sobre o protocolo",rows:3})]}),e.jsxs("div",{className:"flex gap-4 pt-4",children:[e.jsx(I,{onClick:We,className:"bg-green-600 hover:bg-green-700",disabled:r,children:"Continuar para Receptoras"}),e.jsx(I,{type:"button",variant:"outline",onClick:ee,disabled:r,children:"Sair"})]})]})})]}),e.jsx(ye,{open:G,onOpenChange:Q,onConfirm:me})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(Ne,{title:"Adicionar Receptoras",description:"Selecione as receptoras para este protocolo",actions:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(I,{variant:"outline",size:"icon",onClick:fe,children:e.jsx(we,{className:"w-4 h-4"})}),e.jsxs(I,{variant:"outline",onClick:ee,children:[e.jsx(X,{className:"w-4 h-4 mr-2"}),"Sair"]})]})}),e.jsxs(ae,{children:[e.jsx(se,{children:e.jsx(oe,{children:"Informações do Protocolo"})}),e.jsxs(te,{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Fazenda"}),e.jsx("p",{className:"text-base text-slate-900",children:R(t.fazenda_id)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Data Início"}),e.jsx("p",{className:"text-base text-slate-900",children:t.data_inicio})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Veterinário"}),e.jsx("p",{className:"text-base text-slate-900",children:t.veterinario})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-500",children:"Técnico"}),e.jsx("p",{className:"text-base text-slate-900",children:t.tecnico})]})]})]}),e.jsxs(ae,{children:[e.jsx(se,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(oe,{children:["Receptoras do Protocolo (",S.length,")"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(he,{open:T,onOpenChange:N=>{L(N),N||k()},children:[e.jsx(xe,{asChild:!0,children:e.jsxs(I,{className:"bg-green-600 hover:bg-green-700",children:[e.jsx(Aa,{className:"w-4 h-4 mr-2"}),"Adicionar Receptora"]})}),e.jsxs(ve,{className:"max-w-lg",children:[e.jsxs(ge,{children:[e.jsx(je,{children:"Adicionar Receptora ao Protocolo"}),e.jsx(be,{children:"Busque por identificação ou nome. Receptoras adequadas aparecerão como disponíveis."})]}),e.jsx(La,{addReceptoraForm:F,setAddReceptoraForm:P,buscaReceptora:f,setBuscaReceptora:C,popoverAberto:v,setPopoverAberto:E,receptorasFiltradas:Ze,receptorasComStatus:d,loadingReceptoras:s,onAdd:h})]})]}),e.jsxs(he,{open:u,onOpenChange:N=>{x(N),N||W()},children:[e.jsx(xe,{asChild:!0,children:e.jsxs(I,{variant:"outline",children:[e.jsx(Pe,{className:"w-4 h-4 mr-2"}),"Cadastrar Nova"]})}),e.jsxs(ve,{children:[e.jsxs(ge,{children:[e.jsx(je,{children:"Cadastrar Nova Receptora"}),e.jsx(be,{children:"Preencha os dados da nova receptora para cadastrá-la e adicioná-la ao protocolo."})]}),e.jsx(Ma,{createReceptoraForm:O,setCreateReceptoraForm:Z,submitting:J,onCreate:p})]})]})]})]})}),e.jsx(te,{children:S.length===0?e.jsx("div",{className:"text-center py-8 text-slate-500",children:"Nenhuma receptora adicionada. Adicione pelo menos uma antes de finalizar."}):e.jsx(Qa,{receptorasLocais:S,onRemove:y,onUpdateCiclando:b,onUpdateQualidade:_})})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs(I,{onClick:Ue,disabled:S.length===0||J,className:"bg-blue-600 hover:bg-blue-700",children:[e.jsx(Ta,{className:"w-4 h-4 mr-2"}),J?"Finalizando...":"Finalizar 1º Passo"]}),e.jsx(I,{variant:"outline",onClick:fe,disabled:J,children:"Voltar"})]}),e.jsx(ye,{open:G,onOpenChange:Q,onConfirm:me})]})}function ye({open:a,onOpenChange:o,onConfirm:n}){return e.jsx(fa,{open:a,onOpenChange:o,children:e.jsxs(ha,{children:[e.jsxs(xa,{children:[e.jsx(va,{children:"Sair sem finalizar?"}),e.jsx(ga,{children:"Se você sair agora, nenhum protocolo será criado. Todos os dados preenchidos serão perdidos."})]}),e.jsxs(ja,{children:[e.jsx(ba,{children:"Cancelar"}),e.jsx(Ca,{onClick:n,children:"Sim, sair"})]})]})})}function La({addReceptoraForm:a,setAddReceptoraForm:o,buscaReceptora:n,setBuscaReceptora:r,popoverAberto:s,setPopoverAberto:i,receptorasFiltradas:m,receptorasComStatus:d,loadingReceptoras:t,onAdd:j}){return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{children:"Receptora *"}),e.jsxs(ra,{open:s,onOpenChange:i,children:[e.jsx(ia,{asChild:!0,children:e.jsxs(I,{variant:"outline",role:"combobox","aria-expanded":s,className:"w-full justify-between",onClick:()=>i(!s),children:[a.receptora_id?(()=>{const c=d.find(g=>String(g.id).trim()===a.receptora_id.trim());return c?`${c.identificacao}${c.nome?` - ${c.nome}`:""}`:"Selecione uma receptora"})():"Buscar receptora...",e.jsx(ka,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(na,{className:"w-[400px] p-0",align:"start",children:e.jsxs(ca,{shouldFilter:!1,children:[e.jsx(la,{placeholder:"Buscar por identificação ou nome...",value:n,onValueChange:r}),e.jsx(da,{children:t?e.jsx("div",{className:"p-4 text-sm text-center text-slate-500",children:"Carregando receptoras..."}):m.length===0?e.jsx(ua,{children:n.trim()?"Nenhuma receptora encontrada":"Nenhuma receptora disponível"}):e.jsx(ma,{children:m.map(c=>{var w,R;const g=c.id?String(c.id).trim():"";if(!g)return null;const A=`${c.identificacao} ${c.nome||""}`.trim();return e.jsx(pa,{value:`${A} ${g}`,onSelect:()=>{c.disponivel&&(o({...a,receptora_id:g}),r(""),i(!1))},disabled:!c.disponivel,className:c.disponivel?"":"opacity-60 cursor-not-allowed",children:e.jsxs("div",{className:"flex flex-col w-full",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("span",{className:"flex-1",children:[c.identificacao,c.nome?` - ${c.nome}`:""]}),c.disponivel?e.jsx(_e,{variant:"outline",className:"bg-green-50 text-green-700 border-green-200 shrink-0",children:"Disponível"}):e.jsx(_e,{variant:"outline",className:"bg-red-50 text-red-700 border-red-200 shrink-0",children:"Indisponível"})]}),!c.disponivel&&e.jsx("span",{className:"text-xs text-red-600 mt-1",children:(w=c.motivoIndisponivel)!=null&&w.includes("Status atual:")&&((R=c.motivoIndisponivel.split("Status atual:")[1])==null?void 0:R.trim())||c.status})]})},c.id)})})})]})})]})]}),e.jsx("div",{className:"space-y-2",children:e.jsx(Qe,{ciclandoValue:a.ciclando_classificacao,qualidadeValue:a.qualidade_semaforo,onChangeCiclando:c=>o({...a,ciclando_classificacao:c}),onChangeQualidade:c=>o({...a,qualidade_semaforo:c}),size:"sm"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{children:"Observações"}),e.jsx(ne,{value:a.observacoes,onChange:c=>o({...a,observacoes:c.target.value}),placeholder:"Observações sobre a inclusão",rows:2})]}),e.jsx(I,{onClick:j,className:"w-full bg-green-600 hover:bg-green-700",disabled:t||!a.receptora_id,children:"Adicionar"})]})}function Ma({createReceptoraForm:a,setCreateReceptoraForm:o,submitting:n,onCreate:r}){return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{children:"Identificação (Brinco) *"}),e.jsx(K,{value:a.identificacao,onChange:s=>o({...a,identificacao:s.target.value}),placeholder:"Número do brinco"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{children:"Nome"}),e.jsx(K,{value:a.nome,onChange:s=>o({...a,nome:s.target.value}),placeholder:"Nome da receptora (opcional)"})]}),e.jsx("div",{className:"space-y-2",children:e.jsx(Qe,{ciclandoValue:a.ciclando_classificacao||null,qualidadeValue:a.qualidade_semaforo||null,onChangeCiclando:s=>o({...a,ciclando_classificacao:s}),onChangeQualidade:s=>o({...a,qualidade_semaforo:s}),size:"sm"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{children:"Observações"}),e.jsx(ne,{value:a.observacoes,onChange:s=>o({...a,observacoes:s.target.value}),placeholder:"Observações sobre a receptora",rows:2})]}),e.jsxs(I,{onClick:r,className:"w-full bg-blue-600 hover:bg-blue-700",disabled:n,children:[e.jsx(Pe,{className:"w-4 h-4 mr-2"}),n?"Criando...":"Criar e Adicionar"]})]})}function Qa({receptorasLocais:a,onRemove:o,onUpdateCiclando:n,onUpdateQualidade:r}){return e.jsxs(_a,{children:[e.jsx(Na,{children:e.jsxs(Ce,{children:[e.jsx(U,{children:"Brinco"}),e.jsx(U,{children:"Nome"}),e.jsx(U,{children:"Ciclando"}),e.jsx(U,{children:"Qualidade"}),e.jsx(U,{children:"Observações"}),e.jsx(U,{className:"text-right",children:"Ações"})]})}),e.jsx(wa,{children:a.map((s,i)=>{const m=s.id&&s.id.trim()!==""?s.id:`new-${i}`;return e.jsxs(Ce,{children:[e.jsx(H,{className:"font-medium",children:s.identificacao}),e.jsx(H,{children:s.nome||"-"}),e.jsx(H,{children:e.jsx(Sa,{value:s.ciclando_classificacao,onChange:d=>n(i,d),variant:"editable"})}),e.jsx(H,{children:e.jsx(ya,{value:s.qualidade_semaforo,onChange:d=>r(i,d),variant:"row"})}),e.jsx(H,{children:s.observacoes||"-"}),e.jsx(H,{className:"text-right",children:e.jsx(I,{variant:"ghost",size:"sm",onClick:()=>o(i),children:e.jsx(X,{className:"w-4 h-4"})})})]},m)})})]})}export{Ns as default};
