import{r as D,s as _}from"./index-BPMeM9-O.js";import{u as P}from"./use-toast-BGNwDi9e.js";const G={DG:27,SEXAGEM:54};function O(t){const d=new Date(t);return Math.floor((new Date().getTime()-d.getTime())/(1e3*60*60*24))}function k(t){const d=new Date(t),c=new Date(d);return c.setDate(c.getDate()+275),c.toISOString().split("T")[0]}function x(){return new Date().toISOString().split("T")[0]}function Z(t){return t.veterinario_responsavel.trim()!==""}function $({statusReceptoraFiltro:t}){const{toast:d}=P(),[c,u]=D.useState([]),[m,M]=D.useState(!1),T=D.useCallback(async()=>{try{M(!0);const{data:n,error:g}=await _.from("fazendas").select("*").order("nome",{ascending:!0});if(g)throw g;if(!n||n.length===0){u([]);return}const{data:I,error:i}=await _.from("vw_receptoras_fazenda_atual").select("receptora_id, fazenda_id_atual");if(i)throw i;const E=[...new Set((I||[]).map(e=>e.receptora_id).filter(Boolean))];if(E.length===0){u(n);return}const h=Array.isArray(t)?t:[t];let f=_.from("receptoras").select("id").in("id",E);h.length===1?f=f.eq("status_reprodutivo",h[0]):f=f.in("status_reprodutivo",h);const{data:l,error:v}=await f;if(v)throw v;const b=(l==null?void 0:l.map(e=>e.id))||[];if(b.length===0){u([]);return}const{data:z,error:p}=await _.from("transferencias_embrioes").select("receptora_id").in("receptora_id",b).eq("status_te","REALIZADA");if(p)throw console.error("Erro ao buscar TEs:",p),p;const A=new Set((z==null?void 0:z.map(e=>e.receptora_id))||[]);if(A.size===0){u([]);return}const q=new Map((I||[]).filter(e=>e.receptora_id&&e.fazenda_id_atual).map(e=>[e.receptora_id,e.fazenda_id_atual])),S=new Set;A.forEach(e=>{const w=q.get(e);w&&S.add(w)});const L=n.filter(e=>S.has(e.id));u(L)}catch(n){console.error("Erro ao carregar fazendas:",n),d({title:"Erro ao carregar fazendas",description:n instanceof Error?n.message:"Erro desconhecido",variant:"destructive"}),u([])}finally{M(!1)}},[t,d]);return{fazendas:c,loading:m,loadFazendas:T}}function H({statusReceptoraFiltro:t,transformLote:d}){const{toast:c}=P(),[u,m]=D.useState([]),[M,T]=D.useState(!1),n=D.useCallback(async(g,I)=>{try{T(!0);const{data:i,error:E}=await _.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",g);if(E)throw console.error("Erro ao buscar view:",E),E;const h=(i==null?void 0:i.map(a=>a.receptora_id))||[];if(h.length===0){m([]);return}const f=Array.isArray(t)?t:[t];let l=_.from("receptoras").select("id, status_reprodutivo").in("id",h);f.length===1?l=l.eq("status_reprodutivo",f[0]):l=l.in("status_reprodutivo",f);const{data:v,error:b}=await l;if(b)throw console.error("Erro ao buscar receptoras:",b),b;const z=(v==null?void 0:v.map(a=>a.id))||[];if(z.length===0){m([]);return}const{data:p,error:A}=await _.from("transferencias_embrioes").select("id, receptora_id, data_te, embriao_id").in("receptora_id",z).eq("status_te","REALIZADA").order("data_te",{ascending:!1});if(A)throw console.error("Erro ao buscar TEs:",A),A;if(!p||p.length===0){m([]);return}const q=p.map(a=>a.embriao_id).filter(Boolean);let S=new Map,L=new Map;if(q.length>0){const{data:a}=await _.from("embrioes").select("id, lote_fiv_id").in("id",q);if(a){S=new Map(a.map(r=>[r.id,{lote_fiv_id:r.lote_fiv_id}]));const o=[...new Set(a.map(r=>r.lote_fiv_id).filter(Boolean))];if(o.length>0){const{data:r}=await _.from("lotes_fiv").select("id, data_abertura").in("id",o);r&&(L=new Map(r.map(s=>[s.id,{data_abertura:s.data_abertura}])))}}}const e=new Map,w=new Map,C=new Map;p.forEach(a=>{const o=`${g}-${a.data_te}`;w.has(a.data_te)||w.set(a.data_te,new Set),w.get(a.data_te).add(a.receptora_id);const r=S.get(a.embriao_id);if(r!=null&&r.lote_fiv_id){const s=L.get(r.lote_fiv_id);if(s!=null&&s.data_abertura){const y=C.get(o);(!y||s.data_abertura<y)&&C.set(o,s.data_abertura)}}e.has(o)||e.set(o,{id:o,fazenda_id:g,fazenda_nome:I||"",data_te:a.data_te,quantidade_receptoras:0,status:"ABERTO"})}),e.forEach((a,o)=>{var y;const r=((y=w.get(a.data_te))==null?void 0:y.size)||0;a.quantidade_receptoras=r;const s=C.get(o);s&&(a.data_abertura_lote=s,a.dias_gestacao=O(s))});const B=Array.from(e.values()).map(a=>d(a,void 0)).sort((a,o)=>new Date(o.data_te).getTime()-new Date(a.data_te).getTime());m(B)}catch(i){console.error("Erro ao carregar lotes:",i),c({title:"Erro ao carregar lotes",description:i instanceof Error?i.message:"Erro desconhecido",variant:"destructive"}),m([])}finally{T(!1)}},[t,d,c]);return{lotesTE:u,loading:M,loadLotesTE:n}}export{G as D,H as a,k as b,O as c,x as g,$ as u,Z as v};
