import{r as i,s as c,y as Qe,h as za,z as Ca,f as Fa,j as e,B as le,g as Me,C as Ra,E as ga,F as Va,U as Na,a as qa,e as Ua}from"./index-DM5u2d-F.js";import{C as Je,a as Ke,b as We,d as ea}from"./card-B_EQ6x91.js";import{T as ra,a as na,b as $e,c as T,d as da,e as B}from"./table-CEKyj1ed.js";import{S as ca,a as la,b as ma,c as pa,d as xa,C as Qa,e as Za}from"./select-B_NoJ61H.js";import{I as Ue}from"./input-CtUEWea1.js";import{L as he}from"./label-Bhhf9ayq.js";import{B as ke}from"./badge-D_AVhbx8.js";import{P as Xa}from"./PageHeader-JgO8x5IE.js";import{E as Ma}from"./EmptyState-ChaxWsz8.js";import{u as ha}from"./use-toast-BOUGyrIz.js";import{h as ia}from"./error-handler-BKHO4AyN.js";import{T as Ga,a as Ya,b as La,c as Ia}from"./tabs-mOzZlruc.js";import{D as wa,a as Ja,b as Da,c as Sa,d as Ea,e as ya}from"./dialog-2y4jBKyr.js";import{T as Pa}from"./textarea-Kj1o8r55.js";import{P as $a}from"./plus-DJrruxx9.js";import{A as Ka}from"./arrow-left-CH9vqVt5.js";import{F as Wa}from"./file-text-FTh7JeGJ.js";import{P as Aa}from"./package-D-Y95y60.js";import{D as Oa}from"./DatePickerBR-BEWFLeoy.js";import{X as ka}from"./x-DsJYRTDR.js";import{S as es}from"./search-QDhw42Qv.js";import{E as as}from"./eye-8DczHlUQ.js";import"./index-ClZPXJQX.js";import"./index-sCsFC1oc.js";import"./index-CWb7Yp_3.js";import"./index-BEVMOrkK.js";import"./check-Y5eEMkO8.js";import"./index-C0gH1jj7.js";import"./popover-CNdtTvFz.js";import"./calendar-B_KmJ-VL.js";function ba(a){return{[-1]:"Aspira√ß√£o",0:"Fecunda√ß√£o",1:"Zigoto",2:"Clivagem",3:"Clivagem Avan√ßada",4:"Compacta√ß√£o",5:"M√≥rula / Blastocisto Inicial",6:"Blastocisto",7:"Blastocisto Expandido",8:"Resgate / Sa√≠da Tardia"}[a]||`Dia ${a}`}function ss(a){return a===-1?"bg-blue-100 text-blue-800 border-blue-300":a===0?"bg-green-100 text-green-800 border-green-300":a>=1&&a<=3?"bg-yellow-100 text-yellow-800 border-yellow-300":a>=4&&a<=5||a===6?"bg-orange-100 text-orange-800 border-orange-300":a===7?"bg-purple-100 text-purple-800 border-purple-300":a===8?"bg-red-100 text-red-800 border-red-300":"bg-slate-100 text-slate-800 border-slate-300"}const Ha="lotes_fiv_filtros";function ts(){try{const a=localStorage.getItem(Ha);return a?JSON.parse(a):{}}catch{return{}}}function os(a){try{localStorage.setItem(Ha,JSON.stringify(a))}catch{}}const Ta=8;function is(a){return a===0?-1:a>9?8:a-1}function Ba({lotes:a,pacotesParaFiltro:P,fazendasAspiracaoUnicas:o,lotesHistoricos:V}){const[d]=i.useState(()=>ts()),[y,W]=i.useState(d.filtroFazendaAspiracao??""),[U,je]=i.useState(d.filtroFazendaAspiracaoBusca??""),[j,X]=i.useState(d.filtroDiaCultivo??""),[b,ie]=i.useState(!1),[re,ue]=i.useState(d.filtroHistoricoDataInicio??""),[ne,N]=i.useState(d.filtroHistoricoDataFim??""),[ee,fe]=i.useState(d.filtroHistoricoFazenda??""),[_e,ve]=i.useState(d.filtroHistoricoFazendaBusca??""),[de,k]=i.useState(!1),[u,g]=i.useState(d.abaAtiva??"ativos"),[me,J]=i.useState(d.historicoPage??1);i.useEffect(()=>{os({abaAtiva:u,filtroFazendaAspiracao:y,filtroFazendaAspiracaoBusca:U,filtroDiaCultivo:j,filtroHistoricoDataInicio:re,filtroHistoricoDataFim:ne,filtroHistoricoFazenda:ee,filtroHistoricoFazendaBusca:_e,historicoPage:me})},[u,y,U,j,re,ne,ee,_e,me]),i.useEffect(()=>{J(1)},[re,ne,ee]),i.useEffect(()=>{const f=Math.max(1,Math.ceil(V.length/Ta));me>f&&J(f)},[V.length,me]),i.useEffect(()=>{const f=A=>{const ce=A.target;ce.closest(".fazenda-busca-container")||ie(!1),ce.closest(".fazenda-busca-historico-container")||k(!1)};if(b||de)return document.addEventListener("mousedown",f),()=>{document.removeEventListener("mousedown",f)}},[b,de]);const w=i.useMemo(()=>{let f=[...a];if(f=f.filter(A=>A.status==="FECHADO"||A.dia_atual!==void 0&&A.dia_atual>9?!1:A.dia_atual!==void 0&&A.dia_atual<=9),y&&(f=f.filter(A=>{const ce=P.find(Se=>Se.id===A.pacote_aspiracao_id);return(ce==null?void 0:ce.fazenda_id)===y})),j!==""){const A=parseInt(j);f=f.filter(ce=>ce.dia_atual===void 0||ce.dia_atual===null?!1:(ce.dia_atual===0?-1:ce.dia_atual-1)===A)}return f},[a,y,j,P]),H=i.useMemo(()=>o.filter(f=>f.nome.toLowerCase().includes(U.toLowerCase())),[o,U]);return{filtroFazendaAspiracao:y,setFiltroFazendaAspiracao:W,filtroFazendaAspiracaoBusca:U,setFiltroFazendaAspiracaoBusca:je,filtroDiaCultivo:j,setFiltroDiaCultivo:X,showFazendaBusca:b,setShowFazendaBusca:ie,fazendasFiltradas:H,lotesFiltrados:w,limparFiltrosAtivos:()=>{W(""),je(""),X(""),ie(!1)},filtroHistoricoDataInicio:re,setFiltroHistoricoDataInicio:ue,filtroHistoricoDataFim:ne,setFiltroHistoricoDataFim:N,filtroHistoricoFazenda:ee,setFiltroHistoricoFazenda:fe,filtroHistoricoFazendaBusca:_e,setFiltroHistoricoFazendaBusca:ve,showFazendaBuscaHistorico:de,setShowFazendaBuscaHistorico:k,limparFiltrosHistorico:()=>{ue(""),N(""),fe(""),ve(""),k(!1),J(1)},abaAtiva:u,setAbaAtiva:g,historicoPage:me,setHistoricoPage:J,HISTORICO_PAGE_SIZE:Ta}}function rs({id:a,filtroHistoricoDataInicio:P,filtroHistoricoDataFim:o,filtroHistoricoFazenda:V,setHistoricoPage:d}){const{toast:y}=ha(),[W,U]=i.useState([]),[je,j]=i.useState([]),[X,b]=i.useState([]),[ie,re]=i.useState([]),[ue,ne]=i.useState([]),[N,ee]=i.useState(!0),[fe,_e]=i.useState(null),[ve,de]=i.useState(!1),[k,u]=i.useState([]),[g,me]=i.useState([]),[J,w]=i.useState([]),[H,ae]=i.useState([]),[ze,f]=i.useState([]),[A,ce]=i.useState(""),[Se,Le]=i.useState([]),[Ee,ye]=i.useState([]),[Pe,n]=i.useState(""),[q,se]=i.useState([]),[Ce,be]=i.useState([]),[Ie,Re]=i.useState([]),[He,Oe]=i.useState(!1),[Te,Ze]=i.useState(null),[ua,aa]=i.useState(null),[fa,sa]=i.useState(!1),ta=i.useCallback(async S=>{try{const{data:z,error:G}=await c.from("embrioes").select("id, lote_fiv_acasalamento_id, created_at").eq("lote_fiv_id",S).order("created_at",{ascending:!1});if(G){w([]);return}const I=new Map;z==null||z.forEach(E=>{if(E.created_at){const te=E.created_at.split("T")[0],t=I.get(te)||[];t.push(E),I.set(te,t)}});const Ne=[...new Set((z==null?void 0:z.map(E=>E.lote_fiv_acasalamento_id).filter(Boolean))||[])];if(Ne.length>0){const{data:E,error:te}=await c.from("lote_fiv_acasalamentos").select("id, aspiracao_doadora_id, dose_semen_id").in("id",Ne);if(!te&&E){const t=[...new Set(E.map(_=>_.aspiracao_doadora_id).filter(Boolean))],{data:p}=await c.from("aspiracoes_doadoras").select("id, doadora_id").in("id",t),v=[...new Set((p==null?void 0:p.map(_=>_.doadora_id).filter(Boolean))||[])],{data:L}=await c.from("doadoras").select("id, registro, nome").in("id",v),K=[...new Set(E.map(_=>_.dose_semen_id).filter(Boolean))],{data:m}=await c.from("doses_semen").select("id, touro_id, touro:touros(id, nome, registro, raca)").in("id",K),D=new Map((p==null?void 0:p.map(_=>[_.id,_]))||[]),O=new Map((L==null?void 0:L.map(_=>[_.id,_]))||[]),Q=new Map((m==null?void 0:m.map(_=>[_.id,_]))||[]),oe=new Map(E.map(_=>[_.id,_])),pe=Array.from(I.keys()).sort((_,r)=>r.localeCompare(_)).map(_=>{const r=I.get(_)||[],C=new Map;r.forEach(xe=>{xe.lote_fiv_acasalamento_id&&C.set(xe.lote_fiv_acasalamento_id,(C.get(xe.lote_fiv_acasalamento_id)||0)+1)});const Fe=Array.from(C.entries()).map(([xe,x])=>{var F;const R=oe.get(xe),Z=R?D.get(R.aspiracao_doadora_id):void 0,s=Z?O.get(Z.doadora_id):void 0,h=R?Q.get(R.dose_semen_id):void 0;return{acasalamento_id:xe,quantidade:x,doadora:(s==null?void 0:s.registro)||(s==null?void 0:s.nome)||"-",dose:h?((F=h.touro)==null?void 0:F.nome)||"Touro desconhecido":"-"}});return{id:`${S}-${_}`,data_despacho:_,acasalamentos:Fe}});w(pe);return}}const we=Array.from(I.keys()).map(E=>({id:`${S}-${E}`,data_despacho:E,acasalamentos:[]}));w(we)}catch{w([])}},[]),Xe=i.useCallback(async()=>{try{ee(!0);const{data:S,error:z}=await c.from("pacotes_aspiracao").select("*").eq("status","FINALIZADO").order("data_aspiracao",{ascending:!1});if(z)throw z;const{data:G,error:I}=await c.from("fazendas").select("id, nome").order("nome",{ascending:!0});if(I)throw I;b(G||[]);const{data:Ne,error:we}=await c.from("clientes").select("id, nome").order("nome",{ascending:!0});we||ne(Ne||[]);const E=new Map(G==null?void 0:G.map(s=>[s.id,s.nome])),te=new Map,t=new Map,p=(S==null?void 0:S.map(s=>s.id))||[];if(p.length>0){const{data:s,error:h}=await c.from("pacotes_aspiracao_fazendas_destino").select("pacote_aspiracao_id, fazenda_destino_id").in("pacote_aspiracao_id",p);!h&&s&&s.forEach(M=>{const l=E.get(M.fazenda_destino_id);if(l){const De=te.get(M.pacote_aspiracao_id)||[];De.push(l),te.set(M.pacote_aspiracao_id,De)}});const{data:F,error:Ae}=await c.from("aspiracoes_doadoras").select("pacote_aspiracao_id").in("pacote_aspiracao_id",p);!Ae&&F&&F.forEach(M=>{M.pacote_aspiracao_id&&t.set(M.pacote_aspiracao_id,(t.get(M.pacote_aspiracao_id)||0)+1)})}const{data:v,error:L}=await c.from("lotes_fiv").select("*").order("data_abertura",{ascending:!1});if(L)throw L;const K=new Set((v==null?void 0:v.map(s=>s.pacote_aspiracao_id).filter(s=>!!s))||[]),D=(S||[]).filter(s=>s.usado_em_lote_fiv!==void 0?!s.usado_em_lote_fiv:!K.has(s.id)).map(s=>({...s,fazenda_nome:E.get(s.fazenda_id),fazendas_destino_nomes:te.get(s.id)||[],quantidade_doadoras:t.get(s.id)||0}));j(D);const O=(v==null?void 0:v.map(s=>s.id))||[],{data:Q,error:oe}=await c.from("lote_fiv_acasalamentos").select("lote_fiv_id").in("lote_fiv_id",O);if(oe)throw oe;const Y=new Map;Q==null||Q.forEach(s=>{Y.set(s.lote_fiv_id,(Y.get(s.lote_fiv_id)||0)+1)});const{data:pe,error:_}=await c.from("lote_fiv_fazendas_destino").select("lote_fiv_id, fazenda_id").in("lote_fiv_id",O);if(_)throw _;const r=new Map;pe==null||pe.forEach(s=>{const h=E.get(s.fazenda_id);if(h){const F=r.get(s.lote_fiv_id)||[];F.push(h),r.set(s.lote_fiv_id,F)}});const C=new Map(D.map(s=>[s.id,s]));(S||[]).forEach(s=>{C.has(s.id)||C.set(s.id,{...s,fazenda_nome:E.get(s.fazenda_id),fazendas_destino_nomes:te.get(s.id)||[],quantidade_doadoras:t.get(s.id)||0})});const Fe=(v||[]).map(s=>{const h=C.get(s.pacote_aspiracao_id);let F=Qe((h==null?void 0:h.data_aspiracao)||null);if(!F){const l=Qe(s.data_abertura);if(l){const[De,ge,qe]=l.split("-").map(Number),$=new Date(De,ge-1,qe);$.setDate($.getDate()-1);const Be=$.getFullYear(),Ye=String($.getMonth()+1).padStart(2,"0"),ja=String($.getDate()).padStart(2,"0");F=`${Be}-${Ye}-${ja}`}}const Ae=za(),M=F?Math.max(0,Ca(Ae,F)):0;return{...s,pacote_nome:h==null?void 0:h.fazenda_nome,pacote_data:h==null?void 0:h.data_aspiracao,fazendas_destino_nomes:r.get(s.id)||[],quantidade_acasalamentos:Y.get(s.id)||0,dia_atual:M}}),xe=Fe.filter(s=>s.status==="ABERTO"&&s.dia_atual!==void 0&&s.dia_atual>9);if(xe.length>0){const s=xe.map(h=>h.id);c.from("lotes_fiv").update({status:"FECHADO"}).in("id",s).then(({error:h})=>{h&&y({title:"Aviso",description:"N√£o foi poss√≠vel fechar automaticamente alguns lotes expirados. Recarregue a p√°gina.",variant:"destructive"})})}U(Fe);const x=new Set(Fe.map(s=>s.pacote_aspiracao_id).filter(s=>!!s)),R=[];(S||[]).forEach(s=>{x.has(s.id)&&R.push({...s,fazenda_nome:E.get(s.fazenda_id),fazendas_destino_nomes:te.get(s.id)||[],quantidade_doadoras:t.get(s.id)||0})}),se(R);const Z=new Map;R.forEach(s=>{s.fazenda_id&&s.fazenda_nome&&Z.set(s.fazenda_id,s.fazenda_nome)}),be(Array.from(Z.entries()).map(([s,h])=>({id:s,nome:h})).sort((s,h)=>s.nome.localeCompare(h.nome)))}catch(S){ia(S,"Erro ao carregar dados")}finally{ee(!1)}},[y]),_a=i.useCallback(async()=>{try{Oe(!0),d(1);let S=c.from("lotes_fiv").select("*").eq("status","FECHADO");P&&(S=S.gte("data_abertura",P)),o&&(S=S.lte("data_abertura",o));const{data:z,error:G}=await S.order("data_abertura",{ascending:!1});if(G)throw G;if(!z||z.length===0){Re([]),Oe(!1);return}const I=z.map(r=>r.id),Ne=[...new Set(z.map(r=>r.pacote_aspiracao_id).filter(Boolean))],{data:we}=await c.from("pacotes_aspiracao").select("id, data_aspiracao, fazenda_id, total_oocitos").in("id",Ne),{data:E}=await c.from("fazendas").select("id, nome").order("nome",{ascending:!0}),te=new Map((E==null?void 0:E.map(r=>[r.id,r.nome]))||[]),t=(E==null?void 0:E.map(r=>({id:r.id,nome:r.nome})))||[],{data:p}=await c.from("lote_fiv_acasalamentos").select("id, lote_fiv_id, quantidade_embrioes, aspiracao_doadora_id").in("lote_fiv_id",I),{data:v,error:L}=await c.from("embrioes").select("id, lote_fiv_id, lote_fiv_acasalamento_id, classificacao, status_atual").in("lote_fiv_id",I);L&&y({title:"Erro ao buscar embri√µes",description:L.message,variant:"destructive"});const{data:K}=await c.from("lote_fiv_fazendas_destino").select("lote_fiv_id, fazenda_id").in("lote_fiv_id",I),m=[...new Set((p==null?void 0:p.map(r=>r.aspiracao_doadora_id).filter(Boolean))||[])],{data:D}=await c.from("aspiracoes_doadoras").select("id, viaveis").in("id",m),O=new Map((we==null?void 0:we.map(r=>[r.id,r]))||[]),Q=new Map,oe=new Map,Y=new Map,pe=new Map((D==null?void 0:D.map(r=>[r.id,r]))||[]);p==null||p.forEach(r=>{Q.has(r.lote_fiv_id)||Q.set(r.lote_fiv_id,[]),Q.get(r.lote_fiv_id).push(r)}),v&&v.length>0&&v.forEach(r=>{r.lote_fiv_id&&(oe.has(r.lote_fiv_id)||oe.set(r.lote_fiv_id,[]),oe.get(r.lote_fiv_id).push(r))}),K==null||K.forEach(r=>{Y.has(r.lote_fiv_id)||Y.set(r.lote_fiv_id,[]);const C=te.get(r.fazenda_id);C&&Y.get(r.lote_fiv_id).push(C)});let _=z.map(r=>{const C=O.get(r.pacote_aspiracao_id),Fe=Q.get(r.id)||[],xe=oe.get(r.id)||[],x=Y.get(r.id)||[],R=xe.length,Z=xe.filter(M=>M.status_atual==="TRANSFERIDO").length,s=xe.filter(M=>M.status_atual==="CONGELADO").length,h=xe.filter(M=>M.status_atual==="DESCARTADO").length,F={};xe.forEach(M=>{M.classificacao?F[M.classificacao]=(F[M.classificacao]||0)+1:F.sem_classificacao=(F.sem_classificacao||0)+1});let Ae=0;return Fe.forEach(M=>{if(M.aspiracao_doadora_id){const l=pe.get(M.aspiracao_doadora_id);l!=null&&l.viaveis&&(Ae+=l.viaveis)}}),{id:r.id,data_abertura:r.data_abertura,status:r.status,observacoes:r.observacoes,pacote_aspiracao_id:r.pacote_aspiracao_id,pacote_data:C==null?void 0:C.data_aspiracao,pacote_nome:te.get((C==null?void 0:C.fazenda_id)||""),fazenda_origem_nome:te.get((C==null?void 0:C.fazenda_id)||""),fazendas_destino_nomes:x,quantidade_acasalamentos:Fe.length,total_embrioes_produzidos:R,total_embrioes_transferidos:Z,total_embrioes_congelados:s,total_embrioes_descartados:h,embrioes_por_classificacao:{BE:F.BE,BN:F.BN,BX:F.BX,BL:F.BL,BI:F.BI,sem_classificacao:F.sem_classificacao},total_oocitos:C==null?void 0:C.total_oocitos,total_viaveis:Ae>0?Ae:void 0}});if(V){const r=t.find(C=>C.id===V);r&&(_=_.filter(C=>C.fazenda_origem_nome===r.nome))}Re(_)}catch(S){ia(S,"Erro ao carregar hist√≥rico")}finally{Oe(!1)}},[P,o,V,d,y]),oa=i.useCallback(async S=>{try{sa(!0);const z=Ie.find(m=>m.id===S);if(!z){y({title:"Erro",description:"Lote n√£o encontrado",variant:"destructive"});return}const{data:G}=await c.from("pacotes_aspiracao").select("*").eq("id",z.pacote_aspiracao_id).single(),{data:I}=await c.from("lote_fiv_acasalamentos").select("*").eq("lote_fiv_id",S).order("created_at",{ascending:!0}),{data:Ne}=await c.from("embrioes").select("*").eq("lote_fiv_id",S).order("created_at",{ascending:!0}),we=[...new Set((I==null?void 0:I.map(m=>m.aspiracao_doadora_id).filter(Boolean))||[])],{data:E}=await c.from("aspiracoes_doadoras").select("*, doadora:doadoras(id, registro, nome)").in("id",we),te=[...new Set((I==null?void 0:I.map(m=>m.dose_semen_id).filter(Boolean))||[])],{data:t}=await c.from("doses_semen").select("*, cliente:clientes(nome), touro:touros(id, nome, registro, raca)").in("id",te),p=new Map((E==null?void 0:E.map(m=>[m.id,m]))||[]),v=new Map((t==null?void 0:t.map(m=>[m.id,m]))||[]),L=new Map;(Ne||[]).forEach(m=>{const D=m.lote_fiv_acasalamento_id||"sem_acasalamento";L.has(D)||L.set(D,{total:0,porStatus:{},porClassificacao:{}});const O=L.get(D);O.total++;const Q=m.status_atual||"sem_status";O.porStatus[Q]=(O.porStatus[Q]||0)+1;const oe=m.classificacao||"sem_classificacao";O.porClassificacao[oe]=(O.porClassificacao[oe]||0)+1});const K={lote:z,pacote:G?{id:G.id,data_aspiracao:G.data_aspiracao,horario_inicio:G.horario_inicio,horario_final:G.horario_final,veterinario_responsavel:G.veterinario_responsavel,tecnico_responsavel:G.tecnico_responsavel,total_oocitos:G.total_oocitos,observacoes:G.observacoes}:void 0,acasalamentos:(I||[]).map(m=>{var Y,pe,_,r;const D=m.aspiracao_doadora_id?p.get(m.aspiracao_doadora_id):null,O=m.dose_semen_id?v.get(m.dose_semen_id):null,Q=D==null?void 0:D.doadora,oe=L.get(m.id)||{total:0,porStatus:{},porClassificacao:{}};return{id:m.id,aspiracao_id:m.aspiracao_doadora_id,doadora:Q?{registro:Q.registro,nome:Q.nome}:void 0,aspiracao:D?{data_aspiracao:D.data_aspiracao,horario_aspiracao:D.horario_aspiracao,viaveis:D.viaveis,expandidos:D.expandidos,total_oocitos:D.total_oocitos,atresicos:D.atresicos,degenerados:D.degenerados,desnudos:D.desnudos,veterinario_responsavel:D.veterinario_responsavel}:void 0,dose_semen:O?{nome:((Y=O.touro)==null?void 0:Y.nome)||"Touro desconhecido",registro:(pe=O.touro)==null?void 0:pe.registro,raca:((_=O.touro)==null?void 0:_.raca)||O.raca,tipo_semen:O.tipo_semen,cliente:(r=O.cliente)==null?void 0:r.nome}:void 0,quantidade_fracionada:m.quantidade_fracionada,quantidade_oocitos:m.quantidade_oocitos,quantidade_embrioes:m.quantidade_embrioes,observacoes:m.observacoes,resumo_embrioes:oe}}),embrioes:(Ne||[]).map(m=>({id:m.id,identificacao:m.identificacao,classificacao:m.classificacao,tipo_embriao:m.tipo_embriao,status_atual:m.status_atual,acasalamento_id:m.lote_fiv_acasalamento_id}))};aa(K)}catch(z){ia(z,"Erro ao carregar detalhes")}finally{sa(!1)}},[Ie,y]),va=i.useCallback(async S=>{Te===S?(Ze(null),aa(null)):(Ze(S),await oa(S))},[Te,oa]),Ge=i.useCallback(async S=>{try{ee(!0);const{data:z,error:G}=await c.from("lotes_fiv").select("*").eq("id",S).single();if(G)throw G;const{data:I,error:Ne}=await c.from("pacotes_aspiracao").select("*").eq("id",z.pacote_aspiracao_id).single();if(Ne){if(Ne.code==="PGRST116"){y({title:"Pacote n√£o encontrado",description:"O lote referencia um pacote de aspira√ß√£o inexistente. Verifique o v√≠nculo do lote.",variant:"destructive"}),ee(!1);return}throw Ne}n(I.data_aspiracao);const{data:we,error:E}=await c.from("fazendas").select("nome").eq("id",I.fazenda_id).single();ce(E?"":(we==null?void 0:we.nome)||"");const{data:te}=await c.from("pacotes_aspiracao_fazendas_destino").select("fazenda_destino_id").eq("pacote_aspiracao_id",I.id);let t=[];if(!te||te.length===0?I.fazenda_destino_id&&(t=[I.fazenda_destino_id]):t=te.map(l=>l.fazenda_destino_id),me(t),t.length>0){const{data:l,error:De}=await c.from("fazendas").select("id, nome").in("id",t);De?Le([]):(Le((l==null?void 0:l.map(ge=>ge.nome))||[]),l&&b(ge=>{const qe=[...ge];return l.forEach($=>{qe.find(Be=>Be.id===$.id)||qe.push($)}),qe}))}else Le([]);const{data:p,error:v}=await c.from("lote_fiv_acasalamentos").select("*").eq("lote_fiv_id",S).order("created_at",{ascending:!0});if(v)throw v;const L=(p==null?void 0:p.map(l=>l.aspiracao_doadora_id))||[],{data:K,error:m}=await c.from("aspiracoes_doadoras").select("id, doadora_id, viaveis").in("id",L);if(m)throw m;const D=[...new Set((K==null?void 0:K.map(l=>l.doadora_id))||[])],{data:O,error:Q}=await c.from("doadoras").select("id, nome, registro").in("id",D);if(Q)throw Q;const oe=[...new Set((p==null?void 0:p.map(l=>l.dose_semen_id))||[])],{data:Y,error:pe}=await c.from("doses_semen").select("id, touro_id, touro:touros(id, nome, registro, raca)").in("id",oe);if(pe)throw pe;const _=new Map(O==null?void 0:O.map(l=>[l.id,l])),r=new Map(Y==null?void 0:Y.map(l=>[l.id,l])),C=new Map(K==null?void 0:K.map(l=>[l.id,l])),{data:Fe,error:xe}=await c.from("embrioes").select("lote_fiv_acasalamento_id").eq("lote_fiv_id",S),x=new Map;!xe&&Fe&&Fe.forEach(l=>{l.lote_fiv_acasalamento_id&&x.set(l.lote_fiv_acasalamento_id,(x.get(l.lote_fiv_acasalamento_id)||0)+1)});const R=(p||[]).map(l=>{const De=C.get(l.aspiracao_doadora_id),ge=De?_.get(De.doadora_id):void 0,qe=r.get(l.dose_semen_id),$=(qe==null?void 0:qe.touro)??null;return{...l,doadora_nome:(ge==null?void 0:ge.nome)||(ge==null?void 0:ge.registro),doadora_registro:ge==null?void 0:ge.registro,dose_nome:($==null?void 0:$.nome)||"Touro desconhecido",viaveis:De==null?void 0:De.viaveis,total_embrioes_produzidos:x.get(l.id)||0}});u(R),_e({...z,pacote_nome:I.fazenda_id,pacote_data:I.data_aspiracao}),de(!0);const{data:Z,error:s}=await c.from("aspiracoes_doadoras").select("id, doadora_id, viaveis").eq("pacote_aspiracao_id",z.pacote_aspiracao_id);if(!s){const l=new Map;p==null||p.forEach($=>{const Be=$.aspiracao_doadora_id,Ye=$.quantidade_oocitos||0;l.set(Be,(l.get(Be)||0)+Ye)});const ge=(Z||[]).filter($=>{const Be=$.viaveis??0,Ye=l.get($.id)||0,ja=Be-Ye;return Be>0&&ja>0}).map($=>({...$,oocitos_disponiveis:($.viaveis??0)-(l.get($.id)||0)}));ae(ge);const qe=[...new Set((Z==null?void 0:Z.map($=>$.doadora_id))||[])];if(qe.length>0){const{data:$,error:Be}=await c.from("doadoras").select("id, nome, registro").in("id",qe);!Be&&$&&re($)}}const{data:h,error:F}=await c.from("doses_semen").select("id, touro_id, cliente_id, tipo_semen, quantidade, touro:touros(id, nome, registro, raca)").order("created_at",{ascending:!1});if(F)f([]);else try{const l=z==null?void 0:z.doses_selecionadas;l&&Array.isArray(l)&&l.length>0?f((h||[]).filter(De=>l.includes(De.id))):f(h||[])}catch{f(h||[])}const{data:Ae,error:M}=await c.from("clientes").select("id, nome").order("nome",{ascending:!0});M||ne(Ae||[]),await ta(S)}catch(z){ia(z,"Erro ao carregar detalhes do lote")}finally{ee(!1)}},[y,ta]);return i.useEffect(()=>{a?Ge(a):Xe()},[a,Xe,Ge]),{lotes:W,pacotes:je,fazendas:X,setFazendas:b,doadoras:ie,clientes:ue,loading:N,selectedLote:fe,setSelectedLote:_e,showLoteDetail:ve,setShowLoteDetail:de,acasalamentos:k,setAcasalamentos:u,fazendasDestinoIds:g,historicoDespachos:J,setHistoricoDespachos:w,aspiracoesDisponiveis:H,dosesDisponiveis:ze,fazendaOrigemNome:A,fazendasDestinoNomes:Se,dosesDisponiveisNoLote:Ee,dataAspiracao:Pe,pacotesParaFiltro:q,fazendasAspiracaoUnicas:Ce,lotesHistoricos:Ie,loadingHistorico:He,loteExpandido:Te,detalhesLoteExpandido:ua,loadingDetalhes:fa,loadData:Xe,loadLoteDetail:Ge,loadLotesHistoricos:_a,handleExpandirLote:va}}function ns({pacotes:a,clientes:P,fazendas:o}){var u;const V=Fa(),{toast:d}=ha(),[y,W]=i.useState(!1),[U,je]=i.useState(!1),[j,X]=i.useState({pacote_aspiracao_id:"",observacoes:"",doses_selecionadas:[]}),[b,ie]=i.useState(null),[re,ue]=i.useState([]),[ne,N]=i.useState([]),[ee,fe]=i.useState([]),_e=async g=>{X({...j,pacote_aspiracao_id:g});const me=a.find(J=>J.id===g);if(ie(me||null),me){const{data:J,error:w}=await c.from("aspiracoes_doadoras").select("id, doadora_id, viaveis").eq("pacote_aspiracao_id",g);if(w)return;N(J||[]);const H=[...new Set((J==null?void 0:J.map(f=>f.doadora_id))||[])];if(H.length>0){const{data:f,error:A}=await c.from("doadoras").select("id, nome, registro").in("id",H);if(A)return;fe(f||[])}const{data:ae,error:ze}=await c.from("doses_semen").select("id, cliente_id, touro_id, tipo_semen, quantidade, touro:touros(id, nome, registro, raca)").order("created_at",{ascending:!1});if(ze)return;ue(ae||[])}},ve=async g=>{var me,J;if(g.preventDefault(),!j.pacote_aspiracao_id){d({title:"Erro de valida√ß√£o",description:"Pacote de aspira√ß√£o √© obrigat√≥rio",variant:"destructive"});return}if(!b){d({title:"Erro de valida√ß√£o",description:"Pacote selecionado n√£o encontrado",variant:"destructive"});return}try{je(!0);const{data:w,error:H}=await c.from("pacotes_aspiracao").select("id, status").eq("id",j.pacote_aspiracao_id).single();if(H||!w){d({title:"Erro de valida√ß√£o",description:"Pacote de aspira√ß√£o n√£o encontrado ou inv√°lido",variant:"destructive"});return}if(w.status!=="FINALIZADO"){d({title:"Erro de valida√ß√£o",description:"Apenas pacotes FINALIZADOS podem ser usados para criar lotes FIV",variant:"destructive"});return}const ae=new Date(b.data_aspiracao);ae.setDate(ae.getDate()+1);const ze=ae.toISOString().split("T")[0],f={pacote_aspiracao_id:j.pacote_aspiracao_id,data_abertura:ze,data_fecundacao:ze,status:"ABERTO",observacoes:j.observacoes||null};if(j.doses_selecionadas&&j.doses_selecionadas.length>0)try{f.doses_selecionadas=j.doses_selecionadas}catch{}let A;const{data:ce,error:Se}=await c.from("lotes_fiv").insert([f]).select().single();if(Se)if((me=Se.message)!=null&&me.includes("doses_selecionadas")||Se.code==="42703"){delete f.doses_selecionadas;const{data:Ee,error:ye}=await c.from("lotes_fiv").insert([f]).select().single();if(ye)throw ye;A=Ee}else throw Se;else A=ce;const Le=(J=b.fazendas_destino_nomes)==null?void 0:J.map(Ee=>{const ye=o.find(Pe=>Pe.nome===Ee);return ye==null?void 0:ye.id}).filter(Ee=>!!Ee);if(Le&&Le.length>0){const{error:Ee}=await c.from("lote_fiv_fazendas_destino").insert(Le.map(ye=>({lote_fiv_id:A.id,fazenda_id:ye})));if(Ee)throw Ee}try{await c.from("pacotes_aspiracao").update({usado_em_lote_fiv:!0}).eq("id",j.pacote_aspiracao_id)}catch{}d({title:"Lote FIV criado",description:"Lote FIV criado com sucesso. Agora voc√™ pode adicionar acasalamentos."}),W(!1),de(),V(`/lotes-fiv/${A.id}`)}catch(w){const H=w instanceof Error?w.message:"Erro desconhecido";d({title:"Erro ao criar lote",description:H.includes("RLS")||H.includes("policy")?"RLS est√° bloqueando escrita. Configure pol√≠ticas anon no Supabase.":H,variant:"destructive"})}finally{je(!1)}},de=()=>{X({pacote_aspiracao_id:"",observacoes:"",doses_selecionadas:[]}),ie(null),N([]),fe([]),ue([])},k=()=>{W(!1),de()};return e.jsxs(wa,{open:y,onOpenChange:W,children:[e.jsx(Ja,{asChild:!0,children:e.jsxs(le,{className:"bg-green-600 hover:bg-green-700",children:[e.jsx($a,{className:"w-4 h-4 mr-2"}),"Novo Lote"]})}),e.jsxs(Da,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(Sa,{children:[e.jsx(Ea,{children:"Criar Novo Lote FIV"}),e.jsx(ya,{children:"Selecione um pacote de aspira√ß√£o FINALIZADO para criar o lote"})]}),e.jsxs("form",{onSubmit:ve,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(he,{htmlFor:"pacote_aspiracao_id",children:"Pacote de Aspira√ß√£o *"}),a.length===0?e.jsxs("div",{className:"border rounded-lg p-4 bg-yellow-50 border-yellow-200",children:[e.jsx("p",{className:"text-sm text-yellow-800 font-medium mb-2",children:"Nenhum pacote dispon√≠vel"}),e.jsxs("p",{className:"text-sm text-yellow-700",children:["Verifique se o pacote de aspira√ß√£o est√° com status ",e.jsx("strong",{children:"FINALIZADO"})," e ainda n√£o foi usado para criar um lote FIV."]})]}):e.jsxs(ca,{value:j.pacote_aspiracao_id,onValueChange:_e,children:[e.jsx(la,{children:e.jsx(ma,{placeholder:"Selecione o pacote"})}),e.jsx(pa,{children:a.map(g=>e.jsxs(xa,{value:g.id,children:[Me(g.data_aspiracao)," - ",g.fazenda_nome," (",g.quantidade_doadoras," doadoras)"]},g.id))})]}),b&&e.jsxs("div",{className:"text-sm text-slate-600 space-y-1 mt-2 p-3 bg-slate-50 rounded-lg",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Data do Pacote:"})," ",Me(b.data_aspiracao)]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Data de Fecunda√ß√£o do Lote:"})," ",(()=>{const g=new Date(b.data_aspiracao);return g.setDate(g.getDate()+1),Me(g.toISOString().split("T")[0])})()]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Fazendas Destino:"})," ",((u=b.fazendas_destino_nomes)==null?void 0:u.join(", "))||"Nenhuma"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Quantidade de Doadoras:"})," ",b.quantidade_doadoras||0]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(he,{children:"Doses de S√™men Dispon√≠veis no Lote *"}),e.jsx("div",{className:"border rounded-lg p-4 max-h-60 overflow-y-auto",children:re.length===0?e.jsx("p",{className:"text-sm text-slate-500",children:b?"Carregando doses...":"Selecione um pacote primeiro"}):e.jsx("div",{className:"space-y-2",children:re.map(g=>{var w,H;const me=P.find(ae=>ae.id===g.cliente_id),J=j.doses_selecionadas.includes(g.id);return e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:`dose-${g.id}`,checked:J,onChange:ae=>{ae.target.checked?X({...j,doses_selecionadas:[...j.doses_selecionadas,g.id]}):X({...j,doses_selecionadas:j.doses_selecionadas.filter(ze=>ze!==g.id)})},className:"rounded"}),e.jsxs("label",{htmlFor:`dose-${g.id}`,className:"text-sm cursor-pointer flex-1",children:[e.jsx("span",{className:"font-medium",children:((w=g.touro)==null?void 0:w.nome)||"Touro desconhecido"}),((H=g.touro)==null?void 0:H.registro)&&e.jsxs("span",{className:"text-slate-500 ml-2",children:["(",g.touro.registro,")"]}),me&&e.jsxs("span",{className:"text-slate-500 ml-2",children:["- ",me.nome]})]})]},g.id)})})}),e.jsx("p",{className:"text-xs text-slate-500",children:"Selecione as doses de s√™men que estar√£o dispon√≠veis para uso neste lote"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(he,{htmlFor:"observacoes",children:"Observa√ß√µes"}),e.jsx(Pa,{id:"observacoes",value:j.observacoes,onChange:g=>X({...j,observacoes:g.target.value}),placeholder:"Observa√ß√µes sobre o lote",rows:3})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(le,{type:"submit",className:"flex-1 bg-green-600 hover:bg-green-700",disabled:U,children:U?"Criando...":"Criar Lote"}),e.jsx(le,{type:"button",variant:"outline",onClick:k,disabled:U,children:"Cancelar"})]})]})]})]})}function Ve(a){return{[-1]:"Aspira√ß√£o",0:"Fecunda√ß√£o",1:"Zigoto",2:"2 C√©lulas",3:"4 C√©lulas",4:"8 C√©lulas",5:"M√≥rula",6:"Blastocisto",7:"Blastocisto Expandido",8:"Blastocisto Expandido"}[a]||`D${a}`}function ds({lote:a,acasalamentos:P,aspiracoesDisponiveis:o,dosesDisponiveis:V,dosesDisponiveisNoLote:d,doadoras:y,clientes:W,historicoDespachos:U,dataAspiracao:je,fazendaOrigemNome:j,fazendasDestinoNomes:X,submitting:b,onBack:ie,onAddAcasalamento:re,onDespacharEmbrioes:ue,onUpdateQuantidadeEmbrioes:ne,editQuantidadeEmbrioes:N,onUpdateClivados:ee,editClivados:fe={}}){var Pe;const _e=Fa(),{toast:ve}=ha(),[de,k]=i.useState(!1),[u,g]=i.useState(!1),[me,J]=i.useState(""),[w,H]=i.useState({aspiracao_doadora_id:"",dose_semen_id:"",quantidade_fracionada:"1.0",quantidade_oocitos:"",observacoes:""});let ae=Qe(je||a.pacote_data||null);if(!ae){const n=Qe(a.data_abertura);if(n){const[q,se,Ce]=n.split("-").map(Number),be=new Date(q,se-1,Ce);be.setDate(be.getDate()-1),ae=`${be.getFullYear()}-${String(be.getMonth()+1).padStart(2,"0")}-${String(be.getDate()).padStart(2,"0")}`}}if(!ae)return e.jsx("div",{children:"Erro: Data de aspira√ß√£o n√£o encontrada"});const ze=za(),f=Math.max(0,Ca(ze,ae)),A=is(f),ce=Ra(ae,8),Se=ga(ce),Le=Va(ce),Ee=async n=>{if(n.preventDefault(),!w.aspiracao_doadora_id){ve({title:"Erro de valida√ß√£o",description:"Doadora √© obrigat√≥ria",variant:"destructive"});return}if(!w.dose_semen_id){ve({title:"Erro de valida√ß√£o",description:"Selecione uma dose de s√™men",variant:"destructive"});return}if((parseFloat(w.quantidade_fracionada)||0)<=0){ve({title:"Erro de valida√ß√£o",description:"Quantidade fracionada deve ser maior que zero",variant:"destructive"});return}try{await re(w),k(!1),H({aspiracao_doadora_id:"",dose_semen_id:"",quantidade_fracionada:"1.0",quantidade_oocitos:"",observacoes:""}),J("")}catch{}},ye=()=>{ie(),_e("/lotes-fiv")};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(le,{variant:"ghost",size:"sm",onClick:ye,children:e.jsx(Ka,{className:"w-4 h-4"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-slate-900",children:"Detalhes do Lote FIV"}),e.jsxs("div",{className:"text-slate-600 mt-1 flex items-center gap-2",children:[e.jsxs("span",{children:["Data de fecunda√ß√£o (D0): ",Me(a.data_abertura)," |",ae&&` Data aspira√ß√£o (D-1): ${ga(ae)} |`,A===-1?` D-1 - ${Ve(A)} |`:` D${A} - ${Ve(A)} |`," ","Status:"]}),e.jsx(ke,{variant:a.status==="FECHADO"?"default":"secondary",children:a.status})]})]})]}),e.jsxs(Je,{children:[e.jsx(Ke,{children:e.jsx(We,{children:"Informa√ß√µes do Lote"})}),e.jsxs(ea,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(he,{children:"Dia Atual"}),e.jsx("p",{className:"text-2xl font-bold",children:A===-1?e.jsxs(e.Fragment,{children:["D-1 ",e.jsxs("span",{className:"text-lg font-normal text-slate-600",children:["- ",Ve(A)]})]}):e.jsxs(e.Fragment,{children:["D",A," ",e.jsxs("span",{className:"text-lg font-normal text-slate-600",children:["- ",Ve(A)]})]})})]}),e.jsxs("div",{children:[e.jsx(he,{children:"Data da TE"}),f<7?e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-orange-600",children:Se}),e.jsx("p",{className:"text-sm text-slate-500",children:Le})]}):e.jsx("p",{className:"text-2xl font-bold text-green-600",children:"Hoje ou passou"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(he,{children:"Fazenda de Origem"}),e.jsx("p",{className:"font-medium",children:j||a.pacote_nome||"-"})]}),e.jsxs("div",{children:[e.jsx(he,{children:"Fazendas de Destino"}),e.jsx("p",{className:"font-medium",children:X.length>0?X.join(", "):((Pe=a.fazendas_destino_nomes)==null?void 0:Pe.join(", "))||"-"})]})]}),a.observacoes&&e.jsxs("div",{children:[e.jsx(he,{children:"Observa√ß√µes"}),e.jsx("p",{className:"text-slate-600",children:a.observacoes})]}),a.status==="ABERTO"&&f===7&&e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"text-blue-800 font-medium",children:["üìä Este lote est√° no D6 (",Ve(6),"). Voc√™ pode preencher a quantidade de embri√µes (pr√©via) e gerar um relat√≥rio."]}),e.jsxs(le,{variant:"outline",size:"sm",onClick:()=>g(!0),children:[e.jsx(Wa,{className:"w-4 h-4 mr-2"}),"Gerar Relat√≥rio de Pr√©via"]})]})}),(a.status==="ABERTO"&&(f===8||f===9)||a.status==="FECHADO"&&f===9)&&e.jsx("div",{className:"bg-orange-50 border border-orange-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"text-orange-800 font-medium",children:["‚ö†Ô∏è Este lote est√° no ",f===8?"D7":"D8"," (",Ve(f===8?7:8),"). ",f===8?"Informe a quantidade de embri√µes para cada acasalamento e despache os embri√µes.":"Per√≠odo de emerg√™ncia (D8). Voc√™ pode adicionar novos acasalamentos e despachar os embri√µes imediatamente."]}),e.jsxs(le,{variant:"default",size:"sm",onClick:ue,disabled:b,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(Aa,{className:"w-4 h-4 mr-2"}),b?"Despachando...":"Despachar Todos os Embri√µes"]})]})})]})]}),e.jsxs(Je,{children:[e.jsx(Ke,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(We,{className:"flex items-center gap-2",children:[e.jsx(Na,{className:"w-5 h-5"}),"Acasalamentos (",P.length,")"]}),a.status==="ABERTO"&&e.jsxs(le,{size:"sm",onClick:()=>k(!0),className:"bg-green-600 hover:bg-green-700",children:[e.jsx($a,{className:"w-4 h-4 mr-2"}),"Adicionar Acasalamento"]})]})}),e.jsx(ea,{children:P.length===0?e.jsxs("div",{className:"text-center py-8 text-slate-500",children:[e.jsx(Na,{className:"w-12 h-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"Nenhum acasalamento cadastrado"}),a.status==="ABERTO"&&e.jsx(le,{variant:"outline",size:"sm",className:"mt-2",onClick:()=>k(!0),children:"Adicionar primeiro acasalamento"})]}):e.jsxs(ra,{children:[e.jsx(na,{children:e.jsxs($e,{children:[e.jsx(T,{children:"Doadora"}),e.jsx(T,{children:"Touro"}),e.jsx(T,{className:"text-center",children:"O√≥citos"}),e.jsx(T,{className:"text-center",children:"D3 Clivados"}),e.jsx(T,{className:"text-center",children:"Qtd. Embri√µes"}),e.jsx(T,{className:"text-center",children:"%"}),e.jsx(T,{children:"Observa√ß√µes"})]})}),e.jsx(da,{children:P.map(n=>{const q=n.viaveis||0,se=fe[n.id],Ce=n.embrioes_clivados_d3,be=se!==void 0?se:(Ce==null?void 0:Ce.toString())??"",Ie=parseInt(be)||0,Re=Ie>0?Ie:q,He=N[n.id]!==void 0?parseInt(N[n.id])||0:n.total_embrioes_produzidos||0,Oe=q>0?(He/q*100).toFixed(1):"0.0";return e.jsxs($e,{children:[e.jsx(B,{children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:n.doadora_registro||"-"}),n.doadora_nome&&e.jsx("p",{className:"text-sm text-slate-500",children:n.doadora_nome})]})}),e.jsx(B,{children:n.dose_nome||"-"}),e.jsx(B,{className:"text-center",children:q}),e.jsx(B,{className:"text-center",children:a.status==="ABERTO"&&A>=3&&ee?e.jsx(Ue,{type:"number",min:"0",max:q,className:"w-20 text-center",value:be,onChange:Te=>ee(n.id,Te.target.value),placeholder:"-"}):e.jsx("span",{children:Ie>0?Ie:"-"})}),e.jsx(B,{className:"text-center",children:a.status==="ABERTO"&&f>=7?e.jsx(Ue,{type:"number",min:"0",max:Re,className:"w-20 text-center",value:N[n.id]??n.total_embrioes_produzidos??"",onChange:Te=>ne(n.id,Te.target.value),placeholder:"0"}):e.jsx("span",{children:He})}),e.jsx(B,{className:"text-center",children:e.jsxs(ke,{variant:parseFloat(Oe)>=30?"default":"secondary",children:[Oe,"%"]})}),e.jsx(B,{className:"max-w-[200px] truncate",children:n.observacoes||"-"})]},n.id)})})]})})]}),U.length>0&&e.jsxs(Je,{children:[e.jsx(Ke,{children:e.jsxs(We,{className:"flex items-center gap-2",children:[e.jsx(Aa,{className:"w-5 h-5"}),"Hist√≥rico de Despachos"]})}),e.jsx(ea,{children:e.jsx("div",{className:"space-y-4",children:U.map(n=>e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsxs("p",{className:"font-medium mb-2",children:["Despacho em ",ga(n.data_despacho)]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2",children:n.acasalamentos.map((q,se)=>e.jsxs("div",{className:"text-sm bg-slate-50 rounded p-2",children:[e.jsx("span",{className:"font-medium",children:q.doadora}),e.jsxs("span",{className:"text-slate-500",children:[" x ",q.dose]}),e.jsxs("span",{className:"ml-2 text-green-600 font-medium",children:["(",q.quantidade,")"]})]},se))})]},n.id))})})]}),e.jsx(wa,{open:de,onOpenChange:k,children:e.jsxs(Da,{className:"max-w-lg",children:[e.jsxs(Sa,{children:[e.jsx(Ea,{children:"Adicionar Acasalamento"}),e.jsx(ya,{children:"Selecione a doadora e a dose de s√™men para o acasalamento"})]}),e.jsxs("form",{onSubmit:Ee,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(he,{children:"Doadora *"}),e.jsxs(ca,{value:w.aspiracao_doadora_id,onValueChange:n=>{H({...w,aspiracao_doadora_id:n});const q=o.find(se=>se.id===n);q&&H(se=>({...se,aspiracao_doadora_id:n,quantidade_oocitos:String(q.oocitos_disponiveis||q.viaveis||0)}))},children:[e.jsx(la,{children:e.jsx(ma,{placeholder:"Selecione a doadora"})}),e.jsx(pa,{children:o.map(n=>{const q=y.find(se=>se.id===n.doadora_id);return e.jsxs(xa,{value:n.id,children:[(q==null?void 0:q.registro)||(q==null?void 0:q.nome)||"Doadora"," - ",n.oocitos_disponiveis??n.viaveis??0," o√≥citos dispon√≠veis"]},n.id)})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(he,{children:"Dose de S√™men *"}),e.jsxs(ca,{value:w.dose_semen_id,onValueChange:n=>H({...w,dose_semen_id:n}),children:[e.jsx(la,{children:e.jsx(ma,{placeholder:"Selecione a dose"})}),e.jsx(pa,{children:(d.length>0?d:V).map(n=>{var se,Ce;const q=W.find(be=>be.id===n.cliente_id);return e.jsxs(xa,{value:n.id,children:[((se=n.touro)==null?void 0:se.nome)||"Touro desconhecido",((Ce=n.touro)==null?void 0:Ce.registro)&&` (${n.touro.registro})`,q&&` - ${q.nome}`]},n.id)})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(he,{children:"Qtd. Fracionada"}),e.jsx(Ue,{type:"number",step:"0.1",min:"0",value:w.quantidade_fracionada,onChange:n=>H({...w,quantidade_fracionada:n.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(he,{children:"Qtd. O√≥citos"}),e.jsx(Ue,{type:"number",min:"0",value:w.quantidade_oocitos,onChange:n=>H({...w,quantidade_oocitos:n.target.value}),placeholder:"Auto"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(he,{children:"Observa√ß√µes"}),e.jsx(Pa,{value:w.observacoes,onChange:n=>H({...w,observacoes:n.target.value}),placeholder:"Observa√ß√µes sobre o acasalamento",rows:2})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(le,{type:"submit",className:"flex-1 bg-green-600 hover:bg-green-700",disabled:b,children:b?"Adicionando...":"Adicionar"}),e.jsx(le,{type:"button",variant:"outline",onClick:()=>{k(!1),H({aspiracao_doadora_id:"",dose_semen_id:"",quantidade_fracionada:"1.0",quantidade_oocitos:"",observacoes:""})},children:"Cancelar"})]})]})]})}),e.jsx(wa,{open:u,onOpenChange:g,children:e.jsxs(Da,{className:"max-w-2xl",children:[e.jsxs(Sa,{children:[e.jsx(Ea,{children:"Relat√≥rio de Pr√©via - D6"}),e.jsx(ya,{children:"Resumo dos acasalamentos e embri√µes previstos"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"border rounded-lg p-4 bg-slate-50",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Informa√ß√µes do Lote"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"text-slate-500",children:"Fazenda Origem:"})," ",j||a.pacote_nome]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-slate-500",children:"Fazendas Destino:"})," ",X.join(", ")||"-"]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-slate-500",children:"Data TE prevista:"})," ",Se]}),e.jsxs("p",{children:[e.jsx("span",{className:"text-slate-500",children:"Total Acasalamentos:"})," ",P.length]})]})]}),e.jsxs(ra,{children:[e.jsx(na,{children:e.jsxs($e,{children:[e.jsx(T,{children:"Doadora"}),e.jsx(T,{children:"Touro"}),e.jsx(T,{className:"text-center",children:"O√≥citos"}),e.jsx(T,{className:"text-center",children:"Embri√µes (prev.)"})]})}),e.jsx(da,{children:P.map(n=>e.jsxs($e,{children:[e.jsx(B,{children:n.doadora_registro||"-"}),e.jsx(B,{children:n.dose_nome||"-"}),e.jsx(B,{className:"text-center",children:n.viaveis||0}),e.jsx(B,{className:"text-center",children:N[n.id]??n.total_embrioes_produzidos??"-"})]},n.id))})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(le,{onClick:()=>g(!1),children:"Fechar"})})]})]})})]})}function cs({lotesHistoricos:a,fazendas:P,detalhesLoteExpandido:o,loteExpandido:V,loadingHistorico:d,loadingDetalhes:y,filtroHistoricoDataInicio:W,setFiltroHistoricoDataInicio:U,filtroHistoricoDataFim:je,setFiltroHistoricoDataFim:j,filtroHistoricoFazenda:X,setFiltroHistoricoFazenda:b,filtroHistoricoFazendaBusca:ie,setFiltroHistoricoFazendaBusca:re,showFazendaBuscaHistorico:ue,setShowFazendaBuscaHistorico:ne,historicoPage:N,setHistoricoPage:ee,HISTORICO_PAGE_SIZE:fe,onLoadHistorico:_e,onExpandirLote:ve}){const de=Math.max(1,Math.ceil(a.length/fe)),k=()=>{U(""),j(""),b(""),re(""),ne(!1),_e()};return e.jsxs("div",{className:"mt-0",children:[e.jsxs("div",{className:"flex gap-4 mb-6 flex-wrap items-end",children:[e.jsxs("div",{className:"flex-1 min-w-[280px]",children:[e.jsxs("div",{className:"mb-2",children:[e.jsx(he,{className:"text-sm font-medium text-slate-700",children:"Per√≠odo de Busca"}),e.jsx("p",{className:"text-xs text-slate-500 mt-0.5",children:"Filtro pela data D0 (Fecunda√ß√£o) do lote"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(he,{htmlFor:"filtro-historico-data-inicio",className:"text-xs text-slate-500 font-normal",children:"Data In√≠cio"}),e.jsx(Oa,{value:W,onChange:u=>U(u||""),placeholder:"Data inicial"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx(he,{htmlFor:"filtro-historico-data-fim",className:"text-xs text-slate-500 font-normal",children:"Data Fim"}),e.jsx(Oa,{value:je,onChange:u=>j(u||""),placeholder:"Data final"})]})]})]}),e.jsxs("div",{className:"flex-1 min-w-[250px] relative fazenda-busca-historico-container",children:[e.jsx(he,{htmlFor:"filtro-historico-fazenda",children:"Fazenda de Origem"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ue,{id:"filtro-historico-fazenda",placeholder:"Digite para buscar fazenda...",value:ie,onChange:u=>{re(u.target.value),ne(!0),u.target.value||b("")},onFocus:()=>ne(!0)}),X&&e.jsx(le,{variant:"ghost",size:"sm",className:"absolute right-1 top-1 h-7 w-7 p-0",onClick:()=>{b(""),re(""),ne(!1)},children:e.jsx(ka,{className:"h-4 w-4"})}),ue&&P.length>0&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-white border rounded-md shadow-lg max-h-60 overflow-auto",children:P.filter(u=>u.nome.toLowerCase().includes(ie.toLowerCase())).map(u=>e.jsx("div",{className:"px-4 py-2 hover:bg-slate-100 cursor-pointer",onClick:()=>{b(u.id),re(u.nome),ne(!1)},children:u.nome},u.id))}),ue&&ie&&P.filter(u=>u.nome.toLowerCase().includes(ie.toLowerCase())).length===0&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-white border rounded-md shadow-lg p-4 text-sm text-slate-500",children:"Nenhuma fazenda encontrada"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(le,{onClick:_e,disabled:d,className:"bg-blue-600 hover:bg-blue-700",children:[e.jsx(es,{className:"w-4 h-4 mr-2"}),"Buscar"]}),(W||je||X)&&e.jsx(le,{variant:"outline",onClick:k,children:"Limpar"})]})]}),d?e.jsx("div",{className:"py-8",children:e.jsx(qa,{})}):a.length===0?e.jsx(Ma,{title:"Nenhum lote hist√≥rico encontrado",description:"Ajuste os filtros ou tente outro per√≠odo."}):e.jsxs("div",{className:"space-y-4",children:[a.slice((N-1)*fe,N*fe).map(u=>e.jsx(ls,{lote:u,isExpanded:V===u.id,detalhes:V===u.id?o:null,loadingDetalhes:y&&V===u.id,onExpandir:()=>ve(u.id)},u.id)),e.jsxs("div",{className:"flex items-center justify-between pt-2 text-sm text-slate-600",children:[e.jsxs("div",{children:[a.length," lotes no hist√≥rico"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(le,{variant:"outline",size:"sm",onClick:()=>ee(Math.max(1,N-1)),disabled:N===1,children:"Anterior"}),e.jsxs("span",{children:["P√°gina ",Math.min(N,de)," de ",de]}),e.jsx(le,{variant:"outline",size:"sm",onClick:()=>ee(Math.min(de,N+1)),disabled:N>=de,children:"Pr√≥xima"})]})]})]})]})}function ls({lote:a,isExpanded:P,detalhes:o,loadingDetalhes:V,onExpandir:d}){return e.jsxs(Je,{className:"border-l-4 border-l-slate-400",children:[e.jsx(Ke,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(We,{className:"text-lg",children:["Lote FIV - ",Me(a.data_abertura)]}),e.jsx(le,{variant:"outline",size:"sm",onClick:d,disabled:V,children:P?e.jsxs(e.Fragment,{children:[e.jsx(Qa,{className:"w-4 h-4 mr-2"}),"Recolher"]}):e.jsxs(e.Fragment,{children:[e.jsx(Za,{className:"w-4 h-4 mr-2"}),"Ver Detalhes Completos"]})})]})}),e.jsxs(ea,{className:"pt-0",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Informa√ß√µes B√°sicas"}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Data da Aspira√ß√£o:"})," ",a.pacote_data?Me(a.pacote_data):"-"]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Fazenda Origem:"})," ",a.fazenda_origem_nome||"-"]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Data de Abertura:"})," ",Me(a.data_abertura)]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Status:"})," ",e.jsx(ke,{variant:"outline",children:a.status})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Fazendas Destino"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:a.fazendas_destino_nomes&&a.fazendas_destino_nomes.length>0?a.fazendas_destino_nomes.map((y,W)=>e.jsx(ke,{variant:"outline",className:"text-xs",children:y},W)):e.jsx("span",{className:"text-slate-400 text-sm",children:"-"})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Estat√≠sticas"}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Acasalamentos:"})," ",a.quantidade_acasalamentos||0]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total de Embri√µes:"})," ",a.total_embrioes_produzidos||0]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total Transferidos:"})," ",e.jsx("span",{className:"text-green-700 font-semibold",children:a.total_embrioes_transferidos||0})]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total Congelados:"})," ",e.jsx("span",{className:"text-blue-700 font-semibold",children:a.total_embrioes_congelados||0})]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total Descartados:"})," ",e.jsx("span",{className:"text-red-700 font-semibold",children:a.total_embrioes_descartados||0})]}),a.total_oocitos&&e.jsxs("p",{className:"mt-2 pt-2 border-t border-slate-200",children:[e.jsx("span",{className:"font-medium",children:"Total de O√≥citos:"})," ",a.total_oocitos]}),a.total_viaveis&&e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"O√≥citos Vi√°veis:"})," ",a.total_viaveis]})]})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2 lg:col-span-3",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Embri√µes por Classifica√ß√£o"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-6 gap-2",children:[a.embrioes_por_classificacao.BE&&e.jsxs("div",{className:"bg-green-50 p-2 rounded border",children:[e.jsx("p",{className:"text-xs font-medium text-green-800",children:"BE"}),e.jsx("p",{className:"text-lg font-bold text-green-900",children:a.embrioes_por_classificacao.BE})]}),a.embrioes_por_classificacao.BN&&e.jsxs("div",{className:"bg-blue-50 p-2 rounded border",children:[e.jsx("p",{className:"text-xs font-medium text-blue-800",children:"BN"}),e.jsx("p",{className:"text-lg font-bold text-blue-900",children:a.embrioes_por_classificacao.BN})]}),a.embrioes_por_classificacao.BX&&e.jsxs("div",{className:"bg-yellow-50 p-2 rounded border",children:[e.jsx("p",{className:"text-xs font-medium text-yellow-800",children:"BX"}),e.jsx("p",{className:"text-lg font-bold text-yellow-900",children:a.embrioes_por_classificacao.BX})]}),a.embrioes_por_classificacao.BL&&e.jsxs("div",{className:"bg-orange-50 p-2 rounded border",children:[e.jsx("p",{className:"text-xs font-medium text-orange-800",children:"BL"}),e.jsx("p",{className:"text-lg font-bold text-orange-900",children:a.embrioes_por_classificacao.BL})]}),a.embrioes_por_classificacao.BI&&e.jsxs("div",{className:"bg-red-50 p-2 rounded border",children:[e.jsx("p",{className:"text-xs font-medium text-red-800",children:"BI"}),e.jsx("p",{className:"text-lg font-bold text-red-900",children:a.embrioes_por_classificacao.BI})]}),a.embrioes_por_classificacao.sem_classificacao&&e.jsxs("div",{className:"bg-slate-50 p-2 rounded border",children:[e.jsx("p",{className:"text-xs font-medium text-slate-800",children:"Sem Classifica√ß√£o"}),e.jsx("p",{className:"text-lg font-bold text-slate-900",children:a.embrioes_por_classificacao.sem_classificacao})]})]})]}),a.observacoes&&e.jsxs("div",{className:"space-y-2 md:col-span-2 lg:col-span-3",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Observa√ß√µes"}),e.jsx("p",{className:"text-sm text-slate-600 bg-slate-50 p-3 rounded border",children:a.observacoes})]})]}),P&&e.jsx(ms,{detalhes:o,loadingDetalhes:V})]})]})}function ms({detalhes:a,loadingDetalhes:P}){return P?e.jsx("div",{className:"mt-4 pt-4 border-t border-slate-200 py-4",children:e.jsx(qa,{})}):a?e.jsxs("div",{className:"mt-4 pt-4 border-t border-slate-200 space-y-4",children:[a.pacote&&e.jsxs("div",{className:"bg-slate-50 p-3 rounded border text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Aa,{className:"w-4 h-4 text-slate-600"}),e.jsx("span",{className:"font-semibold",children:"Pacote de Aspira√ß√£o"})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-x-4 gap-y-1",children:[a.pacote.data_aspiracao&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Data:"})," ",e.jsx("span",{className:"font-medium",children:Me(a.pacote.data_aspiracao)})]}),a.pacote.horario_inicio&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Hora In√≠cio:"})," ",e.jsx("span",{className:"font-medium",children:a.pacote.horario_inicio})]}),a.pacote.horario_final&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Hora Fim Aspira√ß√£o:"})," ",e.jsx("span",{className:"font-medium",children:a.pacote.horario_final})]}),a.pacote.veterinario_responsavel&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"Vet:"})," ",e.jsx("span",{className:"font-medium",children:a.pacote.veterinario_responsavel})]}),a.pacote.tecnico_responsavel&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"T√©cnico:"})," ",e.jsx("span",{className:"font-medium",children:a.pacote.tecnico_responsavel})]}),a.pacote.total_oocitos&&e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-600",children:"O√≥citos Totais:"})," ",e.jsx("span",{className:"font-medium",children:a.pacote.total_oocitos})]}),a.pacote.observacoes&&e.jsxs("div",{className:"col-span-full mt-1 pt-1 border-t border-slate-200",children:[e.jsx("span",{className:"text-slate-600",children:"Obs:"})," ",e.jsx("span",{className:"text-slate-700",children:a.pacote.observacoes})]})]})]}),a.acasalamentos.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Na,{className:"w-4 h-4 text-slate-600"}),e.jsxs("span",{className:"font-semibold text-sm",children:["Acasalamentos e Embri√µes (",a.acasalamentos.length,")"]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(ra,{children:[e.jsx(na,{children:e.jsxs($e,{className:"bg-slate-50",children:[e.jsx(T,{className:"h-8 text-xs font-semibold",children:"#"}),e.jsx(T,{className:"h-8 text-xs font-semibold",children:"Doadora"}),e.jsx(T,{className:"h-8 text-xs font-semibold",children:"Aspira√ß√£o"}),e.jsx(T,{className:"h-8 text-xs font-semibold",children:"O√≥citos"}),e.jsx(T,{className:"h-8 text-xs font-semibold",children:"Vi√°veis"}),e.jsx(T,{className:"h-8 text-xs font-semibold",children:"S√™men"}),e.jsx(T,{className:"h-8 text-xs font-semibold",children:"Dose"}),e.jsx(T,{className:"h-8 text-xs font-semibold",children:"Embri√µes Prod."}),e.jsx(T,{className:"h-8 text-xs font-semibold",children:"Total Emb."}),e.jsx(T,{className:"h-8 text-xs font-semibold",children:"Transf."}),e.jsx(T,{className:"h-8 text-xs font-semibold",children:"Cong."}),e.jsx(T,{className:"h-8 text-xs font-semibold",children:"Desc."}),e.jsx(T,{className:"h-8 text-xs font-semibold",children:"Outros"}),e.jsx(T,{className:"h-8 text-xs font-semibold",children:"Classifica√ß√£o"})]})}),e.jsx(da,{children:a.acasalamentos.map((o,V)=>{var ie,re,ue,ne,N,ee,fe,_e,ve,de;const d=o.resumo_embrioes,y=(d==null?void 0:d.porStatus.TRANSFERIDO)||0,W=(d==null?void 0:d.porStatus.CONGELADO)||0,U=(d==null?void 0:d.porStatus.DESCARTADO)||0,je=d?d.total-y-W-U:0,j=d&&Object.entries(d.porClassificacao).filter(([k])=>k!=="sem_classificacao").sort((k,u)=>u[1]-k[1]).map(([k,u])=>`${k}(${u})`).join(", ")||"-",X=V>0?a.acasalamentos[V-1]:null,b=X&&o.aspiracao_id&&o.aspiracao_id===X.aspiracao_id;return e.jsxs($e,{className:`text-xs ${b?"bg-slate-50/50":""}`,children:[e.jsx(B,{className:"py-2 font-medium",children:V+1}),e.jsx(B,{className:"py-2",children:b?e.jsx("div",{className:"text-slate-400 italic text-[10px]",children:"‚Ü≥"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"font-medium",children:((ie=o.doadora)==null?void 0:ie.registro)||"-"}),((re=o.doadora)==null?void 0:re.nome)&&e.jsx("div",{className:"text-slate-500 text-[11px]",children:o.doadora.nome})]})}),e.jsx(B,{className:"py-2",children:b?e.jsx("div",{className:"text-slate-400 italic text-[10px]",children:"‚Ü≥"}):e.jsxs(e.Fragment,{children:[((ue=o.aspiracao)==null?void 0:ue.data_aspiracao)&&e.jsx("div",{children:Me(o.aspiracao.data_aspiracao)}),((ne=o.aspiracao)==null?void 0:ne.horario_aspiracao)&&e.jsx("div",{className:"text-slate-500 text-[11px]",children:o.aspiracao.horario_aspiracao})]})}),e.jsx(B,{className:"py-2",children:b?e.jsx("div",{className:"text-slate-400 italic text-[10px]",children:"‚Ü≥ (mesma aspira√ß√£o)"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"font-medium",children:((N=o.aspiracao)==null?void 0:N.total_oocitos)??"-"}),o.aspiracao&&e.jsxs("div",{className:"text-[10px] text-slate-500 space-x-1",children:[o.aspiracao.expandidos!==void 0&&e.jsxs("span",{children:["Exp:",o.aspiracao.expandidos]}),o.aspiracao.atresicos!==void 0&&e.jsxs("span",{children:["At:",o.aspiracao.atresicos]}),o.aspiracao.degenerados!==void 0&&e.jsxs("span",{children:["Deg:",o.aspiracao.degenerados]}),o.aspiracao.desnudos!==void 0&&e.jsxs("span",{children:["Des:",o.aspiracao.desnudos]})]})]})}),e.jsx(B,{className:"py-2",children:b?e.jsx("div",{className:"text-slate-400 italic text-[10px]",children:"‚Ü≥"}):e.jsx("span",{className:"font-medium text-green-700",children:((ee=o.aspiracao)==null?void 0:ee.viaveis)??"-"})}),e.jsxs(B,{className:"py-2",children:[e.jsx("div",{className:"font-medium",children:((fe=o.dose_semen)==null?void 0:fe.nome)||"-"}),e.jsxs("div",{className:"text-[10px] text-slate-500 space-x-1",children:[((_e=o.dose_semen)==null?void 0:_e.raca)&&e.jsx("span",{children:o.dose_semen.raca}),((ve=o.dose_semen)==null?void 0:ve.tipo_semen)&&e.jsxs("span",{children:["‚Ä¢ ",o.dose_semen.tipo_semen]})]}),((de=o.dose_semen)==null?void 0:de.cliente)&&e.jsx("div",{className:"text-[10px] text-slate-500",children:o.dose_semen.cliente})]}),e.jsx(B,{className:"py-2 text-center",children:e.jsx("span",{className:"font-medium",children:o.quantidade_fracionada})}),e.jsxs(B,{className:"py-2 text-center",children:[e.jsx("span",{className:"font-medium text-blue-700",children:o.quantidade_embrioes??"-"}),o.quantidade_oocitos!==void 0&&e.jsxs("div",{className:"text-[10px] text-slate-500",children:["Usados: ",o.quantidade_oocitos]})]}),e.jsx(B,{className:"py-2 text-center",children:d&&d.total>0?e.jsx("span",{className:"font-semibold",children:d.total}):e.jsx("span",{className:"text-slate-400",children:"-"})}),e.jsx(B,{className:"py-2 text-center",children:y>0?e.jsx("span",{className:"text-green-700 font-medium",children:y}):e.jsx("span",{className:"text-slate-400",children:"-"})}),e.jsx(B,{className:"py-2 text-center",children:W>0?e.jsx("span",{className:"text-blue-700 font-medium",children:W}):e.jsx("span",{className:"text-slate-400",children:"-"})}),e.jsx(B,{className:"py-2 text-center",children:U>0?e.jsx("span",{className:"text-red-700 font-medium",children:U}):e.jsx("span",{className:"text-slate-400",children:"-"})}),e.jsx(B,{className:"py-2 text-center",children:je>0?e.jsx("span",{className:"text-slate-600 font-medium",children:je}):e.jsx("span",{className:"text-slate-400",children:"-"})}),e.jsx(B,{className:"py-2 text-[11px] text-slate-700",children:d&&j!=="-"?e.jsxs("div",{className:"flex flex-wrap gap-1",children:[j.split(", ").map((k,u)=>e.jsx(ke,{variant:"outline",className:"text-[10px] px-1 py-0 border-slate-300",children:k},u)),d.porClassificacao.sem_classificacao&&e.jsxs(ke,{variant:"outline",className:"text-[10px] px-1 py-0 border-slate-300 text-slate-500",children:["Sem class.(",d.porClassificacao.sem_classificacao,")"]})]}):e.jsx("span",{className:"text-slate-400",children:"-"})})]},o.id)})})]})})]}),a.acasalamentos.some(o=>o.observacoes)&&e.jsxs("div",{className:"bg-amber-50 p-2 rounded border border-amber-200 text-xs",children:[e.jsx("div",{className:"font-semibold mb-1 text-amber-900",children:"Observa√ß√µes dos Acasalamentos:"}),a.acasalamentos.filter(o=>o.observacoes).map((o,V)=>{var d;return e.jsxs("div",{className:"mb-1",children:[e.jsxs("span",{className:"font-medium",children:["#",V+1," (",((d=o.doadora)==null?void 0:d.registro)||"N/A","):"]})," ",o.observacoes]},o.id)})]})]}):e.jsx("div",{className:"mt-4 pt-4 border-t border-slate-200 text-center text-slate-500 py-4 text-sm",children:"Erro ao carregar detalhes"})}function Hs(){const{id:a}=Ua(),P=Fa(),{toast:o}=ha(),[V,d]=i.useState(!1),[y,W]=i.useState({}),[U,je]=i.useState({}),j=Ba({lotes:[],pacotesParaFiltro:[],fazendasAspiracaoUnicas:[],lotesHistoricos:[]}),{lotes:X,pacotes:b,fazendas:ie,doadoras:re,clientes:ue,loading:ne,selectedLote:N,setSelectedLote:ee,showLoteDetail:fe,setShowLoteDetail:_e,acasalamentos:ve,fazendasDestinoIds:de,historicoDespachos:k,setHistoricoDespachos:u,aspiracoesDisponiveis:g,dosesDisponiveis:me,fazendaOrigemNome:J,fazendasDestinoNomes:w,dosesDisponiveisNoLote:H,dataAspiracao:ae,pacotesParaFiltro:ze,fazendasAspiracaoUnicas:f,lotesHistoricos:A,loadingHistorico:ce,loteExpandido:Se,detalhesLoteExpandido:Le,loadingDetalhes:Ee,loadLoteDetail:ye,loadLotesHistoricos:Pe,handleExpandirLote:n}=rs({id:a,filtroHistoricoDataInicio:j.filtroHistoricoDataInicio,filtroHistoricoDataFim:j.filtroHistoricoDataFim,filtroHistoricoFazenda:j.filtroHistoricoFazenda,setHistoricoPage:j.setHistoricoPage}),{filtroFazendaAspiracao:q,setFiltroFazendaAspiracao:se,filtroFazendaAspiracaoBusca:Ce,setFiltroFazendaAspiracaoBusca:be,filtroDiaCultivo:Ie,setFiltroDiaCultivo:Re,showFazendaBusca:He,setShowFazendaBusca:Oe,fazendasFiltradas:Te,lotesFiltrados:Ze,limparFiltrosAtivos:ua,filtroHistoricoDataInicio:aa,setFiltroHistoricoDataInicio:fa,filtroHistoricoDataFim:sa,setFiltroHistoricoDataFim:ta,filtroHistoricoFazenda:Xe,setFiltroHistoricoFazenda:_a,filtroHistoricoFazendaBusca:oa,setFiltroHistoricoFazendaBusca:va,showFazendaBuscaHistorico:Ge,setShowFazendaBuscaHistorico:S,abaAtiva:z,setAbaAtiva:G,historicoPage:I,setHistoricoPage:Ne,HISTORICO_PAGE_SIZE:we}=Ba({lotes:X,pacotesParaFiltro:ze,fazendasAspiracaoUnicas:f,lotesHistoricos:A}),E=async()=>{var t,p;if(N)try{d(!0);const v=b.find(x=>x.id===N.pacote_aspiracao_id);let L=Qe((v==null?void 0:v.data_aspiracao)||null);if(!L){const x=Qe(N.data_abertura);if(x){const[R,Z,s]=x.split("-").map(Number),h=new Date(R,Z-1,s);h.setDate(h.getDate()-1);const F=h.getFullYear(),Ae=String(h.getMonth()+1).padStart(2,"0"),M=String(h.getDate()).padStart(2,"0");L=`${F}-${Ae}-${M}`}}const K=za();if((L?Math.max(0,Ca(K,L)):0)>9){o({title:"Prazo expirado",description:"D8 √© o √∫ltimo dia. N√£o √© poss√≠vel criar embri√µes ap√≥s o D8. O lote ser√° fechado e n√£o aparecer√° mais na lista.",variant:"destructive"}),d(!1);return}const D=ve.filter(x=>{var Z;return parseInt(y[x.id]||((Z=x.quantidade_embrioes)==null?void 0:Z.toString())||"0")>0});if(D.length===0){o({title:"Nenhum embri√£o para despachar",description:"Preencha a quantidade de embri√µes em pelo menos um acasalamento antes de despachar.",variant:"destructive"});return}for(const x of D){const R=parseInt(y[x.id]||((t=x.quantidade_embrioes)==null?void 0:t.toString())||"0"),Z=x.quantidade_oocitos??0,s=U[x.id],h=x.embrioes_clivados_d3,F=parseInt(s??(h==null?void 0:h.toString())??"")||0,Ae=F>0?F:Z;if(R>Ae){const M=x.doadora_nome||x.doadora_registro||"Doadora desconhecida",l=F>0?"clivados (D3)":"o√≥citos";o({title:"Valida√ß√£o de quantidade",description:`O acasalamento da doadora "${M}" possui ${R} embri√µes, mas o limite de ${l} √© ${Ae}. A quantidade de embri√µes n√£o pode exceder esse limite.`,variant:"destructive"});return}}const O=`${J} - ${w.join(", ")}`,Q=new Date().toISOString().split("T")[0];if(!de.length){o({title:"Erro ao despachar",description:"√â necess√°rio ter pelo menos uma fazenda destino configurada no lote.",variant:"destructive"});return}let oe="",Y="";if(v!=null&&v.fazenda_id){const{data:x,error:R}=await c.from("fazendas").select("sigla").eq("id",v.fazenda_id).single();if(!R&&(x!=null&&x.sigla)){oe=x.sigla;const Z=L||"",s=Z.slice(8,10)+Z.slice(5,7);Y=`${oe}-${s}`}}let pe=1;if(Y){const{count:x,error:R}=await c.from("embrioes").select("*",{count:"exact",head:!0}).like("identificacao",`${Y}-%`);!R&&x!==null&&(pe=x+1)}const _=[],r=[];let C=0;for(const x of D){const R=parseInt(y[x.id]||((p=x.quantidade_embrioes)==null?void 0:p.toString())||"0");if(R>0){for(let Z=0;Z<R;Z++){const s={lote_fiv_id:N.id,lote_fiv_acasalamento_id:x.id,status_atual:"FRESCO"};if(Y){const h=String(pe+C).padStart(3,"0");s.identificacao=`${Y}-${h}`}_.push(s),C++}r.push({acasalamento_id:x.id,quantidade:R,doadora:x.doadora_registro||x.doadora_nome,dose:x.dose_nome})}}if(_.length>0){const{error:x}=await c.from("embrioes").insert(_);if(x)throw x}const Fe={id:`${N.id}-${Q}`,data_despacho:Q,acasalamentos:r};u([Fe,...k]);const xe=D.map(x=>c.from("lote_fiv_acasalamentos").update({quantidade_embrioes:null}).eq("id",x.id));await Promise.all(xe),W({}),o({title:"Embri√µes despachados",description:`${_.length} embri√£o(√µes) foram despachados para ${O}.`}),ye(N.id)}catch(v){o({title:"Erro ao despachar embri√µes",description:v instanceof Error?v.message:"Erro desconhecido",variant:"destructive"})}finally{d(!1)}},te=async t=>{if(!N)return;const p=parseFloat(t.quantidade_fracionada)||0;try{d(!0);const v=g.find(_=>_.id===t.aspiracao_doadora_id),L=(v==null?void 0:v.oocitos_disponiveis)??0,K=parseInt(t.quantidade_oocitos)||0;if(K>L)throw o({title:"Erro de valida√ß√£o",description:`A quantidade de o√≥citos (${K}) n√£o pode ser maior que os o√≥citos dispon√≠veis (${L})`,variant:"destructive"}),new Error("Valida√ß√£o falhou");const{data:m,error:D}=await c.from("doses_semen").select("id, quantidade").eq("id",t.dose_semen_id).single();if(D)throw D;const O=(m==null?void 0:m.quantidade)??0;if(O<p)throw o({title:"Estoque insuficiente",description:`Quantidade dispon√≠vel (${O}) √© menor que a quantidade fracionada (${p}).`,variant:"destructive"}),new Error("Estoque insuficiente");const Q={lote_fiv_id:N.id,aspiracao_doadora_id:t.aspiracao_doadora_id,dose_semen_id:t.dose_semen_id,quantidade_fracionada:p,quantidade_oocitos:K>0?K:null,observacoes:t.observacoes||null},{error:oe}=await c.from("lote_fiv_acasalamentos").insert([Q]);if(oe)throw oe;const Y=O-p,{error:pe}=await c.from("doses_semen").update({quantidade:Y}).eq("id",(m==null?void 0:m.id)||"");if(pe)throw pe;o({title:"Acasalamento adicionado",description:"Acasalamento adicionado com sucesso"}),await ye(N.id)}catch(v){const L=v instanceof Error?v.message:"Erro desconhecido";throw!L.includes("Valida√ß√£o")&&!L.includes("Estoque")&&o({title:"Erro ao adicionar acasalamento",description:L.includes("RLS")||L.includes("policy")?"RLS est√° bloqueando escrita. Configure pol√≠ticas anon no Supabase.":L,variant:"destructive"}),v}finally{d(!1)}};return ne&&!N?e.jsx(qa,{}):N&&fe?e.jsx(ds,{lote:N,acasalamentos:ve,aspiracoesDisponiveis:g,dosesDisponiveis:me,dosesDisponiveisNoLote:H,doadoras:re,clientes:ue,historicoDespachos:k,dataAspiracao:ae,fazendaOrigemNome:J,fazendasDestinoNomes:w,submitting:V,onBack:()=>{_e(!1),ee(null)},onAddAcasalamento:te,onDespacharEmbrioes:E,onUpdateQuantidadeEmbrioes:(t,p)=>{W({...y,[t]:p})},editQuantidadeEmbrioes:y,onUpdateClivados:async(t,p)=>{je({...U,[t]:p});const v=parseInt(p)||null;await c.from("lote_fiv_acasalamentos").update({embrioes_clivados_d3:v}).eq("id",t)},editClivados:U}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(Xa,{title:"Lotes FIV",description:"Gerenciar lotes de fecunda√ß√£o in vitro",actions:e.jsx(ns,{pacotes:b,clientes:ue,fazendas:ie})}),e.jsxs(Je,{children:[e.jsx(Ke,{children:e.jsx(We,{children:"Lista de Lotes FIV"})}),e.jsx(ea,{children:e.jsxs(Ga,{value:z,onValueChange:t=>G(t),children:[e.jsxs(Ya,{className:"mb-6",children:[e.jsx(La,{value:"ativos",children:"Lotes Ativos"}),e.jsx(La,{value:"historico",children:"Hist√≥rico"})]}),e.jsxs(Ia,{value:"ativos",className:"mt-0",children:[e.jsxs("div",{className:"flex gap-4 mb-6 flex-wrap",children:[e.jsxs("div",{className:"flex-1 min-w-[250px] relative fazenda-busca-container",children:[e.jsx(he,{htmlFor:"filtro-fazenda-aspira√ß√£o",children:"Filtrar por Fazenda da Aspira√ß√£o"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ue,{id:"filtro-fazenda-aspira√ß√£o",placeholder:"Digite para buscar fazenda...",value:Ce,onChange:t=>{be(t.target.value),Oe(!0),t.target.value||se("")},onFocus:()=>Oe(!0)}),q&&e.jsx(le,{variant:"ghost",size:"sm",className:"absolute right-1 top-1 h-7 w-7 p-0",onClick:()=>{se(""),be(""),Oe(!1)},children:e.jsx(ka,{className:"h-4 w-4"})}),He&&Te.length>0&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-white border rounded-md shadow-lg max-h-60 overflow-auto",children:Te.map(t=>e.jsx("div",{className:"px-4 py-2 hover:bg-slate-100 cursor-pointer",onClick:()=>{se(t.id),be(t.nome),Oe(!1)},children:t.nome},t.id))}),He&&Ce&&Te.length===0&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-white border rounded-md shadow-lg p-4 text-sm text-slate-500",children:"Nenhuma fazenda encontrada"})]})]}),e.jsxs("div",{className:"flex-1 min-w-[200px]",children:[e.jsx(he,{htmlFor:"filtro-dia-cultivo",children:"Filtrar por Dia do Cultivo"}),e.jsxs(ca,{value:Ie||void 0,onValueChange:t=>Re(t||""),children:[e.jsx(la,{id:"filtro-dia-cultivo",children:e.jsx(ma,{placeholder:"Todos os dias"})}),e.jsx(pa,{children:[0,1,2,3,4,5,6,7,8].map(t=>e.jsxs(xa,{value:t.toString(),children:["D",t," - ",ba(t)]},t))})]})]}),(q||Ie)&&e.jsx("div",{className:"flex items-end",children:e.jsx(le,{variant:"outline",onClick:ua,children:"Limpar Filtros"})})]}),Ze.length===0?e.jsx(Ma,{title:X.length===0?"Nenhum lote cadastrado":"Nenhum lote encontrado",description:X.length===0?"Crie um novo lote para come√ßar.":"Ajuste os filtros para encontrar outros lotes."}):e.jsxs(ra,{children:[e.jsx(na,{children:e.jsxs($e,{children:[e.jsx(T,{children:"Aspira√ß√£o"}),e.jsx(T,{children:"Fazendas Destino"}),e.jsx(T,{children:"Dia do Cultivo"}),e.jsx(T,{children:"Acasalamentos"}),e.jsx(T,{className:"text-right",children:"A√ß√µes"})]})}),e.jsx(da,{children:Ze.map(t=>e.jsxs($e,{children:[e.jsxs(B,{children:[t.pacote_data&&Me(t.pacote_data)," - ",t.pacote_nome]}),e.jsx(B,{children:e.jsx("div",{className:"flex flex-wrap gap-1",children:t.fazendas_destino_nomes&&t.fazendas_destino_nomes.length>0?t.fazendas_destino_nomes.map((p,v)=>e.jsx(ke,{variant:"outline",className:"text-xs",children:p},v)):e.jsx("span",{className:"text-slate-400",children:"-"})})}),e.jsx(B,{children:t.dia_atual!==void 0?e.jsx(ke,{variant:"outline",className:`font-semibold ${ss(t.dia_atual===0?-1:t.dia_atual>9?8:t.dia_atual-1)}`,children:(()=>{const p=t.dia_atual===0?-1:t.dia_atual>9?8:t.dia_atual-1;return p===-1?`D-1 - ${ba(p)}`:`D${p} - ${ba(p)}`})()}):e.jsx("span",{className:"text-slate-400",children:"-"})}),e.jsx(B,{children:t.quantidade_acasalamentos??0}),e.jsx(B,{className:"text-right",children:e.jsx(le,{variant:"ghost",size:"sm",onClick:()=>P(`/lotes-fiv/${t.id}`),children:e.jsx(as,{className:"w-4 h-4"})})})]},t.id))})]})]}),e.jsx(Ia,{value:"historico",className:"mt-0",children:e.jsx(cs,{lotesHistoricos:A,fazendas:ie,detalhesLoteExpandido:Le,loteExpandido:Se,loadingHistorico:ce,loadingDetalhes:Ee,filtroHistoricoDataInicio:aa,setFiltroHistoricoDataInicio:fa,filtroHistoricoDataFim:sa,setFiltroHistoricoDataFim:ta,filtroHistoricoFazenda:Xe,setFiltroHistoricoFazenda:_a,filtroHistoricoFazendaBusca:oa,setFiltroHistoricoFazendaBusca:va,showFazendaBuscaHistorico:Ge,setShowFazendaBuscaHistorico:S,historicoPage:I,setHistoricoPage:Ne,HISTORICO_PAGE_SIZE:we,onLoadHistorico:Pe,onExpandirLote:n})})]})})]})]})}export{Hs as default};
