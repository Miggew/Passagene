import{a as O,a7 as H,r as d,s as S,j as e,i as K,B as N}from"./index-BPMeM9-O.js";import{C as A,d as R,a as Q,b as U,c as Z}from"./card-8azKTSNJ.js";import{B as J}from"./badge-CeJDYfYs.js";import{I as W}from"./input-tqcTRdPv.js";import{E as X}from"./EmptyState-yqSFIU3C.js";import{C,g as Y,D as ee}from"./index-BkgnAyi6.js";import{R as ae}from"./ResultBadge-D1BY0IWw.js";import{u as te}from"./use-toast-BGNwDi9e.js";import{A as se}from"./arrow-left-CjWJp082.js";import{S as re}from"./search-SyV5imYB.js";function fe(){const D=O(),[b]=H(),{toast:P}=te(),f=b.get("fazenda")||"",g=b.get("data_te")||"",h=b.get("data_dg")||"",v=b.get("vet")||"",[B,k]=d.useState(!0),[x,M]=d.useState(null),[y,T]=d.useState([]),[w,I]=d.useState(""),[n,z]=d.useState(1),_=20;d.useEffect(()=>{if(!f||!g||!h){P({title:"Parâmetros inválidos",description:"Faltam parâmetros para identificar a sessão",variant:"destructive"}),D("/dg");return}q()},[f,g,h,v]);const q=async()=>{try{k(!0);let a=S.from("diagnosticos_gestacao").select("*").eq("tipo_diagnostico","DG").eq("data_te",g).eq("data_diagnostico",h);v&&(a=a.eq("veterinario_responsavel",v));const{data:t,error:r}=await a;if(r)throw r;if(!t||t.length===0){T([]),M({fazenda_nome:f,data_te:g,data_diagnostico:h,veterinario_responsavel:v||void 0}),k(!1);return}const m=[...new Set(t.map(s=>s.receptora_id))],{data:E,error:c}=await S.from("receptoras").select("id, identificacao, nome, data_provavel_parto").in("id",m);if(c)throw c;const F=new Map((E||[]).map(s=>[s.id,s])),{data:G}=await S.from("vw_receptoras_fazenda_atual").select("receptora_id, fazenda_nome_atual").in("receptora_id",m),V=new Map((G||[]).map(s=>[s.receptora_id,s.fazenda_nome_atual])),$=t.filter(s=>V.get(s.receptora_id)===f).map(s=>{const o=F.get(s.receptora_id);return{id:s.id,receptora_id:s.receptora_id,receptora_brinco:(o==null?void 0:o.identificacao)||"-",receptora_nome:o==null?void 0:o.nome,data_te:s.data_te,data_diagnostico:s.data_diagnostico,resultado:s.resultado,numero_gestacoes:s.numero_gestacoes,observacoes:s.observacoes,data_provavel_parto:(o==null?void 0:o.data_provavel_parto)||void 0}}).sort((s,o)=>s.receptora_brinco.localeCompare(o.receptora_brinco));T($);const u=t[0];M({fazenda_nome:f,data_te:g,data_diagnostico:h,veterinario_responsavel:(u==null?void 0:u.veterinario_responsavel)||v||void 0,tecnico_responsavel:u==null?void 0:u.tecnico_responsavel})}catch(a){console.error("Erro ao carregar sessão:",a),P({title:"Erro ao carregar dados",description:a instanceof Error?a.message:"Erro desconhecido",variant:"destructive"})}finally{k(!1)}},i=d.useMemo(()=>{if(!w.trim())return y;const a=w.toLowerCase();return y.filter(t=>{var r;return t.receptora_brinco.toLowerCase().includes(a)||((r=t.receptora_nome)==null?void 0:r.toLowerCase().includes(a))})},[y,w]),l=Math.ceil(i.length/_),L=i.slice((n-1)*_,n*_),p=d.useMemo(()=>{const a=i.length,t=i.filter(c=>c.resultado==="PRENHE").length,r=i.filter(c=>c.resultado==="VAZIA").length,m=i.filter(c=>c.resultado==="RETOQUE").length,E=a>0?Math.round((t+m)/a*100):0;return{total:a,prenhes:t,vazias:r,retoques:m,taxa:E}},[i]),j=a=>{if(!a)return"-";const[t,r,m]=a.split("-");return`${m}/${r}/${t}`};return B?e.jsx(K,{}):x?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>D(-1),children:e.jsx(se,{className:"w-4 h-4"})}),e.jsx("h1",{className:"text-xl font-semibold text-foreground",children:"Sessão de Diagnóstico"})]}),e.jsx(A,{children:e.jsxs(R,{className:"pt-4 pb-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-xs font-medium text-muted-foreground",children:"Fazenda"}),e.jsx("p",{className:"text-base font-semibold text-foreground",children:x.fazenda_nome})]}),e.jsx("div",{className:"h-8 w-px bg-border"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xs font-medium text-muted-foreground",children:"Data TE"}),e.jsx("p",{className:"text-sm text-foreground",children:j(x.data_te)})]}),e.jsx("div",{className:"h-8 w-px bg-border"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xs font-medium text-muted-foreground",children:"Data DG"}),e.jsx("p",{className:"text-sm text-foreground",children:j(x.data_diagnostico)})]}),e.jsx("div",{className:"h-8 w-px bg-border"}),e.jsx(J,{variant:"default",className:"bg-primary hover:bg-primary-dark",children:"Realizado"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Total:"}),e.jsx(C,{value:p.total,variant:"default"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Prenhes:"}),e.jsx(C,{value:p.prenhes+p.retoques,variant:"success"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Vazias:"}),e.jsx(C,{value:p.vazias,variant:"danger"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Taxa:"}),e.jsx(C,{value:p.taxa,suffix:"%",variant:Y(p.taxa)})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4 pt-3 border-t border-border",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h4",{className:"text-[10px] font-semibold text-muted-foreground uppercase tracking-wide",children:"Veterinário"}),e.jsx("p",{className:"text-xs text-foreground",children:x.veterinario_responsavel||"—"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("h4",{className:"text-[10px] font-semibold text-muted-foreground uppercase tracking-wide",children:"Técnico"}),e.jsx("p",{className:"text-xs text-foreground",children:x.tecnico_responsavel||"—"})]})]})]})}),e.jsxs(A,{children:[e.jsx(Q,{className:"pb-2 pt-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(U,{className:"text-base",children:["Receptoras (",i.length,")"]}),e.jsx(Z,{children:"Lista de todas as receptoras diagnosticadas na sessão"})]}),e.jsxs("div",{className:"relative w-64",children:[e.jsx(re,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(W,{placeholder:"Buscar brinco ou nome...",value:w,onChange:a=>{I(a.target.value),z(1)},className:"pl-9 h-9"})]})]})}),e.jsx(R,{className:"pt-0 pb-2",children:i.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:y.length===0?"Nenhuma receptora encontrada nesta sessão":"Nenhuma receptora corresponde à busca"}):e.jsxs(e.Fragment,{children:[e.jsx(ee,{data:L,rowKey:"id",rowNumber:!0,emptyMessage:"Nenhuma receptora encontrada",columns:[{key:"receptora_brinco",label:"Receptora"},{key:"data_te",label:"Data TE",align:"center"},{key:"data_diagnostico",label:"Data DG",align:"center"},{key:"data_provavel_parto",label:"Data Parto",align:"center"},{key:"resultado",label:"Resultado",align:"center"},{key:"numero_gestacoes",label:"Nº Gest.",align:"center"},{key:"observacoes",label:"Observações"}],renderCell:(a,t)=>{switch(t.key){case"receptora_brinco":return e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-sm text-foreground",children:a.receptora_brinco}),a.receptora_nome&&e.jsx("span",{className:"text-[10px] text-muted-foreground block",children:a.receptora_nome})]});case"data_te":return e.jsx("span",{className:"text-muted-foreground",children:j(a.data_te)});case"data_diagnostico":return e.jsx("span",{className:"text-foreground",children:j(a.data_diagnostico)});case"data_provavel_parto":return e.jsx("span",{className:"text-muted-foreground",children:a.data_provavel_parto?j(a.data_provavel_parto):"—"});case"resultado":return e.jsx(ae,{result:a.resultado});case"numero_gestacoes":return e.jsx("span",{className:"text-muted-foreground",children:a.numero_gestacoes||"—"});case"observacoes":return e.jsx("span",{className:"text-muted-foreground truncate",children:a.observacoes||"—"});default:return null}}}),l>1&&e.jsxs("div",{className:"flex items-center justify-between mt-4 pt-4 border-t border-border",children:[e.jsxs("span",{className:"text-sm text-muted-foreground",children:["Mostrando ",(n-1)*_+1," a ",Math.min(n*_,i.length)," de ",i.length]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{variant:"outline",size:"sm",onClick:()=>z(a=>Math.max(1,a-1)),disabled:n===1,children:"Anterior"}),e.jsx("div",{className:"flex items-center gap-1",children:Array.from({length:Math.min(5,l)},(a,t)=>{let r;return l<=5||n<=3?r=t+1:n>=l-2?r=l-4+t:r=n-2+t,e.jsx(N,{variant:n===r?"default":"outline",size:"sm",className:`w-9 h-9 p-0 ${n===r?"bg-primary hover:bg-primary-dark":""}`,onClick:()=>z(r),children:r},r)})}),e.jsx(N,{variant:"outline",size:"sm",onClick:()=>z(a=>Math.min(l,a+1)),disabled:n===l,children:"Próximo"})]})]})]})})]})]}):e.jsx(X,{title:"Sessão não encontrada",description:"Não foi possível carregar os dados da sessão.",action:e.jsx(N,{onClick:()=>D("/dg"),variant:"outline",children:"Voltar para DG"})})}export{fe as default};
