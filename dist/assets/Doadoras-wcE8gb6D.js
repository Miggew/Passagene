import{c as H,r,s as S,j as a,a as R,g as aa,f as ga,B as _}from"./index-DmNymSE5.js";import{C as V,a as Z,b as J,d as Q}from"./card-SrkIpKk5.js";import{T as ea,a as sa,b,c as n,d as ra,e as i}from"./table-BEqiB4gi.js";import{D as ta,b as ia,c as oa,d as la,e as ca,a as va}from"./dialog-j4QKUGZf.js";import{S as K,a as U,b as W,c as X,d as k}from"./select-yD1hylSL.js";import{I as F}from"./input-CUsCheD8.js";import{L as Y}from"./label-u6KawL_e.js";import{P as ya}from"./PageHeader-C6hPTib0.js";import{E as Na}from"./EmptyState-8CewmVht.js";import{u as na}from"./use-toast-8Wh80yTN.js";import{B as wa}from"./badge-BB9l9AxT.js";import{S as Ca}from"./search-52vUzEUy.js";import{P as _a}from"./plus-BZvL1qCK.js";import{H as Sa}from"./history-Ijd8nAqu.js";import"./index-BMCBZPUE.js";import"./index-C79PyqkA.js";import"./x-BKw_NAIH.js";import"./index-BoubMqWY.js";import"./index-BMurdLVa.js";import"./check-D6LfuFSM.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ba=H("Gem",[["path",{d:"M6 3h12l4 6-10 13L2 9Z",key:"1pcd5k"}],["path",{d:"M11 3 8 9l4 13 4-13-3-6",key:"1fcu3u"}],["path",{d:"M2 9h20",key:"16fsjt"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Da=H("Pencil",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const N=H("Star",[["path",{d:"M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z",key:"r04s7s"}]]);function Ea({doadoraId:x,doadoraNome:g,open:v,onClose:y}){const[u,p]=r.useState([]),[D,w]=r.useState(!1),{toast:L}=na();r.useEffect(()=>{v&&x&&m()},[v,x]);const m=async()=>{try{w(!0);const{data:o,error:h}=await S.from("aspiracoes_doadoras").select("*").eq("doadora_id",x).order("data_aspiracao",{ascending:!1});if(h)throw h;p(o||[])}catch(o){L({title:"Erro ao carregar histórico",description:o instanceof Error?o.message:"Erro desconhecido",variant:"destructive"})}finally{w(!1)}};return a.jsx(ta,{open:v,onOpenChange:y,children:a.jsxs(ia,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[a.jsxs(oa,{children:[a.jsx(la,{children:"Histórico de Aspirações"}),a.jsx(ca,{children:g?`Aspirações da doadora: ${g}`:"Histórico completo de aspirações"})]}),D?a.jsx("div",{className:"py-8",children:a.jsx(R,{})}):a.jsx("div",{className:"mt-4",children:u.length===0?a.jsx("p",{className:"text-center text-slate-500 py-8",children:"Nenhuma aspiração registrada para esta doadora"}):a.jsxs(ea,{children:[a.jsx(sa,{children:a.jsxs(b,{children:[a.jsx(n,{children:"Data"}),a.jsx(n,{children:"Quantidade de Oócitos"}),a.jsx(n,{children:"Veterinário"}),a.jsx(n,{children:"Técnico"})]})}),a.jsx(ra,{children:u.map(o=>a.jsxs(b,{children:[a.jsx(i,{children:aa(o.data_aspiracao)}),a.jsx(i,{className:"font-medium",children:o.total_oocitos??"-"}),a.jsx(i,{children:o.veterinario_responsavel||"-"}),a.jsx(i,{children:o.tecnico_responsavel||"-"})]},o.id))})]})})]})})}function Ka(){var q,M;const x=ga(),[g,v]=r.useState([]),[y,u]=r.useState([]),[p,D]=r.useState(null),[w,L]=r.useState([]),[m,o]=r.useState(""),[h,da]=r.useState(""),[P,E]=r.useState(!0),[ma,A]=r.useState(!1),[T,O]=r.useState(!1),{toast:f}=na(),[l,C]=r.useState({registro:"",raca:"",racaCustom:""}),ha=["Holandesa","Jersey","Gir","Girolando"],[z,B]=r.useState("");r.useEffect(()=>{ua()},[]),r.useEffect(()=>{m?G():(v([]),u([]))},[m]),r.useEffect(()=>{xa()},[h,g]);const xa=()=>{if(!h.trim()){u(g);return}const e=h.toLowerCase(),s=g.filter(t=>{var c,d,j;return((c=t.nome)==null?void 0:c.toLowerCase().includes(e))||((d=t.registro)==null?void 0:d.toLowerCase().includes(e))||((j=t.raca)==null?void 0:j.toLowerCase().includes(e))});u(s)},ua=async()=>{try{E(!0);const{data:e,error:s}=await S.from("fazendas").select("id, nome").order("nome",{ascending:!0});if(s)throw s;L(e||[])}catch(e){f({title:"Erro ao carregar fazendas",description:e instanceof Error?e.message:"Erro desconhecido",variant:"destructive"})}finally{E(!1)}},G=async()=>{try{E(!0);const{data:e,error:s}=await S.from("doadoras").select("*").eq("fazenda_id",m).order("created_at",{ascending:!1});if(s)throw s;const t=await Promise.all((e||[]).map(async c=>{const{data:d,error:j}=await S.from("aspiracoes_doadoras").select("total_oocitos, data_aspiracao").eq("doadora_id",c.id).order("data_aspiracao",{ascending:!1}).limit(1).maybeSingle();return j||!d?{...c,ultima_aspiracao_total_oocitos:void 0,ultima_aspiracao_data:void 0}:{...c,ultima_aspiracao_total_oocitos:d.total_oocitos,ultima_aspiracao_data:d.data_aspiracao}}));v(t),u(t)}catch(e){f({title:"Erro ao carregar doadoras",description:e instanceof Error?e.message:"Erro desconhecido",variant:"destructive"})}finally{E(!1)}},pa=e=>{if(!e)return"-";switch(e){case"1_estrela":return a.jsx("div",{className:"flex items-center gap-1",children:a.jsx(N,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"})});case"2_estrelas":return a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(N,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"}),a.jsx(N,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"})]});case"3_estrelas":return a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(N,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"}),a.jsx(N,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"}),a.jsx(N,{className:"w-4 h-4 fill-yellow-400 text-yellow-400"})]});case"diamante":return a.jsx("div",{className:"flex items-center gap-1",children:a.jsx(ba,{className:"w-4 h-4 fill-blue-500 text-blue-500"})});default:return"-"}},fa=e=>{if(e.raca==="Gir"){const s=[];return e.gpta&&s.push(`GPTA: ${e.gpta}`),e.controle_leiteiro&&s.push(`Controle Leiteiro: ${e.controle_leiteiro}`),e.beta_caseina&&s.push(`Beta Caseína: ${e.beta_caseina}`),e.link_abcz&&s.push("Link ABCZ"),s.length>0?s.join(", "):null}return null},I=()=>{C({registro:"",raca:"",racaCustom:""}),B("")},ja=async e=>{if(e.preventDefault(),!m){f({title:"Erro de validação",description:"Selecione a fazenda primeiro",variant:"destructive"});return}if(!l.registro.trim()){f({title:"Erro de validação",description:"Registro é obrigatório",variant:"destructive"});return}if(!(z==="Outra"?l.racaCustom.trim():l.raca.trim())){f({title:"Erro de validação",description:"Raça é obrigatória",variant:"destructive"});return}try{O(!0);const t=z==="Outra"?l.racaCustom.trim():l.raca.trim(),c={fazenda_id:m,registro:l.registro.trim(),raca:t},{data:d,error:j}=await S.from("doadoras").insert([c]).select().single();if(j)throw j;f({title:"Doadora criada",description:"Doadora criada com sucesso"}),A(!1),I(),G(),d!=null&&d.id&&x(`/doadoras/${d.id}`)}catch(t){const c=t instanceof Error?t.message:"Erro desconhecido";f({title:"Erro ao criar doadora",description:c.includes("RLS")||c.includes("policy")?"RLS está bloqueando escrita. Configure políticas anon no Supabase.":c,variant:"destructive"})}finally{O(!1)}},$=e=>{A(e),e||I()};return P&&w.length===0?a.jsx(R,{}):a.jsxs("div",{className:"space-y-6",children:[a.jsx(ya,{title:"Doadoras",description:"Gerenciar doadoras do sistema"}),a.jsxs(V,{children:[a.jsx(Z,{children:a.jsx(J,{children:"Selecione a Fazenda"})}),a.jsx(Q,{children:a.jsxs(K,{value:m,onValueChange:o,children:[a.jsx(U,{className:"w-full",children:a.jsx(W,{placeholder:"Selecione uma fazenda para visualizar doadoras"})}),a.jsx(X,{children:w.map(e=>a.jsx(k,{value:e.id,children:e.nome},e.id))})]})})]}),m?a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("div",{className:"flex items-center gap-4 flex-1",children:a.jsxs("div",{className:"relative flex-1 max-w-md",children:[a.jsx(Ca,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4"}),a.jsx(F,{placeholder:"Buscar por nome ou registro...",value:h,onChange:e=>da(e.target.value),className:"pl-10"})]})}),a.jsxs(ta,{open:ma,onOpenChange:$,children:[a.jsx(va,{asChild:!0,children:a.jsxs(_,{className:"bg-green-600 hover:bg-green-700",children:[a.jsx(_a,{className:"w-4 h-4 mr-2"}),"Nova Doadora"]})}),a.jsxs(ia,{className:"max-w-md",children:[a.jsxs(oa,{children:[a.jsx(la,{children:"Criar Nova Doadora"}),a.jsx(ca,{children:"Preencha os campos básicos. As informações detalhadas podem ser preenchidas após a criação."})]}),a.jsxs("form",{onSubmit:ja,className:"space-y-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(Y,{htmlFor:"registro",children:"Registro *"}),a.jsx(F,{id:"registro",value:l.registro,onChange:e=>C({...l,registro:e.target.value}),placeholder:"Registro da doadora",required:!0})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(Y,{htmlFor:"raca",children:"Raça *"}),a.jsxs(K,{value:z,onValueChange:e=>{B(e),C(e==="Outra"?{...l,raca:"",racaCustom:""}:{...l,raca:e,racaCustom:""})},children:[a.jsx(U,{children:a.jsx(W,{placeholder:"Selecione a raça"})}),a.jsxs(X,{children:[ha.map(e=>a.jsx(k,{value:e,children:e},e)),a.jsx(k,{value:"Outra",children:"Outra"})]})]}),z==="Outra"&&a.jsx(F,{id:"raca_custom",value:l.racaCustom,onChange:e=>C({...l,racaCustom:e.target.value,raca:e.target.value}),placeholder:"Digite a raça",className:"mt-2",required:!0})]}),a.jsxs("div",{className:"flex gap-2 pt-2",children:[a.jsx(_,{type:"submit",className:"flex-1 bg-green-600 hover:bg-green-700",disabled:T,children:T?"Salvando...":"Criar Doadora"}),a.jsx(_,{type:"button",variant:"outline",onClick:()=>$(!1),disabled:T,children:"Cancelar"})]})]})]})]})]}),a.jsxs(V,{children:[a.jsx(Z,{children:a.jsx(J,{children:"Lista de Doadoras"})}),a.jsx(Q,{children:P?a.jsx("div",{className:"py-8",children:a.jsx(R,{})}):a.jsx("div",{className:"overflow-x-auto",children:a.jsxs(ea,{children:[a.jsx(sa,{children:a.jsxs(b,{children:[a.jsx(n,{children:"Registro"}),a.jsx(n,{children:"Nome"}),a.jsx(n,{children:"Última Aspiração"}),a.jsx(n,{children:"Oócitos"}),a.jsx(n,{children:"Estado"}),a.jsx(n,{children:"Raça (Campos Especiais)"}),a.jsx(n,{children:"Classificação"}),a.jsx(n,{className:"text-right",children:"Ações"})]})}),a.jsx(ra,{children:y.length===0?a.jsx(b,{children:a.jsx(i,{colSpan:8,className:"text-center text-slate-500",children:h?"Nenhuma doadora encontrada":"Nenhuma doadora cadastrada nesta fazenda"})}):y.map(e=>{const s=fa(e);return a.jsxs(b,{className:"cursor-pointer hover:bg-slate-50",onClick:()=>x(`/doadoras/${e.id}`),children:[a.jsx(i,{className:"font-medium",children:e.registro}),a.jsx(i,{children:e.nome||"-"}),a.jsx(i,{children:e.ultima_aspiracao_data?aa(e.ultima_aspiracao_data):"-"}),a.jsx(i,{children:e.ultima_aspiracao_total_oocitos??"-"}),a.jsx(i,{children:a.jsx(wa,{variant:e.disponivel_aspiracao?"default":"secondary",children:e.disponivel_aspiracao?"Disponível":"Indisponível"})}),a.jsx(i,{children:a.jsxs("div",{className:"flex flex-col gap-1",children:[a.jsx("span",{children:e.raca||"-"}),s&&a.jsx("span",{className:"text-xs text-slate-500",children:s})]})}),a.jsx(i,{children:pa(e.classificacao_genetica)}),a.jsx(i,{className:"text-right",children:a.jsxs("div",{className:"flex items-center justify-end gap-2",children:[a.jsx(_,{variant:"ghost",size:"sm",onClick:t=>{t.stopPropagation(),D(e.id)},title:"Ver histórico de aspirações",children:a.jsx(Sa,{className:"w-4 h-4"})}),a.jsx(_,{variant:"ghost",size:"sm",onClick:t=>{t.stopPropagation(),x(`/doadoras/${e.id}`)},title:"Editar doadora",children:a.jsx(Da,{className:"w-4 h-4"})})]})})]},e.id)})})]})})})]}),p&&a.jsx(Ea,{doadoraId:p,doadoraNome:((q=y.find(e=>e.id===p))==null?void 0:q.nome)||((M=y.find(e=>e.id===p))==null?void 0:M.registro),open:!!p,onClose:()=>D(null)})]}):a.jsx(Na,{title:"Selecione uma fazenda",description:"Escolha uma fazenda para visualizar e gerenciar doadoras."})]})}export{Ka as default};
