import{c as re,i as oe,a as ie,r as v,s as h,j as e,h as ne,B as E}from"./index-TMaXuGT-.js";import{C as l,a as m,b as x,d as u}from"./card-DMaHdbj2.js";import{T as ce,a as de,b as V,c as b,d as le,e as z}from"./table-BcP2BpwR.js";import{B as N}from"./badge-CUxYsHH9.js";import{f as F}from"./dateUtils-eJ5e6apA.js";import{u as me}from"./use-toast-BfiUt0Jw.js";import{C as xe,Q as ue}from"./QualidadeSemaforo-DkL0c3kE.js";import{A as pe}from"./arrow-left-BZEOW66l.js";import"./popover-C4Z9du6z.js";import"./index-CbBZSCMq.js";import"./check-BrBvYO5V.js";import"./x-_4GU21wu.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=re("Printer",[["path",{d:"M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2",key:"143wyd"}],["path",{d:"M6 9V3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v6",key:"1itne7"}],["rect",{x:"6",y:"14",width:"12",height:"8",rx:"1",key:"1ue0tg"}]]);function Ce(){const{id:w}=oe(),q=ie(),{toast:Q}=me(),[Z,O]=v.useState(!0),[i,G]=v.useState(null),[J,K]=v.useState(""),[B,U]=v.useState([]),[d,k]=v.useState(null),[_,W]=v.useState({totalIniciaram:0,totalConcluiram:0,totalDescartadas:0,totalConfirmadas:0}),X=async a=>{try{const{data:r}=await h.from("protocolo_receptoras").select("receptora_id").eq("protocolo_id",a.id).limit(1);if(!r||r.length===0)return a.observacoes||"";const n=r[0].receptora_id,{data:t}=await h.from("receptora_fazenda_historico").select(`
          fazenda_id,
          data_inicio
        `).eq("receptora_id",n).order("data_inicio",{ascending:!0});if(!t||t.length<2)return a.observacoes||"";const c=new Set;for(const s of t)s.fazenda_id&&c.add(s.fazenda_id);const{data:f}=await h.from("fazendas").select("id, nome").in("id",Array.from(c)),p=new Map;if(f)for(const s of f)p.set(s.id,s.nome);const H=a.data_inicio.split("T")[0],[o,T,y]=H.split("-").map(Number),C=new Date(o,T-1,y);let j=null,L=1/0;for(let s=1;s<t.length;s++){const g=t[s],M=t[s-1],A=g.data_inicio.split("T")[0],[P,R,I]=A.split("-").map(Number),D=new Date(P,R-1,I),S=Math.abs((D.getTime()-C.getTime())/(1e3*60*60*24));S<=1&&S<L&&(L=S,j={fazendaOrigem:p.get(M.fazenda_id)||"Fazenda desconhecida",fazendaDestino:p.get(g.fazenda_id)||"Fazenda desconhecida",dataMudanca:g.data_inicio})}if(!j&&t.length>1)for(let s=t.length-1;s>=1;s--){const g=t[s],M=t[s-1],A=g.data_inicio.split("T")[0],[P,R,I]=A.split("-").map(Number),D=new Date(P,R-1,I);if(D<=C&&(C.getTime()-D.getTime())/(1e3*60*60*24)<=2){j={fazendaOrigem:p.get(M.fazenda_id)||"Fazenda desconhecida",fazendaDestino:p.get(g.fazenda_id)||"Fazenda desconhecida",dataMudanca:g.data_inicio};break}}if(j){const s=new Date(j.dataMudanca).toLocaleDateString("pt-BR");return`${a.observacoes} (Mudança: ${j.fazendaOrigem} → ${j.fazendaDestino} em ${s})`}return a.observacoes||""}catch{return a.observacoes||""}};v.useEffect(()=>{w&&Y()},[w]);const Y=async()=>{try{O(!0);const{data:a,error:r}=await h.from("protocolos_sincronizacao").select("*").eq("id",w).single();if(r)throw r;let n=a.observacoes;a.observacoes&&a.observacoes.includes("Protocolo criado automaticamente")&&(n=await X(a)),G({...a,observacoes:n});const{data:t,error:c}=await h.from("fazendas").select("nome").eq("id",a.fazenda_id).single();if(c)throw c;K(t.nome),await ee(a.id),await ae({...a,observacoes:n})}catch{}finally{O(!1)}},ee=async a=>{try{const{data:r,error:n}=await h.from("protocolo_receptoras").select("id").eq("protocolo_id",a);if(n||!r||r.length===0)return;const t=r.map(p=>p.id),{data:c,error:f}=await h.from("transferencias_embrioes").select("data_te, veterinario_responsavel, tecnico_responsavel").in("protocolo_receptora_id",t).eq("status_te","REALIZADA").order("data_te",{ascending:!1}).order("created_at",{ascending:!1}).limit(1).single();if(f)return;c&&k({data_te:c.data_te,veterinario_responsavel:c.veterinario_responsavel||void 0,tecnico_responsavel:c.tecnico_responsavel||void 0})}catch{k(null)}},ae=async a=>{try{const{data:r,error:n}=await h.from("protocolo_receptoras").select("*").eq("protocolo_id",a.id).order("data_inclusao",{ascending:!0});if(n)throw n;const t=[];for(const o of r||[]){const{data:T,error:y}=await h.from("receptoras").select("*").eq("id",o.receptora_id).single();y||t.push({...T,pr_id:o.id,pr_status:o.status,pr_motivo_inapta:o.motivo_inapta,pr_data_inclusao:o.data_inclusao,pr_data_retirada:o.data_retirada,pr_ciclando_classificacao:o.ciclando_classificacao,pr_qualidade_semaforo:o.qualidade_semaforo})}U(t);const c=t.length,f=t.filter(o=>o.pr_status==="APTA").length,p=t.filter(o=>o.pr_status==="INAPTA").length;W({totalIniciaram:c,totalConcluiram:f,totalDescartadas:p,totalConfirmadas:f})}catch{Q({title:"Erro ao carregar receptoras",description:"Não foi possível carregar a lista de receptoras do protocolo.",variant:"destructive"})}},$=a=>{if(!a)return{veterinario:null,tecnico:null};const r=a.match(/VET:\s*(.+?)(?:\s*\||$)/i),n=a.match(/TEC:\s*(.+?)(?:\s*\||$)/i);return{veterinario:r?r[1].trim():null,tecnico:n?n[1].trim():null}},te=a=>a==="APTA"?e.jsx(N,{variant:"default",className:"bg-green-600",children:"Confirmada"}):a==="INAPTA"?e.jsx(N,{variant:"destructive",children:"Descartada"}):e.jsx(N,{variant:"secondary",children:a}),se=()=>{window.print()};return Z?e.jsx(ne,{}):i?e.jsxs("div",{className:"space-y-6 print:space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between print:hidden",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(E,{variant:"ghost",size:"sm",onClick:()=>q("/protocolos"),children:e.jsx(pe,{className:"w-4 h-4"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Relatório do Protocolo"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Visualização somente leitura"})]})]}),e.jsxs(E,{onClick:se,variant:"outline",children:[e.jsx(he,{className:"w-4 h-4 mr-2"}),"Imprimir"]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(l,{children:[e.jsx(m,{children:e.jsx(x,{children:"Informações Gerais"})}),e.jsxs(u,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Fazenda"}),e.jsx("p",{className:"text-base text-foreground mt-1",children:J||"—"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Data de Início"}),e.jsx("p",{className:"text-base text-foreground mt-1",children:i.data_inicio?F(i.data_inicio):"—"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Status"}),e.jsxs("p",{className:"text-base text-foreground mt-1",children:[i.status==="SINCRONIZADO"&&e.jsx(N,{variant:"default",className:"bg-green-600",children:"Sincronizado"}),i.status==="FECHADO"&&e.jsx(N,{variant:"default",className:"bg-slate-600",children:"Fechado"}),i.status==="PASSO1_FECHADO"&&e.jsx(N,{variant:"default",className:"bg-yellow-600",children:"Aguardando 2º Passo"})]})]})]})]}),e.jsxs(l,{children:[e.jsx(m,{children:e.jsx(x,{children:"1º Passo"})}),e.jsxs(u,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Veterinário Responsável"}),e.jsx("p",{className:"text-base text-foreground mt-1",children:$(i.responsavel_inicio).veterinario||"—"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Técnico Responsável"}),e.jsx("p",{className:"text-base text-foreground mt-1",children:$(i.responsavel_inicio).tecnico||"—"})]})]})]}),e.jsxs(l,{children:[e.jsx(m,{children:e.jsx(x,{children:"2º Passo"})}),e.jsxs(u,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Data de Realização"}),e.jsx("p",{className:"text-base text-foreground mt-1",children:i.passo2_data?F(i.passo2_data):"—"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Técnico Responsável"}),e.jsx("p",{className:"text-base text-foreground mt-1",children:i.passo2_tecnico_responsavel||"—"})]})]})]}),d&&(d.data_te||d.veterinario_responsavel||d.tecnico_responsavel)&&e.jsxs(l,{children:[e.jsx(m,{children:e.jsx(x,{children:"Transferência de Embriões"})}),e.jsxs(u,{className:"space-y-4",children:[d.data_te&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Data da TE"}),e.jsx("p",{className:"text-base text-foreground mt-1",children:F(d.data_te)})]}),d.veterinario_responsavel&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Veterinário Responsável"}),e.jsx("p",{className:"text-base text-foreground mt-1",children:d.veterinario_responsavel})]}),d.tecnico_responsavel&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Técnico Responsável"}),e.jsx("p",{className:"text-base text-foreground mt-1",children:d.tecnico_responsavel})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs(l,{children:[e.jsx(m,{className:"pb-3",children:e.jsx(x,{className:"text-base",children:"Total Iniciaram"})}),e.jsx(u,{children:e.jsx("p",{className:"text-3xl font-bold text-foreground",children:_.totalIniciaram})})]}),e.jsxs(l,{children:[e.jsx(m,{className:"pb-3",children:e.jsx(x,{className:"text-base",children:"Confirmadas"})}),e.jsx(u,{children:e.jsx("p",{className:"text-3xl font-bold text-primary",children:_.totalConfirmadas})})]}),e.jsxs(l,{children:[e.jsx(m,{className:"pb-3",children:e.jsx(x,{className:"text-base",children:"Descartadas"})}),e.jsx(u,{children:e.jsx("p",{className:"text-3xl font-bold text-red-600",children:_.totalDescartadas})})]}),e.jsxs(l,{children:[e.jsx(m,{className:"pb-3",children:e.jsx(x,{className:"text-base",children:"Taxa de Sucesso"})}),e.jsx(u,{children:e.jsxs("p",{className:"text-3xl font-bold text-blue-600",children:[_.totalIniciaram>0?Math.round(_.totalConfirmadas/_.totalIniciaram*100):0,"%"]})})]})]}),e.jsxs(l,{children:[e.jsx(m,{children:e.jsx(x,{children:"Receptoras e Resultado Final"})}),e.jsx(u,{children:B.length===0?e.jsx("p",{className:"text-muted-foreground text-center py-4",children:"Nenhuma receptora no protocolo"}):e.jsxs(ce,{children:[e.jsx(de,{children:e.jsxs(V,{children:[e.jsx(b,{children:"Identificação"}),e.jsx(b,{children:"Ciclando"}),e.jsx(b,{children:"Qualidade"}),e.jsx(b,{children:"Resultado Final"}),e.jsx(b,{children:"Motivo do Descarte"})]})}),e.jsx(le,{children:B.map(a=>e.jsxs(V,{children:[e.jsxs(z,{className:"font-medium",children:[a.identificacao,a.nome?` - ${a.nome}`:""]}),e.jsx(z,{children:e.jsx(xe,{value:a.pr_ciclando_classificacao,variant:"display",disabled:!0})}),e.jsx(z,{children:e.jsx(ue,{value:a.pr_qualidade_semaforo,variant:"single",disabled:!0})}),e.jsx(z,{children:te(a.pr_status)}),e.jsx(z,{children:a.pr_motivo_inapta||"—"})]},a.id))})]})})]}),i.observacoes&&e.jsxs(l,{children:[e.jsx(m,{children:e.jsx(x,{children:"Observações"})}),e.jsx(u,{children:e.jsx("p",{className:"text-muted-foreground whitespace-pre-wrap",children:i.observacoes})})]})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx("p",{className:"text-muted-foreground",children:"Protocolo não encontrado"}),e.jsx(E,{onClick:()=>q("/protocolos"),className:"mt-4",children:"Voltar para Protocolos"})]})}export{Ce as default};
