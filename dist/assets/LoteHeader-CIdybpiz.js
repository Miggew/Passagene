import{r as T,s as j,j as e,g as Q,h as B}from"./index-CWtHucPz.js";import{u as G,C as O,a as R,b as P,c as $}from"./use-toast-C_ednEV-.js";import{S as U,a as J,b as K,c as W,d as X}from"./select-BUr2m4f3.js";import{L as D}from"./label-CDN-yMr6.js";import{T as Y,a as ee,b as Z,c as M,d as ae,e as I}from"./table-2v-HqcxP.js";import{E as se}from"./EmptyState-B00kV8BS.js";import{I as H}from"./input-bF23Jkur.js";import{C as re}from"./circle-check-big-WLdPQf4E.js";import{L as te}from"./lock-BwRoEkXK.js";function fe(t){const i=new Date(t);return Math.floor((new Date().getTime()-i.getTime())/(1e3*60*60*24))}function ue(t){const i=new Date(t),s=new Date(i);return s.setDate(s.getDate()+275),s.toISOString().split("T")[0]}function me(){return new Date().toISOString().split("T")[0]}function ve(t){return t.veterinario_responsavel.trim()!==""&&t.tecnico_responsavel.trim()!==""}function ge({statusReceptoraFiltro:t,tipoDiagnosticoFiltro:i}){const{toast:s}=G(),[c,n]=T.useState([]),[h,u]=T.useState(!1),l=T.useCallback(async()=>{try{u(!0);const{data:_,error:p}=await j.from("fazendas").select("*").order("nome",{ascending:!0});if(p)throw p;if(!_||_.length===0){n([]);return}const{data:m,error:o}=await j.from("vw_receptoras_fazenda_atual").select("receptora_id, fazenda_id_atual");if(o)throw o;const A=[...new Set((m||[]).map(r=>r.receptora_id).filter(Boolean))];if(A.length===0){n([]);return}const C=Array.isArray(t)?t:[t];let v=j.from("receptoras").select("id").in("id",A);C.length===1?v=v.eq("status_reprodutivo",C[0]):v=v.in("status_reprodutivo",C);const{data:g,error:N}=await v;if(N)throw N;const L=(g==null?void 0:g.map(r=>r.id))||[];if(L.length===0){n([]);return}const{data:S,error:q}=await j.from("transferencias_embrioes").select("receptora_id, data_te").in("receptora_id",L).eq("status_te","REALIZADA");if(q)throw q;const{data:w,error:b}=await j.from("diagnosticos_gestacao").select("receptora_id, data_te").in("receptora_id",L).eq("tipo_diagnostico",i);if(b)throw b;const z=new Map((m||[]).filter(r=>r.receptora_id&&r.fazenda_id_atual).map(r=>[r.receptora_id,r.fazenda_id_atual])),E=new Map,k=new Map;(S||[]).forEach(r=>{const f=z.get(r.receptora_id);if(!f)return;const x=`${f}|${r.data_te}`;k.set(x,f),E.has(x)||E.set(x,new Set),E.get(x).add(r.receptora_id)});const a=new Map;(w||[]).forEach(r=>{const f=z.get(r.receptora_id);if(!f)return;const x=`${f}|${r.data_te}`;a.has(x)||a.set(x,new Set),a.get(x).add(r.receptora_id)});const d=new Set;E.forEach((r,f)=>{var V;if((((V=a.get(f))==null?void 0:V.size)||0)<r.size){const F=k.get(f);F&&d.add(F)}});const y=_.filter(r=>d.has(r.id));n(y)}catch(_){s({title:"Erro ao carregar fazendas",description:_ instanceof Error?_.message:"Erro desconhecido",variant:"destructive"}),n([])}finally{u(!1)}},[t,i,s]);return{fazendas:c,loading:h,loadFazendas:l}}function xe({statusReceptoraFiltro:t,tipoDiagnosticoFiltro:i,transformLote:s}){const{toast:c}=G(),[n,h]=T.useState([]),[u,l]=T.useState(!1),_=T.useCallback(async(p,m)=>{try{l(!0);const{data:o,error:A}=await j.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",p);if(A)throw A;const C=(o==null?void 0:o.map(a=>a.receptora_id))||[];if(C.length===0){h([]);return}const v=Array.isArray(t)?t:[t];let g=j.from("receptoras").select("id, status_reprodutivo").in("id",C);v.length===1?g=g.eq("status_reprodutivo",v[0]):g=g.in("status_reprodutivo",v);const{data:N}=await g,L=(N==null?void 0:N.map(a=>a.id))||[];if(L.length===0){h([]);return}const{data:S,error:q}=await j.from("transferencias_embrioes").select("id, receptora_id, data_te").in("receptora_id",L).eq("status_te","REALIZADA").order("data_te",{ascending:!1});if(q)throw q;const{data:w}=await j.from("diagnosticos_gestacao").select("receptora_id, data_te, veterinario_responsavel, tecnico_responsavel, data_diagnostico").in("receptora_id",L).eq("tipo_diagnostico",i).order("data_diagnostico",{ascending:!1}),b=new Map,z=new Map,E=new Map;S==null||S.forEach(a=>{const d=`${p}-${a.data_te}`;if(z.has(a.data_te)||z.set(a.data_te,new Set),z.get(a.data_te).add(a.receptora_id),!b.has(d)){const y=w==null?void 0:w.find(r=>r.data_te===a.data_te);y&&!E.has(a.data_te)&&E.set(a.data_te,y),b.set(d,{id:d,fazenda_id:p,fazenda_nome:m||"",data_te:a.data_te,quantidade_receptoras:0,status:"ABERTO"})}}),b.forEach(a=>{var r;const d=((r=z.get(a.data_te))==null?void 0:r.size)||0;a.quantidade_receptoras=d;const y=(w==null?void 0:w.filter(f=>f.data_te===a.data_te))||[];y.length>0&&y.length>=d&&(a.status="FECHADO")});const k=Array.from(b.values()).map(a=>{const d=E.get(a.data_te);return s(a,d?{veterinario_responsavel:d.veterinario_responsavel,tecnico_responsavel:d.tecnico_responsavel}:void 0)}).filter(a=>a.status==="ABERTO").sort((a,d)=>new Date(d.data_te).getTime()-new Date(a.data_te).getTime());h(k)}catch(o){c({title:"Erro ao carregar lotes",description:o instanceof Error?o.message:"Erro desconhecido",variant:"destructive"}),h([])}finally{l(!1)}},[t,i,s,c]);return{lotesTE:n,loading:u,loadLotesTE:_}}function je({fazendas:t,fazendaSelecionada:i,onFazendaChange:s}){return e.jsxs(O,{children:[e.jsx(R,{children:e.jsx(P,{children:"Selecionar Fazenda"})}),e.jsx($,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"fazenda",children:"Fazenda *"}),e.jsxs(U,{value:i,onValueChange:s,children:[e.jsx(J,{children:e.jsx(K,{placeholder:"Selecione a fazenda"})}),e.jsx(W,{children:t.map(c=>e.jsx(X,{value:c.id,children:c.nome},c.id))})]})]})})]})}function we({title:t,emptyTitle:i,emptyDescription:s,lotesTE:c,loteSelecionado:n,loading:h,veterinarioLabel:u,tecnicoLabel:l,getVeterinario:_,getTecnico:p,onSelectLote:m}){return e.jsxs(O,{children:[e.jsx(R,{children:e.jsx(P,{children:t})}),e.jsx($,{children:h?e.jsx(Q,{}):c.length===0?e.jsx(se,{title:i,description:s}):e.jsxs(Y,{children:[e.jsx(ee,{children:e.jsxs(Z,{children:[e.jsx(M,{children:"Data TE"}),e.jsx(M,{children:"Quantidade"}),e.jsx(M,{children:u}),e.jsx(M,{children:l}),e.jsx(M,{className:"text-right",children:"Ações"})]})}),e.jsx(ae,{children:c.map(o=>e.jsxs(Z,{className:(n==null?void 0:n.id)===o.id?"bg-blue-50":"",children:[e.jsx(I,{className:"font-medium",children:new Date(o.data_te).toLocaleDateString("pt-BR")}),e.jsxs(I,{children:[o.quantidade_receptoras," receptoras"]}),e.jsx(I,{children:_(o)||"-"}),e.jsx(I,{children:p(o)||"-"}),e.jsx(I,{className:"text-right",children:e.jsx(B,{size:"sm",onClick:()=>m(o),variant:(n==null?void 0:n.id)===o.id?"default":"outline",children:(n==null?void 0:n.id)===o.id?"Selecionado":"Selecionar"})})]},o.id))})]})})]})}function Ee({title:t,loteSelecionado:i,loteFormData:s,onFormChange:c,onAbrirLote:n,onCancelar:h}){const u=s.veterinario_responsavel.trim()!==""&&s.tecnico_responsavel.trim()!=="";return e.jsxs(O,{children:[e.jsx(R,{children:e.jsx(P,{children:t})}),e.jsxs($,{className:"space-y-4",children:[e.jsxs("p",{className:"text-slate-600",children:["Lote de TE em ",new Date(i.data_te).toLocaleDateString("pt-BR")," - ",i.quantidade_receptoras," receptoras"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"veterinario",children:"Veterinário Responsável *"}),e.jsx(H,{id:"veterinario",value:s.veterinario_responsavel,onChange:l=>c({...s,veterinario_responsavel:l.target.value}),placeholder:"Nome do veterinário"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"tecnico",children:"Técnico Responsável *"}),e.jsx(H,{id:"tecnico",value:s.tecnico_responsavel,onChange:l=>c({...s,tecnico_responsavel:l.target.value}),placeholder:"Nome do técnico"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(B,{onClick:n,className:"bg-green-600 hover:bg-green-700",disabled:!u,children:[e.jsx(re,{className:"w-4 h-4 mr-2"}),"Abrir Lote"]}),e.jsx(B,{variant:"outline",onClick:h,children:"Cancelar"})]})]})]})}function Le({loteSelecionado:t,receptorasCount:i,loteFormData:s,onFormChange:c,veterinarioLabel:n,tecnicoLabel:h,onSalvarLote:u,submitting:l,canSave:_}){const p=t.status==="FECHADO";return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(P,{children:["Receptoras do Lote - ",i," ",i===1?"receptora":"receptoras",p&&e.jsx("span",{className:"ml-2 text-sm text-slate-500",children:"(Lote Fechado - Somente Leitura)"})]}),!p&&e.jsxs(B,{onClick:u,disabled:!_||l,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(te,{className:"w-4 h-4 mr-2"}),l?"Salvando...":"Salvar Lote Completo"]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 pt-2 border-t",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(D,{htmlFor:"veterinario_lote",children:[n," *"]}),e.jsx(H,{id:"veterinario_lote",value:s.veterinario_responsavel,onChange:m=>c({...s,veterinario_responsavel:m.target.value}),placeholder:"Nome do veterinário",disabled:p})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(D,{htmlFor:"tecnico_lote",children:[h," *"]}),e.jsx(H,{id:"tecnico_lote",value:s.tecnico_responsavel,onChange:m=>c({...s,tecnico_responsavel:m.target.value}),placeholder:"Nome do técnico",disabled:p})]})]})]})}export{Ee as A,je as F,we as L,xe as a,Le as b,fe as c,ue as d,me as g,ge as u,ve as v};
