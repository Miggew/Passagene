import{r as p,s as j,j as e,g as be}from"./index-CWtHucPz.js";import{a as je,e as Ne,c as Re,b as Fe}from"./dataEnrichment-C6Uyclml.js";import{u as Me,C as He,a as Ce,c as we}from"./use-toast-C_ednEV-.js";import{T as Oe,a as Pe,b as ne,c as F,d as Te,e as M}from"./table-2v-HqcxP.js";import{S as ye,a as Le,b as De,c as ze,d as J}from"./select-BUr2m4f3.js";import{T as Ve}from"./textarea-EUsZECCO.js";import{P as Ge}from"./PageHeader-DqMTzrbX.js";import{S as Ie}from"./StatusBadge-B_pnPC6h.js";import{a as Xe}from"./receptoraStatus-DfJ2QNI_.js";import{D as $e}from"./DatePickerBR-D4MNcuwK.js";import{g as qe,u as Ze,a as Be,c as Ue,F as ke,L as Qe,A as Je,b as Ke,v as ce}from"./LoteHeader-CIdybpiz.js";import"./index-RvRMy3My.js";import"./index-H2w26JuE.js";import"./check-D_BDiPDp.js";import"./badge-DewFfdNp.js";import"./statusLabels-IklKT8dE.js";import"./chevron-right-CY2M1G_-.js";import"./popover-hCBfJPXC.js";import"./dateUtils-eJ5e6apA.js";import"./label-CDN-yMr6.js";import"./EmptyState-B00kV8BS.js";import"./input-bF23Jkur.js";import"./circle-check-big-WLdPQf4E.js";import"./lock-BwRoEkXK.js";const de=["PRENHE","PRENHE_RETOQUE","PRENHE_FEMEA","PRENHE_MACHO","PRENHE_SEM_SEXO","PRENHE_2_SEXOS"];function Aa(){const{toast:C}=Me(),K=qe(),[N,le]=p.useState(""),[n,D]=p.useState(null),[R,H]=p.useState([]),[me,ae]=p.useState(!1),[_e,se]=p.useState(!1),[te,w]=p.useState(!1),[z,O]=p.useState({}),[v,V]=p.useState({veterinario_responsavel:"",tecnico_responsavel:""}),{fazendas:W,loadFazendas:oe}=Ze({statusReceptoraFiltro:["PRENHE","PRENHE_RETOQUE"],tipoDiagnosticoFiltro:"SEXAGEM"}),ge=p.useCallback((a,s)=>({...a,veterinario_sexagem:s==null?void 0:s.veterinario_responsavel,tecnico_sexagem:s==null?void 0:s.tecnico_responsavel}),[]),{lotesTE:ue,loading:pe,loadLotesTE:re}=Be({statusReceptoraFiltro:de,tipoDiagnosticoFiltro:"SEXAGEM",transformLote:ge});p.useEffect(()=>{oe()},[oe]),p.useEffect(()=>{var a;if(N){const s=(a=W.find(c=>c.id===N))==null?void 0:a.nome;re(N,s)}else D(null),H([]),O({})},[N]),p.useEffect(()=>{n?n.status==="FECHADO"?(V({veterinario_responsavel:n.veterinario_sexagem||"",tecnico_responsavel:n.tecnico_sexagem||""}),w(!1),X(n)):n.veterinario_sexagem&&n.tecnico_sexagem?(V({veterinario_responsavel:n.veterinario_sexagem,tecnico_responsavel:n.tecnico_sexagem}),w(!1),X(n)):(V({veterinario_responsavel:"",tecnico_responsavel:""}),w(!0),H([]),O({})):(H([]),O({}),w(!1))},[n]);const fe=async()=>{if(!ce(v)){C({title:"Erro de validação",description:"Veterinário e técnico responsáveis são obrigatórios",variant:"destructive"});return}if(!n)return;const a={...n,veterinario_sexagem:v.veterinario_responsavel.trim(),tecnico_sexagem:v.tecnico_responsavel.trim(),status:"ABERTO"};D(a),w(!1),await X(a)},X=async a=>{try{ae(!0);const{data:s}=await j.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",a.fazenda_id),c=(s==null?void 0:s.map(t=>t.receptora_id))||[],{data:i}=await j.from("receptoras").select("id, identificacao, nome, status_reprodutivo").in("id",c).in("status_reprodutivo",de),o=(i==null?void 0:i.map(t=>t.id))||[];if(o.length===0){H([]);return}const[_,G,d]=await Promise.all([j.from("transferencias_embrioes").select("id, receptora_id, embriao_id, data_te").in("receptora_id",o).eq("data_te",a.data_te).eq("status_te","REALIZADA"),j.from("diagnosticos_gestacao").select("*").in("receptora_id",o).eq("tipo_diagnostico","DG").eq("data_te",a.data_te).order("data_diagnostico",{ascending:!1}),j.from("diagnosticos_gestacao").select("*").in("receptora_id",o).eq("tipo_diagnostico","SEXAGEM").eq("data_te",a.data_te).order("data_diagnostico",{ascending:!1})]),l=_.data,g=G.data,h=d.data;if(!l||l.length===0){H([]);return}const P=l.map(t=>t.embriao_id).filter(Boolean);let f=new Map;if(P.length>0){const{data:t}=await j.from("embrioes").select("id, identificacao, classificacao, lote_fiv_id, lote_fiv_acasalamento_id").in("id",P);t&&(f=new Map(t.map(r=>[r.id,r])))}const $=Array.from(f.values()),S=je($),q=Ne($),[T,Z]=await Promise.all([Re(S),Fe(q)]),{doadorasMap:B,tourosMap:U}=Z,y=new Map;g==null||g.forEach(t=>{y.has(t.receptora_id)||y.set(t.receptora_id,t)});const m=new Map;h==null||h.forEach(t=>{m.has(t.receptora_id)||m.set(t.receptora_id,t)});const A=new Map;l.forEach(t=>{const r=`${t.receptora_id}-${t.data_te}`;A.has(r)||A.set(r,[]),A.get(r).push(t)});const x=[];A.forEach(t=>{const r=t[0],u=i==null?void 0:i.find(Q=>Q.id===r.receptora_id);if(!u)return;const L=[];let b=null,k=null;if(t.forEach(Q=>{const E=f.get(Q.embriao_id);if(!E)return;const ee=T.get(E.lote_fiv_id);if(!ee)return;b||(b=ee.data_abertura,k=Ue(ee.data_abertura));const Se=E.lote_fiv_acasalamento_id?B.get(E.lote_fiv_acasalamento_id):void 0,Ae=E.lote_fiv_acasalamento_id?U.get(E.lote_fiv_acasalamento_id):void 0;L.push({te_id:Q.id,embriao_id:E.id,embriao_identificacao:E.identificacao,embriao_classificacao:E.classificacao,lote_fiv_id:E.lote_fiv_id,lote_fiv_acasalamento_id:E.lote_fiv_acasalamento_id,doadora_registro:Se,touro_nome:Ae})}),L.length===0||!b||k===null)return;const I=y.get(r.receptora_id);!I||I.resultado==="VAZIA"||x.push({receptora_id:r.receptora_id,brinco:u.identificacao,nome:u.nome,data_te:r.data_te,embrioes:L,data_abertura_lote:b,dias_gestacao:k,numero_gestacoes:I.numero_gestacoes||1,diagnostico_existente:m.get(r.receptora_id)?{id:m.get(r.receptora_id).id,data_diagnostico:m.get(r.receptora_id).data_diagnostico,resultado:m.get(r.receptora_id).resultado,numero_gestacoes:m.get(r.receptora_id).numero_gestacoes,observacoes:m.get(r.receptora_id).observacoes}:void 0})}),x.sort((t,r)=>t.brinco.localeCompare(r.brinco)),H(x);const Y={};x.forEach(t=>{if(t.diagnostico_existente){const r=m.get(t.receptora_id);let u=new Array(t.numero_gestacoes).fill("").map(()=>""),L=t.diagnostico_existente.observacoes||"";if(r!=null&&r.observacoes){const b=r.observacoes.match(/SEXAGENS:([^|]+)/);if(b){for(u=b[1].split(",").map(I=>I.trim());u.length<t.numero_gestacoes;)u.push("");u=u.slice(0,t.numero_gestacoes),L=r.observacoes.replace(/SEXAGENS:[^|]+\|?/,"").trim()}}u.every(b=>!b)&&(r!=null&&r.sexagem)&&(u[0]=r.sexagem),Y[t.receptora_id]={data_sexagem:t.diagnostico_existente.data_diagnostico,sexagens:u,observacoes:L}}else Y[t.receptora_id]={data_sexagem:K,sexagens:new Array(t.numero_gestacoes).fill("").map(()=>""),observacoes:""}}),O(Y)}catch(s){C({title:"Erro ao carregar receptoras",description:s instanceof Error?s.message:"Erro desconhecido",variant:"destructive"}),H([])}finally{ae(!1)}},xe=(a,s,c)=>{O(i=>{const o=i[a]||{data_sexagem:K,sexagens:[],observacoes:""},_=[...o.sexagens];return _[s]=c,{...i,[a]:{...o,sexagens:_}}})},ie=(a,s,c)=>{O(i=>({...i,[a]:{...i[a],[s]:c}}))},Ee=a=>{const s=a.filter(_=>_&&_!=="VAZIA");if(s.length===0)return"VAZIA";const c=s.includes("FEMEA"),i=s.includes("MACHO"),o=s.includes("SEM_SEXO");return c&&!i&&!o?"PRENHE_FEMEA":i&&!c&&!o?"PRENHE_MACHO":c&&i?"PRENHE_2_SEXOS":"PRENHE_SEM_SEXO"},ve=async()=>{var s;if(!n)return;if(!ce(v)){C({title:"Erro de validação",description:"Veterinário e técnico responsáveis são obrigatórios",variant:"destructive"});return}const a=R.filter(c=>{const i=z[c.receptora_id];return!i||!i.data_sexagem||!i.sexagens||i.sexagens.every(o=>!o)});if(a.length>0){C({title:"Erro de validação",description:`Há ${a.length} receptora(s) sem sexagem definida`,variant:"destructive"});return}try{se(!0);const c=[],i=[],o=[];if(R.forEach(d=>{var B,U,y;const l=z[d.receptora_id];if(!l||!l.data_sexagem)return;const g=l.sexagens.filter(m=>m&&m!=="VAZIA"),h=Ee(l.sexagens),P=h==="VAZIA"?"VAZIA":"PRENHE";let f=null;if(P==="PRENHE"){const m=g.every(x=>x==="FEMEA")&&g.length>0,A=g.every(x=>x==="MACHO")&&g.length>0;m?f="FEMEA":A?f="MACHO":f=g.find(x=>x==="FEMEA"||x==="MACHO")||null}(f==="PRENHE"||f==="SEM_SEXO")&&(f=g.find(A=>A==="FEMEA"||A==="MACHO")||null);const $=P==="VAZIA"?0:g.length;let S=((B=l.observacoes)==null?void 0:B.trim())||"";const q=l.sexagens.filter(m=>m),T=q.length>0?q.join(","):"";T&&(S.includes("SEXAGENS:")?S=S.replace(/SEXAGENS:[^|]+/,`SEXAGENS:${T}`):S=S?`SEXAGENS:${T}|${S}`:`SEXAGENS:${T}`);const Z={receptora_id:d.receptora_id,data_te:d.data_te,tipo_diagnostico:"SEXAGEM",data_diagnostico:l.data_sexagem,resultado:P,sexagem:f,numero_gestacoes:$,observacoes:S||void 0,veterinario_responsavel:((U=v.veterinario_responsavel)==null?void 0:U.trim())||void 0,tecnico_responsavel:((y=v.tecnico_responsavel)==null?void 0:y.trim())||void 0};d.diagnostico_existente?i.push({id:d.diagnostico_existente.id,...Z}):c.push(Z),o.push({receptora_id:d.receptora_id,status:h})}),c.length>0){const{error:d}=await j.from("diagnosticos_gestacao").insert(c);if(d)throw new Error(`Erro ao inserir sexagens: ${d.message}`)}for(const d of i){const{id:l,...g}=d,{error:h}=await j.from("diagnosticos_gestacao").update(g).eq("id",l);if(h)throw new Error(`Erro ao atualizar sexagem: ${h.message}`)}for(const d of o){const{error:l}=await Xe(d.receptora_id,d.status);if(l)throw new Error("Erro ao atualizar status da receptora");d.status==="VAZIA"&&await j.from("receptoras").update({data_provavel_parto:null}).eq("id",d.receptora_id)}const _=R.every(d=>{const l=z[d.receptora_id];return l&&l.data_sexagem&&l.sexagens&&l.sexagens.some(g=>g)});D({...n,veterinario_sexagem:v.veterinario_responsavel.trim(),tecnico_sexagem:v.tecnico_responsavel.trim(),status:_?"FECHADO":"ABERTO"}),C({title:"Lote salvo com sucesso",description:`${R.length} sexagem(ns) registrada(s)`});const G=(s=W.find(d=>d.id===N))==null?void 0:s.nome;await re(N,G),n&&await X(n)}catch(c){C({title:"Erro ao salvar lote",description:c instanceof Error?c.message:"Erro desconhecido",variant:"destructive"})}finally{se(!1)}},he=R.every(a=>{const s=z[a.receptora_id];return s&&s.data_sexagem&&s.sexagens&&s.sexagens.some(c=>c)});return e.jsxs("div",{className:"space-y-6",children:[e.jsx(Ge,{title:"Sexagem",description:"Registrar sexagem fetal por lote de receptoras prenhes"}),e.jsx(ke,{fazendas:W,fazendaSelecionada:N,onFazendaChange:le}),N&&e.jsx(Qe,{title:"Lotes de Receptoras Prenhes",emptyTitle:"Nenhum lote de receptoras prenhes encontrado",emptyDescription:"Selecione outra fazenda ou verifique se há receptoras prenhes registradas.",lotesTE:ue,loteSelecionado:n,loading:pe,veterinarioLabel:"Vet. Sexagem",tecnicoLabel:"Téc. Sexagem",getVeterinario:a=>a.veterinario_sexagem,getTecnico:a=>a.tecnico_sexagem,onSelectLote:D}),n&&te&&e.jsx(Je,{title:"Abrir Lote de Sexagem",loteSelecionado:n,loteFormData:v,onFormChange:V,onAbrirLote:fe,onCancelar:()=>{w(!1),D(null)}}),n&&!te&&R.length>0&&e.jsxs(He,{children:[e.jsx(Ce,{children:e.jsx(Ke,{loteSelecionado:n,receptorasCount:R.length,loteFormData:v,onFormChange:V,veterinarioLabel:"Veterinário Responsável (Sexagem)",tecnicoLabel:"Técnico Responsável (Sexagem)",onSalvarLote:ve,submitting:_e,canSave:he})}),e.jsx(we,{children:me?e.jsx(be,{}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(Oe,{children:[e.jsx(Pe,{children:e.jsxs(ne,{children:[e.jsx(F,{children:"Receptora"}),e.jsx(F,{children:"Dias Gestação"}),e.jsx(F,{children:"Embrião(ões)"}),e.jsx(F,{children:"Doadora / Touro"}),e.jsx(F,{children:"Nº Gest."}),e.jsx(F,{children:"Data Sexagem"}),e.jsx(F,{children:"Sexagens"}),e.jsx(F,{children:"Observações"})]})}),e.jsx(Te,{children:R.map(a=>{var i;const s=z[a.receptora_id]||{data_sexagem:K,sexagens:new Array(a.numero_gestacoes).fill("").map(()=>""),observacoes:""},c=!!a.diagnostico_existente;return e.jsxs(ne,{children:[e.jsxs(M,{className:"font-medium",children:[a.brinco,a.nome&&e.jsxs("span",{className:"text-slate-500 text-sm ml-2",children:["(",a.nome,")"]}),c&&e.jsx(Ie,{status:((i=a.diagnostico_existente)==null?void 0:i.resultado)||"",className:"ml-2"})]}),e.jsxs(M,{children:[e.jsx("span",{className:"font-semibold",children:a.dias_gestacao})," dias"]}),e.jsx(M,{children:e.jsx("div",{className:"space-y-1",children:a.embrioes.map((o,_)=>e.jsx("div",{className:"text-sm",children:e.jsxs("div",{className:"font-medium",children:[o.embriao_identificacao||`Embrião ${_+1}`,o.embriao_classificacao&&e.jsxs("span",{className:"text-slate-500 ml-2",children:["(",o.embriao_classificacao,")"]})]})},o.te_id))})}),e.jsx(M,{children:e.jsx("div",{className:"space-y-1",children:a.embrioes.map(o=>e.jsx("div",{className:"text-sm",children:e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:o.doadora_registro||"-"}),o.doadora_registro&&o.touro_nome&&" × ",e.jsx("span",{className:"font-medium",children:o.touro_nome||""})]})},o.te_id))})}),e.jsx(M,{className:"font-medium text-center",children:a.numero_gestacoes}),e.jsx(M,{children:e.jsx($e,{value:s.data_sexagem,onChange:o=>ie(a.receptora_id,"data_sexagem",o||""),className:"w-36",disabled:n.status==="FECHADO"})}),e.jsx(M,{children:e.jsx("div",{className:"flex gap-2",children:Array.from({length:a.numero_gestacoes},(o,_)=>{const G=s.sexagens[_]||"",d=a.numero_gestacoes>1?`Gest. ${_+1}`:"Selecione";return e.jsxs(ye,{value:G,onValueChange:l=>xe(a.receptora_id,_,l),disabled:n.status==="FECHADO",children:[e.jsx(Le,{className:"w-28",children:e.jsx(De,{placeholder:d})}),e.jsxs(ze,{children:[e.jsx(J,{value:"FEMEA",children:"Fêmea"}),e.jsx(J,{value:"MACHO",children:"Macho"}),e.jsx(J,{value:"SEM_SEXO",children:"Sem sexo"}),e.jsx(J,{value:"VAZIA",children:"Vazia"})]})]},_)})})}),e.jsx(M,{children:e.jsx(Ve,{value:s.observacoes,onChange:o=>ie(a.receptora_id,"observacoes",o.target.value),placeholder:"Observações",rows:2,className:"w-48",disabled:n.status==="FECHADO"})})]},a.receptora_id)})})]})})})]})]})}export{Aa as default};
