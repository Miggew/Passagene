import{r as p,s as A,j as e,g as be}from"./index-CvlUDCD-.js";import{a as je,e as Ne,c as Re,b as Fe}from"./dataEnrichment-vey-_oex.js";import{u as Me,C as He,a as Ce,c as we}from"./use-toast-BhbfqK05.js";import{T as Oe,a as Pe,b as ne,c as N,d as Te,e as R}from"./table-BAfLAU-a.js";import{S as ye,a as Le,b as De,c as Ve,d as J}from"./select-CRV7QsOQ.js";import{T as Ge}from"./textarea-CWzGJoHk.js";import{P as ze}from"./PageHeader-Don16aHL.js";import{S as Ie}from"./StatusBadge-Dl4aSm-D.js";import{a as Xe}from"./receptoraStatus-DUGAnGBM.js";import{D as $e}from"./DatePickerBR-gAx3gAQT.js";import{g as qe,u as Ze,a as Be,c as Ue,F as ke,L as Qe,A as Je,b as Ke,v as ce}from"./LoteHeader-G7UdQGWm.js";import"./index-BYe3zTS0.js";import"./index-CDlvsNjp.js";import"./check-BbN618wW.js";import"./badge-C6XBkHcG.js";import"./popover-D6dVxm31.js";import"./label-BIMTC7_j.js";import"./EmptyState-DFkj0E0i.js";import"./input-BiDTc9_9.js";import"./circle-check-big-C9vVKwgT.js";import"./lock-F3GwCU70.js";const de=["PRENHE","PRENHE_RETOQUE","PRENHE_FEMEA","PRENHE_MACHO","PRENHE_SEM_SEXO","PRENHE_2_SEXOS"];function va(){const{toast:H}=Me(),K=qe(),[C,le]=p.useState(""),[n,y]=p.useState(null),[b,F]=p.useState([]),[me,ae]=p.useState(!1),[_e,se]=p.useState(!1),[te,w]=p.useState(!1),[L,O]=p.useState({}),[v,D]=p.useState({veterinario_responsavel:"",tecnico_responsavel:""}),{fazendas:oe,loadFazendas:re}=Ze({statusReceptoraFiltro:["PRENHE","PRENHE_RETOQUE"],tipoDiagnosticoFiltro:"SEXAGEM"}),ge=p.useCallback((a,s)=>({...a,veterinario_sexagem:s==null?void 0:s.veterinario_responsavel,tecnico_sexagem:s==null?void 0:s.tecnico_responsavel}),[]),{lotesTE:ue,loading:pe,loadLotesTE:W}=Be({statusReceptoraFiltro:de,tipoDiagnosticoFiltro:"SEXAGEM",fazendas:oe,transformLote:ge});p.useEffect(()=>{re()},[re]),p.useEffect(()=>{C?W(C):(y(null),F([]),O({}))},[C,W]),p.useEffect(()=>{n?n.status==="FECHADO"?(D({veterinario_responsavel:n.veterinario_sexagem||"",tecnico_responsavel:n.tecnico_sexagem||""}),w(!1),z(n)):n.veterinario_sexagem&&n.tecnico_sexagem?(D({veterinario_responsavel:n.veterinario_sexagem,tecnico_responsavel:n.tecnico_sexagem}),w(!1),z(n)):(D({veterinario_responsavel:"",tecnico_responsavel:""}),w(!0),F([]),O({})):(F([]),O({}),w(!1))},[n]);const fe=async()=>{if(!ce(v)){H({title:"Erro de validação",description:"Veterinário e técnico responsáveis são obrigatórios",variant:"destructive"});return}if(!n)return;const a={...n,veterinario_sexagem:v.veterinario_responsavel.trim(),tecnico_sexagem:v.tecnico_responsavel.trim(),status:"ABERTO"};y(a),w(!1),await z(a)},z=async a=>{try{ae(!0);const{data:s}=await A.from("vw_receptoras_fazenda_atual").select("receptora_id").eq("fazenda_id_atual",a.fazenda_id),d=(s==null?void 0:s.map(t=>t.receptora_id))||[],{data:c}=await A.from("receptoras").select("id, identificacao, nome, status_reprodutivo").in("id",d).in("status_reprodutivo",de),i=(c==null?void 0:c.map(t=>t.id))||[];if(i.length===0){F([]);return}const[o,l,_]=await Promise.all([A.from("transferencias_embrioes").select("id, receptora_id, embriao_id, data_te").in("receptora_id",i).eq("data_te",a.data_te).eq("status_te","REALIZADA"),A.from("diagnosticos_gestacao").select("*").in("receptora_id",i).eq("tipo_diagnostico","DG").eq("data_te",a.data_te).order("data_diagnostico",{ascending:!1}),A.from("diagnosticos_gestacao").select("*").in("receptora_id",i).eq("tipo_diagnostico","SEXAGEM").eq("data_te",a.data_te).order("data_diagnostico",{ascending:!1})]),g=o.data,M=l.data,f=_.data;if(!g||g.length===0){F([]);return}const I=g.map(t=>t.embriao_id).filter(Boolean);let x=new Map;if(I.length>0){const{data:t}=await A.from("embrioes").select("id, identificacao, classificacao, lote_fiv_id, lote_fiv_acasalamento_id").in("id",I);t&&(x=new Map(t.map(r=>[r.id,r])))}const V=Array.from(x.values()),P=je(V),X=Ne(V),[$,q]=await Promise.all([Re(P),Fe(X)]),{doadorasMap:Z,tourosMap:h}=q,j=new Map;M==null||M.forEach(t=>{j.has(t.receptora_id)||j.set(t.receptora_id,t)});const m=new Map;f==null||f.forEach(t=>{m.has(t.receptora_id)||m.set(t.receptora_id,t)});const B=new Map;g.forEach(t=>{const r=`${t.receptora_id}-${t.data_te}`;B.has(r)||B.set(r,[]),B.get(r).push(t)});const U=[];B.forEach(t=>{const r=t[0],u=c==null?void 0:c.find(Q=>Q.id===r.receptora_id);if(!u)return;const T=[];let S=null,k=null;if(t.forEach(Q=>{const E=x.get(Q.embriao_id);if(!E)return;const ee=$.get(E.lote_fiv_id);if(!ee)return;S||(S=ee.data_abertura,k=Ue(ee.data_abertura));const Se=E.lote_fiv_acasalamento_id?Z.get(E.lote_fiv_acasalamento_id):void 0,Ae=E.lote_fiv_acasalamento_id?h.get(E.lote_fiv_acasalamento_id):void 0;T.push({te_id:Q.id,embriao_id:E.id,embriao_identificacao:E.identificacao,embriao_classificacao:E.classificacao,lote_fiv_id:E.lote_fiv_id,lote_fiv_acasalamento_id:E.lote_fiv_acasalamento_id,doadora_registro:Se,touro_nome:Ae})}),T.length===0||!S||k===null)return;const G=j.get(r.receptora_id);!G||G.resultado==="VAZIA"||U.push({receptora_id:r.receptora_id,brinco:u.identificacao,nome:u.nome,data_te:r.data_te,embrioes:T,data_abertura_lote:S,dias_gestacao:k,numero_gestacoes:G.numero_gestacoes||1,diagnostico_existente:m.get(r.receptora_id)?{id:m.get(r.receptora_id).id,data_diagnostico:m.get(r.receptora_id).data_diagnostico,resultado:m.get(r.receptora_id).resultado,numero_gestacoes:m.get(r.receptora_id).numero_gestacoes,observacoes:m.get(r.receptora_id).observacoes}:void 0})}),U.sort((t,r)=>t.brinco.localeCompare(r.brinco)),F(U);const Y={};U.forEach(t=>{if(t.diagnostico_existente){const r=m.get(t.receptora_id);let u=new Array(t.numero_gestacoes).fill("").map(()=>""),T=t.diagnostico_existente.observacoes||"";if(r!=null&&r.observacoes){const S=r.observacoes.match(/SEXAGENS:([^|]+)/);if(S){for(u=S[1].split(",").map(G=>G.trim());u.length<t.numero_gestacoes;)u.push("");u=u.slice(0,t.numero_gestacoes),T=r.observacoes.replace(/SEXAGENS:[^|]+\|?/,"").trim()}}u.every(S=>!S)&&(r!=null&&r.sexagem)&&(u[0]=r.sexagem),Y[t.receptora_id]={data_sexagem:t.diagnostico_existente.data_diagnostico,sexagens:u,observacoes:T}}else Y[t.receptora_id]={data_sexagem:K,sexagens:new Array(t.numero_gestacoes).fill("").map(()=>""),observacoes:""}}),O(Y)}catch(s){H({title:"Erro ao carregar receptoras",description:s instanceof Error?s.message:"Erro desconhecido",variant:"destructive"}),F([])}finally{ae(!1)}},xe=(a,s,d)=>{O(c=>{const i=c[a]||{data_sexagem:K,sexagens:[],observacoes:""},o=[...i.sexagens];return o[s]=d,{...c,[a]:{...i,sexagens:o}}})},ie=(a,s,d)=>{O(c=>({...c,[a]:{...c[a],[s]:d}}))},Ee=a=>{const s=a.filter(o=>o&&o!=="VAZIA");if(s.length===0)return"VAZIA";const d=s.includes("FEMEA"),c=s.includes("MACHO"),i=s.includes("SEM_SEXO");return d&&!c&&!i?"PRENHE_FEMEA":c&&!d&&!i?"PRENHE_MACHO":d&&c?"PRENHE_2_SEXOS":"PRENHE_SEM_SEXO"},ve=async()=>{if(!n)return;if(!ce(v)){H({title:"Erro de validação",description:"Veterinário e técnico responsáveis são obrigatórios",variant:"destructive"});return}const a=b.filter(s=>{const d=L[s.receptora_id];return!d||!d.data_sexagem||!d.sexagens||d.sexagens.every(c=>!c)});if(a.length>0){H({title:"Erro de validação",description:`Há ${a.length} receptora(s) sem sexagem definida`,variant:"destructive"});return}try{se(!0);const s=[],d=[],c=[];if(b.forEach(o=>{var $,q,Z;const l=L[o.receptora_id];if(!l||!l.data_sexagem)return;const _=l.sexagens.filter(h=>h&&h!=="VAZIA"),g=Ee(l.sexagens),M=g==="VAZIA"?"VAZIA":"PRENHE";let f=null;if(M==="PRENHE"){const h=_.every(m=>m==="FEMEA")&&_.length>0,j=_.every(m=>m==="MACHO")&&_.length>0;h?f="FEMEA":j?f="MACHO":f=_.find(m=>m==="FEMEA"||m==="MACHO")||null}(f==="PRENHE"||f==="SEM_SEXO")&&(f=_.find(j=>j==="FEMEA"||j==="MACHO")||null);const I=M==="VAZIA"?0:_.length;let x=(($=l.observacoes)==null?void 0:$.trim())||"";const V=l.sexagens.filter(h=>h),P=V.length>0?V.join(","):"";P&&(x.includes("SEXAGENS:")?x=x.replace(/SEXAGENS:[^|]+/,`SEXAGENS:${P}`):x=x?`SEXAGENS:${P}|${x}`:`SEXAGENS:${P}`);const X={receptora_id:o.receptora_id,data_te:o.data_te,tipo_diagnostico:"SEXAGEM",data_diagnostico:l.data_sexagem,resultado:M,sexagem:f,numero_gestacoes:I,observacoes:x||void 0,veterinario_responsavel:((q=v.veterinario_responsavel)==null?void 0:q.trim())||void 0,tecnico_responsavel:((Z=v.tecnico_responsavel)==null?void 0:Z.trim())||void 0};o.diagnostico_existente?d.push({id:o.diagnostico_existente.id,...X}):s.push(X),c.push({receptora_id:o.receptora_id,status:g})}),s.length>0){const{error:o}=await A.from("diagnosticos_gestacao").insert(s);if(o)throw new Error(`Erro ao inserir sexagens: ${o.message}`)}for(const o of d){const{id:l,..._}=o,{error:g}=await A.from("diagnosticos_gestacao").update(_).eq("id",l);if(g)throw new Error(`Erro ao atualizar sexagem: ${g.message}`)}for(const o of c){const{error:l}=await Xe(o.receptora_id,o.status);if(l)throw new Error("Erro ao atualizar status da receptora");o.status==="VAZIA"&&await A.from("receptoras").update({data_provavel_parto:null}).eq("id",o.receptora_id)}const i=b.every(o=>{const l=L[o.receptora_id];return l&&l.data_sexagem&&l.sexagens&&l.sexagens.some(_=>_)});y({...n,veterinario_sexagem:v.veterinario_responsavel.trim(),tecnico_sexagem:v.tecnico_responsavel.trim(),status:i?"FECHADO":"ABERTO"}),H({title:"Lote salvo com sucesso",description:`${b.length} sexagem(ns) registrada(s)`}),await W(C),n&&await z(n)}catch(s){H({title:"Erro ao salvar lote",description:s instanceof Error?s.message:"Erro desconhecido",variant:"destructive"})}finally{se(!1)}},he=b.every(a=>{const s=L[a.receptora_id];return s&&s.data_sexagem&&s.sexagens&&s.sexagens.some(d=>d)});return e.jsxs("div",{className:"space-y-6",children:[e.jsx(ze,{title:"Sexagem",description:"Registrar sexagem fetal por lote de receptoras prenhes"}),e.jsx(ke,{fazendas:oe,fazendaSelecionada:C,onFazendaChange:le}),C&&e.jsx(Qe,{title:"Lotes de Receptoras Prenhes",emptyTitle:"Nenhum lote de receptoras prenhes encontrado",emptyDescription:"Selecione outra fazenda ou verifique se há receptoras prenhes registradas.",lotesTE:ue,loteSelecionado:n,loading:pe,veterinarioLabel:"Vet. Sexagem",tecnicoLabel:"Téc. Sexagem",getVeterinario:a=>a.veterinario_sexagem,getTecnico:a=>a.tecnico_sexagem,onSelectLote:y}),n&&te&&e.jsx(Je,{title:"Abrir Lote de Sexagem",loteSelecionado:n,loteFormData:v,onFormChange:D,onAbrirLote:fe,onCancelar:()=>{w(!1),y(null)}}),n&&!te&&b.length>0&&e.jsxs(He,{children:[e.jsx(Ce,{children:e.jsx(Ke,{loteSelecionado:n,receptorasCount:b.length,loteFormData:v,onFormChange:D,veterinarioLabel:"Veterinário Responsável (Sexagem)",tecnicoLabel:"Técnico Responsável (Sexagem)",onSalvarLote:ve,submitting:_e,canSave:he})}),e.jsx(we,{children:me?e.jsx(be,{}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(Oe,{children:[e.jsx(Pe,{children:e.jsxs(ne,{children:[e.jsx(N,{children:"Receptora"}),e.jsx(N,{children:"Dias Gestação"}),e.jsx(N,{children:"Embrião(ões)"}),e.jsx(N,{children:"Doadora / Touro"}),e.jsx(N,{children:"Nº Gest."}),e.jsx(N,{children:"Data Sexagem"}),e.jsx(N,{children:"Sexagens"}),e.jsx(N,{children:"Observações"})]})}),e.jsx(Te,{children:b.map(a=>{var c;const s=L[a.receptora_id]||{data_sexagem:K,sexagens:new Array(a.numero_gestacoes).fill("").map(()=>""),observacoes:""},d=!!a.diagnostico_existente;return e.jsxs(ne,{children:[e.jsxs(R,{className:"font-medium",children:[a.brinco,a.nome&&e.jsxs("span",{className:"text-slate-500 text-sm ml-2",children:["(",a.nome,")"]}),d&&e.jsx(Ie,{status:((c=a.diagnostico_existente)==null?void 0:c.resultado)||"",className:"ml-2"})]}),e.jsxs(R,{children:[e.jsx("span",{className:"font-semibold",children:a.dias_gestacao})," dias"]}),e.jsx(R,{children:e.jsx("div",{className:"space-y-1",children:a.embrioes.map((i,o)=>e.jsx("div",{className:"text-sm",children:e.jsxs("div",{className:"font-medium",children:[i.embriao_identificacao||`Embrião ${o+1}`,i.embriao_classificacao&&e.jsxs("span",{className:"text-slate-500 ml-2",children:["(",i.embriao_classificacao,")"]})]})},i.te_id))})}),e.jsx(R,{children:e.jsx("div",{className:"space-y-1",children:a.embrioes.map(i=>e.jsx("div",{className:"text-sm",children:e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:i.doadora_registro||"-"}),i.doadora_registro&&i.touro_nome&&" × ",e.jsx("span",{className:"font-medium",children:i.touro_nome||""})]})},i.te_id))})}),e.jsx(R,{className:"font-medium text-center",children:a.numero_gestacoes}),e.jsx(R,{children:e.jsx($e,{value:s.data_sexagem,onChange:i=>ie(a.receptora_id,"data_sexagem",i||""),className:"w-36",disabled:n.status==="FECHADO"})}),e.jsx(R,{children:e.jsx("div",{className:"flex gap-2",children:Array.from({length:a.numero_gestacoes},(i,o)=>{const l=s.sexagens[o]||"",_=a.numero_gestacoes>1?`Gest. ${o+1}`:"Selecione";return e.jsxs(ye,{value:l,onValueChange:g=>xe(a.receptora_id,o,g),disabled:n.status==="FECHADO",children:[e.jsx(Le,{className:"w-28",children:e.jsx(De,{placeholder:_})}),e.jsxs(Ve,{children:[e.jsx(J,{value:"FEMEA",children:"Fêmea"}),e.jsx(J,{value:"MACHO",children:"Macho"}),e.jsx(J,{value:"SEM_SEXO",children:"Sem sexo"}),e.jsx(J,{value:"VAZIA",children:"Vazia"})]})]},o)})})}),e.jsx(R,{children:e.jsx(Ge,{value:s.observacoes,onChange:i=>ie(a.receptora_id,"observacoes",i.target.value),placeholder:"Observações",rows:2,className:"w-48",disabled:n.status==="FECHADO"})})]},a.receptora_id)})})]})})})]})]})}export{va as default};
